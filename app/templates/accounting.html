<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Dashboard - Invoice Allocations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .summary-card { transition: transform 0.2s; cursor: pointer; }
        .summary-card:hover { transform: translateY(-2px); }
        .allocation-badge { font-size: 0.8em; }
        .search-highlight { background: #fff3cd; }
        .table-hover tbody tr:hover { background: #e3f2fd; }
        .modal-xl { max-width: 90%; }
        .allocation-row { border-left: 3px solid #0d6efd; padding-left: 10px; margin-bottom: 10px; }
        .filter-section { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        .column-config-btn { cursor: pointer; }
        .column-list-item { padding: 8px 12px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .column-list-item:last-child { border-bottom: none; }
        .column-list-item.disabled { opacity: 0.5; }
        .drag-handle { cursor: grab; color: #999; }
        .column-list-item.dragging { opacity: 0.5; background: #e3f2fd; }
        .column-list-item.drag-over { border-top: 2px solid #0d6efd; }
        .custom-column-badge { background: #198754; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; }
        .allocation-edit-row { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .allocation-edit-row .form-label { font-size: 0.85em; margin-bottom: 2px; }
        .allocation-edit-row .form-control, .allocation-edit-row .form-select { font-size: 0.9em; }
        .allocation-edit-row .delete-allocation-btn { position: absolute; top: 5px; right: 5px; }
        .allocation-value-display { font-weight: bold; color: #198754; }
        .bulk-action-bar { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px 12px; margin-bottom: 10px; display: none; }
        .bulk-action-bar.show { display: flex; align-items: center; gap: 10px; }
        .select-checkbox { cursor: pointer; width: 18px; height: 18px; }
        .bin-badge { background: #dc3545; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .deleted-row { opacity: 0.7; background: #fff3cd; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-success mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-calculator"></i> Accounting Dashboard
            </span>
            <div>
                <a href="/connectors" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plug"></i> Connectors
                </a>
                <a href="/" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-plus-circle"></i> New Invoice
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <div class="col-md-3">
                <div class="card summary-card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-receipt"></i> Total Invoices</h6>
                        <h2 id="totalInvoices">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0"><i class="bi bi-currency-exchange"></i> Total Value</h6>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="currencyToggle" style="cursor: pointer;">
                                <label class="form-check-label small" for="currencyToggle" id="currencyToggleLabel" style="cursor: pointer;">EUR</label>
                            </div>
                        </div>
                        <h2 id="totalValue">0 RON</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-building"></i> Companies</h6>
                        <h2 id="totalCompanies">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-diagram-3"></i> Departments</h6>
                        <h2 id="totalDepartments">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="row align-items-end g-1">
                <div class="col">
                    <label class="form-label small mb-0">Company</label>
                    <select class="form-select form-select-sm" id="companyFilter">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label small mb-0">Department</label>
                    <select class="form-select form-select-sm" id="departmentFilter" onchange="updateSubdepartmentFilter()">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label small mb-0">Subdept</label>
                    <select class="form-select form-select-sm" id="subdepartmentFilter">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label small mb-0">Brand</label>
                    <select class="form-select form-select-sm" id="brandFilter">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col">
                    <label class="form-label small mb-0">Start</label>
                    <input type="date" class="form-control form-control-sm" id="startDate">
                </div>
                <div class="col">
                    <label class="form-label small mb-0">End</label>
                    <input type="date" class="form-control form-control-sm" id="endDate">
                </div>
                <div class="col-auto">
                    <label class="form-label small mb-0">Quick</label>
                    <select class="form-select form-select-sm" id="quickFilter" onchange="setQuickFilter(this.value)">
                        <option value="">--</option>
                        <option value="today">Today</option>
                        <option value="week">Week</option>
                        <option value="month">Month</option>
                        <option value="quarter">Quarter</option>
                        <option value="year">Year</option>
                    </select>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Clear Filters">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col">
                    <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search by supplier or invoice #...">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#invoicesTab">
                    <i class="bi bi-receipt"></i> Invoices
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#companyTab">
                    <i class="bi bi-building"></i> By Company
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#departmentTab">
                    <i class="bi bi-diagram-3"></i> By Department
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#brandTab">
                    <i class="bi bi-tag"></i> By Brand
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#binTab" onclick="loadBinData()">
                    <i class="bi bi-trash3"></i> Bin <span id="binCount" class="bin-badge" style="display: none;">0</span>
                </a>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Invoices Tab -->
            <div class="tab-pane fade show active" id="invoicesTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-table"></i> Invoice Data</span>
                        <div class="d-flex gap-2 align-items-center">
                            <select class="form-select form-select-sm" id="sortOrder" onchange="applySorting()" style="width: auto;">
                                <option value="newest">Newest first</option>
                                <option value="oldest">Oldest first</option>
                            </select>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#columnConfigModal">
                                <i class="bi bi-gear"></i> Configure Columns
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bulk-action-bar" id="bulkActionBar">
                            <span><strong id="selectedCount">0</strong> selected</span>
                            <button class="btn btn-danger btn-sm" onclick="bulkDeleteSelected()">
                                <i class="bi bi-trash"></i> Delete Selected
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                Clear Selection
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="invoicesDataTable">
                                <thead class="table-light" id="invoicesTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="invoicesTable">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Company Tab -->
            <div class="tab-pane fade" id="companyTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-building"></i> By Company</span>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#companyColumnConfigModal">
                            <i class="bi bi-gear"></i> Configure Columns
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="companyDataTable">
                                <thead class="table-light" id="companyTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="companyTable">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Department Tab -->
            <div class="tab-pane fade" id="departmentTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-diagram-3"></i> By Department</span>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#departmentColumnConfigModal">
                            <i class="bi bi-gear"></i> Configure Columns
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="departmentDataTable">
                                <thead class="table-light" id="departmentTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="departmentTable">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Brand Tab -->
            <div class="tab-pane fade" id="brandTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-tag"></i> By Brand (Linie de business)</span>
                        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#brandColumnConfigModal">
                            <i class="bi bi-gear"></i> Configure Columns
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="brandDataTable">
                                <thead class="table-light" id="brandTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="brandTable">
                                    <tr>
                                        <td colspan="3" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bin Tab -->
            <div class="tab-pane fade" id="binTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-trash3"></i> Deleted Invoices (Bin) - Auto-deleted after 30 days</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreSelected()" id="binRestoreBtn" disabled>
                                <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkPermanentDeleteSelected()" id="binPermanentDeleteBtn" disabled>
                                <i class="bi bi-trash"></i> Delete Permanently
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="binDataTable">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" class="select-checkbox" id="binSelectAll" onchange="toggleBinSelectAll(this)"></th>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Invoice #</th>
                                        <th>Value</th>
                                        <th>Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="binTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Bin" tab to load deleted invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceModalBody">
                    Loading...
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-outline-primary" id="driveLink" target="_blank">
                        <i class="bi bi-cloud"></i> Open in Drive
                    </a>
                    <button type="button" class="btn btn-warning" id="editInvoiceBtn">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteInvoiceBtn">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Table Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="columnConfigTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#existingColumnsTab">
                                <i class="bi bi-list-check"></i> Show/Hide Columns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#addColumnTab">
                                <i class="bi bi-plus-circle"></i> Add Custom Column
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- Existing Columns Tab -->
                        <div class="tab-pane fade show active" id="existingColumnsTab">
                            <p class="text-muted small">Toggle columns visibility. Drag to reorder.</p>
                            <div id="columnList" class="border rounded">
                                <!-- Column items will be rendered here -->
                            </div>
                        </div>
                        <!-- Add Column Tab -->
                        <div class="tab-pane fade" id="addColumnTab">
                            <div class="mb-3">
                                <label class="form-label">Column Name</label>
                                <input type="text" class="form-control" id="newColumnName" placeholder="Enter column header name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data Source</label>
                                <select class="form-select" id="newColumnSource">
                                    <optgroup label="Invoice Fields">
                                        <option value="invoice.id">Invoice ID</option>
                                        <option value="invoice.supplier">Supplier</option>
                                        <option value="invoice.invoice_number">Invoice Number</option>
                                        <option value="invoice.invoice_date">Invoice Date</option>
                                        <option value="invoice.invoice_value">Invoice Value</option>
                                        <option value="invoice.currency">Currency</option>
                                        <option value="invoice.invoice_template">Template</option>
                                        <option value="invoice.drive_link">Drive Link</option>
                                        <option value="invoice.comment">Comment</option>
                                        <option value="invoice.created_at">Created At</option>
                                    </optgroup>
                                    <optgroup label="Allocation Fields (First)">
                                        <option value="allocation.company">Company</option>
                                        <option value="allocation.brand">Brand</option>
                                        <option value="allocation.department">Department</option>
                                        <option value="allocation.subdepartment">Subdepartment</option>
                                        <option value="allocation.allocation_percent">Allocation %</option>
                                        <option value="allocation.allocation_value">Allocation Value</option>
                                        <option value="allocation.responsible">Responsible</option>
                                        <option value="allocation.reinvoice_to">Reinvoice To</option>
                                    </optgroup>
                                    <optgroup label="Computed">
                                        <option value="computed.allocation_count">Allocation Count</option>
                                        <option value="computed.companies_list">Companies (comma-sep)</option>
                                        <option value="computed.departments_list">Departments (comma-sep)</option>
                                        <option value="computed.reinvoice_list">Reinvoice To (all allocations)</option>
                                        <option value="computed.split_values">Split Values (all allocations)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Format (optional)</label>
                                <select class="form-select" id="newColumnFormat">
                                    <option value="text">Text (as-is)</option>
                                    <option value="currency">Currency (formatted)</option>
                                    <option value="percent">Percentage</option>
                                    <option value="date">Date</option>
                                    <option value="link">Link (clickable)</option>
                                    <option value="split">Split (allocation breakdown)</option>
                                    <option value="reinvoice">Reinvoice (detailed breakdown)</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="addCustomColumnBtn">
                                <i class="bi bi-plus"></i> Add Column
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" id="resetColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Column Configuration Modal -->
    <div class="modal fade" id="companyColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Company Table Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="companyColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" id="resetCompanyColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Column Configuration Modal -->
    <div class="modal fade" id="departmentColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Department Table Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="departmentColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" id="resetDepartmentColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Brand Column Configuration Modal -->
    <div class="modal fade" id="brandColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Brand Table Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="brandColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" id="resetBrandColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">

                        <!-- Invoice Details Section -->
                        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-receipt"></i> Invoice Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control" id="editSupplier" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="editInvoiceNumber" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="editInvoiceDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Invoice Value</label>
                                <input type="number" step="0.01" class="form-control" id="editInvoiceValue" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Currency</label>
                                <select class="form-select" id="editCurrency">
                                    <option value="RON">RON</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drive Link</label>
                                <input type="url" class="form-control" id="editDriveLink" placeholder="https://drive.google.com/...">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Comment</label>
                                <input type="text" class="form-control" id="editComment" placeholder="Add a comment...">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Upload Invoice File</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" id="editInvoiceFile" accept=".pdf,.jpg,.jpeg,.png">
                                    <button type="button" class="btn btn-outline-success" id="uploadEditFileBtn">
                                        <i class="bi bi-cloud-upload"></i> Upload to Drive
                                    </button>
                                </div>
                                <small class="text-muted">Upload a new invoice file to Google Drive (optional)</small>
                            </div>
                        </div>

                        <!-- Allocations Section -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">
                            <i class="bi bi-pie-chart"></i> Cost Allocations
                            <span class="badge bg-secondary ms-2" id="allocationTotalBadge">0%</span>
                        </h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Dedicated To (Company) *</label>
                                <select class="form-select" id="editDedicatedCompany" required>
                                    <option value="">Select company...</option>
                                </select>
                            </div>
                        </div>
                        <div id="allocationsContainer">
                            <!-- Allocation rows will be rendered here -->
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm mt-2" id="addAllocationBtn">
                            <i class="bi bi-plus-circle"></i> Add Allocation
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveInvoiceBtn">
                        <i class="bi bi-check"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allInvoices = [];
        let invoicesWithAllocations = {}; // Cache for full invoice data
        let currentInvoiceId = null;
        let organizationalStructure = []; // Cache for company/department structure
        let editAllocations = []; // Current allocations being edited

        // Summary card totals for currency toggle
        let summaryTotalRon = 0;
        let summaryTotalEur = 0;
        let currentEurRate = 5.0; // Default EUR/RON rate, will be fetched from API

        // Selection state
        let selectedInvoices = new Set();
        let binInvoices = [];
        let selectedBinInvoices = new Set();

        // Default column configuration
        const DEFAULT_COLUMNS = [
            { id: 'select', name: '', source: 'special.select', format: 'special', visible: true, custom: false },
            { id: 'id', name: 'ID', source: 'invoice.id', format: 'text', visible: true, custom: false },
            { id: 'date', name: 'Date', source: 'invoice.invoice_date', format: 'date', visible: true, custom: false },
            { id: 'supplier', name: 'Supplier', source: 'invoice.supplier', format: 'text', visible: true, custom: false },
            { id: 'invoice_number', name: 'Invoice #', source: 'invoice.invoice_number', format: 'text', visible: true, custom: false },
            { id: 'value', name: 'Value', source: 'invoice.invoice_value', format: 'currency', visible: true, custom: false },
            { id: 'currency', name: 'Currency', source: 'invoice.currency', format: 'text', visible: false, custom: false },
            { id: 'template', name: 'Template', source: 'invoice.invoice_template', format: 'text', visible: false, custom: false },
            { id: 'company', name: 'Company', source: 'allocation.company', format: 'text', visible: false, custom: false },
            { id: 'department', name: 'Department', source: 'allocation.department', format: 'text', visible: false, custom: false },
            { id: 'brand', name: 'Brand', source: 'allocation.brand', format: 'text', visible: false, custom: false },
            { id: 'responsible', name: 'Responsible', source: 'allocation.responsible', format: 'text', visible: false, custom: false },
            { id: 'reinvoice_to', name: 'Reinvoice To', source: 'computed.reinvoice_list', format: 'reinvoice', visible: false, custom: false },
            { id: 'split_values', name: 'Split Values', source: 'computed.split_values', format: 'split', visible: false, custom: false },
            { id: 'comment', name: 'Comment', source: 'invoice.comment', format: 'text', visible: false, custom: false },
            { id: 'actions', name: 'Actions', source: 'special.actions', format: 'special', visible: true, custom: false },
            { id: 'drive', name: 'Drive', source: 'special.drive', format: 'special', visible: true, custom: false }
        ];

        let columnConfig = [];

        // Default column configuration for Company view
        const DEFAULT_COMPANY_COLUMNS = [
            { id: 'company', name: 'Company', source: 'company', format: 'text', visible: true },
            { id: 'total_value', name: 'Total Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: true }
        ];

        // Default column configuration for Department view
        const DEFAULT_DEPARTMENT_COLUMNS = [
            { id: 'company', name: 'Company', source: 'company', format: 'text', visible: true },
            { id: 'department', name: 'Department', source: 'department', format: 'text', visible: true },
            { id: 'subdepartment', name: 'Subdepartment', source: 'subdepartment', format: 'text', visible: true },
            { id: 'total_value', name: 'Total Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: false }
        ];

        const DEFAULT_BRAND_COLUMNS = [
            { id: 'brand', name: 'Brand (Linie de business)', source: 'brand', format: 'text', visible: true },
            { id: 'invoice_numbers', name: 'Invoice #', source: 'invoice_numbers', format: 'text', visible: true },
            { id: 'total_value', name: 'Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'split_values', name: 'Split Values', source: 'split_values', format: 'split', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: false }
        ];

        let companyColumnConfig = [];
        let departmentColumnConfig = [];
        let brandColumnConfig = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadColumnConfig();
            loadData();
            setupEventListeners();
        });

        function loadColumnConfig() {
            // Invoice columns
            const saved = localStorage.getItem('accountingColumnConfig');
            if (saved) {
                columnConfig = JSON.parse(saved);
                // Ensure select column exists (for migration from old configs)
                if (!columnConfig.find(c => c.id === 'select')) {
                    columnConfig.unshift({ id: 'select', name: '', source: 'special.select', format: 'special', visible: true, custom: false });
                }
            } else {
                columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            }
            renderColumnList();

            // Company columns
            const savedCompany = localStorage.getItem('companyColumnConfig');
            if (savedCompany) {
                companyColumnConfig = JSON.parse(savedCompany);
            } else {
                companyColumnConfig = JSON.parse(JSON.stringify(DEFAULT_COMPANY_COLUMNS));
            }
            renderCompanyColumnList();

            // Department columns
            const savedDept = localStorage.getItem('departmentColumnConfig');
            if (savedDept) {
                departmentColumnConfig = JSON.parse(savedDept);
            } else {
                departmentColumnConfig = JSON.parse(JSON.stringify(DEFAULT_DEPARTMENT_COLUMNS));
            }
            renderDepartmentColumnList();

            // Brand columns
            const savedBrand = localStorage.getItem('brandColumnConfig');
            if (savedBrand) {
                brandColumnConfig = JSON.parse(savedBrand);
            } else {
                brandColumnConfig = JSON.parse(JSON.stringify(DEFAULT_BRAND_COLUMNS));
            }
            renderBrandColumnList();
        }

        function saveColumnConfig() {
            localStorage.setItem('accountingColumnConfig', JSON.stringify(columnConfig));
            renderInvoicesTable(allInvoices);
        }

        function saveCompanyColumnConfig() {
            localStorage.setItem('companyColumnConfig', JSON.stringify(companyColumnConfig));
            loadCompanySummary();
        }

        function saveDepartmentColumnConfig() {
            localStorage.setItem('departmentColumnConfig', JSON.stringify(departmentColumnConfig));
            loadDepartmentSummary();
        }

        function saveBrandColumnConfig() {
            localStorage.setItem('brandColumnConfig', JSON.stringify(brandColumnConfig));
            loadBrandSummary();
        }

        function resetColumnConfig() {
            columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            saveColumnConfig();
            renderColumnList();
        }

        function resetCompanyColumnConfig() {
            companyColumnConfig = JSON.parse(JSON.stringify(DEFAULT_COMPANY_COLUMNS));
            saveCompanyColumnConfig();
            renderCompanyColumnList();
        }

        function resetDepartmentColumnConfig() {
            departmentColumnConfig = JSON.parse(JSON.stringify(DEFAULT_DEPARTMENT_COLUMNS));
            saveDepartmentColumnConfig();
            renderDepartmentColumnList();
        }

        function resetBrandColumnConfig() {
            brandColumnConfig = JSON.parse(JSON.stringify(DEFAULT_BRAND_COLUMNS));
            saveBrandColumnConfig();
            renderBrandColumnList();
        }

        function renderColumnList() {
            const container = document.getElementById('columnList');
            container.innerHTML = columnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">
                        ${col.name}
                        ${col.custom ? '<span class="custom-column-badge">Custom</span>' : ''}
                    </span>
                    <small class="text-muted">${col.source}</small>
                    ${col.custom ? `<button class="btn btn-sm btn-outline-danger ms-2 delete-column-btn" data-idx="${idx}"><i class="bi bi-trash"></i></button>` : ''}
                </div>
            `).join('');

            // Add event listeners for toggles
            container.querySelectorAll('.column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    columnConfig[idx].visible = e.target.checked;
                    saveColumnConfig();
                    renderColumnList();
                });
            });

            // Add event listeners for delete buttons
            container.querySelectorAll('.delete-column-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.closest('button').dataset.idx);
                    columnConfig.splice(idx, 1);
                    saveColumnConfig();
                    renderColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, columnConfig, saveColumnConfig, renderColumnList);
        }

        function setupDragAndDrop(container, config, saveFunc, renderFunc) {
            let draggedIdx = null;

            container.querySelectorAll('.column-list-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedIdx = parseInt(item.dataset.idx);
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    container.querySelectorAll('.column-list-item').forEach(el => el.classList.remove('drag-over'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const targetIdx = parseInt(item.dataset.idx);
                    if (targetIdx !== draggedIdx) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetIdx = parseInt(item.dataset.idx);
                    if (draggedIdx !== null && draggedIdx !== targetIdx) {
                        // Reorder the config array
                        const draggedItem = config[draggedIdx];
                        config.splice(draggedIdx, 1);
                        config.splice(targetIdx, 0, draggedItem);
                        saveFunc();
                        renderFunc();
                    }
                    item.classList.remove('drag-over');
                });
            });
        }

        function renderCompanyColumnList() {
            const container = document.getElementById('companyColumnList');
            container.innerHTML = companyColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input company-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.company-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    companyColumnConfig[idx].visible = e.target.checked;
                    saveCompanyColumnConfig();
                    renderCompanyColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, companyColumnConfig, saveCompanyColumnConfig, renderCompanyColumnList);
        }

        function renderDepartmentColumnList() {
            const container = document.getElementById('departmentColumnList');
            container.innerHTML = departmentColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input department-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.department-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    departmentColumnConfig[idx].visible = e.target.checked;
                    saveDepartmentColumnConfig();
                    renderDepartmentColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, departmentColumnConfig, saveDepartmentColumnConfig, renderDepartmentColumnList);
        }

        function renderBrandColumnList() {
            const container = document.getElementById('brandColumnList');
            container.innerHTML = brandColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input brand-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.brand-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    brandColumnConfig[idx].visible = e.target.checked;
                    saveBrandColumnConfig();
                    renderBrandColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, brandColumnConfig, saveBrandColumnConfig, renderBrandColumnList);
        }

        function addCustomColumn() {
            const name = document.getElementById('newColumnName').value.trim();
            const source = document.getElementById('newColumnSource').value;
            const format = document.getElementById('newColumnFormat').value;

            if (!name) {
                alert('Please enter a column name');
                return;
            }

            const newCol = {
                id: 'custom_' + Date.now(),
                name: name,
                source: source,
                format: format,
                visible: true,
                custom: true
            };

            // Insert before Actions column
            const actionsIdx = columnConfig.findIndex(c => c.id === 'actions');
            if (actionsIdx >= 0) {
                columnConfig.splice(actionsIdx, 0, newCol);
            } else {
                columnConfig.push(newCol);
            }

            saveColumnConfig();
            renderColumnList();

            // Clear form
            document.getElementById('newColumnName').value = '';
            document.getElementById('newColumnSource').selectedIndex = 0;
            document.getElementById('newColumnFormat').selectedIndex = 0;

            // Switch to columns tab
            const tabEl = document.querySelector('#columnConfigTabs a[href="#existingColumnsTab"]');
            bootstrap.Tab.getOrCreateInstance(tabEl).show();
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('deleteInvoiceBtn').addEventListener('click', handleDelete);
            document.getElementById('editInvoiceBtn').addEventListener('click', openEditModal);
            document.getElementById('saveInvoiceBtn').addEventListener('click', handleSaveInvoice);
            document.getElementById('uploadEditFileBtn').addEventListener('click', handleEditFileUpload);
            document.getElementById('addAllocationBtn').addEventListener('click', addNewAllocation);
            document.getElementById('addCustomColumnBtn').addEventListener('click', addCustomColumn);
            document.getElementById('resetColumnsBtn').addEventListener('click', () => {
                if (confirm('Reset all columns to default? This will remove custom columns.')) {
                    resetColumnConfig();
                }
            });
            document.getElementById('resetCompanyColumnsBtn').addEventListener('click', () => {
                if (confirm('Reset company columns to default?')) {
                    resetCompanyColumnConfig();
                }
            });
            document.getElementById('resetDepartmentColumnsBtn').addEventListener('click', () => {
                if (confirm('Reset department columns to default?')) {
                    resetDepartmentColumnConfig();
                }
            });
            document.getElementById('resetBrandColumnsBtn').addEventListener('click', () => {
                if (confirm('Reset brand columns to default?')) {
                    resetBrandColumnConfig();
                }
            });

            // Currency toggle for summary card
            document.getElementById('currencyToggle').addEventListener('change', (e) => {
                updateTotalValueDisplay(e.target.checked);
            });

            // Tab change listeners
            document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', loadData);
            });

            // Refresh table when modal closes
            document.getElementById('columnConfigModal').addEventListener('hidden.bs.modal', () => {
                renderInvoicesTable(allInvoices);
            });

            // Dynamic filter listeners - auto-apply on change
            document.getElementById('companyFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('departmentFilter').addEventListener('change', () => {
                updateSubdepartmentFilter();
                applyFiltersOnly();
            });
            document.getElementById('subdepartmentFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('brandFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('startDate').addEventListener('change', applyFiltersOnly);
            document.getElementById('endDate').addEventListener('change', applyFiltersOnly);
            document.getElementById('quickFilter').addEventListener('change', (e) => {
                if (e.target.value) {
                    setQuickFilter(e.target.value);
                }
            });
        }

        // Apply filters without reloading filter dropdowns (to avoid infinite loop)
        async function applyFiltersOnly() {
            await Promise.all([
                loadInvoices(),
                loadCompanySummary(),
                loadDepartmentSummary(),
                loadBrandSummary()
            ]);
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function loadData() {
            await Promise.all([
                loadInvoices(),
                loadCompanySummary(),
                loadDepartmentSummary(),
                loadBrandSummary(),
                loadCompanyFilter(),
                loadDepartmentFilter(),
                loadBrandFilter()
            ]);
            updateSummaryCards();
        }

        function setQuickFilter(period) {
            if (!period) return; // Empty selection, do nothing

            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();

            if (period === 'today') {
                // Set both start and end to today
                const todayStr = today.toISOString().split('T')[0];
                startDate.value = todayStr;
                endDate.value = todayStr;
            } else if (period === 'week') {
                // Get current day of week (0 = Sunday, 1 = Monday, etc.)
                const dayOfWeek = today.getDay();
                // Calculate Monday of current week (week starts on Monday)
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                // Calculate Sunday of current week
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                startDate.value = monday.toISOString().split('T')[0];
                endDate.value = sunday.toISOString().split('T')[0];
            } else if (period === 'month') {
                // First day of current month
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                // Last day of current month
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate.value = firstDay.toISOString().split('T')[0];
                endDate.value = lastDay.toISOString().split('T')[0];
            } else if (period === 'quarter') {
                // Determine current quarter (0-3)
                const quarter = Math.floor(today.getMonth() / 3);
                // First day of quarter
                const firstDay = new Date(today.getFullYear(), quarter * 3, 1);
                // Last day of quarter
                const lastDay = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                startDate.value = firstDay.toISOString().split('T')[0];
                endDate.value = lastDay.toISOString().split('T')[0];
            } else if (period === 'year') {
                // First day of current year
                const firstDay = new Date(today.getFullYear(), 0, 1);
                // Last day of current year
                const lastDay = new Date(today.getFullYear(), 11, 31);
                startDate.value = firstDay.toISOString().split('T')[0];
                endDate.value = lastDay.toISOString().split('T')[0];
            }

            // Auto-apply filters
            applyFiltersOnly();
        }

        async function loadInvoices() {
            try {
                // Build URL with filter parameters
                const params = new URLSearchParams();
                const company = document.getElementById('companyFilter').value;
                const department = document.getElementById('departmentFilter').value;
                const subdepartment = document.getElementById('subdepartmentFilter').value;
                const brand = document.getElementById('brandFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (company) params.append('company', company);
                if (department) params.append('department', department);
                if (subdepartment) params.append('subdepartment', subdepartment);
                if (brand) params.append('brand', brand);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const url = '/api/db/invoices' + (params.toString() ? '?' + params.toString() : '');
                const res = await fetch(url);
                allInvoices = await res.json();

                // Check if we need allocation data for any visible column
                const needsAllocations = columnConfig.some(col =>
                    col.visible && (col.source.startsWith('allocation.') || col.source.startsWith('computed.'))
                );

                if (needsAllocations) {
                    // Load full invoice data with allocations
                    await Promise.all(allInvoices.map(async (inv) => {
                        if (!invoicesWithAllocations[inv.id]) {
                            const fullRes = await fetch(`/api/db/invoices/${inv.id}`);
                            invoicesWithAllocations[inv.id] = await fullRes.json();
                        }
                    }));
                }

                renderInvoicesTable(allInvoices);
            } catch (e) {
                console.error('Error loading invoices:', e);
            }
        }

        async function loadCompanyFilter() {
            try {
                const res = await fetch('/api/companies');
                const companies = await res.json();
                const select = document.getElementById('companyFilter');
                select.innerHTML = '<option value="">All Companies</option>';
                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading companies:', e);
            }
        }

        let departmentStructure = [];

        async function loadDepartmentFilter() {
            try {
                const res = await fetch('/api/structure');
                departmentStructure = await res.json();
                const select = document.getElementById('departmentFilter');
                select.innerHTML = '<option value="">All Departments</option>';
                // Get unique departments
                const departments = [...new Set(departmentStructure.map(s => s.department))].sort();
                departments.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading departments:', e);
            }
        }

        function updateSubdepartmentFilter() {
            const department = document.getElementById('departmentFilter').value;
            const select = document.getElementById('subdepartmentFilter');
            select.innerHTML = '<option value="">All Subdepartments</option>';

            if (department) {
                // Get subdepartments for selected department
                const subdepts = [...new Set(
                    departmentStructure
                        .filter(s => s.department === department && s.subdepartment)
                        .map(s => s.subdepartment)
                )].sort();
                subdepts.forEach(sd => {
                    const opt = document.createElement('option');
                    opt.value = sd;
                    opt.textContent = sd;
                    select.appendChild(opt);
                });
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('quickFilter').value = '';
            document.getElementById('companyFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('subdepartmentFilter').innerHTML = '<option value="">All Subdepartments</option>';
            document.getElementById('brandFilter').value = '';
            applyFiltersOnly();
        }

        async function loadBrandFilter() {
            try {
                const res = await fetch('/api/structure');
                const structure = await res.json();
                const select = document.getElementById('brandFilter');
                select.innerHTML = '<option value="">All Brands</option>';
                // Get unique brands
                const brands = [...new Set(structure.filter(s => s.brand).map(s => s.brand))].sort();
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading brands:', e);
            }
        }

        async function loadCompanySummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/company?${params}`);
                const data = await res.json();
                renderCompanyTable(data);
            } catch (e) {
                console.error('Error loading company summary:', e);
            }
        }

        async function loadDepartmentSummary() {
            const company = document.getElementById('companyFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (company) params.append('company', company);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/department?${params}`);
                const data = await res.json();
                renderDepartmentTable(data);
            } catch (e) {
                console.error('Error loading department summary:', e);
            }
        }

        async function loadBrandSummary() {
            const company = document.getElementById('companyFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (company) params.append('company', company);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/brand?${params}`);
                const data = await res.json();
                renderBrandTable(data);
            } catch (e) {
                console.error('Error loading brand summary:', e);
            }
        }

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                renderInvoicesTable(allInvoices);
                return;
            }

            try {
                const res = await fetch(`/api/db/search?q=${encodeURIComponent(query)}`);
                const results = await res.json();
                renderInvoicesTable(results);
            } catch (e) {
                console.error('Error searching:', e);
            }
        }

        function getColumnValue(inv, col) {
            const fullInvoice = invoicesWithAllocations[inv.id] || inv;
            const firstAllocation = fullInvoice.allocations?.[0] || {};

            if (col.source.startsWith('invoice.')) {
                const field = col.source.replace('invoice.', '');
                return inv[field];
            } else if (col.source.startsWith('allocation.')) {
                const field = col.source.replace('allocation.', '');
                return firstAllocation[field];
            } else if (col.source.startsWith('computed.')) {
                const field = col.source.replace('computed.', '');
                const allocations = fullInvoice.allocations || [];
                switch (field) {
                    case 'allocation_count':
                        return allocations.length;
                    case 'companies_list':
                        return [...new Set(allocations.map(a => a.company))].join(', ');
                    case 'departments_list':
                        return [...new Set(allocations.map(a => a.department))].join(', ');
                    case 'split_values':
                        return allocations.map(a => ({
                            company: a.company,
                            department: a.department,
                            subdepartment: a.subdepartment,
                            brand: a.brand,
                            percent: a.allocation_percent,
                            value: a.allocation_value,
                            reinvoice_to: a.reinvoice_to
                        }));
                    case 'reinvoice_list':
                        // Get allocations with reinvoice_to, including value/dept details
                        const reinvoiceAllocations = allocations
                            .filter(a => a.reinvoice_to)
                            .map(a => ({
                                value: a.allocation_value,
                                percent: a.allocation_percent,
                                department: a.department,
                                brand: a.brand,
                                reinvoice_to: a.reinvoice_to
                            }));
                        return reinvoiceAllocations.length > 0 ? reinvoiceAllocations : null;
                    default:
                        return '-';
                }
            }
            return '-';
        }

        function formatColumnValue(value, col, inv) {
            if (value === null || value === undefined) return '-';

            switch (col.format) {
                case 'currency':
                    return formatCurrency(value) + ' ' + (inv.currency || 'RON');
                case 'percent':
                    return value + '%';
                case 'date':
                    return formatDateRomanian(value) || '-';
                case 'link':
                    return value ? `<a href="${value}" target="_blank">${value}</a>` : '-';
                case 'split':
                    if (Array.isArray(value) && value.length > 0) {
                        // Single allocation - show inline (no collapse)
                        if (value.length === 1) {
                            const s = value[0];
                            const location = s.subdepartment || s.department;
                            const brandPart = s.brand ? ` (${s.brand})` : '';
                            const borderColor = s.reinvoice_to ? 'border-warning' : 'border-primary';
                            const reinvoiceLine = s.reinvoice_to
                                ? `<br><span class="text-warning"><i class="bi bi-arrow-right"></i> ${s.reinvoice_to}</span>`
                                : '';
                            return `<div class="small border-start ${borderColor} ps-2">
                                <span class="text-muted">${location}${brandPart}</span><br>
                                <strong>${formatCurrency(s.value)} ${inv.currency || 'RON'}</strong>
                                <span class="badge bg-secondary">${s.percent}%</span>${reinvoiceLine}
                            </div>`;
                        }

                        // Multiple allocations - collapsible
                        const collapseId = 'split-' + Math.random().toString(36).substr(2, 9);

                        // Calculate summary
                        const totalValue = value.reduce((sum, s) => sum + s.value, 0);
                        const reinvoicedAllocs = value.filter(s => s.reinvoice_to);

                        // Build summary text
                        const currency = inv.currency || 'RON';
                        let summaryText = `${value.length} allocations  ${formatCurrency(totalValue)} ${currency}`;
                        if (reinvoicedAllocs.length > 0) {
                            summaryText += ` <span class="text-warning">()</span>`;
                        }

                        // Build allocation details
                        const allocDetails = value.map(s => {
                            const location = s.subdepartment || s.department;
                            const brandPart = s.brand ? ` (${s.brand})` : '';
                            const borderColor = s.reinvoice_to ? 'border-warning' : 'border-primary';
                            const reinvoiceLine = s.reinvoice_to
                                ? `<br><span class="text-warning"><i class="bi bi-arrow-right"></i> ${s.reinvoice_to}</span>`
                                : '';
                            return `<div class="small border-start ${borderColor} ps-2 mb-1">
                                <span class="text-muted">${location}${brandPart}</span><br>
                                <strong>${formatCurrency(s.value)} ${currency}</strong>
                                <span class="badge bg-secondary">${s.percent}%</span>${reinvoiceLine}
                            </div>`;
                        }).join('');

                        return `<div>
                            <a class="text-primary small text-decoration-none" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false">
                                <i class="bi bi-plus-circle toggle-icon"></i> ${summaryText}
                            </a>
                            <div class="collapse" id="${collapseId}">
                                <div class="mt-1">${allocDetails}</div>
                            </div>
                        </div>`;
                    }
                    return '-';
                case 'reinvoice':
                    if (Array.isArray(value) && value.length > 0) {
                        // Helper function to format reinvoice destination
                        const formatReinvoiceDest = (r) => {
                            let dest = r.reinvoice_to || '-';
                            if (r.reinvoice_department) {
                                dest += ` / ${r.reinvoice_department}`;
                                if (r.reinvoice_subdepartment) {
                                    dest += ` / ${r.reinvoice_subdepartment}`;
                                }
                            }
                            return dest;
                        };

                        const reinvCurrency = inv.currency || 'RON';

                        // Single allocation - show inline
                        if (value.length === 1) {
                            const r = value[0];
                            return `<div class="small border-start border-warning ps-2">
                                <span class="text-muted">${r.department}${r.brand ? ' (' + r.brand + ')' : ''}</span><br>
                                <strong>${formatCurrency(r.value)} ${reinvCurrency}</strong>
                                <span class="badge bg-secondary">${r.percent}%</span><br>
                                <span class="text-warning"><i class="bi bi-arrow-right"></i> ${formatReinvoiceDest(r)}</span>
                            </div>`;
                        }

                        // Multiple allocations - collapsible
                        const reinvCollapseId = `reinv-collapse-${inv.id}-${col.id}`;
                        const totalReinvoiceValue = value.reduce((sum, r) => sum + r.value, 0);
                        const summaryText = `${value.length} reinvoices  ${formatCurrency(totalReinvoiceValue)} ${reinvCurrency}`;

                        const reinvoiceDetails = value.map(r =>
                            `<div class="small border-start border-warning ps-2 mb-1">
                                <span class="text-muted">${r.department}${r.brand ? ' (' + r.brand + ')' : ''}</span><br>
                                <strong>${formatCurrency(r.value)} ${reinvCurrency}</strong>
                                <span class="badge bg-secondary">${r.percent}%</span><br>
                                <span class="text-warning"><i class="bi bi-arrow-right"></i> ${formatReinvoiceDest(r)}</span>
                            </div>`
                        ).join('');

                        return `<div>
                            <a class="text-warning small text-decoration-none" data-bs-toggle="collapse" href="#${reinvCollapseId}" role="button" aria-expanded="false">
                                <i class="bi bi-plus-circle toggle-icon"></i> ${summaryText}
                            </a>
                            <div class="collapse" id="${reinvCollapseId}">
                                <div class="mt-1">${reinvoiceDetails}</div>
                            </div>
                        </div>`;
                    }
                    return '-';
                case 'special':
                    if (col.source === 'special.actions') {
                        return `<button class="btn btn-sm btn-outline-primary" onclick="showInvoiceDetail(${inv.id})">
                            <i class="bi bi-eye"></i> View
                        </button>`;
                    } else if (col.source === 'special.drive') {
                        if (inv.drive_link) {
                            return `<a href="${inv.drive_link}" target="_blank" class="btn btn-sm btn-outline-success" title="Open in Google Drive">
                                <i class="bi bi-cloud-arrow-down"></i>
                            </a>`;
                        } else {
                            return `<span class="btn btn-sm btn-outline-secondary disabled" title="No file uploaded">
                                <i class="bi bi-cloud"></i>
                            </span>`;
                        }
                    }
                    return '-';
                default:
                    if (col.id === 'supplier') return `<strong>${value}</strong>`;
                    if (col.id === 'invoice_number') return `<code>${value}</code>`;
                    return value;
            }
        }

        function renderInvoicesTable(invoices) {
            const thead = document.getElementById('invoicesTableHead').querySelector('tr');
            const tbody = document.getElementById('invoicesTable');
            const visibleCols = columnConfig.filter(c => c.visible);

            // Render header with select all checkbox for select column
            thead.innerHTML = visibleCols.map(col => {
                if (col.id === 'select') {
                    const allSelected = invoices.length > 0 && invoices.every(inv => selectedInvoices.has(inv.id));
                    return `<th><input type="checkbox" class="select-checkbox" id="selectAll" onchange="toggleSelectAll(this)" ${allSelected ? 'checked' : ''}></th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            if (invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No invoices found</td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const cells = visibleCols.map(col => {
                    if (col.id === 'select') {
                        const checked = selectedInvoices.has(inv.id) ? 'checked' : '';
                        return `<td><input type="checkbox" class="select-checkbox" data-id="${inv.id}" onchange="toggleInvoiceSelect(${inv.id})" ${checked}></td>`;
                    }
                    const value = getColumnValue(inv, col);
                    const formatted = formatColumnValue(value, col, inv);
                    return `<td>${formatted}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            // Update selection UI
            updateSelectionUI();
        }

        function renderCompanyTable(data) {
            const thead = document.getElementById('companyTableHead').querySelector('tr');
            const tbody = document.getElementById('companyTable');
            const visibleCols = companyColumnConfig.filter(c => c.visible);

            // Render header
            thead.innerHTML = visibleCols.map(col => `<th>${col.name}</th>`).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(row => {
                // Add computed avg_value
                row.avg_value = row.total_value / row.invoice_count;

                const cells = visibleCols.map(col => {
                    let value = row[col.source];
                    if (col.format === 'currency') {
                        return `<td>${formatCurrency(value)} RON</td>`;
                    } else if (col.id === 'company') {
                        return `<td><strong>${value}</strong></td>`;
                    }
                    return `<td>${value || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function renderDepartmentTable(data) {
            const thead = document.getElementById('departmentTableHead').querySelector('tr');
            const tbody = document.getElementById('departmentTable');
            const visibleCols = departmentColumnConfig.filter(c => c.visible);

            // Render header
            thead.innerHTML = visibleCols.map(col => `<th>${col.name}</th>`).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(row => {
                // Add computed avg_value
                row.avg_value = row.total_value / row.invoice_count;

                const cells = visibleCols.map(col => {
                    let value = row[col.source];
                    if (col.format === 'currency') {
                        return `<td>${formatCurrency(value)} RON</td>`;
                    } else if (col.id === 'department') {
                        return `<td><strong>${value}</strong></td>`;
                    }
                    return `<td>${value || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        function renderBrandTable(data) {
            const thead = document.getElementById('brandTableHead').querySelector('tr');
            const tbody = document.getElementById('brandTable');
            const visibleCols = brandColumnConfig.filter(c => c.visible);

            // Render header
            thead.innerHTML = visibleCols.map(col => `<th>${col.name}</th>`).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(row => {
                // Add computed avg_value
                row.avg_value = row.total_value / row.invoice_count;

                const cells = visibleCols.map(col => {
                    let value = row[col.source];
                    if (col.format === 'currency') {
                        return `<td>${formatCurrency(value)} RON</td>`;
                    } else if (col.id === 'brand') {
                        return `<td><strong>${value || '(No Brand)'}</strong></td>`;
                    } else if (col.format === 'split') {
                        // Use the same split formatting as the Invoices table
                        return `<td>${formatColumnValue(value, col, {})}</td>`;
                    }
                    return `<td>${value || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');
        }

        async function showInvoiceDetail(id) {
            currentInvoiceId = id;
            const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            const body = document.getElementById('invoiceModalBody');
            body.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
            modal.show();

            try {
                const res = await fetch(`/api/db/invoices/${id}`);
                const invoice = await res.json();

                // Cache full invoice data
                invoicesWithAllocations[id] = invoice;

                const driveLink = document.getElementById('driveLink');
                if (invoice.drive_link) {
                    driveLink.href = invoice.drive_link;
                    driveLink.classList.remove('disabled');
                } else {
                    driveLink.href = '#';
                    driveLink.classList.add('disabled');
                }

                body.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Invoice Information</h6>
                            <table class="table table-sm">
                                <tr><th>Supplier</th><td>${invoice.supplier}</td></tr>
                                <tr><th>Invoice #</th><td><code>${invoice.invoice_number}</code></td></tr>
                                <tr><th>Date</th><td>${formatDateRomanian(invoice.invoice_date)}</td></tr>
                                <tr><th>Total Value</th><td><strong>${formatCurrency(invoice.invoice_value)} ${invoice.currency || 'RON'}</strong></td></tr>
                                <tr><th>Template</th><td>${invoice.invoice_template || '-'}</td></tr>
                                <tr><th>Created</th><td>${invoice.created_at}</td></tr>
                                ${invoice.comment ? `<tr><th>Comment</th><td><em>${invoice.comment}</em></td></tr>` : ''}
                                <tr><th>Invoice File</th><td>${invoice.drive_link ? `<a href="${invoice.drive_link}" target="_blank" class="btn btn-sm btn-outline-success"><i class="bi bi-cloud"></i> View on Drive</a>` : '<span class="text-muted">Not uploaded</span>'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Cost Allocations</h6>
                            ${invoice.allocations.map(a => `
                                <div class="allocation-row">
                                    <div class="d-flex justify-content-between">
                                        <strong>${a.company}</strong>
                                        <span class="badge bg-primary">${a.allocation_percent}%</span>
                                    </div>
                                    <div class="small text-muted">
                                        ${a.department}${a.subdepartment ? ' > ' + a.subdepartment : ''}
                                        ${a.brand ? ' (' + a.brand + ')' : ''}
                                    </div>
                                    <div class="fw-bold text-success">${formatCurrency(a.allocation_value)} ${invoice.currency || 'RON'}</div>
                                    <div class="small">Responsible: ${a.responsible || '-'}</div>
                                    ${a.reinvoice_to ? `<div class="small text-warning"><i class="bi bi-arrow-right"></i> Reinvoice to: ${a.reinvoice_to}${a.reinvoice_department ? ' / ' + a.reinvoice_department : ''}${a.reinvoice_subdepartment ? ' / ' + a.reinvoice_subdepartment : ''}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = '<div class="alert alert-danger">Error loading invoice details</div>';
            }
        }

        async function handleDelete() {
            if (!currentInvoiceId) return;
            if (!confirm('Are you sure you want to delete this invoice? This action cannot be undone.')) return;

            try {
                const res = await fetch(`/api/db/invoices/${currentInvoiceId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                    delete invoicesWithAllocations[currentInvoiceId];
                    loadData();
                } else {
                    alert('Error deleting invoice');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function openEditModal() {
            if (!currentInvoiceId) return;

            const invoice = invoicesWithAllocations[currentInvoiceId];
            if (!invoice) return;

            // Load organizational structure if not cached
            if (organizationalStructure.length === 0) {
                try {
                    const res = await fetch('/api/structure');
                    organizationalStructure = await res.json();
                } catch (e) {
                    console.error('Error loading structure:', e);
                }
            }

            // Populate the edit form
            document.getElementById('editInvoiceId').value = invoice.id;
            document.getElementById('editSupplier').value = invoice.supplier || '';
            document.getElementById('editInvoiceNumber').value = invoice.invoice_number || '';
            document.getElementById('editInvoiceDate').value = invoice.invoice_date || '';
            document.getElementById('editInvoiceValue').value = invoice.invoice_value || '';
            document.getElementById('editCurrency').value = invoice.currency || 'RON';
            document.getElementById('editDriveLink').value = invoice.drive_link || '';
            document.getElementById('editComment').value = invoice.comment || '';

            // Populate dedicated company dropdown
            const companies = getUniqueCompanies();
            const dedicatedCompanySelect = document.getElementById('editDedicatedCompany');
            dedicatedCompanySelect.innerHTML = '<option value="">Select company...</option>' +
                companies.map(c => `<option value="${c}">${c}</option>`).join('');

            // Set dedicated company from first allocation (all should be same company)
            const firstAllocationCompany = invoice.allocations && invoice.allocations.length > 0
                ? invoice.allocations[0].company
                : '';
            dedicatedCompanySelect.value = firstAllocationCompany;

            // Add change event listener for dedicated company
            dedicatedCompanySelect.onchange = onDedicatedCompanyChange;

            // Load allocations
            editAllocations = (invoice.allocations || []).map(a => ({...a}));
            renderEditAllocations();

            // Close the detail modal and open the edit modal
            bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
            const editModal = new bootstrap.Modal(document.getElementById('editInvoiceModal'));
            editModal.show();

            // Reset the file input
            document.getElementById('editInvoiceFile').value = '';
        }

        async function handleEditFileUpload() {
            const fileInput = document.getElementById('editInvoiceFile');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file first');
                return;
            }

            const supplier = document.getElementById('editSupplier').value || 'Unknown';
            const invoiceDate = document.getElementById('editInvoiceDate').value || '';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('supplier', supplier);
            formData.append('invoice_date', invoiceDate);

            const btn = document.getElementById('uploadEditFileBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/drive/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (result.success && result.drive_link) {
                    document.getElementById('editDriveLink').value = result.drive_link;
                    alert('File uploaded successfully to Google Drive!');
                    fileInput.value = '';
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Upload error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleSaveInvoice() {
            const invoiceId = document.getElementById('editInvoiceId').value;
            if (!invoiceId) return;

            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;

            // Validate dedicated company
            if (!dedicatedCompany) {
                alert('Please select a company');
                return;
            }

            // Check for duplicate invoice number
            const invoiceNumber = document.getElementById('editInvoiceNumber').value.trim();
            if (invoiceNumber) {
                try {
                    const dupRes = await fetch(`/api/db/check-invoice-number?invoice_number=${encodeURIComponent(invoiceNumber)}&exclude_id=${invoiceId}`);
                    const dupResult = await dupRes.json();
                    if (dupResult.exists) {
                        const existing = dupResult.invoice;
                        alert(`Invoice number "${invoiceNumber}" already exists!\n\nExisting invoice:\n- Supplier: ${existing.supplier}\n- Date: ${existing.invoice_date}\n- Value: ${existing.invoice_value} ${existing.currency}`);
                        return;
                    }
                } catch (e) {
                    console.error('Error checking duplicate:', e);
                }
            }

            // Validate allocations
            const totalPercent = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_percent) || 0), 0);
            if (Math.abs(totalPercent - 100) > 0.01) {
                alert(`Allocations must sum to 100%. Current total: ${totalPercent.toFixed(2)}%`);
                return;
            }

            // Validate all allocations have a department
            for (let idx = 0; idx < editAllocations.length; idx++) {
                const alloc = editAllocations[idx];
                if (!alloc.department) {
                    alert('Please select a department for all allocations');
                    return;
                }

                // Validate reinvoice fields if reinvoice is set (Brand first, then Department, then Subdepartment)
                if (alloc.reinvoice_to) {
                    // Check if reinvoice brand is mandatory (brands exist for selected reinvoice company)
                    const reinvoiceBrandSelect = document.querySelector(`.alloc-reinvoice-brand[data-idx="${idx}"]`);
                    if (reinvoiceBrandSelect) {
                        const hasReinvoiceBrands = reinvoiceBrandSelect.options.length > 1; // More than just "N/A"
                        if (hasReinvoiceBrands && !alloc.reinvoice_brand) {
                            alert('Please select a reinvoice brand (brands are available for the selected reinvoice company)');
                            return;
                        }
                    }

                    // Check if reinvoice department is mandatory (departments exist for selected reinvoice company)
                    const reinvoiceDeptSelect = document.querySelector(`.alloc-reinvoice-dept[data-idx="${idx}"]`);
                    if (reinvoiceDeptSelect) {
                        const hasReinvoiceDepts = reinvoiceDeptSelect.options.length > 1; // More than just "Select department..."
                        if (hasReinvoiceDepts && !alloc.reinvoice_department) {
                            alert('Please select a reinvoice department (departments are available for the selected reinvoice company)');
                            return;
                        }
                    }

                    // Check if reinvoice subdepartment is mandatory (subdepartments exist for selected reinvoice department)
                    if (alloc.reinvoice_department) {
                        const reinvoiceSubdeptSelect = document.querySelector(`.alloc-reinvoice-subdept[data-idx="${idx}"]`);
                        if (reinvoiceSubdeptSelect) {
                            const hasReinvoiceSubdepts = reinvoiceSubdeptSelect.options.length > 1; // More than just "N/A"
                            if (hasReinvoiceSubdepts && !alloc.reinvoice_subdepartment) {
                                alert('Please select a reinvoice subdepartment (subdepartments are available for the selected reinvoice department)');
                                return;
                            }
                        }
                    }
                }
            }

            // Calculate allocation values and set company for all allocations
            const allocationsWithValues = editAllocations.map(a => ({
                ...a,
                company: dedicatedCompany,  // Use dedicated company for all
                allocation_percent: parseFloat(a.allocation_percent) || 0,
                allocation_value: (invoiceValue * (parseFloat(a.allocation_percent) || 0)) / 100
            }));

            const data = {
                supplier: document.getElementById('editSupplier').value,
                invoice_number: document.getElementById('editInvoiceNumber').value,
                invoice_date: document.getElementById('editInvoiceDate').value,
                invoice_value: invoiceValue,
                currency: document.getElementById('editCurrency').value,
                drive_link: document.getElementById('editDriveLink').value,
                comment: document.getElementById('editComment').value
            };

            try {
                // Save invoice details
                const invoiceRes = await fetch(`/api/db/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const invoiceResult = await invoiceRes.json();

                if (!invoiceResult.success && invoiceRes.status !== 404) {
                    alert('Error updating invoice: ' + (invoiceResult.error || 'Unknown error'));
                    return;
                }

                // Save allocations
                const allocRes = await fetch(`/api/db/invoices/${invoiceId}/allocations`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ allocations: allocationsWithValues })
                });
                const allocResult = await allocRes.json();

                if (allocResult.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                    // Clear the cache for this invoice
                    delete invoicesWithAllocations[invoiceId];
                    loadData();
                    alert('Invoice and allocations updated successfully!');
                } else {
                    alert('Error updating allocations: ' + (allocResult.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ============== ALLOCATION EDITING FUNCTIONS ==============

        function getUniqueCompanies() {
            return [...new Set(organizationalStructure.map(s => s.company))].sort();
        }

        function getDepartmentsForCompany(company) {
            return [...new Set(organizationalStructure
                .filter(s => s.company === company)
                .map(s => s.department))].sort();
        }

        function getSubdepartmentsForDept(company, department) {
            return organizationalStructure
                .filter(s => s.company === company && s.department === department && s.subdepartment)
                .map(s => s.subdepartment)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();
        }

        function getBrandsForCompany(company) {
            return organizationalStructure
                .filter(s => s.company === company && s.brand)
                .map(s => s.brand)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();
        }

        function getResponsible(company, department, subdepartment) {
            const match = organizationalStructure.find(s =>
                s.company === company &&
                s.department === department &&
                (!subdepartment || s.subdepartment === subdepartment)
            );
            return match ? match.manager : '';
        }

        function renderEditAllocations() {
            const container = document.getElementById('allocationsContainer');
            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const companies = getUniqueCompanies();
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;

            // Get departments/brands for the dedicated company
            const departments = getDepartmentsForCompany(dedicatedCompany);
            const brands = getBrandsForCompany(dedicatedCompany);

            container.innerHTML = editAllocations.map((alloc, idx) => {
                const subdepartments = getSubdepartmentsForDept(dedicatedCompany, alloc.department);
                const allocValue = (invoiceValue * (parseFloat(alloc.allocation_percent) || 0)) / 100;

                return `
                    <div class="allocation-edit-row position-relative" data-idx="${idx}">
                        <button type="button" class="btn btn-sm btn-outline-danger delete-allocation-btn" onclick="deleteAllocation(${idx})" ${editAllocations.length <= 1 ? 'disabled' : ''}>
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="row">
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Brand</label>
                                <select class="form-select alloc-brand" data-idx="${idx}" onchange="onAllocationFieldChange(${idx})">
                                    <option value="">N/A</option>
                                    ${brands.map(b => `<option value="${b}" ${b === alloc.brand ? 'selected' : ''}>${b}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Department</label>
                                <select class="form-select alloc-department" data-idx="${idx}" onchange="onAllocationDeptChange(${idx})">
                                    <option value="">Select...</option>
                                    ${departments.map(d => `<option value="${d}" ${d === alloc.department ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Subdepartment</label>
                                <select class="form-select alloc-subdepartment" data-idx="${idx}" onchange="onAllocationFieldChange(${idx})">
                                    <option value="">N/A</option>
                                    ${subdepartments.map(s => `<option value="${s}" ${s === alloc.subdepartment ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Allocation %</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control alloc-percent" data-idx="${idx}"
                                           value="${alloc.allocation_percent || ''}" min="0" max="100" step="0.01"
                                           onchange="onAllocationPercentChange(${idx})" onkeyup="onAllocationPercentChange(${idx})">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Value</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control alloc-value" data-idx="${idx}"
                                           value="${allocValue.toFixed(2)}" min="0" step="0.01"
                                           onchange="onAllocationValueChange(${idx})" onkeyup="onAllocationValueChange(${idx})">
                                    <span class="input-group-text">${document.getElementById('editCurrency').value}</span>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Manager: ${alloc.responsible || '--'}</small>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input alloc-reinvoice-check" type="checkbox" data-idx="${idx}"
                                           ${alloc.reinvoice_to ? 'checked' : ''} onchange="onReinvoiceCheckChange(${idx})">
                                    <label class="form-check-label small">Reinvoice to:</label>
                                </div>
                            </div>
                        </div>
                        <div class="row reinvoice-fields-row" data-idx="${idx}" style="${alloc.reinvoice_to ? '' : 'display: none;'}">
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm alloc-reinvoice" data-idx="${idx}" onchange="onReinvoiceCompanyChange(${idx})">
                                    <option value="">Select company...</option>
                                    ${companies.map(c => `<option value="${c}" ${c === alloc.reinvoice_to ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <select class="form-select form-select-sm alloc-reinvoice-brand" data-idx="${idx}" onchange="onReinvoiceBrandChange(${idx})">
                                    <option value="">N/A</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <select class="form-select form-select-sm alloc-reinvoice-dept" data-idx="${idx}" onchange="onReinvoiceDeptChange(${idx})">
                                    <option value="">Select department...</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <select class="form-select form-select-sm alloc-reinvoice-subdept" data-idx="${idx}" onchange="onAllocationFieldChange(${idx})">
                                    <option value="">N/A</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateAllocationTotalBadge();

            // Populate reinvoice dept/subdept dropdowns for allocations with existing reinvoice data
            initializeReinvoiceDropdowns();
        }

        async function initializeReinvoiceDropdowns() {
            for (let idx = 0; idx < editAllocations.length; idx++) {
                const alloc = editAllocations[idx];
                if (alloc.reinvoice_to) {
                    const brandSelect = document.querySelector(`.alloc-reinvoice-brand[data-idx="${idx}"]`);
                    const deptSelect = document.querySelector(`.alloc-reinvoice-dept[data-idx="${idx}"]`);
                    const subdeptSelect = document.querySelector(`.alloc-reinvoice-subdept[data-idx="${idx}"]`);

                    // Fetch brands and departments in parallel
                    const [brands, depts] = await Promise.all([
                        fetch(`/api/brands/${encodeURIComponent(alloc.reinvoice_to)}`).then(r => r.json()),
                        fetch(`/api/departments/${encodeURIComponent(alloc.reinvoice_to)}`).then(r => r.json())
                    ]);

                    // Populate brands
                    brandSelect.innerHTML = '<option value="">N/A</option>';
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        if (b === alloc.reinvoice_brand) opt.selected = true;
                        brandSelect.appendChild(opt);
                    });

                    // Populate departments
                    deptSelect.innerHTML = '<option value="">Select department...</option>';
                    depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        if (d === alloc.reinvoice_department) opt.selected = true;
                        deptSelect.appendChild(opt);
                    });

                    // Fetch and populate subdepartments if department is set
                    if (alloc.reinvoice_department) {
                        const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(alloc.reinvoice_to)}/${encodeURIComponent(alloc.reinvoice_department)}`).then(r => r.json());
                        subdeptSelect.innerHTML = '<option value="">N/A</option>';
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            if (s === alloc.reinvoice_subdepartment) opt.selected = true;
                            subdeptSelect.appendChild(opt);
                        });
                    }
                }
            }
        }

        function updateAllocationTotalBadge() {
            const totalPercent = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_percent) || 0), 0);
            const totalValue = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_value) || 0), 0);
            const currency = document.getElementById('editCurrency').value || 'RON';
            const badge = document.getElementById('allocationTotalBadge');
            badge.textContent = `${totalPercent.toFixed(2)}% | ${formatCurrency(totalValue)} ${currency}`;
            badge.className = Math.abs(totalPercent - 100) < 0.01 ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';
        }

        function onDedicatedCompanyChange() {
            // Reset all allocations when company changes
            const company = document.getElementById('editDedicatedCompany').value;
            editAllocations.forEach(alloc => {
                alloc.company = company;
                alloc.department = '';
                alloc.subdepartment = '';
                alloc.brand = '';
                alloc.responsible = '';
            });
            renderEditAllocations();
        }

        function onAllocationDeptChange(idx) {
            const company = document.getElementById('editDedicatedCompany').value;
            const department = document.querySelector(`.alloc-department[data-idx="${idx}"]`).value;

            editAllocations[idx].department = department;
            editAllocations[idx].subdepartment = '';
            editAllocations[idx].responsible = getResponsible(company, department, null);
            renderEditAllocations();
        }

        function onAllocationFieldChange(idx) {
            const row = document.querySelector(`.allocation-edit-row[data-idx="${idx}"]`);
            const company = document.getElementById('editDedicatedCompany').value;

            editAllocations[idx].subdepartment = row.querySelector('.alloc-subdepartment').value || null;
            editAllocations[idx].brand = row.querySelector('.alloc-brand').value || null;
            editAllocations[idx].reinvoice_to = row.querySelector('.alloc-reinvoice').value || null;
            editAllocations[idx].reinvoice_brand = row.querySelector('.alloc-reinvoice-brand').value || null;
            editAllocations[idx].reinvoice_department = row.querySelector('.alloc-reinvoice-dept').value || null;
            editAllocations[idx].reinvoice_subdepartment = row.querySelector('.alloc-reinvoice-subdept').value || null;

            // Update responsible based on company/dept/subdept
            const department = editAllocations[idx].department;
            const subdepartment = editAllocations[idx].subdepartment;
            editAllocations[idx].responsible = getResponsible(company, department, subdepartment);
        }

        function onReinvoiceCheckChange(idx) {
            const checked = document.querySelector(`.alloc-reinvoice-check[data-idx="${idx}"]`).checked;
            const fieldsRow = document.querySelector(`.reinvoice-fields-row[data-idx="${idx}"]`);

            if (checked) {
                fieldsRow.style.display = '';
            } else {
                fieldsRow.style.display = 'none';
                document.querySelector(`.alloc-reinvoice[data-idx="${idx}"]`).value = '';
                document.querySelector(`.alloc-reinvoice-brand[data-idx="${idx}"]`).innerHTML = '<option value="">N/A</option>';
                document.querySelector(`.alloc-reinvoice-dept[data-idx="${idx}"]`).innerHTML = '<option value="">Select department...</option>';
                document.querySelector(`.alloc-reinvoice-subdept[data-idx="${idx}"]`).innerHTML = '<option value="">N/A</option>';
                editAllocations[idx].reinvoice_to = null;
                editAllocations[idx].reinvoice_brand = null;
                editAllocations[idx].reinvoice_department = null;
                editAllocations[idx].reinvoice_subdepartment = null;
            }
        }

        async function onReinvoiceCompanyChange(idx) {
            const company = document.querySelector(`.alloc-reinvoice[data-idx="${idx}"]`).value;
            const brandSelect = document.querySelector(`.alloc-reinvoice-brand[data-idx="${idx}"]`);
            const deptSelect = document.querySelector(`.alloc-reinvoice-dept[data-idx="${idx}"]`);
            const subdeptSelect = document.querySelector(`.alloc-reinvoice-subdept[data-idx="${idx}"]`);

            editAllocations[idx].reinvoice_to = company || null;
            editAllocations[idx].reinvoice_brand = null;
            editAllocations[idx].reinvoice_department = null;
            editAllocations[idx].reinvoice_subdepartment = null;

            brandSelect.innerHTML = '<option value="">N/A</option>';
            deptSelect.innerHTML = '<option value="">Select department...</option>';
            subdeptSelect.innerHTML = '<option value="">N/A</option>';

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    brandSelect.appendChild(opt);
                });
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });
            }
        }

        function onReinvoiceBrandChange(idx) {
            const brand = document.querySelector(`.alloc-reinvoice-brand[data-idx="${idx}"]`).value;
            editAllocations[idx].reinvoice_brand = brand || null;
        }

        async function onReinvoiceDeptChange(idx) {
            const company = document.querySelector(`.alloc-reinvoice[data-idx="${idx}"]`).value;
            const department = document.querySelector(`.alloc-reinvoice-dept[data-idx="${idx}"]`).value;
            const subdeptSelect = document.querySelector(`.alloc-reinvoice-subdept[data-idx="${idx}"]`);

            editAllocations[idx].reinvoice_department = department || null;
            editAllocations[idx].reinvoice_subdepartment = null;

            subdeptSelect.innerHTML = '<option value="">N/A</option>';

            if (company && department) {
                const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(department)}`).then(r => r.json());
                subdepts.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    subdeptSelect.appendChild(opt);
                });
            }
        }

        function onAllocationPercentChange(idx) {
            const percent = parseFloat(document.querySelector(`.alloc-percent[data-idx="${idx}"]`).value) || 0;
            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            editAllocations[idx].allocation_percent = percent;
            editAllocations[idx].allocation_value = (invoiceValue * percent) / 100;

            // Update value field without re-rendering (to avoid losing focus)
            const valueInput = document.querySelector(`.alloc-value[data-idx="${idx}"]`);
            if (valueInput) {
                valueInput.value = editAllocations[idx].allocation_value.toFixed(2);
            }

            // Redistribute remaining to other allocations
            redistributeOtherAllocations(idx);
        }

        function onAllocationValueChange(idx) {
            const value = parseFloat(document.querySelector(`.alloc-value[data-idx="${idx}"]`).value) || 0;
            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;

            editAllocations[idx].allocation_value = value;
            editAllocations[idx].allocation_percent = invoiceValue > 0 ? (value / invoiceValue) * 100 : 0;

            // Update percent field without re-rendering (to avoid losing focus)
            const percentInput = document.querySelector(`.alloc-percent[data-idx="${idx}"]`);
            if (percentInput) {
                percentInput.value = editAllocations[idx].allocation_percent.toFixed(2);
            }

            // Redistribute remaining to other allocations
            redistributeOtherAllocations(idx);
        }

        // Redistribute remaining percentage equally among other allocations
        function redistributeOtherAllocations(changedIdx) {
            const count = editAllocations.length;
            if (count <= 1) {
                updateAllocationTotalBadge();
                return;
            }

            const changedPercent = editAllocations[changedIdx].allocation_percent || 0;
            const remaining = 100 - changedPercent;
            const perOther = remaining / (count - 1);
            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;

            editAllocations.forEach((alloc, idx) => {
                if (idx !== changedIdx) {
                    alloc.allocation_percent = perOther;
                    alloc.allocation_value = (invoiceValue * perOther) / 100;

                    // Update UI without re-rendering
                    const pInput = document.querySelector(`.alloc-percent[data-idx="${idx}"]`);
                    const vInput = document.querySelector(`.alloc-value[data-idx="${idx}"]`);
                    if (pInput) pInput.value = perOther.toFixed(2);
                    if (vInput) vInput.value = alloc.allocation_value.toFixed(2);
                }
            });

            updateAllocationTotalBadge();
        }

        // Get smart split percentages based on count
        // 1: 100%, 2: 50-50, 3: 40-30-30, 4: 40-20-20-20, etc.
        function getSmartSplitEdit(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];

            // For 3+: first gets 40%, rest split equally
            const firstPercent = 40;
            const remaining = 100 - firstPercent;
            const otherPercent = remaining / (count - 1);

            const result = [firstPercent];
            for (let i = 1; i < count; i++) {
                result.push(otherPercent);
            }
            return result;
        }

        // Apply smart split to all allocations
        function applySmartSplit() {
            const count = editAllocations.length;
            if (count === 0) return;

            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const percentages = getSmartSplitEdit(count);

            editAllocations.forEach((alloc, idx) => {
                alloc.allocation_percent = percentages[idx];
                alloc.allocation_value = (invoiceValue * percentages[idx]) / 100;
            });

            renderEditAllocations();
        }

        function addNewAllocation() {
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;
            if (!dedicatedCompany) {
                alert('Please select a company first');
                return;
            }
            editAllocations.push({
                company: dedicatedCompany,
                brand: null,
                department: '',
                subdepartment: null,
                allocation_percent: 0,
                allocation_value: 0,
                responsible: '',
                reinvoice_to: null,
                reinvoice_brand: null,
                reinvoice_department: null,
                reinvoice_subdepartment: null
            });
            applySmartSplit(); // Redistribute with smart split when adding
        }

        function deleteAllocation(idx) {
            if (editAllocations.length <= 1) {
                alert('Invoice must have at least one allocation');
                return;
            }
            editAllocations.splice(idx, 1);
            applySmartSplit(); // Redistribute with smart split when removing
        }

        // Update allocation values when invoice value changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('editInvoiceValue').addEventListener('input', () => {
                if (editAllocations.length > 0) {
                    renderEditAllocations();
                }
            });

            // Toggle +/- icon on collapse show/hide
            document.addEventListener('show.bs.collapse', (e) => {
                const trigger = document.querySelector(`[href="#${e.target.id}"]`);
                if (trigger) {
                    const icon = trigger.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-plus-circle');
                        icon.classList.add('bi-dash-circle');
                    }
                }
            });
            document.addEventListener('hide.bs.collapse', (e) => {
                const trigger = document.querySelector(`[href="#${e.target.id}"]`);
                if (trigger) {
                    const icon = trigger.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-dash-circle');
                        icon.classList.add('bi-plus-circle');
                    }
                }
            });
        });

        // ============== END ALLOCATION EDITING FUNCTIONS ==============

        function updateSummaryCards() {
            document.getElementById('totalInvoices').textContent = allInvoices.length;

            // Calculate totals in both currencies
            // For RON: sum all values, converting EUR to RON where needed
            // For EUR: sum all values, converting RON to EUR where needed
            summaryTotalRon = 0;
            summaryTotalEur = 0;

            allInvoices.forEach(inv => {
                const value = inv.invoice_value || 0;
                const currency = (inv.currency || 'RON').toUpperCase();

                if (inv.value_ron && inv.value_eur) {
                    // Use pre-calculated values if available
                    summaryTotalRon += inv.value_ron;
                    summaryTotalEur += inv.value_eur;
                } else if (currency === 'EUR') {
                    // EUR invoice without pre-calculated values
                    summaryTotalEur += value;
                    summaryTotalRon += value * currentEurRate;
                } else {
                    // RON invoice without pre-calculated values
                    summaryTotalRon += value;
                    summaryTotalEur += value / currentEurRate;
                }
            });

            // Display based on toggle state
            const showEur = document.getElementById('currencyToggle').checked;
            updateTotalValueDisplay(showEur);

            // Count unique companies and departments from summaries
            fetch('/api/db/summary/company').then(r => r.json()).then(data => {
                document.getElementById('totalCompanies').textContent = data.length;
            });
            fetch('/api/db/summary/department').then(r => r.json()).then(data => {
                document.getElementById('totalDepartments').textContent = data.length;
            });
        }

        function updateTotalValueDisplay(showEur) {
            const totalValueEl = document.getElementById('totalValue');
            const toggleLabel = document.getElementById('currencyToggleLabel');

            if (showEur) {
                totalValueEl.textContent = formatCurrency(summaryTotalEur) + ' EUR';
                toggleLabel.textContent = 'RON';
            } else {
                totalValueEl.textContent = formatCurrency(summaryTotalRon) + ' RON';
                toggleLabel.textContent = 'EUR';
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0);
        }

        function formatDateRomanian(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        // ================= SORTING FUNCTIONS =================

        function applySorting() {
            const sortOrder = document.getElementById('sortOrder').value;
            let sortedInvoices = [...allInvoices];

            sortedInvoices.sort((a, b) => {
                const dateA = new Date(a.invoice_date || '1970-01-01');
                const dateB = new Date(b.invoice_date || '1970-01-01');

                if (sortOrder === 'newest') {
                    return dateB - dateA;
                } else {
                    return dateA - dateB;
                }
            });

            renderInvoicesTable(sortedInvoices);
        }

        // ================= SELECTION FUNCTIONS =================

        function toggleSelectAll(checkbox) {
            const isChecked = checkbox.checked;

            // Get currently displayed invoices (after filtering)
            const displayedInvoices = allInvoices;

            if (isChecked) {
                displayedInvoices.forEach(inv => selectedInvoices.add(inv.id));
            } else {
                displayedInvoices.forEach(inv => selectedInvoices.delete(inv.id));
            }

            // Update individual checkboxes
            document.querySelectorAll('#invoicesTable input.select-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });

            updateSelectionUI();
        }

        function toggleInvoiceSelect(id) {
            if (selectedInvoices.has(id)) {
                selectedInvoices.delete(id);
            } else {
                selectedInvoices.add(id);
            }

            updateSelectionUI();

            // Update select all checkbox state
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                const allChecked = allInvoices.length > 0 && allInvoices.every(inv => selectedInvoices.has(inv.id));
                selectAll.checked = allChecked;
            }
        }

        function updateSelectionUI() {
            const count = selectedInvoices.size;
            const bulkActionBar = document.getElementById('bulkActionBar');
            const selectedCountEl = document.getElementById('selectedCount');

            if (count > 0) {
                bulkActionBar.classList.add('show');
                selectedCountEl.textContent = count;
            } else {
                bulkActionBar.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedInvoices.clear();
            document.querySelectorAll('#invoicesTable input.select-checkbox, #selectAll').forEach(cb => {
                cb.checked = false;
            });
            updateSelectionUI();
        }

        // ================= BULK DELETE FUNCTIONS =================

        async function bulkDeleteSelected() {
            if (selectedInvoices.size === 0) return;

            if (!confirm(`Are you sure you want to move ${selectedInvoices.size} invoice(s) to the bin?`)) {
                return;
            }

            try {
                const invoice_ids = Array.from(selectedInvoices);
                const response = await fetch('/api/db/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    // Remove deleted invoices from local data
                    allInvoices = allInvoices.filter(inv => !selectedInvoices.has(inv.id));
                    selectedInvoices.clear();

                    // Re-render table
                    applySorting();
                    updateSummaryCards();
                    loadBinCount();

                    alert(`${result.deleted_count} invoice(s) moved to bin.`);
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (err) {
                console.error('Bulk delete error:', err);
                alert('Error deleting invoices');
            }
        }

        // ================= BIN FUNCTIONS =================

        async function loadBinCount() {
            try {
                const response = await fetch('/api/db/invoices/bin');
                const data = await response.json();
                const count = data.length;

                const binBadge = document.getElementById('binCount');
                if (count > 0) {
                    binBadge.textContent = count;
                    binBadge.style.display = 'inline';
                } else {
                    binBadge.style.display = 'none';
                }
            } catch (err) {
                console.error('Error loading bin count:', err);
            }
        }

        async function loadBinData() {
            const tbody = document.getElementById('binTable');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

            try {
                const response = await fetch('/api/db/invoices/bin');
                binInvoices = await response.json();
                renderBinTable();
            } catch (err) {
                console.error('Error loading bin data:', err);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading deleted invoices</td></tr>';
            }
        }

        function renderBinTable() {
            const tbody = document.getElementById('binTable');

            if (binInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No deleted invoices in bin</td></tr>';
                document.getElementById('binCount').style.display = 'none';
                return;
            }

            // Update bin count badge
            document.getElementById('binCount').textContent = binInvoices.length;
            document.getElementById('binCount').style.display = 'inline';

            tbody.innerHTML = binInvoices.map(inv => {
                const checked = selectedBinInvoices.has(inv.id) ? 'checked' : '';
                const deletedAt = inv.deleted_at ? formatDateRomanian(inv.deleted_at) : '-';
                return `
                    <tr class="deleted-row">
                        <td><input type="checkbox" class="select-checkbox" data-bin-id="${inv.id}" onchange="toggleBinInvoiceSelect(${inv.id})" ${checked}></td>
                        <td>${inv.id}</td>
                        <td>${formatDateRomanian(inv.invoice_date)}</td>
                        <td>${inv.supplier || '-'}</td>
                        <td><code>${inv.invoice_number || '-'}</code></td>
                        <td>${formatCurrency(inv.invoice_value)} ${inv.currency || 'RON'}</td>
                        <td>${deletedAt}</td>
                        <td>
                            <button class="btn btn-outline-success btn-sm" onclick="restoreInvoice(${inv.id})" title="Restore">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="permanentDeleteInvoice(${inv.id})" title="Delete Permanently">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateBinSelectionUI();
        }

        function toggleBinSelectAll(checkbox) {
            const isChecked = checkbox.checked;

            if (isChecked) {
                binInvoices.forEach(inv => selectedBinInvoices.add(inv.id));
            } else {
                selectedBinInvoices.clear();
            }

            document.querySelectorAll('#binTable input.select-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });

            updateBinSelectionUI();
        }

        function toggleBinInvoiceSelect(id) {
            if (selectedBinInvoices.has(id)) {
                selectedBinInvoices.delete(id);
            } else {
                selectedBinInvoices.add(id);
            }

            updateBinSelectionUI();

            // Update select all checkbox state
            const selectAll = document.getElementById('binSelectAll');
            if (selectAll) {
                const allChecked = binInvoices.length > 0 && binInvoices.every(inv => selectedBinInvoices.has(inv.id));
                selectAll.checked = allChecked;
            }
        }

        function updateBinSelectionUI() {
            const count = selectedBinInvoices.size;
            const restoreBtn = document.getElementById('binRestoreBtn');
            const deleteBtn = document.getElementById('binPermanentDeleteBtn');

            restoreBtn.disabled = count === 0;
            deleteBtn.disabled = count === 0;
        }

        async function restoreInvoice(id) {
            if (!confirm('Restore this invoice from the bin?')) return;

            try {
                const response = await fetch(`/api/db/invoices/${id}/restore`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadBinData();
                    loadData();
                } else {
                    const result = await response.json();
                    alert('Error: ' + (result.error || 'Failed to restore'));
                }
            } catch (err) {
                console.error('Restore error:', err);
                alert('Error restoring invoice');
            }
        }

        async function permanentDeleteInvoice(id) {
            if (!confirm('PERMANENTLY delete this invoice? This cannot be undone!')) return;

            try {
                const response = await fetch(`/api/db/invoices/${id}/permanent`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadBinData();
                } else {
                    const result = await response.json();
                    alert('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (err) {
                console.error('Permanent delete error:', err);
                alert('Error deleting invoice');
            }
        }

        async function bulkRestoreSelected() {
            if (selectedBinInvoices.size === 0) return;

            if (!confirm(`Restore ${selectedBinInvoices.size} invoice(s) from the bin?`)) return;

            try {
                const invoice_ids = Array.from(selectedBinInvoices);
                const response = await fetch('/api/db/invoices/bulk-restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    selectedBinInvoices.clear();
                    loadBinData();
                    loadData();
                    alert(`${result.restored_count} invoice(s) restored.`);
                } else {
                    alert('Error: ' + (result.error || 'Failed to restore'));
                }
            } catch (err) {
                console.error('Bulk restore error:', err);
                alert('Error restoring invoices');
            }
        }

        async function bulkPermanentDeleteSelected() {
            if (selectedBinInvoices.size === 0) return;

            if (!confirm(`PERMANENTLY delete ${selectedBinInvoices.size} invoice(s)? This cannot be undone!`)) return;

            try {
                const invoice_ids = Array.from(selectedBinInvoices);
                const response = await fetch('/api/db/invoices/bulk-permanent-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    selectedBinInvoices.clear();
                    loadBinData();
                    alert(`${result.deleted_count} invoice(s) permanently deleted.`);
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (err) {
                console.error('Bulk permanent delete error:', err);
                alert('Error deleting invoices');
            }
        }

        // Load bin count on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBinCount();
        });
    </script>
</body>
</html>
