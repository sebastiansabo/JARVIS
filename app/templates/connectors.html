<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connectors - Invoice Integrations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .connector-card { transition: transform 0.2s; }
        .connector-card:hover { transform: translateY(-2px); }
        .connector-icon { font-size: 2.5rem; }
        .status-badge { font-size: 0.8em; }
        .sync-log { font-size: 0.85em; }
        .sync-log-item { border-left: 3px solid #dee2e6; padding-left: 10px; margin-bottom: 8px; }
        .sync-log-item.success { border-left-color: #198754; }
        .sync-log-item.error { border-left-color: #dc3545; }
        .sync-log-item.running { border-left-color: #0d6efd; }
        .connector-unavailable { opacity: 0.6; }
        .coming-soon-badge { font-size: 0.7em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-plug"></i> Connectors
            </span>
            <div class="d-flex align-items-center">
                {% if current_user.can_access_settings %}
                <a href="/settings" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-gear"></i> Settings
                </a>
                {% endif %}
                {% if current_user.can_access_accounting %}
                <a href="/accounting" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
                {% endif %}
                {% if current_user.can_add_invoices %}
                <a href="/add-invoice" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plus-circle"></i> New Invoice
                </a>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ current_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text text-muted small">{{ current_user.email }}</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="bi bi-key"></i> Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Info Banner -->
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Connectors</strong> allow you to automatically import invoices from external services like Google Ads and Meta (Facebook) advertising platforms.
        </div>

        <!-- Available Connectors -->
        <h5 class="mb-3"><i class="bi bi-collection"></i> Available Integrations</h5>

        <div class="row g-4 mb-5">
            <!-- Google Ads Connector -->
            <div class="col-md-6 col-lg-4">
                <div class="card connector-card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="connector-icon text-danger me-3">
                                <i class="bi bi-google"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">Google Ads</h5>
                                <small class="text-muted">Advertising invoices</small>
                            </div>
                        </div>

                        {% if google_ads_connector %}
                            <div class="mb-3">
                                <span class="badge {% if google_ads_connector.status == 'connected' %}bg-success{% elif google_ads_connector.status == 'error' %}bg-danger{% else %}bg-secondary{% endif %} status-badge">
                                    {{ google_ads_connector.status | title }}
                                </span>
                                {% if google_ads_connector.last_sync %}
                                    <small class="text-muted ms-2">
                                        Last sync: {{ google_ads_connector.last_sync.strftime('%d.%m.%Y %H:%M') }}
                                    </small>
                                {% endif %}
                            </div>

                            {% if google_ads_connector.last_error %}
                                <div class="alert alert-danger py-1 px-2 small mb-3">
                                    {{ google_ads_connector.last_error }}
                                </div>
                            {% endif %}

                            <div class="d-flex gap-2">
                                <button class="btn btn-primary btn-sm" onclick="syncConnector({{ google_ads_connector.id }})">
                                    <i class="bi bi-arrow-repeat"></i> Sync Now
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="configureConnector({{ google_ads_connector.id }}, 'google_ads')">
                                    <i class="bi bi-gear"></i> Configure
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="disconnectConnector({{ google_ads_connector.id }})">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        {% else %}
                            <p class="text-muted small mb-3">
                                Connect your Google Ads account to automatically import advertising invoices.
                                Requires monthly invoicing to be enabled in Google Ads.
                            </p>
                            <button class="btn btn-outline-primary" onclick="showConnectModal('google_ads')">
                                <i class="bi bi-link-45deg"></i> Connect
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Meta (Facebook) Connector -->
            <div class="col-md-6 col-lg-4">
                <div class="card connector-card h-100 connector-unavailable">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="connector-icon text-primary me-3">
                                <i class="bi bi-meta"></i>
                            </div>
                            <div>
                                <h5 class="card-title mb-0">
                                    Meta (Facebook)
                                    <span class="badge bg-warning text-dark coming-soon-badge">Coming Soon</span>
                                </h5>
                                <small class="text-muted">Advertising invoices</small>
                            </div>
                        </div>

                        <p class="text-muted small mb-3">
                            Meta does not provide a public API for invoices.
                            Future versions may support automated download via browser automation.
                        </p>

                        <button class="btn btn-outline-secondary" disabled>
                            <i class="bi bi-hourglass-split"></i> Not Available
                        </button>
                    </div>
                </div>
            </div>

            <!-- Future: More Connectors -->
            <div class="col-md-6 col-lg-4">
                <div class="card connector-card h-100 connector-unavailable">
                    <div class="card-body text-center py-5">
                        <div class="connector-icon text-muted mb-3">
                            <i class="bi bi-plus-circle-dotted"></i>
                        </div>
                        <h5 class="card-title text-muted">More Coming Soon</h5>
                        <p class="text-muted small">
                            LinkedIn Ads, TikTok Ads, and more integrations planned.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Connected Connectors with Sync History -->
        {% if connectors %}
        <h5 class="mb-3"><i class="bi bi-clock-history"></i> Sync History</h5>

        <div class="card mb-4">
            <div class="card-body">
                <ul class="nav nav-tabs" id="connectorTabs" role="tablist">
                    {% for connector in connectors %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}"
                                id="tab-{{ connector.id }}"
                                data-bs-toggle="tab"
                                data-bs-target="#logs-{{ connector.id }}"
                                type="button">
                            {{ connector.name }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>

                <div class="tab-content pt-3" id="connectorTabContent">
                    {% for connector in connectors %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                         id="logs-{{ connector.id }}"
                         role="tabpanel">

                        <div id="syncLogs-{{ connector.id }}" class="sync-log">
                            {% if connector.sync_logs %}
                                {% for log in connector.sync_logs %}
                                <div class="sync-log-item {{ log.status }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>{{ log.sync_type | title }}</strong>
                                            <span class="badge {% if log.status == 'success' %}bg-success{% elif log.status == 'error' %}bg-danger{% else %}bg-info{% endif %} ms-2">
                                                {{ log.status }}
                                            </span>
                                        </div>
                                        <small class="text-muted">{{ log.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                    </div>
                                    {% if log.invoices_found > 0 or log.invoices_imported > 0 %}
                                    <small class="text-muted">
                                        Found: {{ log.invoices_found }} | Imported: {{ log.invoices_imported }}
                                    </small>
                                    {% endif %}
                                    {% if log.error_message %}
                                    <div class="text-danger small mt-1">{{ log.error_message }}</div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted">No sync history yet. Click "Sync Now" to fetch invoices.</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Connect Modal -->
    <div class="modal fade" id="connectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-link-45deg"></i> Connect <span id="connectModalTitle"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="connectForm">
                        <input type="hidden" id="connectorType" name="connector_type">

                        <!-- Google Ads specific fields -->
                        <div id="googleAdsFields" style="display: none;">
                            <div class="alert alert-warning small">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Requirements:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>Monthly invoicing must be enabled in Google Ads</li>
                                    <li>You need a Google Ads Developer Token</li>
                                    <li>OAuth credentials for your Google account</li>
                                </ul>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Connector Name</label>
                                <input type="text" class="form-control" name="name" value="Google Ads" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-control" name="customer_id"
                                       placeholder="123-456-7890" pattern="[\d-]+" required>
                                <small class="text-muted">Your Google Ads account ID (without dashes)</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Developer Token</label>
                                <input type="password" class="form-control" name="developer_token" required>
                                <small class="text-muted">From Google Ads API Center</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">OAuth Client ID</label>
                                <input type="text" class="form-control" name="oauth_client_id">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">OAuth Client Secret</label>
                                <input type="password" class="form-control" name="oauth_client_secret">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Refresh Token</label>
                                <input type="password" class="form-control" name="refresh_token">
                                <small class="text-muted">OAuth refresh token for API access</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveConnector()">
                        <i class="bi bi-check-lg"></i> Connect
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Configure Modal -->
    <div class="modal fade" id="configureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i> Configure Connector
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="configureForm">
                        <input type="hidden" id="configureConnectorId" name="connector_id">

                        <div class="mb-3">
                            <label class="form-label">Connector Name</label>
                            <input type="text" class="form-control" id="configureName" name="name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Customer ID</label>
                            <input type="text" class="form-control" id="configureCustomerId" name="customer_id">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Developer Token</label>
                            <input type="password" class="form-control" id="configureDeveloperToken" name="developer_token"
                                   placeholder="Leave blank to keep existing">
                        </div>

                        <hr>
                        <p class="text-muted small">Leave credential fields blank to keep existing values.</p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateConnector()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const connectModal = new bootstrap.Modal(document.getElementById('connectModal'));
        const configureModal = new bootstrap.Modal(document.getElementById('configureModal'));

        function showConnectModal(connectorType) {
            document.getElementById('connectorType').value = connectorType;

            // Hide all connector-specific fields
            document.getElementById('googleAdsFields').style.display = 'none';

            // Show appropriate fields
            if (connectorType === 'google_ads') {
                document.getElementById('connectModalTitle').textContent = 'Google Ads';
                document.getElementById('googleAdsFields').style.display = 'block';
            }

            connectModal.show();
        }

        async function saveConnector() {
            const form = document.getElementById('connectForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/connectors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    connectModal.hide();
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to save connector'));
                }
            } catch (err) {
                alert('Error connecting: ' + err.message);
            }
        }

        function configureConnector(connectorId, connectorType) {
            document.getElementById('configureConnectorId').value = connectorId;

            // Fetch current config
            fetch(`/api/connectors/${connectorId}`)
                .then(r => r.json())
                .then(connector => {
                    document.getElementById('configureName').value = connector.name || '';
                    document.getElementById('configureCustomerId').value = connector.config?.customer_id || '';
                    configureModal.show();
                });
        }

        async function updateConnector() {
            const form = document.getElementById('configureForm');
            const formData = new FormData(form);
            const connectorId = formData.get('connector_id');
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`/api/connectors/${connectorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    configureModal.hide();
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to update connector'));
                }
            } catch (err) {
                alert('Error updating: ' + err.message);
            }
        }

        async function syncConnector(connectorId) {
            if (!confirm('Start syncing invoices from this connector?')) return;

            try {
                const response = await fetch(`/api/connectors/${connectorId}/sync`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`Sync complete!\nFound: ${result.invoices_found}\nImported: ${result.invoices_imported}`);
                    location.reload();
                } else {
                    alert('Sync failed: ' + (result.error || 'Unknown error'));
                    location.reload();
                }
            } catch (err) {
                alert('Error syncing: ' + err.message);
            }
        }

        async function disconnectConnector(connectorId) {
            if (!confirm('Are you sure you want to disconnect this connector? This will remove all configuration.')) return;

            try {
                const response = await fetch(`/api/connectors/${connectorId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + (error.error || 'Failed to disconnect'));
                }
            } catch (err) {
                alert('Error disconnecting: ' + err.message);
            }
        }
    </script>
</body>
</html>
