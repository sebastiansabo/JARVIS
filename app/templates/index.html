<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Cost Distribution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .allocation-row { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .allocation-row:hover { background: #e9ecef; }
        .drag-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .drag-drop-zone:hover, .drag-drop-zone.dragover {
            border-color: #0d6efd;
            background: #f0f7ff;
        }
        .parsing-spinner { display: none; }
        .parsing .parsing-spinner { display: inline-block; }
        .total-allocation { font-size: 1.2em; font-weight: bold; }
        .total-allocation.valid { color: #198754; }
        .total-allocation.invalid { color: #dc3545; }
        .existing-invoices { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-receipt"></i> Invoice Cost Distribution
            </span>
            <div class="d-flex align-items-center">
                <a href="/settings" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-gear"></i> Settings
                </a>
                <a href="/templates" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-file-earmark-text"></i> Templates
                </a>
                <a href="/connectors" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plug"></i> Connectors
                </a>
                <a href="/accounting" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ current_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text text-muted small">{{ current_user.email }}</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="bi bi-key"></i> Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <!-- Left Column: Invoice Input -->
            <div class="col-md-5">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-upload"></i> Invoice Input</h5>
                    </div>
                    <div class="card-body">
                        <!-- File Upload -->
                        <div class="drag-drop-zone mb-3" id="dropZone">
                            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                            <p class="mb-0 mt-2">Drag & drop invoice here or click to upload</p>
                            <small class="text-muted">Supports PDF, JPG, PNG</small>
                            <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
                        </div>

                        <!-- Template Selector -->
                        <div class="mb-3">
                            <label class="form-label small">Parse Method</label>
                            <select class="form-select form-select-sm" id="templateSelect">
                                <option value="">Auto-detect (AI fallback)</option>
                            </select>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <button class="btn btn-primary w-100" id="parseBtn">
                                    <span class="parsing-spinner spinner-border spinner-border-sm me-2"></span>
                                    <i class="bi bi-magic" id="parseBtnIcon"></i> <span id="parseBtnText">Citeste Factura</span>
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary w-100" id="manualEntryBtn" title="Skip AI parsing and enter manually">
                                    <i class="bi bi-pencil"></i> Manual
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info small py-2 mb-3" id="entryModeAlert" style="display: none;">
                            <i class="bi bi-info-circle"></i> <span id="entryModeText"></span>
                        </div>

                        <!-- Invoice Details Form -->
                        <form id="invoiceForm">
                            <div class="mb-3">
                                <label class="form-label">Supplier *</label>
                                <input type="text" class="form-control" id="supplier" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Customer VAT</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="customerVat" placeholder="Auto-detected or enter manually">
                                        <button class="btn btn-outline-secondary" type="button" id="matchVatBtn" title="Match VAT to company">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Matched Company</label>
                                    <input type="text" class="form-control" id="matchedCompany" placeholder="Company matched by VAT" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Invoice Number *</label>
                                    <input type="text" class="form-control" id="invoiceNumber" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Invoice Date *</label>
                                    <input type="date" class="form-control" id="invoiceDate" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Invoice Value *</label>
                                    <input type="number" step="0.01" class="form-control" id="invoiceValue" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option value="RON">RON</option>
                                        <option value="EUR">EUR</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Currency Conversion Display -->
                            <div class="row mb-3" id="conversionDisplay" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-light py-2 mb-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-currency-exchange text-primary"></i>
                                            <span class="ms-2">
                                                <strong id="displayValueRon">0.00</strong> RON =
                                                <strong id="displayValueEur">0.00</strong> EUR
                                            </span>
                                        </div>
                                        <small class="text-muted" id="exchangeRateInfo">
                                            Rate: <span id="displayExchangeRate">0.0000</span> EUR/RON
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="driveLink">
                            <input type="hidden" id="valueRon">
                            <input type="hidden" id="valueEur">
                            <input type="hidden" id="exchangeRate">
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column: Cost Distribution -->
            <div class="col-md-7">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Cost Distribution</h5>
                        <button class="btn btn-sm btn-outline-primary" id="addAllocationBtn">
                            <i class="bi bi-plus"></i> Add Department
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Dedicated To (Company) *</label>
                                <select class="form-select" id="dedicatedCompany" required>
                                    <option value="">Select company...</option>
                                </select>
                            </div>
                            </div>
                        <hr>
                        <div id="allocationsContainer">
                            <!-- Allocation rows will be added here -->
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded">
                            <span>Total Allocation:</span>
                            <span class="total-allocation" id="totalAllocation">0%</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success btn-lg w-100" id="submitBtn">
                    <i class="bi bi-check-circle"></i> Save Distribution
                </button>
            </div>
        </div>
    </div>

    <!-- Allocation Row Template -->
    <template id="allocationTemplate">
        <div class="allocation-row">
            <div class="row align-items-end">
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Brand</label>
                    <select class="form-select form-select-sm brand-select">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Department</label>
                    <select class="form-select form-select-sm department-select" required>
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Subdepartment</label>
                    <select class="form-select form-select-sm subdepartment-select">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-4 col-md-2 mb-2">
                    <label class="form-label small">Allocation %</label>
                    <input type="number" class="form-control form-control-sm allocation-input" min="0" max="100" step="0.01" value="100" required>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Value</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control form-control-sm allocation-value-input" min="0" step="0.01" value="0">
                        <span class="input-group-text currency-label">RON</span>
                    </div>
                </div>
                <div class="col-2 col-md-2 mb-2 d-flex gap-1 align-items-end justify-content-end">
                    <button type="button" class="btn btn-outline-secondary btn-sm lock-allocation" title="Lock this allocation">
                        <i class="bi bi-unlock"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-allocation">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="row mt-1 align-items-center">
                <div class="col-md-6">
                    <small class="text-muted manager-display">Manager: --</small>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input reinvoice-check" type="checkbox" id="reinvoice">
                        <label class="form-check-label small" for="reinvoice">Reinvoice to:</label>
                    </div>
                </div>
            </div>
            <div class="row mt-1 reinvoice-fields" style="display: none;">
                <div class="col-md-3">
                    <select class="form-select form-select-sm reinvoice-company">
                        <option value="">Select company...</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm reinvoice-brand">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select form-select-sm reinvoice-department">
                        <option value="">Select department...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select form-select-sm reinvoice-subdepartment">
                        <option value="">N/A</option>
                    </select>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let companies = [];
        let structure = [];
        let companiesWithVat = []; // Companies with VAT from Comp sheet
        let invoiceTemplates = []; // Invoice parsing templates
        let uploadedFile = null; // Store uploaded file reference

        // Form cache key
        const FORM_CACHE_KEY = 'invoiceFormCache';
        let isInitializing = true; // Flag to prevent caching during initialization

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStructure();
            await loadCompaniesWithVat();
            await loadInvoiceTemplates();

            // Try to restore from cache first
            const restored = await restoreFormFromCache();

            // Only add default allocation row if nothing was restored
            if (!restored) {
                addAllocationRow();
            }

            setupEventListeners();
            setupFormCaching();

            // Enable caching after initialization is complete
            isInitializing = false;
        });

        // Save form data to localStorage
        function saveFormToCache() {
            // Don't save during initialization to prevent overwriting cached data
            if (isInitializing) return;
            const formData = {
                supplier: document.getElementById('supplier').value,
                customerVat: document.getElementById('customerVat').value,
                matchedCompany: document.getElementById('matchedCompany').value,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                invoiceValue: document.getElementById('invoiceValue').value,
                currency: document.getElementById('currency').value,
                dedicatedCompany: document.getElementById('dedicatedCompany').value,
                driveLink: document.getElementById('driveLink').value,
                valueRon: document.getElementById('valueRon').value,
                valueEur: document.getElementById('valueEur').value,
                exchangeRate: document.getElementById('exchangeRate').value,
                timestamp: Date.now()
            };

            // Save allocations
            const allocations = [];
            document.querySelectorAll('.allocation-row').forEach(row => {
                const lockBtn = row.querySelector('.lock-allocation');
                const lockIcon = lockBtn ? lockBtn.querySelector('i') : null;
                const isLocked = lockIcon && lockIcon.classList.contains('bi-lock-fill');
                allocations.push({
                    brand: row.querySelector('.brand-select').value,
                    department: row.querySelector('.department-select').value,
                    subdepartment: row.querySelector('.subdepartment-select').value,
                    allocation: row.querySelector('.allocation-input').value,
                    allocationValue: row.querySelector('.allocation-value-input').value,
                    locked: isLocked,
                    reinvoiceCheck: row.querySelector('.reinvoice-check').checked,
                    reinvoiceCompany: row.querySelector('.reinvoice-company').value,
                    reinvoiceBrand: row.querySelector('.reinvoice-brand').value,
                    reinvoiceDepartment: row.querySelector('.reinvoice-department').value,
                    reinvoiceSubdepartment: row.querySelector('.reinvoice-subdepartment').value
                });
            });
            formData.allocations = allocations;

            localStorage.setItem(FORM_CACHE_KEY, JSON.stringify(formData));
        }

        // Restore form data from localStorage
        // Returns true if meaningful data was restored, false otherwise
        async function restoreFormFromCache() {
            const cached = localStorage.getItem(FORM_CACHE_KEY);
            if (!cached) return false;

            try {
                const formData = JSON.parse(cached);

                // Check if cache is older than 24 hours
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                if (Date.now() - formData.timestamp > maxAge) {
                    localStorage.removeItem(FORM_CACHE_KEY);
                    return false;
                }

                // Check if there's any meaningful data to restore
                if (!formData.supplier && !formData.invoiceNumber && !formData.invoiceValue) {
                    return false;
                }

                // Restore basic fields
                if (formData.supplier) document.getElementById('supplier').value = formData.supplier;
                if (formData.customerVat) document.getElementById('customerVat').value = formData.customerVat;
                if (formData.matchedCompany) document.getElementById('matchedCompany').value = formData.matchedCompany;
                if (formData.invoiceNumber) document.getElementById('invoiceNumber').value = formData.invoiceNumber;
                if (formData.invoiceDate) document.getElementById('invoiceDate').value = formData.invoiceDate;
                if (formData.invoiceValue) document.getElementById('invoiceValue').value = formData.invoiceValue;
                if (formData.currency) document.getElementById('currency').value = formData.currency;
                if (formData.driveLink) document.getElementById('driveLink').value = formData.driveLink;
                if (formData.valueRon) document.getElementById('valueRon').value = formData.valueRon;
                if (formData.valueEur) document.getElementById('valueEur').value = formData.valueEur;
                if (formData.exchangeRate) document.getElementById('exchangeRate').value = formData.exchangeRate;

                // Show conversion display if values exist
                if (formData.valueRon && formData.valueEur) {
                    document.getElementById('displayValueRon').textContent = formatCurrency(parseFloat(formData.valueRon));
                    document.getElementById('displayValueEur').textContent = formatCurrency(parseFloat(formData.valueEur));
                    document.getElementById('displayExchangeRate').textContent = formData.exchangeRate ? parseFloat(formData.exchangeRate).toFixed(4) : '-';
                    document.getElementById('conversionDisplay').style.display = 'block';
                }

                // Restore dedicated company and wait for dropdowns to populate
                if (formData.dedicatedCompany) {
                    document.getElementById('dedicatedCompany').value = formData.dedicatedCompany;
                    await onDedicatedCompanyChange();

                    // Restore allocations after company change completes
                    if (formData.allocations && formData.allocations.length > 0) {
                        // Clear existing allocation rows and add the right number
                        const container = document.getElementById('allocationsContainer');
                        container.innerHTML = '';

                        for (let i = 0; i < formData.allocations.length; i++) {
                            await addAllocationRowWithoutRedistribute();
                        }

                        // Now restore allocation values
                        const rows = document.querySelectorAll('.allocation-row');
                        for (let i = 0; i < rows.length && i < formData.allocations.length; i++) {
                            const row = rows[i];
                            const alloc = formData.allocations[i];

                            if (alloc.brand) row.querySelector('.brand-select').value = alloc.brand;
                            if (alloc.department) {
                                row.querySelector('.department-select').value = alloc.department;
                                // Trigger subdepartment load
                                const company = formData.dedicatedCompany;
                                const dept = alloc.department;
                                if (company && dept) {
                                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                                    const subdeptSelect = row.querySelector('.subdepartment-select');
                                    subdeptSelect.innerHTML = '<option value="">N/A</option>';
                                    subdepts.forEach(s => {
                                        const opt = document.createElement('option');
                                        opt.value = s;
                                        opt.textContent = s;
                                        subdeptSelect.appendChild(opt);
                                    });
                                }
                            }
                            if (alloc.subdepartment) row.querySelector('.subdepartment-select').value = alloc.subdepartment;
                            if (alloc.allocation) row.querySelector('.allocation-input').value = alloc.allocation;
                            if (alloc.allocationValue) row.querySelector('.allocation-value-input').value = alloc.allocationValue;

                            // Restore locked state
                            if (alloc.locked) {
                                const lockBtn = row.querySelector('.lock-allocation');
                                const icon = lockBtn ? lockBtn.querySelector('i') : null;
                                if (icon) {
                                    icon.classList.remove('bi-unlock');
                                    icon.classList.add('bi-lock-fill');
                                    lockBtn.classList.remove('btn-outline-secondary');
                                    lockBtn.classList.add('btn-warning');
                                    lockBtn.title = 'Unlock this allocation';
                                }
                            }

                            // Restore reinvoice fields
                            if (alloc.reinvoiceCheck) {
                                row.querySelector('.reinvoice-check').checked = true;
                                row.querySelector('.reinvoice-fields').style.display = 'flex';
                                if (alloc.reinvoiceCompany) {
                                    row.querySelector('.reinvoice-company').value = alloc.reinvoiceCompany;
                                    // Load reinvoice brands and departments
                                    const [brands, depts] = await Promise.all([
                                        fetch(`/api/brands/${encodeURIComponent(alloc.reinvoiceCompany)}`).then(r => r.json()),
                                        fetch(`/api/departments/${encodeURIComponent(alloc.reinvoiceCompany)}`).then(r => r.json())
                                    ]);
                                    const reinvoiceBrandSelect = row.querySelector('.reinvoice-brand');
                                    const reinvoiceDeptSelect = row.querySelector('.reinvoice-department');
                                    reinvoiceBrandSelect.innerHTML = '<option value="">N/A</option>';
                                    reinvoiceDeptSelect.innerHTML = '<option value="">Select department...</option>';
                                    brands.forEach(b => {
                                        const opt = document.createElement('option');
                                        opt.value = b;
                                        opt.textContent = b;
                                        reinvoiceBrandSelect.appendChild(opt);
                                    });
                                    depts.forEach(d => {
                                        const opt = document.createElement('option');
                                        opt.value = d;
                                        opt.textContent = d;
                                        reinvoiceDeptSelect.appendChild(opt);
                                    });
                                    if (alloc.reinvoiceBrand) reinvoiceBrandSelect.value = alloc.reinvoiceBrand;
                                    if (alloc.reinvoiceDepartment) {
                                        reinvoiceDeptSelect.value = alloc.reinvoiceDepartment;
                                        // Load reinvoice subdepartments
                                        const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(alloc.reinvoiceCompany)}/${encodeURIComponent(alloc.reinvoiceDepartment)}`).then(r => r.json());
                                        const reinvoiceSubdeptSelect = row.querySelector('.reinvoice-subdepartment');
                                        reinvoiceSubdeptSelect.innerHTML = '<option value="">N/A</option>';
                                        subdepts.forEach(s => {
                                            const opt = document.createElement('option');
                                            opt.value = s;
                                            opt.textContent = s;
                                            reinvoiceSubdeptSelect.appendChild(opt);
                                        });
                                        if (alloc.reinvoiceSubdepartment) reinvoiceSubdeptSelect.value = alloc.reinvoiceSubdepartment;
                                    }
                                }
                            }
                        }
                    }
                }

                updateTotalAllocation();

                // Show restore notification
                const alertEl = document.getElementById('entryModeAlert');
                const alertText = document.getElementById('entryModeText');
                alertEl.style.display = 'block';
                alertEl.className = 'alert alert-warning small py-2 mb-3';
                alertText.textContent = 'Form restored from previous session. Clear if starting fresh.';

                return true; // Successfully restored

            } catch (e) {
                console.error('Error restoring form cache:', e);
                localStorage.removeItem(FORM_CACHE_KEY);
                return false;
            }
        }

        // Add allocation row without redistributing (for restore)
        async function addAllocationRowWithoutRedistribute() {
            const container = document.getElementById('allocationsContainer');
            const template = document.getElementById('allocationTemplate');
            const row = template.content.cloneNode(true);

            const brandSelect = row.querySelector('.brand-select');
            const deptSelect = row.querySelector('.department-select');
            const subdeptSelect = row.querySelector('.subdepartment-select');
            const allocationInput = row.querySelector('.allocation-input');
            const allocationValueInput = row.querySelector('.allocation-value-input');
            const currencyLabel = row.querySelector('.currency-label');
            const managerDisplay = row.querySelector('.manager-display');
            const removeBtn = row.querySelector('.remove-allocation');
            const reinvoiceCheck = row.querySelector('.reinvoice-check');
            const reinvoiceFields = row.querySelector('.reinvoice-fields');
            const reinvoiceCompany = row.querySelector('.reinvoice-company');
            const reinvoiceBrand = row.querySelector('.reinvoice-brand');
            const reinvoiceDepartment = row.querySelector('.reinvoice-department');
            const reinvoiceSubdepartment = row.querySelector('.reinvoice-subdepartment');

            // Populate reinvoice company dropdown with all companies
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                reinvoiceCompany.appendChild(opt);
            });

            // Toggle reinvoice fields visibility
            reinvoiceCheck.addEventListener('change', () => {
                if (reinvoiceCheck.checked) {
                    reinvoiceFields.style.display = 'flex';
                } else {
                    reinvoiceFields.style.display = 'none';
                    reinvoiceCompany.value = '';
                    reinvoiceBrand.innerHTML = '<option value="">N/A</option>';
                    reinvoiceDepartment.innerHTML = '<option value="">Select department...</option>';
                    reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';
                }
                saveFormToCache();
            });

            // Update reinvoice brand and department when company changes
            reinvoiceCompany.addEventListener('change', async () => {
                const company = reinvoiceCompany.value;
                reinvoiceBrand.innerHTML = '<option value="">N/A</option>';
                reinvoiceDepartment.innerHTML = '<option value="">Select department...</option>';
                reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';

                if (company) {
                    const [brands, depts] = await Promise.all([
                        fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                        fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                    ]);
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        reinvoiceBrand.appendChild(opt);
                    });
                    depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        reinvoiceDepartment.appendChild(opt);
                    });
                }
                saveFormToCache();
            });

            // Update reinvoice subdepartment when department changes
            reinvoiceDepartment.addEventListener('change', async () => {
                const company = reinvoiceCompany.value;
                const dept = reinvoiceDepartment.value;
                reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                    subdepts.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        reinvoiceSubdepartment.appendChild(opt);
                    });
                }
                saveFormToCache();
            });

            // Populate brands and departments based on dedicated company
            const company = document.getElementById('dedicatedCompany').value;
            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    brandSelect.appendChild(opt);
                });
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });
            }

            deptSelect.addEventListener('change', async () => {
                const company = document.getElementById('dedicatedCompany').value;
                const dept = deptSelect.value;
                const subdeptCol = subdeptSelect.closest('[class*="col-"]');
                subdeptSelect.innerHTML = '<option value="">N/A</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                    if (subdepts.length > 0) {
                        subdeptCol.style.display = '';
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subdeptSelect.appendChild(opt);
                        });
                    } else {
                        subdeptCol.style.display = 'none';
                    }
                } else {
                    subdeptCol.style.display = 'none';
                }
                updateManager();
                saveFormToCache();
            });

            subdeptSelect.addEventListener('change', () => {
                updateManager();
                saveFormToCache();
            });

            async function updateManager() {
                const company = document.getElementById('dedicatedCompany').value;
                const dept = deptSelect.value;
                const subdept = subdeptSelect.value;

                if (company && dept) {
                    const params = new URLSearchParams({ company, department: dept });
                    if (subdept) params.append('subdepartment', subdept);
                    const res = await fetch(`/api/manager?${params}`);
                    const data = await res.json();
                    managerDisplay.textContent = `Manager: ${data.manager || '--'}`;
                } else {
                    managerDisplay.textContent = 'Manager: --';
                }
            }

            // Sync percentage and value inputs with smart redistribution
            allocationInput.addEventListener('input', () => {
                const rowElement = allocationInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'percent');
                saveFormToCache();
            });

            allocationValueInput.addEventListener('input', () => {
                const rowElement = allocationValueInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'value');
                saveFormToCache();
            });

            // Add cache saving for brand select
            brandSelect.addEventListener('change', () => saveFormToCache());

            removeBtn.addEventListener('click', () => {
                removeBtn.closest('.allocation-row').remove();
                redistributeAllocations();
                saveFormToCache();
            });

            // Lock button toggle
            const lockBtn = row.querySelector('.lock-allocation');
            lockBtn.addEventListener('click', () => {
                const icon = lockBtn.querySelector('i');
                const isLocked = icon.classList.contains('bi-lock-fill');
                if (isLocked) {
                    icon.classList.remove('bi-lock-fill');
                    icon.classList.add('bi-unlock');
                    lockBtn.classList.remove('btn-warning');
                    lockBtn.classList.add('btn-outline-secondary');
                    lockBtn.title = 'Lock this allocation';
                } else {
                    icon.classList.remove('bi-unlock');
                    icon.classList.add('bi-lock-fill');
                    lockBtn.classList.remove('btn-outline-secondary');
                    lockBtn.classList.add('btn-warning');
                    lockBtn.title = 'Unlock this allocation';
                }
                saveFormToCache();
            });

            container.appendChild(row);
            // Don't redistribute - this is for restore
        }

        // Setup form caching event listeners
        function setupFormCaching() {
            // Cache on input changes for main form fields
            const fieldsToCache = ['supplier', 'customerVat', 'invoiceNumber', 'invoiceDate', 'invoiceValue', 'currency', 'dedicatedCompany'];
            fieldsToCache.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', saveFormToCache);
                    field.addEventListener('change', saveFormToCache);
                }
            });
        }

        // Clear form cache
        function clearFormCache() {
            localStorage.removeItem(FORM_CACHE_KEY);
        }

        async function loadStructure() {
            const [companiesRes, structureRes] = await Promise.all([
                fetch('/api/companies'),
                fetch('/api/structure')
            ]);
            companies = await companiesRes.json();
            structure = await structureRes.json();

            // Populate dedicated company dropdown
            const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                dedicatedCompanySelect.appendChild(opt);
            });
        }

        async function loadCompaniesWithVat() {
            const res = await fetch('/api/companies-vat');
            companiesWithVat = await res.json();
        }

        async function loadInvoiceTemplates() {
            try {
                const res = await fetch('/api/templates');
                invoiceTemplates = await res.json();
                renderTemplateSelect();
            } catch (e) {
                console.error('Error loading templates:', e);
            }
        }

        function renderTemplateSelect() {
            const select = document.getElementById('templateSelect');
            // Keep the first auto-detect option
            select.innerHTML = '<option value="">Auto-detect (AI fallback)</option>';

            invoiceTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = `Template: ${t.name}`;
                select.appendChild(opt);
            });

            // Update button text when selection changes
            select.addEventListener('change', updateParseButton);
        }

        function updateParseButton() {
            const select = document.getElementById('templateSelect');
            const btnText = document.getElementById('parseBtnText');
            const btnIcon = document.getElementById('parseBtnIcon');

            if (select.value) {
                const template = invoiceTemplates.find(t => t.id == select.value);
                btnText.textContent = `Citeste cu ${template ? template.name : 'Template'}`;
                btnIcon.className = 'bi bi-file-earmark-text';
            } else {
                btnText.textContent = 'Citeste Factura';
                btnIcon.className = 'bi bi-magic';
            }
        }

        function normalizeVat(vat) {
            if (!vat) return '';
            // Remove spaces, dashes, dots, colons
            vat = vat.toUpperCase().replace(/[\s\-\./:]+/g, '');
            // Remove common prefixes
            const prefixes = ['CUI:', 'CUI', 'CIF:', 'CIF', 'VAT:', 'VAT', 'TAXID:', 'TAXID'];
            for (const prefix of prefixes) {
                if (vat.startsWith(prefix)) {
                    vat = vat.substring(prefix.length);
                    break;
                }
            }
            return vat;
        }

        function extractVatNumbers(vat) {
            if (!vat) return '';
            return vat.replace(/[^0-9]/g, '');
        }

        function matchCompanyByVat(invoiceVat) {
            if (!invoiceVat) return null;
            const normalizedInvoiceVat = normalizeVat(invoiceVat);
            const invoiceNumbersOnly = extractVatNumbers(invoiceVat);

            // First pass: exact normalized match
            for (const c of companiesWithVat) {
                if (normalizeVat(c.vat) === normalizedInvoiceVat) {
                    return c;
                }
            }

            // Second pass: numeric-only match (handles 'RO225615' matching '225615')
            if (invoiceNumbersOnly) {
                for (const c of companiesWithVat) {
                    const companyNumbers = extractVatNumbers(c.vat);
                    if (companyNumbers && companyNumbers === invoiceNumbersOnly) {
                        return c;
                    }
                }
            }

            return null;
        }

        function setupEventListeners() {
            // File upload
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    uploadedFile = e.dataTransfer.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    uploadedFile = fileInput.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });

            // Parse button
            document.getElementById('parseBtn').addEventListener('click', parseInvoice);

            // Add allocation
            document.getElementById('addAllocationBtn').addEventListener('click', addAllocationRow);

            // Submit
            document.getElementById('submitBtn').addEventListener('click', submitDistribution);

            // Manual VAT Match button
            document.getElementById('matchVatBtn').addEventListener('click', manualVatMatch);

            // Manual Entry button
            document.getElementById('manualEntryBtn').addEventListener('click', enableManualEntry);

            // Dedicated Company change - reload allocation rows
            document.getElementById('dedicatedCompany').addEventListener('change', onDedicatedCompanyChange);

            // Invoice Value change - update allocation values
            document.getElementById('invoiceValue').addEventListener('input', updateAllocationValues);

            // Currency change - update labels
            document.getElementById('currency').addEventListener('change', updateTotalAllocation);
        }

        async function onDedicatedCompanyChange() {
            const company = document.getElementById('dedicatedCompany').value;

            // Reload department and brand dropdowns in all allocation rows
            const rows = document.querySelectorAll('.allocation-row');
            for (const row of rows) {
                await updateAllocationRowDropdowns(row);
            }
        }

        async function updateAllocationRowDropdowns(row) {
            const company = document.getElementById('dedicatedCompany').value;
            const brandSelect = row.querySelector('.brand-select');
            const deptSelect = row.querySelector('.department-select');
            const subdeptSelect = row.querySelector('.subdepartment-select');
            const managerDisplay = row.querySelector('.manager-display');
            const brandCol = brandSelect.closest('[class*="col-"]');
            const subdeptCol = subdeptSelect.closest('[class*="col-"]');

            brandSelect.innerHTML = '<option value="">N/A</option>';
            deptSelect.innerHTML = '<option value="">Select...</option>';
            subdeptSelect.innerHTML = '<option value="">N/A</option>';
            managerDisplay.textContent = 'Manager: --';

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);

                // Hide/show brand column based on whether brands exist
                if (brands.length > 0) {
                    brandCol.style.display = '';
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        brandSelect.appendChild(opt);
                    });
                } else {
                    brandCol.style.display = 'none';
                }

                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });

                // Initially hide subdepartment until a department is selected
                subdeptCol.style.display = 'none';
            } else {
                // No company selected - show all columns
                brandCol.style.display = '';
                subdeptCol.style.display = '';
            }
        }

        function manualVatMatch() {
            const vatInput = document.getElementById('customerVat').value.trim();
            if (!vatInput) {
                alert('Please enter a VAT number first');
                return;
            }

            const vatMatch = matchCompanyByVat(vatInput);
            if (vatMatch) {
                document.getElementById('matchedCompany').value = vatMatch.company + ' (matched by VAT)';

                // Auto-select company in dedicated company dropdown
                const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                let selectedCompany = null;

                // First try exact match
                for (let opt of dedicatedCompanySelect.options) {
                    if (opt.value === vatMatch.company) {
                        selectedCompany = vatMatch.company;
                        break;
                    }
                }

                // If no exact match, try partial match
                if (!selectedCompany) {
                    const matchedLower = vatMatch.company.toLowerCase();
                    for (let opt of dedicatedCompanySelect.options) {
                        if (!opt.value) continue;
                        const optLower = opt.value.toLowerCase();
                        if (optLower.includes(matchedLower) || matchedLower.includes(optLower)) {
                            selectedCompany = opt.value;
                            break;
                        }
                    }
                }

                if (selectedCompany) {
                    dedicatedCompanySelect.value = selectedCompany;
                    dedicatedCompanySelect.dispatchEvent(new Event('change'));
                }
            } else {
                document.getElementById('matchedCompany').value = '';
                alert('No matching company found for VAT: ' + vatInput);
            }
        }

        function enableManualEntry() {
            // Clear form but keep file if already uploaded
            document.getElementById('invoiceForm').reset();
            document.getElementById('matchedCompany').value = '';

            // Reset dedicated company
            document.getElementById('dedicatedCompany').value = '';
            document.getElementById('allocationsContainer').innerHTML = '';
            addAllocationRow();

            // Set today's date as default
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Show manual entry mode alert
            const alertEl = document.getElementById('entryModeAlert');
            const alertText = document.getElementById('entryModeText');
            alertEl.style.display = 'block';
            alertEl.className = 'alert alert-secondary small py-2 mb-3';
            alertText.textContent = 'Manual entry mode - fill in invoice details' + (uploadedFile ? ' (file attached for upload)' : '');

            // Focus on supplier field
            document.getElementById('supplier').focus();
        }

        function updateDropZoneText(filename) {
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <i class="bi bi-file-earmark-check fs-1 text-success"></i>
                <p class="mb-0 mt-2">${filename}</p>
                <small class="text-muted">Click to change</small>
                <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
            `;
            document.getElementById('fileInput').addEventListener('change', function() {
                if (this.files.length) {
                    uploadedFile = this.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
        }

        async function parseInvoice() {
            const btn = document.getElementById('parseBtn');
            const templateSelect = document.getElementById('templateSelect');
            const templateId = templateSelect.value;

            if (!uploadedFile) {
                alert('Please upload an invoice first');
                return;
            }

            btn.classList.add('parsing');
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', uploadedFile);

                // Add template_id if a template is selected
                if (templateId) {
                    formData.append('template_id', templateId);
                }

                const res = await fetch('/api/parse-invoice', { method: 'POST', body: formData });
                const result = await res.json();

                if (result.success) {
                    fillFormFromParsed(result.data, templateId ? true : false);
                } else {
                    alert('Error parsing invoice: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.classList.remove('parsing');
                btn.disabled = false;
            }
        }

        function fillFormFromParsed(data, isTemplate = false) {
            // Show parsed mode alert
            const alertEl = document.getElementById('entryModeAlert');
            const alertText = document.getElementById('entryModeText');
            alertEl.style.display = 'block';
            if (isTemplate) {
                alertEl.className = 'alert alert-info small py-2 mb-3';
                alertText.textContent = `Template applied: ${data.template_used || 'Custom'} - enter invoice number, date, and value`;
            } else {
                alertEl.className = 'alert alert-success small py-2 mb-3';
                alertText.textContent = 'Invoice parsed with AI - review and edit fields if needed';
            }

            // Store drive link if returned from parsing (uploaded during parse)
            if (data.drive_link) {
                document.getElementById('driveLink').value = data.drive_link;
            }

            if (data.supplier) document.getElementById('supplier').value = data.supplier;
            if (data.customer_vat) document.getElementById('customerVat').value = data.customer_vat;
            if (data.invoice_number) document.getElementById('invoiceNumber').value = data.invoice_number;
            if (data.invoice_date) document.getElementById('invoiceDate').value = data.invoice_date;
            if (data.invoice_value) document.getElementById('invoiceValue').value = data.invoice_value;
            if (data.currency) {
                const currencySelect = document.getElementById('currency');
                for (let opt of currencySelect.options) {
                    if (opt.value === data.currency) {
                        opt.selected = true;
                        break;
                    }
                }
            }

            // Display currency conversion if available
            if (data.value_ron && data.value_eur) {
                document.getElementById('valueRon').value = data.value_ron;
                document.getElementById('valueEur').value = data.value_eur;
                document.getElementById('exchangeRate').value = data.exchange_rate || '';

                document.getElementById('displayValueRon').textContent = formatCurrency(data.value_ron);
                document.getElementById('displayValueEur').textContent = formatCurrency(data.value_eur);
                document.getElementById('displayExchangeRate').textContent = data.exchange_rate ? data.exchange_rate.toFixed(4) : '-';
                document.getElementById('conversionDisplay').style.display = 'block';
            } else {
                document.getElementById('conversionDisplay').style.display = 'none';
            }

            // PRIORITY 1: Try to match company by VAT number
            let matchedCompany = null;
            if (data.customer_vat) {
                const vatMatch = matchCompanyByVat(data.customer_vat);
                if (vatMatch) {
                    matchedCompany = vatMatch.company;
                    document.getElementById('matchedCompany').value = matchedCompany + ' (matched by VAT)';
                }
            }

            // Auto-select company in dedicated company dropdown
            if (matchedCompany) {
                const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                let selectedCompany = null;

                // First try exact match with matched company name
                for (let opt of dedicatedCompanySelect.options) {
                    if (opt.value === matchedCompany) {
                        selectedCompany = matchedCompany;
                        break;
                    }
                }

                // If no exact match, try partial match with matched company
                if (!selectedCompany) {
                    const matchedLower = matchedCompany.toLowerCase();
                    for (let opt of dedicatedCompanySelect.options) {
                        if (!opt.value) continue;
                        const optLower = opt.value.toLowerCase();
                        if (optLower.includes(matchedLower) || matchedLower.includes(optLower)) {
                            selectedCompany = opt.value;
                            break;
                        }
                        // Check word-based match
                        const matchedWords = matchedLower.split(/\s+/);
                        const optWords = optLower.split(/\s+/);
                        for (let mw of matchedWords) {
                            if (mw.length > 3 && optWords.some(w => w.includes(mw) || mw.includes(w))) {
                                selectedCompany = opt.value;
                                break;
                            }
                        }
                        if (selectedCompany) break;
                    }
                }

                // Apply selection if found
                if (selectedCompany) {
                    dedicatedCompanySelect.value = selectedCompany;
                    dedicatedCompanySelect.dispatchEvent(new Event('change'));
                }
            }

            // Update allocation values after invoice value is filled
            updateAllocationValues();
        }

        async function addAllocationRow() {
            const container = document.getElementById('allocationsContainer');
            const template = document.getElementById('allocationTemplate');
            const row = template.content.cloneNode(true);

            const brandSelect = row.querySelector('.brand-select');
            const deptSelect = row.querySelector('.department-select');
            const subdeptSelect = row.querySelector('.subdepartment-select');
            const allocationInput = row.querySelector('.allocation-input');
            const allocationValueInput = row.querySelector('.allocation-value-input');
            const currencyLabel = row.querySelector('.currency-label');
            const managerDisplay = row.querySelector('.manager-display');
            const removeBtn = row.querySelector('.remove-allocation');
            const reinvoiceCheck = row.querySelector('.reinvoice-check');
            const reinvoiceFields = row.querySelector('.reinvoice-fields');
            const reinvoiceCompany = row.querySelector('.reinvoice-company');
            const reinvoiceBrand = row.querySelector('.reinvoice-brand');
            const reinvoiceDepartment = row.querySelector('.reinvoice-department');
            const reinvoiceSubdepartment = row.querySelector('.reinvoice-subdepartment');

            // Populate reinvoice company dropdown with all companies
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                reinvoiceCompany.appendChild(opt);
            });

            // Toggle reinvoice fields visibility
            reinvoiceCheck.addEventListener('change', () => {
                if (reinvoiceCheck.checked) {
                    reinvoiceFields.style.display = 'flex';
                } else {
                    reinvoiceFields.style.display = 'none';
                    reinvoiceCompany.value = '';
                    reinvoiceBrand.innerHTML = '<option value="">N/A</option>';
                    reinvoiceDepartment.innerHTML = '<option value="">Select department...</option>';
                    reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';
                }
                saveFormToCache();
            });

            // Update reinvoice brand and department when company changes
            reinvoiceCompany.addEventListener('change', async () => {
                const company = reinvoiceCompany.value;
                reinvoiceBrand.innerHTML = '<option value="">N/A</option>';
                reinvoiceDepartment.innerHTML = '<option value="">Select department...</option>';
                reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';

                if (company) {
                    const [brands, depts] = await Promise.all([
                        fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                        fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                    ]);
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        reinvoiceBrand.appendChild(opt);
                    });
                    depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        reinvoiceDepartment.appendChild(opt);
                    });
                }
                saveFormToCache();
            });

            // Update reinvoice subdepartment when department changes
            reinvoiceDepartment.addEventListener('change', async () => {
                const company = reinvoiceCompany.value;
                const dept = reinvoiceDepartment.value;
                reinvoiceSubdepartment.innerHTML = '<option value="">N/A</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                    subdepts.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        reinvoiceSubdepartment.appendChild(opt);
                    });
                }
                saveFormToCache();
            });

            // Populate brands and departments based on dedicated company
            const company = document.getElementById('dedicatedCompany').value;
            const brandCol = brandSelect.closest('[class*="col-"]');
            const subdeptCol = subdeptSelect.closest('[class*="col-"]');

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);

                // Hide/show brand column based on whether brands exist
                if (brands.length > 0) {
                    brandCol.style.display = '';
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        brandSelect.appendChild(opt);
                    });
                } else {
                    brandCol.style.display = 'none';
                }

                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });

                // Initially hide subdepartment until a department is selected
                subdeptCol.style.display = 'none';
            }

            deptSelect.addEventListener('change', async () => {
                const company = document.getElementById('dedicatedCompany').value;
                const dept = deptSelect.value;
                const subdeptCol = subdeptSelect.closest('[class*="col-"]');
                subdeptSelect.innerHTML = '<option value="">N/A</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                    if (subdepts.length > 0) {
                        subdeptCol.style.display = '';
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subdeptSelect.appendChild(opt);
                        });
                    } else {
                        subdeptCol.style.display = 'none';
                    }
                } else {
                    subdeptCol.style.display = 'none';
                }
                updateManager();
                saveFormToCache();
            });

            subdeptSelect.addEventListener('change', () => {
                updateManager();
                saveFormToCache();
            });

            async function updateManager() {
                const company = document.getElementById('dedicatedCompany').value;
                const dept = deptSelect.value;
                const subdept = subdeptSelect.value;

                if (company && dept) {
                    const params = new URLSearchParams({ company, department: dept });
                    if (subdept) params.append('subdepartment', subdept);
                    const res = await fetch(`/api/manager?${params}`);
                    const data = await res.json();
                    managerDisplay.textContent = `Manager: ${data.manager || '--'}`;
                } else {
                    managerDisplay.textContent = 'Manager: --';
                }
            }

            // Sync percentage and value inputs with smart redistribution
            allocationInput.addEventListener('input', () => {
                const rowElement = allocationInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'percent');
                saveFormToCache();
            });

            allocationValueInput.addEventListener('input', () => {
                const rowElement = allocationValueInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'value');
                saveFormToCache();
            });

            // Add cache saving for brand select
            brandSelect.addEventListener('change', () => saveFormToCache());

            removeBtn.addEventListener('click', () => {
                removeBtn.closest('.allocation-row').remove();
                redistributeAllocations(); // Redistribute after removing
                saveFormToCache();
            });

            // Lock button toggle
            const lockBtn = row.querySelector('.lock-allocation');
            lockBtn.addEventListener('click', () => {
                const icon = lockBtn.querySelector('i');
                const isLocked = icon.classList.contains('bi-lock-fill');
                if (isLocked) {
                    icon.classList.remove('bi-lock-fill');
                    icon.classList.add('bi-unlock');
                    lockBtn.classList.remove('btn-warning');
                    lockBtn.classList.add('btn-outline-secondary');
                    lockBtn.title = 'Lock this allocation';
                } else {
                    icon.classList.remove('bi-unlock');
                    icon.classList.add('bi-lock-fill');
                    lockBtn.classList.remove('btn-outline-secondary');
                    lockBtn.classList.add('btn-warning');
                    lockBtn.title = 'Unlock this allocation';
                }
                saveFormToCache();
            });

            container.appendChild(row);
            redistributeAllocations(); // Smart redistribute when adding
            saveFormToCache();
        }

        function updateTotalAllocation() {
            const percentInputs = document.querySelectorAll('.allocation-input');
            const valueInputs = document.querySelectorAll('.allocation-value-input');
            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;
            const currency = document.getElementById('currency').value || 'RON';

            let totalPercent = 0;
            let totalValue = 0;
            percentInputs.forEach(input => {
                totalPercent += parseFloat(input.value) || 0;
            });
            valueInputs.forEach(input => {
                totalValue += parseFloat(input.value) || 0;
            });

            const display = document.getElementById('totalAllocation');
            display.textContent = `${totalPercent.toFixed(2)}% | ${formatCurrency(totalValue)} ${currency}`;
            display.classList.remove('valid', 'invalid');
            display.classList.add(Math.abs(totalPercent - 100) < 0.01 ? 'valid' : 'invalid');

            // Update currency labels in allocation rows
            document.querySelectorAll('.currency-label').forEach(label => {
                label.textContent = currency;
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        function updateAllocationValues() {
            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;
            const rows = document.querySelectorAll('.allocation-row');
            rows.forEach(row => {
                const percentInput = row.querySelector('.allocation-input');
                const valueInput = row.querySelector('.allocation-value-input');
                const percent = parseFloat(percentInput.value) || 0;
                valueInput.value = ((invoiceValue * percent) / 100).toFixed(2);
            });
            updateTotalAllocation();
        }

        // Check if a row is locked
        function isRowLocked(row) {
            const lockBtn = row.querySelector('.lock-allocation');
            const icon = lockBtn ? lockBtn.querySelector('i') : null;
            return icon && icon.classList.contains('bi-lock-fill');
        }

        // Smart allocation splitting - redistributes percentages when adding/removing allocations
        function redistributeAllocations() {
            const rows = Array.from(document.querySelectorAll('.allocation-row'));
            const count = rows.length;
            if (count === 0) return;

            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;

            // Separate locked and unlocked rows
            const lockedRows = rows.filter(r => isRowLocked(r));
            const unlockedRows = rows.filter(r => !isRowLocked(r));

            // Calculate total locked percentage
            let lockedPercent = 0;
            lockedRows.forEach(row => {
                lockedPercent += parseFloat(row.querySelector('.allocation-input').value) || 0;
            });

            // Distribute remaining percentage among unlocked rows
            const remainingPercent = Math.max(0, 100 - lockedPercent);
            const unlockedCount = unlockedRows.length;

            if (unlockedCount > 0) {
                let percentages = getSmartSplit(unlockedCount);
                // Scale percentages to fit remaining percent
                const scaleFactor = remainingPercent / 100;
                percentages = percentages.map(p => p * scaleFactor);

                unlockedRows.forEach((row, idx) => {
                    const percentInput = row.querySelector('.allocation-input');
                    const valueInput = row.querySelector('.allocation-value-input');
                    percentInput.value = percentages[idx].toFixed(2);
                    valueInput.value = ((invoiceValue * percentages[idx]) / 100).toFixed(2);
                });
            }
            updateTotalAllocation();
        }

        // Get smart split percentages based on count
        // 1: 100%, 2: 50-50, 3: 40-30-30, 4: 40-20-20-20, etc.
        function getSmartSplit(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];

            // For 3+: first gets 40%, rest split equally
            const firstPercent = 40;
            const remaining = 100 - firstPercent;
            const otherPercent = remaining / (count - 1);

            const result = [firstPercent];
            for (let i = 1; i < count; i++) {
                result.push(otherPercent);
            }
            return result;
        }

        // When user changes an allocation, redistribute the difference to others
        function onAllocationChange(changedRow, changeType) {
            const rows = Array.from(document.querySelectorAll('.allocation-row'));
            const count = rows.length;
            if (count <= 1) {
                updateTotalAllocation();
                return;
            }

            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;
            const changedPercentInput = changedRow.querySelector('.allocation-input');
            const changedValueInput = changedRow.querySelector('.allocation-value-input');

            let changedPercent;
            if (changeType === 'percent') {
                changedPercent = parseFloat(changedPercentInput.value) || 0;
                changedValueInput.value = ((invoiceValue * changedPercent) / 100).toFixed(2);
            } else {
                const changedValue = parseFloat(changedValueInput.value) || 0;
                changedPercent = invoiceValue > 0 ? (changedValue / invoiceValue) * 100 : 0;
                changedPercentInput.value = changedPercent.toFixed(2);
            }

            // Calculate total from changed row and all locked rows (excluding changed row if it's locked)
            let lockedPercent = changedPercent;
            const lockedRows = rows.filter(r => r !== changedRow && isRowLocked(r));
            lockedRows.forEach(row => {
                lockedPercent += parseFloat(row.querySelector('.allocation-input').value) || 0;
            });

            // Get unlocked rows that aren't the changed row
            const unlockedOtherRows = rows.filter(r => r !== changedRow && !isRowLocked(r));

            // Calculate remaining percentage to distribute among unlocked rows
            const remaining = Math.max(0, 100 - lockedPercent);

            if (unlockedOtherRows.length > 0) {
                const perOther = remaining / unlockedOtherRows.length;
                unlockedOtherRows.forEach(row => {
                    const pInput = row.querySelector('.allocation-input');
                    const vInput = row.querySelector('.allocation-value-input');
                    pInput.value = perOther.toFixed(2);
                    vInput.value = ((invoiceValue * perOther) / 100).toFixed(2);
                });
            }

            updateTotalAllocation();
        }

        async function uploadToDrive(file, invoiceDate, company, invoiceNumber) {
            // Upload file to Google Drive
            const formData = new FormData();
            formData.append('file', file);
            formData.append('invoice_date', invoiceDate);
            formData.append('company', company);
            formData.append('invoice_number', invoiceNumber);

            const res = await fetch('/api/drive/upload', { method: 'POST', body: formData });
            return await res.json();
        }

        async function submitDistribution() {
            // Validate form
            const supplier = document.getElementById('supplier').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceValue = document.getElementById('invoiceValue').value;

            if (!supplier || !invoiceNumber || !invoiceDate || !invoiceValue) {
                alert('Please fill in all required fields');
                return;
            }

            // Check for duplicate invoice number
            try {
                const dupRes = await fetch(`/api/db/check-invoice-number?invoice_number=${encodeURIComponent(invoiceNumber)}`);
                const dupResult = await dupRes.json();
                if (dupResult.exists) {
                    const existing = dupResult.invoice;
                    alert(`Invoice number "${invoiceNumber}" already exists!\n\nExisting invoice:\n- Supplier: ${existing.supplier}\n- Date: ${existing.invoice_date}\n- Value: ${existing.invoice_value} ${existing.currency}`);
                    return;
                }
            } catch (e) {
                console.error('Error checking duplicate:', e);
            }

            // Get dedicated company
            const dedicatedCompany = document.getElementById('dedicatedCompany').value;

            if (!dedicatedCompany) {
                alert('Please select a company in "Dedicated To"');
                return;
            }

            // Collect allocations
            const rows = document.querySelectorAll('.allocation-row');
            const distributions = [];

            for (const row of rows) {
                const brandSelect = row.querySelector('.brand-select');
                const brand = brandSelect.value;
                const dept = row.querySelector('.department-select').value;
                const subdept = row.querySelector('.subdepartment-select').value;
                const allocation = parseFloat(row.querySelector('.allocation-input').value) / 100;
                const reinvoiceCheck = row.querySelector('.reinvoice-check').checked;
                const reinvoiceCompanyVal = row.querySelector('.reinvoice-company').value;
                const reinvoiceBrandVal = row.querySelector('.reinvoice-brand').value;
                const reinvoiceDepartmentVal = row.querySelector('.reinvoice-department').value;
                const reinvoiceSubdepartmentVal = row.querySelector('.reinvoice-subdepartment').value;

                // Check if brand is mandatory (brands exist for this company)
                const hasBrands = brandSelect.options.length > 1; // More than just "N/A"
                if (hasBrands && !brand) {
                    alert('Please select a Brand for all allocations (brands are available for this company)');
                    return;
                }

                if (!dept) {
                    alert('Please select Department for all allocations');
                    return;
                }

                // Check if subdepartment is mandatory (subdepartments exist for this department)
                const subdeptSelect = row.querySelector('.subdepartment-select');
                const hasSubdepts = subdeptSelect.options.length > 1; // More than just "N/A"
                if (hasSubdepts && !subdept) {
                    alert('Please select Subdepartment for all allocations (subdepartments are available for this department)');
                    return;
                }

                if (reinvoiceCheck && !reinvoiceCompanyVal) {
                    alert('Please select a company for reinvoicing or uncheck the reinvoice option');
                    return;
                }

                // Check reinvoice fields validation (Brand first, then Department, then Subdepartment)
                if (reinvoiceCheck && reinvoiceCompanyVal) {
                    // Check if reinvoice brand is mandatory (brands exist for selected reinvoice company)
                    const reinvoiceBrandSelect = row.querySelector('.reinvoice-brand');
                    const hasReinvoiceBrands = reinvoiceBrandSelect.options.length > 1; // More than just "N/A"
                    if (hasReinvoiceBrands && !reinvoiceBrandVal) {
                        alert('Please select a reinvoice brand (brands are available for the selected reinvoice company)');
                        return;
                    }

                    // Check if reinvoice department is mandatory (departments exist for selected reinvoice company)
                    const reinvoiceDeptSelect = row.querySelector('.reinvoice-department');
                    const hasReinvoiceDepts = reinvoiceDeptSelect.options.length > 1; // More than just "Select department..."
                    if (hasReinvoiceDepts && !reinvoiceDepartmentVal) {
                        alert('Please select a reinvoice department (departments are available for the selected reinvoice company)');
                        return;
                    }

                    // Check if reinvoice subdepartment is mandatory (subdepartments exist for selected reinvoice department)
                    if (reinvoiceDepartmentVal) {
                        const reinvoiceSubdeptSelect = row.querySelector('.reinvoice-subdepartment');
                        const hasReinvoiceSubdepts = reinvoiceSubdeptSelect.options.length > 1; // More than just "N/A"
                        if (hasReinvoiceSubdepts && !reinvoiceSubdepartmentVal) {
                            alert('Please select a reinvoice subdepartment (subdepartments are available for the selected reinvoice department)');
                            return;
                        }
                    }
                }

                distributions.push({
                    company: dedicatedCompany,
                    brand: brand || null,
                    department: dept,
                    subdepartment: subdept || null,
                    allocation,
                    reinvoice_to: reinvoiceCheck ? reinvoiceCompanyVal : null,
                    reinvoice_brand: reinvoiceCheck ? (reinvoiceBrandVal || null) : null,
                    reinvoice_department: reinvoiceCheck ? (reinvoiceDepartmentVal || null) : null,
                    reinvoice_subdepartment: reinvoiceCheck ? (reinvoiceSubdepartmentVal || null) : null
                });
            }

            // Validate total
            const total = distributions.reduce((sum, d) => sum + d.allocation, 0);
            if (Math.abs(total - 1) > 0.001) {
                alert('Allocations must sum to 100%');
                return;
            }

            // Submit
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
                let driveLink = document.getElementById('driveLink').value;

                // Get conversion values if available
                const valueRon = document.getElementById('valueRon').value;
                const valueEur = document.getElementById('valueEur').value;
                const exchangeRate = document.getElementById('exchangeRate').value;

                // First save to database (without drive link if not yet uploaded)
                const res = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplier,
                        invoice_number: invoiceNumber,
                        invoice_date: invoiceDate,
                        invoice_value: invoiceValue,
                        currency: document.getElementById('currency').value,
                        drive_link: driveLink,
                        distributions,
                        value_ron: valueRon ? parseFloat(valueRon) : null,
                        value_eur: valueEur ? parseFloat(valueEur) : null,
                        exchange_rate: exchangeRate ? parseFloat(exchangeRate) : null
                    })
                });

                const result = await res.json();
                if (result.success) {
                    // Only upload to Drive AFTER successful database save
                    // This prevents creating Drive folders for duplicate invoices
                    if (uploadedFile && !driveLink) {
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading to Drive...';
                        const uploadResult = await uploadToDrive(uploadedFile, invoiceDate, dedicatedCompany, invoiceNumber);
                        if (uploadResult.success) {
                            driveLink = uploadResult.drive_link;
                            document.getElementById('driveLink').value = driveLink;
                            // Update the invoice with the drive link
                            await fetch(`/api/invoices/${result.invoice_id}/drive-link`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ drive_link: driveLink })
                            });
                        } else if (!uploadResult.need_auth) {
                            console.warn('Drive upload failed:', uploadResult.error);
                        }
                    }

                    alert('Successfully saved ' + result.allocations + ' allocation(s)!' + (driveLink ? '\nUploaded to Drive!' : ''));
                    // Clear form cache after successful submission
                    clearFormCache();
                    // Reset form
                    document.getElementById('invoiceForm').reset();
                    document.getElementById('matchedCompany').value = '';
                    document.getElementById('allocationsContainer').innerHTML = '';
                    // Reset dedicated company
                    document.getElementById('dedicatedCompany').value = '';
                    // Hide entry mode alert and conversion display
                    document.getElementById('entryModeAlert').style.display = 'none';
                    document.getElementById('conversionDisplay').style.display = 'none';
                    document.getElementById('valueRon').value = '';
                    document.getElementById('valueEur').value = '';
                    document.getElementById('exchangeRate').value = '';
                    addAllocationRow();
                    // Reset file input area
                    uploadedFile = null;
                    const dropZone = document.getElementById('dropZone');
                    dropZone.innerHTML = `
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <p class="mb-0 mt-2">Drag & drop invoice here or click to upload</p>
                        <small class="text-muted">Supports PDF, JPG, PNG</small>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
                    `;
                    setupFileInput();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Save Distribution';
            }
        }

        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    uploadedFile = this.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
        }

        // Change Password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Password changed successfully');
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    document.getElementById('changePasswordForm').reset();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    </script>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel"><i class="bi bi-key"></i> Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="changePassword()">Change Password</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
