<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Users, Roles & Notifications</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background: #f5f5f5; }
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-hover tbody tr:hover { background: #e3f2fd; }
        .role-badge { font-size: 0.85em; }
        .permission-check { width: 20px; height: 20px; }
        .permission-granted { color: #198754; }
        .permission-denied { color: #dc3545; opacity: 0.4; }

        /* Searchable pills input styles */
        .pills-input-container {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.375rem;
            min-height: 42px;
            background: #fff;
            cursor: text;
            position: relative;
        }
        .pills-input-container:focus-within {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .pills-input-container .pills-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
        }
        .pills-input-container .pill {
            display: inline-flex;
            align-items: center;
            background: #e7f1ff;
            border: 1px solid #b6d4fe;
            border-radius: 1rem;
            padding: 0.125rem 0.5rem;
            font-size: 0.875rem;
            color: #0a58ca;
        }
        .pills-input-container .pill .remove-pill {
            margin-left: 0.375rem;
            cursor: pointer;
            color: #6c757d;
            font-size: 1rem;
            line-height: 1;
        }
        .pills-input-container .pill .remove-pill:hover {
            color: #dc3545;
        }
        .pills-input-container .search-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            padding: 0.125rem;
            font-size: 0.875rem;
        }
        .pills-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1050;
            background: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .pills-dropdown.show {
            display: block;
        }
        .pills-dropdown-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        .pills-dropdown-item:hover, .pills-dropdown-item.active {
            background: #e7f1ff;
        }
        .pills-dropdown-empty {
            padding: 0.5rem 0.75rem;
            color: #6c757d;
            font-style: italic;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-secondary mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-gear"></i> Settings
            </span>
            <div class="d-flex align-items-center">
                {% if current_user.can_access_accounting %}
                <a href="/accounting" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
                {% endif %}
                {% if current_user.can_access_connectors %}
                <a href="/connectors" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plug"></i> Connectors
                </a>
                {% endif %}
                {% if current_user.can_access_templates %}
                <a href="/templates" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-file-earmark-text"></i> Templates
                </a>
                {% endif %}
                {% if current_user.can_add_invoices %}
                <a href="/add-invoice" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plus-circle"></i> New Invoice
                </a>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ current_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text text-muted small">{{ current_user.email }}</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="bi bi-key"></i> Change Password</a></li>
                        <li><a class="dropdown-item" href="/guide"><i class="bi bi-book"></i> User Guide</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-people"></i> Total Users</h6>
                        <h2 id="totalUsers">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-person-check"></i> Active Users</h6>
                        <h2 id="activeUsers">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-shield"></i> Roles Defined</h6>
                        <h2 id="totalRoles">0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-person-badge"></i> Responsables</h6>
                        <h2 id="totalResponsables">0</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Users, Roles, Responsables, and Notifications -->
        <ul class="nav nav-tabs" id="settingsTabs">
            <li class="nav-item">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                    <i class="bi bi-people-fill"></i> Users
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button">
                    <i class="bi bi-shield-lock"></i> Roles
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="responsables-tab" data-bs-toggle="tab" data-bs-target="#responsables" type="button">
                    <i class="bi bi-person-badge"></i> Responsables
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button">
                    <i class="bi bi-envelope"></i> Notifications
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="company-config-tab" data-bs-toggle="tab" data-bs-target="#company-config" type="button">
                    <i class="bi bi-building"></i> Company Configuration
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vat-registry-tab" data-bs-toggle="tab" data-bs-target="#vat-registry" type="button">
                    <i class="bi bi-card-list"></i> VAT Registry
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="vat-rates-tab" data-bs-toggle="tab" data-bs-target="#vat-rates" type="button">
                    <i class="bi bi-percent"></i> VAT Rates
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="activity-logs-tab" data-bs-toggle="tab" data-bs-target="#activity-logs" type="button">
                    <i class="bi bi-clock-history"></i> Activity Logs
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Users Tab -->
            <div class="tab-pane fade show active" id="users">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Users</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                            <i class="bi bi-person-plus"></i> Add User
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noUsersMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-people display-4"></i>
                            <p class="mt-2">No users found. Click "Add User" to create one.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roles Tab -->
            <div class="tab-pane fade" id="roles">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Roles & Permissions</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddRoleModal()">
                            <i class="bi bi-shield-plus"></i> Add Role
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="rolesTable">
                                <thead>
                                    <tr>
                                        <th>Role Name</th>
                                        <th>Description</th>
                                        <th class="text-center" title="Add Invoices"><i class="bi bi-plus-circle"></i></th>
                                        <th class="text-center" title="Edit Invoices"><i class="bi bi-pencil"></i></th>
                                        <th class="text-center" title="View Invoices"><i class="bi bi-eye"></i></th>
                                        <th class="text-center" title="Delete Invoices"><i class="bi bi-trash"></i></th>
                                        <th class="text-center" title="Accounting"><i class="bi bi-calculator"></i></th>
                                        <th class="text-center" title="Connectors"><i class="bi bi-plug"></i></th>
                                        <th class="text-center" title="Templates"><i class="bi bi-file-earmark-text"></i></th>
                                        <th class="text-center" title="Settings"><i class="bi bi-gear"></i></th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="rolesTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noRolesMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-shield display-4"></i>
                            <p class="mt-2">No roles found. Click "Add Role" to create one.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Responsables Tab -->
            <div class="tab-pane fade" id="responsables">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Invoice Responsables</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddResponsableModal()">
                            <i class="bi bi-person-plus"></i> Add Responsable
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> Responsables receive email notifications when invoices are allocated to their departments.
                        </p>
                        <div class="table-responsive">
                            <table class="table table-hover" id="responsablesTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Departments</th>
                                        <th class="text-center">Notify</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="responsablesTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noResponsablesMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-person-badge display-4"></i>
                            <p class="mt-2">No responsables found. Click "Add Responsable" to create one.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notifications">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-envelope-gear"></i> Email Notification Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="notificationSettingsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">SMTP Server Configuration</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Host</label>
                                                <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Port</label>
                                                <input type="number" class="form-control" id="smtpPort" placeholder="587">
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="smtpTls" checked>
                                                <label class="form-check-label" for="smtpTls">Use TLS</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">Authentication</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Username</label>
                                                <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Password</label>
                                                <input type="password" class="form-control" id="smtpPassword" placeholder="App password or SMTP password">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">From Email</label>
                                                <input type="email" class="form-control" id="fromEmail" placeholder="noreply@yourcompany.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">From Name</label>
                                                <input type="text" class="form-control" id="fromName" placeholder="Invoice System">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">Notification Preferences</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="notifyOnAllocation" checked>
                                                <label class="form-check-label" for="notifyOnAllocation">
                                                    Send email when invoice is allocated to a department
                                                </label>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Global CC Address</label>
                                                <input type="email" class="form-control" id="globalCc" placeholder="cc@yourcompany.com">
                                                <small class="text-muted">All notification emails will be copied to this address</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                                    <i class="bi bi-check-lg"></i> Save Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="testEmailSettings()">
                                    <i class="bi bi-send"></i> Send Test Email
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Company Configuration Tab -->
            <div class="tab-pane fade" id="company-config">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Department Structure Configuration</h5>
                        <button class="btn btn-primary btn-sm" onclick="showAddDepartmentStructureModal()">
                            <i class="bi bi-plus-circle"></i> Add Department
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> Configure the company structure used for invoice allocation. Each entry represents a department allocation option.
                        </p>
                        <div class="table-responsive">
                            <table class="table table-hover" id="departmentStructuresTable">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Brand</th>
                                        <th>Department</th>
                                        <th>Subdepartment</th>
                                        <th>Manager</th>
                                        <th>Marketing</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentStructuresTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noDepartmentStructuresMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-building display-4"></i>
                            <p class="mt-2">No department structures found. Click "Add Department" to create one.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VAT Registry Tab -->
            <div class="tab-pane fade" id="vat-registry">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-card-list"></i> My Companies (VAT Registry)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> Register your company VAT numbers for automatic matching when parsing invoices. The Customer VAT from invoices will be matched against this registry.
                        </p>
                        <div class="table-responsive mb-3">
                            <table class="table table-hover" id="companiesVatTable">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Brands</th>
                                        <th>VAT Number</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="companiesVatTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noCompaniesVatMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-card-list display-4"></i>
                            <p class="mt-2">No companies registered. Add a company below.</p>
                        </div>
                        <hr>
                        <h6><i class="bi bi-plus-circle"></i> Add New Company</h6>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="newCompanyName" placeholder="Company Name">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="newCompanyBrands" placeholder="Brands (optional)">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="newCompanyVat" placeholder="VAT Number">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" id="addCompanyVatBtn">
                                    <i class="bi bi-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VAT Rates Tab -->
            <div class="tab-pane fade" id="vat-rates">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-percent"></i> VAT Rates Configuration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> Configure VAT rates for invoice processing. When adding invoices, you can optionally subtract VAT from the invoice value for allocation calculations.
                        </p>
                        <div class="table-responsive mb-3">
                            <table class="table table-hover" id="vatRatesTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Rate (%)</th>
                                        <th>Default</th>
                                        <th>Active</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="vatRatesTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noVatRatesMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-percent display-4"></i>
                            <p class="mt-2">No VAT rates configured. Add a VAT rate below.</p>
                        </div>
                        <hr>
                        <h6><i class="bi bi-plus-circle"></i> Add New VAT Rate</h6>
                        <div class="row g-2">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="newVatRateName" placeholder="Name (e.g., Standard VAT)">
                            </div>
                            <div class="col-md-2">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="newVatRateValue" placeholder="Rate" step="0.01" min="0" max="100">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="newVatRateDefault">
                                    <label class="form-check-label" for="newVatRateDefault">Default</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="newVatRateActive" checked>
                                    <label class="form-check-label" for="newVatRateActive">Active</label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" id="addVatRateBtn">
                                    <i class="bi bi-plus"></i> Add VAT Rate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade" id="activity-logs">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Activity Logs</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> View user activity logs including logins, logouts, and application actions.
                        </p>
                        <!-- Filters -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="logFilterUser">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="logFilterEventType">
                                    <option value="">All Event Types</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="logFilterStartDate" placeholder="Start Date">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="logFilterEndDate" placeholder="End Date">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-primary w-100" onclick="loadActivityLogs()">
                                    <i class="bi bi-search"></i> Filter
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearActivityLogFilters()">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                        </div>
                        <!-- Logs Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="activityLogsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;">Timestamp</th>
                                        <th style="width: 150px;">User</th>
                                        <th style="width: 120px;">Event Type</th>
                                        <th>Description</th>
                                        <th style="width: 120px;">IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="activityLogsTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noActivityLogsMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-clock-history display-4"></i>
                            <p class="mt-2">No activity logs found.</p>
                        </div>
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted small" id="activityLogsPaginationInfo">Showing 0 events</div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="activityLogsPagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit VAT Registry Modal -->
    <div class="modal fade" id="editVatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVatOriginalCompany">
                    <div class="mb-3">
                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatCompanyName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brands</label>
                        <input type="text" class="form-control" id="editVatBrands" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">VAT Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatNumber" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVatEdit()">
                        <i class="bi bi-check"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Department Structure Modal -->
    <div class="modal fade" id="departmentStructureModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departmentStructureModalTitle">Add Department Structure</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="departmentStructureForm">
                        <input type="hidden" id="departmentStructureId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company <span class="text-danger">*</span></label>
                                    <select class="form-select" id="dsCompany" required>
                                        <option value="">Select company...</option>
                                    </select>
                                    <small class="text-muted">Companies from VAT Registry</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="dsBrand" list="brandList">
                                    <datalist id="brandList"></datalist>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dsDepartment" required list="departmentList">
                                    <datalist id="departmentList"></datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subdepartment</label>
                                    <input type="text" class="form-control" id="dsSubdepartment">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Manager</label>
                                    <div class="pills-input-container" id="dsManagerContainer" onclick="focusPillsInput('dsManagerSearch')">
                                        <div class="pills-area">
                                            <span id="dsManagerPills"></span>
                                            <input type="text" class="search-input" id="dsManagerSearch"
                                                   placeholder="Type to search..."
                                                   autocomplete="off"
                                                   onfocus="showPillsDropdown('manager')"
                                                   oninput="filterPillsDropdown('manager')">
                                        </div>
                                        <div class="pills-dropdown" id="dsManagerDropdown"></div>
                                    </div>
                                    <small class="text-muted">Search and select responsables as managers.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Marketing</label>
                                    <div class="pills-input-container" id="dsMarketingContainer" onclick="focusPillsInput('dsMarketingSearch')">
                                        <div class="pills-area">
                                            <span id="dsMarketingPills"></span>
                                            <input type="text" class="search-input" id="dsMarketingSearch"
                                                   placeholder="Type to search..."
                                                   autocomplete="off"
                                                   onfocus="showPillsDropdown('marketing')"
                                                   oninput="filterPillsDropdown('marketing')">
                                        </div>
                                        <div class="pills-dropdown" id="dsMarketingDropdown"></div>
                                    </div>
                                    <small class="text-muted">Search and select responsables for marketing.</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDepartmentStructure()">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone">
                        </div>
                        <div class="mb-3" id="passwordField">
                            <label class="form-label">Password <span class="text-danger" id="passwordRequired">*</span></label>
                            <input type="password" class="form-control" id="userPassword">
                            <small class="text-muted" id="passwordHelp">Required for new users</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="userRole" required>
                                <option value="">Select a role...</option>
                            </select>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="userActive" checked>
                            <label class="form-check-label" for="userActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="bi bi-check-lg"></i> Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Role Modal -->
    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roleModalTitle">Add Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="roleForm">
                        <input type="hidden" id="roleId">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Role Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="roleName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" id="roleDescription">
                            </div>
                        </div>
                        <hr>
                        <h6 class="mb-3"><i class="bi bi-shield-lock"></i> Permissions</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <small class="text-muted">Invoice Permissions</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermAddInvoices">
                                            <label class="form-check-label" for="rolePermAddInvoices">
                                                <i class="bi bi-plus-circle text-success"></i> Add Invoices
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermEditInvoices">
                                            <label class="form-check-label" for="rolePermEditInvoices">
                                                <i class="bi bi-pencil text-warning"></i> Edit Invoices
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermViewInvoices">
                                            <label class="form-check-label" for="rolePermViewInvoices">
                                                <i class="bi bi-eye text-primary"></i> View Invoices
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="rolePermDeleteInvoices">
                                            <label class="form-check-label" for="rolePermDeleteInvoices">
                                                <i class="bi bi-trash text-danger"></i> Delete Invoices
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <small class="text-muted">Access Permissions</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermAccounting">
                                            <label class="form-check-label" for="rolePermAccounting">
                                                <i class="bi bi-calculator text-success"></i> Accounting Dashboard
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermConnectors">
                                            <label class="form-check-label" for="rolePermConnectors">
                                                <i class="bi bi-plug text-info"></i> Connectors
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="rolePermTemplates">
                                            <label class="form-check-label" for="rolePermTemplates">
                                                <i class="bi bi-file-earmark-text text-warning"></i> Templates
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="rolePermSettings">
                                            <label class="form-check-label" for="rolePermSettings">
                                                <i class="bi bi-gear text-secondary"></i> Settings (Admin)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRole()">
                        <i class="bi bi-check-lg"></i> Save Role
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Responsable Modal -->
    <div class="modal fade" id="responsableModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="responsableModalTitle">Add Responsable</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="responsableForm">
                        <input type="hidden" id="responsableId">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="responsableName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="responsableEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="responsablePhone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Departments</label>
                            <input type="text" class="form-control" id="responsableDepartments" placeholder="e.g., Marketing, Sales, IT (comma-separated)">
                            <small class="text-muted">List the departments this person is responsible for, separated by commas</small>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="responsableNotify" checked>
                            <label class="form-check-label" for="responsableNotify">Receive notifications on allocation</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="responsableActive" checked>
                            <label class="form-check-label" for="responsableActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveResponsable()">
                        <i class="bi bi-check-lg"></i> Save Responsable
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit VAT Rate Modal -->
    <div class="modal fade" id="editVatRateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit VAT Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVatRateId">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatRateName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate (%) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editVatRateValue" step="0.01" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="editVatRateDefault">
                        <label class="form-check-label" for="editVatRateDefault">Default VAT rate</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editVatRateActive">
                        <label class="form-check-label" for="editVatRateActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedVatRate()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let users = [];
        let roles = [];
        let responsables = [];
        let notificationSettings = {};
        let deleteType = null;
        let deleteId = null;
        let companiesWithVat = [];
        let vatRates = [];

        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        const roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
        const responsableModal = new bootstrap.Modal(document.getElementById('responsableModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const editVatRateModal = new bootstrap.Modal(document.getElementById('editVatRateModal'));

        document.addEventListener('DOMContentLoaded', () => {
            loadRoles();
            loadUsers();
            loadResponsables();
            loadNotificationSettings();
            loadCompaniesWithVat();  // Load VAT registry first (needed for department structure modal)
            loadDepartmentStructures();
            loadVatRates();

            // Event listener for Add Company VAT button
            document.getElementById('addCompanyVatBtn').addEventListener('click', addNewCompanyVat);
            // Event listener for Add VAT Rate button
            document.getElementById('addVatRateBtn').addEventListener('click', addNewVatRate);
        });

        // ========== DATA LOADING ==========

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                users = await res.json();
                renderUsers();
                updateSummary();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadRoles() {
            try {
                const res = await fetch('/api/roles');
                roles = await res.json();
                renderRoles();
                populateRoleDropdown();
                updateSummary();
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        function updateSummary() {
            const total = users.length;
            const active = users.filter(u => u.is_active).length;

            document.getElementById('totalUsers').textContent = total;
            document.getElementById('activeUsers').textContent = active;
            document.getElementById('totalRoles').textContent = roles.length;
            document.getElementById('totalResponsables').textContent = responsables.length;
        }

        // ========== USERS ==========

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMsg = document.getElementById('noUsersMessage');

            if (users.length === 0) {
                tbody.innerHTML = '';
                noUsersMsg.style.display = 'block';
                return;
            }

            noUsersMsg.style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><strong>${escapeHtml(user.name)}</strong></td>
                    <td><a href="mailto:${escapeHtml(user.email)}">${escapeHtml(user.email)}</a></td>
                    <td>${user.phone ? escapeHtml(user.phone) : '<span class="text-muted">-</span>'}</td>
                    <td>
                        ${user.role_name
                            ? `<span class="badge bg-primary role-badge">${escapeHtml(user.role_name)}</span>`
                            : '<span class="badge bg-secondary role-badge">No Role</span>'}
                    </td>
                    <td>
                        ${user.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('user', ${user.id}, '${escapeHtml(user.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateRoleDropdown() {
            const select = document.getElementById('userRole');
            select.innerHTML = '<option value="">Select a role...</option>' +
                roles.map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = '';
            document.getElementById('userActive').checked = true;
            // Show password as required for new users
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHelp').textContent = 'Required for new users';
            userModal.show();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role_id || '';
            document.getElementById('userActive').checked = user.is_active;
            // Password is optional when editing
            document.getElementById('passwordRequired').style.display = 'none';
            document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
            userModal.show();
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const roleId = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value.trim();
            const userData = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim() || null,
                role_id: roleId ? parseInt(roleId) : null,
                is_active: document.getElementById('userActive').checked
            };

            if (!userData.name || !userData.email) {
                alert('Name and email are required');
                return;
            }

            // Password required for new users
            if (!userId && !password) {
                alert('Password is required for new users');
                return;
            }

            // Include password if provided
            if (password) {
                userData.password = password;
            }

            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await res.json();

                if (result.success || result.id) {
                    userModal.hide();
                    loadUsers();
                } else {
                    alert(result.error || 'Failed to save user');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Failed to save user');
            }
        }

        // ========== ROLES ==========

        function renderRoles() {
            const tbody = document.getElementById('rolesTableBody');
            const noRolesMsg = document.getElementById('noRolesMessage');

            if (roles.length === 0) {
                tbody.innerHTML = '';
                noRolesMsg.style.display = 'block';
                return;
            }

            noRolesMsg.style.display = 'none';
            tbody.innerHTML = roles.map(role => `
                <tr>
                    <td><strong>${escapeHtml(role.name)}</strong></td>
                    <td>${role.description ? escapeHtml(role.description) : '<span class="text-muted">-</span>'}</td>
                    <td class="text-center">${permIcon(role.can_add_invoices)}</td>
                    <td class="text-center">${permIcon(role.can_edit_invoices)}</td>
                    <td class="text-center">${permIcon(role.can_view_invoices)}</td>
                    <td class="text-center">${permIcon(role.can_delete_invoices)}</td>
                    <td class="text-center">${permIcon(role.can_access_accounting)}</td>
                    <td class="text-center">${permIcon(role.can_access_connectors)}</td>
                    <td class="text-center">${permIcon(role.can_access_templates)}</td>
                    <td class="text-center">${permIcon(role.can_access_settings)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editRole(${role.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('role', ${role.id}, '${escapeHtml(role.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function permIcon(granted) {
            return granted
                ? '<i class="bi bi-check-circle-fill permission-granted"></i>'
                : '<i class="bi bi-x-circle permission-denied"></i>';
        }

        function showAddRoleModal() {
            document.getElementById('roleModalTitle').textContent = 'Add Role';
            document.getElementById('roleId').value = '';
            document.getElementById('roleName').value = '';
            document.getElementById('roleDescription').value = '';
            document.getElementById('rolePermAddInvoices').checked = false;
            document.getElementById('rolePermEditInvoices').checked = false;
            document.getElementById('rolePermViewInvoices').checked = false;
            document.getElementById('rolePermDeleteInvoices').checked = false;
            document.getElementById('rolePermAccounting').checked = false;
            document.getElementById('rolePermConnectors').checked = false;
            document.getElementById('rolePermTemplates').checked = false;
            document.getElementById('rolePermSettings').checked = false;
            roleModal.show();
        }

        function editRole(roleId) {
            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            document.getElementById('roleModalTitle').textContent = 'Edit Role';
            document.getElementById('roleId').value = role.id;
            document.getElementById('roleName').value = role.name;
            document.getElementById('roleDescription').value = role.description || '';
            document.getElementById('rolePermAddInvoices').checked = role.can_add_invoices;
            document.getElementById('rolePermEditInvoices').checked = role.can_edit_invoices;
            document.getElementById('rolePermViewInvoices').checked = role.can_view_invoices;
            document.getElementById('rolePermDeleteInvoices').checked = role.can_delete_invoices;
            document.getElementById('rolePermAccounting').checked = role.can_access_accounting;
            document.getElementById('rolePermConnectors').checked = role.can_access_connectors;
            document.getElementById('rolePermTemplates').checked = role.can_access_templates;
            document.getElementById('rolePermSettings').checked = role.can_access_settings;
            roleModal.show();
        }

        async function saveRole() {
            const roleId = document.getElementById('roleId').value;
            const roleData = {
                name: document.getElementById('roleName').value.trim(),
                description: document.getElementById('roleDescription').value.trim() || null,
                can_add_invoices: document.getElementById('rolePermAddInvoices').checked,
                can_edit_invoices: document.getElementById('rolePermEditInvoices').checked,
                can_view_invoices: document.getElementById('rolePermViewInvoices').checked,
                can_delete_invoices: document.getElementById('rolePermDeleteInvoices').checked,
                can_access_accounting: document.getElementById('rolePermAccounting').checked,
                can_access_connectors: document.getElementById('rolePermConnectors').checked,
                can_access_templates: document.getElementById('rolePermTemplates').checked,
                can_access_settings: document.getElementById('rolePermSettings').checked
            };

            if (!roleData.name) {
                alert('Role name is required');
                return;
            }

            try {
                const url = roleId ? `/api/roles/${roleId}` : '/api/roles';
                const method = roleId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roleData)
                });

                const result = await res.json();

                if (result.success || result.id) {
                    roleModal.hide();
                    loadRoles();
                } else {
                    alert(result.error || 'Failed to save role');
                }
            } catch (error) {
                console.error('Error saving role:', error);
                alert('Failed to save role');
            }
        }

        // ========== DELETE ==========

        function showDeleteModal(type, id, name) {
            deleteType = type;
            deleteId = id;
            document.getElementById('deleteItemName').textContent = name;
            deleteModal.show();
        }

        async function confirmDelete() {
            if (!deleteType || !deleteId) return;

            try {
                let url;
                if (deleteType === 'user') url = `/api/users/${deleteId}`;
                else if (deleteType === 'role') url = `/api/roles/${deleteId}`;
                else if (deleteType === 'responsable') url = `/api/responsables/${deleteId}`;
                else if (deleteType === 'vat_rate') url = `/api/vat-rates/${deleteId}`;
                const res = await fetch(url, { method: 'DELETE' });
                const result = await res.json();

                if (result.success) {
                    deleteModal.hide();
                    if (deleteType === 'user') loadUsers();
                    else if (deleteType === 'role') loadRoles();
                    else if (deleteType === 'responsable') loadResponsables();
                    else if (deleteType === 'vat_rate') loadVatRates();
                } else {
                    alert(result.error || 'Failed to delete');
                }
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete');
            } finally {
                deleteType = null;
                deleteId = null;
            }
        }

        // ========== RESPONSABLES ==========

        async function loadResponsables() {
            try {
                const res = await fetch('/api/responsables');
                responsables = await res.json();
                renderResponsables();
                updateSummary();
            } catch (error) {
                console.error('Error loading responsables:', error);
            }
        }

        function renderResponsables() {
            const tbody = document.getElementById('responsablesTableBody');
            const noResponsablesMsg = document.getElementById('noResponsablesMessage');

            if (responsables.length === 0) {
                tbody.innerHTML = '';
                noResponsablesMsg.style.display = 'block';
                return;
            }

            noResponsablesMsg.style.display = 'none';
            tbody.innerHTML = responsables.map(r => `
                <tr>
                    <td><strong>${escapeHtml(r.name)}</strong></td>
                    <td><a href="mailto:${escapeHtml(r.email)}">${escapeHtml(r.email)}</a></td>
                    <td>${r.phone ? escapeHtml(r.phone) : '<span class="text-muted">-</span>'}</td>
                    <td>${r.departments ? escapeHtml(r.departments) : '<span class="text-muted">All</span>'}</td>
                    <td class="text-center">
                        ${r.notify_on_allocation
                            ? '<i class="bi bi-bell-fill text-success"></i>'
                            : '<i class="bi bi-bell-slash text-muted"></i>'}
                    </td>
                    <td>
                        ${r.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editResponsable(${r.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('responsable', ${r.id}, '${escapeHtml(r.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showAddResponsableModal() {
            document.getElementById('responsableModalTitle').textContent = 'Add Responsable';
            document.getElementById('responsableId').value = '';
            document.getElementById('responsableName').value = '';
            document.getElementById('responsableEmail').value = '';
            document.getElementById('responsablePhone').value = '';
            document.getElementById('responsableDepartments').value = '';
            document.getElementById('responsableNotify').checked = true;
            document.getElementById('responsableActive').checked = true;
            responsableModal.show();
        }

        function editResponsable(responsableId) {
            const r = responsables.find(resp => resp.id === responsableId);
            if (!r) return;

            document.getElementById('responsableModalTitle').textContent = 'Edit Responsable';
            document.getElementById('responsableId').value = r.id;
            document.getElementById('responsableName').value = r.name;
            document.getElementById('responsableEmail').value = r.email;
            document.getElementById('responsablePhone').value = r.phone || '';
            document.getElementById('responsableDepartments').value = r.departments || '';
            document.getElementById('responsableNotify').checked = r.notify_on_allocation;
            document.getElementById('responsableActive').checked = r.is_active;
            responsableModal.show();
        }

        async function saveResponsable() {
            const responsableId = document.getElementById('responsableId').value;
            const responsableData = {
                name: document.getElementById('responsableName').value.trim(),
                email: document.getElementById('responsableEmail').value.trim(),
                phone: document.getElementById('responsablePhone').value.trim() || null,
                departments: document.getElementById('responsableDepartments').value.trim() || null,
                notify_on_allocation: document.getElementById('responsableNotify').checked,
                is_active: document.getElementById('responsableActive').checked
            };

            if (!responsableData.name || !responsableData.email) {
                alert('Name and email are required');
                return;
            }

            try {
                const url = responsableId ? `/api/responsables/${responsableId}` : '/api/responsables';
                const method = responsableId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(responsableData)
                });

                const result = await res.json();

                if (result.success || result.id) {
                    responsableModal.hide();
                    loadResponsables();
                } else {
                    alert(result.error || 'Failed to save responsable');
                }
            } catch (error) {
                console.error('Error saving responsable:', error);
                alert('Failed to save responsable');
            }
        }

        // ========== NOTIFICATION SETTINGS ==========

        async function loadNotificationSettings() {
            try {
                const res = await fetch('/api/notification-settings');
                const settings = await res.json();
                // API returns a dictionary directly, no need to transform
                notificationSettings = settings;
                populateNotificationSettings();
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }

        function populateNotificationSettings() {
            document.getElementById('smtpHost').value = notificationSettings.smtp_host || '';
            document.getElementById('smtpPort').value = notificationSettings.smtp_port || '';
            document.getElementById('smtpTls').checked = notificationSettings.smtp_tls !== 'false';
            document.getElementById('smtpUsername').value = notificationSettings.smtp_username || '';
            document.getElementById('smtpPassword').value = notificationSettings.smtp_password || '';
            document.getElementById('fromEmail').value = notificationSettings.from_email || '';
            document.getElementById('fromName').value = notificationSettings.from_name || '';
            document.getElementById('notifyOnAllocation').checked = notificationSettings.notify_on_allocation !== 'false';
            document.getElementById('globalCc').value = notificationSettings.global_cc || '';
        }

        async function saveNotificationSettings() {
            const settingsData = {
                smtp_host: document.getElementById('smtpHost').value.trim(),
                smtp_port: document.getElementById('smtpPort').value.trim(),
                smtp_tls: document.getElementById('smtpTls').checked ? 'true' : 'false',
                smtp_username: document.getElementById('smtpUsername').value.trim(),
                smtp_password: document.getElementById('smtpPassword').value.trim(),
                from_email: document.getElementById('fromEmail').value.trim(),
                from_name: document.getElementById('fromName').value.trim(),
                notify_on_allocation: document.getElementById('notifyOnAllocation').checked ? 'true' : 'false',
                global_cc: document.getElementById('globalCc').value.trim()
            };

            try {
                const res = await fetch('/api/notification-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await res.json();

                if (result.success) {
                    alert('Notification settings saved successfully!');
                    loadNotificationSettings();
                } else {
                    alert(result.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving notification settings:', error);
                alert('Failed to save settings');
            }
        }

        async function testEmailSettings() {
            const fromEmail = document.getElementById('fromEmail').value;
            if (!fromEmail) {
                showToast('Please enter a "From Email" address first', 'warning');
                return;
            }

            // Ask for test recipient email
            const testEmail = prompt('Enter email address to send test email to:', fromEmail);
            if (!testEmail) {
                return;
            }

            try {
                const btn = document.querySelector('button[onclick="testEmailSettings()"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';

                const response = await fetch('/api/notification-settings/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: testEmail })
                });

                const result = await response.json();

                btn.disabled = false;
                btn.innerHTML = originalText;

                if (result.success) {
                    showToast(`Test email sent to ${testEmail}`, 'success');
                } else {
                    showToast(`Failed to send test email: ${result.error}`, 'danger');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        }

        // ========== DEPARTMENT STRUCTURE ==========

        let departmentStructuresData = [];
        let responsablesForDS = [];

        async function loadDepartmentStructures() {
            try {
                const [dsRes, respRes] = await Promise.all([
                    fetch('/api/department-structures'),
                    fetch('/api/responsables')
                ]);
                departmentStructuresData = await dsRes.json();
                responsablesForDS = await respRes.json();
                renderDepartmentStructuresTable();
            } catch (error) {
                console.error('Error loading department structures:', error);
            }
        }

        function renderDepartmentStructuresTable() {
            const tbody = document.getElementById('departmentStructuresTableBody');
            const noMsg = document.getElementById('noDepartmentStructuresMessage');

            if (departmentStructuresData.length === 0) {
                tbody.innerHTML = '';
                noMsg.style.display = 'block';
                return;
            }

            noMsg.style.display = 'none';
            tbody.innerHTML = departmentStructuresData.map(ds => {
                // Get manager names from manager_ids
                const managerNames = (ds.manager_ids || [])
                    .map(id => responsablesForDS.find(r => r.id === id))
                    .filter(r => r)
                    .map(r => r.name)
                    .join(', ') || '-';

                // Get marketing names from marketing_ids
                const marketingNames = (ds.marketing_ids || [])
                    .map(id => responsablesForDS.find(r => r.id === id))
                    .filter(r => r)
                    .map(r => r.name)
                    .join(', ') || '-';

                return `
                    <tr>
                        <td>${escapeHtml(ds.company)}</td>
                        <td>${escapeHtml(ds.brand || '-')}</td>
                        <td>${escapeHtml(ds.department)}</td>
                        <td>${escapeHtml(ds.subdepartment || '-')}</td>
                        <td>${escapeHtml(managerNames)}</td>
                        <td>${escapeHtml(marketingNames)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDepartmentStructure(${ds.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartmentStructure(${ds.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Store selected IDs for manager and marketing
        let selectedManagerIds = [];
        let selectedMarketingIds = [];

        function showAddDepartmentStructureModal() {
            document.getElementById('departmentStructureModalTitle').textContent = 'Add Department Structure';
            document.getElementById('departmentStructureForm').reset();
            document.getElementById('departmentStructureId').value = '';
            selectedManagerIds = [];
            selectedMarketingIds = [];
            renderPills('manager');
            renderPills('marketing');
            populateDSDataLists();
            new bootstrap.Modal(document.getElementById('departmentStructureModal')).show();
        }

        function editDepartmentStructure(id) {
            const ds = departmentStructuresData.find(d => d.id === id);
            if (!ds) return;

            document.getElementById('departmentStructureModalTitle').textContent = 'Edit Department Structure';
            document.getElementById('departmentStructureId').value = ds.id;
            document.getElementById('dsCompany').value = ds.company || '';
            document.getElementById('dsBrand').value = ds.brand || '';
            document.getElementById('dsDepartment').value = ds.department || '';
            document.getElementById('dsSubdepartment').value = ds.subdepartment || '';
            selectedManagerIds = ds.manager_ids || [];
            selectedMarketingIds = ds.marketing_ids || [];
            renderPills('manager');
            renderPills('marketing');
            populateDSDataLists();
            new bootstrap.Modal(document.getElementById('departmentStructureModal')).show();
        }

        function focusPillsInput(inputId) {
            document.getElementById(inputId).focus();
        }

        function getSelectedIds(fieldName) {
            return fieldName === 'manager' ? selectedManagerIds : selectedMarketingIds;
        }

        function setSelectedIds(fieldName, ids) {
            if (fieldName === 'manager') {
                selectedManagerIds = ids;
            } else {
                selectedMarketingIds = ids;
            }
        }

        function renderPills(fieldName) {
            const pillsContainer = document.getElementById(`ds${capitalize(fieldName)}Pills`);
            const selectedIds = getSelectedIds(fieldName);
            const activeResponsables = responsablesForDS.filter(r => r.is_active);

            pillsContainer.innerHTML = selectedIds.map(id => {
                const responsable = activeResponsables.find(r => r.id === id);
                if (!responsable) return '';
                return `
                    <span class="pill" data-id="${id}">
                        ${escapeHtml(responsable.name)}
                        <span class="remove-pill" onclick="removePill('${fieldName}', ${id})">&times;</span>
                    </span>
                `;
            }).join('');
        }

        function removePill(fieldName, id) {
            const selectedIds = getSelectedIds(fieldName);
            const index = selectedIds.indexOf(id);
            if (index > -1) {
                selectedIds.splice(index, 1);
                setSelectedIds(fieldName, selectedIds);
                renderPills(fieldName);
            }
        }

        function showPillsDropdown(fieldName) {
            filterPillsDropdown(fieldName);
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            dropdown.classList.add('show');
        }

        function hidePillsDropdown(fieldName) {
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            dropdown.classList.remove('show');
        }

        function filterPillsDropdown(fieldName) {
            const searchInput = document.getElementById(`ds${capitalize(fieldName)}Search`);
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedIds = getSelectedIds(fieldName);
            const activeResponsables = responsablesForDS.filter(r => r.is_active);

            // Filter out already selected and match search term
            const filtered = activeResponsables.filter(r =>
                !selectedIds.includes(r.id) &&
                r.name.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="pills-dropdown-empty">No responsables found</div>';
            } else {
                dropdown.innerHTML = filtered.map(r => `
                    <div class="pills-dropdown-item" onclick="selectResponsable('${fieldName}', ${r.id})">
                        ${escapeHtml(r.name)}
                    </div>
                `).join('');
            }

            dropdown.classList.add('show');
        }

        function selectResponsable(fieldName, id) {
            const selectedIds = getSelectedIds(fieldName);
            if (!selectedIds.includes(id)) {
                selectedIds.push(id);
                setSelectedIds(fieldName, selectedIds);
                renderPills(fieldName);
            }
            // Clear search and hide dropdown
            const searchInput = document.getElementById(`ds${capitalize(fieldName)}Search`);
            searchInput.value = '';
            hidePillsDropdown(fieldName);
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const managerContainer = document.getElementById('dsManagerContainer');
            const marketingContainer = document.getElementById('dsMarketingContainer');

            if (managerContainer && !managerContainer.contains(e.target)) {
                hidePillsDropdown('manager');
            }
            if (marketingContainer && !marketingContainer.contains(e.target)) {
                hidePillsDropdown('marketing');
            }
        });

        function populateDSDataLists() {
            // Populate company select from VAT Registry
            const companySelect = document.getElementById('dsCompany');
            const currentValue = companySelect.value;
            companySelect.innerHTML = '<option value="">Select company...</option>' +
                companiesWithVat.map(c => `<option value="${escapeHtml(c.company)}">${escapeHtml(c.company)}</option>`).join('');
            // Restore previous selection if exists
            if (currentValue) {
                companySelect.value = currentValue;
            }

            // Populate brand list from existing department structures
            const brands = [...new Set(departmentStructuresData.map(d => d.brand).filter(b => b))];
            const brandList = document.getElementById('brandList');
            brandList.innerHTML = brands.map(b => `<option value="${escapeHtml(b)}">`).join('');

            // Populate department list from existing department structures
            const departments = [...new Set(departmentStructuresData.map(d => d.department).filter(d => d))];
            const departmentList = document.getElementById('departmentList');
            departmentList.innerHTML = departments.map(d => `<option value="${escapeHtml(d)}">`).join('');
        }

        async function saveDepartmentStructure() {
            const id = document.getElementById('departmentStructureId').value;
            const company = document.getElementById('dsCompany').value.trim();
            const department = document.getElementById('dsDepartment').value.trim();

            if (!company || !department) {
                alert('Company and Department are required');
                return;
            }

            const managerIds = selectedManagerIds;
            const marketingIds = selectedMarketingIds;

            const data = {
                company: company,
                brand: document.getElementById('dsBrand').value.trim() || null,
                department: department,
                subdepartment: document.getElementById('dsSubdepartment').value.trim() || null,
                manager_ids: managerIds.length > 0 ? managerIds : null,
                marketing_ids: marketingIds.length > 0 ? marketingIds : null
            };

            try {
                const url = id ? `/api/department-structures/${id}` : '/api/department-structures';
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('departmentStructureModal')).hide();
                    loadDepartmentStructures();
                    showToast(id ? 'Department structure updated' : 'Department structure created', 'success');
                } else {
                    alert(result.error || 'Failed to save department structure');
                }
            } catch (error) {
                console.error('Error saving department structure:', error);
                alert('Failed to save department structure');
            }
        }

        async function deleteDepartmentStructure(id) {
            if (!confirm('Are you sure you want to delete this department structure?')) return;

            try {
                const res = await fetch(`/api/department-structures/${id}`, { method: 'DELETE' });
                const result = await res.json();

                if (result.success) {
                    loadDepartmentStructures();
                    showToast('Department structure deleted', 'success');
                } else {
                    alert(result.error || 'Failed to delete department structure');
                }
            } catch (error) {
                console.error('Error deleting department structure:', error);
                alert('Failed to delete department structure');
            }
        }

        // ========== VAT REGISTRY ==========

        async function loadCompaniesWithVat() {
            try {
                const res = await fetch('/api/companies-vat');
                companiesWithVat = await res.json();
                renderCompaniesVatTable();
            } catch (error) {
                console.error('Error loading companies with VAT:', error);
            }
        }

        function renderCompaniesVatTable() {
            const tbody = document.getElementById('companiesVatTableBody');
            const noMsg = document.getElementById('noCompaniesVatMessage');

            if (companiesWithVat.length === 0) {
                tbody.innerHTML = '';
                noMsg.style.display = 'block';
                document.getElementById('companiesVatTable').style.display = 'none';
                return;
            }

            noMsg.style.display = 'none';
            document.getElementById('companiesVatTable').style.display = 'table';
            tbody.innerHTML = companiesWithVat.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.company || '')}</strong></td>
                    <td>${escapeHtml(c.brands || '-')}</td>
                    <td><code>${escapeHtml(c.vat || '')}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCompanyVat('${escapeHtml(c.company)}')" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCompanyVat('${escapeHtml(c.company)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewCompanyVat() {
            const name = document.getElementById('newCompanyName').value.trim();
            const brands = document.getElementById('newCompanyBrands').value.trim();
            const vat = document.getElementById('newCompanyVat').value.trim();

            if (!name || !vat) {
                alert('Company name and VAT number are required');
                return;
            }

            try {
                const res = await fetch('/api/companies-vat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: name, brands, vat })
                });

                const result = await res.json();
                if (result.success) {
                    document.getElementById('newCompanyName').value = '';
                    document.getElementById('newCompanyBrands').value = '';
                    document.getElementById('newCompanyVat').value = '';
                    await loadCompaniesWithVat();
                    showToast('Company added to VAT registry', 'success');
                } else {
                    alert('Error adding company: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding company:', error);
                alert('Failed to add company');
            }
        }

        async function deleteCompanyVat(company) {
            if (!confirm(`Delete "${company}" from VAT registry?`)) return;

            try {
                const res = await fetch(`/api/companies-vat/${encodeURIComponent(company)}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    await loadCompaniesWithVat();
                    showToast('Company removed from VAT registry', 'success');
                } else {
                    alert('Error deleting company: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting company:', error);
                alert('Failed to delete company');
            }
        }

        function editCompanyVat(company) {
            const c = companiesWithVat.find(item => item.company === company);
            if (!c) return;

            document.getElementById('editVatOriginalCompany').value = c.company;
            document.getElementById('editVatCompanyName').value = c.company || '';
            document.getElementById('editVatBrands').value = c.brands || '';
            document.getElementById('editVatNumber').value = c.vat || '';

            new bootstrap.Modal(document.getElementById('editVatModal')).show();
        }

        async function saveVatEdit() {
            const originalCompany = document.getElementById('editVatOriginalCompany').value;
            const newCompany = document.getElementById('editVatCompanyName').value.trim();
            const brands = document.getElementById('editVatBrands').value.trim();
            const vat = document.getElementById('editVatNumber').value.trim();

            if (!newCompany || !vat) {
                alert('Company name and VAT number are required');
                return;
            }

            try {
                const res = await fetch(`/api/companies-vat/${encodeURIComponent(originalCompany)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: newCompany, brands, vat })
                });

                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editVatModal')).hide();
                    await loadCompaniesWithVat();
                    showToast('Company updated successfully', 'success');
                } else {
                    alert('Error updating company: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating company:', error);
                alert('Failed to update company');
            }
        }

        // ========== ACTIVITY LOGS ==========

        let activityLogs = [];
        let activityLogsPage = 1;
        let activityLogsPageSize = 50;
        let activityLogsTotalCount = 0;
        let eventTypes = [];

        async function loadActivityLogs() {
            const userId = document.getElementById('logFilterUser').value;
            const eventType = document.getElementById('logFilterEventType').value;
            const startDate = document.getElementById('logFilterStartDate').value;
            const endDate = document.getElementById('logFilterEndDate').value;

            const params = new URLSearchParams();
            params.append('limit', activityLogsPageSize);
            params.append('offset', (activityLogsPage - 1) * activityLogsPageSize);
            if (userId) params.append('user_id', userId);
            if (eventType) params.append('event_type', eventType);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            try {
                const res = await fetch(`/api/events?${params.toString()}`);
                if (!res.ok) {
                    if (res.status === 403) {
                        showToast('Permission denied. Admin access required.', 'danger');
                        return;
                    }
                    throw new Error('Failed to load activity logs');
                }
                const data = await res.json();
                // API returns array directly, not wrapped in {events: [...]}
                activityLogs = Array.isArray(data) ? data : (data.events || []);
                activityLogsTotalCount = activityLogs.length;
                renderActivityLogs();
            } catch (error) {
                console.error('Error loading activity logs:', error);
                showToast('Failed to load activity logs', 'danger');
            }
        }

        async function loadEventTypes() {
            try {
                const res = await fetch('/api/events/types');
                if (res.ok) {
                    eventTypes = await res.json();
                    populateEventTypeFilter();
                }
            } catch (error) {
                console.error('Error loading event types:', error);
            }
        }

        function populateEventTypeFilter() {
            const select = document.getElementById('logFilterEventType');
            select.innerHTML = '<option value="">All Event Types</option>' +
                eventTypes.map(type => `<option value="${escapeHtml(type)}">${formatEventType(escapeHtml(type))}</option>`).join('');
        }

        function populateUserFilterForLogs() {
            const select = document.getElementById('logFilterUser');
            select.innerHTML = '<option value="">All Users</option>' +
                users.map(u => `<option value="${u.id}">${escapeHtml(u.name)} (${escapeHtml(u.email)})</option>`).join('');
        }

        function formatEventType(type) {
            // Convert snake_case to Title Case
            return type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('ro-RO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getEventTypeBadgeClass(type) {
            const typeMap = {
                'login': 'bg-success',
                'logout': 'bg-secondary',
                'login_failed': 'bg-danger',
                'password_changed': 'bg-warning text-dark',
                'admin_password_reset': 'bg-warning text-dark',
                'bulk_password_set': 'bg-warning text-dark',
                'invoice_created': 'bg-primary',
                'invoice_updated': 'bg-info',
                'invoice_deleted': 'bg-danger',
                'invoice_restored': 'bg-success',
                'invoice_permanently_deleted': 'bg-dark',
                'allocations_updated': 'bg-info'
            };
            return typeMap[type] || 'bg-secondary';
        }

        function renderActivityLogs() {
            const tbody = document.getElementById('activityLogsTableBody');
            const noLogsMsg = document.getElementById('noActivityLogsMessage');
            const table = document.getElementById('activityLogsTable');

            if (activityLogs.length === 0) {
                tbody.innerHTML = '';
                noLogsMsg.style.display = 'block';
                table.style.display = 'none';
                document.getElementById('activityLogsPaginationInfo').textContent = 'Showing 0 events';
                document.getElementById('activityLogsPagination').innerHTML = '';
                return;
            }

            noLogsMsg.style.display = 'none';
            table.style.display = 'table';

            tbody.innerHTML = activityLogs.map(log => `
                <tr>
                    <td class="small">${formatTimestamp(log.created_at)}</td>
                    <td>
                        <strong>${escapeHtml(log.user_email || 'Unknown')}</strong>
                    </td>
                    <td>
                        <span class="badge ${getEventTypeBadgeClass(log.event_type)}">${formatEventType(log.event_type)}</span>
                    </td>
                    <td class="small">${escapeHtml(log.event_description || '-')}</td>
                    <td class="small text-muted">${escapeHtml(log.ip_address || '-')}</td>
                </tr>
            `).join('');

            // Update pagination info
            const start = (activityLogsPage - 1) * activityLogsPageSize + 1;
            const end = Math.min(activityLogsPage * activityLogsPageSize, activityLogsTotalCount);
            document.getElementById('activityLogsPaginationInfo').textContent =
                `Showing ${start}-${end} of ${activityLogsTotalCount} events`;

            // Render pagination
            renderActivityLogsPagination();
        }

        function renderActivityLogsPagination() {
            const totalPages = Math.ceil(activityLogsTotalCount / activityLogsPageSize);
            const pagination = document.getElementById('activityLogsPagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `<li class="page-item ${activityLogsPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToActivityLogsPage(${activityLogsPage - 1}); return false;">&laquo;</a>
            </li>`;

            // Page numbers (show max 5 pages around current)
            const startPage = Math.max(1, activityLogsPage - 2);
            const endPage = Math.min(totalPages, activityLogsPage + 2);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToActivityLogsPage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === activityLogsPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToActivityLogsPage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToActivityLogsPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            html += `<li class="page-item ${activityLogsPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToActivityLogsPage(${activityLogsPage + 1}); return false;">&raquo;</a>
            </li>`;

            pagination.innerHTML = html;
        }

        function goToActivityLogsPage(page) {
            const totalPages = Math.ceil(activityLogsTotalCount / activityLogsPageSize);
            if (page < 1 || page > totalPages) return;
            activityLogsPage = page;
            loadActivityLogs();
        }

        function clearActivityLogFilters() {
            document.getElementById('logFilterUser').value = '';
            document.getElementById('logFilterEventType').value = '';
            document.getElementById('logFilterStartDate').value = '';
            document.getElementById('logFilterEndDate').value = '';
            activityLogsPage = 1;
            loadActivityLogs();
        }

        // Load activity logs when tab is shown
        document.getElementById('activity-logs-tab').addEventListener('shown.bs.tab', function() {
            populateUserFilterForLogs();
            loadEventTypes();
            loadActivityLogs();
        });

        // ========== VAT RATES ==========

        async function loadVatRates() {
            try {
                const res = await fetch('/api/vat-rates');
                vatRates = await res.json();
                renderVatRates();
            } catch (error) {
                console.error('Error loading VAT rates:', error);
            }
        }

        function renderVatRates() {
            const tbody = document.getElementById('vatRatesTableBody');
            const noVatRatesMsg = document.getElementById('noVatRatesMessage');

            if (vatRates.length === 0) {
                tbody.innerHTML = '';
                noVatRatesMsg.style.display = 'block';
                return;
            }

            noVatRatesMsg.style.display = 'none';
            tbody.innerHTML = vatRates.map(rate => `
                <tr>
                    <td>${escapeHtml(rate.name)}</td>
                    <td>${rate.rate}%</td>
                    <td>
                        ${rate.is_default
                            ? '<span class="badge bg-primary"><i class="bi bi-check-circle"></i> Default</span>'
                            : '<span class="text-muted">-</span>'}
                    </td>
                    <td>
                        ${rate.is_active
                            ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>'
                            : '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editVatRate(${rate.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVatRateConfirm(${rate.id}, '${escapeHtml(rate.name)}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewVatRate() {
            const name = document.getElementById('newVatRateName').value.trim();
            const rate = document.getElementById('newVatRateValue').value;
            const isDefault = document.getElementById('newVatRateDefault').checked;
            const isActive = document.getElementById('newVatRateActive').checked;

            if (!name || !rate) {
                showToast('Please fill in Name and Rate', 'warning');
                return;
            }

            try {
                const res = await fetch('/api/vat-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        rate: parseFloat(rate),
                        is_default: isDefault,
                        is_active: isActive
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate added successfully', 'success');
                    // Clear form
                    document.getElementById('newVatRateName').value = '';
                    document.getElementById('newVatRateValue').value = '';
                    document.getElementById('newVatRateDefault').checked = false;
                    document.getElementById('newVatRateActive').checked = true;
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to add VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error adding VAT rate:', error);
                showToast('Failed to add VAT rate', 'danger');
            }
        }

        function editVatRate(rateId) {
            const rate = vatRates.find(r => r.id === rateId);
            if (!rate) return;

            document.getElementById('editVatRateId').value = rate.id;
            document.getElementById('editVatRateName').value = rate.name;
            document.getElementById('editVatRateValue').value = rate.rate;
            document.getElementById('editVatRateDefault').checked = rate.is_default;
            document.getElementById('editVatRateActive').checked = rate.is_active;

            editVatRateModal.show();
        }

        async function saveEditedVatRate() {
            const rateId = document.getElementById('editVatRateId').value;
            const name = document.getElementById('editVatRateName').value.trim();
            const rate = document.getElementById('editVatRateValue').value;
            const isDefault = document.getElementById('editVatRateDefault').checked;
            const isActive = document.getElementById('editVatRateActive').checked;

            if (!name || !rate) {
                showToast('Please fill in Name and Rate', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/vat-rates/${rateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        rate: parseFloat(rate),
                        is_default: isDefault,
                        is_active: isActive
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate updated successfully', 'success');
                    editVatRateModal.hide();
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to update VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error updating VAT rate:', error);
                showToast('Failed to update VAT rate', 'danger');
            }
        }

        function deleteVatRateConfirm(rateId, rateName) {
            deleteType = 'vat_rate';
            deleteId = rateId;
            document.getElementById('deleteItemName').textContent = `VAT Rate: ${rateName}`;
            deleteModal.show();
        }

        async function deleteVatRateById(rateId) {
            try {
                const res = await fetch(`/api/vat-rates/${rateId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate deleted successfully', 'success');
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to delete VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error deleting VAT rate:', error);
                showToast('Failed to delete VAT rate', 'danger');
            }
        }

        // ========== UTILS ==========

        function showToast(message, type = 'info') {
            // Simple toast notification using Bootstrap alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
