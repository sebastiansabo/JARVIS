<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Accounting</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'accounting' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">Accounting</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats (same line) -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
            {% set active_page = 'dashboard' %}
            {% set inline_nav = true %}
            {% include 'partials/_accounting_nav.html' %}

            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3">
                <span class="summary-stat" title="Total Invoices">
                    <i class="bi bi-receipt text-primary"></i>
                    <strong id="totalInvoicesCompact">0</strong> invoices
                </span>
                <span class="summary-stat" title="Companies">
                    <i class="bi bi-building text-info"></i>
                    <strong id="totalCompaniesCompact">0</strong> companies
                </span>
                <span class="summary-stat" title="Departments">
                    <i class="bi bi-diagram-3 text-warning"></i>
                    <strong id="totalDepartmentsCompact">0</strong> depts
                </span>
                <span class="summary-stat text-success" title="Net Value">
                    <i class="bi bi-cash-stack"></i>
                    <strong id="totalValueCompact">0</strong>
                </span>
                <span class="summary-stat text-danger" title="VAT Value">
                    <i class="bi bi-percent"></i>
                    <strong id="vatValueCompact">0</strong>
                </span>
                <span class="summary-stat" title="Gross Value">
                    <i class="bi bi-currency-exchange text-secondary"></i>
                    <strong id="grossValueCompact">0</strong>
                </span>
                <div class="form-check form-switch mb-0">
                    <input class="form-check-input" type="checkbox" id="currencyToggle" style="cursor: pointer;">
                    <label class="form-check-label small" for="currencyToggle" id="currencyToggleLabel" style="cursor: pointer;">EUR</label>
                </div>
            </div>
        </div>

        <!-- Hidden elements for JS compatibility -->
        <div class="d-none">
            <span id="totalInvoices">0</span>
            <span id="totalCompanies">0</span>
            <span id="totalDepartments">0</span>
            <span id="totalValue">0</span>
            <span id="vatValue">0</span>
            <span id="grossValue">0</span>
        </div>
        <style>
            .summary-filter-bar { font-size: 0.85rem; }
            .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
            .summary-stat i { font-size: 1rem; }
            .summary-stat strong { color: var(--bs-body-color); }
        </style>

        <!-- Collapsible Filters Panel -->
        <div class="collapse" id="filtersCollapse">
            <div class="filter-section mb-2">
                <div class="row align-items-end g-1">
                    <div class="col">
                        <label class="form-label small mb-0">Company</label>
                        <select class="form-select form-select-sm" id="companyFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="form-label small mb-0">Department</label>
                        <select class="form-select form-select-sm" id="departmentFilter" onchange="updateSubdepartmentFilter()">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="form-label small mb-0">Subdept</label>
                        <select class="form-select form-select-sm" id="subdepartmentFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="form-label small mb-0">Brand</label>
                        <select class="form-select form-select-sm" id="brandFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-0">Status</label>
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-0">Payment</label>
                        <select class="form-select form-select-sm" id="paymentFilter">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="col">
                        <label class="form-label small mb-0">Start</label>
                        <input type="date" class="form-control form-control-sm" id="startDate">
                    </div>
                    <div class="col">
                        <label class="form-label small mb-0">End</label>
                        <input type="date" class="form-control form-control-sm" id="endDate">
                    </div>
                    <div class="col-auto">
                        <label class="form-label small mb-0">Quick</label>
                        <select class="form-select form-select-sm" id="quickFilter" onchange="setQuickFilter(this.value)">
                            <option value="">--</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                    </div>
                    <div class="col-auto d-flex align-items-end">
                        <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Clear All">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs with Action Buttons -->
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs mb-0" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#invoicesTab">
                        <i class="bi bi-receipt"></i> Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#companyTab">
                        <i class="bi bi-building"></i> By Company
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#departmentTab">
                        <i class="bi bi-diagram-3"></i> By Department
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#brandTab">
                        <i class="bi bi-tag"></i> By Brand
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#supplierTab">
                        <i class="bi bi-shop"></i> By Supplier
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#binTab" onclick="loadBinData()">
                        <i class="bi bi-trash3"></i> Bin <span id="binCount" class="bin-badge" style="display: none;">0</span>
                    </a>
                </li>
            </ul>
            <div class="d-flex gap-2">
                <a href="/add-invoice" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle"></i> New Invoice
                </a>
            </div>
        </div>

        <div class="tab-content">
            <!-- Invoices Tab -->
            <div class="tab-pane fade show active" id="invoicesTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-table"></i> Invoice Data <span id="invoiceResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <!-- Search -->
                                <div class="input-group input-group-sm" style="width: 250px;">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search supplier or invoice #..." oninput="updateSearchIcon()">
                                    <button class="btn btn-outline-secondary" type="button" id="searchBtn" onclick="handleSearchClick()" title="Search">
                                        <i class="bi bi-search" id="searchIcon"></i>
                                    </button>
                                </div>
                                <!-- Filters Toggle -->
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" id="filtersToggleBtn">
                                    <i class="bi bi-funnel"></i> Filters <span id="activeFiltersCount" class="badge bg-primary ms-1 d-none">0</span>
                                </button>
                                <!-- Sort -->
                                <select class="form-select form-select-sm" id="sortOrder" onchange="applySorting()" style="width: auto;">
                                    <option value="newest">Date: Newest</option>
                                    <option value="oldest">Date: Oldest</option>
                                    <option value="value_highest">Value: Highest</option>
                                    <option value="value_lowest">Value: Lowest</option>
                                </select>
                                <!-- Columns -->
                                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#columnConfigModal">
                                    <i class="bi bi-gear"></i> Columns
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="bulk-action-bar" id="bulkActionBar">
                            <span><strong id="selectedCount">0</strong> selected</span>
                            <div class="d-flex gap-2 align-items-center">
                                <select class="form-select form-select-sm" id="bulkStatusChange" onchange="bulkChangeStatus(this.value)" style="width: auto;">
                                    <option value="">Change Status...</option>
                                    <!-- Populated dynamically from dropdown_options -->
                                </select>
                                <button class="btn btn-outline-success btn-sm" onclick="exportSelectedToCSV()">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteSelected()">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover" id="invoicesDataTable">
                                <thead class="table-light" id="invoicesTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="invoicesTable">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="paginationControls">
                            <div class="d-flex align-items-center gap-2">
                                <span class="text-muted">Rows per page:</span>
                                <select class="form-select form-select-sm" style="width: auto;" id="pageSize" onchange="changePageSize()">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="0">All</option>
                                </select>
                                <span class="text-muted ms-3" id="paginationInfo">Showing 1-50 of 100</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item" id="prevPageItem">
                                        <a class="page-link" href="#" onclick="goToPage(currentPage - 1); return false;">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item" id="nextPageItem">
                                        <a class="page-link" href="#" onclick="goToPage(currentPage + 1); return false;">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Company Tab -->
            <div class="tab-pane fade" id="companyTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-building"></i> By Company</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group" id="companyCurrencyToggle">
                                <input type="radio" class="btn-check" name="companyCurrency" id="companyCurrencyRON" value="RON" checked>
                                <label class="btn btn-outline-primary" for="companyCurrencyRON">RON</label>
                                <input type="radio" class="btn-check" name="companyCurrency" id="companyCurrencyEUR" value="EUR">
                                <label class="btn btn-outline-primary" for="companyCurrencyEUR">EUR</label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#companyColumnConfigModal">
                                <i class="bi bi-gear"></i> Columns
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="companyDataTable">
                                <thead class="table-light" id="companyTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="companyTable">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Department Tab -->
            <div class="tab-pane fade" id="departmentTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-diagram-3"></i> By Department</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group" id="departmentCurrencyToggle">
                                <input type="radio" class="btn-check" name="departmentCurrency" id="departmentCurrencyRON" value="RON" checked>
                                <label class="btn btn-outline-primary" for="departmentCurrencyRON">RON</label>
                                <input type="radio" class="btn-check" name="departmentCurrency" id="departmentCurrencyEUR" value="EUR">
                                <label class="btn btn-outline-primary" for="departmentCurrencyEUR">EUR</label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#departmentColumnConfigModal">
                                <i class="bi bi-gear"></i> Columns
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="departmentDataTable">
                                <thead class="table-light" id="departmentTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="departmentTable">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Brand Tab -->
            <div class="tab-pane fade" id="brandTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-tag"></i> By Brand (Linie de business)</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group" id="brandCurrencyToggle">
                                <input type="radio" class="btn-check" name="brandCurrency" id="brandCurrencyRON" value="RON" checked>
                                <label class="btn btn-outline-primary" for="brandCurrencyRON">RON</label>
                                <input type="radio" class="btn-check" name="brandCurrency" id="brandCurrencyEUR" value="EUR">
                                <label class="btn btn-outline-primary" for="brandCurrencyEUR">EUR</label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#brandColumnConfigModal">
                                <i class="bi bi-gear"></i> Columns
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="brandDataTable">
                                <thead class="table-light" id="brandTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="brandTable">
                                    <tr>
                                        <td colspan="3" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Supplier Tab -->
            <div class="tab-pane fade" id="supplierTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-shop"></i> By Supplier</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="btn-group btn-group-sm" role="group" id="supplierCurrencyToggle">
                                <input type="radio" class="btn-check" name="supplierCurrency" id="supplierCurrencyRON" value="RON" checked>
                                <label class="btn btn-outline-primary" for="supplierCurrencyRON">RON</label>
                                <input type="radio" class="btn-check" name="supplierCurrency" id="supplierCurrencyEUR" value="EUR">
                                <label class="btn btn-outline-primary" for="supplierCurrencyEUR">EUR</label>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#supplierColumnConfigModal">
                                <i class="bi bi-gear"></i> Columns
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="supplierDataTable">
                                <thead class="table-light" id="supplierTableHead">
                                    <tr>
                                        <!-- Dynamic columns will be rendered here -->
                                    </tr>
                                </thead>
                                <tbody id="supplierTable">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bin Tab -->
            <div class="tab-pane fade" id="binTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-trash3"></i> Deleted Invoices (Bin) - Auto-deleted after 30 days</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreSelected()" id="binRestoreBtn" disabled>
                                <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkPermanentDeleteSelected()" id="binPermanentDeleteBtn" disabled>
                                <i class="bi bi-trash"></i> Delete Permanently
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="binDataTable">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" class="select-checkbox" id="binSelectAll" onchange="toggleBinSelectAll(this)"></th>
                                        <th>ID</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Invoice #</th>
                                        <th>Value</th>
                                        <th>Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="binTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Bin" tab to load deleted invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Detail Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceModalBody">
                    Loading...
                </div>
                <div class="modal-footer justify-content-between">
                    <div>
                        {% if current_user.can_edit_invoices %}
                        <button type="button" class="btn btn-warning me-2" id="editInvoiceBtn">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        {% endif %}
                        {% if current_user.can_delete_invoices %}
                        <button type="button" class="btn btn-danger" id="deleteInvoiceBtn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="columnConfigTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#existingColumnsTab">
                                <i class="bi bi-list-check"></i> Show/Hide Columns
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#addColumnTab">
                                <i class="bi bi-plus-circle"></i> Add Custom Column
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- Existing Columns Tab -->
                        <div class="tab-pane fade show active" id="existingColumnsTab">
                            <p class="text-muted small">Toggle columns visibility. Drag to reorder.</p>
                            <div id="columnList" class="border rounded">
                                <!-- Column items will be rendered here -->
                            </div>
                        </div>
                        <!-- Add Column Tab -->
                        <div class="tab-pane fade" id="addColumnTab">
                            <div class="mb-3">
                                <label class="form-label">Column Name</label>
                                <input type="text" class="form-control" id="newColumnName" placeholder="Enter column header name">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Data Source</label>
                                <select class="form-select" id="newColumnSource">
                                    <optgroup label="Invoice Fields">
                                        <option value="invoice.id">Invoice ID</option>
                                        <option value="invoice.supplier">Supplier</option>
                                        <option value="invoice.invoice_number">Invoice Number</option>
                                        <option value="invoice.invoice_date">Invoice Date</option>
                                        <option value="invoice.invoice_value">Invoice Value</option>
                                        <option value="invoice.net_value">Net Value</option>
                                        <option value="invoice.currency">Currency</option>
                                        <option value="invoice.invoice_template">Template</option>
                                        <option value="invoice.drive_link">Drive Link</option>
                                        <option value="invoice.comment">Comment</option>
                                        <option value="invoice.created_at">Created At</option>
                                    </optgroup>
                                    <optgroup label="Allocation Fields (First)">
                                        <option value="allocation.company">Company</option>
                                        <option value="allocation.brand">Brand</option>
                                        <option value="allocation.department">Department</option>
                                        <option value="allocation.subdepartment">Subdepartment</option>
                                        <option value="allocation.allocation_percent">Allocation %</option>
                                        <option value="allocation.allocation_value">Allocation Value</option>
                                        <option value="allocation.responsible">Responsible</option>
                                        <option value="allocation.reinvoice_to">Reinvoice To</option>
                                    </optgroup>
                                    <optgroup label="Computed">
                                        <option value="computed.allocation_count">Allocation Count</option>
                                        <option value="computed.companies_list">Companies (comma-sep)</option>
                                        <option value="computed.departments_list">Departments (comma-sep)</option>
                                        <option value="computed.reinvoice_list">Reinvoice To (all allocations)</option>
                                        <option value="computed.split_values">Split Values (all allocations)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Format (optional)</label>
                                <select class="form-select" id="newColumnFormat">
                                    <option value="text">Text (as-is)</option>
                                    <option value="currency">Currency (formatted)</option>
                                    <option value="percent">Percentage</option>
                                    <option value="date">Date</option>
                                    <option value="link">Link (clickable)</option>
                                    <option value="split">Split (allocation breakdown)</option>
                                    <option value="reinvoice">Reinvoice (detailed breakdown)</option>
                                </select>
                            </div>
                            <button class="btn btn-success" id="addCustomColumnBtn">
                                <i class="bi bi-plus"></i> Add Column
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        {% if current_user.can_access_settings %}
                        <button type="button" class="btn btn-outline-success" id="setDefaultColumnsBtn" title="Set current configuration as default for all users">
                            <i class="bi bi-people"></i> Set as Default for All
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-warning" id="resetColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Column Configuration Modal -->
    <div class="modal fade" id="companyColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Company Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="companyColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        {% if current_user.can_access_settings %}
                        <button type="button" class="btn btn-outline-success" id="setDefaultCompanyColumnsBtn" title="Set current configuration as default for all users">
                            <i class="bi bi-people"></i> Set as Default for All
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-warning" id="resetCompanyColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Department Column Configuration Modal -->
    <div class="modal fade" id="departmentColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Department Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="departmentColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        {% if current_user.can_access_settings %}
                        <button type="button" class="btn btn-outline-success" id="setDefaultDepartmentColumnsBtn" title="Set current configuration as default for all users">
                            <i class="bi bi-people"></i> Set as Default for All
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-warning" id="resetDepartmentColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Brand Column Configuration Modal -->
    <div class="modal fade" id="brandColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Brand Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="brandColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        {% if current_user.can_access_settings %}
                        <button type="button" class="btn btn-outline-success" id="setDefaultBrandColumnsBtn" title="Set current configuration as default for all users">
                            <i class="bi bi-people"></i> Set as Default for All
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-warning" id="resetBrandColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supplier Column Configuration Modal -->
    <div class="modal fade" id="supplierColumnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Supplier Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility.</p>
                    <div id="supplierColumnList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        {% if current_user.can_access_settings %}
                        <button type="button" class="btn btn-outline-success" id="setDefaultSupplierColumnsBtn" title="Set current configuration as default for all users">
                            <i class="bi bi-people"></i> Set as Default for All
                        </button>
                        {% endif %}
                    </div>
                    <button type="button" class="btn btn-outline-warning" id="resetSupplierColumnsBtn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Modal -->
    <div class="modal fade" id="editInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editInvoiceForm">
                        <input type="hidden" id="editInvoiceId">

                        <!-- Invoice Details Section -->
                        <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-receipt"></i> Invoice Details</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Supplier</label>
                                <input type="text" class="form-control" id="editSupplier" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Invoice Number</label>
                                <input type="text" class="form-control" id="editInvoiceNumber" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Invoice Date</label>
                                <input type="date" class="form-control" id="editInvoiceDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Invoice Value</label>
                                <input type="number" step="0.01" class="form-control" id="editInvoiceValue" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Currency</label>
                                <select class="form-select" id="editCurrency">
                                    <option value="RON">RON</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drive Link</label>
                                <input type="url" class="form-control" id="editDriveLink" placeholder="https://drive.google.com/...">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-control" id="editComment" placeholder="Add notes...">
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editStatus">
                                    <!-- Populated dynamically from dropdown_options -->
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" id="editPaymentStatus">
                                    <!-- Populated dynamically from dropdown_options -->
                                </select>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">VAT Subtract</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="editSubtractVat">
                                    <label class="form-check-label" for="editSubtractVat">Subtract VAT</label>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3" id="editVatRateCol" style="display: none;">
                                <label class="form-label">VAT Rate</label>
                                <select class="form-select" id="editVatRateId">
                                    <option value="">Select rate...</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3" id="editNetValueCol" style="display: none;">
                                <label class="form-label">Net Value</label>
                                <input type="text" class="form-control" id="editNetValueDisplay" readonly>
                                <input type="hidden" id="editNetValue">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Upload Invoice File</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" id="editInvoiceFile" accept=".pdf,.jpg,.jpeg,.png">
                                    <button type="button" class="btn btn-outline-success" id="uploadEditFileBtn">
                                        <i class="bi bi-cloud-upload"></i> Upload to Drive
                                    </button>
                                </div>
                                <small class="text-muted">Upload a new invoice file to Google Drive (optional)</small>
                            </div>
                        </div>

                        <!-- Allocations Section -->
                        <h6 class="border-bottom pb-2 mb-3 mt-4">
                            <i class="bi bi-pie-chart"></i> Cost Allocations
                            <span class="badge bg-secondary ms-2" id="allocationTotalBadge">0%</span>
                        </h6>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Dedicated To (Company) *</label>
                                <select class="form-select" id="editDedicatedCompany" required>
                                    <option value="">Select company...</option>
                                </select>
                            </div>
                        </div>
                        <div id="allocationsContainer">
                            <!-- Allocation rows will be rendered here -->
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm mt-2" id="addAllocationBtn">
                            <i class="bi bi-plus-circle"></i> Add Allocation
                        </button>
                    </form>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="sendNotificationToggle">
                        <label class="form-check-label" for="sendNotificationToggle">
                            <i class="bi bi-envelope"></i> Send notification to responsables
                        </label>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveInvoiceBtn">
                            <i class="bi bi-check"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Allocation Comment Modal -->
    <div class="modal fade" id="allocationCommentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-chat-text"></i> Allocation Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="allocationCommentId">
                    <div class="mb-3">
                        <label class="form-label">Allocation Details</label>
                        <div id="allocationCommentDetails" class="small text-muted border rounded p-2 bg-light"></div>
                    </div>
                    <div class="mb-3">
                        <label for="allocationCommentText" class="form-label">Comment</label>
                        <textarea class="form-control" id="allocationCommentText" rows="3" placeholder="Add a comment for this allocation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAllocationCommentBtn">
                        <i class="bi bi-check"></i> Save Comment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Loading overlay helpers
        let loadingCount = 0;
        function showLoading(message = 'Loading...') {
            loadingCount++;
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.loading-text');
            text.textContent = message;
            overlay.classList.add('show');
        }
        function hideLoading() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        function setLoadingText(message) {
            document.querySelector('#loadingOverlay .loading-text').textContent = message;
        }

        let allInvoices = [];
        let invoicesWithAllocations = {}; // Cache for full invoice data
        let currentInvoiceId = null;

        // Dynamic dropdown options from settings
        let invoiceStatusOptions = [];
        let paymentStatusOptions = [];

        // User role for status filtering
        const currentUserRole = '{{ current_user.role_name }}';
        const canEditInvoices = {{ 'true' if current_user.can_edit_invoices else 'false' }};

        // Role hierarchy for min_role filtering (higher index = more permissions)
        const roleHierarchy = ['Viewer', 'Manager', 'Admin'];

        // Check if user's role meets the minimum required role
        function userMeetsMinRole(minRole) {
            if (!minRole) return true;  // No restriction
            const userLevel = roleHierarchy.indexOf(currentUserRole);
            const minLevel = roleHierarchy.indexOf(minRole);
            return userLevel >= minLevel;
        }

        // Filter options by min_role for the current user
        function filterOptionsByRole(options) {
            return options.filter(opt => userMeetsMinRole(opt.min_role));
        }

        // Set CSS variables for status colors and inject dynamic CSS rules
        function setStatusColorCssVariables(options) {
            // Remove any existing dynamic status styles
            const existingStyle = document.getElementById('dynamic-status-styles');
            if (existingStyle) existingStyle.remove();

            // Create new style element for dynamic status colors
            const styleEl = document.createElement('style');
            styleEl.id = 'dynamic-status-styles';
            let cssRules = '';

            options.forEach(opt => {
                if (opt.color && opt.value) {
                    // Convert hex color to rgba with configurable opacity from settings
                    const hex = opt.color.replace('#', '');
                    const r = parseInt(hex.substring(0, 2), 16);
                    const g = parseInt(hex.substring(2, 4), 16);
                    const b = parseInt(hex.substring(4, 6), 16);
                    const opacity = opt.opacity ?? 0.7; // Use configurable opacity, default to 0.7
                    const rgbaColor = `rgba(${r}, ${g}, ${b}, ${opacity})`;

                    // Set CSS variable (for backwards compatibility)
                    document.documentElement.style.setProperty(`--status-color-${opt.value}`, rgbaColor);

                    // Add dynamic CSS rule for this status value
                    cssRules += `tr[data-status="${opt.value}"] > td { background-color: ${rgbaColor} !important; }\n`;
                    cssRules += `body.dark-theme tr[data-status="${opt.value}"] > td { background-color: ${rgbaColor} !important; }\n`;
                }
            });

            styleEl.textContent = cssRules;
            document.head.appendChild(styleEl);
        }

        // Set CSS variables for payment status colors (used for dropdown coloring)
        function setPaymentColorCssVariables(options) {
            options.forEach(opt => {
                if (opt.color && opt.value) {
                    // Payment status uses full color (no transparency) for dropdown background
                    document.documentElement.style.setProperty(`--payment-color-${opt.value}`, opt.color);
                }
            });
        }

        // Load dropdown options from API
        async function loadDropdownOptions() {
            try {
                const res = await fetch('/api/dropdown-options');
                const data = await res.json();

                // Store ALL options for display/filtering purposes
                const allInvoiceStatusOptions = data.filter(opt => opt.dropdown_type === 'invoice_status');
                const allPaymentStatusOptions = data.filter(opt => opt.dropdown_type === 'payment_status');

                // Filter options by min_role for editing (user can only set statuses they have permission for)
                invoiceStatusOptions = filterOptionsByRole(allInvoiceStatusOptions);
                paymentStatusOptions = filterOptionsByRole(allPaymentStatusOptions);

                // Set CSS variables for status row colors (using ALL options for display)
                setStatusColorCssVariables(allInvoiceStatusOptions);
                // Set CSS variables for payment status dropdown colors
                setPaymentColorCssVariables(allPaymentStatusOptions);

                // Populate filter dropdowns with ALL options (user can filter by any status)
                populateDropdown('statusFilter', allInvoiceStatusOptions, true);
                populateDropdown('paymentFilter', allPaymentStatusOptions, true);

                // Populate edit modal dropdowns with FILTERED options (user can only set allowed statuses)
                populateDropdown('editStatus', invoiceStatusOptions, false);
                populateDropdown('editPaymentStatus', paymentStatusOptions, false);

                // Populate bulk status dropdown with filtered options
                populateBulkStatusDropdown();
            } catch (err) {
                console.error('Failed to load dropdown options:', err);
            }
        }

        // Populate a dropdown with options
        function populateDropdown(elementId, options, includeAll) {
            const select = document.getElementById(elementId);
            if (!select) return;

            select.innerHTML = '';
            if (includeAll) {
                select.innerHTML = '<option value="">All</option>';
            }
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                select.appendChild(option);
            });
        }

        // Populate bulk status dropdown
        function populateBulkStatusDropdown() {
            const select = document.getElementById('bulkStatusChange');
            if (!select) return;

            select.innerHTML = '<option value="">Change Status...</option>';
            invoiceStatusOptions.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                select.appendChild(option);
            });
        }

        // Generate status dropdown HTML for inline editing
        function getStatusDropdownHtml(invoiceId, currentStatus) {
            currentStatus = currentStatus || invoiceStatusOptions[0]?.value || 'new';
            // Find the label for the current status (for display when no edit permission)
            const currentOpt = invoiceStatusOptions.find(o => o.value === currentStatus);
            const currentLabel = currentOpt?.label || currentStatus;

            // If user can't edit invoices or has no status options, show text only
            if (!canEditInvoices || invoiceStatusOptions.length === 0) {
                return `<span class="badge bg-secondary">${currentLabel}</span>`;
            }

            let html = `<select class="form-select form-select-sm status-dropdown"
                        data-invoice-id="${invoiceId}"
                        onchange="updateInvoiceStatus(${invoiceId}, this.value)"
                        style="width: auto; min-width: 110px; padding: 2px 24px 2px 8px; font-size: 0.8em;">`;
            // Include current status even if not in allowed options (so user can see current value)
            const optionsToShow = [...invoiceStatusOptions];
            if (!optionsToShow.find(o => o.value === currentStatus) && currentStatus) {
                optionsToShow.unshift({ value: currentStatus, label: currentLabel + ' (current)' });
            }
            optionsToShow.forEach(opt => {
                html += `<option value="${opt.value}" ${currentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`;
            });
            html += '</select>';
            return html;
        }

        // Generate payment status dropdown HTML for inline editing
        function getPaymentStatusDropdownHtml(invoiceId, currentPaymentStatus) {
            currentPaymentStatus = currentPaymentStatus || paymentStatusOptions[0]?.value || 'not_paid';
            // Get current option's color for styling
            const currentOpt = paymentStatusOptions.find(o => o.value === currentPaymentStatus);
            const currentLabel = currentOpt?.label || currentPaymentStatus;
            const bgColor = currentOpt?.color ? `var(--payment-color-${currentPaymentStatus}, ${currentOpt.color})` : '';
            const style = bgColor ? `background-color: ${bgColor}; color: #fff;` : '';

            // If user can't edit invoices or has no payment options, show text only
            if (!canEditInvoices || paymentStatusOptions.length === 0) {
                return `<span class="badge" style="${style || 'background: var(--bs-secondary);'}">${currentLabel}</span>`;
            }

            let html = `<select class="form-select form-select-sm payment-status-dropdown"
                        data-invoice-id="${invoiceId}"
                        data-payment-status="${currentPaymentStatus}"
                        onchange="updatePaymentStatus(${invoiceId}, this.value)"
                        style="width: auto; min-width: 100px; padding: 2px 24px 2px 8px; font-size: 0.8em; ${style}">`;
            // Include current status even if not in allowed options
            const optionsToShow = [...paymentStatusOptions];
            if (!optionsToShow.find(o => o.value === currentPaymentStatus) && currentPaymentStatus) {
                optionsToShow.unshift({ value: currentPaymentStatus, label: currentLabel + ' (current)' });
            }
            optionsToShow.forEach(opt => {
                html += `<option value="${opt.value}" ${currentPaymentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`;
            });
            html += '</select>';
            return html;
        }

        // Generate modal status dropdown HTML
        function getModalStatusDropdownHtml(invoiceId, currentStatus) {
            currentStatus = currentStatus || invoiceStatusOptions[0]?.value || 'new';
            const currentOpt = invoiceStatusOptions.find(o => o.value === currentStatus);
            const currentLabel = currentOpt?.label || currentStatus;

            // If user can't edit or has no options, show text only
            if (!canEditInvoices || invoiceStatusOptions.length === 0) {
                return `<span class="badge bg-secondary">${currentLabel}</span>`;
            }

            let html = `<select class="form-select form-select-sm" id="modalStatusDropdown"
                        onchange="updateInvoiceStatus(${invoiceId}, this.value)"
                        style="width: auto; min-width: 120px;">`;
            // Include current status even if not in allowed options
            const optionsToShow = [...invoiceStatusOptions];
            if (!optionsToShow.find(o => o.value === currentStatus) && currentStatus) {
                optionsToShow.unshift({ value: currentStatus, label: currentLabel + ' (current)' });
            }
            optionsToShow.forEach(opt => {
                html += `<option value="${opt.value}" ${currentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`;
            });
            html += '</select>';
            return html;
        }

        // Generate modal payment status dropdown HTML
        function getModalPaymentStatusDropdownHtml(invoiceId, currentPaymentStatus) {
            currentPaymentStatus = currentPaymentStatus || paymentStatusOptions[0]?.value || 'not_paid';
            // Get current option's color for styling
            const currentOpt = paymentStatusOptions.find(o => o.value === currentPaymentStatus);
            const currentLabel = currentOpt?.label || currentPaymentStatus;
            const bgColor = currentOpt?.color ? `var(--payment-color-${currentPaymentStatus}, ${currentOpt.color})` : '';
            const style = bgColor ? `background-color: ${bgColor}; color: #fff;` : '';

            // If user can't edit or has no options, show text only
            if (!canEditInvoices || paymentStatusOptions.length === 0) {
                return `<span class="badge" style="${style || 'background: var(--bs-secondary);'}">${currentLabel}</span>`;
            }

            let html = `<select class="form-select form-select-sm payment-status-dropdown" id="modalPaymentStatusDropdown"
                        data-payment-status="${currentPaymentStatus}"
                        onchange="updatePaymentStatus(${invoiceId}, this.value)"
                        style="width: auto; min-width: 120px; ${style}">`;
            // Include current status even if not in allowed options
            const optionsToShow = [...paymentStatusOptions];
            if (!optionsToShow.find(o => o.value === currentPaymentStatus) && currentPaymentStatus) {
                optionsToShow.unshift({ value: currentPaymentStatus, label: currentLabel + ' (current)' });
            }
            optionsToShow.forEach(opt => {
                html += `<option value="${opt.value}" ${currentPaymentStatus === opt.value ? 'selected' : ''}>${opt.label}</option>`;
            });
            html += '</select>';
            return html;
        }

        // Pagination state
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('accountingPageSize') || '50');
        let organizationalStructure = []; // Cache for company/department structure
        let editAllocations = []; // Current allocations being edited

        // Summary card totals for currency toggle
        let summaryTotalRon = 0;
        let summaryTotalEur = 0;
        let summaryGrossRon = 0;
        let summaryGrossEur = 0;
        let summaryVatRon = 0;
        let summaryVatEur = 0;
        let currentEurRate = 5.0; // Default EUR/RON rate, will be fetched from API

        // Selection state
        let selectedInvoices = new Set();
        let binInvoices = [];
        let selectedBinInvoices = new Set();

        // Default column configuration
        const DEFAULT_COLUMNS = [
            { id: 'select', name: '', source: 'special.select', format: 'special', visible: true, custom: false },
            { id: 'id', name: 'ID', source: 'invoice.id', format: 'text', visible: true, custom: false },
            { id: 'status', name: 'Status', source: 'invoice.status', format: 'status', visible: true, custom: false },
            { id: 'payment_status', name: 'Payment', source: 'invoice.payment_status', format: 'payment_status', visible: true, custom: false },
            { id: 'date', name: 'Date', source: 'invoice.invoice_date', format: 'date', visible: true, custom: false },
            { id: 'supplier', name: 'Supplier', source: 'invoice.supplier', format: 'text', visible: true, custom: false },
            { id: 'invoice_number', name: 'Invoice #', source: 'invoice.invoice_number', format: 'text', visible: true, custom: false },
            { id: 'value', name: 'Value', source: 'invoice.invoice_value', format: 'currency', visible: true, custom: false },
            { id: 'net_value', name: 'Net Value', source: 'invoice.net_value', format: 'currency', visible: false, custom: false },
            { id: 'currency', name: 'Currency', source: 'invoice.currency', format: 'text', visible: false, custom: false },
            { id: 'template', name: 'Template', source: 'invoice.invoice_template', format: 'text', visible: false, custom: false },
            { id: 'company', name: 'Company', source: 'allocation.company', format: 'text', visible: false, custom: false },
            { id: 'department', name: 'Department', source: 'allocation.department', format: 'text', visible: false, custom: false },
            { id: 'brand', name: 'Brand', source: 'allocation.brand', format: 'text', visible: false, custom: false },
            { id: 'responsible', name: 'Responsible', source: 'allocation.responsible', format: 'text', visible: false, custom: false },
            { id: 'reinvoice_to', name: 'Reinvoice To', source: 'computed.reinvoice_list', format: 'reinvoice', visible: false, custom: false },
            { id: 'split_values', name: 'Split Values', source: 'computed.split_values', format: 'split', visible: false, custom: false },
            { id: 'comment', name: 'Notes', source: 'invoice.comment', format: 'text', visible: false, custom: false },
            { id: 'actions', name: 'Actions', source: 'special.actions', format: 'special', visible: true, custom: false },
            { id: 'drive', name: 'Drive', source: 'special.drive', format: 'special', visible: true, custom: false }
        ];

        let columnConfig = [];

        // Default column configuration for Company view
        const DEFAULT_COMPANY_COLUMNS = [
            { id: 'company', name: 'Company', source: 'company', format: 'text', visible: true },
            { id: 'total_value', name: 'Total Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: true },
            { id: 'avg_exchange_rate', name: 'Avg Rate', source: 'avg_exchange_rate', format: 'rate', visible: true }
        ];

        // Default column configuration for Department view
        const DEFAULT_DEPARTMENT_COLUMNS = [
            { id: 'company', name: 'Company', source: 'company', format: 'text', visible: true },
            { id: 'department', name: 'Department', source: 'department', format: 'text', visible: true },
            { id: 'subdepartment', name: 'Subdepartment', source: 'subdepartment', format: 'text', visible: true },
            { id: 'total_value', name: 'Total Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: false },
            { id: 'avg_exchange_rate', name: 'Avg Rate', source: 'avg_exchange_rate', format: 'rate', visible: true }
        ];

        const DEFAULT_BRAND_COLUMNS = [
            { id: 'brand', name: 'Brand (Linie de business)', source: 'brand', format: 'text', visible: true },
            { id: 'invoice_numbers', name: 'Invoice #', source: 'invoice_numbers', format: 'text', visible: true },
            { id: 'total_value', name: 'Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'split_values', name: 'Split Values', source: 'split_values', format: 'split', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: false },
            { id: 'avg_exchange_rate', name: 'Avg Rate', source: 'avg_exchange_rate', format: 'rate', visible: true }
        ];

        const DEFAULT_SUPPLIER_COLUMNS = [
            { id: 'supplier', name: 'Supplier', source: 'supplier', format: 'text', visible: true },
            { id: 'total_value', name: 'Total Value', source: 'total_value', format: 'currency', visible: true },
            { id: 'invoice_count', name: 'Invoice Count', source: 'invoice_count', format: 'text', visible: true },
            { id: 'avg_value', name: 'Avg per Invoice', source: 'avg_value', format: 'currency', visible: true },
            { id: 'avg_exchange_rate', name: 'Avg Rate', source: 'avg_exchange_rate', format: 'rate', visible: true }
        ];

        let companyColumnConfig = [];
        let departmentColumnConfig = [];
        let brandColumnConfig = [];
        let supplierColumnConfig = [];

        // Currency toggle state and data cache for all summary tabs
        let companyCurrency = localStorage.getItem('companySummaryCurrency') || 'RON';
        let companyData = [];
        let departmentCurrency = localStorage.getItem('departmentSummaryCurrency') || 'RON';
        let departmentData = [];
        let brandCurrency = localStorage.getItem('brandSummaryCurrency') || 'RON';
        let brandData = [];
        let supplierCurrency = localStorage.getItem('supplierSummaryCurrency') || 'RON';
        let supplierData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            showLoading('Loading dashboard...');
            try {
                restoreSummaryState();
                await loadDropdownOptions();
                await loadColumnConfig();
                initPagination();
                initCurrencyToggles();
                initOnlineUsersTracking();
                await loadData();
                setupEventListeners();
            } finally {
                hideLoading();
            }
        });

        // Online users tracking - provided by /static/js/online-users.js

        function initCurrencyToggles() {
            // Set the radio button state from localStorage for all tabs
            if (companyCurrency === 'EUR') {
                document.getElementById('companyCurrencyEUR').checked = true;
            } else {
                document.getElementById('companyCurrencyRON').checked = true;
            }
            if (departmentCurrency === 'EUR') {
                document.getElementById('departmentCurrencyEUR').checked = true;
            } else {
                document.getElementById('departmentCurrencyRON').checked = true;
            }
            if (brandCurrency === 'EUR') {
                document.getElementById('brandCurrencyEUR').checked = true;
            } else {
                document.getElementById('brandCurrencyRON').checked = true;
            }
            if (supplierCurrency === 'EUR') {
                document.getElementById('supplierCurrencyEUR').checked = true;
            } else {
                document.getElementById('supplierCurrencyRON').checked = true;
            }
        }

        function initPagination() {
            // Initialize page size from localStorage
            const savedPageSize = localStorage.getItem('accountingPageSize');
            if (savedPageSize) {
                pageSize = parseInt(savedPageSize);
            }
            document.getElementById('pageSize').value = pageSize.toString();
        }

        async function loadColumnConfig() {
            // Fetch server defaults first (if not already loaded)
            if (Object.keys(serverDefaultColumns).length === 0) {
                await fetchServerDefaultColumns();
            }

            // Invoice columns: localStorage > serverDefault > hardcoded DEFAULT
            const saved = localStorage.getItem('accountingColumnConfig');
            if (saved) {
                columnConfig = JSON.parse(saved);
                // Ensure select column exists (for migration from old configs)
                if (!columnConfig.find(c => c.id === 'select')) {
                    columnConfig.unshift({ id: 'select', name: '', source: 'special.select', format: 'special', visible: true, custom: false });
                }
                // Ensure payment_status column exists (for migration from old configs)
                if (!columnConfig.find(c => c.id === 'payment_status')) {
                    // Insert after status column
                    const statusIdx = columnConfig.findIndex(c => c.id === 'status');
                    const paymentCol = { id: 'payment_status', name: 'Payment', source: 'invoice.payment_status', format: 'payment_status', visible: true, custom: false };
                    if (statusIdx >= 0) {
                        columnConfig.splice(statusIdx + 1, 0, paymentCol);
                    } else {
                        columnConfig.push(paymentCol);
                    }
                }
                // Ensure net_value column exists (for migration from old configs)
                if (!columnConfig.find(c => c.id === 'net_value')) {
                    // Insert after value column
                    const valueIdx = columnConfig.findIndex(c => c.id === 'value');
                    const netValueCol = { id: 'net_value', name: 'Net Value', source: 'invoice.net_value', format: 'currency', visible: false, custom: false };
                    if (valueIdx >= 0) {
                        columnConfig.splice(valueIdx + 1, 0, netValueCol);
                    } else {
                        columnConfig.push(netValueCol);
                    }
                }
            } else if (serverDefaultColumns.accounting) {
                // Use server default if no user personalization
                columnConfig = JSON.parse(JSON.stringify(serverDefaultColumns.accounting));
            } else {
                columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            }
            renderColumnList();

            // Company columns: localStorage > serverDefault > hardcoded DEFAULT
            const savedCompany = localStorage.getItem('companyColumnConfig');
            if (savedCompany) {
                companyColumnConfig = JSON.parse(savedCompany);
            } else if (serverDefaultColumns.company) {
                companyColumnConfig = JSON.parse(JSON.stringify(serverDefaultColumns.company));
            } else {
                companyColumnConfig = JSON.parse(JSON.stringify(DEFAULT_COMPANY_COLUMNS));
            }
            renderCompanyColumnList();

            // Department columns: localStorage > serverDefault > hardcoded DEFAULT
            const savedDept = localStorage.getItem('departmentColumnConfig');
            if (savedDept) {
                departmentColumnConfig = JSON.parse(savedDept);
            } else if (serverDefaultColumns.department) {
                departmentColumnConfig = JSON.parse(JSON.stringify(serverDefaultColumns.department));
            } else {
                departmentColumnConfig = JSON.parse(JSON.stringify(DEFAULT_DEPARTMENT_COLUMNS));
            }
            renderDepartmentColumnList();

            // Brand columns: localStorage > serverDefault > hardcoded DEFAULT
            const savedBrand = localStorage.getItem('brandColumnConfig');
            if (savedBrand) {
                brandColumnConfig = JSON.parse(savedBrand);
            } else if (serverDefaultColumns.brand) {
                brandColumnConfig = JSON.parse(JSON.stringify(serverDefaultColumns.brand));
            } else {
                brandColumnConfig = JSON.parse(JSON.stringify(DEFAULT_BRAND_COLUMNS));
            }
            renderBrandColumnList();

            // Supplier columns: localStorage > serverDefault > hardcoded DEFAULT
            const savedSupplier = localStorage.getItem('supplierColumnConfig');
            if (savedSupplier) {
                supplierColumnConfig = JSON.parse(savedSupplier);
            } else if (serverDefaultColumns.supplier) {
                supplierColumnConfig = JSON.parse(JSON.stringify(serverDefaultColumns.supplier));
            } else {
                supplierColumnConfig = JSON.parse(JSON.stringify(DEFAULT_SUPPLIER_COLUMNS));
            }
            renderSupplierColumnList();
        }

        function saveColumnConfig() {
            localStorage.setItem('accountingColumnConfig', JSON.stringify(columnConfig));
            renderInvoicesTable(allInvoices);
        }

        function saveCompanyColumnConfig() {
            localStorage.setItem('companyColumnConfig', JSON.stringify(companyColumnConfig));
            loadCompanySummary();
        }

        function saveDepartmentColumnConfig() {
            localStorage.setItem('departmentColumnConfig', JSON.stringify(departmentColumnConfig));
            loadDepartmentSummary();
        }

        function saveBrandColumnConfig() {
            localStorage.setItem('brandColumnConfig', JSON.stringify(brandColumnConfig));
            loadBrandSummary();
        }

        function saveSupplierColumnConfig() {
            localStorage.setItem('supplierColumnConfig', JSON.stringify(supplierColumnConfig));
            loadSupplierSummary();
        }

        function resetColumnConfig() {
            // Use server default if available, otherwise hardcoded DEFAULT
            columnConfig = serverDefaultColumns.accounting
                ? JSON.parse(JSON.stringify(serverDefaultColumns.accounting))
                : JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            saveColumnConfig();
            renderColumnList();
        }

        function resetCompanyColumnConfig() {
            // Use server default if available, otherwise hardcoded DEFAULT
            companyColumnConfig = serverDefaultColumns.company
                ? JSON.parse(JSON.stringify(serverDefaultColumns.company))
                : JSON.parse(JSON.stringify(DEFAULT_COMPANY_COLUMNS));
            saveCompanyColumnConfig();
            renderCompanyColumnList();
        }

        function resetDepartmentColumnConfig() {
            // Use server default if available, otherwise hardcoded DEFAULT
            departmentColumnConfig = serverDefaultColumns.department
                ? JSON.parse(JSON.stringify(serverDefaultColumns.department))
                : JSON.parse(JSON.stringify(DEFAULT_DEPARTMENT_COLUMNS));
            saveDepartmentColumnConfig();
            renderDepartmentColumnList();
        }

        function resetBrandColumnConfig() {
            // Use server default if available, otherwise hardcoded DEFAULT
            brandColumnConfig = serverDefaultColumns.brand
                ? JSON.parse(JSON.stringify(serverDefaultColumns.brand))
                : JSON.parse(JSON.stringify(DEFAULT_BRAND_COLUMNS));
            saveBrandColumnConfig();
            renderBrandColumnList();
        }

        function resetSupplierColumnConfig() {
            // Use server default if available, otherwise hardcoded DEFAULT
            supplierColumnConfig = serverDefaultColumns.supplier
                ? JSON.parse(JSON.stringify(serverDefaultColumns.supplier))
                : JSON.parse(JSON.stringify(DEFAULT_SUPPLIER_COLUMNS));
            saveSupplierColumnConfig();
            renderSupplierColumnList();
        }

        // Set current column configuration as server default for all users
        async function setDefaultColumns(tab) {
            const configMap = {
                'accounting': columnConfig,
                'company': companyColumnConfig,
                'department': departmentColumnConfig,
                'brand': brandColumnConfig,
                'supplier': supplierColumnConfig
            };
            const config = configMap[tab];
            if (!config) return;

            const confirmed = await JarvisDialog.confirm(`Set current ${tab} column configuration as the default for all users?`, { title: 'Set Default Columns' });
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/default-columns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tab: tab,
                        config: JSON.stringify(config)
                    })
                });
                const result = await response.json();
                if (result.success) {
                    await JarvisDialog.alert('Default columns saved for all users', { type: 'success', title: 'Success' });
                    // Update the cached server defaults
                    serverDefaultColumns[tab] = JSON.parse(JSON.stringify(config));
                } else {
                    await JarvisDialog.alert('Error: ' + result.error, { type: 'error', title: 'Error' });
                }
            } catch (error) {
                console.error('Error setting default columns:', error);
                await JarvisDialog.alert('Error saving default columns', { type: 'error', title: 'Error' });
            }
        }

        // Fetch server default columns
        let serverDefaultColumns = {};
        async function fetchServerDefaultColumns() {
            try {
                const response = await fetch('/api/default-columns');
                const data = await response.json();
                serverDefaultColumns = {
                    accounting: data.accounting ? JSON.parse(data.accounting) : null,
                    company: data.company ? JSON.parse(data.company) : null,
                    department: data.department ? JSON.parse(data.department) : null,
                    brand: data.brand ? JSON.parse(data.brand) : null
                };
            } catch (error) {
                console.error('Error fetching server default columns:', error);
            }
        }

        function renderColumnList() {
            const container = document.getElementById('columnList');
            container.innerHTML = columnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">
                        ${col.name}
                        ${col.custom ? '<span class="custom-column-badge">Custom</span>' : ''}
                    </span>
                    <small class="text-muted">${col.source}</small>
                    ${col.custom ? `<button class="btn btn-sm btn-outline-danger ms-2 delete-column-btn" data-idx="${idx}"><i class="bi bi-trash"></i></button>` : ''}
                </div>
            `).join('');

            // Add event listeners for toggles
            container.querySelectorAll('.column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    columnConfig[idx].visible = e.target.checked;
                    saveColumnConfig();
                    renderColumnList();
                });
            });

            // Add event listeners for delete buttons
            container.querySelectorAll('.delete-column-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = parseInt(e.target.closest('button').dataset.idx);
                    columnConfig.splice(idx, 1);
                    saveColumnConfig();
                    renderColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, columnConfig, saveColumnConfig, renderColumnList);
        }

        function setupDragAndDrop(container, config, saveFunc, renderFunc) {
            let draggedIdx = null;

            container.querySelectorAll('.column-list-item').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedIdx = parseInt(item.dataset.idx);
                    item.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    container.querySelectorAll('.column-list-item').forEach(el => el.classList.remove('drag-over'));
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const targetIdx = parseInt(item.dataset.idx);
                    if (targetIdx !== draggedIdx) {
                        item.classList.add('drag-over');
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const targetIdx = parseInt(item.dataset.idx);
                    if (draggedIdx !== null && draggedIdx !== targetIdx) {
                        // Reorder the config array
                        const draggedItem = config[draggedIdx];
                        config.splice(draggedIdx, 1);
                        config.splice(targetIdx, 0, draggedItem);
                        saveFunc();
                        renderFunc();
                    }
                    item.classList.remove('drag-over');
                });
            });
        }

        function renderCompanyColumnList() {
            const container = document.getElementById('companyColumnList');
            container.innerHTML = companyColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input company-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.company-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    companyColumnConfig[idx].visible = e.target.checked;
                    saveCompanyColumnConfig();
                    renderCompanyColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, companyColumnConfig, saveCompanyColumnConfig, renderCompanyColumnList);
        }

        function renderDepartmentColumnList() {
            const container = document.getElementById('departmentColumnList');
            container.innerHTML = departmentColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input department-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.department-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    departmentColumnConfig[idx].visible = e.target.checked;
                    saveDepartmentColumnConfig();
                    renderDepartmentColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, departmentColumnConfig, saveDepartmentColumnConfig, renderDepartmentColumnList);
        }

        function renderBrandColumnList() {
            const container = document.getElementById('brandColumnList');
            container.innerHTML = brandColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input brand-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.brand-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    brandColumnConfig[idx].visible = e.target.checked;
                    saveBrandColumnConfig();
                    renderBrandColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, brandColumnConfig, saveBrandColumnConfig, renderBrandColumnList);
        }

        function renderSupplierColumnList() {
            const container = document.getElementById('supplierColumnList');
            container.innerHTML = supplierColumnConfig.map((col, idx) => `
                <div class="column-list-item ${col.visible ? '' : 'disabled'}" data-idx="${idx}" draggable="true">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <div class="form-check form-switch">
                        <input class="form-check-input supplier-column-toggle" type="checkbox" ${col.visible ? 'checked' : ''} data-idx="${idx}">
                    </div>
                    <span class="flex-grow-1">${col.name}</span>
                    <small class="text-muted">${col.source}</small>
                </div>
            `).join('');

            container.querySelectorAll('.supplier-column-toggle').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    const idx = parseInt(e.target.dataset.idx);
                    supplierColumnConfig[idx].visible = e.target.checked;
                    saveSupplierColumnConfig();
                    renderSupplierColumnList();
                });
            });

            // Add drag-and-drop functionality
            setupDragAndDrop(container, supplierColumnConfig, saveSupplierColumnConfig, renderSupplierColumnList);
        }

        async function addCustomColumn() {
            const name = document.getElementById('newColumnName').value.trim();
            const source = document.getElementById('newColumnSource').value;
            const format = document.getElementById('newColumnFormat').value;

            if (!name) {
                await JarvisDialog.alert('Please enter a column name', { type: 'warning', title: 'Missing Name' });
                return;
            }

            const newCol = {
                id: 'custom_' + Date.now(),
                name: name,
                source: source,
                format: format,
                visible: true,
                custom: true
            };

            // Insert before Actions column
            const actionsIdx = columnConfig.findIndex(c => c.id === 'actions');
            if (actionsIdx >= 0) {
                columnConfig.splice(actionsIdx, 0, newCol);
            } else {
                columnConfig.push(newCol);
            }

            saveColumnConfig();
            renderColumnList();

            // Clear form
            document.getElementById('newColumnName').value = '';
            document.getElementById('newColumnSource').selectedIndex = 0;
            document.getElementById('newColumnFormat').selectedIndex = 0;

            // Switch to columns tab
            const tabEl = document.querySelector('#columnConfigTabs a[href="#existingColumnsTab"]');
            bootstrap.Tab.getOrCreateInstance(tabEl).show();
        }

        // Search icon toggle functions
        function updateSearchIcon() {
            const input = document.getElementById('searchInput');
            const icon = document.getElementById('searchIcon');
            const btn = document.getElementById('searchBtn');
            if (input.value.trim()) {
                icon.className = 'bi bi-x-lg';
                btn.title = 'Clear';
            } else {
                icon.className = 'bi bi-search';
                btn.title = 'Search';
            }
        }

        function handleSearchClick() {
            const input = document.getElementById('searchInput');
            if (input.value.trim()) {
                input.value = '';
                updateSearchIcon();
                handleSearch();
            } else {
                input.focus();
            }
        }

        function setupEventListeners() {
            // Search input - instant search on typing
            const searchInput = document.getElementById('searchInput');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(handleSearch, 300); // Debounce 300ms
            });
            // Enter key in search input
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    clearTimeout(searchTimeout);
                    handleSearch();
                }
            });
            document.getElementById('deleteInvoiceBtn').addEventListener('click', handleDelete);
            document.getElementById('editInvoiceBtn').addEventListener('click', openEditModal);
            document.getElementById('saveInvoiceBtn').addEventListener('click', handleSaveInvoice);
            document.getElementById('uploadEditFileBtn').addEventListener('click', handleEditFileUpload);
            document.getElementById('addAllocationBtn').addEventListener('click', addNewAllocation);
            document.getElementById('editSubtractVat').addEventListener('change', onEditSubtractVatChange);
            document.getElementById('editVatRateId').addEventListener('change', calculateEditNetValue);
            document.getElementById('editInvoiceValue').addEventListener('input', () => {
                if (document.getElementById('editSubtractVat').checked) calculateEditNetValue();
            });
            document.getElementById('editCurrency').addEventListener('change', () => {
                if (document.getElementById('editSubtractVat').checked) calculateEditNetValue();
            });
            document.getElementById('addCustomColumnBtn').addEventListener('click', addCustomColumn);
            document.getElementById('resetColumnsBtn').addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Reset all columns to default? This will remove custom columns.', { title: 'Reset Columns', danger: true });
                if (confirmed) {
                    resetColumnConfig();
                }
            });
            document.getElementById('resetCompanyColumnsBtn').addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Reset company columns to default?', { title: 'Reset Columns', danger: true });
                if (confirmed) {
                    resetCompanyColumnConfig();
                }
            });
            document.getElementById('resetDepartmentColumnsBtn').addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Reset department columns to default?', { title: 'Reset Columns', danger: true });
                if (confirmed) {
                    resetDepartmentColumnConfig();
                }
            });
            document.getElementById('resetBrandColumnsBtn').addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Reset brand columns to default?', { title: 'Reset Columns', danger: true });
                if (confirmed) {
                    resetBrandColumnConfig();
                }
            });
            document.getElementById('resetSupplierColumnsBtn').addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Reset supplier columns to default?', { title: 'Reset Columns', danger: true });
                if (confirmed) {
                    resetSupplierColumnConfig();
                }
            });

            // Set as Default buttons (admin only)
            const setDefaultColumnsBtn = document.getElementById('setDefaultColumnsBtn');
            if (setDefaultColumnsBtn) {
                setDefaultColumnsBtn.addEventListener('click', () => setDefaultColumns('accounting'));
            }
            const setDefaultCompanyColumnsBtn = document.getElementById('setDefaultCompanyColumnsBtn');
            if (setDefaultCompanyColumnsBtn) {
                setDefaultCompanyColumnsBtn.addEventListener('click', () => setDefaultColumns('company'));
            }
            const setDefaultDepartmentColumnsBtn = document.getElementById('setDefaultDepartmentColumnsBtn');
            if (setDefaultDepartmentColumnsBtn) {
                setDefaultDepartmentColumnsBtn.addEventListener('click', () => setDefaultColumns('department'));
            }
            const setDefaultBrandColumnsBtn = document.getElementById('setDefaultBrandColumnsBtn');
            if (setDefaultBrandColumnsBtn) {
                setDefaultBrandColumnsBtn.addEventListener('click', () => setDefaultColumns('brand'));
            }
            const setDefaultSupplierColumnsBtn = document.getElementById('setDefaultSupplierColumnsBtn');
            if (setDefaultSupplierColumnsBtn) {
                setDefaultSupplierColumnsBtn.addEventListener('click', () => setDefaultColumns('supplier'));
            }

            // Currency toggle for summary card
            document.getElementById('currencyToggle').addEventListener('change', (e) => {
                updateTotalValueDisplay(e.target.checked);
            });

            // Currency toggle for By Company tab
            document.querySelectorAll('input[name="companyCurrency"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    companyCurrency = e.target.value;
                    localStorage.setItem('companySummaryCurrency', companyCurrency);
                    renderCompanyTable(companyData);
                });
            });

            // Currency toggle for By Department tab
            document.querySelectorAll('input[name="departmentCurrency"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    departmentCurrency = e.target.value;
                    localStorage.setItem('departmentSummaryCurrency', departmentCurrency);
                    renderDepartmentTable(departmentData);
                });
            });

            // Currency toggle for By Brand tab
            document.querySelectorAll('input[name="brandCurrency"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    brandCurrency = e.target.value;
                    localStorage.setItem('brandSummaryCurrency', brandCurrency);
                    renderBrandTable(brandData);
                });
            });

            // Currency toggle for By Supplier tab
            document.querySelectorAll('input[name="supplierCurrency"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    supplierCurrency = e.target.value;
                    localStorage.setItem('supplierSummaryCurrency', supplierCurrency);
                    renderSupplierTable(supplierData);
                });
            });

            // Tab change listeners
            document.querySelectorAll('#mainTabs .nav-link').forEach(tab => {
                tab.addEventListener('shown.bs.tab', loadData);
            });

            // Refresh table when modal closes
            document.getElementById('columnConfigModal').addEventListener('hidden.bs.modal', () => {
                renderInvoicesTable(allInvoices);
            });

            // Dynamic filter listeners - auto-apply on change
            document.getElementById('companyFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('departmentFilter').addEventListener('change', () => {
                updateSubdepartmentFilter();
                applyFiltersOnly();
            });
            document.getElementById('subdepartmentFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('brandFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('statusFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('paymentFilter').addEventListener('change', applyFiltersOnly);
            document.getElementById('startDate').addEventListener('change', applyFiltersOnly);
            document.getElementById('endDate').addEventListener('change', applyFiltersOnly);
            document.getElementById('quickFilter').addEventListener('change', (e) => {
                if (e.target.value) {
                    setQuickFilter(e.target.value);
                }
            });
        }

        // Update active filters count badge
        function updateActiveFiltersCount() {
            let count = 0;
            if (document.getElementById('companyFilter').value) count++;
            if (document.getElementById('departmentFilter').value) count++;
            if (document.getElementById('subdepartmentFilter').value) count++;
            if (document.getElementById('brandFilter').value) count++;
            if (document.getElementById('statusFilter').value) count++;
            if (document.getElementById('paymentFilter').value) count++;
            if (document.getElementById('startDate').value) count++;
            if (document.getElementById('endDate').value) count++;

            const badge = document.getElementById('activeFiltersCount');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }

        // Apply filters without reloading filter dropdowns (to avoid infinite loop)
        async function applyFiltersOnly() {
            showLoading('Applying filters...');
            updateActiveFiltersCount();
            try {
                await Promise.all([
                    loadInvoices(),
                    loadCompanySummary(),
                    loadDepartmentSummary(),
                    loadBrandSummary(),
                    loadSupplierSummary()
                ]);
            } finally {
                hideLoading();
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function loadData() {
            await Promise.all([
                loadInvoices(),
                loadCompanySummary(),
                loadDepartmentSummary(),
                loadBrandSummary(),
                loadSupplierSummary(),
                loadCompanyFilter(),
                loadDepartmentFilter(),
                loadBrandFilter()
            ]);
            updateSummaryCards();
        }

        function setQuickFilter(period) {
            if (!period) return; // Empty selection, do nothing

            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');
            const today = new Date();

            // Helper to format date as YYYY-MM-DD in local timezone
            const formatDate = (d) => {
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            if (period === 'today') {
                // Set both start and end to today
                const todayStr = formatDate(today);
                startDate.value = todayStr;
                endDate.value = todayStr;
            } else if (period === 'week') {
                // Get current day of week (0 = Sunday, 1 = Monday, etc.)
                const dayOfWeek = today.getDay();
                // Calculate Monday of current week (week starts on Monday)
                const monday = new Date(today);
                monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                // Calculate Sunday of current week
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);
                startDate.value = formatDate(monday);
                endDate.value = formatDate(sunday);
            } else if (period === 'month') {
                // First day of current month
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                // Last day of current month
                const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate.value = formatDate(firstDay);
                endDate.value = formatDate(lastDay);
            } else if (period === 'quarter') {
                // Determine current quarter (0-3)
                const quarter = Math.floor(today.getMonth() / 3);
                // First day of quarter
                const firstDay = new Date(today.getFullYear(), quarter * 3, 1);
                // Last day of quarter
                const lastDay = new Date(today.getFullYear(), quarter * 3 + 3, 0);
                startDate.value = formatDate(firstDay);
                endDate.value = formatDate(lastDay);
            } else if (period === 'year') {
                // First day of current year
                const firstDay = new Date(today.getFullYear(), 0, 1);
                // Last day of current year
                const lastDay = new Date(today.getFullYear(), 11, 31);
                startDate.value = formatDate(firstDay);
                endDate.value = formatDate(lastDay);
            }

            // Auto-apply filters
            applyFiltersOnly();
        }

        async function loadInvoices() {
            try {
                // Reset to first page when loading new data
                currentPage = 1;

                // Build URL with filter parameters
                const params = new URLSearchParams();
                const company = document.getElementById('companyFilter').value;
                const department = document.getElementById('departmentFilter').value;
                const subdepartment = document.getElementById('subdepartmentFilter').value;
                const brand = document.getElementById('brandFilter').value;
                const status = document.getElementById('statusFilter').value;
                const payment = document.getElementById('paymentFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (company) params.append('company', company);
                if (department) params.append('department', department);
                if (subdepartment) params.append('subdepartment', subdepartment);
                if (brand) params.append('brand', brand);
                if (status) params.append('status', status);
                if (payment) params.append('payment_status', payment);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                // Check if we need allocation data for any visible column
                const needsAllocationsForColumns = columnConfig.some(col =>
                    col.visible && (col.source.startsWith('allocation.') || col.source.startsWith('computed.'))
                );

                // ALWAYS fetch allocations - summary cards need them for correct value calculation
                // Even if no allocation columns are visible, we need allocation_value for totals
                params.append('include_allocations', 'true');
                const needsAllocations = true;

                const url = '/api/db/invoices' + (params.toString() ? '?' + params.toString() : '');
                const res = await fetch(url);
                allInvoices = await res.json();

                // If allocations were included, populate the cache
                if (needsAllocations) {
                    allInvoices.forEach(inv => {
                        invoicesWithAllocations[inv.id] = inv;
                    });
                }

                renderInvoicesTable(allInvoices);
                updateSummaryCards();
            } catch (e) {
                console.error('Error loading invoices:', e);
            }
        }

        async function loadCompanyFilter() {
            try {
                const res = await fetch('/api/companies');
                const companies = await res.json();
                const select = document.getElementById('companyFilter');
                select.innerHTML = '<option value="">All Companies</option>';
                companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading companies:', e);
            }
        }

        let departmentStructure = [];

        async function loadDepartmentFilter() {
            try {
                const res = await fetch('/api/structure');
                departmentStructure = await res.json();
                const select = document.getElementById('departmentFilter');
                select.innerHTML = '<option value="">All Departments</option>';
                // Get unique departments
                const departments = [...new Set(departmentStructure.map(s => s.department))].sort();
                departments.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading departments:', e);
            }
        }

        function updateSubdepartmentFilter() {
            const department = document.getElementById('departmentFilter').value;
            const select = document.getElementById('subdepartmentFilter');
            select.innerHTML = '<option value="">All Subdepartments</option>';

            if (department) {
                // Get subdepartments for selected department
                const subdepts = [...new Set(
                    departmentStructure
                        .filter(s => s.department === department && s.subdepartment)
                        .map(s => s.subdepartment)
                )].sort();
                subdepts.forEach(sd => {
                    const opt = document.createElement('option');
                    opt.value = sd;
                    opt.textContent = sd;
                    select.appendChild(opt);
                });
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('quickFilter').value = '';
            document.getElementById('companyFilter').value = '';
            document.getElementById('departmentFilter').value = '';
            document.getElementById('subdepartmentFilter').innerHTML = '<option value="">All Subdepartments</option>';
            document.getElementById('brandFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('paymentFilter').value = '';
            applyFiltersOnly();
        }

        async function loadBrandFilter() {
            try {
                const res = await fetch('/api/structure');
                const structure = await res.json();
                const select = document.getElementById('brandFilter');
                select.innerHTML = '<option value="">All Brands</option>';
                // Get unique brands
                const brands = [...new Set(structure.filter(s => s.brand).map(s => s.brand))].sort();
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading brands:', e);
            }
        }

        async function loadCompanySummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/company?${params}`);
                companyData = await res.json();
                renderCompanyTable(companyData);
            } catch (e) {
                console.error('Error loading company summary:', e);
            }
        }

        async function loadDepartmentSummary() {
            const company = document.getElementById('companyFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (company) params.append('company', company);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/department?${params}`);
                departmentData = await res.json();
                renderDepartmentTable(departmentData);
            } catch (e) {
                console.error('Error loading department summary:', e);
            }
        }

        async function loadBrandSummary() {
            const company = document.getElementById('companyFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (company) params.append('company', company);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/brand?${params}`);
                brandData = await res.json();
                renderBrandTable(brandData);
            } catch (e) {
                console.error('Error loading brand summary:', e);
            }
        }

        async function loadSupplierSummary() {
            const company = document.getElementById('companyFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const department = document.getElementById('departmentFilter').value;
            const subdepartment = document.getElementById('subdepartmentFilter').value;
            const brand = document.getElementById('brandFilter').value;
            const params = new URLSearchParams();
            if (company) params.append('company', company);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (subdepartment) params.append('subdepartment', subdepartment);
            if (brand) params.append('brand', brand);

            try {
                const res = await fetch(`/api/db/summary/supplier?${params}`);
                supplierData = await res.json();
                renderSupplierTable(supplierData);
            } catch (e) {
                console.error('Error loading supplier summary:', e);
            }
        }

        async function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                renderInvoicesTable(allInvoices);
                return;
            }

            try {
                // Build filter params to search within current filter criteria
                const params = new URLSearchParams();
                params.append('q', query);

                const company = document.getElementById('companyFilter').value;
                const department = document.getElementById('departmentFilter').value;
                const subdepartment = document.getElementById('subdepartmentFilter').value;
                const brand = document.getElementById('brandFilter').value;
                const status = document.getElementById('statusFilter').value;
                const payment = document.getElementById('paymentFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                if (company) params.append('company', company);
                if (department) params.append('department', department);
                if (subdepartment) params.append('subdepartment', subdepartment);
                if (brand) params.append('brand', brand);
                if (status) params.append('status', status);
                if (payment) params.append('payment_status', payment);
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);

                const res = await fetch(`/api/db/search?${params.toString()}`);
                const results = await res.json();
                renderInvoicesTable(results);
            } catch (e) {
                console.error('Error searching:', e);
            }
        }

        function getColumnValue(inv, col) {
            const fullInvoice = invoicesWithAllocations[inv.id] || inv;
            const firstAllocation = fullInvoice.allocations?.[0] || {};

            if (col.source.startsWith('invoice.')) {
                const field = col.source.replace('invoice.', '');
                return inv[field];
            } else if (col.source.startsWith('allocation.')) {
                const field = col.source.replace('allocation.', '');
                return firstAllocation[field];
            } else if (col.source.startsWith('computed.')) {
                const field = col.source.replace('computed.', '');
                const allocations = fullInvoice.allocations || [];
                switch (field) {
                    case 'allocation_count':
                        return allocations.length;
                    case 'companies_list':
                        return [...new Set(allocations.map(a => a.company))].join(', ');
                    case 'departments_list':
                        return [...new Set(allocations.map(a => a.department))].join(', ');
                    case 'split_values':
                        return allocations.map(a => ({
                            id: a.id,
                            company: a.company,
                            department: a.department,
                            subdepartment: a.subdepartment,
                            brand: a.brand,
                            percent: a.allocation_percent,
                            value: a.allocation_value,
                            reinvoice_to: a.reinvoice_to,
                            reinvoice_destinations: a.reinvoice_destinations || [],
                            comment: a.comment
                        }));
                    case 'reinvoice_list':
                        // Get allocations with reinvoice (new multi-destination or legacy single)
                        const reinvoiceAllocations = allocations
                            .filter(a => (a.reinvoice_destinations && a.reinvoice_destinations.length > 0) || a.reinvoice_to)
                            .map(a => ({
                                value: a.allocation_value,
                                percent: a.allocation_percent,
                                department: a.department,
                                brand: a.brand,
                                reinvoice_to: a.reinvoice_to,
                                reinvoice_department: a.reinvoice_department,
                                reinvoice_subdepartment: a.reinvoice_subdepartment,
                                reinvoice_destinations: a.reinvoice_destinations || []
                            }));
                        return reinvoiceAllocations.length > 0 ? reinvoiceAllocations : null;
                    default:
                        return '-';
                }
            }
            return '-';
        }

        function formatColumnValue(value, col, inv) {
            if (value === null || value === undefined) return '-';

            switch (col.format) {
                case 'currency':
                    return formatCurrencyWithSign(value, inv.currency || 'RON');
                case 'percent':
                    return value + '%';
                case 'date':
                    return formatDateRomanian(value) || '-';
                case 'status':
                    return getStatusDropdownHtml(inv.id, value);
                case 'payment_status':
                    return getPaymentStatusDropdownHtml(inv.id, value);
                case 'link':
                    return value ? `<a href="${value}" target="_blank">${value}</a>` : '-';
                case 'split':
                    if (Array.isArray(value) && value.length > 0) {
                        // Helper to get the correct value based on currency toggle
                        const getValueForCurrency = (s, cur) => {
                            if (cur === 'EUR' && s.value_eur !== undefined) return s.value_eur;
                            if (cur === 'RON' && s.value_ron !== undefined) return s.value_ron;
                            return s.value; // fallback to original value
                        };

                        // Helper to check if allocation has reinvoice destinations
                        const hasReinvoice = (s) => (s.reinvoice_destinations && s.reinvoice_destinations.length > 0) || s.reinvoice_to;

                        // Helper to format reinvoice display for an allocation
                        const formatReinvoiceDisplay = (s) => {
                            if (s.reinvoice_destinations && s.reinvoice_destinations.length > 0) {
                                // New multi-destination format
                                if (s.reinvoice_destinations.length === 1) {
                                    const dest = s.reinvoice_destinations[0];
                                    let destStr = dest.company;
                                    if (dest.department) destStr += ` / ${dest.department}`;
                                    return `<br><span class="text-warning"><i class="bi bi-arrow-right"></i> ${destStr} (${dest.percentage}%)</span>`;
                                }
                                // Multiple destinations - show count
                                const totalPct = s.reinvoice_destinations.reduce((sum, d) => sum + d.percentage, 0);
                                return `<br><span class="text-warning"><i class="bi bi-arrow-right"></i> ${s.reinvoice_destinations.length} destinations (${totalPct.toFixed(0)}%)</span>`;
                            } else if (s.reinvoice_to) {
                                // Legacy single destination
                                return `<br><span class="text-warning"><i class="bi bi-arrow-right"></i> ${s.reinvoice_to}</span>`;
                            }
                            return '';
                        };

                        // Determine currency to use (toggle currency takes precedence)
                        const displayCurrency = inv.useCurrency || inv.currency || 'RON';

                        // Single allocation - show inline (no collapse)
                        if (value.length === 1) {
                            const s = value[0];
                            const displayValue = getValueForCurrency(s, displayCurrency);
                            const location = s.subdepartment || s.department;
                            const brandPart = s.brand ? ` (${s.brand})` : '';
                            const borderColor = hasReinvoice(s) ? 'border-warning' : 'border-primary';
                            const reinvoiceLine = formatReinvoiceDisplay(s);
                            const commentIcon = s.id ? `<a href="#" class="allocation-comment-btn ms-1 ${s.comment ? 'text-info' : 'text-muted'}" data-allocation-id="${s.id}" data-department="${location}" data-brand="${s.brand || ''}" data-value="${displayValue}" data-percent="${s.percent}" data-comment="${(s.comment || '').replace(/"/g, '&quot;')}" title="${s.comment ? 'View/Edit comment' : 'Add comment'}"><i class="bi bi-chat-text${s.comment ? '-fill' : ''}"></i></a>` : '';
                            return `<div class="small border-start ${borderColor} ps-2">
                                <span class="text-muted">${location}${brandPart}</span>${commentIcon}<br>
                                <strong>${formatCurrency(displayValue)} ${displayCurrency}</strong>
                                <span class="badge bg-secondary">${s.percent}%</span>${reinvoiceLine}
                            </div>`;
                        }

                        // Multiple allocations - collapsible
                        const collapseId = 'split-' + Math.random().toString(36).substr(2, 9);

                        // Calculate summary using correct currency values
                        const totalValue = value.reduce((sum, s) => sum + getValueForCurrency(s, displayCurrency), 0);
                        const reinvoicedAllocs = value.filter(s => hasReinvoice(s));
                        const allocsWithComments = value.filter(s => s.comment);

                        // Build summary text
                        const currency = displayCurrency;
                        let summaryText = `${value.length} allocations  ${formatCurrency(totalValue)} ${currency}`;
                        if (reinvoicedAllocs.length > 0) {
                            summaryText += ` <span class="text-warning">()</span>`;
                        }
                        if (allocsWithComments.length > 0) {
                            summaryText += ` <span class="text-info"><i class="bi bi-chat-text-fill"></i></span>`;
                        }

                        // Build allocation details
                        const allocDetails = value.map(s => {
                            const displayValue = getValueForCurrency(s, displayCurrency);
                            const location = s.subdepartment || s.department;
                            const brandPart = s.brand ? ` (${s.brand})` : '';
                            const borderColor = hasReinvoice(s) ? 'border-warning' : 'border-primary';
                            const reinvoiceLine = formatReinvoiceDisplay(s);
                            const commentIcon = s.id ? `<a href="#" class="allocation-comment-btn ms-1 ${s.comment ? 'text-info' : 'text-muted'}" data-allocation-id="${s.id}" data-department="${location}" data-brand="${s.brand || ''}" data-value="${displayValue}" data-percent="${s.percent}" data-comment="${(s.comment || '').replace(/"/g, '&quot;')}" title="${s.comment ? 'View/Edit comment' : 'Add comment'}"><i class="bi bi-chat-text${s.comment ? '-fill' : ''}"></i></a>` : '';
                            return `<div class="small border-start ${borderColor} ps-2 mb-1">
                                <span class="text-muted">${location}${brandPart}</span>${commentIcon}<br>
                                <strong>${formatCurrency(displayValue)} ${currency}</strong>
                                <span class="badge bg-secondary">${s.percent}%</span>${reinvoiceLine}
                            </div>`;
                        }).join('');

                        return `<div>
                            <a class="text-primary small text-decoration-none" data-bs-toggle="collapse" href="#${collapseId}" role="button" aria-expanded="false">
                                <i class="bi bi-plus-circle toggle-icon"></i> ${summaryText}
                            </a>
                            <div class="collapse" id="${collapseId}">
                                <div class="mt-1">${allocDetails}</div>
                            </div>
                        </div>`;
                    }
                    return '-';
                case 'reinvoice':
                    if (Array.isArray(value) && value.length > 0) {
                        // Helper to format a single reinvoice_destination
                        const formatMultiDest = (dest) => {
                            let str = dest.company;
                            if (dest.brand) str += ` (${dest.brand})`;
                            if (dest.department) str += ` / ${dest.department}`;
                            if (dest.subdepartment) str += ` / ${dest.subdepartment}`;
                            return `${str} <span class="badge bg-warning text-dark">${dest.percentage}%</span>`;
                        };

                        // Helper to format legacy single destination
                        const formatLegacyDest = (r) => {
                            let dest = r.reinvoice_to || '-';
                            if (r.reinvoice_department) {
                                dest += ` / ${r.reinvoice_department}`;
                                if (r.reinvoice_subdepartment) {
                                    dest += ` / ${r.reinvoice_subdepartment}`;
                                }
                            }
                            return dest;
                        };

                        // Helper to render all destinations for an allocation
                        const renderDestinations = (r) => {
                            if (r.reinvoice_destinations && r.reinvoice_destinations.length > 0) {
                                return r.reinvoice_destinations.map(dest =>
                                    `<span class="text-warning"><i class="bi bi-arrow-right"></i> ${formatMultiDest(dest)}</span>`
                                ).join('<br>');
                            } else if (r.reinvoice_to) {
                                return `<span class="text-warning"><i class="bi bi-arrow-right"></i> ${formatLegacyDest(r)}</span>`;
                            }
                            return '';
                        };

                        const reinvCurrency = inv.currency || 'RON';

                        // Single allocation - show inline
                        if (value.length === 1) {
                            const r = value[0];
                            return `<div class="small border-start border-warning ps-2">
                                <span class="text-muted">${r.department}${r.brand ? ' (' + r.brand + ')' : ''}</span><br>
                                <strong>${formatCurrency(r.value)} ${reinvCurrency}</strong>
                                <span class="badge bg-secondary">${r.percent}%</span><br>
                                ${renderDestinations(r)}
                            </div>`;
                        }

                        // Multiple allocations - collapsible
                        const reinvCollapseId = `reinv-collapse-${inv.id}-${col.id}`;
                        const totalReinvoiceValue = value.reduce((sum, r) => sum + r.value, 0);
                        const summaryText = `${value.length} reinvoices  ${formatCurrency(totalReinvoiceValue)} ${reinvCurrency}`;

                        const reinvoiceDetails = value.map(r =>
                            `<div class="small border-start border-warning ps-2 mb-1">
                                <span class="text-muted">${r.department}${r.brand ? ' (' + r.brand + ')' : ''}</span><br>
                                <strong>${formatCurrency(r.value)} ${reinvCurrency}</strong>
                                <span class="badge bg-secondary">${r.percent}%</span><br>
                                ${renderDestinations(r)}
                            </div>`
                        ).join('');

                        return `<div>
                            <a class="text-warning small text-decoration-none" data-bs-toggle="collapse" href="#${reinvCollapseId}" role="button" aria-expanded="false">
                                <i class="bi bi-plus-circle toggle-icon"></i> ${summaryText}
                            </a>
                            <div class="collapse" id="${reinvCollapseId}">
                                <div class="mt-1">${reinvoiceDetails}</div>
                            </div>
                        </div>`;
                    }
                    return '-';
                case 'special':
                    if (col.source === 'special.actions') {
                        return `<div class="d-flex">
                            <button class="btn btn-sm btn-outline-primary" onclick="showInvoiceDetail(${inv.id})" title="View Details" aria-label="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>`;
                    } else if (col.source === 'special.drive') {
                        if (inv.drive_link) {
                            return `<div class="d-flex">
                                <a href="${inv.drive_link}" target="_blank" class="btn btn-sm btn-outline-success" title="Open in Google Drive" aria-label="Open in Google Drive">
                                    <i class="bi bi-cloud-arrow-down"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-secondary ms-1" onclick="openDriveFolder('${inv.drive_link.replace(/'/g, "\\'")}')" title="Open folder in Drive" aria-label="Open folder in Drive">
                                    <i class="bi bi-folder"></i>
                                </button>
                            </div>`;
                        } else {
                            return `<span class="btn btn-sm btn-outline-secondary disabled" title="No file uploaded">
                                <i class="bi bi-cloud"></i>
                            </span>`;
                        }
                    }
                    return '-';
                default:
                    if (col.id === 'supplier') return `<strong>${value}</strong>`;
                    if (col.id === 'invoice_number') return `<code>${value}</code>`;
                    return value;
            }
        }

        function renderInvoicesTable(invoices) {
            const thead = document.getElementById('invoicesTableHead').querySelector('tr');
            const tbody = document.getElementById('invoicesTable');
            const visibleCols = columnConfig.filter(c => c.visible);

            // Render header with select all checkbox for select column and sort arrows for Date
            const sortOrder = document.getElementById('sortOrder').value;
            thead.innerHTML = visibleCols.map(col => {
                if (col.id === 'select') {
                    const allSelected = invoices.length > 0 && invoices.every(inv => selectedInvoices.has(inv.id));
                    return `<th><input type="checkbox" class="select-checkbox" id="selectAll" onchange="toggleSelectAll(this)" ${allSelected ? 'checked' : ''}></th>`;
                }
                // Add sort arrow for Date column (single arrow that flips)
                if (col.id === 'date') {
                    const isDateSort = sortOrder === 'newest' || sortOrder === 'oldest';
                    const arrowIcon = sortOrder === 'newest' ? 'bi-caret-down-fill' : 'bi-caret-up-fill';
                    const arrowClass = isDateSort ? 'text-primary' : 'text-muted';
                    return `<th style="cursor: pointer; white-space: nowrap;" onclick="toggleDateSort()">
                        ${col.name}
                        <i class="bi ${arrowIcon} ${arrowClass} ms-1" style="font-size: 0.7rem;"></i>
                    </th>`;
                }
                // Add sort arrow for Value and Net Value columns
                if (col.id === 'value' || col.id === 'net_value') {
                    const isValueSort = sortOrder === 'value_highest' || sortOrder === 'value_lowest';
                    const arrowIcon = sortOrder === 'value_highest' ? 'bi-caret-down-fill' : 'bi-caret-up-fill';
                    const arrowClass = isValueSort ? 'text-primary' : 'text-muted';
                    return `<th style="cursor: pointer; white-space: nowrap;" onclick="toggleValueSort()">
                        ${col.name}
                        <i class="bi ${arrowIcon} ${arrowClass} ms-1" style="font-size: 0.7rem;"></i>
                    </th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            // Calculate pagination
            const totalItems = invoices.length;
            const effectivePageSize = pageSize === 0 ? totalItems : pageSize;

            // Update result count badge
            const countBadge = document.getElementById('invoiceResultCount');
            countBadge.textContent = totalItems === allInvoices.length ? totalItems + ' invoices' : totalItems + ' of ' + allInvoices.length + ' invoices';
            const totalPages = Math.ceil(totalItems / effectivePageSize) || 1;

            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const startIndex = (currentPage - 1) * effectivePageSize;
            const endIndex = pageSize === 0 ? totalItems : Math.min(startIndex + effectivePageSize, totalItems);
            const paginatedInvoices = invoices.slice(startIndex, endIndex);

            if (invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No invoices found</td></tr>`;
                updatePaginationUI(0, 0, 0, 1);
                return;
            }

            tbody.innerHTML = paginatedInvoices.map(inv => {
                const cells = visibleCols.map(col => {
                    if (col.id === 'select') {
                        const checked = selectedInvoices.has(inv.id) ? 'checked' : '';
                        return `<td><input type="checkbox" class="select-checkbox" data-id="${inv.id}" onchange="toggleInvoiceSelect(${inv.id})" ${checked}></td>`;
                    }
                    const value = getColumnValue(inv, col);
                    const formatted = formatColumnValue(value, col, inv);
                    return `<td>${formatted}</td>`;
                }).join('');
                // Row color applied via CSS using data-status attribute (see theme.css)
                return `<tr data-status="${inv.status || ''}">${cells}</tr>`;
            }).join('');

            // Update pagination UI
            updatePaginationUI(startIndex + 1, endIndex, totalItems, totalPages);

            // Update selection UI
            updateSelectionUI();
        }

        function updatePaginationUI(start, end, total, totalPages) {
            const infoEl = document.getElementById('paginationInfo');
            const prevItem = document.getElementById('prevPageItem');
            const nextItem = document.getElementById('nextPageItem');
            const pageSizeSelect = document.getElementById('pageSize');

            // Update info text
            if (total === 0) {
                infoEl.textContent = 'No invoices';
            } else if (pageSize === 0) {
                infoEl.textContent = `Showing all ${total} invoices`;
            } else {
                infoEl.textContent = `Showing ${start}-${end} of ${total}`;
            }

            // Update prev/next buttons
            prevItem.classList.toggle('disabled', currentPage <= 1);
            nextItem.classList.toggle('disabled', currentPage >= totalPages);

            // Sync page size dropdown with state
            pageSizeSelect.value = pageSize.toString();
        }

        function goToPage(page) {
            const totalItems = allInvoices.length;
            const effectivePageSize = pageSize === 0 ? totalItems : pageSize;
            const totalPages = Math.ceil(totalItems / effectivePageSize) || 1;

            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderInvoicesTable(allInvoices);
        }

        function changePageSize() {
            const newSize = parseInt(document.getElementById('pageSize').value);
            pageSize = newSize;
            localStorage.setItem('accountingPageSize', newSize.toString());
            currentPage = 1; // Reset to first page
            renderInvoicesTable(allInvoices);
        }

        function renderCompanyTable(data) {
            const thead = document.getElementById('companyTableHead').querySelector('tr');
            const tbody = document.getElementById('companyTable');
            const visibleCols = companyColumnConfig.filter(c => c.visible);
            const currency = companyCurrency;

            // Render header with currency indicator for value columns
            thead.innerHTML = visibleCols.map(col => {
                if (col.format === 'currency') {
                    return `<th>${col.name} (${currency})</th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            // Calculate totals
            let totalValueSum = 0;
            let totalInvoices = 0;
            data.forEach(row => {
                totalValueSum += currency === 'EUR' ? (row.total_value_eur || 0) : (row.total_value_ron || 0);
                totalInvoices += row.invoice_count || 0;
            });

            tbody.innerHTML = data.map(row => {
                // Use RON or EUR value based on toggle
                const totalValue = currency === 'EUR' ? row.total_value_eur : row.total_value_ron;
                // Add computed avg_value based on selected currency
                const avgValue = totalValue / row.invoice_count;

                const cells = visibleCols.map(col => {
                    if (col.id === 'total_value') {
                        return `<td>${formatCurrency(totalValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_value') {
                        return `<td>${formatCurrency(avgValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_exchange_rate') {
                        return `<td>${row.avg_exchange_rate ? row.avg_exchange_rate.toFixed(4) : '-'}</td>`;
                    } else if (col.id === 'company') {
                        return `<td><strong>${row.company}</strong></td>`;
                    }
                    return `<td>${row[col.source] || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            // Calculate weighted average exchange rate
            let totalWeightedRate = 0;
            data.forEach(row => {
                totalWeightedRate += (row.avg_exchange_rate || 0) * (row.invoice_count || 0);
            });
            const avgExchangeRate = totalInvoices > 0 ? totalWeightedRate / totalInvoices : 0;

            // Add summary row
            const summaryRow = visibleCols.map(col => {
                if (col.id === 'company') {
                    return `<td><strong>TOTAL (${data.length} companies)</strong></td>`;
                } else if (col.id === 'total_value') {
                    return `<td><strong>${formatCurrency(totalValueSum)} ${currency}</strong></td>`;
                } else if (col.id === 'invoice_count') {
                    return `<td><strong>${totalInvoices}</strong></td>`;
                } else if (col.id === 'avg_value') {
                    return `<td><strong>${totalInvoices > 0 ? formatCurrency(totalValueSum / totalInvoices) : '-'} ${currency}</strong></td>`;
                } else if (col.id === 'avg_exchange_rate') {
                    return `<td><strong>${avgExchangeRate > 0 ? avgExchangeRate.toFixed(4) : '-'}</strong></td>`;
                }
                return `<td></td>`;
            }).join('');
            tbody.innerHTML += `<tr class="table-info" style="font-weight: bold; border-top: 2px solid #000;">${summaryRow}</tr>`;
        }

        function renderDepartmentTable(data) {
            const thead = document.getElementById('departmentTableHead').querySelector('tr');
            const tbody = document.getElementById('departmentTable');
            const visibleCols = departmentColumnConfig.filter(c => c.visible);
            const currency = departmentCurrency;

            // Render header with currency indicator for value columns
            thead.innerHTML = visibleCols.map(col => {
                if (col.format === 'currency') {
                    return `<th>${col.name} (${currency})</th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            // Calculate totals
            let totalValueSum = 0;
            let totalInvoices = 0;
            data.forEach(row => {
                totalValueSum += currency === 'EUR' ? (row.total_value_eur || 0) : (row.total_value_ron || 0);
                totalInvoices += row.invoice_count || 0;
            });

            tbody.innerHTML = data.map(row => {
                // Use RON or EUR value based on toggle
                const totalValue = currency === 'EUR' ? row.total_value_eur : row.total_value_ron;
                // Add computed avg_value based on selected currency
                const avgValue = totalValue / row.invoice_count;

                const cells = visibleCols.map(col => {
                    if (col.id === 'total_value') {
                        return `<td>${formatCurrency(totalValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_value') {
                        return `<td>${formatCurrency(avgValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_exchange_rate') {
                        return `<td>${row.avg_exchange_rate ? row.avg_exchange_rate.toFixed(4) : '-'}</td>`;
                    } else if (col.id === 'department') {
                        return `<td><strong>${row[col.source]}</strong></td>`;
                    }
                    return `<td>${row[col.source] || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            // Calculate weighted average exchange rate
            let totalWeightedRate = 0;
            data.forEach(row => {
                totalWeightedRate += (row.avg_exchange_rate || 0) * (row.invoice_count || 0);
            });
            const avgExchangeRate = totalInvoices > 0 ? totalWeightedRate / totalInvoices : 0;

            // Add summary row
            const summaryRow = visibleCols.map(col => {
                if (col.id === 'department') {
                    return `<td><strong>TOTAL (${data.length} departments)</strong></td>`;
                } else if (col.id === 'total_value') {
                    return `<td><strong>${formatCurrency(totalValueSum)} ${currency}</strong></td>`;
                } else if (col.id === 'invoice_count') {
                    return `<td><strong>${totalInvoices}</strong></td>`;
                } else if (col.id === 'avg_value') {
                    return `<td><strong>${totalInvoices > 0 ? formatCurrency(totalValueSum / totalInvoices) : '-'} ${currency}</strong></td>`;
                } else if (col.id === 'avg_exchange_rate') {
                    return `<td><strong>${avgExchangeRate > 0 ? avgExchangeRate.toFixed(4) : '-'}</strong></td>`;
                }
                return `<td></td>`;
            }).join('');
            tbody.innerHTML += `<tr class="table-info" style="font-weight: bold; border-top: 2px solid #000;">${summaryRow}</tr>`;
        }

        function renderBrandTable(data) {
            const thead = document.getElementById('brandTableHead').querySelector('tr');
            const tbody = document.getElementById('brandTable');
            const visibleCols = brandColumnConfig.filter(c => c.visible);
            const currency = brandCurrency;

            // Render header with currency indicator for value columns
            thead.innerHTML = visibleCols.map(col => {
                if (col.format === 'currency') {
                    return `<th>${col.name} (${currency})</th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            // Calculate totals
            let totalValueSum = 0;
            let totalInvoices = 0;
            data.forEach(row => {
                totalValueSum += currency === 'EUR' ? (row.total_value_eur || 0) : (row.total_value_ron || 0);
                totalInvoices += row.invoice_count || 0;
            });

            tbody.innerHTML = data.map(row => {
                // Use RON or EUR value based on toggle
                const totalValue = currency === 'EUR' ? row.total_value_eur : row.total_value_ron;
                // Add computed avg_value based on selected currency
                const avgValue = totalValue / row.invoice_count;

                const cells = visibleCols.map(col => {
                    if (col.id === 'total_value') {
                        return `<td>${formatCurrency(totalValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_value') {
                        return `<td>${formatCurrency(avgValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_exchange_rate') {
                        return `<td>${row.avg_exchange_rate ? row.avg_exchange_rate.toFixed(4) : '-'}</td>`;
                    } else if (col.id === 'brand') {
                        return `<td><strong>${row[col.source] || '(No Brand)'}</strong></td>`;
                    } else if (col.format === 'split') {
                        // Use the same split formatting as the Invoices table, pass selected currency
                        return `<td>${formatColumnValue(row[col.source], col, {currency: currency, useCurrency: currency})}</td>`;
                    }
                    return `<td>${row[col.source] || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            // Calculate weighted average exchange rate
            let totalWeightedRate = 0;
            data.forEach(row => {
                totalWeightedRate += (row.avg_exchange_rate || 0) * (row.invoice_count || 0);
            });
            const avgExchangeRate = totalInvoices > 0 ? totalWeightedRate / totalInvoices : 0;

            // Add summary row
            const summaryRow = visibleCols.map(col => {
                if (col.id === 'brand') {
                    return `<td><strong>TOTAL (${data.length} brands)</strong></td>`;
                } else if (col.id === 'total_value') {
                    return `<td><strong>${formatCurrency(totalValueSum)} ${currency}</strong></td>`;
                } else if (col.id === 'invoice_count') {
                    return `<td><strong>${totalInvoices}</strong></td>`;
                } else if (col.id === 'avg_value') {
                    return `<td><strong>${totalInvoices > 0 ? formatCurrency(totalValueSum / totalInvoices) : '-'} ${currency}</strong></td>`;
                } else if (col.id === 'avg_exchange_rate') {
                    return `<td><strong>${avgExchangeRate > 0 ? avgExchangeRate.toFixed(4) : '-'}</strong></td>`;
                }
                return `<td></td>`;
            }).join('');
            tbody.innerHTML += `<tr class="table-info" style="font-weight: bold; border-top: 2px solid #000;">${summaryRow}</tr>`;
        }

        function renderSupplierTable(data) {
            const thead = document.getElementById('supplierTableHead').querySelector('tr');
            const tbody = document.getElementById('supplierTable');
            const visibleCols = supplierColumnConfig.filter(c => c.visible);
            const currency = supplierCurrency;

            // Render header with currency indicator for value columns
            thead.innerHTML = visibleCols.map(col => {
                if (col.format === 'currency') {
                    return `<th>${col.name} (${currency})</th>`;
                }
                return `<th>${col.name}</th>`;
            }).join('');

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${visibleCols.length}" class="text-center text-muted">No data</td></tr>`;
                return;
            }

            // Calculate totals
            let totalValueSum = 0;
            let totalInvoices = 0;
            data.forEach(row => {
                totalValueSum += currency === 'EUR' ? (row.total_value_eur || 0) : (row.total_value_ron || 0);
                totalInvoices += row.invoice_count || 0;
            });

            tbody.innerHTML = data.map(row => {
                // Use RON or EUR value based on toggle
                const totalValue = currency === 'EUR' ? row.total_value_eur : row.total_value_ron;
                // Add computed avg_value based on selected currency
                const avgValue = totalValue / row.invoice_count;

                const cells = visibleCols.map(col => {
                    if (col.id === 'total_value') {
                        return `<td>${formatCurrency(totalValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_value') {
                        return `<td>${formatCurrency(avgValue)} ${currency}</td>`;
                    } else if (col.id === 'avg_exchange_rate') {
                        return `<td>${row.avg_exchange_rate ? row.avg_exchange_rate.toFixed(4) : '-'}</td>`;
                    } else if (col.id === 'supplier') {
                        return `<td><strong>${row[col.source] || '(Unknown)'}</strong></td>`;
                    }
                    return `<td>${row[col.source] || '-'}</td>`;
                }).join('');
                return `<tr>${cells}</tr>`;
            }).join('');

            // Calculate weighted average exchange rate
            let totalWeightedRate = 0;
            data.forEach(row => {
                totalWeightedRate += (row.avg_exchange_rate || 0) * (row.invoice_count || 0);
            });
            const avgExchangeRate = totalInvoices > 0 ? totalWeightedRate / totalInvoices : 0;

            // Add summary row
            const summaryRow = visibleCols.map(col => {
                if (col.id === 'supplier') {
                    return `<td><strong>TOTAL (${data.length} suppliers)</strong></td>`;
                } else if (col.id === 'total_value') {
                    return `<td><strong>${formatCurrency(totalValueSum)} ${currency}</strong></td>`;
                } else if (col.id === 'invoice_count') {
                    return `<td><strong>${totalInvoices}</strong></td>`;
                } else if (col.id === 'avg_value') {
                    return `<td><strong>${totalInvoices > 0 ? formatCurrency(totalValueSum / totalInvoices) : '-'} ${currency}</strong></td>`;
                } else if (col.id === 'avg_exchange_rate') {
                    return `<td><strong>${avgExchangeRate > 0 ? avgExchangeRate.toFixed(4) : '-'}</strong></td>`;
                }
                return `<td></td>`;
            }).join('');
            tbody.innerHTML += `<tr class="table-info" style="font-weight: bold; border-top: 2px solid #000;">${summaryRow}</tr>`;
        }

        async function openDriveFolder(driveLink) {
            try {
                const res = await fetch(`/api/drive/folder-link?drive_link=${encodeURIComponent(driveLink)}`);
                const data = await res.json();
                if (data.success && data.folder_link) {
                    window.open(data.folder_link, '_blank');
                } else {
                    await JarvisDialog.alert('Could not find folder for this file', { type: 'warning', title: 'Not Found' });
                }
            } catch (err) {
                console.error('Error fetching folder link:', err);
                await JarvisDialog.alert('Error fetching folder link', { type: 'error', title: 'Error' });
            }
        }

        async function updateInvoiceStatus(invoiceId, newStatus) {
            try {
                const res = await fetch(`/api/db/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await res.json();
                if (!result.success && result.error) {
                    console.error('Failed to update status:', result.error);
                    await JarvisDialog.alert('Error updating status: ' + result.error, { type: 'error', title: 'Error' });
                    return;
                }
                // Update local cache
                if (invoicesWithAllocations[invoiceId]) {
                    invoicesWithAllocations[invoiceId].status = newStatus;
                }
                // Update allInvoices array as well
                const invInList = allInvoices.find(i => i.id === invoiceId);
                if (invInList) {
                    invInList.status = newStatus;
                }
                // Update row status attribute (CSS handles color via theme.css)
                const dropdown = document.querySelector(`select.status-dropdown[data-invoice-id="${invoiceId}"]`);
                if (dropdown) {
                    const row = dropdown.closest('tr');
                    if (row) {
                        row.setAttribute('data-status', newStatus);
                    }
                }
            } catch (e) {
                console.error('Error updating status:', e);
                await JarvisDialog.alert('Error updating status', { type: 'error', title: 'Error' });
            }
        }

        async function updatePaymentStatus(invoiceId, newStatus) {
            try {
                const res = await fetch(`/api/db/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_status: newStatus })
                });
                const result = await res.json();
                if (!result.success && result.error) {
                    console.error('Failed to update payment status:', result.error);
                    await JarvisDialog.alert('Error updating payment status: ' + result.error, { type: 'error', title: 'Error' });
                    return;
                }
                // Update local cache
                if (invoicesWithAllocations[invoiceId]) {
                    invoicesWithAllocations[invoiceId].payment_status = newStatus;
                }
                // Update allInvoices array as well
                const invInList = allInvoices.find(i => i.id === invoiceId);
                if (invInList) {
                    invInList.payment_status = newStatus;
                }
                // Update dropdown color styling
                const dropdown = document.querySelector(`select.payment-status-dropdown[data-invoice-id="${invoiceId}"]`);
                if (dropdown) {
                    dropdown.setAttribute('data-payment-status', newStatus);
                    const newOpt = paymentStatusOptions.find(o => o.value === newStatus);
                    if (newOpt?.color) {
                        dropdown.style.backgroundColor = `var(--payment-color-${newStatus}, ${newOpt.color})`;
                        dropdown.style.color = '#fff';
                        dropdown.style.fontWeight = '500';
                    } else {
                        dropdown.style.backgroundColor = '';
                        dropdown.style.color = '';
                        dropdown.style.fontWeight = '';
                    }
                }
            } catch (e) {
                console.error('Error updating payment status:', e);
                await JarvisDialog.alert('Error updating payment status', { type: 'error', title: 'Error' });
            }
        }

        async function showInvoiceDetail(id) {
            currentInvoiceId = id;
            const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
            const body = document.getElementById('invoiceModalBody');
            body.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
            modal.show();

            try {
                const res = await fetch(`/api/db/invoices/${id}`);
                const invoice = await res.json();

                // Cache full invoice data
                invoicesWithAllocations[id] = invoice;

                const statusDropdown = getModalStatusDropdownHtml(invoice.id, invoice.status);
                const paymentStatusDropdown = getModalPaymentStatusDropdownHtml(invoice.id, invoice.payment_status);

                const driveButtons = invoice.drive_link
                    ? `<a href="${invoice.drive_link}" target="_blank" class="btn btn-sm btn-outline-success me-1"><i class="bi bi-cloud"></i> View on Drive</a><button type="button" class="btn btn-sm btn-outline-secondary" onclick="openDriveFolder('${invoice.drive_link}')" title="Open Folder"><i class="bi bi-folder2-open"></i></button>`
                    : '<span class="text-muted">Not uploaded</span>';

                body.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Invoice Information</h6>
                            <table class="table table-sm">
                                <tr><th>Status</th><td>${statusDropdown}</td></tr>
                                <tr><th>Payment</th><td>${paymentStatusDropdown}</td></tr>
                                <tr><th>Supplier</th><td>${invoice.supplier}</td></tr>
                                <tr><th>Invoice #</th><td><code>${invoice.invoice_number}</code></td></tr>
                                <tr><th>Date</th><td>${formatDateRomanian(invoice.invoice_date)}</td></tr>
                                <tr><th>Total Value</th><td><strong>${formatCurrency(invoice.invoice_value)} ${invoice.currency || 'RON'}</strong></td></tr>
                                ${invoice.subtract_vat && invoice.net_value ? `
                                <tr><th>VAT (${invoice.vat_rate ? invoice.vat_rate + '%' : ''})</th><td>${formatCurrency(invoice.invoice_value - invoice.net_value)} ${invoice.currency || 'RON'}</td></tr>
                                <tr><th>Net Value (excl. VAT)</th><td><strong>${formatCurrency(invoice.net_value)} ${invoice.currency || 'RON'}</strong></td></tr>` : ''}
                                <tr><th>Created</th><td>${invoice.created_at}</td></tr>
                                ${invoice.comment ? `<tr><th>Notes</th><td><em>${invoice.comment}</em></td></tr>` : ''}
                                <tr><th>Invoice File</th><td>${driveButtons}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Cost Allocations</h6>
                            ${invoice.allocations.map(a => `
                                <div class="allocation-row">
                                    <div class="d-flex justify-content-between">
                                        <strong>${a.company}</strong>
                                        <span class="badge bg-primary">${a.allocation_percent}%</span>
                                    </div>
                                    <div class="small text-muted">
                                        ${a.department}${a.subdepartment ? ' > ' + a.subdepartment : ''}
                                        ${a.brand ? ' (' + a.brand + ')' : ''}
                                    </div>
                                    <div class="fw-bold text-success">${formatCurrency(a.allocation_value)} ${invoice.currency || 'RON'}</div>
                                    <div class="small">Responsible: ${a.responsible || '-'}</div>
                                    ${(a.reinvoice_destinations && a.reinvoice_destinations.length > 0) ?
                                        a.reinvoice_destinations.map(rd => `<div class="small text-warning"><i class="bi bi-arrow-right"></i> Reinvoice to: ${rd.company}${rd.brand ? ' (' + rd.brand + ')' : ''}${rd.department ? ' / ' + rd.department : ''}${rd.subdepartment ? ' / ' + rd.subdepartment : ''} <span class="badge bg-warning text-dark">${rd.percentage}%</span></div>`).join('')
                                        : (a.reinvoice_to ? `<div class="small text-warning"><i class="bi bi-arrow-right"></i> Reinvoice to: ${a.reinvoice_to}${a.reinvoice_brand ? ' (' + a.reinvoice_brand + ')' : ''}${a.reinvoice_department ? ' / ' + a.reinvoice_department : ''}${a.reinvoice_subdepartment ? ' / ' + a.reinvoice_subdepartment : ''}</div>` : '')}
                                </div>
                            `).join('')}
                            <div class="border-top mt-3 pt-2">
                                <div class="d-flex justify-content-between fw-bold">
                                    <span>Total (${invoice.allocations.length} allocation${invoice.allocations.length !== 1 ? 's' : ''})${invoice.subtract_vat ? ' <small class="text-muted fw-normal">excl. VAT</small>' : ''}</span>
                                    <span class="text-success">${formatCurrency(invoice.allocations.reduce((sum, a) => sum + (a.allocation_value || 0), 0))} ${invoice.currency || 'RON'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                body.innerHTML = '<div class="alert alert-danger">Error loading invoice details</div>';
            }
        }

        async function handleDelete() {
            if (!currentInvoiceId) return;
            const confirmed = await JarvisDialog.confirm('Are you sure you want to delete this invoice? This action cannot be undone.', { title: 'Delete Invoice', danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/api/db/invoices/${currentInvoiceId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
                    delete invoicesWithAllocations[currentInvoiceId];
                    loadData();
                } else {
                    await JarvisDialog.alert('Error deleting invoice', { type: 'error', title: 'Error' });
                }
            } catch (e) {
                await JarvisDialog.alert('Error: ' + e.message, { type: 'error', title: 'Error' });
            }
        }

        async function openEditModal() {
            if (!currentInvoiceId) return;

            const invoice = invoicesWithAllocations[currentInvoiceId];
            if (!invoice) return;

            // Load organizational structure if not cached
            if (organizationalStructure.length === 0) {
                try {
                    const res = await fetch('/api/structure');
                    organizationalStructure = await res.json();
                } catch (e) {
                    console.error('Error loading structure:', e);
                }
            }

            // Populate the edit form
            document.getElementById('editInvoiceId').value = invoice.id;
            document.getElementById('editSupplier').value = invoice.supplier || '';
            document.getElementById('editInvoiceNumber').value = invoice.invoice_number || '';
            document.getElementById('editInvoiceDate').value = invoice.invoice_date || '';
            document.getElementById('editInvoiceValue').value = invoice.invoice_value || '';
            document.getElementById('editCurrency').value = invoice.currency || 'RON';
            document.getElementById('editDriveLink').value = invoice.drive_link || '';
            document.getElementById('editComment').value = invoice.comment || '';
            document.getElementById('editStatus').value = invoice.status || 'new';
            document.getElementById('editPaymentStatus').value = invoice.payment_status || 'not_paid';

            // Initialize VAT subtraction fields
            await loadEditVatRates();
            const subtractVatCheckbox = document.getElementById('editSubtractVat');
            const vatRateSelect = document.getElementById('editVatRateId');
            const netValueDisplay = document.getElementById('editNetValueDisplay');
            const netValueHidden = document.getElementById('editNetValue');
            const vatRateCol = document.getElementById('editVatRateCol');
            const netValueCol = document.getElementById('editNetValueCol');

            subtractVatCheckbox.checked = invoice.subtract_vat || false;
            if (invoice.subtract_vat) {
                vatRateCol.style.display = '';
                netValueCol.style.display = '';
                if (invoice.vat_rate) {
                    // Find matching VAT rate option by rate value
                    for (let opt of vatRateSelect.options) {
                        if (opt.dataset.rate == invoice.vat_rate) {
                            vatRateSelect.value = opt.value;
                            break;
                        }
                    }
                }
                if (invoice.net_value) {
                    netValueHidden.value = invoice.net_value;
                    netValueDisplay.value = formatNumber(invoice.net_value) + ' ' + (invoice.currency || 'RON');
                }
            } else {
                vatRateCol.style.display = 'none';
                netValueCol.style.display = 'none';
                vatRateSelect.value = '';
                netValueHidden.value = '';
                netValueDisplay.value = '';
            }

            // Populate dedicated company dropdown
            const companies = getUniqueCompanies();
            const dedicatedCompanySelect = document.getElementById('editDedicatedCompany');
            dedicatedCompanySelect.innerHTML = '<option value="">Select company...</option>' +
                companies.map(c => `<option value="${c}">${c}</option>`).join('');

            // Set dedicated company from first allocation (all should be same company)
            const firstAllocationCompany = invoice.allocations && invoice.allocations.length > 0
                ? invoice.allocations[0].company
                : '';
            dedicatedCompanySelect.value = firstAllocationCompany;

            // Add change event listener for dedicated company
            dedicatedCompanySelect.onchange = onDedicatedCompanyChange;

            // Load allocations (preserve locked state from database, default to false if not set)
            editAllocations = (invoice.allocations || []).map(a => ({...a, locked: a.locked || false}));
            renderEditAllocations();

            // Close the detail modal and open the edit modal
            bootstrap.Modal.getInstance(document.getElementById('invoiceModal')).hide();
            const editModal = new bootstrap.Modal(document.getElementById('editInvoiceModal'));
            editModal.show();

            // Reset the file input
            document.getElementById('editInvoiceFile').value = '';
        }

        async function handleEditFileUpload() {
            const fileInput = document.getElementById('editInvoiceFile');
            const file = fileInput.files[0];

            if (!file) {
                await JarvisDialog.alert('Please select a file first', { type: 'warning', title: 'No File Selected' });
                return;
            }

            const invoiceDate = document.getElementById('editInvoiceDate').value || '';
            const company = document.getElementById('editDedicatedCompany').value || 'Unknown Company';
            const invoiceNumber = document.getElementById('editInvoiceNumber').value || 'Unknown Invoice';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('invoice_date', invoiceDate);
            formData.append('company', company);
            formData.append('invoice_number', invoiceNumber);

            const btn = document.getElementById('uploadEditFileBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/drive/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await res.json();

                if (result.success && result.drive_link) {
                    document.getElementById('editDriveLink').value = result.drive_link;
                    await JarvisDialog.alert('File uploaded successfully to Google Drive!', { type: 'success', title: 'Upload Complete' });
                    fileInput.value = '';
                } else {
                    await JarvisDialog.alert('Upload failed: ' + (result.error || 'Unknown error'), { type: 'error', title: 'Upload Failed' });
                }
            } catch (e) {
                await JarvisDialog.alert('Upload error: ' + e.message, { type: 'error', title: 'Upload Error' });
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleSaveInvoice() {
            const invoiceId = document.getElementById('editInvoiceId').value;
            if (!invoiceId) return;

            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;

            // Validate dedicated company
            if (!dedicatedCompany) {
                await JarvisDialog.alert('Please select a company', { type: 'warning', title: 'Missing Company' });
                return;
            }

            // Check for duplicate invoice number
            const invoiceNumber = document.getElementById('editInvoiceNumber').value.trim();
            if (invoiceNumber) {
                try {
                    const dupRes = await fetch(`/api/db/check-invoice-number?invoice_number=${encodeURIComponent(invoiceNumber)}&exclude_id=${invoiceId}`);
                    const dupResult = await dupRes.json();
                    if (dupResult.exists) {
                        const existing = dupResult.invoice;
                        await JarvisDialog.alert(`Invoice number "${invoiceNumber}" already exists!\n\nExisting invoice:\n- Supplier: ${existing.supplier}\n- Date: ${existing.invoice_date}\n- Value: ${existing.invoice_value} ${existing.currency}`, { type: 'warning', title: 'Duplicate Invoice' });
                        return;
                    }
                } catch (e) {
                    console.error('Error checking duplicate:', e);
                }
            }

            // Validate allocations (must be 100%, allow up to 0.1% overdraft for rounding)
            const totalPercent = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_percent) || 0), 0);
            if (totalPercent < 100 || totalPercent > 100.1) {
                await JarvisDialog.alert(`Allocations must sum to 100% (max 0.1% overdraft allowed). Current total: ${totalPercent.toFixed(2)}%`, { type: 'warning', title: 'Invalid Allocation' });
                return;
            }

            // Validate all allocations have a department and validate reinvoice destinations
            for (let idx = 0; idx < editAllocations.length; idx++) {
                const alloc = editAllocations[idx];
                if (!alloc.department) {
                    await JarvisDialog.alert('Please select a department for all allocations', { type: 'warning', title: 'Missing Department' });
                    return;
                }

                // Get reinvoice destinations from the DOM
                const reinvoiceDestinations = getEditReinvoiceDestinations(idx);

                // Validate reinvoice total percentage if any destinations exist
                if (reinvoiceDestinations.length > 0) {
                    const totalReinvoicePercent = reinvoiceDestinations.reduce((sum, d) => sum + d.percentage, 0);
                    if (totalReinvoicePercent > 100) {
                        await JarvisDialog.alert(`Allocation #${idx + 1}: Reinvoice total percentage (${totalReinvoicePercent.toFixed(2)}%) cannot exceed 100%`, { type: 'warning', title: 'Invalid Reinvoice' });
                        return;
                    }
                    // Check that all destinations have a company selected
                    const invalidDest = reinvoiceDestinations.find(d => !d.company);
                    if (invalidDest) {
                        await JarvisDialog.alert(`Allocation #${idx + 1}: All reinvoice destinations must have a company selected`, { type: 'warning', title: 'Invalid Reinvoice' });
                        return;
                    }
                }
            }

            // Get VAT fields for allocation value calculation
            const subtractVat = document.getElementById('editSubtractVat').checked;
            const vatRateSelect = document.getElementById('editVatRateId');
            const selectedVatOption = vatRateSelect.options[vatRateSelect.selectedIndex];
            const vatRate = subtractVat && selectedVatOption && selectedVatOption.dataset.rate ? parseFloat(selectedVatOption.dataset.rate) : null;
            const netValue = subtractVat ? parseFloat(document.getElementById('editNetValue').value) || null : null;

            // Use net value for allocation calculations if VAT subtraction is enabled
            const effectiveValue = subtractVat && netValue ? netValue : invoiceValue;

            // Calculate allocation values and set company for all allocations
            const allocationsWithValues = editAllocations.map((a, idx) => ({
                ...a,
                company: dedicatedCompany,  // Use dedicated company for all
                allocation_percent: parseFloat(a.allocation_percent) || 0,
                allocation_value: (effectiveValue * (parseFloat(a.allocation_percent) || 0)) / 100,
                reinvoice_destinations: getEditReinvoiceDestinations(idx)
            }));

            const data = {
                supplier: document.getElementById('editSupplier').value,
                invoice_number: document.getElementById('editInvoiceNumber').value,
                invoice_date: document.getElementById('editInvoiceDate').value,
                invoice_value: invoiceValue,
                currency: document.getElementById('editCurrency').value,
                drive_link: document.getElementById('editDriveLink').value,
                comment: document.getElementById('editComment').value,
                status: document.getElementById('editStatus').value,
                payment_status: document.getElementById('editPaymentStatus').value,
                subtract_vat: subtractVat,
                vat_rate: vatRate,
                net_value: netValue
            };

            try {
                // Save invoice details
                const invoiceRes = await fetch(`/api/db/invoices/${invoiceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const invoiceResult = await invoiceRes.json();

                if (!invoiceResult.success && invoiceRes.status !== 404) {
                    await JarvisDialog.alert('Error updating invoice: ' + (invoiceResult.error || 'Unknown error'), { type: 'error', title: 'Error' });
                    return;
                }

                // Save allocations (include send_notification flag)
                const sendNotification = document.getElementById('sendNotificationToggle').checked;
                const allocRes = await fetch(`/api/db/invoices/${invoiceId}/allocations`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ allocations: allocationsWithValues, send_notification: sendNotification })
                });
                const allocResult = await allocRes.json();

                if (allocResult.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editInvoiceModal')).hide();
                    // Clear the cache for this invoice
                    delete invoicesWithAllocations[invoiceId];
                    loadData();
                    await JarvisDialog.alert('Invoice and allocations updated successfully!', { type: 'success', title: 'Success' });
                } else {
                    await JarvisDialog.alert('Error updating allocations: ' + (allocResult.error || 'Unknown error'), { type: 'error', title: 'Error' });
                }
            } catch (e) {
                await JarvisDialog.alert('Error: ' + e.message, { type: 'error', title: 'Error' });
            }
        }

        // ============== ALLOCATION EDITING FUNCTIONS ==============

        function getUniqueCompanies() {
            return [...new Set(organizationalStructure.map(s => s.company))].sort();
        }

        function getDepartmentsForCompany(company) {
            return [...new Set(organizationalStructure
                .filter(s => s.company === company)
                .map(s => s.department))].sort();
        }

        function getSubdepartmentsForDept(company, department) {
            return organizationalStructure
                .filter(s => s.company === company && s.department === department && s.subdepartment)
                .map(s => s.subdepartment)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();
        }

        function getBrandsForCompany(company) {
            return organizationalStructure
                .filter(s => s.company === company && s.brand)
                .map(s => s.brand)
                .filter((v, i, a) => a.indexOf(v) === i)
                .sort();
        }

        function getResponsible(company, department, subdepartment, brand) {
            const match = organizationalStructure.find(s =>
                s.company === company &&
                s.department === department &&
                (!subdepartment || s.subdepartment === subdepartment) &&
                (!brand || s.brand === brand)
            );
            return match ? match.manager : '';
        }

        function renderEditAllocations() {
            const container = document.getElementById('allocationsContainer');
            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const companies = getUniqueCompanies();
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;

            // Get departments/brands for the dedicated company
            const departments = getDepartmentsForCompany(dedicatedCompany);
            const brands = getBrandsForCompany(dedicatedCompany);
            const hasBrands = brands.length > 0;

            container.innerHTML = editAllocations.map((alloc, idx) => {
                const subdepartments = getSubdepartmentsForDept(dedicatedCompany, alloc.department);
                const hasSubdepts = subdepartments.length > 0;
                const allocValue = (invoiceValue * (parseFloat(alloc.allocation_percent) || 0)) / 100;

                return `
                    <div class="allocation-edit-row position-relative" data-idx="${idx}">
                        <div class="position-absolute d-flex gap-1" style="top: 5px; right: 40px;">
                            <button type="button" class="btn btn-sm ${alloc.comment ? 'btn-info' : 'btn-outline-info'} comment-allocation-btn" onclick="openEditAllocationCommentModal(${idx})" title="${alloc.comment ? 'Edit comment' : 'Add comment'}" aria-label="${alloc.comment ? 'Edit comment' : 'Add comment'}">
                                <i class="bi ${alloc.comment ? 'bi-chat-text-fill' : 'bi-chat-text'}"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary lock-allocation-btn" onclick="toggleAllocationLock(${idx})" title="${alloc.locked ? 'Unlock this allocation' : 'Lock this allocation'}" aria-label="${alloc.locked ? 'Unlock this allocation' : 'Lock this allocation'}">
                                <i class="bi ${alloc.locked ? 'bi-lock-fill' : 'bi-unlock'}"></i>
                            </button>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger delete-allocation-btn" onclick="deleteAllocation(${idx})" ${editAllocations.length <= 1 ? 'disabled' : ''} aria-label="Delete allocation">
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="row">
                            <div class="col-md-2 mb-2" ${hasBrands ? '' : 'style="display: none;"'}>
                                <label class="form-label">Brand</label>
                                <select class="form-select alloc-brand" data-idx="${idx}" onchange="onAllocationFieldChange(${idx})">
                                    <option value="">N/A</option>
                                    ${brands.map(b => `<option value="${b}" ${b === alloc.brand ? 'selected' : ''}>${b}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Department</label>
                                <select class="form-select alloc-department" data-idx="${idx}" onchange="onAllocationDeptChange(${idx})">
                                    <option value="">Select...</option>
                                    ${departments.map(d => `<option value="${d}" ${d === alloc.department ? 'selected' : ''}>${d}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2" ${hasSubdepts ? '' : 'style="display: none;"'}>
                                <label class="form-label">Subdepartment</label>
                                <select class="form-select alloc-subdepartment" data-idx="${idx}" onchange="onAllocationFieldChange(${idx})">
                                    <option value="">N/A</option>
                                    ${subdepartments.map(s => `<option value="${s}" ${s === alloc.subdepartment ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <label class="form-label">Allocation %</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control alloc-percent" data-idx="${idx}"
                                           value="${alloc.allocation_percent || ''}" min="0" max="100" step="0.01"
                                           onchange="onAllocationPercentChange(${idx})" onkeyup="onAllocationPercentChange(${idx})">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label class="form-label">Value (${document.getElementById('editCurrency').value})</label>
                                <input type="number" class="form-control form-control-sm alloc-value" data-idx="${idx}"
                                       value="${allocValue.toFixed(2)}" min="0" step="0.01"
                                       onchange="onAllocationValueChange(${idx})" onkeyup="onAllocationValueChange(${idx})">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Manager: ${alloc.responsible || '--'}</small>
                            </div>
                            <div class="col-md-6 mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input alloc-reinvoice-check" type="checkbox" data-idx="${idx}"
                                           ${(alloc.reinvoice_destinations && alloc.reinvoice_destinations.length > 0) ? 'checked' : ''} onchange="onReinvoiceCheckChange(${idx})">
                                    <label class="form-check-label small">Reinvoice to:</label>
                                    <span class="reinvoice-total-badge badge bg-secondary ms-2" data-idx="${idx}" style="display: ${(alloc.reinvoice_destinations && alloc.reinvoice_destinations.length > 0) ? '' : 'none'};">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="reinvoice-section" data-idx="${idx}" style="display: ${(alloc.reinvoice_destinations && alloc.reinvoice_destinations.length > 0) ? '' : 'none'};">
                            <div class="reinvoice-lines-container" data-idx="${idx}"></div>
                            <div class="row mt-1">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-secondary btn-sm add-reinvoice-line-btn" data-idx="${idx}" onclick="addEditReinvoiceLine(${idx}, true)">
                                        <i class="bi bi-plus"></i> Add Reinvoice Line
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateAllocationTotalBadge();

            // Initialize reinvoice lines for allocations with existing reinvoice destinations
            initializeReinvoiceLines();
        }

        async function initializeReinvoiceLines() {
            for (let idx = 0; idx < editAllocations.length; idx++) {
                const alloc = editAllocations[idx];
                // Support both new reinvoice_destinations array and legacy single reinvoice fields
                if (alloc.reinvoice_destinations && alloc.reinvoice_destinations.length > 0) {
                    // New multi-destination format
                    for (const dest of alloc.reinvoice_destinations) {
                        await addEditReinvoiceLine(idx, false, dest);
                    }
                } else if (alloc.reinvoice_to) {
                    // Legacy single destination - migrate to new format
                    const legacyDest = {
                        company: alloc.reinvoice_to,
                        brand: alloc.reinvoice_brand,
                        department: alloc.reinvoice_department,
                        subdepartment: alloc.reinvoice_subdepartment,
                        percentage: 100
                    };
                    editAllocations[idx].reinvoice_destinations = [legacyDest];
                    await addEditReinvoiceLine(idx, false, legacyDest);
                }
                updateEditReinvoiceTotalBadge(idx);
            }
        }

        async function addEditReinvoiceLine(allocIdx, redistribute = false, existingData = null) {
            const container = document.querySelector(`.reinvoice-lines-container[data-idx="${allocIdx}"]`);
            if (!container) return;

            // Get companies list
            const companies = getUniqueCompanies();

            const lineCount = container.children.length;
            let newPercentage = existingData ? existingData.percentage : 100;

            // If redistributing, update all existing lines to equal percentage
            if (redistribute && lineCount > 0) {
                newPercentage = 100 / (lineCount + 1);
                container.querySelectorAll('.reinvoice-percent').forEach(input => {
                    input.value = newPercentage.toFixed(2);
                });
            }

            const lineId = `reinvoice-line-${allocIdx}-${Date.now()}`;
            const line = document.createElement('div');
            line.className = 'reinvoice-line row mb-1 align-items-center';
            line.id = lineId;

            line.innerHTML = `
                <div class="col-md-2">
                    <select class="form-select form-select-sm reinvoice-company" onchange="onEditReinvoiceCompanyChange('${lineId}', ${allocIdx})">
                        <option value="">Company...</option>
                        ${companies.map(c => `<option value="${c}" ${existingData && c === existingData.company ? 'selected' : ''}>${c}</option>`).join('')}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm reinvoice-brand">
                        <option value="">Brand...</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm reinvoice-dept" onchange="onEditReinvoiceDeptChange('${lineId}', ${allocIdx})">
                        <option value="">Dept...</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select form-select-sm reinvoice-subdept" onchange="updateEditReinvoiceTotalBadge(${allocIdx})">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control reinvoice-percent" value="${newPercentage.toFixed(2)}"
                               min="0" max="100" step="0.01" onchange="updateEditReinvoiceTotalBadge(${allocIdx})">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEditReinvoiceLine('${lineId}', ${allocIdx})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;

            container.appendChild(line);

            // Populate brands, departments and subdepartments if existing data
            if (existingData && existingData.company) {
                const brandSelect = line.querySelector('.reinvoice-brand');
                const deptSelect = line.querySelector('.reinvoice-dept');
                const subdeptSelect = line.querySelector('.reinvoice-subdept');

                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(existingData.company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(existingData.company)}`).then(r => r.json())
                ]);

                brandSelect.innerHTML = '<option value="">Brand...</option>';
                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    if (b === existingData.brand) opt.selected = true;
                    brandSelect.appendChild(opt);
                });

                deptSelect.innerHTML = '<option value="">Dept...</option>';
                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    if (d === existingData.department) opt.selected = true;
                    deptSelect.appendChild(opt);
                });

                if (existingData.department) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(existingData.company)}/${encodeURIComponent(existingData.department)}`).then(r => r.json());
                    subdeptSelect.innerHTML = '<option value="">N/A</option>';
                    subdepts.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        if (s === existingData.subdepartment) opt.selected = true;
                        subdeptSelect.appendChild(opt);
                    });
                }
            }

            updateEditReinvoiceTotalBadge(allocIdx);
        }

        function removeEditReinvoiceLine(lineId, allocIdx) {
            const line = document.getElementById(lineId);
            if (line) {
                line.remove();
            }

            // If no lines left, uncheck the reinvoice checkbox
            const container = document.querySelector(`.reinvoice-lines-container[data-idx="${allocIdx}"]`);
            if (container && container.children.length === 0) {
                const checkbox = document.querySelector(`.alloc-reinvoice-check[data-idx="${allocIdx}"]`);
                if (checkbox) checkbox.checked = false;
                const section = document.querySelector(`.reinvoice-section[data-idx="${allocIdx}"]`);
                if (section) section.style.display = 'none';
                const badge = document.querySelector(`.reinvoice-total-badge[data-idx="${allocIdx}"]`);
                if (badge) badge.style.display = 'none';
            }

            updateEditReinvoiceTotalBadge(allocIdx);
        }

        async function onEditReinvoiceCompanyChange(lineId, allocIdx) {
            const line = document.getElementById(lineId);
            if (!line) return;

            const company = line.querySelector('.reinvoice-company').value;
            const brandSelect = line.querySelector('.reinvoice-brand');
            const deptSelect = line.querySelector('.reinvoice-dept');
            const subdeptSelect = line.querySelector('.reinvoice-subdept');

            brandSelect.innerHTML = '<option value="">Brand...</option>';
            deptSelect.innerHTML = '<option value="">Dept...</option>';
            subdeptSelect.innerHTML = '<option value="">N/A</option>';

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);

                brands.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = b;
                    brandSelect.appendChild(opt);
                });

                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });
            }

            updateEditReinvoiceTotalBadge(allocIdx);
        }

        async function onEditReinvoiceDeptChange(lineId, allocIdx) {
            const line = document.getElementById(lineId);
            if (!line) return;

            const company = line.querySelector('.reinvoice-company').value;
            const department = line.querySelector('.reinvoice-dept').value;
            const subdeptSelect = line.querySelector('.reinvoice-subdept');

            subdeptSelect.innerHTML = '<option value="">N/A</option>';

            if (company && department) {
                const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(department)}`).then(r => r.json());
                subdepts.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    subdeptSelect.appendChild(opt);
                });
            }

            updateEditReinvoiceTotalBadge(allocIdx);
        }

        function updateEditReinvoiceTotalBadge(allocIdx) {
            const container = document.querySelector(`.reinvoice-lines-container[data-idx="${allocIdx}"]`);
            const badge = document.querySelector(`.reinvoice-total-badge[data-idx="${allocIdx}"]`);
            if (!container || !badge) return;

            let total = 0;
            container.querySelectorAll('.reinvoice-percent').forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            badge.textContent = `${total.toFixed(1)}%`;
            badge.className = total <= 100 ? 'reinvoice-total-badge badge bg-success ms-2' : 'reinvoice-total-badge badge bg-danger ms-2';
        }

        function getEditReinvoiceDestinations(allocIdx) {
            const container = document.querySelector(`.reinvoice-lines-container[data-idx="${allocIdx}"]`);
            const destinations = [];
            if (!container) return destinations;

            container.querySelectorAll('.reinvoice-line').forEach(line => {
                const company = line.querySelector('.reinvoice-company').value;
                const brand = line.querySelector('.reinvoice-brand').value;
                const department = line.querySelector('.reinvoice-dept').value;
                const subdepartment = line.querySelector('.reinvoice-subdept').value;
                const percentage = parseFloat(line.querySelector('.reinvoice-percent').value) || 0;

                if (company && percentage > 0) {
                    destinations.push({
                        company,
                        brand: brand || null,
                        department: department || null,
                        subdepartment: subdepartment || null,
                        percentage
                    });
                }
            });

            return destinations;
        }

        function updateAllocationTotalBadge() {
            const totalPercent = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_percent) || 0), 0);
            const totalValue = editAllocations.reduce((sum, a) => sum + (parseFloat(a.allocation_value) || 0), 0);
            const currency = document.getElementById('editCurrency').value || 'RON';
            const badge = document.getElementById('allocationTotalBadge');
            badge.textContent = `${totalPercent.toFixed(2)}% | ${formatCurrency(totalValue)} ${currency}`;
            // Valid if 100% to 100.1% (allow small overdraft for rounding)
            badge.className = (totalPercent >= 100 && totalPercent <= 100.1) ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';
        }

        function onDedicatedCompanyChange() {
            // Reset all allocations when company changes
            const company = document.getElementById('editDedicatedCompany').value;
            editAllocations.forEach(alloc => {
                alloc.company = company;
                alloc.department = '';
                alloc.subdepartment = '';
                alloc.brand = '';
                alloc.responsible = '';
            });
            renderEditAllocations();
        }

        function onAllocationDeptChange(idx) {
            const company = document.getElementById('editDedicatedCompany').value;
            const department = document.querySelector(`.alloc-department[data-idx="${idx}"]`).value;
            const brand = editAllocations[idx].brand;

            editAllocations[idx].department = department;
            editAllocations[idx].subdepartment = '';
            editAllocations[idx].responsible = getResponsible(company, department, null, brand);
            renderEditAllocations();
        }

        function onAllocationFieldChange(idx) {
            const row = document.querySelector(`.allocation-edit-row[data-idx="${idx}"]`);
            const company = document.getElementById('editDedicatedCompany').value;

            editAllocations[idx].subdepartment = row.querySelector('.alloc-subdepartment').value || null;
            editAllocations[idx].brand = row.querySelector('.alloc-brand').value || null;

            // Update responsible based on company/dept/subdept/brand
            const department = editAllocations[idx].department;
            const subdepartment = editAllocations[idx].subdepartment;
            const brand = editAllocations[idx].brand;
            editAllocations[idx].responsible = getResponsible(company, department, subdepartment, brand);
        }

        function onReinvoiceCheckChange(idx) {
            const checked = document.querySelector(`.alloc-reinvoice-check[data-idx="${idx}"]`).checked;
            const section = document.querySelector(`.reinvoice-section[data-idx="${idx}"]`);
            const badge = document.querySelector(`.reinvoice-total-badge[data-idx="${idx}"]`);
            const container = document.querySelector(`.reinvoice-lines-container[data-idx="${idx}"]`);

            if (checked) {
                section.style.display = '';
                badge.style.display = '';
                // Add first line if none exist
                if (container && container.children.length === 0) {
                    addEditReinvoiceLine(idx, false);
                }
            } else {
                section.style.display = 'none';
                badge.style.display = 'none';
                // Clear all reinvoice lines
                if (container) {
                    container.innerHTML = '';
                }
                editAllocations[idx].reinvoice_destinations = [];
            }
        }

        function onAllocationPercentChange(idx) {
            const percent = parseFloat(document.querySelector(`.alloc-percent[data-idx="${idx}"]`).value) || 0;
            const baseValue = getEditBaseValue();
            editAllocations[idx].allocation_percent = percent;
            editAllocations[idx].allocation_value = (baseValue * percent) / 100;

            // Update value field without re-rendering (to avoid losing focus)
            const valueInput = document.querySelector(`.alloc-value[data-idx="${idx}"]`);
            if (valueInput) {
                valueInput.value = editAllocations[idx].allocation_value.toFixed(2);
            }

            // Redistribute remaining to other allocations
            redistributeOtherAllocations(idx);
        }

        function onAllocationValueChange(idx) {
            const value = parseFloat(document.querySelector(`.alloc-value[data-idx="${idx}"]`).value) || 0;
            const baseValue = getEditBaseValue();

            editAllocations[idx].allocation_value = value;
            editAllocations[idx].allocation_percent = baseValue > 0 ? (value / baseValue) * 100 : 0;

            // Update percent field without re-rendering (to avoid losing focus)
            const percentInput = document.querySelector(`.alloc-percent[data-idx="${idx}"]`);
            if (percentInput) {
                percentInput.value = editAllocations[idx].allocation_percent.toFixed(2);
            }

            // Redistribute remaining to other allocations
            redistributeOtherAllocations(idx);
        }

        // Redistribute remaining percentage equally among other allocations
        function redistributeOtherAllocations(changedIdx) {
            const count = editAllocations.length;
            if (count <= 1) {
                updateAllocationTotalBadge();
                return;
            }

            const changedPercent = editAllocations[changedIdx].allocation_percent || 0;
            const remaining = 100 - changedPercent;
            const perOther = remaining / (count - 1);
            const baseValue = getEditBaseValue();

            editAllocations.forEach((alloc, idx) => {
                if (idx !== changedIdx) {
                    alloc.allocation_percent = perOther;
                    alloc.allocation_value = (baseValue * perOther) / 100;

                    // Update UI without re-rendering
                    const pInput = document.querySelector(`.alloc-percent[data-idx="${idx}"]`);
                    const vInput = document.querySelector(`.alloc-value[data-idx="${idx}"]`);
                    if (pInput) pInput.value = perOther.toFixed(2);
                    if (vInput) vInput.value = alloc.allocation_value.toFixed(2);
                }
            });

            updateAllocationTotalBadge();
        }

        // Get smart split percentages based on count
        // 1: 100%, 2: 50-50, 3: 40-30-30, 4: 40-20-20-20, etc.
        function getSmartSplitEdit(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];

            // For 3+: first gets 40%, rest split equally
            const firstPercent = 40;
            const remaining = 100 - firstPercent;
            const otherPercent = remaining / (count - 1);

            const result = [firstPercent];
            for (let i = 1; i < count; i++) {
                result.push(otherPercent);
            }
            return result;
        }

        // Toggle lock state for an allocation
        function toggleAllocationLock(idx) {
            editAllocations[idx].locked = !editAllocations[idx].locked;
            renderEditAllocations();
        }

        // Edit allocation comment variables
        let currentEditCommentIdx = null;

        // Open comment modal for allocation
        function openEditAllocationCommentModal(idx) {
            currentEditCommentIdx = idx;
            const alloc = editAllocations[idx];
            const currency = document.getElementById('editCurrency').value || 'RON';
            const allocValue = (parseFloat(document.getElementById('editInvoiceValue').value) || 0) * (parseFloat(alloc.allocation_percent) || 0) / 100;

            const deptPart = alloc.department || '-';
            const brandPart = alloc.brand ? ` (${alloc.brand})` : '';
            document.getElementById('editAllocationCommentInfo').textContent = `${deptPart}${brandPart} - ${formatCurrency(allocValue)} ${currency} (${alloc.allocation_percent || 0}%)`;
            document.getElementById('editAllocationCommentText').value = alloc.comment || '';

            const modal = new bootstrap.Modal(document.getElementById('editAllocationCommentModal'));
            modal.show();
        }

        // Save allocation comment
        function saveEditAllocationComment() {
            if (currentEditCommentIdx === null) return;

            const comment = document.getElementById('editAllocationCommentText').value;
            editAllocations[currentEditCommentIdx].comment = comment || null;

            bootstrap.Modal.getInstance(document.getElementById('editAllocationCommentModal')).hide();
            currentEditCommentIdx = null;

            renderEditAllocations();
        }

        // Apply smart split to all allocations (respecting locked allocations)
        function applySmartSplit() {
            const count = editAllocations.length;
            if (count === 0) return;

            const invoiceValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;

            // Separate locked and unlocked allocations
            const lockedAllocs = editAllocations.filter(a => a.locked);
            const unlockedAllocs = editAllocations.filter(a => !a.locked);

            // Calculate total locked percentage
            let lockedPercent = 0;
            lockedAllocs.forEach(alloc => {
                lockedPercent += parseFloat(alloc.allocation_percent) || 0;
            });

            // Distribute remaining percentage among unlocked allocations
            const remainingPercent = Math.max(0, 100 - lockedPercent);
            const unlockedCount = unlockedAllocs.length;

            if (unlockedCount > 0) {
                let percentages = getSmartSplitEdit(unlockedCount);
                // Scale percentages to fit remaining percent
                const scaleFactor = remainingPercent / 100;
                percentages = percentages.map(p => p * scaleFactor);

                unlockedAllocs.forEach((alloc, idx) => {
                    alloc.allocation_percent = percentages[idx];
                    alloc.allocation_value = (invoiceValue * percentages[idx]) / 100;
                });
            }

            // Update locked allocation values (in case invoice value changed)
            lockedAllocs.forEach(alloc => {
                alloc.allocation_value = (invoiceValue * (parseFloat(alloc.allocation_percent) || 0)) / 100;
            });

            renderEditAllocations();
        }

        async function addNewAllocation() {
            const dedicatedCompany = document.getElementById('editDedicatedCompany').value;
            if (!dedicatedCompany) {
                await JarvisDialog.alert('Please select a company first', { type: 'warning', title: 'Missing Company' });
                return;
            }
            editAllocations.push({
                company: dedicatedCompany,
                brand: null,
                department: '',
                subdepartment: null,
                allocation_percent: 0,
                allocation_value: 0,
                responsible: '',
                reinvoice_destinations: [],
                locked: false,
                comment: null
            });
            applySmartSplit(); // Redistribute with smart split when adding
        }

        async function deleteAllocation(idx) {
            if (editAllocations.length <= 1) {
                await JarvisDialog.alert('Invoice must have at least one allocation', { type: 'warning', title: 'Cannot Delete' });
                return;
            }
            editAllocations.splice(idx, 1);
            applySmartSplit(); // Redistribute with smart split when removing
        }

        // Update allocation values when invoice value changes
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('editInvoiceValue').addEventListener('input', () => {
                if (editAllocations.length > 0) {
                    renderEditAllocations();
                }
            });

            // Toggle +/- icon on collapse show/hide
            document.addEventListener('show.bs.collapse', (e) => {
                const trigger = document.querySelector(`[href="#${e.target.id}"]`);
                if (trigger) {
                    const icon = trigger.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-plus-circle');
                        icon.classList.add('bi-dash-circle');
                    }
                }
            });
            document.addEventListener('hide.bs.collapse', (e) => {
                const trigger = document.querySelector(`[href="#${e.target.id}"]`);
                if (trigger) {
                    const icon = trigger.querySelector('.toggle-icon');
                    if (icon) {
                        icon.classList.remove('bi-dash-circle');
                        icon.classList.add('bi-plus-circle');
                    }
                }
            });
        });

        // ============== END ALLOCATION EDITING FUNCTIONS ==============

        // ============== SUMMARY CARDS TOGGLE ==============
        // Note: summaryCards/summaryBar elements were removed in UI refactor
        // These functions are kept for backwards compatibility but are now no-ops
        function toggleSummaryCards() {
            const cards = document.getElementById('summaryCards');
            const summaryBar = document.getElementById('summaryBar');
            const btn = document.getElementById('toggleSummary');

            // Early return if elements don't exist (UI was refactored)
            if (!cards || !summaryBar || !btn) return;

            if (cards.classList.contains('d-none')) {
                cards.classList.remove('d-none');
                summaryBar.querySelector('.summary-stats')?.classList.add('d-none');
                btn.innerHTML = '<i class="bi bi-chevron-up"></i>';
                btn.title = 'Collapse summary';
                localStorage.setItem('summaryCardsVisible', 'true');
            } else {
                cards.classList.add('d-none');
                summaryBar.querySelector('.summary-stats')?.classList.remove('d-none');
                btn.innerHTML = '<i class="bi bi-bar-chart-fill"></i>';
                btn.title = 'Expand summary';
                localStorage.setItem('summaryCardsVisible', 'false');
            }
        }

        // Restore summary visibility state on load
        function restoreSummaryState() {
            const visible = localStorage.getItem('summaryCardsVisible');
            if (visible === 'true') {
                toggleSummaryCards();
            }
        }

        function updateCompactSummary() {
            // Update compact bar with same values
            const invoices = document.getElementById('totalInvoices').textContent;
            const value = document.getElementById('totalValue').textContent;
            const companies = document.getElementById('totalCompanies').textContent;
            const depts = document.getElementById('totalDepartments').textContent;
            const vat = document.getElementById('vatValue').textContent;
            const gross = document.getElementById('grossValue').textContent;

            document.getElementById('totalInvoicesCompact').textContent = invoices;
            document.getElementById('totalValueCompact').textContent = value;
            document.getElementById('totalCompaniesCompact').textContent = companies;
            document.getElementById('totalDepartmentsCompact').textContent = depts;
            document.getElementById('vatValueCompact').textContent = vat;
            document.getElementById('grossValueCompact').textContent = gross;
        }

        function updateSummaryCards() {
            document.getElementById('totalInvoices').textContent = allInvoices.length;

            // Calculate totals from ALLOCATION values (not invoice gross values)
            // Allocation values use net_value when VAT subtraction is enabled
            // This ensures consistency with summary tables
            summaryTotalRon = 0;
            summaryTotalEur = 0;

            // Calculate Gross and VAT totals directly from invoice fields
            summaryGrossRon = 0;
            summaryGrossEur = 0;
            summaryVatRon = 0;
            summaryVatEur = 0;

            // Count unique companies and departments
            const uniqueCompanies = new Set();
            const uniqueDepartments = new Set();

            allInvoices.forEach(inv => {
                const invoiceValue = inv.invoice_value || 0;
                const exchangeRate = inv.exchange_rate || currentEurRate;

                // Gross Value = value_ron/value_eur (already converted in database)
                summaryGrossRon += inv.value_ron || invoiceValue;
                summaryGrossEur += inv.value_eur || (invoiceValue / exchangeRate);

                // VAT Value = (invoice_value - net_value) converted to RON/EUR
                if (inv.subtract_vat && inv.net_value && invoiceValue > 0) {
                    const vatInOriginalCurrency = invoiceValue - inv.net_value;
                    // Convert to RON using same ratio as value_ron
                    const conversionRatioRon = (inv.value_ron || invoiceValue) / invoiceValue;
                    const conversionRatioEur = (inv.value_eur || (invoiceValue / exchangeRate)) / invoiceValue;
                    summaryVatRon += vatInOriginalCurrency * conversionRatioRon;
                    summaryVatEur += vatInOriginalCurrency * conversionRatioEur;
                }

                // Sum allocation values and convert to RON/EUR
                if (inv.allocations && inv.allocations.length > 0) {
                    inv.allocations.forEach(alloc => {
                        const allocValue = alloc.allocation_value || 0;
                        // Convert allocation value to RON and EUR using invoice's conversion ratios
                        if (invoiceValue > 0 && inv.value_ron) {
                            summaryTotalRon += allocValue * inv.value_ron / invoiceValue;
                        } else {
                            summaryTotalRon += allocValue;
                        }
                        if (invoiceValue > 0 && inv.value_eur) {
                            summaryTotalEur += allocValue * inv.value_eur / invoiceValue;
                        } else {
                            summaryTotalEur += allocValue / exchangeRate;
                        }
                        // Track unique companies/departments
                        if (alloc.company) uniqueCompanies.add(alloc.company);
                        if (alloc.department) uniqueDepartments.add(alloc.department);
                    });
                } else {
                    // Fallback for invoices without allocations - use invoice values
                    if (inv.value_ron && inv.value_eur) {
                        summaryTotalRon += inv.value_ron;
                        summaryTotalEur += inv.value_eur;
                    } else {
                        const currency = (inv.currency || 'RON').toUpperCase();
                        if (currency === 'EUR') {
                            summaryTotalEur += invoiceValue;
                            summaryTotalRon += invoiceValue * exchangeRate;
                        } else {
                            summaryTotalRon += invoiceValue;
                            summaryTotalEur += invoiceValue / exchangeRate;
                        }
                    }
                }
            });

            // Display based on toggle state
            const showEur = document.getElementById('currencyToggle').checked;
            updateTotalValueDisplay(showEur);

            document.getElementById('totalCompanies').textContent = uniqueCompanies.size;
            document.getElementById('totalDepartments').textContent = uniqueDepartments.size;

            // Update compact summary
            updateCompactSummary();
        }

        function updateTotalValueDisplay(showEur) {
            const totalValueEl = document.getElementById('totalValue');
            const grossValueEl = document.getElementById('grossValue');
            const vatValueEl = document.getElementById('vatValue');
            const toggleLabel = document.getElementById('currencyToggleLabel');

            if (showEur) {
                totalValueEl.textContent = formatCurrency(summaryTotalEur) + ' EUR';
                grossValueEl.textContent = formatCurrency(summaryGrossEur) + ' EUR';
                vatValueEl.textContent = formatCurrency(summaryVatEur) + ' EUR';
                toggleLabel.textContent = 'RON';
            } else {
                totalValueEl.textContent = formatCurrency(summaryTotalRon) + ' RON';
                grossValueEl.textContent = formatCurrency(summaryGrossRon) + ' RON';
                vatValueEl.textContent = formatCurrency(summaryVatRon) + ' RON';
                toggleLabel.textContent = 'EUR';
            }
            updateCompactSummary();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value || 0);
        }

        function formatCurrencyWithSign(value, currency = 'RON') {
            const formatted = formatCurrency(value);
            if (value < 0) {
                return `<span class="text-negative">${formatted} ${currency}</span>`;
            }
            return `${formatted} ${currency}`;
        }

        function formatDateRomanian(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            } catch (e) {
                return dateStr;
            }
        }

        function formatNumber(num) {
            if (num == null || isNaN(num)) return '0.00';
            return parseFloat(num).toLocaleString('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ================= EDIT VAT FUNCTIONS =================

        let editVatRatesCache = null;

        async function loadEditVatRates() {
            if (editVatRatesCache) {
                populateEditVatRateDropdown(editVatRatesCache);
                return;
            }
            try {
                const res = await fetch('/api/vat-rates?active_only=true');
                editVatRatesCache = await res.json();
                populateEditVatRateDropdown(editVatRatesCache);
            } catch (e) {
                console.error('Error loading VAT rates:', e);
            }
        }

        function populateEditVatRateDropdown(rates) {
            const select = document.getElementById('editVatRateId');
            select.innerHTML = '<option value="">Select rate...</option>' +
                rates.map(r => `<option value="${r.id}" data-rate="${r.rate}">${r.name} (${r.rate}%)</option>`).join('');
        }

        // Helper function to get the base value for allocations (net value if VAT enabled, gross otherwise)
        function getEditBaseValue() {
            const subtractVat = document.getElementById('editSubtractVat').checked;
            const netValue = parseFloat(document.getElementById('editNetValue').value) || 0;
            const grossValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            return subtractVat && netValue > 0 ? netValue : grossValue;
        }

        // Recalculate all allocation values based on current base value
        function recalcAllEditAllocationValues() {
            const baseValue = getEditBaseValue();
            const currency = document.getElementById('editCurrency').value || 'RON';

            editAllocations.forEach((alloc, idx) => {
                const percent = parseFloat(alloc.allocation_percent) || 0;
                alloc.allocation_value = (baseValue * percent) / 100;

                // Update UI
                const vInput = document.querySelector(`.alloc-value[data-idx="${idx}"]`);
                if (vInput) vInput.value = alloc.allocation_value.toFixed(2);
            });

            updateAllocationTotalBadge();
        }

        function calculateEditNetValue() {
            const grossValue = parseFloat(document.getElementById('editInvoiceValue').value) || 0;
            const vatRateSelect = document.getElementById('editVatRateId');
            const selectedOption = vatRateSelect.options[vatRateSelect.selectedIndex];
            const vatRate = selectedOption && selectedOption.dataset.rate ? parseFloat(selectedOption.dataset.rate) : 0;
            const currency = document.getElementById('editCurrency').value || 'RON';

            if (vatRate > 0) {
                const netValue = grossValue / (1 + vatRate / 100);
                document.getElementById('editNetValue').value = netValue.toFixed(2);
                document.getElementById('editNetValueDisplay').value = formatNumber(netValue) + ' ' + currency;
            } else {
                document.getElementById('editNetValue').value = '';
                document.getElementById('editNetValueDisplay').value = '';
            }

            // Recalculate allocation values based on new net value
            recalcAllEditAllocationValues();
        }

        function onEditSubtractVatChange() {
            const checked = document.getElementById('editSubtractVat').checked;
            document.getElementById('editVatRateCol').style.display = checked ? '' : 'none';
            document.getElementById('editNetValueCol').style.display = checked ? '' : 'none';
            if (!checked) {
                document.getElementById('editVatRateId').value = '';
                document.getElementById('editNetValue').value = '';
                document.getElementById('editNetValueDisplay').value = '';
            } else {
                calculateEditNetValue();
            }

            // Recalculate allocation values when VAT is toggled
            recalcAllEditAllocationValues();
        }

        // ================= SORTING FUNCTIONS =================

        function toggleDateSort() {
            const sortSelect = document.getElementById('sortOrder');
            // Toggle between newest and oldest
            if (sortSelect.value === 'newest') {
                sortSelect.value = 'oldest';
            } else {
                sortSelect.value = 'newest';
            }
            applySorting();
        }

        function toggleValueSort() {
            const sortSelect = document.getElementById('sortOrder');
            // Toggle between value_highest and value_lowest
            if (sortSelect.value === 'value_highest') {
                sortSelect.value = 'value_lowest';
            } else {
                sortSelect.value = 'value_highest';
            }
            applySorting();
        }

        function applySorting() {
            const sortOrder = document.getElementById('sortOrder').value;
            let sortedInvoices = [...allInvoices];

            // Parse ISO date string (YYYY-MM-DD) to comparable number
            function parseDateToNum(dateStr) {
                if (!dateStr) return 0;
                // Convert YYYY-MM-DD to YYYYMMDD number for proper comparison
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return parseInt(parts[0]) * 10000 + parseInt(parts[1]) * 100 + parseInt(parts[2]);
                }
                return 0;
            }

            sortedInvoices.sort((a, b) => {
                if (sortOrder === 'newest' || sortOrder === 'oldest') {
                    const dateA = parseDateToNum(a.invoice_date);
                    const dateB = parseDateToNum(b.invoice_date);
                    return sortOrder === 'newest' ? dateB - dateA : dateA - dateB;
                } else if (sortOrder === 'value_highest' || sortOrder === 'value_lowest') {
                    const valueA = parseFloat(a.invoice_value) || 0;
                    const valueB = parseFloat(b.invoice_value) || 0;
                    return sortOrder === 'value_highest' ? valueB - valueA : valueA - valueB;
                }
                return 0;
            });

            renderInvoicesTable(sortedInvoices);
        }

        // ================= SELECTION FUNCTIONS =================

        function toggleSelectAll(checkbox) {
            const isChecked = checkbox.checked;

            // Get currently displayed invoices (after filtering)
            const displayedInvoices = allInvoices;

            if (isChecked) {
                displayedInvoices.forEach(inv => selectedInvoices.add(inv.id));
            } else {
                displayedInvoices.forEach(inv => selectedInvoices.delete(inv.id));
            }

            // Update individual checkboxes
            document.querySelectorAll('#invoicesTable input.select-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });

            updateSelectionUI();
        }

        function toggleInvoiceSelect(id) {
            if (selectedInvoices.has(id)) {
                selectedInvoices.delete(id);
            } else {
                selectedInvoices.add(id);
            }

            updateSelectionUI();

            // Update select all checkbox state
            const selectAll = document.getElementById('selectAll');
            if (selectAll) {
                const allChecked = allInvoices.length > 0 && allInvoices.every(inv => selectedInvoices.has(inv.id));
                selectAll.checked = allChecked;
            }
        }

        function updateSelectionUI() {
            const count = selectedInvoices.size;
            const bulkActionBar = document.getElementById('bulkActionBar');
            const selectedCountEl = document.getElementById('selectedCount');

            if (count > 0) {
                bulkActionBar.classList.add('show');
                selectedCountEl.textContent = count;
            } else {
                bulkActionBar.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedInvoices.clear();
            document.querySelectorAll('#invoicesTable input.select-checkbox, #selectAll').forEach(cb => {
                cb.checked = false;
            });
            updateSelectionUI();
        }

        // ================= BULK DELETE FUNCTIONS =================

        async function bulkDeleteSelected() {
            if (selectedInvoices.size === 0) return;

            const confirmed = await JarvisDialog.confirm(`Are you sure you want to move ${selectedInvoices.size} invoice(s) to the bin?`, { title: 'Move to Bin', danger: true });
            if (!confirmed) {
                return;
            }

            try {
                const invoice_ids = Array.from(selectedInvoices);
                const response = await fetch('/api/db/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    // Remove deleted invoices from local data
                    allInvoices = allInvoices.filter(inv => !selectedInvoices.has(inv.id));
                    selectedInvoices.clear();

                    // Re-render table
                    applySorting();
                    updateSummaryCards();
                    loadBinCount();

                    await JarvisDialog.alert(`${result.deleted_count} invoice(s) moved to bin.`, { type: 'success', title: 'Success' });
                } else {
                    await JarvisDialog.alert('Error: ' + (result.error || 'Failed to delete'), { type: 'error', title: 'Error' });
                }
            } catch (err) {
                console.error('Bulk delete error:', err);
                await JarvisDialog.alert('Error deleting invoices', { type: 'error', title: 'Error' });
            }
        }

        async function bulkChangeStatus(newStatus) {
            if (!newStatus || selectedInvoices.size === 0) return;

            try {
                const invoice_ids = Array.from(selectedInvoices);
                let successCount = 0;

                for (const id of invoice_ids) {
                    const response = await fetch(`/api/db/invoices/${id}/status`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });
                    if (response.ok) {
                        successCount++;
                        const inv = allInvoices.find(i => i.id === id);
                        if (inv) inv.status = newStatus;
                    }
                }

                document.getElementById('bulkStatusChange').value = '';
                applySorting();
                await JarvisDialog.alert(`${successCount} invoice(s) updated to "${newStatus}".`, { type: 'success', title: 'Success' });
            } catch (err) {
                console.error('Bulk status change error:', err);
                await JarvisDialog.alert('Error changing status', { type: 'error', title: 'Error' });
            }
        }

        function exportSelectedToCSV() {
            if (selectedInvoices.size === 0) return;

            const selected = allInvoices.filter(inv => selectedInvoices.has(inv.id));
            const headers = ['Date', 'Supplier', 'Invoice #', 'Value', 'Currency', 'Status'];
            const rows = selected.map(inv => [
                inv.invoice_date || '',
                (inv.supplier || '').replace(/"/g, '""'),
                (inv.invoice_number || '').replace(/"/g, '""'),
                inv.invoice_value || 0,
                inv.currency || 'RON',
                inv.status || 'new'
            ]);

            const csvContent = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `invoices_export_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ================= BIN FUNCTIONS =================

        async function loadBinCount() {
            try {
                const response = await fetch('/api/db/invoices/bin');
                const data = await response.json();
                const count = data.length;

                const binBadge = document.getElementById('binCount');
                if (count > 0) {
                    binBadge.textContent = count;
                    binBadge.style.display = 'inline';
                } else {
                    binBadge.style.display = 'none';
                }
            } catch (err) {
                console.error('Error loading bin count:', err);
            }
        }

        async function loadBinData() {
            const tbody = document.getElementById('binTable');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

            try {
                const response = await fetch('/api/db/invoices/bin');
                binInvoices = await response.json();
                renderBinTable();
            } catch (err) {
                console.error('Error loading bin data:', err);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading deleted invoices</td></tr>';
            }
        }

        function renderBinTable() {
            const tbody = document.getElementById('binTable');

            if (binInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No deleted invoices in bin</td></tr>';
                document.getElementById('binCount').style.display = 'none';
                return;
            }

            // Update bin count badge
            document.getElementById('binCount').textContent = binInvoices.length;
            document.getElementById('binCount').style.display = 'inline';

            tbody.innerHTML = binInvoices.map(inv => {
                const checked = selectedBinInvoices.has(inv.id) ? 'checked' : '';
                const deletedAt = inv.deleted_at ? formatDateRomanian(inv.deleted_at) : '-';
                return `
                    <tr class="deleted-row">
                        <td><input type="checkbox" class="select-checkbox" data-bin-id="${inv.id}" onchange="toggleBinInvoiceSelect(${inv.id})" ${checked}></td>
                        <td>${inv.id}</td>
                        <td>${formatDateRomanian(inv.invoice_date)}</td>
                        <td>${inv.supplier || '-'}</td>
                        <td><code>${inv.invoice_number || '-'}</code></td>
                        <td>${formatCurrency(inv.invoice_value)} ${inv.currency || 'RON'}</td>
                        <td>${deletedAt}</td>
                        <td>
                            <button class="btn btn-outline-success btn-sm" onclick="restoreInvoice(${inv.id})" title="Restore" aria-label="Restore invoice">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="permanentDeleteInvoice(${inv.id})" title="Delete Permanently" aria-label="Delete permanently">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateBinSelectionUI();
        }

        function toggleBinSelectAll(checkbox) {
            const isChecked = checkbox.checked;

            if (isChecked) {
                binInvoices.forEach(inv => selectedBinInvoices.add(inv.id));
            } else {
                selectedBinInvoices.clear();
            }

            document.querySelectorAll('#binTable input.select-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });

            updateBinSelectionUI();
        }

        function toggleBinInvoiceSelect(id) {
            if (selectedBinInvoices.has(id)) {
                selectedBinInvoices.delete(id);
            } else {
                selectedBinInvoices.add(id);
            }

            updateBinSelectionUI();

            // Update select all checkbox state
            const selectAll = document.getElementById('binSelectAll');
            if (selectAll) {
                const allChecked = binInvoices.length > 0 && binInvoices.every(inv => selectedBinInvoices.has(inv.id));
                selectAll.checked = allChecked;
            }
        }

        function updateBinSelectionUI() {
            const count = selectedBinInvoices.size;
            const restoreBtn = document.getElementById('binRestoreBtn');
            const deleteBtn = document.getElementById('binPermanentDeleteBtn');

            restoreBtn.disabled = count === 0;
            deleteBtn.disabled = count === 0;
        }

        async function restoreInvoice(id) {
            const confirmed = await JarvisDialog.confirm('Restore this invoice from the bin?', { title: 'Restore Invoice' });
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/db/invoices/${id}/restore`, {
                    method: 'POST'
                });

                if (response.ok) {
                    loadBinData();
                    loadData();
                } else {
                    const result = await response.json();
                    await JarvisDialog.alert('Error: ' + (result.error || 'Failed to restore'), { type: 'error', title: 'Error' });
                }
            } catch (err) {
                console.error('Restore error:', err);
                await JarvisDialog.alert('Error restoring invoice', { type: 'error', title: 'Error' });
            }
        }

        async function permanentDeleteInvoice(id) {
            const confirmed = await JarvisDialog.confirm('PERMANENTLY delete this invoice? This cannot be undone!', { title: 'Permanent Delete', danger: true });
            if (!confirmed) return;

            try {
                const response = await fetch(`/api/db/invoices/${id}/permanent`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadBinData();
                } else {
                    const result = await response.json();
                    await JarvisDialog.alert('Error: ' + (result.error || 'Failed to delete'), { type: 'error', title: 'Error' });
                }
            } catch (err) {
                console.error('Permanent delete error:', err);
                await JarvisDialog.alert('Error deleting invoice', { type: 'error', title: 'Error' });
            }
        }

        async function bulkRestoreSelected() {
            if (selectedBinInvoices.size === 0) return;

            const confirmed = await JarvisDialog.confirm(`Restore ${selectedBinInvoices.size} invoice(s) from the bin?`, { title: 'Restore Invoices' });
            if (!confirmed) return;

            try {
                const invoice_ids = Array.from(selectedBinInvoices);
                const response = await fetch('/api/db/invoices/bulk-restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    selectedBinInvoices.clear();
                    loadBinData();
                    loadData();
                    await JarvisDialog.alert(`${result.restored_count} invoice(s) restored.`, { type: 'success', title: 'Success' });
                } else {
                    await JarvisDialog.alert('Error: ' + (result.error || 'Failed to restore'), { type: 'error', title: 'Error' });
                }
            } catch (err) {
                console.error('Bulk restore error:', err);
                await JarvisDialog.alert('Error restoring invoices', { type: 'error', title: 'Error' });
            }
        }

        async function bulkPermanentDeleteSelected() {
            if (selectedBinInvoices.size === 0) return;

            const confirmed = await JarvisDialog.confirm(`PERMANENTLY delete ${selectedBinInvoices.size} invoice(s)? This cannot be undone!`, { title: 'Permanent Delete', danger: true });
            if (!confirmed) return;

            try {
                const invoice_ids = Array.from(selectedBinInvoices);
                const response = await fetch('/api/db/invoices/bulk-permanent-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids })
                });

                const result = await response.json();

                if (response.ok) {
                    selectedBinInvoices.clear();
                    loadBinData();
                    await JarvisDialog.alert(`${result.deleted_count} invoice(s) permanently deleted.`, { type: 'success', title: 'Success' });
                } else {
                    await JarvisDialog.alert('Error: ' + (result.error || 'Failed to delete'), { type: 'error', title: 'Error' });
                }
            } catch (err) {
                console.error('Bulk permanent delete error:', err);
                await JarvisDialog.alert('Error deleting invoices', { type: 'error', title: 'Error' });
            }
        }

        // Load bin count on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBinCount();
        });

        // ========== ALLOCATION COMMENT MODAL ==========
        // Open allocation comment modal when clicking comment icon
        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.allocation-comment-btn');
            if (btn) {
                e.preventDefault();
                e.stopPropagation();

                const allocationId = btn.dataset.allocationId;
                const department = btn.dataset.department;
                const brand = btn.dataset.brand;
                const value = btn.dataset.value;
                const percent = btn.dataset.percent;
                const comment = btn.dataset.comment || '';

                // Set modal values
                document.getElementById('allocationCommentId').value = allocationId;
                document.getElementById('allocationCommentText').value = comment;

                // Show allocation details
                let detailsHtml = `<strong>${department}</strong>`;
                if (brand) detailsHtml += ` (${brand})`;
                detailsHtml += `<br>${formatCurrency(parseFloat(value))}  ${percent}%`;
                document.getElementById('allocationCommentDetails').innerHTML = detailsHtml;

                // Open modal
                const modal = new bootstrap.Modal(document.getElementById('allocationCommentModal'));
                modal.show();
            }
        });

        // Save allocation comment
        document.getElementById('saveAllocationCommentBtn').addEventListener('click', async () => {
            const allocationId = document.getElementById('allocationCommentId').value;
            const comment = document.getElementById('allocationCommentText').value;

            try {
                const response = await fetch(`/api/allocations/${allocationId}/comment`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment })
                });

                const data = await response.json();

                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('allocationCommentModal'));
                    modal.hide();

                    // Reload the current view to show updated comment
                    loadInvoices();

                    // Clear cache for this invoice
                    invoicesWithAllocations = {};
                } else {
                    await JarvisDialog.alert('Error saving comment: ' + (data.error || 'Unknown error'), { type: 'error', title: 'Error' });
                }
            } catch (error) {
                console.error('Error saving comment:', error);
                await JarvisDialog.alert('Error saving comment', { type: 'error', title: 'Error' });
            }
        });

        // ============== Theme Toggle ==============
        const themeToggle = document.getElementById('themeToggle');

        // Load saved theme preference
        const savedTheme = localStorage.getItem('jarvisTheme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeToggle.checked = true;
        }

        // Theme toggle handler
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('jarvisTheme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('jarvisTheme', 'light');
            }
        });
    </script>

    <!-- Edit Allocation Comment Modal -->
    <div class="modal fade" id="editAllocationCommentModal" tabindex="-1" aria-labelledby="editAllocationCommentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAllocationCommentModalLabel"><i class="bi bi-chat-text"></i> Allocation Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <small class="text-muted" id="editAllocationCommentInfo"></small>
                    </div>
                    <div class="mb-3">
                        <label for="editAllocationCommentText" class="form-label">Comment</label>
                        <textarea class="form-control" id="editAllocationCommentText" rows="3" placeholder="Add a comment for this allocation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditAllocationComment()">Save Comment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/jarvis-utils.js"></script>
    <script src="/static/js/jarvis-dialogs.js"></script>
    <script src="/static/js/online-users.js"></script>
    {% include 'partials/_edit_profile_modal.html' %}
    <script src="/static/js/theme.js"></script>
</body>
</html>
