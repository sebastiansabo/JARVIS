<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Bulk Processor</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        /* Summary stats bar - matching efactura style */
        .summary-filter-bar { font-size: 0.9rem; }
        .summary-stat { display: flex; align-items: center; gap: 6px; color: var(--bs-secondary-color); }
        .summary-stat i { font-size: 1.1rem; }
        /* File list in modal */
        .file-list .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bs-tertiary-bg);
            border-radius: 4px;
            margin-bottom: 4px;
        }
        .file-list .file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-list .remove-file { cursor: pointer; color: var(--bs-danger); opacity: 0.7; }
        .file-list .remove-file:hover { opacity: 1; }
        /* Drag drop zone */
        .drag-drop-zone {
            border: 2px dashed var(--bs-border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .drag-drop-zone:hover, .drag-drop-zone.dragover {
            border-color: var(--bs-primary);
            background: rgba(var(--bs-primary-rgb), 0.05);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="progress-text">Processing invoices...</div>
    </div>

    {% set current_module = 'accounting' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item active">Bulk Processor</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats (same row) -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2">
            {% set active_page = 'invoices' %}
            {% set inline_nav = true %}
            {% include 'partials/_accounting_nav.html' %}

            <!-- Summary Stats on right -->
            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3" id="summaryStats">
                <span class="summary-stat" title="Total Invoices">
                    <i class="bi bi-cloud-download text-warning"></i>
                    <span id="totalCount" class="text-success fw-bold">0</span> invoices
                </span>
                <span class="summary-stat" title="Total Value">
                    <i class="bi bi-cash-stack text-success"></i>
                    <span id="totalValue" class="fw-bold">0,00</span> <span id="totalCurrency">RON</span>
                </span>
                <span class="summary-stat" title="Suppliers">
                    <i class="bi bi-building text-info"></i>
                    <span id="supplierCount" class="text-info fw-bold">0</span> suppliers
                </span>
                <span class="summary-stat" title="Items">
                    <i class="bi bi-list-ul text-warning"></i>
                    <span id="campaignCount" class="text-warning fw-bold">0</span> items
                </span>
            </div>
        </div>

        <!-- Page Tabs with Upload Button -->
        <div class="d-flex justify-content-between align-items-end mt-3 mb-3 border-bottom">
            <ul class="nav nav-tabs border-bottom-0">
                <li class="nav-item">
                    <a class="nav-link" href="/add-invoice">
                        <i class="bi bi-plus-circle"></i> Add Invoice
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/bulk">
                        <i class="bi bi-stack"></i> Bulk
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/templates">
                        <i class="bi bi-file-earmark-text"></i> Templates
                    </a>
                </li>
            </ul>
        </div>

        <!-- Bulk Distribute Section -->
        <div id="resultsSection">
            {% if current_user.can_add_invoices %}
            <!-- Bulk Distribute Content -->
            <div class="row mt-3">
                <!-- Left: Invoice List (sticky on scroll) -->
                <div class="col-md-4">
                    <div style="position: sticky; top: 1rem;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong><i class="bi bi-receipt"></i> Invoices</strong>
                                <span class="badge bg-primary ms-2" id="invoiceCountBadge">0</span>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush" id="invoiceSelectList">
                                    <!-- Invoices will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selected Invoice Summary -->
                        <div class="card mt-3" id="selectedInvoiceSummary" style="display: none;">
                            <div class="card-header bg-light py-2">
                                <h6 class="mb-0" id="selectedInvoiceTitle">-</h6>
                                <small class="text-muted" id="selectedInvoiceSubtitle">-</small>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Invoice Value</small>
                                    <span class="fw-bold text-success" id="selectedInvoiceValue">-</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Allocated</small>
                                    <span class="fw-bold" id="selectedAllocatedTotal">-</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Total %</small>
                                    <span class="fw-bold" id="selectedTotalPercent">-</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">Validation</small>
                                    <span id="validationStatus">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Campaign Allocation Forms -->
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="bi bi-pie-chart"></i> Cost Distribution</strong>
                                <span class="badge bg-success ms-2" id="campaignCountBadge">0</span>
                                <span class="badge ms-2" id="allocationStatusBadge" style="display:none;">0%</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                    <i class="bi bi-cloud-upload"></i> Upload Invoices
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" id="exportBtn" onclick="exportToExcel()" disabled>
                                    <i class="bi bi-file-earmark-excel"></i> Export Excel
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="transferBtn" onclick="saveToAccounting()" disabled>
                                    <i class="bi bi-check-circle"></i> Save to Accounting
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-2" id="campaignDetailsPanel">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-arrow-left fs-1"></i>
                                <p class="mt-2">Select an invoice to configure allocations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- No permission message -->
            <div class="alert alert-warning">
                <i class="bi bi-lock me-2"></i>You don't have permission to distribute invoices.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">
                        <i class="bi bi-cloud-upload me-2"></i>Upload Invoices
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="drag-drop-zone mb-3" id="dropZone">
                        <i class="bi bi-file-earmark-pdf fs-1 text-muted"></i>
                        <p class="mb-1 mt-2 fs-5">Drag & drop PDF invoices here</p>
                        <p class="mb-0 text-muted">or click to select files</p>
                        <small class="text-muted">Supports multiple PDF files</small>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf" multiple>
                    </div>

                    <!-- File List -->
                    <div id="fileListContainer" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong><span id="fileCount">0</span> files selected</strong>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearFiles()">
                                <i class="bi bi-x-circle"></i> Clear All
                            </button>
                        </div>
                        <div class="file-list" id="fileList" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="processBtn" onclick="processInvoices()" disabled>
                        <i class="bi bi-cpu"></i> Process Invoices
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="notificationModalHeader">
                    <h5 class="modal-title" id="notificationModalLabel">
                        <i class="bi" id="notificationModalIcon"></i>
                        <span id="notificationModalTitle">Notification</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notificationModalBody">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============== Notification Modal Helper ==============
        function showModal(message, type = 'info', title = null) {
            const modal = document.getElementById('notificationModal');
            const modalHeader = document.getElementById('notificationModalHeader');
            const modalIcon = document.getElementById('notificationModalIcon');
            const modalTitle = document.getElementById('notificationModalTitle');
            const modalBody = document.getElementById('notificationModalBody');

            // Reset classes
            modalHeader.className = 'modal-header';
            modalIcon.className = 'bi me-2';

            // Set type-specific styling
            switch(type) {
                case 'success':
                    modalHeader.classList.add('bg-success', 'text-white');
                    modalIcon.classList.add('bi-check-circle-fill');
                    modalTitle.textContent = title || 'Success';
                    break;
                case 'error':
                    modalHeader.classList.add('bg-danger', 'text-white');
                    modalIcon.classList.add('bi-x-circle-fill');
                    modalTitle.textContent = title || 'Error';
                    break;
                case 'warning':
                    modalHeader.classList.add('bg-warning');
                    modalIcon.classList.add('bi-exclamation-triangle-fill');
                    modalTitle.textContent = title || 'Warning';
                    break;
                default: // info
                    modalHeader.classList.add('bg-primary', 'text-white');
                    modalIcon.classList.add('bi-info-circle-fill');
                    modalTitle.textContent = title || 'Information';
            }

            // Handle newlines in message
            modalBody.innerHTML = message.replace(/\n/g, '<br>');

            // Show modal - use getOrCreateInstance to avoid stacking backdrop issues
            const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
            bsModal.show();
        }

        // Toggle Summary Section collapse (now a no-op, keeping for compatibility)
        function toggleSummarySection() {
            // Summary bar is always visible, no collapse needed
        }

        // Close upload modal helper
        function closeUploadModal() {
            const uploadModal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
            if (uploadModal) {
                uploadModal.hide();
            }
        }

        // Close modal after processing (called after processing)
        function collapseSections() {
            // Close upload modal
            closeUploadModal();
        }

        // Store uploaded files
        let uploadedFiles = [];
        let reportData = null;

        // Session storage key for caching invoice data
        const BULK_CACHE_KEY = 'jarvis_bulk_invoice_cache';

        // Save report data to session storage
        function saveToCache(data) {
            try {
                sessionStorage.setItem(BULK_CACHE_KEY, JSON.stringify({
                    timestamp: Date.now(),
                    data: data
                }));
            } catch (e) {
                console.warn('Failed to cache bulk data:', e);
            }
        }

        // Load report data from session storage
        function loadFromCache() {
            try {
                const cached = sessionStorage.getItem(BULK_CACHE_KEY);
                if (cached) {
                    const parsed = JSON.parse(cached);
                    // Cache expires after 1 hour
                    if (Date.now() - parsed.timestamp < 3600000) {
                        return parsed.data;
                    }
                    // Clear expired cache
                    sessionStorage.removeItem(BULK_CACHE_KEY);
                }
            } catch (e) {
                console.warn('Failed to load cached bulk data:', e);
            }
            return null;
        }

        // Clear cache (call after saving to accounting)
        function clearCache() {
            sessionStorage.removeItem(BULK_CACHE_KEY);
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'application/pdf' && !uploadedFiles.some(f => f.name === file.name)) {
                    uploadedFiles.push(file);
                }
            }
            updateFileList();
        }

        function updateFileList() {
            const container = document.getElementById('fileListContainer');
            const list = document.getElementById('fileList');
            const count = document.getElementById('fileCount');
            const processBtn = document.getElementById('processBtn');

            if (uploadedFiles.length > 0) {
                container.style.display = 'block';
                count.textContent = uploadedFiles.length;
                processBtn.disabled = false;

                list.innerHTML = uploadedFiles.map((file, idx) => `
                    <div class="file-item">
                        <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                        <span class="file-name">${file.name}</span>
                        <span class="text-muted small">${formatFileSize(file.size)}</span>
                        <span class="remove-file" onclick="removeFile(${idx})">
                            <i class="bi bi-x-circle"></i>
                        </span>
                    </div>
                `).join('');
            } else {
                container.style.display = 'none';
                processBtn.disabled = true;
            }
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        function clearFiles() {
            uploadedFiles = [];
            updateFileList();
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('exportBtn').disabled = true;
            reportData = null;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            // Handle various date formats
            try {
                const date = new Date(dateStr);
                if (!isNaN(date)) {
                    return date.toLocaleDateString('ro-RO');
                }
            } catch (e) {}
            return dateStr;
        }

        async function processInvoices() {
            if (uploadedFiles.length === 0) return;

            const loadingOverlay = document.getElementById('loadingOverlay');
            const progressText = loadingOverlay.querySelector('.progress-text');
            loadingOverlay.classList.add('show');

            const totalFiles = uploadedFiles.length;

            // Start with existing data if available (allows adding invoices incrementally)
            let allInvoices = reportData?.invoices ? [...reportData.invoices] : [];
            let byItem = reportData?.by_item ? {...reportData.by_item} : {};
            let byCampaign = reportData?.by_campaign ? {...reportData.by_campaign} : {};
            let byMonth = reportData?.by_month ? JSON.parse(JSON.stringify(reportData.by_month)) : {};
            let bySupplier = reportData?.by_supplier ? JSON.parse(JSON.stringify(reportData.by_supplier)) : {};
            let total = reportData?.total || 0;
            let currency = reportData?.currency || 'RON';

            try {
                // Track duplicate invoices
                let duplicateInvoices = [];

                // Process files one at a time for progress display
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const file = uploadedFiles[i];
                    progressText.textContent = `Processing ${i + 1} of ${totalFiles}...`;

                    const formData = new FormData();
                    formData.append('files[]', file);

                    const response = await fetch('/api/bulk/process', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success && data.report) {
                        const report = data.report;
                        // Check for duplicates before adding
                        if (report.invoices) {
                            for (const inv of report.invoices) {
                                const isDuplicate = allInvoices.some(existing =>
                                    existing.invoice_number && inv.invoice_number &&
                                    existing.invoice_number === inv.invoice_number
                                );
                                if (isDuplicate) {
                                    duplicateInvoices.push(inv.invoice_number || file.name);
                                } else {
                                    allInvoices.push(inv);
                                    // Only add to totals if not duplicate
                                    if (report.total) total += inv.invoice_value || 0;
                                }
                            }
                        }
                        if (report.currency) currency = report.currency;

                        // Merge by_item
                        if (report.by_item) {
                            for (const [key, val] of Object.entries(report.by_item)) {
                                byItem[key] = (byItem[key] || 0) + val;
                            }
                        }
                        // Merge by_campaign
                        if (report.by_campaign) {
                            for (const [key, val] of Object.entries(report.by_campaign)) {
                                byCampaign[key] = (byCampaign[key] || 0) + val;
                            }
                        }
                        // Merge by_month (objects with count and total)
                        if (report.by_month) {
                            for (const [key, val] of Object.entries(report.by_month)) {
                                if (!byMonth[key]) byMonth[key] = {count: 0, total: 0};
                                byMonth[key].count += val.count || 0;
                                byMonth[key].total += val.total || 0;
                            }
                        }
                        // Merge by_supplier (objects with count and total)
                        if (report.by_supplier) {
                            for (const [key, val] of Object.entries(report.by_supplier)) {
                                if (!bySupplier[key]) bySupplier[key] = {count: 0, total: 0};
                                bySupplier[key].count += val.count || 0;
                                bySupplier[key].total += val.total || 0;
                            }
                        }
                    }
                }

                // Build combined report
                reportData = {
                    invoices: allInvoices,
                    count: allInvoices.length,
                    total: total,
                    currency: currency,
                    by_item: byItem,
                    by_campaign: byCampaign,
                    by_month: byMonth,
                    by_supplier: bySupplier
                };

                // Cache the report data for page refresh persistence
                saveToCache(reportData);

                displayResults(reportData);
                document.getElementById('exportBtn').disabled = false;

                // Show alert if there were duplicate invoices
                if (duplicateInvoices.length > 0) {
                    showModal(
                        `${duplicateInvoices.length} duplicate invoice(s) skipped:\n\n${duplicateInvoices.join('\n')}`,
                        'warning',
                        'Duplicates Skipped'
                    );
                }

                // Clear the uploaded files list (they've been processed)
                uploadedFiles = [];
                updateFileList();
            } catch (error) {
                showModal('Error: ' + error.message, 'error');
            } finally {
                loadingOverlay.classList.remove('show');
                progressText.textContent = 'Processing invoices...';
            }
        }

        function displayResults(report) {
            // Close upload modal after processing
            collapseSections();

            // Update summary stats bar
            document.getElementById('totalCount').textContent = report.count;
            document.getElementById('totalValue').textContent = formatNumber(report.total);
            document.getElementById('totalCurrency').textContent = report.currency;
            document.getElementById('supplierCount').textContent = Object.keys(report.by_supplier || {}).length;
            document.getElementById('campaignCount').textContent = Object.keys(report.by_campaign || {}).length;

            // Populate invoice list for Bulk Distribute
            renderInvoiceList();

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        async function exportToExcel() {
            if (!reportData) {
                showModal('No data to export. Please process invoices first.', 'warning');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.querySelector('.progress-text').textContent = 'Generating Excel report...';
            loadingOverlay.classList.add('show');

            try {
                const response = await fetch('/api/bulk/export-json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ report: reportData })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Invoice_Report_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const data = await response.json();
                    showModal('Error exporting: ' + data.error, 'error');
                }
            } catch (error) {
                showModal('Error: ' + error.message, 'error');
            } finally {
                loadingOverlay.querySelector('.progress-text').textContent = 'Processing invoices...';
                loadingOverlay.classList.remove('show');
            }
        }

        // ============== Bulk Distribute Functionality ==============
        let selectedInvoiceIndex = null;
        let campaignAllocations = {}; // Store allocations by campaign key: {brand, department, subdepartment}
        let structureData = null;
        let companiesWithVat = []; // Companies with VAT numbers for matching
        let selectedMasterCompany = ''; // The master company for the current invoice
        let mergedCampaigns = []; // Store merged campaign groups: [{keys: [], name: '', value: 0, originalNames: []}]
        let selectedForMerge = new Set(); // Track selected campaign keys for merging
        let savedAllocationPattern = null; // Saved pattern for copy/apply: {company, campaignNames: [], allocations: [{brand, department, subdepartment, reinvoice, reinvoiceDestinations}]}

        // ============== Copy/Apply Pattern Functions ==============

        // Calculate string similarity using Dice coefficient
        function stringSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            str1 = str1.toLowerCase().trim();
            str2 = str2.toLowerCase().trim();
            if (str1 === str2) return 1;

            // Create bigrams
            const bigrams1 = new Set();
            const bigrams2 = new Set();
            for (let i = 0; i < str1.length - 1; i++) bigrams1.add(str1.substr(i, 2));
            for (let i = 0; i < str2.length - 1; i++) bigrams2.add(str2.substr(i, 2));

            // Calculate intersection
            let intersection = 0;
            for (const bigram of bigrams1) {
                if (bigrams2.has(bigram)) intersection++;
            }

            return (2 * intersection) / (bigrams1.size + bigrams2.size);
        }

        // Extract key parts from campaign name for matching
        function extractCampaignFeatures(name) {
            if (!name) return {};
            const lower = name.toLowerCase();

            // Common campaign types
            const types = ['leads', 'traffic', 'awareness', 'conversion', 'engagement', 'reach', 'video', 'catalog', 'app'];
            const foundType = types.find(t => lower.includes(t));

            // Extract brand/product (typically after hyphen or in brackets)
            const brandMatch = name.match(/[-–]\s*([^-–]+)$/i) || name.match(/\[([^\]]+)\]/);
            const brand = brandMatch ? brandMatch[1].trim() : '';

            // Extract prefix (typically in [XX] format at start)
            const prefixMatch = name.match(/^\[([^\]]+)\]/);
            const prefix = prefixMatch ? prefixMatch[1].trim() : '';

            return { type: foundType || '', brand, prefix, original: name };
        }

        // Match items using exact name matching first, then similarity as fallback
        function matchCampaignsLocal(sourceCampaigns, targetCampaigns) {
            const mapping = {};
            const usedSources = new Set();

            // Normalize name for comparison (lowercase, trim whitespace)
            const normalize = (name) => name.toLowerCase().trim();

            // FIRST PASS: Exact name matches (highest priority)
            targetCampaigns.forEach((target, targetIdx) => {
                const targetNorm = normalize(target);
                sourceCampaigns.forEach((source, sourceIdx) => {
                    if (usedSources.has(sourceIdx)) return;
                    if (mapping[targetIdx] !== undefined) return;

                    // Exact match (case-insensitive)
                    if (normalize(source) === targetNorm) {
                        mapping[targetIdx] = sourceIdx;
                        usedSources.add(sourceIdx);
                        console.log(`Exact match: "${target}" -> "${source}"`);
                    }
                });
            });

            // SECOND PASS: High similarity matches for remaining items
            targetCampaigns.forEach((target, targetIdx) => {
                if (mapping[targetIdx] !== undefined) return; // Already matched

                const targetFeatures = extractCampaignFeatures(target);
                let bestMatch = -1;
                let bestScore = 0;

                sourceCampaigns.forEach((source, sourceIdx) => {
                    if (usedSources.has(sourceIdx)) return;

                    const sourceFeatures = extractCampaignFeatures(source);

                    // Calculate match score
                    let score = stringSimilarity(target, source);

                    // Boost score if campaign type matches
                    if (targetFeatures.type && targetFeatures.type === sourceFeatures.type) {
                        score += 0.3;
                    }

                    // Boost score if prefix matches (e.g., [CA], [IG])
                    if (targetFeatures.prefix && targetFeatures.prefix === sourceFeatures.prefix) {
                        score += 0.2;
                    }

                    // Boost score if brands are similar
                    if (targetFeatures.brand && sourceFeatures.brand) {
                        score += stringSimilarity(targetFeatures.brand, sourceFeatures.brand) * 0.3;
                    }

                    if (score > bestScore) {
                        bestScore = score;
                        bestMatch = sourceIdx;
                    }
                });

                // Only use match if score is reasonable (> 0.3)
                if (bestScore > 0.3 && bestMatch >= 0) {
                    mapping[targetIdx] = bestMatch;
                    usedSources.add(bestMatch);
                    console.log(`Similarity match (${bestScore.toFixed(2)}): "${target}" -> "${sourceCampaigns[bestMatch]}"`);
                }
            });

            // THIRD PASS: Assign remaining targets to remaining sources sequentially
            let remainingSourceIdx = 0;
            targetCampaigns.forEach((target, targetIdx) => {
                if (mapping[targetIdx] === undefined) {
                    // Find next unused source
                    while (usedSources.has(remainingSourceIdx) && remainingSourceIdx < sourceCampaigns.length) {
                        remainingSourceIdx++;
                    }
                    if (remainingSourceIdx < sourceCampaigns.length) {
                        mapping[targetIdx] = remainingSourceIdx;
                        usedSources.add(remainingSourceIdx);
                        remainingSourceIdx++;
                    } else {
                        // Cycle through sources if we run out
                        mapping[targetIdx] = targetIdx % sourceCampaigns.length;
                    }
                }
            });

            return mapping;
        }

        function copyAllocationPattern() {
            if (selectedInvoiceIndex === null) return;

            const inv = reportData?.invoices[selectedInvoiceIndex];
            if (!inv) return;

            // Get current company
            const company = selectedMasterCompany;
            if (!company) {
                showModal('Please select a company first before copying the pattern.', 'warning', 'Copy Pattern');
                return;
            }

            // Get all visible campaign keys (not hidden by merge)
            const panel = document.getElementById('campaignDetailsPanel');
            const visibleItems = panel.querySelectorAll('.distribute-item:not(.merged-hidden)');

            if (visibleItems.length === 0) {
                showModal('No allocations to copy.', 'warning', 'Copy Pattern');
                return;
            }

            // Extract allocation settings and campaign names from each visible campaign
            // Read actual dropdown values from DOM to ensure we capture all selections
            const allocations = [];
            const campaignNames = [];
            visibleItems.forEach(item => {
                const key = item.dataset.campaignKey;
                const alloc = campaignAllocations[key] || {};

                // Get campaign name from the header
                const nameElem = item.querySelector('.campaign-name');
                const campaignName = nameElem ? nameElem.textContent.trim() : key;
                campaignNames.push(campaignName);

                // Read actual dropdown values from DOM (more reliable than campaignAllocations)
                const brandSelect = item.querySelector('.campaign-brand-select');
                const deptSelect = item.querySelector('.campaign-department-select');
                const subdeptSelect = item.querySelector('.campaign-subdept-select');
                const reinvoiceCheck = item.querySelector('.campaign-reinvoice-check');

                allocations.push({
                    brand: brandSelect?.value || alloc.brand || '',
                    department: deptSelect?.value || alloc.department || '',
                    subdepartment: subdeptSelect?.value || alloc.subdepartment || '',
                    reinvoice: reinvoiceCheck?.checked || alloc.reinvoice || false,
                    reinvoiceDestinations: alloc.reinvoiceDestinations ? JSON.parse(JSON.stringify(alloc.reinvoiceDestinations)) : []
                });
            });

            // Save the pattern with campaign names for AI matching
            savedAllocationPattern = {
                company: company,
                campaignNames: campaignNames,
                allocations: allocations
            };

            // Update Apply button state (if it exists)
            const applyBtnRef = document.getElementById('applyPatternBtn');
            if (applyBtnRef) {
                applyBtnRef.disabled = false;
                applyBtnRef.classList.remove('btn-outline-secondary');
                applyBtnRef.classList.add('btn-primary');
            }

            showModal(`Pattern copied: ${company} with ${allocations.length} allocation(s). Click "Apply Pattern" on another invoice to use it.`, 'success', 'Pattern Copied');
        }

        async function applyAllocationPattern() {
            if (!savedAllocationPattern) {
                showModal('No pattern saved. First copy a pattern from another invoice.', 'warning', 'Apply Pattern');
                return;
            }

            if (selectedInvoiceIndex === null) return;

            const inv = reportData?.invoices[selectedInvoiceIndex];
            if (!inv) return;

            // Get campaign entries
            const campaignEntries = Object.entries(inv.campaigns || {});
            if (campaignEntries.length === 0) return;

            const pattern = savedAllocationPattern;

            // Set the company
            const masterSelect = document.getElementById('masterCompanySelect');
            if (masterSelect && pattern.company) {
                masterSelect.value = pattern.company;
                selectedMasterCompany = pattern.company;
            }

            // Get visible items (not merged-hidden)
            const panel = document.getElementById('campaignDetailsPanel');
            const visibleItems = Array.from(panel.querySelectorAll('.distribute-item:not(.merged-hidden)'));

            // Get target campaign names for AI matching
            const targetCampaignNames = visibleItems.map(item => {
                const nameElem = item.querySelector('.campaign-name');
                return nameElem ? nameElem.textContent.trim() : item.dataset.campaignKey;
            });

            // Use JavaScript matching first (fast), AI as fallback for complex cases
            let campaignMapping = {};
            let matchingMethod = 'sequential';

            if (pattern.campaignNames && pattern.campaignNames.length > 0 && targetCampaignNames.length > 0) {
                // First try local JavaScript matching
                campaignMapping = matchCampaignsLocal(pattern.campaignNames, targetCampaignNames);
                matchingMethod = 'local';
                console.log('Local campaign mapping:', campaignMapping);

                // Calculate average match confidence
                let totalConfidence = 0;
                let lowConfidenceCount = 0;
                targetCampaignNames.forEach((target, idx) => {
                    const sourceIdx = campaignMapping[idx];
                    if (sourceIdx !== undefined) {
                        const confidence = stringSimilarity(target, pattern.campaignNames[sourceIdx]);
                        totalConfidence += confidence;
                        if (confidence < 0.3) lowConfidenceCount++;
                    }
                });
                const avgConfidence = totalConfidence / targetCampaignNames.length;

                // If local matching has low confidence, try AI as fallback
                if (avgConfidence < 0.4 || lowConfidenceCount > targetCampaignNames.length * 0.5) {
                    try {
                        // Show loading indicator
                        const applyBtn = document.getElementById('applyPatternBtn');
                        let originalBtnHtml = '';
                        if (applyBtn) {
                            originalBtnHtml = applyBtn.innerHTML;
                            applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> AI Matching...';
                            applyBtn.disabled = true;
                        }

                        const response = await fetch('/api/bulk/match-campaigns', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                source_campaigns: pattern.campaignNames,
                                target_campaigns: targetCampaignNames
                            })
                        });

                        const result = await response.json();
                        if (result.success && result.mapping) {
                            campaignMapping = result.mapping;
                            matchingMethod = 'AI';
                            console.log('AI campaign mapping:', campaignMapping);
                        }

                        // Restore button
                        if (applyBtn) {
                            applyBtn.innerHTML = originalBtnHtml;
                            applyBtn.disabled = false;
                        }
                    } catch (err) {
                        console.error('AI matching failed, using local matching:', err);
                        // Keep local matching results
                        const applyBtn = document.getElementById('applyPatternBtn');
                        if (applyBtn) {
                            applyBtn.innerHTML = '<i class="bi bi-clipboard-check"></i> Apply Pattern';
                            applyBtn.disabled = false;
                        }
                    }
                }
            }

            console.log('Applying pattern:', pattern);
            console.log('Campaign mapping:', campaignMapping);

            // Apply pattern to each visible campaign using AI mapping or sequential fallback
            visibleItems.forEach((item, idx) => {
                const key = item.dataset.campaignKey;
                // Use AI mapping if available, otherwise fall back to sequential/cycling
                const sourceIdx = campaignMapping[idx] !== undefined
                    ? campaignMapping[idx]
                    : (idx % pattern.allocations.length);
                const patternAlloc = pattern.allocations[sourceIdx];

                console.log(`Applying to ${key}: sourceIdx=${sourceIdx}, patternAlloc=`, patternAlloc);

                if (!patternAlloc) return;

                // Initialize allocation if needed
                if (!campaignAllocations[key]) {
                    campaignAllocations[key] = {};
                }

                // Apply pattern values
                campaignAllocations[key].brand = patternAlloc.brand;
                campaignAllocations[key].department = patternAlloc.department;
                campaignAllocations[key].subdepartment = patternAlloc.subdepartment;
                campaignAllocations[key].reinvoice = patternAlloc.reinvoice;
                if (patternAlloc.reinvoiceDestinations && patternAlloc.reinvoiceDestinations.length > 0) {
                    campaignAllocations[key].reinvoiceDestinations = JSON.parse(JSON.stringify(patternAlloc.reinvoiceDestinations));
                }

                // Update dropdowns - first set the values in the DOM directly
                const brandSelect = item.querySelector('.campaign-brand-select');
                const deptSelect = item.querySelector('.campaign-department-select');

                // Populate dropdowns with company data
                populateCampaignDropdowns(key, pattern.company, campaignAllocations[key]);

                // Force set the values after populating (in case populateCampaignDropdowns didn't set them)
                if (brandSelect && patternAlloc.brand) {
                    brandSelect.value = patternAlloc.brand;
                }
                if (deptSelect && patternAlloc.department) {
                    deptSelect.value = patternAlloc.department;
                }

                // Update subdepartment if department is set
                if (patternAlloc.department) {
                    populateCampaignSubdepts(key, pattern.company, patternAlloc.department, patternAlloc.subdepartment);
                    updateCampaignManager(key, pattern.company, patternAlloc.department, patternAlloc.brand, patternAlloc.subdepartment);
                }

                // Handle reinvoice section
                const reinvoiceCheck = item.querySelector('.campaign-reinvoice-check');
                const reinvoiceSection = item.querySelector('.reinvoice-section');
                const reinvoiceBadge = item.querySelector('.reinvoice-total-badge');
                const reinvoiceContainer = item.querySelector('.reinvoice-lines-container');

                if (patternAlloc.reinvoice && reinvoiceCheck) {
                    reinvoiceCheck.checked = true;
                    if (reinvoiceSection) reinvoiceSection.style.display = 'block';
                    if (reinvoiceBadge) reinvoiceBadge.style.display = 'inline';

                    // Clear existing lines and add from pattern
                    if (reinvoiceContainer) {
                        reinvoiceContainer.innerHTML = '';

                        // Add reinvoice lines with delay to allow dropdowns to populate
                        if (patternAlloc.reinvoiceDestinations && patternAlloc.reinvoiceDestinations.length > 0) {
                            patternAlloc.reinvoiceDestinations.forEach((dest, destIdx) => {
                                setTimeout(() => {
                                    addReinvoiceLine(key, false);

                                    // Set values after dropdown populates
                                    setTimeout(() => {
                                        const lines = reinvoiceContainer.querySelectorAll('.reinvoice-line');
                                        const line = lines[destIdx];
                                        if (line) {
                                            const companySelect = line.querySelector('.reinvoice-company');
                                            if (companySelect && dest.company) {
                                                companySelect.value = dest.company;
                                                companySelect.dispatchEvent(new Event('change'));

                                                // Set brand/dept/subdept after company change populates dropdowns
                                                setTimeout(() => {
                                                    const brandSelect = line.querySelector('.reinvoice-brand');
                                                    const deptSelect = line.querySelector('.reinvoice-dept');
                                                    if (brandSelect && dest.brand) brandSelect.value = dest.brand;
                                                    if (deptSelect && dest.department) {
                                                        deptSelect.value = dest.department;
                                                        deptSelect.dispatchEvent(new Event('change'));

                                                        setTimeout(() => {
                                                            const subdeptSelect = line.querySelector('.reinvoice-subdept');
                                                            if (subdeptSelect && dest.subdepartment) subdeptSelect.value = dest.subdepartment;
                                                        }, 50);
                                                    }
                                                }, 50);
                                            }

                                            // Set percent/value
                                            const percentInput = line.querySelector('.reinvoice-percent');
                                            const valueInput = line.querySelector('.reinvoice-value');
                                            if (percentInput && dest.percent) percentInput.value = dest.percent;
                                            if (valueInput && dest.value) {
                                                // Recalculate value based on current allocation value
                                                const allocValue = parseFloat(item.querySelector('.campaign-value-input')?.value) || 0;
                                                valueInput.value = ((allocValue * (dest.percent || 0)) / 100).toFixed(2);
                                            }
                                        }

                                        updateReinvoiceTotalBadge(key);
                                    }, 100);
                                }, destIdx * 150);
                            });
                        }
                    }
                } else if (reinvoiceCheck) {
                    reinvoiceCheck.checked = false;
                    if (reinvoiceSection) reinvoiceSection.style.display = 'none';
                    if (reinvoiceBadge) reinvoiceBadge.style.display = 'none';
                }
            });

            // Update summary
            setTimeout(() => {
                updateAllocationSummary();
            }, 500);

            const methodDesc = matchingMethod === 'AI' ? ' (AI matched)' : matchingMethod === 'local' ? ' (auto-matched)' : '';
            showModal(`Pattern applied${methodDesc}: ${pattern.company} with ${pattern.allocations.length} allocation template(s) to ${visibleItems.length} item(s).`, 'success', 'Pattern Applied');
        }

        // ============== Merge Functions ==============

        // Merge Similar Items - uses AI to find items that should be merged
        // AI groups items by: same campaign type (Leads, Traffic) + same brand (Mazda, Volvo)
        async function mergeSimilarItems() {
            if (selectedInvoiceIndex === null) {
                showModal('Please select an invoice first.', 'warning');
                return;
            }

            const inv = reportData?.invoices[selectedInvoiceIndex];
            if (!inv) return;

            const panel = document.getElementById('campaignDetailsPanel');
            const visibleItems = Array.from(panel.querySelectorAll('.distribute-item:not(.merged-hidden)'));

            if (visibleItems.length < 2) {
                showModal('Need at least 2 items to merge.', 'info');
                return;
            }

            // Collect all item names and their keys
            const itemsData = visibleItems.map(item => ({
                key: item.dataset.campaignKey,
                name: item.dataset.campaignName,
                value: parseFloat(item.dataset.campaignValue) || 0,
                element: item
            }));

            // Normalize function for comparison
            const normalize = (name) => name.toLowerCase().trim();

            // FIRST PASS: Group items by exact name match (instant, no AI)
            const exactGroups = {};
            itemsData.forEach(item => {
                const normName = normalize(item.name);
                if (!exactGroups[normName]) {
                    exactGroups[normName] = [];
                }
                exactGroups[normName].push(item);
            });

            const exactMergeGroups = Object.values(exactGroups).filter(g => g.length >= 2);
            let mergedCount = 0;

            // Perform exact merges first
            for (const group of exactMergeGroups) {
                selectedForMerge.clear();
                group.forEach(item => {
                    selectedForMerge.add(item.key);
                    item.element.classList.add('selected-for-merge');
                    const checkbox = item.element.querySelector('.campaign-merge-checkbox');
                    if (checkbox) checkbox.checked = true;
                });

                const campaigns = inv.campaigns || {};
                const campaignEntries = Object.entries(campaigns);
                const invoiceValue = inv.invoice_value || 0;

                performMergeCampaigns(selectedInvoiceIndex, campaignEntries, invoiceValue);
                mergedCount++;
            }

            // SECOND PASS: Use AI to find similar items to merge
            const remainingItems = Array.from(panel.querySelectorAll('.distribute-item:not(.merged-hidden)'));

            if (remainingItems.length >= 2) {
                const remainingData = remainingItems.map(item => ({
                    key: item.dataset.campaignKey,
                    name: item.dataset.campaignName,
                    value: parseFloat(item.dataset.campaignValue) || 0
                }));

                // Show loading indicator
                const btn = document.getElementById('mergeSimilarBtn');
                let originalBtnHtml = '';
                if (btn) {
                    originalBtnHtml = btn.innerHTML;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> AI Analyzing...';
                    btn.disabled = true;
                }

                try {
                    // Call AI to group similar items
                    const response = await fetch('/api/bulk/group-similar-items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            items: remainingData.map(i => i.name)
                        })
                    });

                    const result = await response.json();

                    if (result.success && result.groups && result.groups.length > 0) {
                        // Filter to only groups with 2+ items
                        const aiGroups = result.groups.filter(g => g.length >= 2);

                        if (aiGroups.length > 0) {
                            // Build group descriptions for confirmation
                            const groupDescriptions = aiGroups.map((indices, i) => {
                                const names = indices.map(idx => remainingData[idx]?.name || '?');
                                return `Group ${i + 1}: ${names.join(' + ')}`;
                            }).join('\n');

                            const confirmed = await JarvisDialog.confirm(
                                `AI found ${aiGroups.length} group(s) of similar items:\n\n${groupDescriptions}\n\nMerge these items?`
                            );

                            if (confirmed) {
                                for (const indices of aiGroups) {
                                    selectedForMerge.clear();
                                    indices.forEach(idx => {
                                        const item = remainingData[idx];
                                        if (item) {
                                            selectedForMerge.add(item.key);
                                            const elem = document.querySelector(`.distribute-item[data-campaign-key="${item.key}"]`);
                                            if (elem) {
                                                elem.classList.add('selected-for-merge');
                                                const checkbox = elem.querySelector('.campaign-merge-checkbox');
                                                if (checkbox) checkbox.checked = true;
                                            }
                                        }
                                    });

                                    const campaigns = inv.campaigns || {};
                                    const campaignEntries = Object.entries(campaigns);
                                    const invoiceValue = inv.invoice_value || 0;

                                    performMergeCampaigns(selectedInvoiceIndex, campaignEntries, invoiceValue);
                                    mergedCount++;
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error('AI grouping failed:', err);
                } finally {
                    if (btn) {
                        btn.innerHTML = originalBtnHtml;
                        btn.disabled = false;
                    }
                }
            }

            // Clear selection
            clearMergeSelection();

            if (mergedCount > 0) {
                showModal(`Merged ${mergedCount} group(s) of items.`, 'success', 'Items Merged');
            } else {
                showModal('No similar items found to merge.', 'info');
            }
        }

        function updateMergeToolbar() {
            const toolbar = document.getElementById('mergeToolbar');
            const countSpan = document.getElementById('mergeSelectionCount');

            if (selectedForMerge.size > 0) {
                toolbar.style.display = 'block';
                countSpan.textContent = selectedForMerge.size;
            } else {
                toolbar.style.display = 'none';
            }
        }

        function clearMergeSelection() {
            selectedForMerge.forEach(key => {
                const checkbox = document.querySelector(`.campaign-merge-checkbox[data-key="${key}"]`);
                const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
                if (checkbox) checkbox.checked = false;
                if (item) item.classList.remove('selected-for-merge');
            });
            selectedForMerge.clear();
            updateMergeToolbar();
        }

        function performMergeCampaigns(invoiceIdx, campaignEntries, invoiceValue) {
            // Gather selected campaign data with their allocation settings
            const selectedCampaigns = [];
            let totalMergedValue = 0;

            selectedForMerge.forEach(key => {
                const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
                if (item) {
                    const name = item.dataset.campaignName;
                    const value = parseFloat(item.dataset.campaignValue) || 0;
                    const alloc = campaignAllocations[key] || {};

                    // Get current dropdown values
                    const brandSelect = item.querySelector('.campaign-brand-select');
                    const deptSelect = item.querySelector('.campaign-department-select');
                    const subdeptSelect = item.querySelector('.campaign-subdept-select');
                    const reinvoiceCheck = item.querySelector('.campaign-reinvoice-check');

                    // Get reinvoice destinations if reinvoice is checked
                    let reinvoiceDestinations = [];
                    if (reinvoiceCheck?.checked) {
                        reinvoiceDestinations = getReinvoiceDestinations(key);
                    }

                    selectedCampaigns.push({
                        key,
                        name,
                        value,
                        brand: brandSelect?.value || '',
                        department: deptSelect?.value || '',
                        subdepartment: subdeptSelect?.value || '',
                        reinvoice: reinvoiceCheck?.checked || false,
                        reinvoiceDestinations
                    });
                    totalMergedValue += value;
                }
            });

            if (selectedCampaigns.length < 2) {
                showModal('Select at least 2 items to merge.', 'warning');
                return;
            }

            // Validate that all campaigns have the same allocation settings
            const first = selectedCampaigns[0];
            let differences = [];

            for (let i = 1; i < selectedCampaigns.length; i++) {
                const current = selectedCampaigns[i];

                if (current.brand !== first.brand) {
                    differences.push(`Brand differs: "${first.name}" has "${first.brand || 'N/A'}" vs "${current.name}" has "${current.brand || 'N/A'}"`);
                }
                if (current.department !== first.department) {
                    differences.push(`Department differs: "${first.name}" has "${first.department || 'None'}" vs "${current.name}" has "${current.department || 'None'}"`);
                }
                if (current.subdepartment !== first.subdepartment) {
                    differences.push(`Subdepartment differs: "${first.name}" has "${first.subdepartment || 'N/A'}" vs "${current.name}" has "${current.subdepartment || 'N/A'}"`);
                }
                if (current.reinvoice !== first.reinvoice) {
                    differences.push(`Reinvoice setting differs: "${first.name}" is ${first.reinvoice ? 'ON' : 'OFF'} vs "${current.name}" is ${current.reinvoice ? 'ON' : 'OFF'}`);
                }

                // Check reinvoice destinations if both have reinvoice enabled
                if (first.reinvoice && current.reinvoice) {
                    const firstDests = JSON.stringify(first.reinvoiceDestinations.map(d => ({ company: d.company, department: d.department, subdepartment: d.subdepartment })));
                    const currentDests = JSON.stringify(current.reinvoiceDestinations.map(d => ({ company: d.company, department: d.department, subdepartment: d.subdepartment })));
                    if (firstDests !== currentDests) {
                        differences.push(`Reinvoice destinations differ between "${first.name}" and "${current.name}"`);
                    }
                }
            }

            if (differences.length > 0) {
                showModal('Cannot merge items with different allocation settings:\n\n• ' + differences.join('\n• ') + '\n\nPlease ensure all selected items have the same Brand, Department, Subdepartment, and Reinvoice settings before merging.', 'error', 'Merge Not Allowed');
                return;
            }

            // Create merged campaign name
            const mergedName = `Merged: ${selectedCampaigns.map(c => c.name).join(' + ')}`;
            const mergedPercent = invoiceValue > 0 ? (totalMergedValue / invoiceValue) * 100 : 0;

            // Create a new merged entry
            const mergedKey = `merged_${Date.now()}`;
            const mergedEntry = {
                keys: selectedCampaigns.map(c => c.key),
                name: mergedName,
                value: totalMergedValue,
                originalNames: selectedCampaigns.map(c => c.name)
            };

            mergedCampaigns.push(mergedEntry);

            // Initialize allocation for merged campaign - preserve the allocation settings from first campaign
            campaignAllocations[mergedKey] = {
                allocation_percent: mergedPercent,
                allocation_value: totalMergedValue,
                merged: true,
                originalKeys: selectedCampaigns.map(c => c.key),
                originalNames: selectedCampaigns.map(c => c.name),
                brand: first.brand,
                department: first.department,
                subdepartment: first.subdepartment,
                reinvoice: first.reinvoice,
                reinvoiceDestinations: first.reinvoiceDestinations
            };

            // Hide original campaign items and create merged item
            const panel = document.getElementById('campaignDetailsPanel');
            const inv = reportData?.invoices[selectedInvoiceIndex];
            const currency = inv?.currency || 'RON';

            // Hide selected campaigns
            selectedCampaigns.forEach(c => {
                const item = document.querySelector(`.distribute-item[data-campaign-key="${c.key}"]`);
                if (item) {
                    item.style.display = 'none';
                    item.classList.add('merged-hidden');
                }
            });

            // Create merged campaign UI element with preserved settings
            const mergedHtml = createMergedCampaignHtml(mergedKey, mergedEntry, mergedPercent, currency, invoiceIdx, campaignEntries, invoiceValue, first);
            // Insert after the sticky header, not inside it
            const stickyHeader = document.querySelector('.sticky-panel-header');
            stickyHeader.insertAdjacentHTML('afterend', mergedHtml);

            // Attach event listeners to the new merged item
            attachMergedCampaignListeners(mergedKey, invoiceIdx, campaignEntries, invoiceValue);

            // Initialize dropdowns for merged campaign with preserved values
            if (selectedMasterCompany) {
                populateCampaignDropdowns(mergedKey, selectedMasterCompany, campaignAllocations[mergedKey]);

                // Restore reinvoice settings if enabled
                if (first.reinvoice && first.reinvoiceDestinations.length > 0) {
                    const mergedItem = document.querySelector(`.distribute-item[data-campaign-key="${mergedKey}"]`);
                    if (mergedItem) {
                        const reinvoiceCheck = mergedItem.querySelector('.campaign-reinvoice-check');
                        const reinvoiceSection = mergedItem.querySelector('.reinvoice-section');
                        const reinvoiceBadge = mergedItem.querySelector('.reinvoice-total-badge');

                        if (reinvoiceCheck) {
                            reinvoiceCheck.checked = true;
                            if (reinvoiceSection) reinvoiceSection.style.display = 'block';
                            if (reinvoiceBadge) reinvoiceBadge.style.display = 'inline';

                            // Add reinvoice lines with preserved destinations
                            first.reinvoiceDestinations.forEach((dest, idx) => {
                                addReinvoiceLine(mergedKey, false);
                                const container = mergedItem.querySelector('.reinvoice-lines-container');
                                const line = container.lastElementChild;
                                if (line) {
                                    // Set company and trigger change to populate departments
                                    const companySelect = line.querySelector('.reinvoice-company');
                                    if (companySelect && dest.company) {
                                        companySelect.value = dest.company;
                                        companySelect.dispatchEvent(new Event('change'));

                                        // Wait a tick for departments to populate, then set values
                                        setTimeout(() => {
                                            const brandSelect = line.querySelector('.reinvoice-brand');
                                            const deptSelect = line.querySelector('.reinvoice-department');
                                            if (brandSelect && dest.brand) brandSelect.value = dest.brand;
                                            if (deptSelect && dest.department) {
                                                deptSelect.value = dest.department;
                                                deptSelect.dispatchEvent(new Event('change'));

                                                // Wait for subdepts to populate
                                                setTimeout(() => {
                                                    const subdeptSelect = line.querySelector('.reinvoice-subdepartment');
                                                    if (subdeptSelect && dest.subdepartment) subdeptSelect.value = dest.subdepartment;
                                                }, 50);
                                            }

                                            // Set value and percentage
                                            const valueInput = line.querySelector('.reinvoice-value');
                                            const percentInput = line.querySelector('.reinvoice-percent');
                                            if (valueInput) valueInput.value = dest.value?.toFixed(2) || '0.00';
                                            if (percentInput) percentInput.value = dest.percent?.toFixed(2) || '0.00';
                                        }, 50);
                                    }
                                }
                            });

                            updateReinvoiceTotalBadge(mergedKey);
                        }
                    }
                }
            }

            // Clear selection
            clearMergeSelection();

            // Update campaign count badge
            const visibleCampaigns = panel.querySelectorAll('.distribute-item:not(.merged-hidden)').length;
            document.getElementById('campaignCountBadge').textContent = visibleCampaigns;

            // Update allocation summary
            updateAllocationSummary();

            showModal(`Merged ${selectedCampaigns.length} items into "${mergedName}" with total value ${formatNumber(totalMergedValue)} ${currency}`, 'success', 'Items Merged');
        }

        function createMergedCampaignHtml(key, mergedEntry, percent, currency, invoiceIdx, campaignEntries, invoiceValue) {
            const companies = [...new Set(structureData.map(s => s.company))];

            return `
                <div class="distribute-item merged-campaign" data-campaign-key="${key}" data-campaign-name="${mergedEntry.name}" data-campaign-value="${mergedEntry.value}">
                    <div class="item-header">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-collection-fill text-success me-2" title="Merged campaign"></i>
                            <strong class="text-success">${mergedEntry.name}</strong>
                            <span class="badge bg-success text-white ms-2">${formatNumber(mergedEntry.value)} ${currency}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger ms-2 unmerge-btn" data-key="${key}" title="Unmerge items">
                                <i class="bi bi-x-lg"></i> Unmerge
                            </button>
                        </div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-sm btn-outline-info campaign-comment-btn" data-key="${key}" title="Add comment">
                                <i class="bi bi-chat-text"></i>
                            </button>
                            <input type="hidden" class="campaign-comment-input" data-key="${key}" value="">
                        </div>
                    </div>
                    <div class="merged-campaigns-list mb-2">
                        <i class="bi bi-arrow-return-right"></i> Contains: ${mergedEntry.originalNames.join(', ')}
                    </div>
                    <div class="allocation-form">
                        <div class="row g-2 align-items-end">
                            <div class="col campaign-brand-col d-none" data-key="${key}">
                                <label class="form-label small mb-1">Brand</label>
                                <select class="form-select form-select-sm campaign-brand-select" data-key="${key}">
                                    <option value="">N/A</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label small mb-1">Department *</label>
                                <select class="form-select form-select-sm campaign-department-select" data-key="${key}">
                                    <option value="">Select...</option>
                                </select>
                            </div>
                            <div class="col campaign-subdept-col d-none" data-key="${key}">
                                <label class="form-label small mb-1">Subdepartment</label>
                                <select class="form-select form-select-sm campaign-subdept-select" data-key="${key}">
                                    <option value="">N/A</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label small mb-1">%</label>
                                <input type="number" class="form-control form-control-sm campaign-percent-input"
                                       data-key="${key}" value="${percent.toFixed(2)}" step="0.01" min="0" max="100">
                            </div>
                            <div class="col">
                                <label class="form-label small mb-1">Value</label>
                                <input type="number" class="form-control form-control-sm campaign-value-input"
                                       data-key="${key}" value="${mergedEntry.value.toFixed(2)}" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="row g-2 mt-1 align-items-center">
                            <div class="col-md-4">
                                <small class="text-muted campaign-manager-display" data-key="${key}">Manager: --</small>
                            </div>
                            <div class="col-md-8">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input campaign-reinvoice-check" type="checkbox" data-key="${key}">
                                    <label class="form-check-label small">Reinvoice to:</label>
                                    <span class="badge bg-secondary ms-1 reinvoice-total-badge" data-key="${key}" style="display: none;">0%</span>
                                </div>
                            </div>
                        </div>
                        <div class="reinvoice-section" data-key="${key}" style="display: none;">
                            <div class="reinvoice-lines-container mt-2" data-key="${key}">
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2 add-reinvoice-line-btn" data-key="${key}">
                                <i class="bi bi-plus"></i> Add Reinvoice Line
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function attachMergedCampaignListeners(key, invoiceIdx, campaignEntries, invoiceValue) {
            const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
            if (!item) return;

            // Department change
            const deptSelect = item.querySelector('.campaign-department-select');
            deptSelect?.addEventListener('change', function() {
                onCampaignDepartmentChange(key, this.value);
            });

            // Brand change
            const brandSelect = item.querySelector('.campaign-brand-select');
            brandSelect?.addEventListener('change', function() {
                onCampaignFieldChange(key, 'brand', this.value);
            });

            // Subdepartment change
            const subdeptSelect = item.querySelector('.campaign-subdept-select');
            subdeptSelect?.addEventListener('change', function() {
                onCampaignFieldChange(key, 'subdepartment', this.value);
            });

            // Percent input
            const percentInput = item.querySelector('.campaign-percent-input');
            percentInput?.addEventListener('input', function() {
                const percent = parseFloat(this.value) || 0;
                const inv = reportData?.invoices[selectedInvoiceIndex];
                const newValue = (inv.invoice_value * percent) / 100;

                const valueInput = item.querySelector('.campaign-value-input');
                if (valueInput) valueInput.value = newValue.toFixed(2);

                onCampaignFieldChange(key, 'allocation_percent', percent);
                onCampaignFieldChange(key, 'allocation_value', newValue);
                updateAllocationSummary();
            });

            // Value input
            const valueInput = item.querySelector('.campaign-value-input');
            valueInput?.addEventListener('input', function() {
                const value = parseFloat(this.value) || 0;
                const inv = reportData?.invoices[selectedInvoiceIndex];
                const percent = inv.invoice_value > 0 ? (value / inv.invoice_value) * 100 : 0;

                const percentInput = item.querySelector('.campaign-percent-input');
                if (percentInput) percentInput.value = percent.toFixed(2);

                onCampaignFieldChange(key, 'allocation_percent', percent);
                onCampaignFieldChange(key, 'allocation_value', value);
                updateAllocationSummary();
            });

            // Comment button
            const commentBtn = item.querySelector('.campaign-comment-btn');
            commentBtn?.addEventListener('click', function() {
                const commentInput = item.querySelector('.campaign-comment-input');
                const currentComment = commentInput?.value || '';
                const newComment = prompt('Enter comment for this allocation:', currentComment);
                if (newComment !== null) {
                    if (commentInput) commentInput.value = newComment;
                    onCampaignFieldChange(key, 'comment', newComment);
                    if (newComment.trim()) {
                        this.classList.remove('btn-outline-info');
                        this.classList.add('btn-info');
                        this.title = newComment;
                    } else {
                        this.classList.remove('btn-info');
                        this.classList.add('btn-outline-info');
                        this.title = 'Add comment';
                    }
                }
            });

            // Reinvoice checkbox
            const reinvoiceCheck = item.querySelector('.campaign-reinvoice-check');
            reinvoiceCheck?.addEventListener('change', function() {
                const section = item.querySelector('.reinvoice-section');
                const badge = item.querySelector('.reinvoice-total-badge');
                const container = item.querySelector('.reinvoice-lines-container');

                if (this.checked) {
                    section.style.display = 'block';
                    badge.style.display = 'inline';
                    if (container.children.length === 0) {
                        addReinvoiceLine(key, false);
                    }
                } else {
                    section.style.display = 'none';
                    badge.style.display = 'none';
                    container.innerHTML = '';
                }
                onCampaignFieldChange(key, 'reinvoice', this.checked);
                updateReinvoiceTotalBadge(key);
            });

            // Add reinvoice line button
            const addReinvoiceBtn = item.querySelector('.add-reinvoice-line-btn');
            addReinvoiceBtn?.addEventListener('click', function() {
                addReinvoiceLine(key, true);
            });

            // Unmerge button
            const unmergeBtn = item.querySelector('.unmerge-btn');
            unmergeBtn?.addEventListener('click', function() {
                unmergeOwnCampaigns(key);
            });
        }

        function unmergeOwnCampaigns(mergedKey) {
            const allocation = campaignAllocations[mergedKey];
            if (!allocation || !allocation.merged) return;

            // Show original campaigns again
            allocation.originalKeys.forEach(origKey => {
                const item = document.querySelector(`.distribute-item[data-campaign-key="${origKey}"]`);
                if (item) {
                    item.style.display = 'block';
                    item.classList.remove('merged-hidden');
                }
            });

            // Remove merged campaign element
            const mergedItem = document.querySelector(`.distribute-item[data-campaign-key="${mergedKey}"]`);
            if (mergedItem) {
                mergedItem.remove();
            }

            // Remove from mergedCampaigns array
            mergedCampaigns = mergedCampaigns.filter(mc => !mc.keys.includes(mergedKey));

            // Remove allocation
            delete campaignAllocations[mergedKey];

            // Update campaign count badge
            const panel = document.getElementById('campaignDetailsPanel');
            const visibleCampaigns = panel.querySelectorAll('.distribute-item:not(.merged-hidden)').length;
            document.getElementById('campaignCountBadge').textContent = visibleCampaigns;

            // Update allocation summary
            updateAllocationSummary();

            showModal('Items have been unmerged.', 'info', 'Unmerged');
        }

        // Load organizational structure
        async function loadStructure() {
            if (structureData) return structureData;
            try {
                const response = await fetch('/api/structure');
                structureData = await response.json();
                return structureData;
            } catch (e) {
                console.error('Failed to load structure:', e);
                return [];
            }
        }

        // Load companies with VAT numbers for auto-matching
        async function loadCompaniesWithVat() {
            if (companiesWithVat.length > 0) return companiesWithVat;
            try {
                const response = await fetch('/api/companies-vat');
                companiesWithVat = await response.json();
                return companiesWithVat;
            } catch (e) {
                console.error('Failed to load companies with VAT:', e);
                return [];
            }
        }

        // Find company by customer VAT number
        function findCompanyByVat(customerVat) {
            if (!customerVat || !companiesWithVat.length) return null;
            // Normalize VAT: remove spaces, uppercase
            const normalizedVat = customerVat.replace(/\s/g, '').toUpperCase();
            const match = companiesWithVat.find(c => {
                const companyVat = (c.vat || '').replace(/\s/g, '').toUpperCase();
                return companyVat === normalizedVat;
            });
            return match ? match.company : null;
        }

        async function deleteInvoiceFromList(idx) {
            if (!reportData?.invoices || idx < 0 || idx >= reportData.invoices.length) return;

            const inv = reportData.invoices[idx];
            const invoiceName = inv.invoice_number || `Invoice ${idx + 1}`;

            const confirmed = await JarvisDialog.confirm(
                `Remove "${invoiceName}" from the list?`,
                { danger: true, confirmText: 'Remove' }
            );

            if (!confirmed) return;

            // Remove the invoice from the array
            const removedInvoice = reportData.invoices.splice(idx, 1)[0];

            // Update totals
            reportData.count = reportData.invoices.length;
            reportData.total -= (removedInvoice.invoice_value || 0);

            // Update cache
            saveToCache(reportData);

            // Reset selection if the deleted invoice was selected
            if (selectedInvoiceIndex === idx) {
                selectedInvoiceIndex = null;
                document.getElementById('selectedInvoiceSummary').style.display = 'none';
                document.getElementById('campaignDetailsPanel').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-arrow-left fs-1"></i>
                        <p class="mt-2">Select an invoice to configure allocations</p>
                    </div>
                `;
            } else if (selectedInvoiceIndex > idx) {
                // Adjust selected index if it was after the deleted one
                selectedInvoiceIndex--;
            }

            // Update display
            displayResults(reportData);

            // If no invoices left, disable buttons
            if (reportData.invoices.length === 0) {
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('transferBtn').disabled = true;
                clearCache();
            }
        }

        function renderInvoiceList() {
            if (!reportData?.invoices) return;

            const list = document.getElementById('invoiceSelectList');
            const invoices = reportData.invoices;

            document.getElementById('invoiceCountBadge').textContent = invoices.length;

            list.innerHTML = invoices.map((inv, idx) => {
                const hasCampaigns = inv.campaigns && Object.keys(inv.campaigns).length > 0;
                const campaignCount = hasCampaigns ? Object.keys(inv.campaigns).length : 0;
                const isSelected = selectedInvoiceIndex === idx;
                const isSaved = inv.saved || false;

                return `
                    <div class="list-group-item list-group-item-action ${isSelected ? 'active' : ''} ${isSaved ? 'list-group-item-success' : ''}"
                       data-idx="${idx}" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1" onclick="selectInvoice(${idx})">
                                <span class="fw-bold">${inv.invoice_number || 'Invoice ' + (idx + 1)}</span>
                                ${isSaved ? '<span class="badge bg-success ms-2"><i class="bi bi-check"></i> Saved</span>' : ''}
                                <br><small class="${isSelected ? 'text-white-50' : 'text-muted'}">${inv.supplier || 'Unknown'}</small>
                            </div>
                            <div class="text-end d-flex align-items-start gap-2">
                                <div onclick="selectInvoice(${idx})">
                                    <span class="fw-bold">${formatNumber(inv.invoice_value || 0)}</span>
                                    <br>
                                    ${hasCampaigns
                                        ? `<span class="badge ${isSelected ? 'bg-light text-primary' : 'bg-primary'}">${campaignCount} items</span>`
                                        : `<span class="badge ${isSelected ? 'bg-light text-secondary' : 'bg-secondary'}">No items</span>`
                                    }
                                </div>
                                <button type="button" class="btn btn-sm ${isSelected ? 'btn-outline-light' : 'btn-outline-danger'} p-0 px-1"
                                        onclick="event.stopPropagation(); deleteInvoiceFromList(${idx});" title="Remove from list">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function selectInvoice(idx) {
            selectedInvoiceIndex = idx;
            const inv = reportData.invoices[idx];

            // Clear merge state when switching invoices
            selectedForMerge.clear();
            mergedCampaigns = [];

            // Update invoice list selection
            renderInvoiceList();

            // Update summary panel
            document.getElementById('selectedInvoiceSummary').style.display = 'block';
            document.getElementById('selectedInvoiceTitle').textContent = inv.invoice_number || 'Invoice ' + (idx + 1);
            document.getElementById('selectedInvoiceSubtitle').textContent =
                `${inv.supplier || 'Unknown'} • ${formatDate(inv.invoice_date)}`;
            document.getElementById('selectedInvoiceValue').textContent =
                formatNumber(inv.invoice_value || 0) + ' ' + (inv.currency || 'RON');

            // Load companies with VAT for auto-matching
            await loadCompaniesWithVat();

            // Auto-select company based on customer_vat
            selectedMasterCompany = findCompanyByVat(inv.customer_vat) || '';

            // Render campaign details (this will update allocation summary)
            await renderCampaignDetails(inv, idx);

            // Enable copy pattern and merge similar buttons (if they exist)
            const copyPatternBtn = document.getElementById('copyPatternBtn');
            const mergeSimilarBtn = document.getElementById('mergeSimilarBtn');
            const applyPatternBtn = document.getElementById('applyPatternBtn');
            if (copyPatternBtn) copyPatternBtn.disabled = false;
            if (mergeSimilarBtn) mergeSimilarBtn.disabled = false;
            // Enable apply pattern button if a pattern is saved
            if (savedAllocationPattern && applyPatternBtn) {
                applyPatternBtn.disabled = false;
            }
        }

        async function renderCampaignDetails(inv, invoiceIdx) {
            await loadStructure();
            const panel = document.getElementById('campaignDetailsPanel');
            const campaigns = inv.campaigns || {};
            const campaignEntries = Object.entries(campaigns);
            const invoiceValue = inv.invoice_value || 0;

            document.getElementById('campaignCountBadge').textContent = campaignEntries.length;

            const companies = [...new Set(structureData.map(s => s.company))];

            // Build master company selector at the top (sticky header)
            let masterCompanyHtml = `
                <div class="sticky-panel-header" style="position: sticky; top: 0; z-index: 10; background: #fff;">
                    <div class="card mb-2 border-primary">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <label class="form-label small mb-1 fw-bold">Dedicated To (Company) *</label>
                                    <select class="form-select form-select-sm" id="masterCompanySelect">
                                        <option value="">Select Company...</option>
                                        ${companies.map(c => `<option value="${c}" ${selectedMasterCompany === c ? 'selected' : ''}>${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted d-block mt-3">
                                        <i class="bi bi-info-circle"></i>
                                        Customer VAT: <code>${inv.customer_vat || 'N/A'}</code>
                                        ${selectedMasterCompany ? `<span class="badge bg-success ms-2">Auto-matched</span>` : ''}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Merge Toolbar -->
                    <div class="card mb-2 bg-light border-warning" id="mergeToolbar" style="display: none;">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-collection text-warning me-2"></i>
                                    <span id="mergeSelectionCount">0</span> items selected
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearMergeSelection">
                                        <i class="bi bi-x-circle"></i> Clear Selection
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" id="mergeCampaignsBtn">
                                        <i class="bi bi-union"></i> Merge Selected
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // If no campaigns found, create a single "Full Invoice" allocation
            let effectiveCampaignEntries = campaignEntries;
            if (campaignEntries.length === 0) {
                effectiveCampaignEntries = [['Full Invoice', invoiceValue]];
            }

            document.getElementById('campaignCountBadge').textContent = effectiveCampaignEntries.length;

            // Build allocation rows for each campaign (without Company dropdown)
            panel.innerHTML = masterCompanyHtml + effectiveCampaignEntries.map(([name, value], campIdx) => {
                const key = `inv_${invoiceIdx}_camp_${campIdx}`;
                const existing = campaignAllocations[key] || {};
                const allocPercent = existing.allocation_percent ?? ((value / invoiceValue) * 100);
                const allocValue = existing.allocation_value ?? value;

                const isLocked = existing.locked || false;
                const comment = existing.comment || '';
                const hasComment = comment.trim().length > 0;

                return `
                    <div class="distribute-item ${isLocked ? 'locked' : ''} ${selectedForMerge.has(key) ? 'selected-for-merge' : ''}" data-campaign-key="${key}" data-campaign-name="${name}" data-campaign-value="${value}">
                        <div class="item-header">
                            <div class="d-flex align-items-center">
                                <input type="checkbox" class="form-check-input me-2 campaign-merge-checkbox"
                                       data-key="${key}" ${selectedForMerge.has(key) ? 'checked' : ''}
                                       title="Select for merging">
                                <strong class="text-primary">${name}</strong>
                                <span class="badge bg-light text-dark ms-2">${formatNumber(value)} ${inv.currency || 'RON'}</span>
                            </div>
                            <div class="d-flex gap-1">
                                <button type="button" class="btn btn-sm ${hasComment ? 'btn-info' : 'btn-outline-info'} campaign-comment-btn"
                                        data-key="${key}" title="${hasComment ? comment : 'Add comment'}">
                                    <i class="bi bi-chat-text"></i>
                                </button>
                                <button type="button" class="btn btn-sm ${isLocked ? 'btn-warning' : 'btn-outline-secondary'} campaign-lock-btn"
                                        data-key="${key}" title="${isLocked ? 'Unlock this allocation' : 'Lock this allocation'}">
                                    <i class="bi ${isLocked ? 'bi-lock-fill' : 'bi-unlock'}"></i>
                                </button>
                                <input type="hidden" class="campaign-comment-input" data-key="${key}" value="${comment}">
                            </div>
                        </div>
                        <div class="allocation-form">
                            <div class="row g-2 align-items-end">
                                <div class="col campaign-brand-col d-none" data-key="${key}">
                                    <label class="form-label small mb-1">Brand</label>
                                    <select class="form-select form-select-sm campaign-brand-select" data-key="${key}">
                                        <option value="">N/A</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Department *</label>
                                    <select class="form-select form-select-sm campaign-department-select" data-key="${key}">
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                                <div class="col campaign-subdept-col d-none" data-key="${key}">
                                    <label class="form-label small mb-1">Subdepartment</label>
                                    <select class="form-select form-select-sm campaign-subdept-select" data-key="${key}">
                                        <option value="">N/A</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">%</label>
                                    <input type="number" class="form-control form-control-sm campaign-percent-input"
                                           data-key="${key}" value="${allocPercent.toFixed(2)}" step="0.01" min="0" max="100">
                                </div>
                                <div class="col">
                                    <label class="form-label small mb-1">Value</label>
                                    <input type="number" class="form-control form-control-sm campaign-value-input"
                                           data-key="${key}" value="${allocValue.toFixed(2)}" step="0.01" min="0">
                                </div>
                            </div>
                            <div class="row g-2 mt-1 align-items-center">
                                <div class="col-md-4">
                                    <small class="text-muted campaign-manager-display" data-key="${key}">Manager: --</small>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input campaign-reinvoice-check" type="checkbox"
                                               data-key="${key}" ${existing.reinvoice ? 'checked' : ''}>
                                        <label class="form-check-label small">Reinvoice to:</label>
                                        <span class="badge bg-secondary ms-1 reinvoice-total-badge" data-key="${key}" style="display: ${existing.reinvoice ? 'inline' : 'none'};">0%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="reinvoice-section" data-key="${key}" style="display: ${existing.reinvoice ? 'block' : 'none'};">
                                <div class="reinvoice-lines-container mt-2" data-key="${key}">
                                    <!-- Reinvoice lines will be added here -->
                                </div>
                                <button type="button" class="btn btn-outline-secondary btn-sm mt-2 add-reinvoice-line-btn" data-key="${key}">
                                    <i class="bi bi-plus"></i> Add Reinvoice Line
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add event listener for master company dropdown
            attachMasterCompanyListener(invoiceIdx, campaignEntries, invoiceValue);

            // Add event listeners for all campaign allocation controls
            attachCampaignEventListeners(invoiceIdx, campaignEntries, invoiceValue);

            // Initialize dropdowns if master company is already selected
            if (selectedMasterCompany) {
                campaignEntries.forEach((_, campIdx) => {
                    const key = `inv_${invoiceIdx}_camp_${campIdx}`;
                    const existing = campaignAllocations[key];
                    populateCampaignDropdowns(key, selectedMasterCompany, existing);
                });
            }

            updateAllocationSummary();
        }

        function attachMasterCompanyListener(invoiceIdx, campaignEntries, invoiceValue) {
            const masterCompanySelect = document.getElementById('masterCompanySelect');
            if (!masterCompanySelect) return;

            masterCompanySelect.addEventListener('change', function() {
                selectedMasterCompany = this.value;

                // Update all campaign dropdowns with new company
                campaignEntries.forEach((_, campIdx) => {
                    const key = `inv_${invoiceIdx}_camp_${campIdx}`;
                    // Reset department/subdepartment when company changes
                    if (campaignAllocations[key]) {
                        campaignAllocations[key].department = null;
                        campaignAllocations[key].subdepartment = null;
                    }
                    populateCampaignDropdowns(key, selectedMasterCompany, campaignAllocations[key]);
                });

                updateAllocationSummary();
            });
        }

        function attachCampaignEventListeners(invoiceIdx, campaignEntries, invoiceValue) {
            // Department change
            document.querySelectorAll('.campaign-department-select').forEach(select => {
                select.addEventListener('change', function() {
                    const key = this.dataset.key;
                    onCampaignDepartmentChange(key, this.value);
                });
            });

            // Brand change
            document.querySelectorAll('.campaign-brand-select').forEach(select => {
                select.addEventListener('change', function() {
                    const key = this.dataset.key;
                    onCampaignFieldChange(key, 'brand', this.value);
                });
            });

            // Subdepartment change
            document.querySelectorAll('.campaign-subdept-select').forEach(select => {
                select.addEventListener('change', function() {
                    const key = this.dataset.key;
                    onCampaignFieldChange(key, 'subdepartment', this.value);
                });
            });

            // Percent input change
            document.querySelectorAll('.campaign-percent-input').forEach(input => {
                input.addEventListener('input', function() {
                    const key = this.dataset.key;
                    const percent = parseFloat(this.value) || 0;
                    const newValue = (invoiceValue * percent) / 100;

                    const valueInput = document.querySelector(`.campaign-value-input[data-key="${key}"]`);
                    if (valueInput) valueInput.value = newValue.toFixed(2);

                    onCampaignFieldChange(key, 'allocation_percent', percent);
                    onCampaignFieldChange(key, 'allocation_value', newValue);
                    updateAllocationSummary();
                    updateReinvoiceValues(key);
                });
            });

            // Value input change
            document.querySelectorAll('.campaign-value-input').forEach(input => {
                input.addEventListener('input', function() {
                    const key = this.dataset.key;
                    const value = parseFloat(this.value) || 0;
                    const percent = invoiceValue > 0 ? (value / invoiceValue) * 100 : 0;

                    const percentInput = document.querySelector(`.campaign-percent-input[data-key="${key}"]`);
                    if (percentInput) percentInput.value = percent.toFixed(2);

                    onCampaignFieldChange(key, 'allocation_value', value);
                    onCampaignFieldChange(key, 'allocation_percent', percent);
                    updateAllocationSummary();
                    updateReinvoiceValues(key);
                });
            });

            // Lock button
            document.querySelectorAll('.campaign-lock-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.dataset.key;
                    const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
                    const icon = this.querySelector('i');
                    const isLocked = item.classList.toggle('locked');

                    if (isLocked) {
                        icon.classList.remove('bi-unlock');
                        icon.classList.add('bi-lock-fill');
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-warning');
                        this.title = 'Unlock this allocation';
                    } else {
                        icon.classList.remove('bi-lock-fill');
                        icon.classList.add('bi-unlock');
                        this.classList.remove('btn-warning');
                        this.classList.add('btn-outline-secondary');
                        this.title = 'Lock this allocation';
                    }
                    onCampaignFieldChange(key, 'locked', isLocked);
                });
            });

            // Comment button
            document.querySelectorAll('.campaign-comment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.dataset.key;
                    const commentInput = document.querySelector(`.campaign-comment-input[data-key="${key}"]`);
                    const currentComment = commentInput?.value || '';
                    const newComment = prompt('Enter comment for this allocation:', currentComment);

                    if (newComment !== null) {
                        if (commentInput) commentInput.value = newComment;
                        onCampaignFieldChange(key, 'comment', newComment);

                        // Update button appearance
                        if (newComment.trim()) {
                            this.classList.remove('btn-outline-info');
                            this.classList.add('btn-info');
                            this.title = newComment;
                        } else {
                            this.classList.remove('btn-info');
                            this.classList.add('btn-outline-info');
                            this.title = 'Add comment';
                        }
                    }
                });
            });

            // Reinvoice checkbox
            document.querySelectorAll('.campaign-reinvoice-check').forEach(check => {
                check.addEventListener('change', function() {
                    const key = this.dataset.key;
                    const section = document.querySelector(`.reinvoice-section[data-key="${key}"]`);
                    const badge = document.querySelector(`.reinvoice-total-badge[data-key="${key}"]`);
                    const container = document.querySelector(`.reinvoice-lines-container[data-key="${key}"]`);

                    if (this.checked) {
                        section.style.display = 'block';
                        badge.style.display = 'inline';
                        // Add first reinvoice line if none exist
                        if (container.children.length === 0) {
                            addReinvoiceLine(key, false);
                        }
                    } else {
                        section.style.display = 'none';
                        badge.style.display = 'none';
                        container.innerHTML = '';
                    }
                    onCampaignFieldChange(key, 'reinvoice', this.checked);
                    updateReinvoiceTotalBadge(key);
                });
            });

            // Add reinvoice line button
            document.querySelectorAll('.add-reinvoice-line-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const key = this.dataset.key;
                    addReinvoiceLine(key, true); // true = redistribute
                });
            });

            // ============== Merge Selection Event Listeners ==============
            // Merge checkbox change
            document.querySelectorAll('.campaign-merge-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const key = this.dataset.key;
                    const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);

                    if (this.checked) {
                        selectedForMerge.add(key);
                        item.classList.add('selected-for-merge');
                    } else {
                        selectedForMerge.delete(key);
                        item.classList.remove('selected-for-merge');
                    }
                    updateMergeToolbar();
                });
            });

            // Merge toolbar buttons
            const mergeBtn = document.getElementById('mergeCampaignsBtn');
            const clearBtn = document.getElementById('clearMergeSelection');

            if (mergeBtn) {
                mergeBtn.addEventListener('click', function() {
                    if (selectedForMerge.size < 2) {
                        showModal('Please select at least 2 items to merge.', 'warning');
                        return;
                    }
                    performMergeCampaigns(invoiceIdx, campaignEntries, invoiceValue);
                });
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    clearMergeSelection();
                });
            }
        }

        function onCampaignFieldChange(key, field, value) {
            if (!campaignAllocations[key]) {
                campaignAllocations[key] = {};
            }
            campaignAllocations[key][field] = value;

            // Update manager when brand or subdepartment changes
            if (field === 'brand' || field === 'subdepartment') {
                const company = selectedMasterCompany;
                const department = campaignAllocations[key]?.department;
                const brand = campaignAllocations[key]?.brand;
                const subdepartment = campaignAllocations[key]?.subdepartment;
                if (company && department) {
                    updateCampaignManager(key, company, department, brand, subdepartment);
                }
            }
        }

        function populateReinvoiceDeptDropdown(key, company) {
            const deptSelect = document.querySelector(`.reinvoice-dept-select[data-key="${key}"]`);
            if (!deptSelect) return;

            const companyUnits = structureData.filter(s => s.company === company);
            const departments = [...new Set(companyUnits.map(s => s.department))];

            deptSelect.innerHTML = '<option value="">Dept...</option>' +
                departments.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        function populateCampaignDropdowns(key, company, existing) {
            const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
            if (!item) return;

            const companyUnits = structureData.filter(s => s.company === company);

            // Brands
            const brandSelect = item.querySelector('.campaign-brand-select');
            const brandCol = item.querySelector(`.campaign-brand-col[data-key="${key}"]`);
            const brands = [...new Set(companyUnits.map(s => s.brand).filter(b => b))];
            brandSelect.innerHTML = '<option value="">N/A</option>' +
                brands.map(b => `<option value="${b}" ${existing?.brand === b ? 'selected' : ''}>${b}</option>`).join('');

            // Show/hide brand column based on available options
            if (brands.length > 0) {
                brandCol?.classList.remove('d-none');
            } else {
                brandCol?.classList.add('d-none');
            }

            // Auto-select brand if only one option
            if (brands.length === 1 && !existing?.brand) {
                brandSelect.value = brands[0];
                onCampaignFieldChange(key, 'brand', brands[0]);
            }

            // Departments
            const deptSelect = item.querySelector('.campaign-department-select');
            const departments = [...new Set(companyUnits.map(s => s.department))];
            deptSelect.innerHTML = '<option value="">Select...</option>' +
                departments.map(d => `<option value="${d}" ${existing?.department === d ? 'selected' : ''}>${d}</option>`).join('');

            // Subdepartments (initialize empty, will populate on dept change)
            const subdeptSelect = item.querySelector('.campaign-subdept-select');
            const subdeptCol = item.querySelector(`.campaign-subdept-col[data-key="${key}"]`);
            subdeptSelect.innerHTML = '<option value="">N/A</option>';
            subdeptCol?.classList.add('d-none'); // Hide until department is selected

            // Auto-select department if only one option
            if (departments.length === 1 && !existing?.department) {
                deptSelect.value = departments[0];
                onCampaignDepartmentChange(key, departments[0]);
            }
            // If existing department, populate subdepartments
            else if (existing?.department) {
                populateCampaignSubdepts(key, company, existing.department, existing.subdepartment);
                updateCampaignManager(key, company, existing.department, existing?.brand, existing?.subdepartment);
            }
        }

        function onCampaignDepartmentChange(key, department) {
            if (!campaignAllocations[key]) {
                campaignAllocations[key] = {};
            }
            campaignAllocations[key].department = department;
            campaignAllocations[key].subdepartment = null;

            // Use master company instead of per-campaign company
            const company = selectedMasterCompany;
            const brand = campaignAllocations[key]?.brand;
            populateCampaignSubdepts(key, company, department, null);
            updateCampaignManager(key, company, department, brand, null);
            updateAllocationSummary();
        }

        function populateCampaignSubdepts(key, company, department, selectedSubdept) {
            const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
            if (!item) return;

            const subdeptSelect = item.querySelector('.campaign-subdept-select');
            const subdeptCol = item.querySelector(`.campaign-subdept-col[data-key="${key}"]`);
            const deptUnits = structureData.filter(s => s.company === company && s.department === department);
            const subdepts = [...new Set(deptUnits.map(s => s.subdepartment).filter(s => s))];

            subdeptSelect.innerHTML = '<option value="">N/A</option>' +
                subdepts.map(s => `<option value="${s}" ${selectedSubdept === s ? 'selected' : ''}>${s}</option>`).join('');

            // Show/hide subdepartment column based on available options
            if (subdepts.length > 0) {
                subdeptCol?.classList.remove('d-none');
            } else {
                subdeptCol?.classList.add('d-none');
            }

            // Auto-select subdepartment if only one option
            if (subdepts.length === 1 && !selectedSubdept) {
                subdeptSelect.value = subdepts[0];
                onCampaignFieldChange(key, 'subdepartment', subdepts[0]);
            }
        }

        async function updateCampaignManager(key, company, department, brand = null, subdepartment = null) {
            const item = document.querySelector(`.distribute-item[data-campaign-key="${key}"]`);
            if (!item) return;

            const managerDisplay = item.querySelector('.campaign-manager-display');

            if (!company || !department) {
                managerDisplay.textContent = 'Manager: --';
                return;
            }

            // Call the same API as single invoice input page
            const params = new URLSearchParams({ company, department });
            if (brand) params.append('brand', brand);
            if (subdepartment) params.append('subdepartment', subdepartment);

            try {
                const res = await fetch(`/api/manager?${params}`);
                const data = await res.json();
                managerDisplay.textContent = `Manager: ${data.manager || '--'}`;
            } catch (e) {
                managerDisplay.textContent = 'Manager: --';
            }
        }

        // ============== Multi-Destination Reinvoice Functions ==============
        function addReinvoiceLine(campaignKey, redistribute = false) {
            const container = document.querySelector(`.reinvoice-lines-container[data-key="${campaignKey}"]`);
            if (!container) return;

            const allocationValueInput = document.querySelector(`.campaign-value-input[data-key="${campaignKey}"]`);
            const allocationValue = parseFloat(allocationValueInput?.value) || 0;
            const inv = reportData?.invoices[selectedInvoiceIndex];
            const currency = inv?.currency || 'RON';
            const companies = [...new Set(structureData.map(s => s.company))];

            const lineCount = container.children.length;
            let newPercentage = redistribute ? 100 / (lineCount + 1) : 100;

            // If redistributing, update only unlocked lines
            if (redistribute && lineCount > 0) {
                const allLines = container.querySelectorAll('.reinvoice-line');
                const lockedLines = container.querySelectorAll('.reinvoice-line.reinvoice-locked');
                const unlockedLines = container.querySelectorAll('.reinvoice-line:not(.reinvoice-locked)');

                // Calculate total locked percentage
                let lockedPercent = 0;
                lockedLines.forEach(line => {
                    lockedPercent += parseFloat(line.querySelector('.reinvoice-percent').value) || 0;
                });

                // Calculate remaining percentage for unlocked lines (including new line)
                const remainingPercent = Math.max(0, 100 - lockedPercent);
                const unlockedCount = unlockedLines.length + 1; // +1 for new line
                const perUnlockedLine = remainingPercent / unlockedCount;
                const perUnlockedValue = ((allocationValue * perUnlockedLine) / 100).toFixed(2);

                // Update only unlocked lines
                unlockedLines.forEach(line => {
                    line.querySelector('.reinvoice-percent').value = perUnlockedLine.toFixed(2);
                    line.querySelector('.reinvoice-value').value = perUnlockedValue;
                });

                // Use the calculated percentage for the new line
                newPercentage = perUnlockedLine;
            }

            const initialValue = ((allocationValue * newPercentage) / 100).toFixed(2);

            const lineHtml = `
                <div class="row mt-2 reinvoice-line align-items-center gx-1" data-campaign-key="${campaignKey}">
                    <div class="col">
                        <select class="form-select form-select-sm reinvoice-company">
                            <option value="">Company...</option>
                            ${companies.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col reinvoice-brand-col d-none">
                        <select class="form-select form-select-sm reinvoice-brand">
                            <option value="">Brand...</option>
                        </select>
                    </div>
                    <div class="col">
                        <select class="form-select form-select-sm reinvoice-department">
                            <option value="">Dept...</option>
                        </select>
                    </div>
                    <div class="col reinvoice-subdept-col d-none">
                        <select class="form-select form-select-sm reinvoice-subdepartment">
                            <option value="">Subdept...</option>
                        </select>
                    </div>
                    <div class="col">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control reinvoice-value" value="${initialValue}" min="0" step="0.01">
                            <span class="input-group-text">${currency}</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="input-group input-group-sm" style="width: 90px;">
                            <input type="number" class="form-control reinvoice-percent" value="${newPercentage.toFixed(2)}" min="0" max="100" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-center gap-1">
                        <button type="button" class="btn btn-outline-secondary btn-sm reinvoice-lock-btn" title="Lock this line">
                            <i class="bi bi-unlock"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm reinvoice-comment-btn" title="Add comment">
                            <i class="bi bi-chat"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-reinvoice-line-btn">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <input type="hidden" class="reinvoice-comment" value="">
                </div>
            `;

            container.insertAdjacentHTML('beforeend', lineHtml);
            const newLine = container.lastElementChild;
            setupReinvoiceLineEvents(newLine, campaignKey);
            updateReinvoiceTotalBadge(campaignKey);
        }

        function setupReinvoiceLineEvents(line, campaignKey) {
            const companySelect = line.querySelector('.reinvoice-company');
            const brandSelect = line.querySelector('.reinvoice-brand');
            const deptSelect = line.querySelector('.reinvoice-department');
            const subdeptSelect = line.querySelector('.reinvoice-subdepartment');
            const valueInput = line.querySelector('.reinvoice-value');
            const percentInput = line.querySelector('.reinvoice-percent');
            const removeBtn = line.querySelector('.remove-reinvoice-line-btn');
            const brandCol = line.querySelector('.reinvoice-brand-col');
            const subdeptCol = line.querySelector('.reinvoice-subdept-col');

            // Company change - populate brands and departments
            companySelect.addEventListener('change', async () => {
                const company = companySelect.value;
                brandSelect.innerHTML = '<option value="">Brand...</option>';
                deptSelect.innerHTML = '<option value="">Dept...</option>';
                subdeptSelect.innerHTML = '<option value="">Subdept...</option>';
                subdeptCol.classList.add('d-none');

                if (company) {
                    const companyUnits = structureData.filter(s => s.company === company);
                    const brands = [...new Set(companyUnits.map(s => s.brand).filter(b => b))];
                    const departments = [...new Set(companyUnits.map(s => s.department))];

                    if (brands.length > 0) {
                        brandCol.classList.remove('d-none');
                        brands.forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b;
                            opt.textContent = b;
                            brandSelect.appendChild(opt);
                        });
                        // Auto-select brand if only one option
                        if (brands.length === 1) {
                            brandSelect.value = brands[0];
                        }
                    } else {
                        brandCol.classList.add('d-none');
                    }

                    departments.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        deptSelect.appendChild(opt);
                    });

                    // Auto-select department if only one option
                    if (departments.length === 1) {
                        deptSelect.value = departments[0];
                        // Trigger department change to populate subdepartments
                        deptSelect.dispatchEvent(new Event('change'));
                    }
                } else {
                    brandCol.classList.add('d-none');
                }
            });

            // Department change - populate subdepartments
            deptSelect.addEventListener('change', async () => {
                const company = companySelect.value;
                const dept = deptSelect.value;
                subdeptSelect.innerHTML = '<option value="">Subdept...</option>';

                if (company && dept) {
                    const deptUnits = structureData.filter(s => s.company === company && s.department === dept);
                    const subdepts = [...new Set(deptUnits.map(s => s.subdepartment).filter(s => s))];

                    if (subdepts.length > 0) {
                        subdeptCol.classList.remove('d-none');
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subdeptSelect.appendChild(opt);
                        });
                        // Auto-select subdepartment if only one option
                        if (subdepts.length === 1) {
                            subdeptSelect.value = subdepts[0];
                        }
                    } else {
                        subdeptCol.classList.add('d-none');
                    }
                } else {
                    subdeptCol.classList.add('d-none');
                }
            });

            // Value change - update percentage (bidirectional sync)
            valueInput.addEventListener('input', () => {
                const allocationValueInput = document.querySelector(`.campaign-value-input[data-key="${campaignKey}"]`);
                const allocationValue = parseFloat(allocationValueInput?.value) || 0;
                const reinvoiceValue = parseFloat(valueInput.value) || 0;

                if (allocationValue > 0) {
                    const newPercent = (reinvoiceValue / allocationValue) * 100;
                    percentInput.value = newPercent.toFixed(2);
                }
                updateReinvoiceTotalBadge(campaignKey);
            });

            // Percentage change - update value (bidirectional sync)
            percentInput.addEventListener('input', () => {
                const allocationValueInput = document.querySelector(`.campaign-value-input[data-key="${campaignKey}"]`);
                const allocationValue = parseFloat(allocationValueInput?.value) || 0;
                const percent = parseFloat(percentInput.value) || 0;

                valueInput.value = ((allocationValue * percent) / 100).toFixed(2);
                updateReinvoiceTotalBadge(campaignKey);
            });

            // Remove button
            removeBtn.addEventListener('click', () => {
                line.remove();
                updateReinvoiceTotalBadge(campaignKey);
            });

            // Lock button
            const lockBtn = line.querySelector('.reinvoice-lock-btn');
            lockBtn.addEventListener('click', () => {
                const isLocked = line.classList.toggle('reinvoice-locked');
                const icon = lockBtn.querySelector('i');
                if (isLocked) {
                    icon.classList.remove('bi-unlock');
                    icon.classList.add('bi-lock-fill');
                    lockBtn.classList.remove('btn-outline-secondary');
                    lockBtn.classList.add('btn-warning');
                } else {
                    icon.classList.remove('bi-lock-fill');
                    icon.classList.add('bi-unlock');
                    lockBtn.classList.remove('btn-warning');
                    lockBtn.classList.add('btn-outline-secondary');
                }
            });

            // Comment button
            const commentBtn = line.querySelector('.reinvoice-comment-btn');
            const commentInput = line.querySelector('.reinvoice-comment');
            commentBtn.addEventListener('click', () => {
                const currentComment = commentInput.value || '';
                const newComment = prompt('Enter comment for this reinvoice line:', currentComment);
                if (newComment !== null) {
                    commentInput.value = newComment;
                    if (newComment.trim()) {
                        commentBtn.classList.remove('btn-outline-secondary');
                        commentBtn.classList.add('btn-info');
                        commentBtn.title = newComment;
                    } else {
                        commentBtn.classList.remove('btn-info');
                        commentBtn.classList.add('btn-outline-secondary');
                        commentBtn.title = 'Add comment';
                    }
                }
            });
        }

        function updateReinvoiceTotalBadge(campaignKey) {
            const container = document.querySelector(`.reinvoice-lines-container[data-key="${campaignKey}"]`);
            const badge = document.querySelector(`.reinvoice-total-badge[data-key="${campaignKey}"]`);
            if (!container || !badge) return;

            let totalPercent = 0;
            container.querySelectorAll('.reinvoice-line').forEach(line => {
                totalPercent += parseFloat(line.querySelector('.reinvoice-percent')?.value) || 0;
            });

            badge.textContent = totalPercent.toFixed(0) + '%';
            // Allow tolerance: up to 100.1% is considered valid (green)
            const reinvoiceValid = totalPercent >= 99.99 && totalPercent <= 100.1;
            badge.className = `badge ms-1 ${totalPercent > 100.1 ? 'bg-danger' : reinvoiceValid ? 'bg-success' : 'bg-secondary'} reinvoice-total-badge`;
        }

        function updateReinvoiceValues(campaignKey) {
            // When allocation value changes, update all reinvoice line values proportionally
            const container = document.querySelector(`.reinvoice-lines-container[data-key="${campaignKey}"]`);
            if (!container) return;

            const allocationValueInput = document.querySelector(`.campaign-value-input[data-key="${campaignKey}"]`);
            const allocationValue = parseFloat(allocationValueInput?.value) || 0;

            container.querySelectorAll('.reinvoice-line').forEach(line => {
                const percentInput = line.querySelector('.reinvoice-percent');
                const valueInput = line.querySelector('.reinvoice-value');
                const percent = parseFloat(percentInput?.value) || 0;
                if (valueInput) {
                    valueInput.value = ((allocationValue * percent) / 100).toFixed(2);
                }
            });
        }

        function getReinvoiceDestinations(campaignKey) {
            const container = document.querySelector(`.reinvoice-lines-container[data-key="${campaignKey}"]`);
            if (!container) return [];

            const destinations = [];
            container.querySelectorAll('.reinvoice-line').forEach(line => {
                const company = line.querySelector('.reinvoice-company')?.value;
                const brand = line.querySelector('.reinvoice-brand')?.value || null;
                const department = line.querySelector('.reinvoice-department')?.value || null;
                const subdepartment = line.querySelector('.reinvoice-subdepartment')?.value || null;
                const value = parseFloat(line.querySelector('.reinvoice-value')?.value) || 0;
                const percentage = parseFloat(line.querySelector('.reinvoice-percent')?.value) || 0;
                const locked = line.classList.contains('reinvoice-locked');
                const comment = line.querySelector('.reinvoice-comment')?.value || null;

                if (company && percentage > 0) {
                    destinations.push({
                        company,
                        brand,
                        department,
                        subdepartment,
                        value,
                        percentage,
                        locked,
                        comment
                    });
                }
            });

            return destinations;
        }

        function updateAllocationSummary() {
            if (selectedInvoiceIndex === null || !reportData) return;

            const inv = reportData.invoices[selectedInvoiceIndex];
            const invoiceValue = inv.invoice_value || 0;

            let totalAllocValue = 0;
            let totalPercent = 0;
            let allDepartmentsSelected = true;
            let companySelected = !!selectedMasterCompany;
            let validationErrors = [];

            // Process only visible items (including merged campaigns, excluding hidden originals)
            const visibleItems = document.querySelectorAll('.distribute-item:not(.merged-hidden)');
            visibleItems.forEach(item => {
                const key = item.dataset.campaignKey;
                const alloc = campaignAllocations[key] || {};

                // Get values from inputs (if rendered)
                const percentInput = item.querySelector('.campaign-percent-input');
                const valueInput = item.querySelector('.campaign-value-input');

                const percent = percentInput ? parseFloat(percentInput.value) || 0 : (alloc.allocation_percent || 0);
                const value = valueInput ? parseFloat(valueInput.value) || 0 : (alloc.allocation_value || 0);

                totalPercent += percent;
                totalAllocValue += value;

                // Check if department is selected
                const deptSelect = item.querySelector('.campaign-department-select');

                if (!deptSelect?.value) {
                    allDepartmentsSelected = false;
                }
            });

            // Update summary display
            document.getElementById('selectedAllocatedTotal').textContent = formatNumber(totalAllocValue) + ' ' + (inv.currency || 'RON');
            document.getElementById('selectedTotalPercent').textContent = totalPercent.toFixed(2) + '%';

            // Validation status
            const validationDiv = document.getElementById('validationStatus');
            // Allow tolerance: 99.99% to 100.1% is considered valid (100%)
            const percentValid = totalPercent >= 99.99 && totalPercent <= 100.1;
            const isValid = percentValid && allDepartmentsSelected && companySelected;

            if (isValid) {
                validationDiv.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Ready</span>';
            } else {
                let errors = [];
                if (!companySelected) {
                    errors.push('No company');
                }
                if (!percentValid) {
                    errors.push(`${totalPercent.toFixed(2)}% ≠ 100%`);
                }
                if (!allDepartmentsSelected) {
                    errors.push('Missing depts');
                }
                validationDiv.innerHTML = `<span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> ${errors.join(', ')}</span>`;
            }

            // Update transfer button state
            const transferBtn = document.getElementById('transferBtn');
            transferBtn.disabled = !isValid;

            // Update status badge
            const statusBadge = document.getElementById('allocationStatusBadge');
            statusBadge.style.display = 'inline';
            statusBadge.textContent = totalPercent.toFixed(0) + '%';
            statusBadge.className = `badge ms-2 ${isValid ? 'bg-success' : 'bg-warning text-dark'}`;

            return isValid;
        }

        async function saveToAccounting() {
            if (selectedInvoiceIndex === null) {
                showModal('Please select an invoice first.', 'warning');
                return;
            }

            // Validate before saving
            const isValid = updateAllocationSummary();
            if (!isValid) {
                showModal('Please complete all allocations:\n• Company must be selected\n• All items must have Department selected\n• Total allocation must equal 100%', 'warning', 'Validation Required');
                return;
            }

            const loadingOverlay = document.getElementById('loadingOverlay');
            const btn = document.getElementById('transferBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            loadingOverlay.querySelector('.progress-text').textContent = 'Saving to accounting...';
            loadingOverlay.classList.add('show');

            try {
                const inv = reportData.invoices[selectedInvoiceIndex];
                const campaigns = inv.campaigns || {};
                const campaignEntries = Object.entries(campaigns);
                const invoiceValue = inv.invoice_value || 0;

                // If no campaigns found, use "Full Invoice" placeholder
                let effectiveCampaignEntries = campaignEntries;
                if (campaignEntries.length === 0) {
                    effectiveCampaignEntries = [['Full Invoice', invoiceValue]];
                }

                // Build distributions array (same format as Add Invoice page)
                // Process visible campaigns only (skip hidden/merged originals)
                const distributions = [];
                const visibleItems = document.querySelectorAll('.distribute-item:not(.merged-hidden)');

                visibleItems.forEach(item => {
                    const key = item.dataset.campaignKey;
                    const name = item.dataset.campaignName;
                    const isMerged = item.classList.contains('merged-campaign');

                    const percentInput = item.querySelector('.campaign-percent-input');
                    const valueInput = item.querySelector('.campaign-value-input');
                    const brandSelect = item.querySelector('.campaign-brand-select');
                    const deptSelect = item.querySelector('.campaign-department-select');
                    const subdeptSelect = item.querySelector('.campaign-subdept-select');
                    const commentInput = item.querySelector('.campaign-comment-input');
                    const isLocked = item.classList.contains('locked') || false;

                    const percent = parseFloat(percentInput?.value) || 0;
                    const allocValue = parseFloat(valueInput?.value) || 0;

                    // For merged campaigns, store original campaign names in comment
                    let commentText = name;
                    if (isMerged && campaignAllocations[key]?.originalNames) {
                        commentText = `[MERGED] Original campaigns: ${campaignAllocations[key].originalNames.join(', ')}`;
                    }
                    if (commentInput?.value) {
                        commentText += ' - ' + commentInput.value;
                    }

                    distributions.push({
                        company: selectedMasterCompany,
                        brand: brandSelect?.value || null,
                        department: deptSelect?.value || '',
                        subdepartment: subdeptSelect?.value || null,
                        allocation: percent / 100,  // Convert percentage to decimal (0-1)
                        reinvoice_destinations: getReinvoiceDestinations(key),
                        locked: isLocked,
                        comment: commentText
                    });
                });

                // Parse invoice date to ISO format
                let invoiceDate = inv.invoice_date || '';
                if (inv.date_parsed) {
                    // If we have a parsed date object, format it as YYYY-MM-DD
                    const d = new Date(inv.date_parsed);
                    invoiceDate = d.toISOString().split('T')[0];
                } else if (invoiceDate) {
                    // Try to parse Romanian date format (e.g., "20 nov. 2025")
                    invoiceDate = parseRomanianDateToISO(invoiceDate);
                }

                // First save to database (with retry for cold start handling)
                const res = await fetchWithRetry('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplier: inv.supplier || '',
                        invoice_number: inv.invoice_number || '',
                        invoice_date: invoiceDate,
                        invoice_value: invoiceValue,
                        currency: inv.currency || 'RON',
                        drive_link: '',  // Will be set after upload
                        distributions,
                        value_ron: null,
                        value_eur: null,
                        exchange_rate: null,
                        comment: '',
                        payment_status: 'not_paid',
                        subtract_vat: false,
                        vat_rate: null,
                        net_value: null
                    })
                });

                const result = await res.json();
                if (result.success) {
                    // Upload file to Drive if available
                    let driveLink = '';
                    const fileName = inv.filename || '';
                    if (fileName && uploadedFiles.length > 0) {
                        const matchingFile = uploadedFiles.find(f => f.name === fileName);
                        if (matchingFile) {
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading to Drive...';
                            loadingOverlay.querySelector('.progress-text').textContent = 'Uploading to Google Drive...';

                            const uploadResult = await uploadToDrive(matchingFile, invoiceDate, selectedMasterCompany, inv.invoice_number);
                            if (uploadResult.success) {
                                driveLink = uploadResult.drive_link;
                                // Update the invoice with the drive link (with retry for cold start)
                                await fetchWithRetry(`/api/invoices/${result.invoice_id}/drive-link`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ drive_link: driveLink })
                                });
                            }
                        }
                    }

                    // Mark invoice as saved in the list
                    markInvoiceAsSaved(selectedInvoiceIndex);

                    let successMsg = `Invoice ${inv.invoice_number} saved with ${result.allocations} allocation(s)!`;
                    if (driveLink) successMsg += '\nUploaded to Google Drive.';
                    showModal(successMsg, 'success', 'Invoice Saved');

                    // Move to next unsaved invoice or clear selection
                    selectNextUnsavedInvoice();
                } else {
                    showModal('Error: ' + result.error, 'error');
                }
            } catch (error) {
                showModal('Error saving invoice: ' + error.message, 'error');
            } finally {
                loadingOverlay.querySelector('.progress-text').textContent = 'Processing invoices...';
                loadingOverlay.classList.remove('show');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Save to Accounting';
                updateAllocationSummary();
            }
        }

        // Upload file to Google Drive (with retry for cold start)
        async function uploadToDrive(file, invoiceDate, company, invoiceNumber) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('invoice_date', invoiceDate);
            formData.append('company', company);
            formData.append('invoice_number', invoiceNumber);

            const res = await fetchWithRetry('/api/drive/upload', { method: 'POST', body: formData });
            return await res.json();
        }

        // Retry fetch with automatic retry on network errors (cold start handling)
        async function fetchWithRetry(url, options, maxRetries = 2) {
            let lastError;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await fetch(url, options);
                    return res;
                } catch (error) {
                    lastError = error;
                    // Only retry on network errors like "Load failed" or "Failed to fetch"
                    if (error.message && (error.message.includes('Load failed') || error.message.includes('Failed to fetch'))) {
                        console.log(`Fetch attempt ${attempt + 1} failed, retrying...`);
                        // Wait a bit before retrying (exponential backoff)
                        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                        continue;
                    }
                    // For other errors, don't retry
                    throw error;
                }
            }
            throw lastError;
        }

        // Parse Romanian date format to ISO (YYYY-MM-DD)
        function parseRomanianDateToISO(dateStr) {
            const months = {
                'ian': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'mai': '05', 'iun': '06',
                'iul': '07', 'aug': '08', 'sep': '09', 'oct': '10', 'nov': '11', 'dec': '12',
                'ianuarie': '01', 'februarie': '02', 'martie': '03', 'aprilie': '04',
                'iunie': '06', 'iulie': '07', 'august': '08', 'septembrie': '09',
                'octombrie': '10', 'noiembrie': '11', 'decembrie': '12'
            };

            const match = dateStr.match(/(\d{1,2})\s+(\w+)\.?,?\s*(\d{4})/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const monthStr = match[2].toLowerCase().replace('.', '');
                const year = match[3];
                const month = months[monthStr] || '01';
                return `${year}-${month}-${day}`;
            }
            return dateStr;  // Return as-is if can't parse
        }

        // Mark invoice as saved in the list
        function markInvoiceAsSaved(idx) {
            if (!reportData?.invoices[idx]) return;
            reportData.invoices[idx].saved = true;

            // Update the cache with new saved status
            saveToCache(reportData);

            // Re-render the list to show updated saved status
            renderInvoiceList();
        }

        // Select next unsaved invoice
        function selectNextUnsavedInvoice() {
            if (!reportData?.invoices) return;

            // Find next unsaved invoice
            const nextIdx = reportData.invoices.findIndex((inv, idx) => idx > selectedInvoiceIndex && !inv.saved);
            if (nextIdx >= 0) {
                selectInvoice(nextIdx);
            } else {
                // Check if all invoices are saved
                const allSaved = reportData.invoices.every(inv => inv.saved);
                if (allSaved) {
                    showModal('All invoices have been saved successfully!', 'success', 'Complete');
                    // Clear the cache since all work is done
                    clearCache();
                    // Reset selection
                    selectedInvoiceIndex = null;
                    document.getElementById('campaignDetailsPanel').innerHTML = `
                        <div class="text-center text-success py-5">
                            <i class="bi bi-check-circle fs-1"></i>
                            <p class="mt-2">All invoices saved to accounting!</p>
                        </div>
                    `;
                    document.getElementById('selectedInvoiceSummary').style.display = 'none';
                    document.getElementById('transferBtn').disabled = true;
                    const copyBtn1 = document.getElementById('copyPatternBtn');
                    const mergeBtn1 = document.getElementById('mergeSimilarBtn');
                    if (copyBtn1) copyBtn1.disabled = true;
                    if (mergeBtn1) mergeBtn1.disabled = true;
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Restore cached invoice data if available
            const cachedData = loadFromCache();
            if (cachedData) {
                reportData = cachedData;
                displayResults(reportData);
                console.log('Restored bulk invoice data from cache');
            }

            const distributeTab = document.getElementById('distribute-tab');
            if (distributeTab) {
                distributeTab.addEventListener('shown.bs.tab', function() {
                    if (reportData) {
                        renderInvoiceList();
                        // Reset selection
                        selectedInvoiceIndex = null;
                        document.getElementById('campaignDetailsPanel').innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-arrow-left fs-1"></i>
                                <p class="mt-2">Select an invoice to configure allocations</p>
                            </div>
                        `;
                        document.getElementById('selectedInvoiceSummary').style.display = 'none';
                        document.getElementById('transferBtn').disabled = true;
                        const copyBtn2 = document.getElementById('copyPatternBtn');
                        const mergeBtn2 = document.getElementById('mergeSimilarBtn');
                        if (copyBtn2) copyBtn2.disabled = true;
                        if (mergeBtn2) mergeBtn2.disabled = true;
                        document.getElementById('campaignCountBadge').textContent = '0';
                        document.getElementById('allocationStatusBadge').style.display = 'none';
                    }
                });
            }
        });

    </script>
    <script src="/static/js/jarvis-utils.js"></script>
    <script src="/static/js/online-users.js"></script>
    {% include 'partials/_edit_profile_modal.html' %}
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/jarvis-dialogs.js"></script>
</body>
</html>
