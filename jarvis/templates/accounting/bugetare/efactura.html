<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - e-Factura Invoices</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        .summary-filter-bar { font-size: 0.85rem; }
        .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
        .summary-stat i { font-size: 1rem; }
        .summary-stat strong { color: var(--bs-body-color); }
        .bulk-action-bar {
            display: none;
            padding: 0.75rem 1rem;
            background: var(--bs-light);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        .bulk-action-bar.show { display: flex; }
        .tab-badge {
            font-size: 0.7rem;
            padding: 0.15em 0.5em;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        /* Sync Progress Styles */
        .sync-progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            border: 1px solid #a5d6a7;
            min-width: 280px;
        }
        .sync-progress-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: #2e7d32;
        }
        .sync-icon { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .sync-progress-bar {
            flex: 1;
            height: 6px;
            background: #c8e6c9;
            border-radius: 3px;
            overflow: hidden;
            min-width: 100px;
        }
        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .sync-progress-fill.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .sync-progress-container.completed {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #90caf9;
        }
        .sync-progress-container.completed .sync-progress-info { color: #1565c0; }
        .sync-progress-container.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #ef9a9a;
        }
        .sync-progress-container.error .sync-progress-info { color: #c62828; }
        /* Sync progress hover for clickable report */
        .sync-progress-container[data-sync-result] {
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }
        .sync-progress-container[data-sync-result]:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .sync-progress-container[data-sync-result]::after {
            content: '\F479'; /* bi-info-circle */
            font-family: 'bootstrap-icons';
            margin-left: 8px;
            opacity: 0.6;
            font-size: 0.9em;
        }
        /* Sortable Table Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .sortable::after {
            content: '\F282';
            font-family: 'bootstrap-icons';
            margin-left: 4px;
            opacity: 0.3;
            font-size: 0.75em;
        }
        .sortable.asc::after {
            content: '\F235';
            opacity: 1;
        }
        .sortable.desc::after {
            content: '\F229';
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'accounting' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item active">e-Factura</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
            {% set active_page = 'efactura' %}
            {% set inline_nav = true %}
            {% include 'partials/_accounting_nav.html' %}

            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3">
                <!-- Sync Progress Indicator (hidden by default) -->
                <div id="syncProgressContainer" class="sync-progress-container" style="display: none;">
                    <div class="sync-progress-info">
                        <i class="bi bi-cloud-arrow-down sync-icon"></i>
                        <span id="syncStatusText">Syncing...</span>
                    </div>
                    <div class="sync-progress-bar">
                        <div id="syncProgressBar" class="sync-progress-fill"></div>
                    </div>
                    <small id="syncProgressDetail" class="text-muted">Fetching invoices...</small>
                </div>

                <span class="summary-stat text-warning" title="Unallocated Invoices">
                    <i class="bi bi-inbox"></i>
                    <span id="unallocatedSummaryText"><strong>0</strong> invoices</span>
                </span>
                <span class="summary-stat text-success" title="Total Value">
                    <i class="bi bi-cash-stack"></i>
                    <strong id="totalValueUnallocated">0</strong>
                </span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs mb-0" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#unallocatedTab" onclick="loadUnallocatedInvoices()">
                        <i class="bi bi-inbox"></i> Unallocated
                        <span id="unallocatedBadge" class="badge bg-warning tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#hiddenTab" onclick="loadHiddenInvoices()">
                        <i class="bi bi-eye-slash"></i> Hidden
                        <span id="hiddenBadge" class="badge bg-secondary tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#binTab" onclick="loadBinInvoices()">
                        <i class="bi bi-trash3"></i> Bin
                        <span id="binBadge" class="badge bg-danger tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#mappingsTab" onclick="loadSupplierMappings()">
                        <i class="bi bi-diagram-3"></i> Mappings
                        <span id="mappingsBadge" class="badge bg-info tab-badge" style="display: none;">0</span>
                    </a>
                </li>
            </ul>
            <div class="d-flex gap-2">
                <a href="/efactura/" class="btn btn-sm btn-outline-secondary" title="Go to e-Factura Connector settings">
                    <i class="bi bi-gear"></i> Connector Settings
                </a>
                <button class="btn btn-sm btn-success" onclick="openSyncModal()" id="syncBtn" title="Fetch and import invoices from ANAF">
                    <i class="bi bi-cloud-arrow-down"></i> Sync
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Unallocated Tab -->
            <div class="tab-pane fade show active" id="unallocatedTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-table"></i> Unallocated Invoices</span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search supplier or invoice #..." onkeypress="if(event.key==='Enter') loadUnallocatedInvoices()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadUnallocatedInvoices()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-danger btn-sm d-none" id="refreshDataBtn" onclick="refreshAfterMappingChange()" title="Mapping types changed - click to refresh data">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openColumnConfig()">
                                    <i class="bi bi-gear"></i> Columns
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="filtersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Company</label>
                                    <select class="form-select form-select-sm" id="companyFilter">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Direction</label>
                                    <select class="form-select form-select-sm" id="directionFilter">
                                        <option value="">All</option>
                                        <option value="received" selected>Received</option>
                                        <option value="sent">Sent</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">From Date</label>
                                    <input type="date" class="form-control form-control-sm" id="startDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">To Date</label>
                                    <input type="date" class="form-control form-control-sm" id="endDate">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-primary" onclick="loadUnallocatedInvoices()">
                                        <i class="bi bi-search"></i> Apply
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearFilters()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Duplicates Banner (hidden by default) -->
                        <div class="alert alert-warning d-none" id="duplicatesBanner" role="alert">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong id="duplicatesCount">0</strong> potential duplicate(s) found - these invoices already exist in the Invoices module.
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-warning" onclick="viewDuplicates()">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="markAllDuplicates()">
                                        <i class="bi bi-check2-all"></i> Mark All as Duplicates
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="hideDuplicatesBanner()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="bulk-action-bar" id="bulkActionBar">
                            <span><strong id="selectedCount">0</strong> selected</span>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-success btn-sm" onclick="sendSelectedToInvoices()">
                                    <i class="bi bi-send"></i> Send to Invoices
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="openBulkSetOverridesModal()">
                                    <i class="bi bi-pencil-square"></i> Set Type/Dept
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="bulkHideSelected()">
                                    <i class="bi bi-eye-slash"></i> Hide
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteSelected()">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="invoicesTable">
                                <thead class="table-light" id="invoicesTableHead">
                                    <!-- Dynamic columns rendered by JS -->
                                </thead>
                                <tbody id="invoicesTableBody">
                                    <tr>
                                        <td colspan="12" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div id="paginationInfo" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                            <div class="d-flex align-items-center gap-2">
                                <span id="paginationSummary" class="text-muted small"></span>
                                <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)" id="pageSizeSelect">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span class="text-muted small">per page</span>
                            </div>
                            <div id="paginationControls" class="btn-group btn-group-sm"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Tab -->
            <div class="tab-pane fade" id="hiddenTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-eye-slash"></i> Hidden Invoices <span id="hiddenResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="hiddenSearchInput" placeholder="Search supplier or invoice #..." oninput="debouncedHiddenSearch()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadHiddenInvoices(1, true)">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#hiddenFiltersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openHiddenColumnConfig()">
                                    <i class="bi bi-gear"></i> Columns
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreFromHidden()" id="hiddenRestoreBtn" disabled>
                                    <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteFromHidden()" id="hiddenDeleteBtn" disabled>
                                    <i class="bi bi-trash"></i> Move to Bin
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="hiddenFiltersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Direction</label>
                                    <select class="form-select form-select-sm" id="hiddenDirectionFilter">
                                        <option value="">All</option>
                                        <option value="received">Received</option>
                                        <option value="sent">Sent</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">From Date</label>
                                    <input type="date" class="form-control form-control-sm" id="hiddenStartDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">To Date</label>
                                    <input type="date" class="form-control form-control-sm" id="hiddenEndDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Page Size</label>
                                    <select class="form-select form-select-sm" id="hiddenPageSizeSelect" onchange="changeHiddenPageSize(this.value)">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-primary" onclick="loadHiddenInvoices(1, true)">
                                        <i class="bi bi-search"></i> Apply
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearHiddenFilters()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="hiddenTable">
                                <thead class="table-light" id="hiddenTableHead">
                                    <!-- Dynamic columns rendered by JS -->
                                </thead>
                                <tbody id="hiddenTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Hidden" tab to load hidden invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <nav id="hiddenPagination" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="hiddenPaginationInfo">Showing 0-0 of 0</small>
                                <ul class="pagination pagination-sm mb-0" id="hiddenPaginationList"></ul>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Bin Tab -->
            <div class="tab-pane fade" id="binTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-trash3"></i> Deleted Invoices (Bin) - Auto-deleted after 30 days <span id="binResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="binSearchInput" placeholder="Search supplier or invoice #..." oninput="debouncedBinSearch()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadBinInvoices(1, true)">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#binFiltersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreFromBin()" id="binRestoreBtn" disabled>
                                    <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="bulkPermanentDelete()" id="binPermanentDeleteBtn" disabled>
                                    <i class="bi bi-trash"></i> Delete Permanently
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="binFiltersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Direction</label>
                                    <select class="form-select form-select-sm" id="binDirectionFilter">
                                        <option value="">All</option>
                                        <option value="received">Received</option>
                                        <option value="sent">Sent</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">From Date</label>
                                    <input type="date" class="form-control form-control-sm" id="binStartDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">To Date</label>
                                    <input type="date" class="form-control form-control-sm" id="binEndDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Page Size</label>
                                    <select class="form-select form-select-sm" id="binPageSizeSelect" onchange="changeBinPageSize(this.value)">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-primary" onclick="loadBinInvoices(1, true)">
                                        <i class="bi bi-search"></i> Apply
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearBinFilters()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="binTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 60px">
                                            <div class="dropdown d-inline">
                                                <input type="checkbox" class="form-check-input" id="binSelectAll" onchange="toggleBinSelectPage()">
                                                <button class="btn btn-link btn-sm p-0 ms-1 text-muted" type="button" data-bs-toggle="dropdown" style="font-size: 10px;">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-sm">
                                                    <li><a class="dropdown-item small" href="#" onclick="toggleBinSelectPage(); return false;"><i class="bi bi-check2-square me-2"></i>Select Page</a></li>
                                                    <li><a class="dropdown-item small" href="#" onclick="selectAllBin(); return false;"><i class="bi bi-check2-all me-2"></i>Select All (<span id="binTotalForSelect">0</span>)</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item small" href="#" onclick="clearBinSelection(); return false;"><i class="bi bi-x-square me-2"></i>Clear Selection</a></li>
                                                </ul>
                                            </div>
                                        </th>
                                        <th class="sortable" onclick="sortBinTable('direction')">Direction</th>
                                        <th class="sortable" onclick="sortBinTable('invoice_number')">Invoice #</th>
                                        <th class="sortable" onclick="sortBinTable('partner_name')">Supplier / Partner</th>
                                        <th class="sortable" onclick="sortBinTable('issue_date')">Issue Date</th>
                                        <th class="sortable text-end" onclick="sortBinTable('total_amount')">Amount</th>
                                        <th class="sortable" onclick="sortBinTable('deleted_at')">Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="binTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Bin" tab to load deleted invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <nav id="binPagination" class="mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="binPaginationInfo">Showing 0-0 of 0</small>
                                <ul class="pagination pagination-sm mb-0" id="binPaginationList"></ul>
                            </div>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Mappings Tab -->
            <div class="tab-pane fade" id="mappingsTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-diagram-3"></i> Supplier Mappings <span id="mappingsResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="mappingsSearchInput" placeholder="Search partner or supplier..." onkeyup="if(event.key==='Enter') filterMappings()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="filterMappings()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mappingsFiltersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openMappingsColumnConfig()">
                                    <i class="bi bi-layout-three-columns"></i> Columns
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openPartnerTypesModal()" title="Manage Partner Types">
                                    <i class="bi bi-gear"></i> Types
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="importSuppliersFromInvoices()">
                                    <i class="bi bi-box-arrow-in-down"></i> Import from Invoices
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openAddMappingModal()">
                                    <i class="bi bi-plus-lg"></i> Add Mapping
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-2">
                            Map e-Factura partner names to standardized supplier names used in the Invoice module.
                        </p>

                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="mappingsFiltersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Partner</label>
                                    <select class="form-select form-select-sm" id="mappingsPartnerFilter" onchange="filterMappings()">
                                        <option value="">All Partners</option>
                                        <!-- Populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Partner VAT</label>
                                    <input type="text" class="form-control form-control-sm" id="mappingsVatFilter" placeholder="Filter by VAT..." onkeyup="if(event.key==='Enter') filterMappings()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Supplier</label>
                                    <input type="text" class="form-control form-control-sm" id="mappingsSupplierFilter" placeholder="Filter by supplier..." onkeyup="if(event.key==='Enter') filterMappings()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Type</label>
                                    <select class="form-select form-select-sm" id="mappingsTypeFilter" onchange="filterMappings()">
                                        <option value="">All Types</option>
                                        <!-- Populated dynamically from partnerTypesCache -->
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Per Page</label>
                                    <select class="form-select form-select-sm" id="mappingsPageSize" onchange="changeMappingsPageSize(this.value)">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                        <option value="0">All</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-primary me-1" onclick="filterMappings()">
                                        <i class="bi bi-search"></i> Apply
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearMappingsFilters()">
                                        <i class="bi bi-x"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions for Mappings -->
                        <div class="bulk-action-bar" id="mappingsBulkActionBar">
                            <span><strong id="mappingsSelectedCount">0</strong> selected</span>
                            <div class="d-flex gap-2 align-items-center">
                                <!-- Bulk Set Type Dropdown -->
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="bi bi-tag"></i> Set Type
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="bulkSetMappingsType(null); return false;">
                                            <i class="bi bi-x-circle text-muted"></i> No Type
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="bulkSetMappingsType('Service'); return false;">
                                            <span class="badge bg-info me-2">Service</span> Service
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="bulkSetMappingsType('Merchandise'); return false;">
                                            <span class="badge bg-warning me-2">Merchandise</span> Merchandise
                                        </a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteMappings()">
                                    <i class="bi bi-trash"></i> Delete Selected
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearMappingsSelection()">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="mappingsTable">
                                <thead class="table-light">
                                    <!-- Rendered dynamically by renderMappingsTableHeader() -->
                                </thead>
                                <tbody id="mappingsTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">Click "Mappings" tab to load supplier mappings</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Footer -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="mappingsPaginationFooter" style="display: none !important;">
                            <div class="text-muted small">
                                Showing <span id="mappingsShowingRange">0-0</span> of <span id="mappingsTotalCount">0</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="mappingsPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Mapping Modal -->
    <div class="modal fade" id="mappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mappingModalTitle"><i class="bi bi-diagram-3"></i> Add Supplier Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="mappingId">
                    <div class="mb-3">
                        <label class="form-label">Partner Name (e-Factura) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="mappingPartnerName" placeholder="Name as it appears in e-Factura">
                        <div class="form-text">The supplier name as it appears on e-Factura invoices</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Partner VAT (e-Factura)</label>
                        <input type="text" class="form-control" id="mappingPartnerCif" placeholder="e.g. RO12345678">
                        <div class="form-text">Optional VAT number from e-Factura</div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="mappingSupplierName" placeholder="Standardized supplier name">
                        <div class="form-text">The standardized supplier name for the Invoice module</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier VAT</label>
                        <input type="text" class="form-control" id="mappingSupplierVat" placeholder="e.g. RO12345678">
                        <div class="form-text">Standardized VAT number</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Type(s)</label>
                                <div id="mappingTypeCheckboxes" class="border rounded p-2" style="max-height: 120px; overflow-y: auto;">
                                    <!-- Populated dynamically -->
                                </div>
                                <div class="form-text">Select one or more types</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Kod Konto</label>
                                <input type="text" class="form-control" id="mappingKodKonto" placeholder="e.g. 401.01">
                                <div class="form-text">Accounting code</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier Note</label>
                        <textarea class="form-control" id="mappingSupplierNote" rows="2" placeholder="Optional notes about this supplier..."></textarea>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Default Brand</label>
                        <select class="form-select" id="mappingBrand">
                            <option value="">-- None --</option>
                        </select>
                        <div class="form-text">Default brand for this supplier's invoices</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Default Department</label>
                                <select class="form-select" id="mappingDepartment">
                                    <option value="">-- None --</option>
                                </select>
                                <div class="form-text">Default department for this supplier</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Default Subdepartment</label>
                                <select class="form-select" id="mappingSubdepartment">
                                    <option value="">-- None --</option>
                                </select>
                                <div class="form-text">Default subdepartment for this supplier</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMapping()">
                        <i class="bi bi-check-lg"></i> Save Mapping
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Drag to reorder. Check/uncheck to show/hide.</p>
                    <ul id="columnConfigList" class="list-group" style="cursor: move;"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetColumnConfig()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="applyColumnConfig()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Column Configuration Modal -->
    <div class="modal fade" id="hiddenColumnConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Hidden Tab Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Drag to reorder. Check/uncheck to show/hide.</p>
                    <ul id="hiddenColumnConfigList" class="list-group" style="cursor: move;"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetHiddenColumnConfig()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="applyHiddenColumnConfig()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mappings Column Configuration Modal -->
    <div class="modal fade" id="mappingsColumnConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-layout-three-columns"></i> Configure Mappings Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Drag to reorder. Check/uncheck to show/hide.</p>
                    <ul id="mappingsColumnConfigList" class="list-group" style="cursor: move;"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetMappingsColumnConfig()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="applyMappingsColumnConfig()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Modal -->
    <div class="modal fade" id="syncModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cloud-arrow-down text-success"></i> Sync from ANAF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Period Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold"><i class="bi bi-calendar3"></i> Period</label>
                        <div class="btn-group w-100 mb-2" role="group" id="syncPeriodGroup">
                            <input type="radio" class="btn-check" name="syncPeriod" id="period1" value="1" checked>
                            <label class="btn btn-outline-primary" for="period1">1 day</label>
                            <input type="radio" class="btn-check" name="syncPeriod" id="period3" value="3">
                            <label class="btn btn-outline-primary" for="period3">3 days</label>
                            <input type="radio" class="btn-check" name="syncPeriod" id="period7" value="7">
                            <label class="btn btn-outline-primary" for="period7">7 days</label>
                            <input type="radio" class="btn-check" name="syncPeriod" id="period15" value="15">
                            <label class="btn btn-outline-primary" for="period15">15 days</label>
                            <input type="radio" class="btn-check" name="syncPeriod" id="period30" value="30">
                            <label class="btn btn-outline-primary" for="period30">30 days</label>
                        </div>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Custom</span>
                            <input type="number" class="form-control" id="syncCustomDays" placeholder="Enter days" min="1" max="90" onchange="clearPeriodSelection()">
                            <span class="input-group-text">days (max 90)</span>
                        </div>
                    </div>

                    <!-- Company Selection -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label fw-semibold mb-0"><i class="bi bi-building"></i> Companies</label>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllSyncCompanies(true)">Select All</button>
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleAllSyncCompanies(false)">Deselect All</button>
                            </div>
                        </div>
                        <div id="syncCompaniesLoading" class="text-center py-3">
                            <span class="spinner-border spinner-border-sm"></span> Loading companies...
                        </div>
                        <div id="syncCompaniesContainer" class="border rounded p-2" style="max-height: 250px; overflow-y: auto; display: none;">
                            <!-- Populated dynamically -->
                        </div>
                        <div id="syncCompaniesEmpty" class="alert alert-warning mb-0 mt-2" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> No connected companies found.
                            <a href="/efactura/">Go to Connector Settings</a> to add a connection.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="startSync()" id="startSyncBtn">
                        <i class="bi bi-cloud-arrow-down"></i> Start Sync
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Partner Types Settings Modal -->
    <div class="modal fade" id="partnerTypesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-tags"></i> Partner Types</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Manage partner types for supplier mappings (e.g., Service, Merchandise).</p>

                    <!-- Add new type form -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-sm" id="newTypeName" placeholder="e.g. Service">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small mb-1">Description</label>
                                    <input type="text" class="form-control form-control-sm" id="newTypeDescription" placeholder="Optional description">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary btn-sm w-100" onclick="addPartnerType()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Types list -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Hide in Filter</th>
                                    <th>Status</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partnerTypesTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <span class="spinner-border spinner-border-sm"></span> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Invoice Overrides Modal -->
    <div class="modal fade" id="editInvoiceOverridesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Edit Invoice Overrides</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editInvoiceId">
                    <p class="text-muted small mb-3">
                        Override the Type, Department, and Subdepartment for this specific invoice.
                        These values take precedence over the supplier mapping defaults.
                    </p>
                    <div class="mb-3">
                        <label class="form-label">Invoice</label>
                        <div id="editInvoiceInfo" class="form-control-plaintext border rounded px-2 py-1 bg-light">
                            <!-- Invoice info populated dynamically -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type Override</label>
                        <select class="form-select" id="invoiceTypeOverride">
                            <option value="">-- Use Mapping Default --</option>
                        </select>
                        <div class="form-text">Leave empty to use the supplier mapping default</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Department Override</label>
                                <select class="form-select" id="invoiceDepartmentOverride">
                                    <option value="">-- Use Mapping Default --</option>
                                </select>
                                <div class="form-text">Leave empty to use the supplier mapping default</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subdepartment Override</label>
                                <select class="form-select" id="invoiceSubdepartmentOverride">
                                    <option value="">-- Use Mapping Default --</option>
                                </select>
                                <div class="form-text">Leave empty to use the supplier mapping default</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInvoiceOverrides()">
                        <i class="bi bi-check-lg"></i> Save Overrides
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Set Overrides Modal -->
    <div class="modal fade" id="bulkSetOverridesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Bulk Set Type/Department</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small mb-3">
                        <i class="bi bi-info-circle"></i>
                        Set Type, Department, and/or Subdepartment overrides for <strong id="bulkOverrideCount">0</strong> selected invoices.
                        Leave a field empty to keep the existing value unchanged.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type Override</label>
                        <select class="form-select" id="bulkTypeOverride">
                            <option value="">-- Keep Existing --</option>
                            <option value="__CLEAR__">Clear Override (Use Mapping Default)</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Department Override</label>
                                <select class="form-select" id="bulkDepartmentOverride">
                                    <option value="">-- Keep Existing --</option>
                                    <option value="__CLEAR__">Clear Override (Use Mapping Default)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Subdepartment Override</label>
                                <select class="form-select" id="bulkSubdepartmentOverride">
                                    <option value="">-- Keep Existing --</option>
                                    <option value="__CLEAR__">Clear Override (Use Mapping Default)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="applyBulkOverrides()">
                        <i class="bi bi-check-lg"></i> Apply to Selected
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceDetailsContent">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="modalSendToInvoicesBtn">
                        <i class="bi bi-send"></i> Send to Invoices
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jarvis-dialogs.js') }}"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = parseInt(localStorage.getItem('efacturaPageSize')) || 50;
        let currentInvoiceId = null;
        let companiesCache = [];
        let selectedInvoices = new Set();
        let selectedHiddenInvoices = new Set();
        let selectedBinInvoices = new Set();

        // Sorting state - Unallocated table
        let sortColumn = localStorage.getItem('efacturaSortColumn') || 'issue_date';
        let sortDirection = localStorage.getItem('efacturaSortDir') || 'desc';
        let invoicesCache = []; // Cache for client-side sorting
        let unallocatedLoaded = false; // Tab loaded flag
        let lastUnallocatedFilters = ''; // Track last used filter state

        // Hide typed invoices in Unallocated - they appear in Hidden tab based on type settings
        const hideTypedInvoices = true;

        // Sorting state - Hidden table
        let hiddenSortColumn = localStorage.getItem('efacturaHiddenSortColumn') || 'issue_date';
        let hiddenSortDirection = localStorage.getItem('efacturaHiddenSortDir') || 'desc';
        let hiddenCache = [];
        let hiddenLoaded = false; // Tab loaded flag
        let hiddenCurrentPage = 1;
        let hiddenTotalPages = 1;
        let hiddenPageSize = parseInt(localStorage.getItem('efacturaHiddenPageSize')) || 50;
        let lastHiddenFilters = ''; // Track last used filter state

        // Sorting state - Bin table
        let binSortColumn = localStorage.getItem('efacturaBinSortColumn') || 'deleted_at';
        let binSortDirection = localStorage.getItem('efacturaBinSortDir') || 'desc';
        let binCache = [];
        let binLoaded = false; // Tab loaded flag
        let binCurrentPage = 1;
        let binTotalPages = 1;
        let binPageSize = parseInt(localStorage.getItem('efacturaBinPageSize')) || 50;
        let lastBinFilters = ''; // Track last used filter state

        // Sorting state - Mappings table
        let mappingsSortColumn = localStorage.getItem('efacturaMappingsSortColumn') || 'partner_name';
        let mappingsSortDirection = localStorage.getItem('efacturaMappingsSortDir') || 'asc';
        let mappingsLoaded = false; // Tab loaded flag

        // Column definitions
        const allColumns = [
            { id: 'checkbox', label: '', fixed: true, width: '40px' },
            { id: 'company', label: 'Company', visible: true },
            { id: 'direction', label: 'Direction', visible: true },
            { id: 'invoice_number', label: 'Invoice #', visible: true },
            { id: 'partner_name', label: 'Supplier / Partner', visible: true },
            { id: 'partner_cif', label: 'Partner VAT', visible: true },
            { id: 'type', label: 'Type', visible: true },
            { id: 'department', label: 'Department', visible: true },
            { id: 'subdepartment', label: 'Subdepartment', visible: false },
            { id: 'issue_date', label: 'Issue Date', visible: true },
            { id: 'amount', label: 'Amount', visible: true, align: 'end' },
            { id: 'vat', label: 'VAT', visible: true, align: 'end' },
            { id: 'currency', label: 'Currency', visible: true },
            { id: 'imported', label: 'Imported', visible: true },
            { id: 'actions', label: 'Actions', fixed: true, width: '180px' }
        ];

        // Column config version - increment when columns are added/removed to reset user configs
        const COLUMN_CONFIG_VERSION = 2; // Bumped for department/subdepartment columns

        // Load column config from localStorage
        function getColumnConfig() {
            const saved = localStorage.getItem('efacturaColumnConfig');
            const savedVersion = parseInt(localStorage.getItem('efacturaColumnConfigVersion') || '0');

            // If version mismatch, reset to defaults
            if (savedVersion !== COLUMN_CONFIG_VERSION) {
                localStorage.setItem('efacturaColumnConfigVersion', COLUMN_CONFIG_VERSION.toString());
                localStorage.removeItem('efacturaColumnConfig');
                return allColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
            }

            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    // Ensure all current columns are in config (handle any missed columns)
                    const configIds = new Set(config.map(c => c.id));
                    const missingCols = allColumns.filter(c => !configIds.has(c.id));
                    if (missingCols.length > 0) {
                        // Add missing columns at their default position
                        missingCols.forEach(col => {
                            config.push({ id: col.id, visible: col.visible !== false, order: allColumns.indexOf(col) });
                        });
                        saveColumnConfig(config);
                    }
                    return config;
                } catch (e) {}
            }
            return allColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
        }

        function saveColumnConfig(config) {
            localStorage.setItem('efacturaColumnConfig', JSON.stringify(config));
            localStorage.setItem('efacturaColumnConfigVersion', COLUMN_CONFIG_VERSION.toString());
        }

        function getVisibleColumns() {
            const config = getColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: c.order ?? i });

            return allColumns
                .map(col => ({
                    ...col,
                    visible: col.fixed || (configMap[col.id]?.visible ?? col.visible),
                    order: configMap[col.id]?.order ?? allColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order)
                .filter(col => col.visible || col.fixed);
        }

        // Sortable columns (columns that can be sorted)
        const sortableColumns = ['company', 'direction', 'invoice_number', 'partner_name', 'partner_cif', 'type', 'department', 'subdepartment', 'issue_date', 'amount', 'vat', 'currency', 'imported'];

        // ============================================
        // Hidden Tab Column Configuration
        // ============================================

        // Column definitions for Hidden tab
        const hiddenAllColumns = [
            { id: 'checkbox', label: '', fixed: true, width: '40px' },
            { id: 'company', label: 'Company', visible: false },
            { id: 'direction', label: 'Direction', visible: true },
            { id: 'invoice_number', label: 'Invoice #', visible: true },
            { id: 'partner_name', label: 'Supplier / Partner', visible: true },
            { id: 'partner_cif', label: 'Partner VAT', visible: false },
            { id: 'type', label: 'Type', visible: true },
            { id: 'issue_date', label: 'Issue Date', visible: true },
            { id: 'amount', label: 'Amount', visible: true, align: 'end' },
            { id: 'vat', label: 'VAT', visible: false, align: 'end' },
            { id: 'currency', label: 'Currency', visible: true },
            { id: 'imported', label: 'Imported', visible: false },
            { id: 'actions', label: 'Actions', fixed: true, width: '120px' }
        ];

        const HIDDEN_COLUMN_CONFIG_VERSION = 2;

        function getHiddenColumnConfig() {
            const saved = localStorage.getItem('efacturaHiddenColumnConfig');
            const savedVersion = parseInt(localStorage.getItem('efacturaHiddenColumnConfigVersion') || '0');

            if (savedVersion !== HIDDEN_COLUMN_CONFIG_VERSION) {
                localStorage.setItem('efacturaHiddenColumnConfigVersion', HIDDEN_COLUMN_CONFIG_VERSION.toString());
                localStorage.removeItem('efacturaHiddenColumnConfig');
                return hiddenAllColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
            }

            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    const configIds = new Set(config.map(c => c.id));
                    const missingCols = hiddenAllColumns.filter(c => !configIds.has(c.id));
                    if (missingCols.length > 0) {
                        missingCols.forEach(col => {
                            config.push({ id: col.id, visible: col.visible !== false, order: hiddenAllColumns.indexOf(col) });
                        });
                        saveHiddenColumnConfig(config);
                    }
                    return config;
                } catch (e) {}
            }
            return hiddenAllColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
        }

        function saveHiddenColumnConfig(config) {
            localStorage.setItem('efacturaHiddenColumnConfig', JSON.stringify(config));
            localStorage.setItem('efacturaHiddenColumnConfigVersion', HIDDEN_COLUMN_CONFIG_VERSION.toString());
        }

        function getHiddenVisibleColumns() {
            const config = getHiddenColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: c.order ?? i });

            return hiddenAllColumns
                .map(col => ({
                    ...col,
                    visible: col.fixed || (configMap[col.id]?.visible ?? col.visible),
                    order: configMap[col.id]?.order ?? hiddenAllColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order)
                .filter(col => col.visible || col.fixed);
        }

        const hiddenSortableColumns = ['company', 'direction', 'invoice_number', 'partner_name', 'partner_cif', 'type', 'issue_date', 'amount', 'vat', 'currency', 'imported'];

        // ============================================
        // Mappings Tab Column Configuration
        // ============================================

        // Column definitions for Mappings tab
        const mappingsAllColumns = [
            { id: 'checkbox', label: '', fixed: true, width: '60px' },
            { id: 'partner_name', label: 'Partner (e-Factura)', visible: true },
            { id: 'partner_cif', label: 'Partner VAT', visible: true },
            { id: 'supplier_name', label: 'Supplier Name', visible: true },
            { id: 'supplier_vat', label: 'Supplier VAT', visible: true },
            { id: 'type', label: 'Type', visible: true },
            { id: 'brand', label: 'Brand', visible: true },
            { id: 'department', label: 'Department', visible: true },
            { id: 'subdepartment', label: 'Subdepartment', visible: false },
            { id: 'kod_konto', label: 'Kod Konto', visible: false },
            { id: 'supplier_note', label: 'Supplier Note', visible: false },
            { id: 'created_at', label: 'Created', visible: true },
            { id: 'actions', label: 'Actions', fixed: true, width: '100px' }
        ];

        const MAPPINGS_COLUMN_CONFIG_VERSION = 2;

        function getMappingsColumnConfig() {
            const saved = localStorage.getItem('efacturaMappingsColumnConfig');
            const savedVersion = parseInt(localStorage.getItem('efacturaMappingsColumnConfigVersion') || '0');

            if (savedVersion !== MAPPINGS_COLUMN_CONFIG_VERSION) {
                localStorage.setItem('efacturaMappingsColumnConfigVersion', MAPPINGS_COLUMN_CONFIG_VERSION.toString());
                localStorage.removeItem('efacturaMappingsColumnConfig');
                return mappingsAllColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
            }

            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    const configIds = new Set(config.map(c => c.id));
                    const missingCols = mappingsAllColumns.filter(c => !configIds.has(c.id));
                    if (missingCols.length > 0) {
                        missingCols.forEach(col => {
                            config.push({ id: col.id, visible: col.visible !== false, order: mappingsAllColumns.indexOf(col) });
                        });
                        saveMappingsColumnConfig(config);
                    }
                    return config;
                } catch (e) {}
            }
            return mappingsAllColumns.map((c, i) => ({ id: c.id, visible: c.visible !== false, order: i }));
        }

        function saveMappingsColumnConfig(config) {
            localStorage.setItem('efacturaMappingsColumnConfig', JSON.stringify(config));
            localStorage.setItem('efacturaMappingsColumnConfigVersion', MAPPINGS_COLUMN_CONFIG_VERSION.toString());
        }

        function getMappingsVisibleColumns() {
            const config = getMappingsColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: c.order ?? i });

            return mappingsAllColumns
                .map(col => ({
                    ...col,
                    visible: col.fixed || (configMap[col.id]?.visible ?? col.visible),
                    order: configMap[col.id]?.order ?? mappingsAllColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order)
                .filter(col => col.visible || col.fixed);
        }

        const mappingsSortableColumns = ['partner_name', 'partner_cif', 'supplier_name', 'supplier_vat', 'type_name', 'brand', 'department', 'subdepartment', 'kod_konto', 'created_at'];

        function renderMappingsTableHeader() {
            const thead = document.querySelector('#mappingsTable thead');
            const cols = getMappingsVisibleColumns();

            thead.innerHTML = `<tr>
                ${cols.map(col => {
                    if (col.id === 'checkbox') {
                        return `<th style="width: 60px;">
                            <div class="dropdown d-inline">
                                <input type="checkbox" class="form-check-input" id="mappingsSelectAll" onchange="toggleMappingsSelectPage()">
                                <button class="btn btn-link btn-sm p-0 ms-1 text-muted" type="button" data-bs-toggle="dropdown" style="font-size: 10px;">
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-sm">
                                    <li><a class="dropdown-item small" href="#" onclick="toggleMappingsSelectPage(); return false;"><i class="bi bi-check2-square me-2"></i>Select Page</a></li>
                                    <li><a class="dropdown-item small" href="#" onclick="selectAllMappings(); return false;"><i class="bi bi-check2-all me-2"></i>Select All (<span id="mappingsTotalForSelect">0</span>)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item small" href="#" onclick="clearMappingsSelection(); return false;"><i class="bi bi-x-square me-2"></i>Clear Selection</a></li>
                                </ul>
                            </div>
                        </th>`;
                    }
                    if (col.id === 'actions') {
                        return `<th style="${col.width ? 'width:' + col.width : ''}">Actions</th>`;
                    }
                    const sortCol = col.id === 'type' ? 'type_name' : col.id;
                    const isSortable = mappingsSortableColumns.includes(sortCol);
                    return `<th${isSortable ? ` class="sortable" onclick="sortMappingsTable('${sortCol}')"` : ''}${col.width ? ` style="width:${col.width}"` : ''}>${col.label}</th>`;
                }).join('')}
            </tr>`;
        }

        function renderHiddenTableHeader() {
            const thead = document.getElementById('hiddenTableHead');
            const cols = getHiddenVisibleColumns();

            thead.innerHTML = `<tr>
                ${cols.map(col => {
                    if (col.id === 'checkbox') {
                        return `<th style="width: 60px">
                            <div class="dropdown d-inline">
                                <input type="checkbox" class="form-check-input" id="hiddenSelectAll" onchange="toggleHiddenSelectPage()">
                                <button class="btn btn-link btn-sm p-0 ms-1 text-muted" type="button" data-bs-toggle="dropdown" style="font-size: 10px;">
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-sm">
                                    <li><a class="dropdown-item small" href="#" onclick="toggleHiddenSelectPage(); return false;"><i class="bi bi-check2-square me-2"></i>Select Page</a></li>
                                    <li><a class="dropdown-item small" href="#" onclick="selectAllHidden(); return false;"><i class="bi bi-check2-all me-2"></i>Select All (<span id="hiddenTotalForSelect">0</span>)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item small" href="#" onclick="clearHiddenSelection(); return false;"><i class="bi bi-x-square me-2"></i>Clear Selection</a></li>
                                </ul>
                            </div>
                        </th>`;
                    }
                    const align = col.align === 'end' ? 'text-end' : '';
                    const width = col.width ? `style="width: ${col.width}"` : '';
                    const isSortable = hiddenSortableColumns.includes(col.id);
                    const sortClass = isSortable ? `sortable ${hiddenSortColumn === col.id ? hiddenSortDirection : ''}` : '';
                    const onClick = isSortable ? `onclick="sortHiddenTable('${col.id}')"` : '';
                    return `<th class="${align} ${sortClass}" ${width} ${onClick}>${col.label}</th>`;
                }).join('')}
            </tr>`;
        }

        function openHiddenColumnConfig() {
            const modal = new bootstrap.Modal(document.getElementById('hiddenColumnConfigModal'));
            const list = document.getElementById('hiddenColumnConfigList');
            const config = getHiddenColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: i });

            const configCols = hiddenAllColumns
                .filter(col => !col.fixed)
                .map(col => ({
                    ...col,
                    visible: configMap[col.id]?.visible ?? col.visible,
                    order: configMap[col.id]?.order ?? hiddenAllColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order);

            list.innerHTML = configCols.map(col => `
                <li class="list-group-item d-flex align-items-center" data-id="${col.id}">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <input type="checkbox" class="form-check-input me-2" id="hidden_col_${col.id}" ${col.visible ? 'checked' : ''}>
                    <label class="form-check-label flex-grow-1" for="hidden_col_${col.id}">${col.label}</label>
                </li>
            `).join('');

            // Enable drag-drop reorder
            if (typeof Sortable !== 'undefined') {
                new Sortable(list, { animation: 150 });
            }
            modal.show();
        }

        function applyHiddenColumnConfig() {
            const list = document.getElementById('hiddenColumnConfigList');
            const items = list.querySelectorAll('li');
            const config = [];
            let order = 0;

            config.push({ id: 'checkbox', visible: true, order: order++ });

            items.forEach(item => {
                const id = item.dataset.id;
                const visible = item.querySelector('input[type="checkbox"]').checked;
                config.push({ id, visible, order: order++ });
            });

            config.push({ id: 'actions', visible: true, order: order++ });

            saveHiddenColumnConfig(config);
            renderHiddenTableHeader();
            loadHiddenInvoices(hiddenCurrentPage, true);
        }

        function resetHiddenColumnConfig() {
            localStorage.removeItem('efacturaHiddenColumnConfig');
            bootstrap.Modal.getInstance(document.getElementById('hiddenColumnConfigModal')).hide();
            renderHiddenTableHeader();
            loadHiddenInvoices(hiddenCurrentPage, true);
        }

        // Mappings Column Configuration Modal Functions
        function openMappingsColumnConfig() {
            const modal = new bootstrap.Modal(document.getElementById('mappingsColumnConfigModal'));
            const list = document.getElementById('mappingsColumnConfigList');
            const config = getMappingsColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: i });

            const configCols = mappingsAllColumns
                .filter(col => !col.fixed)
                .map(col => ({
                    ...col,
                    visible: configMap[col.id]?.visible ?? col.visible,
                    order: configMap[col.id]?.order ?? mappingsAllColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order);

            list.innerHTML = configCols.map(col => `
                <li class="list-group-item d-flex align-items-center" data-id="${col.id}">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <input type="checkbox" class="form-check-input me-2" id="mappings_col_${col.id}" ${col.visible ? 'checked' : ''}>
                    <label class="form-check-label flex-grow-1" for="mappings_col_${col.id}">${col.label}</label>
                </li>
            `).join('');

            // Enable drag-drop reorder
            if (typeof Sortable !== 'undefined') {
                new Sortable(list, { animation: 150 });
            }
            modal.show();
        }

        function applyMappingsColumnConfig() {
            const list = document.getElementById('mappingsColumnConfigList');
            const items = list.querySelectorAll('li');
            const config = [];
            let order = 0;

            config.push({ id: 'checkbox', visible: true, order: order++ });

            items.forEach(item => {
                const id = item.dataset.id;
                const visible = item.querySelector('input[type="checkbox"]').checked;
                config.push({ id, visible, order: order++ });
            });

            config.push({ id: 'actions', visible: true, order: order++ });

            saveMappingsColumnConfig(config);
            renderMappingsTableHeader();
            // Re-render the table with current page data
            if (mappingsCache.length > 0) {
                const filtered = filteredMappingsCache.length > 0 ? filteredMappingsCache : mappingsCache;
                const start = (mappingsCurrentPage - 1) * mappingsPageSize;
                const end = mappingsPageSize === 0 ? filtered.length : start + mappingsPageSize;
                renderMappingsTable(filtered.slice(start, end));
            }
        }

        function resetMappingsColumnConfig() {
            localStorage.removeItem('efacturaMappingsColumnConfig');
            bootstrap.Modal.getInstance(document.getElementById('mappingsColumnConfigModal')).hide();
            renderMappingsTableHeader();
            // Re-render the table with current page data
            if (mappingsCache.length > 0) {
                const filtered = filteredMappingsCache.length > 0 ? filteredMappingsCache : mappingsCache;
                const start = (mappingsCurrentPage - 1) * mappingsPageSize;
                const end = mappingsPageSize === 0 ? filtered.length : start + mappingsPageSize;
                renderMappingsTable(filtered.slice(start, end));
            }
        }

        // Render table header
        function renderTableHeader() {
            const thead = document.getElementById('invoicesTableHead');
            const cols = getVisibleColumns();

            const allSelected = selectedInvoices.size > 0;
            thead.innerHTML = `<tr>
                ${cols.map(col => {
                    if (col.id === 'checkbox') {
                        return `<th style="width: 60px">
                            <div class="dropdown d-inline">
                                <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectPage()" ${allSelected ? 'checked' : ''}>
                                <button class="btn btn-link btn-sm p-0 ms-1 text-muted" type="button" data-bs-toggle="dropdown" style="font-size: 10px;">
                                    <i class="bi bi-chevron-down"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-sm">
                                    <li><a class="dropdown-item small" href="#" onclick="toggleSelectPage(); return false;"><i class="bi bi-check2-square me-2"></i>Select Page</a></li>
                                    <li><a class="dropdown-item small" href="#" onclick="selectAllInvoices(); return false;"><i class="bi bi-check2-all me-2"></i>Select All (<span id="invoicesTotalForSelect">${totalPages * pageSize}</span>)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item small" href="#" onclick="clearSelection(); return false;"><i class="bi bi-x-square me-2"></i>Clear Selection</a></li>
                                </ul>
                            </div>
                        </th>`;
                    }
                    const align = col.align === 'end' ? 'text-end' : '';
                    const width = col.width ? `style="width: ${col.width}"` : '';
                    const isSortable = sortableColumns.includes(col.id);
                    const sortClass = isSortable ? `sortable ${sortColumn === col.id ? sortDirection : ''}` : '';
                    const onClick = isSortable ? `onclick="sortTable('${col.id}')"` : '';
                    return `<th class="${align} ${sortClass}" ${width} ${onClick}>${col.label}</th>`;
                }).join('')}
            </tr>`;
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            localStorage.setItem('efacturaSortColumn', sortColumn);
            localStorage.setItem('efacturaSortDir', sortDirection);
            renderTableHeader();
            sortAndRenderInvoices();
        }

        // Sort and render invoices from cache
        function sortAndRenderInvoices() {
            if (!invoicesCache || invoicesCache.length === 0) {
                renderInvoices([]);  // Render empty state instead of leaving "Loading..."
                return;
            }

            const sorted = [...invoicesCache].sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // Handle special columns
                if (sortColumn === 'amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                } else if (sortColumn === 'vat') {
                    valA = parseFloat(a.total_vat || 0);
                    valB = parseFloat(b.total_vat || 0);
                } else if (sortColumn === 'imported') {
                    valA = a.created_at || '';
                    valB = b.created_at || '';
                } else if (sortColumn === 'type') {
                    valA = a.type_name || '';
                    valB = b.type_name || '';
                }

                // Null handling
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                // String comparison
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderInvoices(sorted);
        }

        // Sort Hidden table
        function sortHiddenTable(column) {
            if (hiddenSortColumn === column) {
                hiddenSortDirection = hiddenSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                hiddenSortColumn = column;
                hiddenSortDirection = 'asc';
            }
            localStorage.setItem('efacturaHiddenSortColumn', hiddenSortColumn);
            localStorage.setItem('efacturaHiddenSortDir', hiddenSortDirection);
            renderHiddenTableHeader();
            sortAndRenderHidden();
        }

        function sortAndRenderHidden() {
            // Update total count in dropdown
            const totalEl = document.getElementById('hiddenTotalForSelect');
            if (totalEl) {
                totalEl.textContent = hiddenCache ? hiddenCache.length : 0;
            }
            if (!hiddenCache || hiddenCache.length === 0) {
                renderHiddenTable([]);
                return;
            }
            const sorted = [...hiddenCache].sort((a, b) => {
                let valA = a[hiddenSortColumn];
                let valB = b[hiddenSortColumn];
                if (hiddenSortColumn === 'total_amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                }
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return hiddenSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return hiddenSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderHiddenTable(sorted);
        }

        // Sort Bin table
        function sortBinTable(column) {
            if (binSortColumn === column) {
                binSortDirection = binSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                binSortColumn = column;
                binSortDirection = 'asc';
            }
            localStorage.setItem('efacturaBinSortColumn', binSortColumn);
            localStorage.setItem('efacturaBinSortDir', binSortDirection);
            updateBinTableHeaders();
            sortAndRenderBin();
        }

        function updateBinTableHeaders() {
            document.querySelectorAll('#binTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortBinTable\('(\w+)'\)/)?.[1];
                if (col === binSortColumn) {
                    th.classList.add(binSortDirection);
                }
            });
        }

        function sortAndRenderBin() {
            // Update total count in dropdown
            const totalEl = document.getElementById('binTotalForSelect');
            if (totalEl) {
                totalEl.textContent = binCache ? binCache.length : 0;
            }
            if (!binCache || binCache.length === 0) {
                renderBinTable([]);
                return;
            }
            const sorted = [...binCache].sort((a, b) => {
                let valA = a[binSortColumn];
                let valB = b[binSortColumn];
                if (binSortColumn === 'total_amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                }
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return binSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return binSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderBinTable(sorted);
        }

        // Sort Mappings table
        function sortMappingsTable(column) {
            if (mappingsSortColumn === column) {
                mappingsSortDirection = mappingsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                mappingsSortColumn = column;
                mappingsSortDirection = 'asc';
            }
            localStorage.setItem('efacturaMappingsSortColumn', mappingsSortColumn);
            localStorage.setItem('efacturaMappingsSortDir', mappingsSortDirection);
            updateMappingsTableHeaders();
            sortAndRenderMappings();
        }

        function updateMappingsTableHeaders() {
            document.querySelectorAll('#mappingsTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortMappingsTable\('(\w+)'\)/)?.[1];
                if (col === mappingsSortColumn) {
                    th.classList.add(mappingsSortDirection);
                }
            });
        }

        function sortAndRenderMappings() {
            // Use filtered cache (can be empty if filters returned no results)
            const dataToSort = filteredMappingsCache !== undefined
                ? filteredMappingsCache
                : (mappingsCache || []);

            if (dataToSort.length === 0) {
                renderMappingsTable([]);
                updateMappingsPagination(0, 0, 0);
                document.getElementById('mappingsResultCount').textContent = '0 mappings';
                return;
            }

            const sorted = [...dataToSort].sort((a, b) => {
                let valA = a[mappingsSortColumn];
                let valB = b[mappingsSortColumn];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return mappingsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return mappingsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Apply pagination (0 = show all)
            const total = sorted.length;
            let paginated = sorted;
            if (mappingsPageSize > 0) {
                const start = (mappingsCurrentPage - 1) * mappingsPageSize;
                const end = start + mappingsPageSize;
                paginated = sorted.slice(start, end);
            }

            renderMappingsTable(paginated);
            updateMappingsPagination(total, mappingsCurrentPage, mappingsPageSize);

            // Update result count badge
            document.getElementById('mappingsResultCount').textContent = `${total} mappings`;
        }

        function updateMappingsPagination(total, currentPage, pageSize) {
            const footer = document.getElementById('mappingsPaginationFooter');
            const pagination = document.getElementById('mappingsPagination');
            const showingRange = document.getElementById('mappingsShowingRange');
            const totalCount = document.getElementById('mappingsTotalCount');

            if (total === 0 || pageSize === 0) {
                footer.style.display = 'none';
                return;
            }

            footer.style.display = 'flex';
            const totalPages = Math.ceil(total / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);

            showingRange.textContent = `${start}-${end}`;
            totalCount.textContent = total;

            // Build pagination buttons
            let html = '';
            html += `<li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToMappingsPage(${currentPage - 1}); return false;">&laquo;</a>
            </li>`;

            for (let i = 1; i <= totalPages && i <= 10; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToMappingsPage(${i}); return false;">${i}</a>
                </li>`;
            }

            html += `<li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToMappingsPage(${currentPage + 1}); return false;">&raquo;</a>
            </li>`;

            pagination.innerHTML = html;
        }

        function goToMappingsPage(page) {
            const total = filteredMappingsCache.length || mappingsCache.length;
            const totalPages = mappingsPageSize > 0 ? Math.ceil(total / mappingsPageSize) : 1;
            if (page < 1 || page > totalPages) return;
            mappingsCurrentPage = page;
            sortAndRenderMappings();
        }

        // Debounce utility - waits for user to stop typing
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Debounced search functions (300ms delay)
        const debouncedSearch = debounce(() => loadUnallocatedInvoices(), 300);
        const debouncedHiddenSearch = debounce(() => loadHiddenInvoices(), 300);
        const debouncedBinSearch = debounce(() => loadBinInvoices(), 300);

        // Hide loading overlay and restore saved tab
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadingOverlay').style.display = 'none';
            renderTableHeader();
            renderHiddenTableHeader();
            loadBadgeCounts();

            // Check if partner types were changed in Settings page while away
            const partnerTypesChanged = localStorage.getItem('efacturaPartnerTypesChanged');
            if (partnerTypesChanged) {
                // Clear the flag and show refresh button
                localStorage.removeItem('efacturaPartnerTypesChanged');
                // Delay showing button until after initial load
                setTimeout(() => showRefreshButton(), 500);
            }

            // Restore saved tab or default to unallocated
            const savedTab = localStorage.getItem('efacturaActiveTab') || 'unallocatedTab';
            const tabLink = document.querySelector(`a[href="#${savedTab}"]`);
            if (tabLink) {
                // Activate the saved tab
                const tab = new bootstrap.Tab(tabLink);
                tab.show();
                // Load data for the saved tab
                switch(savedTab) {
                    case 'hiddenTab': loadHiddenInvoices(); break;
                    case 'binTab': loadBinInvoices(); break;
                    case 'mappingsTab': loadSupplierMappings(); break;
                    default: loadUnallocatedInvoices();
                }
            } else {
                loadUnallocatedInvoices();
            }

            // Save active tab when changed
            document.querySelectorAll('#mainTabs a[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const tabId = e.target.getAttribute('href').substring(1);
                    localStorage.setItem('efacturaActiveTab', tabId);
                });
            });

            // Listen for partner type changes from Settings page (in another tab)
            window.addEventListener('storage', function(e) {
                if (e.key === 'efacturaPartnerTypesChanged' && e.newValue) {
                    // Clear the flag
                    localStorage.removeItem('efacturaPartnerTypesChanged');
                    // Show refresh button to let user know settings changed
                    showRefreshButton();
                    // Reload partner types for dropdown
                    loadPartnerTypesForDropdown();
                }
            });
        });

        // Load badge counts (unallocated badge is updated from updateSummary for visible count)
        async function loadBadgeCounts() {
            try {
                const [hidden, bin] = await Promise.all([
                    fetch('/efactura/api/invoices/hidden/count').then(r => r.json()),
                    fetch('/efactura/api/invoices/bin/count').then(r => r.json())
                ]);

                // Note: unallocatedBadge is updated from updateSummary() with visible count
                updateBadge('hiddenBadge', hidden.count || 0);
                updateBadge('binBadge', bin.count || 0);
            } catch (e) {
                console.error('Error loading badge counts:', e);
            }
        }

        function updateBadge(id, count) {
            const badge = document.getElementById(id);
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        // Invalidate caches when data changes (after hide/unhide/delete/restore)
        function invalidateCaches(which = 'all') {
            if (which === 'all' || which === 'unallocated') unallocatedLoaded = false;
            if (which === 'all' || which === 'hidden') hiddenLoaded = false;
            if (which === 'all' || which === 'bin') binLoaded = false;
            if (which === 'all' || which === 'mappings') mappingsLoaded = false;
        }

        // Helper: Format sync result message with HTML
        function formatSyncResult(imported, skipped, errors) {
            let html = '<div style="text-align: left;">';

            // Separate XML signature files from actual errors
            const xmlFiles = (errors || []).filter(e => e.includes('signature XML') || e.includes('not invoice'));
            const actualErrors = (errors || []).filter(e => !e.includes('signature XML') && !e.includes('not invoice'));

            // Summary section
            html += '<div style="margin-bottom: 12px;">';
            html += `<div style="font-size: 1.1em; margin-bottom: 8px;"><strong>Sync Summary</strong></div>`;
            html += `<div style="display: flex; gap: 20px; flex-wrap: wrap;">`;
            html += `<span><i class="bi bi-check-circle text-success"></i> <strong>${imported}</strong> imported</span>`;
            html += `<span><i class="bi bi-skip-forward text-secondary"></i> <strong>${skipped}</strong> skipped</span>`;
            if (xmlFiles.length > 0) {
                html += `<span><i class="bi bi-file-earmark-code text-info"></i> <strong>${xmlFiles.length}</strong> XML files</span>`;
            }
            if (actualErrors.length > 0) {
                html += `<span><i class="bi bi-exclamation-triangle text-warning"></i> <strong>${actualErrors.length}</strong> errors</span>`;
            }
            html += '</div></div>';

            // XML files section
            if (xmlFiles.length > 0) {
                html += '<div style="border-top: 1px solid var(--border-color, #dee2e6); padding-top: 12px; margin-bottom: 12px;">';
                html += '<div style="font-size: 0.9em; color: var(--text-muted, #6c757d); margin-bottom: 8px;"><i class="bi bi-file-earmark-code"></i> XML Files (not invoices):</div>';
                html += '<div style="max-height: 120px; overflow-y: auto; font-size: 0.85em; background: var(--bg-muted, #f8f9fa); padding: 8px; border-radius: 4px;">';

                const xmlToShow = xmlFiles.slice(0, 5);
                xmlToShow.forEach(err => {
                    const match = err.match(/^(.+?):\s*(.+)$/);
                    if (match) {
                        html += `<div style="margin-bottom: 4px; padding: 2px 0;"><span class="text-muted">${match[1]}:</span> ${match[2]}</div>`;
                    } else {
                        html += `<div style="margin-bottom: 4px; padding: 2px 0;">${err}</div>`;
                    }
                });

                if (xmlFiles.length > 5) {
                    html += `<div style="color: var(--text-muted, #6c757d); font-style: italic;">... and ${xmlFiles.length - 5} more</div>`;
                }
                html += '</div></div>';
            }

            // Actual errors section
            if (actualErrors.length > 0) {
                html += '<div style="border-top: 1px solid var(--border-color, #dee2e6); padding-top: 12px;">';
                html += '<div style="font-size: 0.9em; color: var(--text-muted, #6c757d); margin-bottom: 8px;"><i class="bi bi-exclamation-triangle"></i> Errors:</div>';
                html += '<div style="max-height: 150px; overflow-y: auto; font-size: 0.85em; background: var(--bg-muted, #f8f9fa); padding: 8px; border-radius: 4px;">';

                const errorsToShow = actualErrors.slice(0, 10);
                errorsToShow.forEach(err => {
                    const match = err.match(/^(.+?):\s*Message (\d+) (.+)$/);
                    if (match) {
                        html += `<div style="margin-bottom: 4px; padding: 4px 0; border-bottom: 1px solid var(--border-color, #eee);">`;
                        html += `<span style="font-weight: 500;">${match[1]}</span> - `;
                        html += `<span style="font-family: monospace; color: var(--text-muted, #6c757d);">${match[2]}</span>: `;
                        html += `<span>${match[3]}</span>`;
                        html += '</div>';
                    } else {
                        html += `<div style="margin-bottom: 4px; padding: 4px 0; border-bottom: 1px solid var(--border-color, #eee);">${err}</div>`;
                    }
                });

                if (actualErrors.length > 10) {
                    html += `<div style="color: var(--text-muted, #6c757d); font-style: italic; margin-top: 8px;">... and ${actualErrors.length - 10} more</div>`;
                }
                html += '</div></div>';
            }

            html += '</div>';
            return html;
        }

        // Load unallocated invoices
        async function loadUnallocatedInvoices(page = 1, forceReload = false) {
            const companyId = document.getElementById('companyFilter').value;
            const direction = document.getElementById('directionFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const search = document.getElementById('searchInput').value;

            // Build filter state string to detect changes (include hideTypedInvoices)
            const currentFilters = JSON.stringify({companyId, direction, startDate, endDate, search, pageSize, hideTypedInvoices});
            const filtersChanged = currentFilters !== lastUnallocatedFilters;

            // Skip if already loaded, not forcing reload, page same, and filters unchanged
            if (unallocatedLoaded && !forceReload && page === currentPage && invoicesCache.length > 0 && !filtersChanged) {
                sortAndRenderInvoices();
                return;
            }

            // Update filter state
            lastUnallocatedFilters = currentFilters;

            let url = `/efactura/api/invoices/unallocated?page=${page}&limit=${pageSize}`;
            if (companyId) url += `&company_id=${companyId}`;
            if (direction) url += `&direction=${direction}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (hideTypedInvoices) url += `&hide_typed=true`;
            if (sortColumn) url += `&sort_by=${sortColumn}&sort_dir=${sortDirection}`;

            const tbody = document.getElementById('invoicesTableBody');
            const colCount = getVisibleColumns().length;
            tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    if (data.companies && data.companies.length > 0) {
                        updateCompanyFilter(data.companies);
                    }

                    invoicesCache = data.data || [];
                    sortAndRenderInvoices();
                    updatePagination(data.pagination);
                    updateSummary(data.data, data.pagination);
                    unallocatedLoaded = true; // Mark as loaded
                } else {
                    tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Failed to load invoices'}
                    </td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle"></i> Error: ${err.message}
                </td></tr>`;
            }
        }

        // Change page size
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            localStorage.setItem('efacturaPageSize', pageSize);
            currentPage = 1;
            loadUnallocatedInvoices(1);
        }

        // Load hidden invoices
        async function loadHiddenInvoices(page = 1, forceReload = false) {
            const direction = document.getElementById('hiddenDirectionFilter')?.value || '';
            const startDate = document.getElementById('hiddenStartDate')?.value || '';
            const endDate = document.getElementById('hiddenEndDate')?.value || '';
            const search = document.getElementById('hiddenSearchInput')?.value || '';

            // Build filter state string to detect changes
            const currentFilters = JSON.stringify({direction, startDate, endDate, search, hiddenPageSize});
            const filtersChanged = currentFilters !== lastHiddenFilters;

            // Skip if already loaded, not forcing reload, page same, and filters unchanged
            if (hiddenLoaded && !forceReload && page === hiddenCurrentPage && hiddenCache.length > 0 && !filtersChanged) {
                sortAndRenderHidden();
                return;
            }

            // Update filter state
            lastHiddenFilters = currentFilters;
            hiddenCurrentPage = page;

            let url = `/efactura/api/invoices/hidden?page=${page}&limit=${hiddenPageSize}`;
            if (direction) url += `&direction=${direction}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (hiddenSortColumn) url += `&sort_by=${hiddenSortColumn}&sort_dir=${hiddenSortDirection}`;

            const tbody = document.getElementById('hiddenTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    hiddenCache = data.data || [];
                    hiddenLoaded = true; // Mark as loaded
                    renderHiddenTableHeader();
                    sortAndRenderHidden();
                    updateHiddenPagination(data.pagination);

                    const total = data.pagination?.total || data.data?.length || 0;
                    document.getElementById('hiddenResultCount').textContent = `${total} invoices`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function updateHiddenPagination(pagination) {
            const paginationNav = document.getElementById('hiddenPagination');
            const paginationList = document.getElementById('hiddenPaginationList');
            const paginationInfo = document.getElementById('hiddenPaginationInfo');

            if (!pagination || pagination.total === 0) {
                paginationNav.style.display = 'none';
                return;
            }

            paginationNav.style.display = 'block';
            hiddenTotalPages = pagination.total_pages;
            const start = pagination.offset + 1;
            const end = Math.min(pagination.offset + pagination.limit, pagination.total);
            paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total}`;

            let html = '';
            // Previous button
            html += `<li class="page-item ${pagination.current_page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadHiddenInvoices(${pagination.current_page - 1}, true); return false;">&laquo;</a>
            </li>`;

            // Page numbers
            for (let i = 1; i <= pagination.total_pages; i++) {
                if (i === 1 || i === pagination.total_pages || Math.abs(i - pagination.current_page) <= 2) {
                    html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadHiddenInvoices(${i}, true); return false;">${i}</a>
                    </li>`;
                } else if (Math.abs(i - pagination.current_page) === 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next button
            html += `<li class="page-item ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadHiddenInvoices(${pagination.current_page + 1}, true); return false;">&raquo;</a>
            </li>`;

            paginationList.innerHTML = html;
        }

        function changeHiddenPageSize(newSize) {
            hiddenPageSize = parseInt(newSize);
            localStorage.setItem('efacturaHiddenPageSize', hiddenPageSize);
            hiddenCurrentPage = 1;
            loadHiddenInvoices(1, true);
        }

        function clearHiddenFilters() {
            document.getElementById('hiddenSearchInput').value = '';
            document.getElementById('hiddenDirectionFilter').value = '';
            document.getElementById('hiddenStartDate').value = '';
            document.getElementById('hiddenEndDate').value = '';
            loadHiddenInvoices(1, true);
        }

        function renderHiddenTable(invoices) {
            const tbody = document.getElementById('hiddenTableBody');
            const cols = getHiddenVisibleColumns();
            const colCount = cols.length;

            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted py-4">
                    <i class="bi bi-check-circle text-success"></i> No hidden invoices
                </td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const importedDate = inv.created_at ? new Date(inv.created_at).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const vatAmount = parseFloat(inv.total_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedHiddenInvoices.has(inv.id) ? 'checked' : '';

                const cellMap = {
                    checkbox: `<input type="checkbox" class="form-check-input hidden-checkbox" value="${inv.id}" onchange="updateHiddenSelectionCount()" ${checked}>`,
                    company: `<span class="${inv.company_name ? '' : 'text-muted'}">${inv.company_name || '-'}</span>`,
                    direction: `<span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span>`,
                    invoice_number: `<code>${inv.invoice_number || '-'}</code>`,
                    partner_name: inv.partner_name || '-',
                    partner_cif: `<code class="text-muted">${inv.partner_cif || '-'}</code>`,
                    type: inv.type_name ? `<span class="badge bg-secondary">${inv.type_name}</span>` : '<span class="text-muted">-</span>',
                    issue_date: issueDate,
                    amount: amount,
                    vat: vatAmount,
                    currency: inv.currency || 'RON',
                    imported: `<span class="small text-muted">${importedDate}</span>`,
                    actions: `<div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="restoreFromHidden(${inv.id})" title="Restore">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteFromHidden(${inv.id})" title="Move to Bin">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>`
                };

                const cells = cols.map(col => {
                    const align = col.align === 'end' ? 'text-end' : '';
                    return `<td class="${align}">${cellMap[col.id] || ''}</td>`;
                }).join('');

                return `<tr data-id="${inv.id}">${cells}</tr>`;
            }).join('');

            updateHiddenSelectionCount();
        }

        // Load bin invoices
        async function loadBinInvoices(page = 1, forceReload = false) {
            const direction = document.getElementById('binDirectionFilter')?.value || '';
            const startDate = document.getElementById('binStartDate')?.value || '';
            const endDate = document.getElementById('binEndDate')?.value || '';
            const search = document.getElementById('binSearchInput')?.value || '';

            // Build filter state string to detect changes
            const currentFilters = JSON.stringify({direction, startDate, endDate, search, binPageSize});
            const filtersChanged = currentFilters !== lastBinFilters;

            // Skip if already loaded, not forcing reload, page same, and filters unchanged
            if (binLoaded && !forceReload && page === binCurrentPage && binCache.length > 0 && !filtersChanged) {
                sortAndRenderBin();
                return;
            }

            // Update filter state
            lastBinFilters = currentFilters;
            binCurrentPage = page;

            let url = `/efactura/api/invoices/bin?page=${page}&limit=${binPageSize}`;
            if (direction) url += `&direction=${direction}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (binSortColumn) url += `&sort_by=${binSortColumn}&sort_dir=${binSortDirection}`;

            const tbody = document.getElementById('binTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    binCache = data.data || [];
                    binLoaded = true; // Mark as loaded
                    updateBinTableHeaders();
                    sortAndRenderBin();
                    updateBinPagination(data.pagination);

                    const total = data.pagination?.total || data.data?.length || 0;
                    document.getElementById('binResultCount').textContent = `${total} invoices`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function updateBinPagination(pagination) {
            const paginationNav = document.getElementById('binPagination');
            const paginationList = document.getElementById('binPaginationList');
            const paginationInfo = document.getElementById('binPaginationInfo');

            if (!pagination || pagination.total === 0) {
                paginationNav.style.display = 'none';
                return;
            }

            paginationNav.style.display = 'block';
            binTotalPages = pagination.total_pages;
            const start = pagination.offset + 1;
            const end = Math.min(pagination.offset + pagination.limit, pagination.total);
            paginationInfo.textContent = `Showing ${start}-${end} of ${pagination.total}`;

            let html = '';
            // Previous button
            html += `<li class="page-item ${pagination.current_page === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadBinInvoices(${pagination.current_page - 1}, true); return false;">&laquo;</a>
            </li>`;

            // Page numbers
            for (let i = 1; i <= pagination.total_pages; i++) {
                if (i === 1 || i === pagination.total_pages || Math.abs(i - pagination.current_page) <= 2) {
                    html += `<li class="page-item ${i === pagination.current_page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadBinInvoices(${i}, true); return false;">${i}</a>
                    </li>`;
                } else if (Math.abs(i - pagination.current_page) === 3) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Next button
            html += `<li class="page-item ${pagination.current_page >= pagination.total_pages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadBinInvoices(${pagination.current_page + 1}, true); return false;">&raquo;</a>
            </li>`;

            paginationList.innerHTML = html;
        }

        function changeBinPageSize(newSize) {
            binPageSize = parseInt(newSize);
            localStorage.setItem('efacturaBinPageSize', binPageSize);
            binCurrentPage = 1;
            loadBinInvoices(1, true);
        }

        function clearBinFilters() {
            document.getElementById('binSearchInput').value = '';
            document.getElementById('binDirectionFilter').value = '';
            document.getElementById('binStartDate').value = '';
            document.getElementById('binEndDate').value = '';
            loadBinInvoices(1, true);
        }

        function renderBinTable(invoices) {
            const tbody = document.getElementById('binTableBody');
            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-check-circle text-success"></i> Bin is empty
                </td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const deletedAt = inv.deleted_at ? new Date(inv.deleted_at).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedBinInvoices.has(inv.id) ? 'checked' : '';

                return `<tr data-id="${inv.id}">
                    <td><input type="checkbox" class="form-check-input bin-checkbox" value="${inv.id}" onchange="updateBinSelectionCount()" ${checked}></td>
                    <td><span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span></td>
                    <td><code>${inv.invoice_number || '-'}</code></td>
                    <td>${inv.partner_name || '-'}</td>
                    <td>${issueDate}</td>
                    <td class="text-end">${amount}</td>
                    <td><span class="small text-muted">${deletedAt}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="restoreFromBin(${inv.id})" title="Restore">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="permanentDelete(${inv.id})" title="Permanently Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');

            updateBinSelectionCount();
        }

        // Sync Progress UI helpers
        function showSyncProgress(status, detail, progress = null, state = 'syncing') {
            const container = document.getElementById('syncProgressContainer');
            const statusText = document.getElementById('syncStatusText');
            const progressBar = document.getElementById('syncProgressBar');
            const progressDetail = document.getElementById('syncProgressDetail');

            container.style.display = 'flex';
            container.className = 'sync-progress-container' + (state !== 'syncing' ? ' ' + state : '');
            statusText.textContent = status;
            progressDetail.textContent = detail;

            if (progress !== null) {
                progressBar.classList.remove('indeterminate');
                progressBar.style.width = progress + '%';
            } else {
                progressBar.classList.add('indeterminate');
                progressBar.style.width = '30%';
            }
        }

        function hideSyncProgress(delay = 0) {
            setTimeout(() => {
                document.getElementById('syncProgressContainer').style.display = 'none';
                // Clear tooltip when hiding
                const container = document.getElementById('syncProgressContainer');
                container.removeAttribute('data-sync-result');
            }, delay);
        }

        // Store sync result for hover tooltip
        let lastSyncResult = null;

        function storeSyncResultForTooltip(html, status, detail) {
            lastSyncResult = { html, status, detail, timestamp: Date.now() };
            const container = document.getElementById('syncProgressContainer');
            container.setAttribute('data-sync-result', 'true');
            container.style.cursor = 'pointer';
            container.title = 'Click or hover to view sync report';

            // Auto-clear after 4 minutes
            setTimeout(() => {
                lastSyncResult = null;
                container.removeAttribute('data-sync-result');
                container.style.cursor = '';
                container.title = '';
            }, 240000);
        }

        // Show sync result tooltip on click
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('syncProgressContainer');
            if (container) {
                container.addEventListener('click', function() {
                    if (lastSyncResult) {
                        JarvisDialog.alert(lastSyncResult.html, { type: 'info', title: 'Sync Report', html: true });
                    }
                });
            }
        });

        // Sync Modal Functions
        let syncCompaniesCache = [];

        async function openSyncModal() {
            const modal = new bootstrap.Modal(document.getElementById('syncModal'));
            const loading = document.getElementById('syncCompaniesLoading');
            const container = document.getElementById('syncCompaniesContainer');
            const empty = document.getElementById('syncCompaniesEmpty');

            // Show loading state
            loading.style.display = 'block';
            container.style.display = 'none';
            empty.style.display = 'none';

            modal.show();

            try {
                const res = await fetch('/efactura/api/sync/companies');
                const data = await res.json();

                loading.style.display = 'none';

                if (data.success && data.companies && data.companies.length > 0) {
                    syncCompaniesCache = data.companies;
                    container.style.display = 'block';
                    container.innerHTML = data.companies.map(c => `
                        <div class="form-check">
                            <input class="form-check-input sync-company-checkbox" type="checkbox" value="${c.cif}" id="sync_${c.cif}" checked>
                            <label class="form-check-label" for="sync_${c.cif}">
                                <strong>${c.display_name}</strong> <small class="text-muted">(${c.cif})</small>
                            </label>
                        </div>
                    `).join('');
                } else {
                    empty.style.display = 'block';
                }
            } catch (err) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                empty.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Error loading companies: ${err.message}`;
            }
        }

        function toggleAllSyncCompanies(checked) {
            document.querySelectorAll('.sync-company-checkbox').forEach(cb => cb.checked = checked);
        }

        function clearPeriodSelection() {
            // Clear radio buttons when custom days is entered
            const customDays = document.getElementById('syncCustomDays').value;
            if (customDays) {
                document.querySelectorAll('input[name="syncPeriod"]').forEach(r => r.checked = false);
            }
        }

        function startSync() {
            // Get days from custom input or radio buttons
            const customDays = document.getElementById('syncCustomDays').value;
            let days;

            if (customDays && parseInt(customDays) > 0) {
                days = Math.min(parseInt(customDays), 90); // Cap at 90 days
            } else {
                days = parseInt(document.querySelector('input[name="syncPeriod"]:checked')?.value || 1);
            }

            const selectedCifs = Array.from(document.querySelectorAll('.sync-company-checkbox:checked')).map(cb => cb.value);

            if (selectedCifs.length === 0) {
                JarvisDialog.alert('Please select at least one company to sync.', { type: 'warning' });
                return;
            }

            // Close modal and start sync
            bootstrap.Modal.getInstance(document.getElementById('syncModal')).hide();

            // Filter companies to only selected ones
            const selectedCompanies = syncCompaniesCache.filter(c => selectedCifs.includes(c.cif));
            syncWithCompanies(days, selectedCompanies);
        }

        // Sync with specified companies
        async function syncWithCompanies(days, companies) {
            const syncBtn = document.getElementById('syncBtn');
            const originalContent = syncBtn.innerHTML;

            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
            showSyncProgress('Starting...', `Fetching last ${days} day(s)...`, 0, 'syncing');

            let totalImported = 0;
            let totalSkipped = 0;
            let allErrors = [];

            try {
                if (!companies || companies.length === 0) {
                    showSyncProgress('No companies', 'No companies selected', 100, 'error');
                    await JarvisDialog.alert('No companies selected.', { type: 'warning' });
                    hideSyncProgress(3000);
                    return;
                }

                for (let i = 0; i < companies.length; i++) {
                    const company = companies[i];
                    const progress = Math.round(((i) / companies.length) * 100);

                    showSyncProgress(
                        `Syncing ${i + 1}/${companies.length}`,
                        `${company.display_name} (${company.cif})...`,
                        progress,
                        'syncing'
                    );

                    try {
                        // Note: Backend already filters to only received (inbound) invoices
                        const syncRes = await fetch('/efactura/api/sync/company', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cif: company.cif, days: days })
                        });
                        const syncData = await syncRes.json();

                        if (syncData.success) {
                            totalImported += syncData.imported || 0;
                            totalSkipped += syncData.skipped || 0;
                            if (syncData.errors && syncData.errors.length > 0) {
                                allErrors.push(...syncData.errors.map(e => `${company.display_name}: ${e}`));
                            }
                        } else {
                            allErrors.push(`${company.display_name}: ${syncData.error || 'Unknown error'}`);
                        }
                    } catch (companyErr) {
                        allErrors.push(`${company.display_name}: ${companyErr.message}`);
                    }

                    showSyncProgress(
                        `Syncing ${i + 1}/${companies.length}`,
                        `${totalImported} imported, ${totalSkipped} skipped`,
                        Math.round(((i + 1) / companies.length) * 100),
                        'syncing'
                    );
                }

                const hasExceptions = allErrors.length > 0;
                const statusText = hasExceptions ? 'Completed with exceptions' : 'Sync Complete!';
                const detailText = `${totalImported} imported, ${totalSkipped} skipped` + (hasExceptions ? `, ${allErrors.length} exceptions` : '');

                showSyncProgress(statusText, detailText, 100, hasExceptions ? 'error' : 'completed');

                // Store sync result for tooltip (available for 4 minutes)
                const syncResultHtml = formatSyncResult(totalImported, totalSkipped, hasExceptions ? allErrors : null);
                storeSyncResultForTooltip(syncResultHtml, statusText, detailText);

                if (totalImported > 0 || hasExceptions) {
                    await JarvisDialog.alert(syncResultHtml, { type: hasExceptions ? 'warning' : 'success', html: true });
                }

                loadUnallocatedInvoices(1, true);  // Force reload after sync
                loadBadgeCounts();
                // Don't hide - let it stay visible with hover tooltip
                hideSyncProgress(240000); // Hide after 4 minutes

                // Check for duplicates after sync
                checkForDuplicates();

            } catch (err) {
                showSyncProgress('Sync Failed', err.message, 100, 'error');
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
                hideSyncProgress(5000);
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalContent;
            }
        }

        function updateCompanyFilter(companies) {
            companiesCache = companies;
            const select = document.getElementById('companyFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All</option>';
            companies.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            select.value = currentValue;
        }

        // Show refresh button when mapping types are changed
        function showRefreshButton(autoHiddenCount = 0) {
            const btn = document.getElementById('refreshDataBtn');
            if (btn) {
                btn.classList.remove('d-none');
                if (autoHiddenCount > 0) {
                    btn.title = `${autoHiddenCount} invoice(s) were auto-hidden - click to refresh data`;
                } else {
                    btn.title = 'Mapping types changed - click to refresh data';
                }
            }
        }

        // Refresh data after mapping change and hide the button
        function refreshAfterMappingChange() {
            const btn = document.getElementById('refreshDataBtn');
            if (btn) {
                btn.classList.add('d-none');
            }
            // Force reload both unallocated and hidden invoices
            unallocatedLoaded = false;
            hiddenLoaded = false;

            // Reload current active tab
            const activeTab = localStorage.getItem('efacturaActiveTab') || 'unallocatedTab';
            if (activeTab === 'hiddenTab') {
                loadHiddenInvoices(1, true);
            } else {
                loadUnallocatedInvoices(1, true);
            }

            // Refresh all badge counts (both unallocated and hidden counts may have changed)
            loadBadgeCounts();
        }

        // Duplicate detection
        let duplicatesCache = [];

        async function checkForDuplicates() {
            try {
                // First check for exact duplicates (supplier + invoice_number match)
                const res = await fetch('/efactura/api/invoices/duplicates');
                const data = await res.json();

                let allDuplicates = [];
                if (data.success && data.count > 0) {
                    allDuplicates = data.duplicates;
                }

                // Then check for AI-detected duplicates (fallback for fuzzy matching)
                try {
                    const aiRes = await fetch('/efactura/api/invoices/duplicates/ai?limit=20');
                    const aiData = await aiRes.json();

                    if (aiData.success && aiData.count > 0) {
                        // Add AI duplicates (marked with ai_detected flag)
                        allDuplicates = [...allDuplicates, ...aiData.duplicates];
                    }
                } catch (aiErr) {
                    console.warn('AI duplicate detection not available:', aiErr);
                }

                if (allDuplicates.length > 0) {
                    duplicatesCache = allDuplicates;
                    showDuplicatesBanner(allDuplicates.length);
                } else {
                    hideDuplicatesBanner();
                }
            } catch (err) {
                console.error('Error checking for duplicates:', err);
            }
        }

        function showDuplicatesBanner(count) {
            const banner = document.getElementById('duplicatesBanner');
            const countEl = document.getElementById('duplicatesCount');
            if (banner && countEl) {
                countEl.textContent = count;
                banner.classList.remove('d-none');
            }
        }

        function hideDuplicatesBanner() {
            const banner = document.getElementById('duplicatesBanner');
            if (banner) {
                banner.classList.add('d-none');
            }
            duplicatesCache = [];
        }

        async function viewDuplicates() {
            if (duplicatesCache.length === 0) {
                await JarvisDialog.alert('No duplicates to display.', { type: 'warning' });
                return;
            }

            // Separate exact and AI-detected duplicates
            const exactDuplicates = duplicatesCache.filter(d => !d.ai_detected);
            const aiDuplicates = duplicatesCache.filter(d => d.ai_detected);

            let msg = 'Potential duplicates found:\n\n';

            if (exactDuplicates.length > 0) {
                msg += '=== EXACT MATCHES ===\n';
                exactDuplicates.forEach((dup, i) => {
                    const issueDate = dup.issue_date ? new Date(dup.issue_date).toLocaleDateString('ro-RO') : '-';
                    const amount = parseFloat(dup.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                    msg += `${i + 1}. ${dup.partner_name} - ${dup.invoice_number}\n`;
                    msg += `   Date: ${issueDate}, Amount: ${amount} ${dup.currency || 'RON'}\n`;
                    msg += `    Exact match: Invoice #${dup.existing_invoice_id}\n\n`;
                });
            }

            if (aiDuplicates.length > 0) {
                msg += '=== AI-DETECTED (fuzzy match) ===\n';
                aiDuplicates.forEach((dup, i) => {
                    const issueDate = dup.issue_date ? new Date(dup.issue_date).toLocaleDateString('ro-RO') : '-';
                    const amount = parseFloat(dup.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                    const confidence = Math.round((dup.confidence || 0) * 100);
                    msg += `${i + 1}. ${dup.partner_name} - ${dup.invoice_number}\n`;
                    msg += `   Date: ${issueDate}, Amount: ${amount} ${dup.currency || 'RON'}\n`;
                    msg += `    AI match (${confidence}% confidence): Invoice #${dup.existing_invoice_id}\n`;
                    if (dup.reasoning) {
                        msg += `   Reason: ${dup.reasoning}\n`;
                    }
                    msg += '\n';
                });
            }

            msg += 'Click "Mark All as Duplicates" to link these to existing invoices and remove them from Unallocated.';

            await JarvisDialog.alert(msg, { type: 'warning' });
        }

        async function markAllDuplicates() {
            if (duplicatesCache.length === 0) {
                await JarvisDialog.alert('No duplicates to mark.', { type: 'warning' });
                return;
            }

            const count = duplicatesCache.length;
            const confirmed = await JarvisDialog.confirm(`Mark ${count} invoice(s) as duplicates?\n\nThis will link them to the existing invoices in the Invoices module and remove them from the Unallocated list.`, { title: 'Confirm' });
            if (!confirmed) {
                return;
            }

            try {
                let totalMarked = 0;

                // Separate exact duplicates from AI-detected ones
                const exactDuplicates = duplicatesCache.filter(d => !d.ai_detected);
                const aiDuplicates = duplicatesCache.filter(d => d.ai_detected);

                // Mark exact duplicates
                if (exactDuplicates.length > 0) {
                    const ids = exactDuplicates.map(d => d.efactura_id);
                    const res = await fetch('/efactura/api/invoices/mark-duplicates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ invoice_ids: ids })
                    });
                    const data = await res.json();
                    if (data.success) {
                        totalMarked += data.marked;
                    }
                }

                // Mark AI-detected duplicates (need explicit mappings)
                if (aiDuplicates.length > 0) {
                    const mappings = aiDuplicates.map(d => ({
                        efactura_id: d.efactura_id,
                        existing_invoice_id: d.existing_invoice_id
                    }));
                    const res = await fetch('/efactura/api/invoices/mark-duplicates/ai', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mappings: mappings })
                    });
                    const data = await res.json();
                    if (data.success) {
                        totalMarked += data.marked;
                    }
                }

                await JarvisDialog.alert(`Successfully marked ${totalMarked} invoice(s) as duplicates.`, { type: 'success' });
                hideDuplicatesBanner();
                loadUnallocatedInvoices(1, true);
                loadBadgeCounts();

            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoicesTableBody');
            const cols = getVisibleColumns();
            const colCount = cols.length;

            // Server-side filtering is now used - no client-side filtering needed
            if (!invoices || invoices.length === 0) {
                const searchTerm = document.getElementById('searchInput')?.value?.trim();
                const hasFilters = searchTerm || document.getElementById('companyFilter')?.value ||
                                   document.getElementById('startDate')?.value || document.getElementById('endDate')?.value;
                let message;
                if (searchTerm) {
                    message = `<i class="bi bi-search"></i> No invoices found matching "<strong>${searchTerm}</strong>".<br><small>Try a different search term.</small>`;
                } else if (hasFilters) {
                    message = `<i class="bi bi-funnel"></i> No invoices match your filters.<br><small>Try adjusting your filter criteria.</small>`;
                } else {
                    message = `<i class="bi bi-check-circle text-success"></i> No unallocated invoices!<br><small>All invoices have been processed or moved to Hidden.</small>`;
                }
                tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted py-4">${message}</td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const importedDate = inv.created_at ? new Date(inv.created_at).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const vat = parseFloat(inv.total_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedInvoices.has(inv.id) ? 'checked' : '';

                // Show override indicator if value differs from mapping
                const typeDisplay = inv.type_name ? `<span class="badge bg-secondary">${inv.type_name}</span>` : '<span class="text-muted">-</span>';
                const typeOverrideIcon = inv.type_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';
                const deptDisplay = inv.department || '-';
                const deptOverrideIcon = inv.department_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';
                const subdeptDisplay = inv.subdepartment || '-';
                const subdeptOverrideIcon = inv.subdepartment_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';

                const cellMap = {
                    checkbox: `<input type="checkbox" class="form-check-input invoice-checkbox" value="${inv.id}" onchange="updateSelectionCount()" ${checked}>`,
                    company: `<span class="${inv.company_name ? '' : 'text-muted'}">${inv.company_name || '-'}</span>`,
                    direction: `<span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span>`,
                    invoice_number: `<code>${inv.invoice_number || '-'}</code>`,
                    partner_name: inv.partner_name || '-',
                    partner_cif: `<code class="text-muted">${inv.partner_cif || '-'}</code>`,
                    type: `${typeDisplay}${typeOverrideIcon}`,
                    department: `<span class="${inv.department ? '' : 'text-muted'}">${deptDisplay}</span>${deptOverrideIcon}`,
                    subdepartment: `<span class="${inv.subdepartment ? '' : 'text-muted'}">${subdeptDisplay}</span>${subdeptOverrideIcon}`,
                    issue_date: issueDate,
                    amount: amount,
                    vat: vat,
                    currency: inv.currency || 'RON',
                    imported: `<span class="small text-muted">${importedDate}</span>`,
                    actions: `<div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="sendSingleToInvoices(${inv.id})" title="Send to Invoices">
                            <i class="bi bi-send"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="editInvoiceOverrides(${inv.id})" title="Edit Type/Dept">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="viewInvoice(${inv.id})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="exportPdf(${inv.id})" title="Export PDF">
                            <i class="bi bi-file-pdf"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="hideInvoice(${inv.id})" title="Hide">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteInvoice(${inv.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>`
                };

                return `<tr data-id="${inv.id}">
                    ${cols.map(col => {
                        const align = col.align === 'end' ? 'text-end' : '';
                        return `<td class="${align}">${cellMap[col.id] || ''}</td>`;
                    }).join('')}
                </tr>`;
            }).join('');
        }

        // Selection management - Unallocated
        // Select only visible page
        function toggleSelectPage() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                cb.checked = selectAll;
                const id = parseInt(cb.value);
                if (selectAll) {
                    selectedInvoices.add(id);
                } else {
                    selectedInvoices.delete(id);
                }
            });
            updateSelectionCount();
        }

        // Select ALL invoices (need to call API to get all IDs)
        let allInvoiceIds = []; // Cache all IDs for bulk selection
        async function selectAllInvoices() {
            try {
                // Fetch all IDs matching current filters
                const companyId = document.getElementById('companyFilter').value;
                const direction = document.getElementById('directionFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const search = document.getElementById('searchInput').value;
                const hideTyped = document.getElementById('hideTypedToggle')?.checked || false;

                let url = '/efactura/api/invoices/unallocated/ids?';
                if (companyId) url += `company_id=${companyId}&`;
                if (direction) url += `direction=${direction}&`;
                if (startDate) url += `start_date=${startDate}&`;
                if (endDate) url += `end_date=${endDate}&`;
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (hideTyped) url += `hide_typed=true&`;

                const res = await fetch(url);
                const data = await res.json();
                if (data.success && data.ids) {
                    selectedInvoices.clear();
                    data.ids.forEach(id => selectedInvoices.add(id));
                    // Check visible checkboxes
                    document.querySelectorAll('.invoice-checkbox').forEach(cb => cb.checked = true);
                    document.getElementById('selectAllCheckbox').checked = true;
                    updateSelectionCount();
                    // Show toast with count
                    JarvisToast.success(`Selected all ${data.count} invoices`);
                }
            } catch (err) {
                console.error('Failed to select all:', err);
                // Fallback to page selection
                toggleSelectPage();
            }
        }

        function updateSelectionCount() {
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedInvoices.add(parseInt(cb.value));
                } else {
                    selectedInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedInvoices.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkActionBar').classList.toggle('show', count > 0);
        }

        function clearSelection() {
            selectedInvoices.clear();
            document.querySelectorAll('.invoice-checkbox, #selectAllCheckbox').forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        // Hidden selection management
        function toggleHiddenSelectPage() {
            const selectAll = document.getElementById('hiddenSelectAll').checked;
            document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedHiddenInvoices.add(parseInt(cb.value));
                } else {
                    selectedHiddenInvoices.delete(parseInt(cb.value));
                }
            });
            updateHiddenSelectionCount();
        }

        function selectAllHidden() {
            // Select all hidden invoices from cache
            if (hiddenCache && hiddenCache.length > 0) {
                hiddenCache.forEach(inv => {
                    selectedHiddenInvoices.add(inv.id);
                });
                // Update checkboxes on current page
                document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                    cb.checked = true;
                });
                document.getElementById('hiddenSelectAll').checked = true;
                updateHiddenSelectionCount();
            }
        }

        function clearHiddenSelection() {
            selectedHiddenInvoices.clear();
            document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('hiddenSelectAll').checked = false;
            updateHiddenSelectionCount();
        }

        function updateHiddenSelectionCount() {
            document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedHiddenInvoices.add(parseInt(cb.value));
                } else {
                    selectedHiddenInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedHiddenInvoices.size;
            document.getElementById('hiddenRestoreBtn').disabled = count === 0;
            document.getElementById('hiddenDeleteBtn').disabled = count === 0;

            // Update "Select All" count in dropdown
            const totalEl = document.getElementById('hiddenTotalForSelect');
            if (totalEl && hiddenCache) {
                totalEl.textContent = hiddenCache.length;
            }
        }

        // Bin selection management
        function toggleBinSelectPage() {
            const selectAll = document.getElementById('binSelectAll').checked;
            document.querySelectorAll('.bin-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedBinInvoices.add(parseInt(cb.value));
                } else {
                    selectedBinInvoices.delete(parseInt(cb.value));
                }
            });
            updateBinSelectionCount();
        }

        function selectAllBin() {
            // Select all bin invoices from cache
            if (binCache && binCache.length > 0) {
                binCache.forEach(inv => {
                    selectedBinInvoices.add(inv.id);
                });
                // Update checkboxes on current page
                document.querySelectorAll('.bin-checkbox').forEach(cb => {
                    cb.checked = true;
                });
                document.getElementById('binSelectAll').checked = true;
                updateBinSelectionCount();
            }
        }

        function clearBinSelection() {
            selectedBinInvoices.clear();
            document.querySelectorAll('.bin-checkbox').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('binSelectAll').checked = false;
            updateBinSelectionCount();
        }

        function updateBinSelectionCount() {
            document.querySelectorAll('.bin-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedBinInvoices.add(parseInt(cb.value));
                } else {
                    selectedBinInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedBinInvoices.size;
            document.getElementById('binRestoreBtn').disabled = count === 0;
            document.getElementById('binPermanentDeleteBtn').disabled = count === 0;

            // Update "Select All" count in dropdown
            const totalEl = document.getElementById('binTotalForSelect');
            if (totalEl && binCache) {
                totalEl.textContent = binCache.length;
            }
        }

        // Single invoice actions
        async function sendSingleToInvoices(invoiceId) {
            // Find invoice in cache to check if type/department are set
            const inv = invoicesCache.find(i => i.id === invoiceId);
            if (!inv) {
                await JarvisDialog.alert('Invoice not found', { type: 'error' });
                return;
            }

            // Check if type and department are set (either override or mapping default)
            const hasType = inv.type_override || (inv.type_names && inv.type_names.length > 0) || inv.type_ids;
            const hasDepartment = inv.department_override || inv.mapping_department || inv.department;

            if (!hasType || !hasDepartment) {
                // Open edit modal if missing required fields
                const missingFields = [];
                if (!hasType) missingFields.push('Type');
                if (!hasDepartment) missingFields.push('Department');

                await JarvisDialog.alert(
                    `Please set ${missingFields.join(' and ')} before sending to Invoices.`,
                    { type: 'warning', title: 'Missing Information' }
                );
                editInvoiceOverrides(invoiceId);
                return;
            }

            const confirmed = await JarvisDialog.confirm('Send this invoice to the Invoices module for allocation?', { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/send-to-module', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: [invoiceId] })
                });
                const data = await res.json();

                if (data.success) {
                    if (data.duplicates > 0) {
                        await JarvisDialog.alert('Invoice already exists in Invoices module (duplicate skipped).', { type: 'warning' });
                    } else {
                        await JarvisDialog.alert('Invoice sent to Invoices module successfully!', { type: 'success' });
                    }
                    loadUnallocatedInvoices(currentPage, true);  // Force reload after data change
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to send invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function hideInvoice(invoiceId) {
            const confirmed = await JarvisDialog.confirm('Hide this invoice? It will be moved to the Hidden tab.', { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/ignore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('hidden'); // Hide moves to hidden
                    removeRow(invoiceId);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to hide invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function deleteInvoice(invoiceId) {
            const confirmed = await JarvisDialog.confirm('Delete this invoice? It will be moved to the Bin.', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('bin'); // Delete moves to bin
                    removeRow(invoiceId);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function restoreFromHidden(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/ignore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ restore: true })
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('unallocated'); // Restore moves to unallocated
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to restore invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function deleteFromHidden(invoiceId) {
            const confirmed = await JarvisDialog.confirm('Move this invoice to the Bin?', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('bin'); // Delete moves to bin
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function restoreFromBin(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('unallocated'); // Restore moves to unallocated
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to restore invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function permanentDelete(invoiceId) {
            const confirmed = await JarvisDialog.confirm('PERMANENTLY delete this invoice? This cannot be undone!', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/permanent-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoice', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        // Bulk actions
        async function sendSelectedToInvoices() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            // Check all selected invoices for missing type/department
            const incompleteInvoices = [];
            for (const id of ids) {
                const inv = invoicesCache.find(i => i.id === id);
                if (inv) {
                    const hasType = inv.type_override || (inv.type_names && inv.type_names.length > 0) || inv.type_ids;
                    const hasDepartment = inv.department_override || inv.mapping_department || inv.department;
                    if (!hasType || !hasDepartment) {
                        incompleteInvoices.push({
                            id: inv.id,
                            number: inv.invoice_number,
                            missingType: !hasType,
                            missingDept: !hasDepartment
                        });
                    }
                }
            }

            if (incompleteInvoices.length > 0) {
                const missingList = incompleteInvoices.slice(0, 5).map(i => {
                    const missing = [];
                    if (i.missingType) missing.push('Type');
                    if (i.missingDept) missing.push('Dept');
                    return ` ${i.number}: missing ${missing.join(', ')}`;
                }).join('\n');
                const moreText = incompleteInvoices.length > 5 ? `\n...and ${incompleteInvoices.length - 5} more` : '';

                await JarvisDialog.alert(
                    `${incompleteInvoices.length} invoice(s) are missing Type or Department:\n\n${missingList}${moreText}\n\nPlease set Type and Department for all invoices before sending.`,
                    { type: 'warning', title: 'Missing Information' }
                );
                return;
            }

            const confirmed = await JarvisDialog.confirm(`Send ${ids.length} invoice(s) to the Invoices module?`, { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/send-to-module', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    let msg = `${data.sent} invoice(s) sent successfully!`;
                    if (data.duplicates > 0) {
                        msg += `\n\n${data.duplicates} duplicate(s) skipped (already exist in Invoices).`;
                    }
                    await JarvisDialog.alert(msg, { type: data.duplicates > 0 ? 'warning' : 'success' });
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);  // Force reload after data change
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to send invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkHideSelected() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`Hide ${ids.length} invoice(s)?`, { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-hide', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.hidden} invoice(s) hidden`, { type: 'success' });
                    invalidateCaches('hidden');
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to hide invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkDeleteSelected() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`Move ${ids.length} invoice(s) to the Bin?`, { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.deleted} invoice(s) moved to bin`, { type: 'success' });
                    invalidateCaches('bin');
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkRestoreFromHidden() {
            const ids = Array.from(selectedHiddenInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`Restore ${ids.length} invoice(s) from hidden?`, { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-restore-hidden', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.restored} invoice(s) restored`, { type: 'success' });
                    invalidateCaches('unallocated');
                    selectedHiddenInvoices.clear();
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to restore invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkDeleteFromHidden() {
            const ids = Array.from(selectedHiddenInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`Move ${ids.length} invoice(s) to the Bin?`, { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.deleted} invoice(s) moved to bin`, { type: 'success' });
                    invalidateCaches('bin');
                    selectedHiddenInvoices.clear();
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkRestoreFromBin() {
            const ids = Array.from(selectedBinInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`Restore ${ids.length} invoice(s) from bin?`, { title: 'Confirm' });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-restore-bin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.restored} invoice(s) restored`, { type: 'success' });
                    invalidateCaches('unallocated');
                    selectedBinInvoices.clear();
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to restore invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkPermanentDelete() {
            const ids = Array.from(selectedBinInvoices);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(`PERMANENTLY delete ${ids.length} invoice(s)? This cannot be undone!`, { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-permanent-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.deleted} invoice(s) permanently deleted`, { type: 'success' });
                    selectedBinInvoices.clear();
                    loadBinInvoices(binCurrentPage, true);  // Force reload after data change
                    loadBadgeCounts();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete invoices', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        function removeRow(invoiceId) {
            const row = document.querySelector(`tr[data-id="${invoiceId}"]`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            selectedInvoices.delete(invoiceId);
        }

        function clearFilters() {
            document.getElementById('companyFilter').value = '';
            document.getElementById('directionFilter').value = 'received';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('searchInput').value = '';
            loadUnallocatedInvoices();
        }

        // Column Configuration
        function openColumnConfig() {
            const modal = new bootstrap.Modal(document.getElementById('columnConfigModal'));
            const list = document.getElementById('columnConfigList');
            const config = getColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: i });

            const configCols = allColumns
                .filter(col => !col.fixed)
                .map(col => ({
                    ...col,
                    visible: configMap[col.id]?.visible ?? col.visible,
                    order: configMap[col.id]?.order ?? allColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order);

            list.innerHTML = configCols.map(col => `
                <li class="list-group-item d-flex align-items-center" data-id="${col.id}">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <input type="checkbox" class="form-check-input me-2" id="col_${col.id}" ${col.visible ? 'checked' : ''}>
                    <label class="form-check-label flex-grow-1" for="col_${col.id}">${col.label}</label>
                </li>
            `).join('');

            new Sortable(list, { animation: 150, handle: '.bi-grip-vertical' });
            modal.show();
        }

        function applyColumnConfig() {
            const list = document.getElementById('columnConfigList');
            const items = list.querySelectorAll('li');
            const config = [];
            let order = 0;

            // Add checkbox column first (order 0)
            config.push({ id: 'checkbox', visible: true, order: order++ });

            // Add non-fixed columns in their current DOM order (as shown in modal)
            items.forEach(item => {
                const id = item.dataset.id;
                const visible = item.querySelector('input[type="checkbox"]').checked;
                config.push({ id, visible, order: order++ });
            });

            // Add actions column last
            config.push({ id: 'actions', visible: true, order: order++ });

            saveColumnConfig(config);
            renderTableHeader();
            loadUnallocatedInvoices(currentPage);
        }

        function resetColumnConfig() {
            localStorage.removeItem('efacturaColumnConfig');
            bootstrap.Modal.getInstance(document.getElementById('columnConfigModal')).hide();
            renderTableHeader();
            loadUnallocatedInvoices(currentPage);
        }

        function updatePagination(pagination) {
            if (!pagination) return;

            currentPage = pagination.current_page || 1;
            totalPages = pagination.total_pages || 1;

            const info = document.getElementById('paginationInfo');
            const summary = document.getElementById('paginationSummary');
            const controls = document.getElementById('paginationControls');
            const pageSizeSelect = document.getElementById('pageSizeSelect');

            // Set page size selector value
            if (pageSizeSelect) {
                pageSizeSelect.value = pageSize;
            }

            if (pagination.total > 0) {
                info.style.display = 'flex';
                const start = pagination.offset + 1;
                const end = Math.min(pagination.offset + pagination.limit, pagination.total);
                summary.textContent = `Showing ${start}-${end} of ${pagination.total}`;

                // Update "Select All" count to show actual total
                const selectAllCount = document.getElementById('invoicesTotalForSelect');
                if (selectAllCount) selectAllCount.textContent = pagination.total;

                if (totalPages > 1) {
                    controls.innerHTML = `
                        <button class="btn btn-outline-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="loadUnallocatedInvoices(${currentPage - 1})">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-secondary" disabled>Page ${currentPage} of ${totalPages}</button>
                        <button class="btn btn-outline-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="loadUnallocatedInvoices(${currentPage + 1})">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    `;
                } else {
                    controls.innerHTML = '';
                }
            } else {
                info.style.display = 'none';
            }
        }

        function updateSummary(invoices, pagination) {
            // Server-side filtering is now used - pagination.total reflects filtered count
            const displayCount = pagination?.total || invoices?.length || 0;
            const hiddenByFilter = pagination?.hidden_by_filter || 0;

            // Update summary text with visible count and hidden count
            let summaryText = `<strong>${displayCount}</strong> invoices`;
            if (hiddenByFilter > 0) {
                summaryText += ` <span class="text-muted small">(${hiddenByFilter} hidden)</span>`;
            }
            document.getElementById('unallocatedSummaryText').innerHTML = summaryText;

            // Update tab badge with visible count (not total)
            updateBadge('unallocatedBadge', displayCount);

            const totalValue = (invoices || []).reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
            document.getElementById('totalValueUnallocated').textContent = totalValue.toLocaleString('ro-RO', {minimumFractionDigits: 2}) + ' RON';
        }

        // Edit invoice overrides
        async function editInvoiceOverrides(invoiceId) {
            // Find invoice in cache
            const inv = invoicesCache.find(i => i.id === invoiceId);
            if (!inv) {
                await JarvisDialog.alert('Invoice not found', { type: 'error' });
                return;
            }

            // Find the mapping for this invoice's partner to show defaults
            const mapping = mappingsCache.find(m =>
                m.partner_name && inv.partner_name &&
                m.partner_name.toLowerCase() === inv.partner_name.toLowerCase()
            );

            // Get mapping defaults - use the mapping values directly from API response
            const mappingType = inv.type_names?.length > 0 ? inv.type_names.join(', ') : (mapping?.type_names?.join(', ') || null);
            const mappingDept = inv.mapping_department || mapping?.department || null;
            const mappingSubdept = inv.mapping_subdepartment || mapping?.subdepartment || null;

            document.getElementById('editInvoiceId').value = invoiceId;
            document.getElementById('editInvoiceInfo').innerHTML = `
                <strong>${inv.invoice_number}</strong> - ${inv.partner_name}<br>
                <small class="text-muted">${inv.issue_date || '-'} | ${parseFloat(inv.total_amount || 0).toLocaleString('ro-RO')} ${inv.currency || 'RON'}</small>
                ${mappingType || mappingDept ? `<br><small class="text-info"><i class="bi bi-info-circle"></i> Mapping defaults: ${[mappingType, mappingDept, mappingSubdept].filter(Boolean).join(' / ') || 'None'}</small>` : ''}
            `;

            // Load partner types for type override dropdown
            if (partnerTypesCache.length === 0) {
                await loadPartnerTypesForDropdown();
            }
            const typeSelect = document.getElementById('invoiceTypeOverride');
            const typeDefaultLabel = mappingType ? `-- Use Mapping Default (${mappingType}) --` : '-- Use Mapping Default --';
            typeSelect.innerHTML = `<option value="">${typeDefaultLabel}</option>` +
                partnerTypesCache.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            typeSelect.value = inv.type_override || '';

            // Load department structure
            await loadDepartmentStructure();
            const deptSelect = document.getElementById('invoiceDepartmentOverride');
            const deptDefaultLabel = mappingDept ? `-- Use Mapping Default (${mappingDept}) --` : '-- Use Mapping Default --';
            deptSelect.innerHTML = `<option value="">${deptDefaultLabel}</option>` +
                departmentsCache.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            deptSelect.value = inv.department_override || '';

            // Add change handler for department to filter subdepartments
            deptSelect.onchange = () => {
                const selectedDept = deptSelect.value || mappingDept;
                updateInvoiceSubdepartmentsForDepartment(selectedDept, mappingSubdept);
            };

            // Load subdepartments based on effective department
            const effectiveDept = inv.department_override || mappingDept;
            updateInvoiceSubdepartmentsForDepartment(effectiveDept, mappingSubdept);

            // Set subdepartment override value after dropdown is populated
            const subdeptSelect = document.getElementById('invoiceSubdepartmentOverride');
            subdeptSelect.value = inv.subdepartment_override || '';

            const modal = new bootstrap.Modal(document.getElementById('editInvoiceOverridesModal'));
            modal.show();
        }

        function updateInvoiceSubdepartmentsForDepartment(department, mappingSubdept) {
            const select = document.getElementById('invoiceSubdepartmentOverride');
            if (!select) return;

            const subdeptDefaultLabel = mappingSubdept ? `-- Use Mapping Default (${mappingSubdept}) --` : '-- Use Mapping Default --';

            if (!department) {
                select.innerHTML = `<option value="">${subdeptDefaultLabel}</option>`;
                select.disabled = true;
                return;
            }

            // Filter subdepartments that exist for this department in the structure
            const subdepts = new Set();
            departmentStructureCache.forEach(ds => {
                if (ds.department === department && ds.subdepartment) {
                    subdepts.add(ds.subdepartment);
                }
            });

            const subdeptList = Array.from(subdepts).sort();

            if (subdeptList.length === 0) {
                select.innerHTML = `<option value="">${subdeptDefaultLabel}</option>`;
                select.disabled = true;
            } else {
                select.innerHTML = `<option value="">${subdeptDefaultLabel}</option>` +
                    subdeptList.map(s => `<option value="${s}">${s}</option>`).join('');
                select.disabled = false;
            }
        }

        async function saveInvoiceOverrides() {
            const invoiceId = parseInt(document.getElementById('editInvoiceId').value);
            const typeOverride = document.getElementById('invoiceTypeOverride').value;
            const departmentOverride = document.getElementById('invoiceDepartmentOverride').value;
            const subdepartmentOverride = document.getElementById('invoiceSubdepartmentOverride').value;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/overrides`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type_override: typeOverride || null,
                        department_override: departmentOverride || null,
                        subdepartment_override: subdepartmentOverride || null,
                    })
                });
                const data = await res.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editInvoiceOverridesModal')).hide();

                    // Update cache and row in place (no full reload)
                    const inv = invoicesCache.find(i => i.id === invoiceId);
                    if (inv) {
                        // Update cache values
                        inv.type_override = typeOverride || null;
                        inv.department_override = departmentOverride || null;
                        inv.subdepartment_override = subdepartmentOverride || null;

                        // Calculate effective values (override takes precedence)
                        inv.type_name = typeOverride || inv.mapping_type_name || null;
                        inv.department = departmentOverride || inv.mapping_department || null;
                        inv.subdepartment = subdepartmentOverride || inv.mapping_subdepartment || null;

                        // Update the row in DOM
                        updateInvoiceRowInPlace(invoiceId, inv);
                    }
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to save overrides', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        // Update a single invoice row in the table without full reload
        function updateInvoiceRowInPlace(invoiceId, inv) {
            const row = document.querySelector(`#invoicesTableBody tr[data-id="${invoiceId}"]`);
            if (!row) return;

            // Find and update the cells based on column visibility
            const cols = getVisibleColumns();
            const cells = row.querySelectorAll('td');

            cols.forEach((col, idx) => {
                const cell = cells[idx];
                if (!cell) return;

                if (col.id === 'type') {
                    const typeDisplay = inv.type_name ? `<span class="badge bg-secondary">${inv.type_name}</span>` : '<span class="text-muted">-</span>';
                    const typeOverrideIcon = inv.type_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';
                    cell.innerHTML = `${typeDisplay}${typeOverrideIcon}`;
                } else if (col.id === 'department') {
                    const deptDisplay = inv.department || '-';
                    const deptOverrideIcon = inv.department_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';
                    cell.innerHTML = `<span class="${inv.department ? '' : 'text-muted'}">${deptDisplay}</span>${deptOverrideIcon}`;
                } else if (col.id === 'subdepartment') {
                    const subdeptDisplay = inv.subdepartment || '-';
                    const subdeptOverrideIcon = inv.subdepartment_override ? '<i class="bi bi-pencil-fill text-warning ms-1" title="Override"></i>' : '';
                    cell.innerHTML = `<span class="${inv.subdepartment ? '' : 'text-muted'}">${subdeptDisplay}</span>${subdeptOverrideIcon}`;
                }
            });
        }

        // Bulk set overrides modal
        async function openBulkSetOverridesModal() {
            const count = selectedInvoices.size;
            if (count === 0) {
                await JarvisDialog.alert('No invoices selected', { type: 'warning' });
                return;
            }

            document.getElementById('bulkOverrideCount').textContent = count;

            // Load partner types for type override dropdown
            if (partnerTypesCache.length === 0) {
                await loadPartnerTypesForDropdown();
            }
            const typeSelect = document.getElementById('bulkTypeOverride');
            typeSelect.innerHTML = '<option value="">-- Keep Existing --</option>' +
                '<option value="__CLEAR__">Clear Override (Use Mapping Default)</option>' +
                partnerTypesCache.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            typeSelect.value = '';

            // Load departments for override dropdown
            await loadDepartmentsForDropdown();
            const deptSelect = document.getElementById('bulkDepartmentOverride');
            deptSelect.innerHTML = '<option value="">-- Keep Existing --</option>' +
                '<option value="__CLEAR__">Clear Override (Use Mapping Default)</option>' +
                departmentsCache.map(d => `<option value="${d.name}">${d.name}</option>`).join('');
            deptSelect.value = '';

            // Load subdepartments for override dropdown
            await loadSubdepartmentsForDropdown();
            const subdeptSelect = document.getElementById('bulkSubdepartmentOverride');
            subdeptSelect.innerHTML = '<option value="">-- Keep Existing --</option>' +
                '<option value="__CLEAR__">Clear Override (Use Mapping Default)</option>' +
                subdepartmentsCache.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
            subdeptSelect.value = '';

            const modal = new bootstrap.Modal(document.getElementById('bulkSetOverridesModal'));
            modal.show();
        }

        async function applyBulkOverrides() {
            const invoiceIds = Array.from(selectedInvoices);
            const typeOverride = document.getElementById('bulkTypeOverride').value;
            const departmentOverride = document.getElementById('bulkDepartmentOverride').value;
            const subdepartmentOverride = document.getElementById('bulkSubdepartmentOverride').value;

            // Check if anything is selected to change
            if (!typeOverride && !departmentOverride && !subdepartmentOverride) {
                await JarvisDialog.alert('Please select at least one field to update', { type: 'warning' });
                return;
            }

            // Build payload - only include fields that should be changed
            const payload = { invoice_ids: invoiceIds };

            // Handle the special __CLEAR__ value
            if (typeOverride === '__CLEAR__') {
                payload.type_override = null;
            } else if (typeOverride) {
                payload.type_override = typeOverride;
            }

            if (departmentOverride === '__CLEAR__') {
                payload.department_override = null;
            } else if (departmentOverride) {
                payload.department_override = departmentOverride;
            }

            if (subdepartmentOverride === '__CLEAR__') {
                payload.subdepartment_override = null;
            } else if (subdepartmentOverride) {
                payload.subdepartment_override = subdepartmentOverride;
            }

            try {
                const res = await fetch('/efactura/api/invoices/bulk-overrides', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('bulkSetOverridesModal')).hide();
                    await JarvisDialog.alert(`Updated ${data.updated_count} invoices`, { type: 'success' });
                    // Clear selection and reload invoices to reflect changes
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to apply overrides', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        // View invoice details
        async function viewInvoice(invoiceId) {
            currentInvoiceId = invoiceId;
            const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
            const content = document.getElementById('invoiceDetailsContent');
            content.innerHTML = '<div class="text-center py-4"><span class="spinner-border"></span></div>';
            modal.show();

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}`);
                const data = await res.json();

                if (data.success) {
                    const inv = data.data;
                    const isReceived = inv.direction === 'received';
                    const seller = inv.seller || {};
                    const buyer = inv.buyer || {};

                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Invoice Information</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted">Invoice #</td><td><strong>${inv.invoice_number || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">Series</td><td>${inv.invoice_series || '-'}</td></tr>
                                    <tr><td class="text-muted">Issue Date</td><td>${inv.issue_date || '-'}</td></tr>
                                    <tr><td class="text-muted">Due Date</td><td>${inv.due_date || '-'}</td></tr>
                                    <tr><td class="text-muted">Direction</td><td><span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">${isReceived ? 'Received' : 'Sent'}</span></td></tr>
                                </table>

                                <h6 class="mt-3">Amounts</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted">Net Amount</td><td class="text-end">${parseFloat(inv.total_without_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</td></tr>
                                    <tr><td class="text-muted">VAT</td><td class="text-end">${parseFloat(inv.total_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</td></tr>
                                    <tr><td class="text-muted"><strong>Total</strong></td><td class="text-end"><strong>${parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</strong></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-building"></i> Seller (Supplier)</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted" style="width: 100px;">Name</td><td><strong>${seller.name || inv.partner_name || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">VAT</td><td><code class="text-danger">${seller.cif || inv.partner_cif || '-'}</code></td></tr>
                                    ${seller.address ? `<tr><td class="text-muted">Address</td><td class="small">${seller.address}</td></tr>` : ''}
                                </table>

                                <h6 class="mt-3"><i class="bi bi-person"></i> Buyer (Customer)</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted" style="width: 100px;">Name</td><td><strong>${buyer.name || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">VAT</td><td><code class="text-danger">${buyer.cif || '-'}</code></td></tr>
                                    ${buyer.address ? `<tr><td class="text-muted">Address</td><td class="small">${buyer.address}</td></tr>` : ''}
                                </table>
                            </div>
                        </div>
                    `;

                    document.getElementById('modalSendToInvoicesBtn').onclick = () => {
                        modal.hide();
                        sendSingleToInvoices(invoiceId);
                    };
                } else {
                    content.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to load invoice'}</div>`;
                }
            } catch (err) {
                content.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            }
        }

        // Export PDF
        async function exportPdf(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/pdf`);

                if (!res.ok) {
                    const data = await res.json();
                    await JarvisDialog.alert(data.error || 'Failed to export PDF', { type: 'error' });
                    return;
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${invoiceId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        // ============================================
        // Supplier Mappings
        // ============================================

        let mappingsCache = [];
        let filteredMappingsCache = []; // Filtered subset
        let mappingsPageSize = parseInt(localStorage.getItem('efacturaMappingsPageSize')) || 50;
        let mappingsCurrentPage = 1;

        // Filter mappings based on search and filters
        // preservePage: if true, keep current page (useful after edit/refresh)
        function filterMappings(preservePage = false) {
            const searchTerm = document.getElementById('mappingsSearchInput').value.toLowerCase().trim();
            const partnerFilter = document.getElementById('mappingsPartnerFilter')?.value || '';
            const vatFilter = document.getElementById('mappingsVatFilter')?.value.toLowerCase().trim() || '';
            const supplierFilter = document.getElementById('mappingsSupplierFilter')?.value.toLowerCase().trim() || '';
            const typeFilter = document.getElementById('mappingsTypeFilter').value;

            filteredMappingsCache = mappingsCache.filter(m => {
                // Search filter (partner name, partner CIF, kod_konto, brand, department, subdepartment)
                const matchesSearch = !searchTerm ||
                    (m.partner_name && m.partner_name.toLowerCase().includes(searchTerm)) ||
                    (m.partner_cif && m.partner_cif.toLowerCase().includes(searchTerm)) ||
                    (m.kod_konto && m.kod_konto.toLowerCase().includes(searchTerm)) ||
                    (m.brand && m.brand.toLowerCase().includes(searchTerm)) ||
                    (m.department && m.department.toLowerCase().includes(searchTerm)) ||
                    (m.subdepartment && m.subdepartment.toLowerCase().includes(searchTerm));

                // Partner filter (exact match by partner_name)
                const matchesPartner = !partnerFilter || m.partner_name === partnerFilter;

                // VAT filter (partner_cif)
                const matchesVat = !vatFilter ||
                    (m.partner_cif && m.partner_cif.toLowerCase().includes(vatFilter));

                // Supplier filter (supplier name, supplier VAT)
                const matchesSupplier = !supplierFilter ||
                    (m.supplier_name && m.supplier_name.toLowerCase().includes(supplierFilter)) ||
                    (m.supplier_vat && m.supplier_vat.toLowerCase().includes(supplierFilter));

                // Type filter - check type_names array
                let matchesType = true;
                const typeNames = m.type_names || (m.type_name ? [m.type_name] : []);
                if (typeFilter === 'none') {
                    matchesType = typeNames.length === 0;
                } else if (typeFilter) {
                    matchesType = typeNames.includes(typeFilter);
                }

                return matchesSearch && matchesPartner && matchesVat && matchesSupplier && matchesType;
            });

            // Only reset page if not preserving and filters changed
            if (!preservePage) {
                mappingsCurrentPage = 1;
            } else {
                // Ensure current page is still valid after filtering
                const totalPages = Math.ceil(filteredMappingsCache.length / mappingsPageSize) || 1;
                if (mappingsCurrentPage > totalPages) {
                    mappingsCurrentPage = totalPages;
                }
            }
            sortAndRenderMappings();
        }

        function changeMappingsPageSize(newSize) {
            mappingsPageSize = parseInt(newSize);
            localStorage.setItem('efacturaMappingsPageSize', mappingsPageSize);
            mappingsCurrentPage = 1;
            sortAndRenderMappings();
        }

        function clearMappingsFilters() {
            document.getElementById('mappingsSearchInput').value = '';
            document.getElementById('mappingsPartnerFilter').value = '';
            document.getElementById('mappingsVatFilter').value = '';
            document.getElementById('mappingsSupplierFilter').value = '';
            document.getElementById('mappingsTypeFilter').value = '';
            filteredMappingsCache = [...mappingsCache];
            mappingsCurrentPage = 1;
            sortAndRenderMappings();
        }

        // Populate Partner and Type filter dropdowns
        function populateMappingsFilterDropdowns() {
            // Populate Partner dropdown
            const partnerSelect = document.getElementById('mappingsPartnerFilter');
            if (partnerSelect) {
                const partnerNames = [...new Set(mappingsCache.map(m => m.partner_name).filter(Boolean))].sort();
                partnerSelect.innerHTML = '<option value="">All Partners</option>' +
                    partnerNames.map(name => `<option value="${name}">${name}</option>`).join('');
            }

            // Populate Type dropdown from partnerTypesCache
            const typeSelect = document.getElementById('mappingsTypeFilter');
            if (typeSelect && partnerTypesCache.length > 0) {
                typeSelect.innerHTML = '<option value="">All Types</option>' +
                    partnerTypesCache.map(t => `<option value="${t.name}">${t.name}</option>`).join('') +
                    '<option value="none">No Type</option>';
            }
        }

        async function loadSupplierMappings(forceReload = false) {
            // Skip if already loaded and not forcing reload
            if (mappingsLoaded && !forceReload) {
                sortAndRenderMappings();
                return;
            }

            // Render table header with column config
            renderMappingsTableHeader();

            const tbody = document.getElementById('mappingsTableBody');
            const cols = getMappingsVisibleColumns();
            tbody.innerHTML = `<tr><td colspan="${cols.length}" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                // Load partner types first (for Type filter dropdown)
                if (partnerTypesCache.length === 0) {
                    const typesRes = await fetch('/efactura/api/partner-types');
                    const typesData = await typesRes.json();
                    if (typesData.success) {
                        partnerTypesCache = typesData.types || [];
                    }
                }

                const res = await fetch('/efactura/api/mappings');
                const data = await res.json();

                if (data.success) {
                    mappingsCache = data.mappings || [];
                    mappingsLoaded = true; // Mark as loaded
                    updateMappingsTableHeaders(); // Update sort indicators
                    populateMappingsFilterDropdowns(); // Populate Partner and Type dropdowns
                    // Reapply filters and preserve page position on reload
                    filterMappings(forceReload);
                    updateBadge('mappingsBadge', data.count || 0);
                    // Restore page size from localStorage
                    document.getElementById('mappingsPageSize').value = mappingsPageSize || 50;
                } else {
                    tbody.innerHTML = `<tr><td colspan="${cols.length}" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="${cols.length}" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        // Bulk selection state for mappings
        let selectedMappings = new Set();

        function renderMappingsTable(mappings) {
            const tbody = document.getElementById('mappingsTableBody');
            const cols = getMappingsVisibleColumns();
            const searchTerm = document.getElementById('mappingsSearchInput')?.value || '';
            const typeFilter = document.getElementById('mappingsTypeFilter')?.value || '';
            const hasFilters = searchTerm || typeFilter;

            if (!mappings || mappings.length === 0) {
                const message = hasFilters
                    ? '<i class="bi bi-search"></i> No mappings match your search criteria.'
                    : '<i class="bi bi-info-circle"></i> No supplier mappings yet. Click "Add Mapping" to create one.';
                tbody.innerHTML = `<tr><td colspan="${cols.length}" class="text-center text-muted py-4">${message}</td></tr>`;
                const selectAll = document.getElementById('mappingsSelectAll');
                if (selectAll) selectAll.checked = false;
                selectedMappings.clear();
                updateMappingsSelectionCount();
                return;
            }

            tbody.innerHTML = mappings.map(m => {
                const createdDate = m.created_at ? new Date(m.created_at).toLocaleDateString('ro-RO') : '-';
                const isSelected = selectedMappings.has(m.id);
                // Support multiple types - use type_names array if available, fallback to type_name
                const typeNames = m.type_names && m.type_names.length > 0 ? m.type_names : (m.type_name ? [m.type_name] : []);
                const typeBadges = typeNames.length > 0
                    ? typeNames.map(tn => `<span class="badge ${tn === 'Service' ? 'bg-info' : 'bg-warning'} me-1">${tn}</span>`).join('')
                    : '<span class="text-muted">-</span>';

                return `<tr data-id="${m.id}">
                    ${cols.map(col => {
                        switch(col.id) {
                            case 'checkbox':
                                return `<td><input type="checkbox" class="form-check-input mapping-checkbox" value="${m.id}" ${isSelected ? 'checked' : ''} onchange="onMappingCheckboxChange(${m.id}, this.checked)"></td>`;
                            case 'partner_name':
                                return `<td><strong>${m.partner_name || '-'}</strong></td>`;
                            case 'partner_cif':
                                return `<td><code class="text-muted">${m.partner_cif || '-'}</code></td>`;
                            case 'supplier_name':
                                return `<td>${m.supplier_name || '-'}</td>`;
                            case 'supplier_vat':
                                return `<td><code class="text-success">${m.supplier_vat || '-'}</code></td>`;
                            case 'type':
                                return `<td>${typeBadges}</td>`;
                            case 'brand':
                                return `<td>${m.brand ? `<span class="badge bg-info text-dark">${m.brand}</span>` : '<span class="text-muted">-</span>'}</td>`;
                            case 'department':
                                return `<td>${m.department || '<span class="text-muted">-</span>'}</td>`;
                            case 'subdepartment':
                                return `<td>${m.subdepartment || '<span class="text-muted">-</span>'}</td>`;
                            case 'kod_konto':
                                return `<td><code class="text-primary">${m.kod_konto || '-'}</code></td>`;
                            case 'supplier_note':
                                return `<td><span class="text-muted small">${m.supplier_note || '-'}</span></td>`;
                            case 'created_at':
                                return `<td><span class="small text-muted">${createdDate}</span></td>`;
                            case 'actions':
                                return `<td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="editMapping(${m.id})" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteMapping(${m.id})" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>`;
                            default:
                                return '<td>-</td>';
                        }
                    }).join('')}
                </tr>`;
            }).join('');

            // Update select all checkbox state
            const selectAll = document.getElementById('mappingsSelectAll');
            const allChecked = mappings.length > 0 && mappings.every(m => selectedMappings.has(m.id));
            if (selectAll) selectAll.checked = allChecked;
        }

        function onMappingCheckboxChange(id, checked) {
            if (checked) {
                selectedMappings.add(id);
            } else {
                selectedMappings.delete(id);
            }
            updateMappingsSelectionCount();

            // Update select all checkbox state
            const allChecked = mappingsCache.length > 0 && mappingsCache.every(m => selectedMappings.has(m.id));
            document.getElementById('mappingsSelectAll').checked = allChecked;
        }

        // Select only visible page checkboxes
        function toggleMappingsSelectPage() {
            const selectAll = document.getElementById('mappingsSelectAll').checked;
            document.querySelectorAll('.mapping-checkbox').forEach(cb => {
                cb.checked = selectAll;
                const id = parseInt(cb.value);
                if (selectAll) {
                    selectedMappings.add(id);
                } else {
                    selectedMappings.delete(id);
                }
            });
            updateMappingsSelectionCount();
        }

        // Select ALL mappings (entire filtered dataset, not just page)
        function selectAllMappings() {
            const dataToSelect = filteredMappingsCache.length > 0 ? filteredMappingsCache : mappingsCache;
            selectedMappings.clear();
            dataToSelect.forEach(m => selectedMappings.add(m.id));
            // Check visible checkboxes
            document.querySelectorAll('.mapping-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('mappingsSelectAll').checked = true;
            updateMappingsSelectionCount();
        }

        function updateMappingsSelectionCount() {
            const count = selectedMappings.size;
            document.getElementById('mappingsSelectedCount').textContent = count;
            const bulkBar = document.getElementById('mappingsBulkActionBar');
            if (count > 0) {
                bulkBar.classList.add('show');
            } else {
                bulkBar.classList.remove('show');
            }
            // Update total count in dropdown
            const total = filteredMappingsCache.length > 0 ? filteredMappingsCache.length : mappingsCache.length;
            const totalEl = document.getElementById('mappingsTotalForSelect');
            if (totalEl) totalEl.textContent = total;
        }

        function clearMappingsSelection() {
            selectedMappings.clear();
            document.querySelectorAll('.mapping-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('mappingsSelectAll').checked = false;
            updateMappingsSelectionCount();
        }

        async function bulkDeleteMappings() {
            const ids = Array.from(selectedMappings);
            if (ids.length === 0) {
                await JarvisDialog.alert('No mappings selected', { type: 'warning' });
                return;
            }

            const confirmed = await JarvisDialog.confirm(`Delete ${ids.length} selected mapping(s)? This cannot be undone.`, { danger: true });
            if (!confirmed) {
                return;
            }

            try {
                const res = await fetch('/efactura/api/mappings/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                const data = await res.json();

                if (data.success) {
                    // Remove deleted items from local caches
                    const deletedSet = new Set(ids);
                    mappingsCache = mappingsCache.filter(m => !deletedSet.has(m.id));
                    filteredMappingsCache = filteredMappingsCache.filter(m => !deletedSet.has(m.id));
                    selectedMappings.clear();
                    updateMappingsSelectionCount();
                    sortAndRenderMappings();
                    // Update badge with new count
                    updateBadge('mappingsBadge', mappingsCache.length);
                    // Re-populate partner dropdown with remaining partners
                    populateMappingsFilterDropdowns();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete mappings', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function bulkSetMappingsType(typeName) {
            const ids = Array.from(selectedMappings);
            if (ids.length === 0) {
                await JarvisDialog.alert('No mappings selected', { type: 'warning' });
                return;
            }

            const typeLabel = typeName || 'No Type';
            const confirmed = await JarvisDialog.confirm(`Set type to "${typeLabel}" for ${ids.length} selected mapping(s)?`, { title: 'Confirm' });
            if (!confirmed) {
                return;
            }

            try {
                const res = await fetch('/efactura/api/mappings/bulk-set-type', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids, type_name: typeName })
                });
                const data = await res.json();

                if (data.success) {
                    await JarvisDialog.alert(`${data.updated} mapping(s) updated to "${typeLabel}"`, { type: 'success' });
                    selectedMappings.clear();
                    updateMappingsSelectionCount();
                    mappingsLoaded = false; // Force reload
                    loadSupplierMappings(true);

                    // Show refresh button if type was set (may have auto-hidden invoices)
                    if (typeName) {
                        showRefreshButton(data.auto_hidden || 0);
                    }
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to update mappings', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        // Partner types cache
        let partnerTypesCache = [];

        async function loadPartnerTypesForDropdown(forceReload = false, selectedIds = []) {
            // Use cache if available and not forcing reload
            if (partnerTypesCache.length > 0 && !forceReload) {
                populateTypeCheckboxes(selectedIds);
                return;
            }

            try {
                const res = await fetch('/efactura/api/partner-types');
                const data = await res.json();
                if (data.success) {
                    partnerTypesCache = data.types || [];
                    populateTypeCheckboxes(selectedIds);
                }
            } catch (err) {
                console.error('Failed to load partner types:', err);
            }
        }

        function populateTypeCheckboxes(selectedIds = []) {
            const container = document.getElementById('mappingTypeCheckboxes');
            if (!container) return;

            container.innerHTML = partnerTypesCache.map(t => {
                const checked = selectedIds.includes(t.id) ? 'checked' : '';
                return `
                    <div class="form-check">
                        <input class="form-check-input mapping-type-checkbox" type="checkbox"
                               value="${t.id}" id="typeCheck${t.id}" ${checked}>
                        <label class="form-check-label" for="typeCheck${t.id}">${t.name}</label>
                    </div>
                `;
            }).join('');

            if (partnerTypesCache.length === 0) {
                container.innerHTML = '<span class="text-muted small">No types available</span>';
            }
        }

        function getSelectedTypeIds() {
            const checkboxes = document.querySelectorAll('.mapping-type-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        // Department/Subdepartment/Brand caches - loaded from department_structure and master tables
        let departmentStructureCache = [];
        let departmentsCache = [];
        let subdepartmentsCache = [];
        let brandsCache = [];

        async function loadBrands() {
            if (brandsCache.length === 0) {
                try {
                    const res = await fetch('/hr/events/api/master/brands');
                    const data = await res.json();
                    brandsCache = (data || []).filter(b => b.is_active !== false);
                } catch (err) {
                    console.error('Failed to load brands:', err);
                    brandsCache = [];
                }
            }
        }

        async function loadBrandsForDropdown() {
            await loadBrands();

            const select = document.getElementById('mappingBrand');
            if (!select) return;

            select.innerHTML = '<option value="">-- None --</option>' +
                brandsCache.map(b => `<option value="${b.name}">${b.name}</option>`).join('');
        }

        async function loadDepartmentStructure() {
            if (departmentStructureCache.length === 0) {
                try {
                    const res = await fetch('/hr/events/api/structure/departments-full');
                    const data = await res.json();
                    departmentStructureCache = data || [];
                    // Extract unique departments
                    const deptSet = new Set();
                    departmentStructureCache.forEach(ds => {
                        if (ds.department) deptSet.add(ds.department);
                    });
                    departmentsCache = Array.from(deptSet).sort().map(name => ({ name }));
                } catch (err) {
                    console.error('Failed to load department structure:', err);
                    departmentStructureCache = [];
                    departmentsCache = [];
                }
            }
        }

        async function loadDepartmentsForDropdown() {
            await loadDepartmentStructure();

            const select = document.getElementById('mappingDepartment');
            if (!select) return;

            select.innerHTML = '<option value="">-- None --</option>' +
                departmentsCache.map(d => `<option value="${d.name}">${d.name}</option>`).join('');

            // Add change handler to filter subdepartments
            select.onchange = () => updateSubdepartmentsForDepartment(select.value, 'mappingSubdepartment');
        }

        function updateSubdepartmentsForDepartment(department, selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;

            if (!department) {
                // No department selected - show all subdepartments or none
                select.innerHTML = '<option value="">-- None --</option>';
                select.disabled = true;
                return;
            }

            // Filter subdepartments that exist for this department in the structure
            const subdepts = new Set();
            departmentStructureCache.forEach(ds => {
                if (ds.department === department && ds.subdepartment) {
                    subdepts.add(ds.subdepartment);
                }
            });

            const subdeptList = Array.from(subdepts).sort();

            if (subdeptList.length === 0) {
                select.innerHTML = '<option value="">-- No subdepartments --</option>';
                select.disabled = true;
            } else {
                select.innerHTML = '<option value="">-- None --</option>' +
                    subdeptList.map(s => `<option value="${s}">${s}</option>`).join('');
                select.disabled = false;
            }
        }

        async function loadSubdepartmentsForDropdown() {
            await loadDepartmentStructure();

            const select = document.getElementById('mappingSubdepartment');
            if (!select) return;

            // Initially disabled until department is selected
            const deptSelect = document.getElementById('mappingDepartment');
            const selectedDept = deptSelect ? deptSelect.value : '';

            if (selectedDept) {
                updateSubdepartmentsForDepartment(selectedDept, 'mappingSubdepartment');
            } else {
                select.innerHTML = '<option value="">-- Select Department First --</option>';
                select.disabled = true;
            }
        }

        async function openAddMappingModal() {
            document.getElementById('mappingId').value = '';
            document.getElementById('mappingPartnerName').value = '';
            document.getElementById('mappingPartnerCif').value = '';
            document.getElementById('mappingSupplierName').value = '';
            document.getElementById('mappingSupplierVat').value = '';
            document.getElementById('mappingKodKonto').value = '';
            document.getElementById('mappingSupplierNote').value = '';
            document.getElementById('mappingModalTitle').innerHTML = '<i class="bi bi-diagram-3"></i> Add Supplier Mapping';

            // Load partner types with no selection
            await loadPartnerTypesForDropdown(false, []);

            // Load and reset brand dropdown
            await loadBrandsForDropdown();
            document.getElementById('mappingBrand').value = '';

            // Load and reset department/subdepartment dropdowns
            await loadDepartmentsForDropdown();
            await loadSubdepartmentsForDropdown();
            document.getElementById('mappingDepartment').value = '';
            document.getElementById('mappingSubdepartment').value = '';

            const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
            modal.show();
        }

        async function editMapping(mappingId) {
            const mapping = mappingsCache.find(m => m.id === mappingId);
            if (!mapping) {
                await JarvisDialog.alert('Mapping not found', { type: 'error' });
                return;
            }

            document.getElementById('mappingId').value = mapping.id;
            document.getElementById('mappingPartnerName').value = mapping.partner_name || '';
            document.getElementById('mappingPartnerCif').value = mapping.partner_cif || '';
            document.getElementById('mappingSupplierName').value = mapping.supplier_name || '';
            document.getElementById('mappingSupplierVat').value = mapping.supplier_vat || '';
            document.getElementById('mappingKodKonto').value = mapping.kod_konto || '';
            document.getElementById('mappingSupplierNote').value = mapping.supplier_note || '';
            document.getElementById('mappingModalTitle').innerHTML = '<i class="bi bi-diagram-3"></i> Edit Supplier Mapping';

            // Load partner types and select the current values
            const selectedTypeIds = mapping.type_ids || (mapping.type_id ? [mapping.type_id] : []);
            await loadPartnerTypesForDropdown(false, selectedTypeIds);

            // Load brands and set value
            await loadBrandsForDropdown();
            document.getElementById('mappingBrand').value = mapping.brand || '';

            // Load departments and set value
            await loadDepartmentsForDropdown();
            document.getElementById('mappingDepartment').value = mapping.department || '';

            // Update subdepartments based on selected department, then set value
            updateSubdepartmentsForDepartment(mapping.department || '', 'mappingSubdepartment');
            document.getElementById('mappingSubdepartment').value = mapping.subdepartment || '';

            const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
            modal.show();
        }

        async function saveMapping() {
            const mappingId = document.getElementById('mappingId').value;
            const partnerName = document.getElementById('mappingPartnerName').value.trim();
            const partnerCif = document.getElementById('mappingPartnerCif').value.trim();
            const supplierName = document.getElementById('mappingSupplierName').value.trim();
            const supplierVat = document.getElementById('mappingSupplierVat').value.trim();
            const typeIds = getSelectedTypeIds();
            const kodKonto = document.getElementById('mappingKodKonto').value.trim();
            const supplierNote = document.getElementById('mappingSupplierNote').value.trim();
            const brand = document.getElementById('mappingBrand').value;
            const department = document.getElementById('mappingDepartment').value;
            const subdepartment = document.getElementById('mappingSubdepartment').value;

            if (!partnerName) {
                await JarvisDialog.alert('Partner Name is required', { type: 'warning' });
                return;
            }

            if (!supplierName) {
                await JarvisDialog.alert('Supplier Name is required', { type: 'warning' });
                return;
            }

            const payload = {
                partner_name: partnerName,
                partner_cif: partnerCif,
                supplier_name: supplierName,
                supplier_vat: supplierVat,
                type_ids: typeIds,
                kod_konto: kodKonto,
                supplier_note: supplierNote,
                brand: brand || null,
                department: department || null,
                subdepartment: subdepartment || null,
            };

            try {
                let res;
                if (mappingId) {
                    // Update existing
                    res = await fetch(`/efactura/api/mappings/${mappingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new
                    res = await fetch('/efactura/api/mappings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const data = await res.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
                    loadSupplierMappings(true); // Force reload to get fresh data

                    // Show refresh button if types were set (may have auto-hidden invoices)
                    if (typeIds && typeIds.length > 0) {
                        showRefreshButton(data.auto_hidden || 0);
                    }
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to save mapping', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function deleteMapping(mappingId) {
            const confirmed = await JarvisDialog.confirm('Delete this supplier mapping?', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/mappings/${mappingId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    // Remove from local caches immediately
                    mappingsCache = mappingsCache.filter(m => m.id !== mappingId);
                    filteredMappingsCache = filteredMappingsCache.filter(m => m.id !== mappingId);
                    selectedMappings.delete(mappingId);
                    sortAndRenderMappings();
                    updateMappingsSelectionCount();
                    // Update badge count
                    updateBadge('mappingsBadge', mappingsCache.length);
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete mapping', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function importSuppliersFromInvoices() {
            try {
                // Fetch distinct partners from invoices
                const res = await fetch('/efactura/api/partners/distinct');
                const data = await res.json();

                if (!data.success) {
                    await JarvisDialog.alert(data.error || 'Failed to load partners', { type: 'error' });
                    return;
                }

                if (!data.partners || data.partners.length === 0) {
                    await JarvisDialog.alert('No partners found in imported invoices.', { type: 'warning' });
                    return;
                }

                // Get existing mappings to filter out already mapped partners
                const existingPartners = new Set(mappingsCache.map(m => m.partner_name?.toLowerCase()));
                const unmappedPartners = data.partners.filter(p =>
                    !existingPartners.has(p.partner_name?.toLowerCase())
                );

                if (unmappedPartners.length === 0) {
                    await JarvisDialog.alert('All partners from invoices already have mappings.', { type: 'warning' });
                    return;
                }

                // Show import modal with list of unmapped partners
                showImportPartnersModal(unmappedPartners);

            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        function showImportPartnersModal(partners) {
            // Create modal dynamically if it doesn't exist
            let modal = document.getElementById('importPartnersModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'importPartnersModal';
                modal.className = 'modal fade';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> Import Suppliers from Invoices</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted small mb-3">Select partners to create mappings. Supplier Name will default to Partner Name.</p>
                                <div class="mb-2">
                                    <input type="checkbox" class="form-check-input me-2" id="importSelectAll" onchange="toggleImportSelectAll()">
                                    <label class="form-check-label small" for="importSelectAll">Select All</label>
                                </div>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm" id="importPartnersTable">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th width="30"></th>
                                                <th>Partner Name</th>
                                                <th>Partner VAT</th>
                                                <th>Invoice Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="importPartnersTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <span id="importSelectedCount" class="me-auto text-muted small">0 selected</span>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="importSelectedPartners()">
                                    <i class="bi bi-check-lg"></i> Create Mappings
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Populate table
            const tbody = document.getElementById('importPartnersTableBody');
            tbody.innerHTML = partners.map((p, idx) => `
                <tr>
                    <td><input type="checkbox" class="form-check-input import-partner-checkbox" value="${idx}" data-name="${escapeHtml(p.partner_name)}" data-cif="${escapeHtml(p.partner_cif || '')}" onchange="updateImportSelectedCount()"></td>
                    <td>${escapeHtml(p.partner_name) || '-'}</td>
                    <td><code class="text-muted">${escapeHtml(p.partner_cif) || '-'}</code></td>
                    <td><span class="badge bg-secondary">${p.invoice_count}</span></td>
                </tr>
            `).join('');

            // Reset select all and count
            document.getElementById('importSelectAll').checked = false;
            updateImportSelectedCount();

            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleImportSelectAll() {
            const selectAll = document.getElementById('importSelectAll').checked;
            document.querySelectorAll('.import-partner-checkbox').forEach(cb => cb.checked = selectAll);
            updateImportSelectedCount();
        }

        function updateImportSelectedCount() {
            const count = document.querySelectorAll('.import-partner-checkbox:checked').length;
            document.getElementById('importSelectedCount').textContent = `${count} selected`;
        }

        async function importSelectedPartners() {
            const checkboxes = document.querySelectorAll('.import-partner-checkbox:checked');
            if (checkboxes.length === 0) {
                await JarvisDialog.alert('Please select at least one partner to import.', { type: 'warning' });
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

            let created = 0;
            let errors = [];

            for (const cb of checkboxes) {
                const partnerName = cb.dataset.name;
                const partnerCif = cb.dataset.cif;

                try {
                    const res = await fetch('/efactura/api/mappings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            partner_name: partnerName,
                            partner_cif: partnerCif,
                            supplier_name: partnerName, // Default to same name
                            supplier_vat: partnerCif,   // Default to same VAT
                        })
                    });
                    const data = await res.json();

                    if (data.success) {
                        created++;
                    } else {
                        errors.push(`${partnerName}: ${data.error}`);
                    }
                } catch (err) {
                    errors.push(`${partnerName}: ${err.message}`);
                }
            }

            btn.disabled = false;
            btn.innerHTML = originalText;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('importPartnersModal')).hide();

            // Show result
            let msg = `Created ${created} mapping(s).`;
            if (errors.length > 0) {
                msg += `\n\n${errors.length} error(s):\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) msg += `\n... and ${errors.length - 5} more`;
            }
            await JarvisDialog.alert(msg, { type: errors.length > 0 ? 'warning' : 'success' });

            // Reload mappings
            loadSupplierMappings();
        }

        // ============================================
        // Partner Types Management
        // ============================================

        async function openPartnerTypesModal() {
            const modal = new bootstrap.Modal(document.getElementById('partnerTypesModal'));
            modal.show();
            await loadPartnerTypesTable();
        }

        async function loadPartnerTypesTable() {
            const tbody = document.getElementById('partnerTypesTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch('/efactura/api/partner-types?active_only=false');
                const data = await res.json();

                if (data.success) {
                    renderPartnerTypesTable(data.types || []);
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function renderPartnerTypesTable(types) {
            const tbody = document.getElementById('partnerTypesTableBody');

            if (!types || types.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">
                    <i class="bi bi-info-circle"></i> No partner types yet. Add one above.
                </td></tr>`;
                return;
            }

            tbody.innerHTML = types.map(t => {
                const statusBadge = t.is_active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';

                const hideInFilter = t.hide_in_filter !== false; // Default to true if undefined
                const toggleChecked = hideInFilter ? 'checked' : '';

                return `<tr data-id="${t.id}">
                    <td><strong>${t.name || '-'}</strong></td>
                    <td class="text-muted small">${t.description || '-'}</td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" ${toggleChecked}
                                   onchange="togglePartnerTypeHideInFilter(${t.id}, this.checked)"
                                   title="${hideInFilter ? 'Hidden when filter is ON' : 'Visible when filter is ON'}">
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger" onclick="deletePartnerType(${t.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // Toggle hide_in_filter for a partner type and show refresh button
        async function togglePartnerTypeHideInFilter(typeId, hideInFilter) {
            try {
                const res = await fetch(`/efactura/api/partner-types/${typeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hide_in_filter: hideInFilter })
                });
                const data = await res.json();

                if (data.success) {
                    // Show refresh button to let user refresh when ready
                    showRefreshButton();

                    // Update cache for dropdown
                    loadPartnerTypesForDropdown();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to update partner type', { type: 'error' });
                    // Reload table to reset toggle state
                    loadPartnerTypesTable();
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
                loadPartnerTypesTable();
            }
        }

        async function addPartnerType() {
            const name = document.getElementById('newTypeName').value.trim();
            const description = document.getElementById('newTypeDescription').value.trim();

            if (!name) {
                await JarvisDialog.alert('Name is required', { type: 'warning' });
                return;
            }

            try {
                const res = await fetch('/efactura/api/partner-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('newTypeName').value = '';
                    document.getElementById('newTypeDescription').value = '';
                    loadPartnerTypesTable();
                    // Update cache for dropdown
                    loadPartnerTypesForDropdown();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to create partner type', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }

        async function deletePartnerType(typeId) {
            const confirmed = await JarvisDialog.confirm('Delete this partner type? It will be soft-deleted (deactivated).', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/efactura/api/partner-types/${typeId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    loadPartnerTypesTable();
                    // Update cache for dropdown
                    loadPartnerTypesForDropdown();
                } else {
                    await JarvisDialog.alert(data.error || 'Failed to delete partner type', { type: 'error' });
                }
            } catch (err) {
                await JarvisDialog.alert('Error: ' + err.message, { type: 'error' });
            }
        }
    </script>
</body>
</html>
