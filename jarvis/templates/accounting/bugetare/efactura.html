<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - e-Factura Invoices</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        .summary-filter-bar { font-size: 0.85rem; }
        .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
        .summary-stat i { font-size: 1rem; }
        .summary-stat strong { color: var(--bs-body-color); }
        .bulk-action-bar {
            display: none;
            padding: 0.75rem 1rem;
            background: var(--bs-light);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            align-items: center;
            justify-content: space-between;
        }
        .bulk-action-bar.show { display: flex; }
        .tab-badge {
            font-size: 0.7rem;
            padding: 0.15em 0.5em;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        /* Sync Progress Styles */
        .sync-progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 8px;
            border: 1px solid #a5d6a7;
            min-width: 280px;
        }
        .sync-progress-info {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
            color: #2e7d32;
        }
        .sync-icon { animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .sync-progress-bar {
            flex: 1;
            height: 6px;
            background: #c8e6c9;
            border-radius: 3px;
            overflow: hidden;
            min-width: 100px;
        }
        .sync-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .sync-progress-fill.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }
        @keyframes indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(400%); }
        }
        .sync-progress-container.completed {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #90caf9;
        }
        .sync-progress-container.completed .sync-progress-info { color: #1565c0; }
        .sync-progress-container.error {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #ef9a9a;
        }
        .sync-progress-container.error .sync-progress-info { color: #c62828; }
        /* Sortable Table Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .sortable::after {
            content: '\F282';
            font-family: 'bootstrap-icons';
            margin-left: 4px;
            opacity: 0.3;
            font-size: 0.75em;
        }
        .sortable.asc::after {
            content: '\F235';
            opacity: 1;
        }
        .sortable.desc::after {
            content: '\F229';
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'accounting' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item active">e-Factura</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
            {% set active_page = 'efactura' %}
            {% set inline_nav = true %}
            {% include 'partials/_accounting_nav.html' %}

            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3">
                <!-- Sync Progress Indicator (hidden by default) -->
                <div id="syncProgressContainer" class="sync-progress-container" style="display: none;">
                    <div class="sync-progress-info">
                        <i class="bi bi-cloud-arrow-down sync-icon"></i>
                        <span id="syncStatusText">Syncing...</span>
                    </div>
                    <div class="sync-progress-bar">
                        <div id="syncProgressBar" class="sync-progress-fill"></div>
                    </div>
                    <small id="syncProgressDetail" class="text-muted">Fetching invoices...</small>
                </div>

                <span class="summary-stat text-warning" title="Unallocated Invoices">
                    <i class="bi bi-inbox"></i>
                    <strong id="unallocatedCount">0</strong> unallocated
                </span>
                <span class="summary-stat text-success" title="Total Value">
                    <i class="bi bi-cash-stack"></i>
                    <strong id="totalValueUnallocated">0</strong>
                </span>
            </div>
        </div>

        <!-- Tabs -->
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs mb-0" id="mainTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#unallocatedTab" onclick="loadUnallocatedInvoices()">
                        <i class="bi bi-inbox"></i> Unallocated
                        <span id="unallocatedBadge" class="badge bg-warning tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#hiddenTab" onclick="loadHiddenInvoices()">
                        <i class="bi bi-eye-slash"></i> Hidden
                        <span id="hiddenBadge" class="badge bg-secondary tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#binTab" onclick="loadBinInvoices()">
                        <i class="bi bi-trash3"></i> Bin
                        <span id="binBadge" class="badge bg-danger tab-badge" style="display: none;">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#mappingsTab" onclick="loadSupplierMappings()">
                        <i class="bi bi-diagram-3"></i> Mappings
                        <span id="mappingsBadge" class="badge bg-info tab-badge" style="display: none;">0</span>
                    </a>
                </li>
            </ul>
            <div class="d-flex gap-2">
                <a href="/efactura/" class="btn btn-sm btn-outline-secondary" title="Go to e-Factura Connector settings">
                    <i class="bi bi-gear"></i> Connector Settings
                </a>
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="syncAll()" id="syncBtn" title="Fetch and import all invoices from all connected companies">
                        <i class="bi bi-cloud-arrow-down"></i> Sync
                    </button>
                    <button type="button" class="btn btn-sm btn-success dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" title="Select sync period">
                        <span class="visually-hidden">Toggle Dropdown</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="syncAll(1); return false;"><i class="bi bi-calendar3"></i> Last 1 day (default)</a></li>
                        <li><a class="dropdown-item" href="#" onclick="syncAll(2); return false;"><i class="bi bi-calendar3"></i> Last 2 days</a></li>
                        <li><a class="dropdown-item" href="#" onclick="syncAll(3); return false;"><i class="bi bi-calendar3"></i> Last 3 days</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Unallocated Tab -->
            <div class="tab-pane fade show active" id="unallocatedTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-table"></i> Unallocated Invoices <span id="unallocatedResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="searchInput" placeholder="Search supplier or invoice #..." onkeyup="if(event.key==='Enter') loadUnallocatedInvoices()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="loadUnallocatedInvoices()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openColumnConfig()">
                                    <i class="bi bi-gear"></i> Columns
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="filtersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Company</label>
                                    <select class="form-select form-select-sm" id="companyFilter">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Direction</label>
                                    <select class="form-select form-select-sm" id="directionFilter">
                                        <option value="">All</option>
                                        <option value="received" selected>Received</option>
                                        <option value="sent">Sent</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">From Date</label>
                                    <input type="date" class="form-control form-control-sm" id="startDate">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">To Date</label>
                                    <input type="date" class="form-control form-control-sm" id="endDate">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-primary" onclick="loadUnallocatedInvoices()">
                                        <i class="bi bi-search"></i> Apply
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearFilters()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions -->
                        <div class="bulk-action-bar" id="bulkActionBar">
                            <span><strong id="selectedCount">0</strong> selected</span>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-success btn-sm" onclick="sendSelectedToInvoices()">
                                    <i class="bi bi-send"></i> Send to Invoices
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="bulkHideSelected()">
                                    <i class="bi bi-eye-slash"></i> Hide
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteSelected()">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="invoicesTable">
                                <thead class="table-light" id="invoicesTableHead">
                                    <!-- Dynamic columns rendered by JS -->
                                </thead>
                                <tbody id="invoicesTableBody">
                                    <tr>
                                        <td colspan="12" class="text-center text-muted py-4">
                                            <i class="bi bi-hourglass-split"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div id="paginationInfo" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                            <div class="d-flex align-items-center gap-2">
                                <span id="paginationSummary" class="text-muted small"></span>
                                <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)" id="pageSizeSelect">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span class="text-muted small">per page</span>
                            </div>
                            <div id="paginationControls" class="btn-group btn-group-sm"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden Tab -->
            <div class="tab-pane fade" id="hiddenTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-eye-slash"></i> Hidden Invoices</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreFromHidden()" id="hiddenRestoreBtn" disabled>
                                <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDeleteFromHidden()" id="hiddenDeleteBtn" disabled>
                                <i class="bi bi-trash"></i> Move to Bin
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="hiddenTable">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" class="form-check-input" id="hiddenSelectAll" onchange="toggleHiddenSelectAll()"></th>
                                        <th class="sortable" onclick="sortHiddenTable('direction')">Direction</th>
                                        <th class="sortable" onclick="sortHiddenTable('invoice_number')">Invoice #</th>
                                        <th class="sortable" onclick="sortHiddenTable('partner_name')">Supplier / Partner</th>
                                        <th class="sortable" onclick="sortHiddenTable('issue_date')">Issue Date</th>
                                        <th class="sortable text-end" onclick="sortHiddenTable('total_amount')">Amount</th>
                                        <th class="sortable" onclick="sortHiddenTable('currency')">Currency</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="hiddenTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Hidden" tab to load hidden invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bin Tab -->
            <div class="tab-pane fade" id="binTab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-trash3"></i> Deleted Invoices (Bin) - Auto-deleted after 30 days</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="bulkRestoreFromBin()" id="binRestoreBtn" disabled>
                                <i class="bi bi-arrow-counterclockwise"></i> Restore Selected
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkPermanentDelete()" id="binPermanentDeleteBtn" disabled>
                                <i class="bi bi-trash"></i> Delete Permanently
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="binTable">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" class="form-check-input" id="binSelectAll" onchange="toggleBinSelectAll()"></th>
                                        <th class="sortable" onclick="sortBinTable('direction')">Direction</th>
                                        <th class="sortable" onclick="sortBinTable('invoice_number')">Invoice #</th>
                                        <th class="sortable" onclick="sortBinTable('partner_name')">Supplier / Partner</th>
                                        <th class="sortable" onclick="sortBinTable('issue_date')">Issue Date</th>
                                        <th class="sortable text-end" onclick="sortBinTable('total_amount')">Amount</th>
                                        <th class="sortable" onclick="sortBinTable('deleted_at')">Deleted At</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="binTableBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">Click "Bin" tab to load deleted invoices</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mappings Tab -->
            <div class="tab-pane fade" id="mappingsTab">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-diagram-3"></i> Supplier Mappings <span id="mappingsResultCount" class="badge bg-secondary ms-2"></span></span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group input-group-sm" style="width: 200px;">
                                    <input type="text" class="form-control" id="mappingsSearchInput" placeholder="Search partner or supplier..." onkeyup="if(event.key==='Enter') filterMappings()">
                                    <button class="btn btn-outline-secondary" type="button" onclick="filterMappings()">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#mappingsFiltersCollapse">
                                    <i class="bi bi-funnel"></i> Filters
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="openPartnerTypesModal()" title="Manage Partner Types">
                                    <i class="bi bi-gear"></i> Types
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="importSuppliersFromInvoices()">
                                    <i class="bi bi-box-arrow-in-down"></i> Import from Invoices
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openAddMappingModal()">
                                    <i class="bi bi-plus-lg"></i> Add Mapping
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-2">
                            Map e-Factura partner names to standardized supplier names used in the Invoice module.
                        </p>

                        <!-- Filters (collapsible) -->
                        <div class="collapse" id="mappingsFiltersCollapse">
                            <div class="row mb-3 g-2">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Type</label>
                                    <select class="form-select form-select-sm" id="mappingsTypeFilter" onchange="filterMappings()">
                                        <option value="">All Types</option>
                                        <option value="Service">Service</option>
                                        <option value="Merchandise">Merchandise</option>
                                        <option value="none">No Type</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Per Page</label>
                                    <select class="form-select form-select-sm" id="mappingsPageSize" onchange="changeMappingsPageSize(this.value)">
                                        <option value="25">25</option>
                                        <option value="50" selected>50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                        <option value="0">All</option>
                                    </select>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="clearMappingsFilters()">
                                        <i class="bi bi-x"></i> Clear
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Bulk Actions for Mappings -->
                        <div class="bulk-action-bar" id="mappingsBulkActionBar">
                            <span><strong id="mappingsSelectedCount">0</strong> selected</span>
                            <div class="d-flex gap-2 align-items-center">
                                <button class="btn btn-danger btn-sm" onclick="bulkDeleteMappings()">
                                    <i class="bi bi-trash"></i> Delete Selected
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="clearMappingsSelection()">
                                    Clear
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="mappingsTable">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="mappingsSelectAll" onchange="toggleMappingsSelectAll()"></th>
                                        <th class="sortable" onclick="sortMappingsTable('partner_name')">Partner (e-Factura)</th>
                                        <th class="sortable" onclick="sortMappingsTable('partner_cif')">Partner VAT</th>
                                        <th class="sortable" onclick="sortMappingsTable('supplier_name')">Supplier Name</th>
                                        <th class="sortable" onclick="sortMappingsTable('supplier_vat')">Supplier VAT</th>
                                        <th class="sortable" onclick="sortMappingsTable('type_name')">Type</th>
                                        <th class="sortable" onclick="sortMappingsTable('kod_konto')">Kod Konto</th>
                                        <th>Supplier Note</th>
                                        <th class="sortable" onclick="sortMappingsTable('created_at')">Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mappingsTableBody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">Click "Mappings" tab to load supplier mappings</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Footer -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="mappingsPaginationFooter" style="display: none !important;">
                            <div class="text-muted small">
                                Showing <span id="mappingsShowingRange">0-0</span> of <span id="mappingsTotalCount">0</span>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="mappingsPagination">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Mapping Modal -->
    <div class="modal fade" id="mappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mappingModalTitle"><i class="bi bi-diagram-3"></i> Add Supplier Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="mappingId">
                    <div class="mb-3">
                        <label class="form-label">Partner Name (e-Factura) <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="mappingPartnerName" placeholder="Name as it appears in e-Factura">
                        <div class="form-text">The supplier name as it appears on e-Factura invoices</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Partner VAT (e-Factura)</label>
                        <input type="text" class="form-control" id="mappingPartnerCif" placeholder="e.g. RO12345678">
                        <div class="form-text">Optional VAT number from e-Factura</div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="mappingSupplierName" placeholder="Standardized supplier name">
                        <div class="form-text">The standardized supplier name for the Invoice module</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier VAT</label>
                        <input type="text" class="form-control" id="mappingSupplierVat" placeholder="e.g. RO12345678">
                        <div class="form-text">Standardized VAT number</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="mappingTypeId">
                                    <option value="">-- Select Type --</option>
                                </select>
                                <div class="form-text">Supplier type (Service, Merchandise)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Kod Konto</label>
                                <input type="text" class="form-control" id="mappingKodKonto" placeholder="e.g. 401.01">
                                <div class="form-text">Accounting code</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier Note</label>
                        <textarea class="form-control" id="mappingSupplierNote" rows="2" placeholder="Optional notes about this supplier..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMapping()">
                        <i class="bi bi-check-lg"></i> Save Mapping
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Drag to reorder. Check/uncheck to show/hide.</p>
                    <ul id="columnConfigList" class="list-group" style="cursor: move;"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetColumnConfig()">Reset to Default</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="applyColumnConfig()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Partner Types Settings Modal -->
    <div class="modal fade" id="partnerTypesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-tags"></i> Partner Types</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3">Manage partner types for supplier mappings (e.g., Service, Merchandise).</p>

                    <!-- Add new type form -->
                    <div class="card mb-3">
                        <div class="card-body py-2">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small mb-1">Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-sm" id="newTypeName" placeholder="e.g. Service">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small mb-1">Description</label>
                                    <input type="text" class="form-control form-control-sm" id="newTypeDescription" placeholder="Optional description">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-primary btn-sm w-100" onclick="addPartnerType()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Types list -->
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th width="100">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partnerTypesTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <span class="spinner-border spinner-border-sm"></span> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Invoice Modal -->
    <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-receipt"></i> Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="invoiceDetailsContent">
                    Loading...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="modalSendToInvoicesBtn">
                        <i class="bi bi-send"></i> Send to Invoices
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let pageSize = parseInt(localStorage.getItem('efacturaPageSize')) || 50;
        let currentInvoiceId = null;
        let companiesCache = [];
        let selectedInvoices = new Set();
        let selectedHiddenInvoices = new Set();
        let selectedBinInvoices = new Set();

        // Sorting state - Unallocated table
        let sortColumn = localStorage.getItem('efacturaSortColumn') || 'issue_date';
        let sortDirection = localStorage.getItem('efacturaSortDir') || 'desc';
        let invoicesCache = []; // Cache for client-side sorting
        let unallocatedLoaded = false; // Tab loaded flag

        // Sorting state - Hidden table
        let hiddenSortColumn = localStorage.getItem('efacturaHiddenSortColumn') || 'issue_date';
        let hiddenSortDirection = localStorage.getItem('efacturaHiddenSortDir') || 'desc';
        let hiddenCache = [];
        let hiddenLoaded = false; // Tab loaded flag

        // Sorting state - Bin table
        let binSortColumn = localStorage.getItem('efacturaBinSortColumn') || 'deleted_at';
        let binSortDirection = localStorage.getItem('efacturaBinSortDir') || 'desc';
        let binCache = [];
        let binLoaded = false; // Tab loaded flag

        // Sorting state - Mappings table
        let mappingsSortColumn = localStorage.getItem('efacturaMappingsSortColumn') || 'partner_name';
        let mappingsSortDirection = localStorage.getItem('efacturaMappingsSortDir') || 'asc';
        let mappingsLoaded = false; // Tab loaded flag

        // Column definitions
        const allColumns = [
            { id: 'checkbox', label: '', fixed: true, width: '40px' },
            { id: 'company', label: 'Company', visible: true },
            { id: 'direction', label: 'Direction', visible: true },
            { id: 'invoice_number', label: 'Invoice #', visible: true },
            { id: 'partner_name', label: 'Supplier / Partner', visible: true },
            { id: 'partner_cif', label: 'Partner VAT', visible: true },
            { id: 'type', label: 'Type', visible: true },
            { id: 'issue_date', label: 'Issue Date', visible: true },
            { id: 'amount', label: 'Amount', visible: true, align: 'end' },
            { id: 'vat', label: 'VAT', visible: true, align: 'end' },
            { id: 'currency', label: 'Currency', visible: true },
            { id: 'imported', label: 'Imported', visible: true },
            { id: 'actions', label: 'Actions', fixed: true, width: '180px' }
        ];

        // Load column config from localStorage
        function getColumnConfig() {
            const saved = localStorage.getItem('efacturaColumnConfig');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {}
            }
            return allColumns.map(c => ({ id: c.id, visible: c.visible !== false }));
        }

        function saveColumnConfig(config) {
            localStorage.setItem('efacturaColumnConfig', JSON.stringify(config));
        }

        function getVisibleColumns() {
            const config = getColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: i });

            return allColumns
                .map(col => ({
                    ...col,
                    visible: col.fixed || (configMap[col.id]?.visible ?? col.visible),
                    order: configMap[col.id]?.order ?? allColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order)
                .filter(col => col.visible || col.fixed);
        }

        // Sortable columns (columns that can be sorted)
        const sortableColumns = ['company', 'direction', 'invoice_number', 'partner_name', 'partner_cif', 'type', 'issue_date', 'amount', 'vat', 'currency', 'imported'];

        // Render table header
        function renderTableHeader() {
            const thead = document.getElementById('invoicesTableHead');
            const cols = getVisibleColumns();

            const allSelected = selectedInvoices.size > 0;
            thead.innerHTML = `<tr>
                ${cols.map(col => {
                    if (col.id === 'checkbox') {
                        return `<th style="width: ${col.width}"><input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll()" ${allSelected ? 'checked' : ''}></th>`;
                    }
                    const align = col.align === 'end' ? 'text-end' : '';
                    const width = col.width ? `style="width: ${col.width}"` : '';
                    const isSortable = sortableColumns.includes(col.id);
                    const sortClass = isSortable ? `sortable ${sortColumn === col.id ? sortDirection : ''}` : '';
                    const onClick = isSortable ? `onclick="sortTable('${col.id}')"` : '';
                    return `<th class="${align} ${sortClass}" ${width} ${onClick}>${col.label}</th>`;
                }).join('')}
            </tr>`;
        }

        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            localStorage.setItem('efacturaSortColumn', sortColumn);
            localStorage.setItem('efacturaSortDir', sortDirection);
            renderTableHeader();
            sortAndRenderInvoices();
        }

        // Sort and render invoices from cache
        function sortAndRenderInvoices() {
            if (!invoicesCache || invoicesCache.length === 0) return;

            const sorted = [...invoicesCache].sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];

                // Handle special columns
                if (sortColumn === 'amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                } else if (sortColumn === 'vat') {
                    valA = parseFloat(a.total_vat || 0);
                    valB = parseFloat(b.total_vat || 0);
                } else if (sortColumn === 'imported') {
                    valA = a.created_at || '';
                    valB = b.created_at || '';
                } else if (sortColumn === 'type') {
                    valA = a.type_name || '';
                    valB = b.type_name || '';
                }

                // Null handling
                if (valA == null) valA = '';
                if (valB == null) valB = '';

                // String comparison
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderInvoices(sorted);
        }

        // Sort Hidden table
        function sortHiddenTable(column) {
            if (hiddenSortColumn === column) {
                hiddenSortDirection = hiddenSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                hiddenSortColumn = column;
                hiddenSortDirection = 'asc';
            }
            localStorage.setItem('efacturaHiddenSortColumn', hiddenSortColumn);
            localStorage.setItem('efacturaHiddenSortDir', hiddenSortDirection);
            updateHiddenTableHeaders();
            sortAndRenderHidden();
        }

        function updateHiddenTableHeaders() {
            document.querySelectorAll('#hiddenTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortHiddenTable\('(\w+)'\)/)?.[1];
                if (col === hiddenSortColumn) {
                    th.classList.add(hiddenSortDirection);
                }
            });
        }

        function sortAndRenderHidden() {
            if (!hiddenCache || hiddenCache.length === 0) return;
            const sorted = [...hiddenCache].sort((a, b) => {
                let valA = a[hiddenSortColumn];
                let valB = b[hiddenSortColumn];
                if (hiddenSortColumn === 'total_amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                }
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return hiddenSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return hiddenSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderHiddenTable(sorted);
        }

        // Sort Bin table
        function sortBinTable(column) {
            if (binSortColumn === column) {
                binSortDirection = binSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                binSortColumn = column;
                binSortDirection = 'asc';
            }
            localStorage.setItem('efacturaBinSortColumn', binSortColumn);
            localStorage.setItem('efacturaBinSortDir', binSortDirection);
            updateBinTableHeaders();
            sortAndRenderBin();
        }

        function updateBinTableHeaders() {
            document.querySelectorAll('#binTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortBinTable\('(\w+)'\)/)?.[1];
                if (col === binSortColumn) {
                    th.classList.add(binSortDirection);
                }
            });
        }

        function sortAndRenderBin() {
            if (!binCache || binCache.length === 0) return;
            const sorted = [...binCache].sort((a, b) => {
                let valA = a[binSortColumn];
                let valB = b[binSortColumn];
                if (binSortColumn === 'total_amount') {
                    valA = parseFloat(a.total_amount || 0);
                    valB = parseFloat(b.total_amount || 0);
                }
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return binSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return binSortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            renderBinTable(sorted);
        }

        // Sort Mappings table
        function sortMappingsTable(column) {
            if (mappingsSortColumn === column) {
                mappingsSortDirection = mappingsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                mappingsSortColumn = column;
                mappingsSortDirection = 'asc';
            }
            localStorage.setItem('efacturaMappingsSortColumn', mappingsSortColumn);
            localStorage.setItem('efacturaMappingsSortDir', mappingsSortDirection);
            updateMappingsTableHeaders();
            sortAndRenderMappings();
        }

        function updateMappingsTableHeaders() {
            document.querySelectorAll('#mappingsTable th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortMappingsTable\('(\w+)'\)/)?.[1];
                if (col === mappingsSortColumn) {
                    th.classList.add(mappingsSortDirection);
                }
            });
        }

        function sortAndRenderMappings() {
            // Use filtered cache (can be empty if filters returned no results)
            const dataToSort = filteredMappingsCache !== undefined
                ? filteredMappingsCache
                : (mappingsCache || []);

            if (dataToSort.length === 0) {
                renderMappingsTable([]);
                updateMappingsPagination(0, 0, 0);
                document.getElementById('mappingsResultCount').textContent = '0 mappings';
                return;
            }

            const sorted = [...dataToSort].sort((a, b) => {
                let valA = a[mappingsSortColumn];
                let valB = b[mappingsSortColumn];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return mappingsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return mappingsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Apply pagination (0 = show all)
            const total = sorted.length;
            let paginated = sorted;
            if (mappingsPageSize > 0) {
                const start = (mappingsCurrentPage - 1) * mappingsPageSize;
                const end = start + mappingsPageSize;
                paginated = sorted.slice(start, end);
            }

            renderMappingsTable(paginated);
            updateMappingsPagination(total, mappingsCurrentPage, mappingsPageSize);

            // Update result count badge
            document.getElementById('mappingsResultCount').textContent = `${total} mappings`;
        }

        function updateMappingsPagination(total, currentPage, pageSize) {
            const footer = document.getElementById('mappingsPaginationFooter');
            const pagination = document.getElementById('mappingsPagination');
            const showingRange = document.getElementById('mappingsShowingRange');
            const totalCount = document.getElementById('mappingsTotalCount');

            if (total === 0 || pageSize === 0) {
                footer.style.display = 'none';
                return;
            }

            footer.style.display = 'flex';
            const totalPages = Math.ceil(total / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);

            showingRange.textContent = `${start}-${end}`;
            totalCount.textContent = total;

            // Build pagination buttons
            let html = '';
            html += `<li class="page-item ${currentPage <= 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToMappingsPage(${currentPage - 1}); return false;">&laquo;</a>
            </li>`;

            for (let i = 1; i <= totalPages && i <= 10; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToMappingsPage(${i}); return false;">${i}</a>
                </li>`;
            }

            html += `<li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToMappingsPage(${currentPage + 1}); return false;">&raquo;</a>
            </li>`;

            pagination.innerHTML = html;
        }

        function goToMappingsPage(page) {
            const total = filteredMappingsCache.length || mappingsCache.length;
            const totalPages = mappingsPageSize > 0 ? Math.ceil(total / mappingsPageSize) : 1;
            if (page < 1 || page > totalPages) return;
            mappingsCurrentPage = page;
            sortAndRenderMappings();
        }

        // Hide loading overlay
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadingOverlay').style.display = 'none';
            renderTableHeader();
            loadUnallocatedInvoices();
            loadBadgeCounts();
        });

        // Load badge counts
        async function loadBadgeCounts() {
            try {
                const [unalloc, hidden, bin] = await Promise.all([
                    fetch('/efactura/api/invoices/unallocated/count').then(r => r.json()),
                    fetch('/efactura/api/invoices/hidden/count').then(r => r.json()),
                    fetch('/efactura/api/invoices/bin/count').then(r => r.json())
                ]);

                updateBadge('unallocatedBadge', unalloc.count || 0);
                updateBadge('hiddenBadge', hidden.count || 0);
                updateBadge('binBadge', bin.count || 0);
            } catch (e) {
                console.error('Error loading badge counts:', e);
            }
        }

        function updateBadge(id, count) {
            const badge = document.getElementById(id);
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        // Invalidate caches when data changes (after hide/unhide/delete/restore)
        function invalidateCaches(which = 'all') {
            if (which === 'all' || which === 'unallocated') unallocatedLoaded = false;
            if (which === 'all' || which === 'hidden') hiddenLoaded = false;
            if (which === 'all' || which === 'bin') binLoaded = false;
            if (which === 'all' || which === 'mappings') mappingsLoaded = false;
        }

        // Load unallocated invoices
        async function loadUnallocatedInvoices(page = 1, forceReload = false) {
            // Skip if already loaded and not forcing reload (unless page changed)
            if (unallocatedLoaded && !forceReload && page === currentPage && invoicesCache.length > 0) {
                sortAndRenderInvoices();
                return;
            }

            const companyId = document.getElementById('companyFilter').value;
            const direction = document.getElementById('directionFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const search = document.getElementById('searchInput').value;

            let url = `/efactura/api/invoices/unallocated?page=${page}&limit=${pageSize}`;
            if (companyId) url += `&company_id=${companyId}`;
            if (direction) url += `&direction=${direction}`;
            if (startDate) url += `&start_date=${startDate}`;
            if (endDate) url += `&end_date=${endDate}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;
            if (sortColumn) url += `&sort_by=${sortColumn}&sort_dir=${sortDirection}`;

            const tbody = document.getElementById('invoicesTableBody');
            const colCount = getVisibleColumns().length;
            tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    if (data.companies && data.companies.length > 0) {
                        updateCompanyFilter(data.companies);
                    }

                    invoicesCache = data.data || [];
                    sortAndRenderInvoices();
                    updatePagination(data.pagination);
                    updateSummary(data.data, data.pagination);
                    unallocatedLoaded = true; // Mark as loaded

                    document.getElementById('unallocatedResultCount').textContent = `${data.pagination?.total || data.data?.length || 0} invoices`;
                } else {
                    tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error || 'Failed to load invoices'}
                    </td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-danger py-4">
                    <i class="bi bi-exclamation-triangle"></i> Error: ${err.message}
                </td></tr>`;
            }
        }

        // Change page size
        function changePageSize(newSize) {
            pageSize = parseInt(newSize);
            localStorage.setItem('efacturaPageSize', pageSize);
            currentPage = 1;
            loadUnallocatedInvoices(1);
        }

        // Load hidden invoices
        async function loadHiddenInvoices(page = 1, forceReload = false) {
            // Skip if already loaded and not forcing reload
            if (hiddenLoaded && !forceReload) {
                sortAndRenderHidden();
                return;
            }

            const tbody = document.getElementById('hiddenTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(`/efactura/api/invoices/hidden?page=${page}`);
                const data = await res.json();

                if (data.success) {
                    hiddenCache = data.data || [];
                    hiddenLoaded = true; // Mark as loaded
                    updateHiddenTableHeaders();
                    sortAndRenderHidden();
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function renderHiddenTable(invoices) {
            const tbody = document.getElementById('hiddenTableBody');
            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-check-circle text-success"></i> No hidden invoices
                </td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedHiddenInvoices.has(inv.id) ? 'checked' : '';

                return `<tr data-id="${inv.id}">
                    <td><input type="checkbox" class="form-check-input hidden-checkbox" value="${inv.id}" onchange="updateHiddenSelectionCount()" ${checked}></td>
                    <td><span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span></td>
                    <td><code>${inv.invoice_number || '-'}</code></td>
                    <td>${inv.partner_name || '-'}</td>
                    <td>${issueDate}</td>
                    <td class="text-end">${amount}</td>
                    <td>${inv.currency || 'RON'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="restoreFromHidden(${inv.id})" title="Restore">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteFromHidden(${inv.id})" title="Move to Bin">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');

            updateHiddenSelectionCount();
        }

        // Load bin invoices
        async function loadBinInvoices(page = 1, forceReload = false) {
            // Skip if already loaded and not forcing reload
            if (binLoaded && !forceReload) {
                sortAndRenderBin();
                return;
            }

            const tbody = document.getElementById('binTableBody');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch(`/efactura/api/invoices/bin?page=${page}`);
                const data = await res.json();

                if (data.success) {
                    binCache = data.data || [];
                    binLoaded = true; // Mark as loaded
                    updateBinTableHeaders();
                    sortAndRenderBin();
                } else {
                    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function renderBinTable(invoices) {
            const tbody = document.getElementById('binTableBody');
            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-check-circle text-success"></i> Bin is empty
                </td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const deletedAt = inv.deleted_at ? new Date(inv.deleted_at).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedBinInvoices.has(inv.id) ? 'checked' : '';

                return `<tr data-id="${inv.id}">
                    <td><input type="checkbox" class="form-check-input bin-checkbox" value="${inv.id}" onchange="updateBinSelectionCount()" ${checked}></td>
                    <td><span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span></td>
                    <td><code>${inv.invoice_number || '-'}</code></td>
                    <td>${inv.partner_name || '-'}</td>
                    <td>${issueDate}</td>
                    <td class="text-end">${amount}</td>
                    <td><span class="small text-muted">${deletedAt}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="restoreFromBin(${inv.id})" title="Restore">
                            <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="permanentDelete(${inv.id})" title="Permanently Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');

            updateBinSelectionCount();
        }

        // Sync Progress UI helpers
        function showSyncProgress(status, detail, progress = null, state = 'syncing') {
            const container = document.getElementById('syncProgressContainer');
            const statusText = document.getElementById('syncStatusText');
            const progressBar = document.getElementById('syncProgressBar');
            const progressDetail = document.getElementById('syncProgressDetail');

            container.style.display = 'flex';
            container.className = 'sync-progress-container' + (state !== 'syncing' ? ' ' + state : '');
            statusText.textContent = status;
            progressDetail.textContent = detail;

            if (progress !== null) {
                progressBar.classList.remove('indeterminate');
                progressBar.style.width = progress + '%';
            } else {
                progressBar.classList.add('indeterminate');
                progressBar.style.width = '30%';
            }
        }

        function hideSyncProgress(delay = 0) {
            setTimeout(() => {
                document.getElementById('syncProgressContainer').style.display = 'none';
            }, delay);
        }

        // Sync all invoices
        async function syncAll(days = 1) {
            const syncBtn = document.getElementById('syncBtn');
            const originalContent = syncBtn.innerHTML;

            syncBtn.disabled = true;
            syncBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
            showSyncProgress('Starting...', `Fetching last ${days} day(s)...`, 0, 'syncing');

            let totalImported = 0;
            let totalSkipped = 0;
            let allErrors = [];

            try {
                const companiesRes = await fetch('/efactura/api/sync/companies');
                const companiesData = await companiesRes.json();

                if (!companiesData.success || !companiesData.companies || companiesData.companies.length === 0) {
                    showSyncProgress('No companies', companiesData.error || 'No connected companies found', 100, 'error');
                    alert(companiesData.error || 'No connected companies found. Go to Connector Settings to add a connection.');
                    hideSyncProgress(3000);
                    return;
                }

                const companies = companiesData.companies;

                for (let i = 0; i < companies.length; i++) {
                    const company = companies[i];
                    const progress = Math.round(((i) / companies.length) * 100);

                    showSyncProgress(
                        `Syncing ${i + 1}/${companies.length}`,
                        `${company.display_name} (${company.cif})...`,
                        progress,
                        'syncing'
                    );

                    try {
                        const syncRes = await fetch('/efactura/api/sync/company', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ cif: company.cif, days: days })
                        });
                        const syncData = await syncRes.json();

                        if (syncData.success) {
                            totalImported += syncData.imported || 0;
                            totalSkipped += syncData.skipped || 0;
                            if (syncData.errors && syncData.errors.length > 0) {
                                allErrors.push(...syncData.errors.map(e => `${company.display_name}: ${e}`));
                            }
                        } else {
                            allErrors.push(`${company.display_name}: ${syncData.error || 'Unknown error'}`);
                        }
                    } catch (companyErr) {
                        allErrors.push(`${company.display_name}: ${companyErr.message}`);
                    }

                    showSyncProgress(
                        `Syncing ${i + 1}/${companies.length}`,
                        `${totalImported} imported, ${totalSkipped} skipped`,
                        Math.round(((i + 1) / companies.length) * 100),
                        'syncing'
                    );
                }

                const hasErrors = allErrors.length > 0;
                showSyncProgress(
                    hasErrors ? 'Completed with errors' : 'Sync Complete!',
                    `${totalImported} imported, ${totalSkipped} skipped` + (hasErrors ? `, ${allErrors.length} errors` : ''),
                    100,
                    hasErrors ? 'error' : 'completed'
                );

                if (totalImported > 0 || hasErrors) {
                    let msg = `Sync completed!\n\nImported: ${totalImported} invoice(s)\nSkipped: ${totalSkipped} (already imported)`;
                    if (hasErrors) {
                        msg += `\n\n ${allErrors.length} errors occurred:\n${allErrors.slice(0, 5).join('\n')}`;
                        if (allErrors.length > 5) msg += `\n... and ${allErrors.length - 5} more`;
                    }
                    alert(msg);
                }

                loadUnallocatedInvoices();
                loadBadgeCounts();
                hideSyncProgress(3000);

            } catch (err) {
                showSyncProgress('Sync Failed', err.message, 100, 'error');
                alert('Error: ' + err.message);
                hideSyncProgress(5000);
            } finally {
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalContent;
            }
        }

        function updateCompanyFilter(companies) {
            companiesCache = companies;
            const select = document.getElementById('companyFilter');
            const currentValue = select.value;
            select.innerHTML = '<option value="">All</option>';
            companies.forEach(c => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            select.value = currentValue;
        }

        function renderInvoices(invoices) {
            const tbody = document.getElementById('invoicesTableBody');
            const cols = getVisibleColumns();
            const colCount = cols.length;

            if (!invoices || invoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${colCount}" class="text-center text-muted py-4">
                    <i class="bi bi-check-circle text-success"></i> No unallocated invoices!
                    <br><small>All e-Factura invoices have been processed.</small>
                </td></tr>`;
                return;
            }

            tbody.innerHTML = invoices.map(inv => {
                const isReceived = inv.direction === 'received';
                const issueDate = inv.issue_date ? new Date(inv.issue_date).toLocaleDateString('ro-RO') : '-';
                const importedDate = inv.created_at ? new Date(inv.created_at).toLocaleDateString('ro-RO') : '-';
                const amount = parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const vat = parseFloat(inv.total_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2});
                const checked = selectedInvoices.has(inv.id) ? 'checked' : '';

                const cellMap = {
                    checkbox: `<input type="checkbox" class="form-check-input invoice-checkbox" value="${inv.id}" onchange="updateSelectionCount()" ${checked}>`,
                    company: `<span class="${inv.company_name ? '' : 'text-muted'}">${inv.company_name || '-'}</span>`,
                    direction: `<span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">
                        <i class="bi bi-arrow-${isReceived ? 'down' : 'up'}"></i>
                        ${isReceived ? 'Received' : 'Sent'}
                    </span>`,
                    invoice_number: `<code>${inv.invoice_number || '-'}</code>`,
                    partner_name: inv.partner_name || '-',
                    partner_cif: `<code class="text-muted">${inv.partner_cif || '-'}</code>`,
                    type: inv.type_name ? `<span class="badge bg-secondary">${inv.type_name}</span>` : '<span class="text-muted">-</span>',
                    issue_date: issueDate,
                    amount: amount,
                    vat: vat,
                    currency: inv.currency || 'RON',
                    imported: `<span class="small text-muted">${importedDate}</span>`,
                    actions: `<div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-success" onclick="sendSingleToInvoices(${inv.id})" title="Send to Invoices">
                            <i class="bi bi-send"></i>
                        </button>
                        <button class="btn btn-outline-primary" onclick="viewInvoice(${inv.id})" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="exportPdf(${inv.id})" title="Export PDF">
                            <i class="bi bi-file-pdf"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="hideInvoice(${inv.id})" title="Hide">
                            <i class="bi bi-eye-slash"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteInvoice(${inv.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>`
                };

                return `<tr data-id="${inv.id}">
                    ${cols.map(col => {
                        const align = col.align === 'end' ? 'text-end' : '';
                        return `<td class="${align}">${cellMap[col.id] || ''}</td>`;
                    }).join('')}
                </tr>`;
            }).join('');
        }

        // Selection management
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedInvoices.add(parseInt(cb.value));
                } else {
                    selectedInvoices.delete(parseInt(cb.value));
                }
            });
            updateSelectionCount();
        }

        function updateSelectionCount() {
            document.querySelectorAll('.invoice-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedInvoices.add(parseInt(cb.value));
                } else {
                    selectedInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedInvoices.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkActionBar').classList.toggle('show', count > 0);
        }

        function clearSelection() {
            selectedInvoices.clear();
            document.querySelectorAll('.invoice-checkbox, #selectAllCheckbox').forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        // Hidden selection management
        function toggleHiddenSelectAll() {
            const selectAll = document.getElementById('hiddenSelectAll').checked;
            document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedHiddenInvoices.add(parseInt(cb.value));
                } else {
                    selectedHiddenInvoices.delete(parseInt(cb.value));
                }
            });
            updateHiddenSelectionCount();
        }

        function updateHiddenSelectionCount() {
            document.querySelectorAll('.hidden-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedHiddenInvoices.add(parseInt(cb.value));
                } else {
                    selectedHiddenInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedHiddenInvoices.size;
            document.getElementById('hiddenRestoreBtn').disabled = count === 0;
            document.getElementById('hiddenDeleteBtn').disabled = count === 0;
        }

        // Bin selection management
        function toggleBinSelectAll() {
            const selectAll = document.getElementById('binSelectAll').checked;
            document.querySelectorAll('.bin-checkbox').forEach(cb => {
                cb.checked = selectAll;
                if (selectAll) {
                    selectedBinInvoices.add(parseInt(cb.value));
                } else {
                    selectedBinInvoices.delete(parseInt(cb.value));
                }
            });
            updateBinSelectionCount();
        }

        function updateBinSelectionCount() {
            document.querySelectorAll('.bin-checkbox').forEach(cb => {
                if (cb.checked) {
                    selectedBinInvoices.add(parseInt(cb.value));
                } else {
                    selectedBinInvoices.delete(parseInt(cb.value));
                }
            });

            const count = selectedBinInvoices.size;
            document.getElementById('binRestoreBtn').disabled = count === 0;
            document.getElementById('binPermanentDeleteBtn').disabled = count === 0;
        }

        // Single invoice actions
        async function sendSingleToInvoices(invoiceId) {
            if (!confirm('Send this invoice to the Invoices module for allocation?')) return;

            try {
                const res = await fetch('/efactura/api/invoices/send-to-module', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: [invoiceId] })
                });
                const data = await res.json();

                if (data.success) {
                    alert('Invoice sent to Invoices module successfully!');
                    loadUnallocatedInvoices(currentPage);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to send invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function hideInvoice(invoiceId) {
            if (!confirm('Hide this invoice? It will be moved to the Hidden tab.')) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/ignore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('hidden'); // Hide moves to hidden
                    removeRow(invoiceId);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to hide invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('Delete this invoice? It will be moved to the Bin.')) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('bin'); // Delete moves to bin
                    removeRow(invoiceId);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function restoreFromHidden(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/ignore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ restore: true })
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('unallocated'); // Restore moves to unallocated
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to restore invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteFromHidden(invoiceId) {
            if (!confirm('Move this invoice to the Bin?')) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('bin'); // Delete moves to bin
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function restoreFromBin(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/restore`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    invalidateCaches('unallocated'); // Restore moves to unallocated
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to restore invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function permanentDelete(invoiceId) {
            if (!confirm('PERMANENTLY delete this invoice? This cannot be undone!')) return;

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/permanent-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoice');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Bulk actions
        async function sendSelectedToInvoices() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Send ${ids.length} invoice(s) to the Invoices module?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/send-to-module', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.sent} invoice(s) sent successfully!`);
                    clearSelection();
                    loadUnallocatedInvoices(currentPage);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to send invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkHideSelected() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Hide ${ids.length} invoice(s)?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-hide', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.hidden} invoice(s) hidden`);
                    invalidateCaches('hidden');
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to hide invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkDeleteSelected() {
            const ids = Array.from(selectedInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Move ${ids.length} invoice(s) to the Bin?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.deleted} invoice(s) moved to bin`);
                    invalidateCaches('bin');
                    clearSelection();
                    loadUnallocatedInvoices(currentPage, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkRestoreFromHidden() {
            const ids = Array.from(selectedHiddenInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Restore ${ids.length} invoice(s) from hidden?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-restore-hidden', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.restored} invoice(s) restored`);
                    invalidateCaches('unallocated');
                    selectedHiddenInvoices.clear();
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to restore invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkDeleteFromHidden() {
            const ids = Array.from(selectedHiddenInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Move ${ids.length} invoice(s) to the Bin?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.deleted} invoice(s) moved to bin`);
                    invalidateCaches('bin');
                    selectedHiddenInvoices.clear();
                    loadHiddenInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkRestoreFromBin() {
            const ids = Array.from(selectedBinInvoices);
            if (ids.length === 0) return;

            if (!confirm(`Restore ${ids.length} invoice(s) from bin?`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-restore-bin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.restored} invoice(s) restored`);
                    invalidateCaches('unallocated');
                    selectedBinInvoices.clear();
                    loadBinInvoices(1, true);
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to restore invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function bulkPermanentDelete() {
            const ids = Array.from(selectedBinInvoices);
            if (ids.length === 0) return;

            if (!confirm(`PERMANENTLY delete ${ids.length} invoice(s)? This cannot be undone!`)) return;

            try {
                const res = await fetch('/efactura/api/invoices/bulk-permanent-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ invoice_ids: ids })
                });
                const data = await res.json();

                if (data.success) {
                    alert(`${data.deleted} invoice(s) permanently deleted`);
                    selectedBinInvoices.clear();
                    loadBinInvoices();
                    loadBadgeCounts();
                } else {
                    alert(data.error || 'Failed to delete invoices');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function removeRow(invoiceId) {
            const row = document.querySelector(`tr[data-id="${invoiceId}"]`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            selectedInvoices.delete(invoiceId);
        }

        function clearFilters() {
            document.getElementById('companyFilter').value = '';
            document.getElementById('directionFilter').value = 'received';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('searchInput').value = '';
            loadUnallocatedInvoices();
        }

        // Column Configuration
        function openColumnConfig() {
            const modal = new bootstrap.Modal(document.getElementById('columnConfigModal'));
            const list = document.getElementById('columnConfigList');
            const config = getColumnConfig();
            const configMap = {};
            config.forEach((c, i) => configMap[c.id] = { ...c, order: i });

            const configCols = allColumns
                .filter(col => !col.fixed)
                .map(col => ({
                    ...col,
                    visible: configMap[col.id]?.visible ?? col.visible,
                    order: configMap[col.id]?.order ?? allColumns.indexOf(col)
                }))
                .sort((a, b) => a.order - b.order);

            list.innerHTML = configCols.map(col => `
                <li class="list-group-item d-flex align-items-center" data-id="${col.id}">
                    <i class="bi bi-grip-vertical text-muted me-2"></i>
                    <input type="checkbox" class="form-check-input me-2" id="col_${col.id}" ${col.visible ? 'checked' : ''}>
                    <label class="form-check-label flex-grow-1" for="col_${col.id}">${col.label}</label>
                </li>
            `).join('');

            new Sortable(list, { animation: 150, handle: '.bi-grip-vertical' });
            modal.show();
        }

        function applyColumnConfig() {
            const list = document.getElementById('columnConfigList');
            const items = list.querySelectorAll('li');
            const config = [];

            allColumns.filter(c => c.fixed).forEach(c => {
                config.push({ id: c.id, visible: true });
            });

            items.forEach(item => {
                const id = item.dataset.id;
                const visible = item.querySelector('input[type="checkbox"]').checked;
                config.push({ id, visible });
            });

            saveColumnConfig(config);
            renderTableHeader();
            loadUnallocatedInvoices(currentPage);
        }

        function resetColumnConfig() {
            localStorage.removeItem('efacturaColumnConfig');
            bootstrap.Modal.getInstance(document.getElementById('columnConfigModal')).hide();
            renderTableHeader();
            loadUnallocatedInvoices(currentPage);
        }

        function updatePagination(pagination) {
            if (!pagination) return;

            currentPage = pagination.current_page || 1;
            totalPages = pagination.total_pages || 1;

            const info = document.getElementById('paginationInfo');
            const summary = document.getElementById('paginationSummary');
            const controls = document.getElementById('paginationControls');
            const pageSizeSelect = document.getElementById('pageSizeSelect');

            // Set page size selector value
            if (pageSizeSelect) {
                pageSizeSelect.value = pageSize;
            }

            if (pagination.total > 0) {
                info.style.display = 'flex';
                const start = pagination.offset + 1;
                const end = Math.min(pagination.offset + pagination.limit, pagination.total);
                summary.textContent = `Showing ${start}-${end} of ${pagination.total}`;

                if (totalPages > 1) {
                    controls.innerHTML = `
                        <button class="btn btn-outline-secondary" ${currentPage <= 1 ? 'disabled' : ''} onclick="loadUnallocatedInvoices(${currentPage - 1})">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <button class="btn btn-outline-secondary" disabled>Page ${currentPage} of ${totalPages}</button>
                        <button class="btn btn-outline-secondary" ${currentPage >= totalPages ? 'disabled' : ''} onclick="loadUnallocatedInvoices(${currentPage + 1})">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    `;
                } else {
                    controls.innerHTML = '';
                }
            } else {
                info.style.display = 'none';
            }
        }

        function updateSummary(invoices, pagination) {
            document.getElementById('unallocatedCount').textContent = pagination?.total || invoices?.length || 0;

            const totalValue = (invoices || []).reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
            document.getElementById('totalValueUnallocated').textContent = totalValue.toLocaleString('ro-RO', {minimumFractionDigits: 2}) + ' RON';
        }

        // View invoice details
        async function viewInvoice(invoiceId) {
            currentInvoiceId = invoiceId;
            const modal = new bootstrap.Modal(document.getElementById('viewInvoiceModal'));
            const content = document.getElementById('invoiceDetailsContent');
            content.innerHTML = '<div class="text-center py-4"><span class="spinner-border"></span></div>';
            modal.show();

            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}`);
                const data = await res.json();

                if (data.success) {
                    const inv = data.data;
                    const isReceived = inv.direction === 'received';
                    const seller = inv.seller || {};
                    const buyer = inv.buyer || {};

                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Invoice Information</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted">Invoice #</td><td><strong>${inv.invoice_number || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">Series</td><td>${inv.invoice_series || '-'}</td></tr>
                                    <tr><td class="text-muted">Issue Date</td><td>${inv.issue_date || '-'}</td></tr>
                                    <tr><td class="text-muted">Due Date</td><td>${inv.due_date || '-'}</td></tr>
                                    <tr><td class="text-muted">Direction</td><td><span class="badge ${isReceived ? 'bg-success' : 'bg-info'}">${isReceived ? 'Received' : 'Sent'}</span></td></tr>
                                </table>

                                <h6 class="mt-3">Amounts</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted">Net Amount</td><td class="text-end">${parseFloat(inv.total_without_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</td></tr>
                                    <tr><td class="text-muted">VAT</td><td class="text-end">${parseFloat(inv.total_vat || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</td></tr>
                                    <tr><td class="text-muted"><strong>Total</strong></td><td class="text-end"><strong>${parseFloat(inv.total_amount || 0).toLocaleString('ro-RO', {minimumFractionDigits: 2})} ${inv.currency}</strong></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="bi bi-building"></i> Seller (Supplier)</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted" style="width: 100px;">Name</td><td><strong>${seller.name || inv.partner_name || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">VAT</td><td><code class="text-danger">${seller.cif || inv.partner_cif || '-'}</code></td></tr>
                                    ${seller.address ? `<tr><td class="text-muted">Address</td><td class="small">${seller.address}</td></tr>` : ''}
                                </table>

                                <h6 class="mt-3"><i class="bi bi-person"></i> Buyer (Customer)</h6>
                                <table class="table table-sm">
                                    <tr><td class="text-muted" style="width: 100px;">Name</td><td><strong>${buyer.name || '-'}</strong></td></tr>
                                    <tr><td class="text-muted">VAT</td><td><code class="text-danger">${buyer.cif || '-'}</code></td></tr>
                                    ${buyer.address ? `<tr><td class="text-muted">Address</td><td class="small">${buyer.address}</td></tr>` : ''}
                                </table>
                            </div>
                        </div>
                    `;

                    document.getElementById('modalSendToInvoicesBtn').onclick = () => {
                        modal.hide();
                        sendSingleToInvoices(invoiceId);
                    };
                } else {
                    content.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to load invoice'}</div>`;
                }
            } catch (err) {
                content.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            }
        }

        // Export PDF
        async function exportPdf(invoiceId) {
            try {
                const res = await fetch(`/efactura/api/invoices/${invoiceId}/pdf`);

                if (!res.ok) {
                    const data = await res.json();
                    alert(data.error || 'Failed to export PDF');
                    return;
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${invoiceId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ============================================
        // Supplier Mappings
        // ============================================

        let mappingsCache = [];
        let filteredMappingsCache = []; // Filtered subset
        let mappingsPageSize = parseInt(localStorage.getItem('efacturaMappingsPageSize')) || 50;
        let mappingsCurrentPage = 1;

        // Filter mappings based on search and type filter
        function filterMappings() {
            const searchTerm = document.getElementById('mappingsSearchInput').value.toLowerCase().trim();
            const typeFilter = document.getElementById('mappingsTypeFilter').value;

            filteredMappingsCache = mappingsCache.filter(m => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    (m.partner_name && m.partner_name.toLowerCase().includes(searchTerm)) ||
                    (m.supplier_name && m.supplier_name.toLowerCase().includes(searchTerm)) ||
                    (m.partner_cif && m.partner_cif.toLowerCase().includes(searchTerm)) ||
                    (m.supplier_vat && m.supplier_vat.toLowerCase().includes(searchTerm)) ||
                    (m.kod_konto && m.kod_konto.toLowerCase().includes(searchTerm));

                // Type filter
                let matchesType = true;
                if (typeFilter === 'none') {
                    matchesType = !m.type_name;
                } else if (typeFilter) {
                    matchesType = m.type_name === typeFilter;
                }

                return matchesSearch && matchesType;
            });

            mappingsCurrentPage = 1;
            sortAndRenderMappings();
        }

        function changeMappingsPageSize(newSize) {
            mappingsPageSize = parseInt(newSize);
            localStorage.setItem('efacturaMappingsPageSize', mappingsPageSize);
            mappingsCurrentPage = 1;
            sortAndRenderMappings();
        }

        function clearMappingsFilters() {
            document.getElementById('mappingsSearchInput').value = '';
            document.getElementById('mappingsTypeFilter').value = '';
            filteredMappingsCache = [...mappingsCache];
            mappingsCurrentPage = 1;
            sortAndRenderMappings();
        }

        async function loadSupplierMappings(forceReload = false) {
            // Skip if already loaded and not forcing reload
            if (mappingsLoaded && !forceReload) {
                sortAndRenderMappings();
                return;
            }

            const tbody = document.getElementById('mappingsTableBody');
            tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch('/efactura/api/mappings');
                const data = await res.json();

                if (data.success) {
                    mappingsCache = data.mappings || [];
                    filteredMappingsCache = [...mappingsCache]; // Initialize filtered cache
                    mappingsLoaded = true; // Mark as loaded
                    updateMappingsTableHeaders();
                    sortAndRenderMappings();
                    updateBadge('mappingsBadge', data.count || 0);
                    // Restore page size from localStorage
                    document.getElementById('mappingsPageSize').value = mappingsPageSize || 50;
                } else {
                    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        // Bulk selection state for mappings
        let selectedMappings = new Set();

        function renderMappingsTable(mappings) {
            const tbody = document.getElementById('mappingsTableBody');
            const searchTerm = document.getElementById('mappingsSearchInput')?.value || '';
            const typeFilter = document.getElementById('mappingsTypeFilter')?.value || '';
            const hasFilters = searchTerm || typeFilter;

            if (!mappings || mappings.length === 0) {
                const message = hasFilters
                    ? '<i class="bi bi-search"></i> No mappings match your search criteria.'
                    : '<i class="bi bi-info-circle"></i> No supplier mappings yet. Click "Add Mapping" to create one.';
                tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted py-4">${message}</td></tr>`;
                document.getElementById('mappingsSelectAll').checked = false;
                selectedMappings.clear();
                updateMappingsSelectionCount();
                return;
            }

            tbody.innerHTML = mappings.map(m => {
                const createdDate = m.created_at ? new Date(m.created_at).toLocaleDateString('ro-RO') : '-';
                const isSelected = selectedMappings.has(m.id);
                const typeBadge = m.type_name
                    ? `<span class="badge ${m.type_name === 'Service' ? 'bg-info' : 'bg-warning'}">${m.type_name}</span>`
                    : '<span class="text-muted">-</span>';

                return `<tr data-id="${m.id}">
                    <td><input type="checkbox" class="form-check-input mapping-checkbox" value="${m.id}" ${isSelected ? 'checked' : ''} onchange="onMappingCheckboxChange(${m.id}, this.checked)"></td>
                    <td><strong>${m.partner_name || '-'}</strong></td>
                    <td><code class="text-muted">${m.partner_cif || '-'}</code></td>
                    <td>${m.supplier_name || '-'}</td>
                    <td><code class="text-success">${m.supplier_vat || '-'}</code></td>
                    <td>${typeBadge}</td>
                    <td><code class="text-primary">${m.kod_konto || '-'}</code></td>
                    <td><span class="text-muted small">${m.supplier_note || '-'}</span></td>
                    <td><span class="small text-muted">${createdDate}</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editMapping(${m.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteMapping(${m.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            // Update select all checkbox state
            const allChecked = mappings.length > 0 && mappings.every(m => selectedMappings.has(m.id));
            document.getElementById('mappingsSelectAll').checked = allChecked;
        }

        function onMappingCheckboxChange(id, checked) {
            if (checked) {
                selectedMappings.add(id);
            } else {
                selectedMappings.delete(id);
            }
            updateMappingsSelectionCount();

            // Update select all checkbox state
            const allChecked = mappingsCache.length > 0 && mappingsCache.every(m => selectedMappings.has(m.id));
            document.getElementById('mappingsSelectAll').checked = allChecked;
        }

        function toggleMappingsSelectAll() {
            const selectAll = document.getElementById('mappingsSelectAll').checked;
            selectedMappings.clear();
            if (selectAll) {
                mappingsCache.forEach(m => selectedMappings.add(m.id));
            }
            document.querySelectorAll('.mapping-checkbox').forEach(cb => cb.checked = selectAll);
            updateMappingsSelectionCount();
        }

        function updateMappingsSelectionCount() {
            const count = selectedMappings.size;
            document.getElementById('mappingsSelectedCount').textContent = count;
            const bulkBar = document.getElementById('mappingsBulkActionBar');
            if (count > 0) {
                bulkBar.classList.add('show');
            } else {
                bulkBar.classList.remove('show');
            }
        }

        function clearMappingsSelection() {
            selectedMappings.clear();
            document.querySelectorAll('.mapping-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('mappingsSelectAll').checked = false;
            updateMappingsSelectionCount();
        }

        async function bulkDeleteMappings() {
            const ids = Array.from(selectedMappings);
            if (ids.length === 0) {
                alert('No mappings selected');
                return;
            }

            if (!confirm(`Delete ${ids.length} selected mapping(s)? This cannot be undone.`)) {
                return;
            }

            try {
                const res = await fetch('/efactura/api/mappings/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                const data = await res.json();

                if (data.success) {
                    selectedMappings.clear();
                    updateMappingsSelectionCount();
                    loadSupplierMappings();
                } else {
                    alert(data.error || 'Failed to delete mappings');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Partner types cache
        let partnerTypesCache = [];

        async function loadPartnerTypesForDropdown() {
            try {
                const res = await fetch('/efactura/api/partner-types');
                const data = await res.json();
                if (data.success) {
                    partnerTypesCache = data.types || [];
                    populateTypeDropdown();
                }
            } catch (err) {
                console.error('Failed to load partner types:', err);
            }
        }

        function populateTypeDropdown() {
            const select = document.getElementById('mappingTypeId');
            const currentValue = select.value;
            select.innerHTML = '<option value="">-- Select Type --</option>' +
                partnerTypesCache.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            if (currentValue) {
                select.value = currentValue;
            }
        }

        async function openAddMappingModal() {
            document.getElementById('mappingId').value = '';
            document.getElementById('mappingPartnerName').value = '';
            document.getElementById('mappingPartnerCif').value = '';
            document.getElementById('mappingSupplierName').value = '';
            document.getElementById('mappingSupplierVat').value = '';
            document.getElementById('mappingTypeId').value = '';
            document.getElementById('mappingKodKonto').value = '';
            document.getElementById('mappingSupplierNote').value = '';
            document.getElementById('mappingModalTitle').innerHTML = '<i class="bi bi-diagram-3"></i> Add Supplier Mapping';

            // Load partner types for dropdown
            await loadPartnerTypesForDropdown();

            const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
            modal.show();
        }

        async function editMapping(mappingId) {
            const mapping = mappingsCache.find(m => m.id === mappingId);
            if (!mapping) {
                alert('Mapping not found');
                return;
            }

            document.getElementById('mappingId').value = mapping.id;
            document.getElementById('mappingPartnerName').value = mapping.partner_name || '';
            document.getElementById('mappingPartnerCif').value = mapping.partner_cif || '';
            document.getElementById('mappingSupplierName').value = mapping.supplier_name || '';
            document.getElementById('mappingSupplierVat').value = mapping.supplier_vat || '';
            document.getElementById('mappingKodKonto').value = mapping.kod_konto || '';
            document.getElementById('mappingSupplierNote').value = mapping.supplier_note || '';
            document.getElementById('mappingModalTitle').innerHTML = '<i class="bi bi-diagram-3"></i> Edit Supplier Mapping';

            // Load partner types and set the current value
            await loadPartnerTypesForDropdown();
            document.getElementById('mappingTypeId').value = mapping.type_id || '';

            const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
            modal.show();
        }

        async function saveMapping() {
            const mappingId = document.getElementById('mappingId').value;
            const partnerName = document.getElementById('mappingPartnerName').value.trim();
            const partnerCif = document.getElementById('mappingPartnerCif').value.trim();
            const supplierName = document.getElementById('mappingSupplierName').value.trim();
            const supplierVat = document.getElementById('mappingSupplierVat').value.trim();
            const typeId = document.getElementById('mappingTypeId').value;
            const kodKonto = document.getElementById('mappingKodKonto').value.trim();
            const supplierNote = document.getElementById('mappingSupplierNote').value.trim();

            if (!partnerName) {
                alert('Partner Name is required');
                return;
            }

            if (!supplierName) {
                alert('Supplier Name is required');
                return;
            }

            const payload = {
                partner_name: partnerName,
                partner_cif: partnerCif,
                supplier_name: supplierName,
                supplier_vat: supplierVat,
                type_id: typeId || null,
                kod_konto: kodKonto,
                supplier_note: supplierNote,
            };

            try {
                let res;
                if (mappingId) {
                    // Update existing
                    res = await fetch(`/efactura/api/mappings/${mappingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new
                    res = await fetch('/efactura/api/mappings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const data = await res.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('mappingModal')).hide();
                    loadSupplierMappings();
                } else {
                    alert(data.error || 'Failed to save mapping');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteMapping(mappingId) {
            if (!confirm('Delete this supplier mapping?')) return;

            try {
                const res = await fetch(`/efactura/api/mappings/${mappingId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    loadSupplierMappings();
                } else {
                    alert(data.error || 'Failed to delete mapping');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function importSuppliersFromInvoices() {
            try {
                // Fetch distinct partners from invoices
                const res = await fetch('/efactura/api/partners/distinct');
                const data = await res.json();

                if (!data.success) {
                    alert(data.error || 'Failed to load partners');
                    return;
                }

                if (!data.partners || data.partners.length === 0) {
                    alert('No partners found in imported invoices.');
                    return;
                }

                // Get existing mappings to filter out already mapped partners
                const existingPartners = new Set(mappingsCache.map(m => m.partner_name?.toLowerCase()));
                const unmappedPartners = data.partners.filter(p =>
                    !existingPartners.has(p.partner_name?.toLowerCase())
                );

                if (unmappedPartners.length === 0) {
                    alert('All partners from invoices already have mappings.');
                    return;
                }

                // Show import modal with list of unmapped partners
                showImportPartnersModal(unmappedPartners);

            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function showImportPartnersModal(partners) {
            // Create modal dynamically if it doesn't exist
            let modal = document.getElementById('importPartnersModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'importPartnersModal';
                modal.className = 'modal fade';
                modal.tabIndex = -1;
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="bi bi-box-arrow-in-down"></i> Import Suppliers from Invoices</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted small mb-3">Select partners to create mappings. Supplier Name will default to Partner Name.</p>
                                <div class="mb-2">
                                    <input type="checkbox" class="form-check-input me-2" id="importSelectAll" onchange="toggleImportSelectAll()">
                                    <label class="form-check-label small" for="importSelectAll">Select All</label>
                                </div>
                                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                    <table class="table table-hover table-sm" id="importPartnersTable">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th width="30"></th>
                                                <th>Partner Name</th>
                                                <th>Partner VAT</th>
                                                <th>Invoice Count</th>
                                            </tr>
                                        </thead>
                                        <tbody id="importPartnersTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <span id="importSelectedCount" class="me-auto text-muted small">0 selected</span>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="importSelectedPartners()">
                                    <i class="bi bi-check-lg"></i> Create Mappings
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Populate table
            const tbody = document.getElementById('importPartnersTableBody');
            tbody.innerHTML = partners.map((p, idx) => `
                <tr>
                    <td><input type="checkbox" class="form-check-input import-partner-checkbox" value="${idx}" data-name="${escapeHtml(p.partner_name)}" data-cif="${escapeHtml(p.partner_cif || '')}" onchange="updateImportSelectedCount()"></td>
                    <td>${escapeHtml(p.partner_name) || '-'}</td>
                    <td><code class="text-muted">${escapeHtml(p.partner_cif) || '-'}</code></td>
                    <td><span class="badge bg-secondary">${p.invoice_count}</span></td>
                </tr>
            `).join('');

            // Reset select all and count
            document.getElementById('importSelectAll').checked = false;
            updateImportSelectedCount();

            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleImportSelectAll() {
            const selectAll = document.getElementById('importSelectAll').checked;
            document.querySelectorAll('.import-partner-checkbox').forEach(cb => cb.checked = selectAll);
            updateImportSelectedCount();
        }

        function updateImportSelectedCount() {
            const count = document.querySelectorAll('.import-partner-checkbox:checked').length;
            document.getElementById('importSelectedCount').textContent = `${count} selected`;
        }

        async function importSelectedPartners() {
            const checkboxes = document.querySelectorAll('.import-partner-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Please select at least one partner to import.');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Creating...';

            let created = 0;
            let errors = [];

            for (const cb of checkboxes) {
                const partnerName = cb.dataset.name;
                const partnerCif = cb.dataset.cif;

                try {
                    const res = await fetch('/efactura/api/mappings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            partner_name: partnerName,
                            partner_cif: partnerCif,
                            supplier_name: partnerName, // Default to same name
                            supplier_vat: partnerCif,   // Default to same VAT
                        })
                    });
                    const data = await res.json();

                    if (data.success) {
                        created++;
                    } else {
                        errors.push(`${partnerName}: ${data.error}`);
                    }
                } catch (err) {
                    errors.push(`${partnerName}: ${err.message}`);
                }
            }

            btn.disabled = false;
            btn.innerHTML = originalText;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('importPartnersModal')).hide();

            // Show result
            let msg = `Created ${created} mapping(s).`;
            if (errors.length > 0) {
                msg += `\n\n${errors.length} error(s):\n${errors.slice(0, 5).join('\n')}`;
                if (errors.length > 5) msg += `\n... and ${errors.length - 5} more`;
            }
            alert(msg);

            // Reload mappings
            loadSupplierMappings();
        }

        // ============================================
        // Partner Types Management
        // ============================================

        async function openPartnerTypesModal() {
            const modal = new bootstrap.Modal(document.getElementById('partnerTypesModal'));
            modal.show();
            await loadPartnerTypesTable();
        }

        async function loadPartnerTypesTable() {
            const tbody = document.getElementById('partnerTypesTableBody');
            tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">
                <span class="spinner-border spinner-border-sm"></span> Loading...
            </td></tr>`;

            try {
                const res = await fetch('/efactura/api/partner-types?active_only=false');
                const data = await res.json();

                if (data.success) {
                    renderPartnerTypesTable(data.types || []);
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">${data.error}</td></tr>`;
                }
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">Error: ${err.message}</td></tr>`;
            }
        }

        function renderPartnerTypesTable(types) {
            const tbody = document.getElementById('partnerTypesTableBody');

            if (!types || types.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-info-circle"></i> No partner types yet. Add one above.
                </td></tr>`;
                return;
            }

            tbody.innerHTML = types.map(t => {
                const statusBadge = t.is_active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Inactive</span>';

                return `<tr data-id="${t.id}">
                    <td><strong>${t.name || '-'}</strong></td>
                    <td class="text-muted small">${t.description || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger" onclick="deletePartnerType(${t.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        async function addPartnerType() {
            const name = document.getElementById('newTypeName').value.trim();
            const description = document.getElementById('newTypeDescription').value.trim();

            if (!name) {
                alert('Name is required');
                return;
            }

            try {
                const res = await fetch('/efactura/api/partner-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('newTypeName').value = '';
                    document.getElementById('newTypeDescription').value = '';
                    loadPartnerTypesTable();
                    // Update cache for dropdown
                    loadPartnerTypesForDropdown();
                } else {
                    alert(data.error || 'Failed to create partner type');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deletePartnerType(typeId) {
            if (!confirm('Delete this partner type? It will be soft-deleted (deactivated).')) return;

            try {
                const res = await fetch(`/efactura/api/partner-types/${typeId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.success) {
                    loadPartnerTypesTable();
                    // Update cache for dropdown
                    loadPartnerTypesForDropdown();
                } else {
                    alert(data.error || 'Failed to delete partner type');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
</body>
</html>
