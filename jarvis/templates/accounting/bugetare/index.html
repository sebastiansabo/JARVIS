<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Add Invoice</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'accounting' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item active">Add Invoice</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        {% set active_page = 'invoices' %}
        {% set inline_nav = true %}
        {% include 'partials/_accounting_nav.html' %}

        <!-- Page Tabs -->
        <ul class="nav nav-tabs mt-3 mb-3">
            <li class="nav-item">
                <a class="nav-link active" href="/add-invoice">
                    <i class="bi bi-plus-circle"></i> Add Invoice
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/bulk">
                    <i class="bi bi-stack"></i> Bulk
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/templates">
                    <i class="bi bi-file-earmark-text"></i> Templates
                </a>
            </li>
        </ul>

        <div class="row">
            <!-- Left Column: Invoice Input -->
            <div class="col-lg-5 col-xl-4">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-upload"></i> Invoice Input</h5>
                    </div>
                    <div class="card-body">
                        <!-- File Upload -->
                        <div class="drag-drop-zone mb-3" id="dropZone">
                            <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                            <p class="mb-0 mt-2">Drag & drop invoice here or click to upload</p>
                            <small class="text-muted">Supports PDF, JPG, PNG</small>
                            <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
                        </div>

                        <!-- Attachments Upload -->
                        <div class="mb-3">
                            <label class="form-label small">
                                <i class="bi bi-paperclip"></i> Attachments (optional)
                            </label>
                            <div class="attachments-zone p-2 border rounded bg-light" id="attachmentsZone">
                                <div class="d-flex align-items-center justify-content-between">
                                    <small class="text-muted">
                                        <i class="bi bi-plus-circle"></i> Add files to upload with invoice
                                    </small>
                                    <input type="file" id="attachmentsInput" class="d-none" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx,.txt">
                                </div>
                                <div id="attachmentsList" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Template Selector -->
                        <div class="mb-3">
                            <label class="form-label small">Parse Method</label>
                            <select class="form-select form-select-sm" id="templateSelect">
                                <option value="">Auto-detect (AI fallback)</option>
                            </select>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-8">
                                <button class="btn btn-primary w-100" id="parseBtn">
                                    <span class="parsing-spinner spinner-border spinner-border-sm me-2"></span>
                                    <i class="bi bi-magic" id="parseBtnIcon"></i> <span id="parseBtnText">Citeste Factura</span>
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-secondary w-100" id="manualEntryBtn" title="Skip AI parsing and enter manually">
                                    <i class="bi bi-pencil"></i> Manual
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info small py-2 mb-3" id="entryModeAlert" style="display: none;">
                            <i class="bi bi-info-circle"></i> <span id="entryModeText"></span>
                        </div>

                        <!-- Invoice Details Form -->
                        <form id="invoiceForm">
                            <div class="mb-3">
                                <label class="form-label">Supplier *</label>
                                <input type="text" class="form-control" id="supplier" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Customer VAT</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="customerVat" placeholder="Auto-detected or enter manually">
                                        <button class="btn btn-outline-secondary" type="button" id="matchVatBtn" title="Match VAT to company">
                                            <i class="bi bi-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Matched Company</label>
                                    <input type="text" class="form-control" id="matchedCompany" placeholder="Company matched by VAT" readonly>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Invoice Number *</label>
                                    <input type="text" class="form-control" id="invoiceNumber" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Invoice Date *</label>
                                    <input type="date" class="form-control" id="invoiceDate" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Invoice Value *</label>
                                    <input type="number" step="0.01" class="form-control" id="invoiceValue" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Currency</label>
                                    <select class="form-select" id="currency">
                                        <option value="RON">RON</option>
                                        <option value="EUR">EUR</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                            <!-- VAT Subtraction -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="subtractVat">
                                        <label class="form-check-label" for="subtractVat">
                                            <i class="bi bi-percent"></i> Subtract VAT
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4" id="vatRateCol" style="display: none;">
                                    <label class="form-label small">VAT Rate</label>
                                    <select class="form-select form-select-sm" id="vatRateSelect">
                                        <option value="">Select VAT rate...</option>
                                    </select>
                                </div>
                                <div class="col-md-4" id="netValueCol" style="display: none;">
                                    <label class="form-label small">Net Value (without VAT)</label>
                                    <input type="text" class="form-control form-control-sm" id="netValueDisplay" readonly>
                                </div>
                            </div>
                            <input type="hidden" id="netValue">
                            <input type="hidden" id="vatRateId">

                            <!-- Currency Conversion Display -->
                            <div class="row mb-3" id="conversionDisplay" style="display: none;">
                                <div class="col-12">
                                    <div class="alert alert-light py-2 mb-0 d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="bi bi-currency-exchange text-primary"></i>
                                            <span class="ms-2">
                                                <strong id="displayValueRon">0.00</strong> RON =
                                                <strong id="displayValueEur">0.00</strong> EUR
                                            </span>
                                        </div>
                                        <small class="text-muted" id="exchangeRateInfo">
                                            Rate: <span id="displayExchangeRate">0.0000</span> EUR/RON
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" id="invoiceNotes" rows="2" placeholder="Optional notes about this invoice"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Payment Status</label>
                                <select class="form-select" id="paymentStatus">
                                    <option value="not_paid">Not Paid</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>

                            <!-- Bank Transaction Link (optional) -->
                            <div class="mb-3" id="bankTransactionSection">
                                <label class="form-label">
                                    <i class="bi bi-link-45deg"></i> Link to Bank Transaction
                                    <span class="badge bg-secondary ms-1">Optional</span>
                                </label>
                                <select class="form-select form-select-sm" id="bankTransactionSelect">
                                    <option value="">-- No transaction link --</option>
                                </select>
                                <small class="text-muted">Link this invoice to a pending bank statement transaction</small>
                            </div>
                            <input type="hidden" id="bankTransactionId">
                            <input type="hidden" id="driveLink">
                            <input type="hidden" id="valueRon">
                            <input type="hidden" id="valueEur">
                            <input type="hidden" id="exchangeRate">
                        </form>
                    </div>
                </div>
            </div>

            <!-- Right Column: Cost Distribution -->
            <div class="col-lg-7 col-xl-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Cost Distribution</h5>
                        <button class="btn btn-sm btn-outline-primary" id="addAllocationBtn">
                            <i class="bi bi-plus"></i> Add Department
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Dedicated To (Company) *</label>
                                <select class="form-select" id="dedicatedCompany" required>
                                    <option value="">Select company...</option>
                                </select>
                            </div>
                            </div>
                        <hr>
                        <div id="allocationsContainer">
                            <!-- Allocation rows will be added here -->
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3 p-3 bg-light rounded">
                            <span>Total Allocation:</span>
                            <span class="total-allocation" id="totalAllocation">0%</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-lg" id="clearFormBtn">
                        <i class="bi bi-x-circle"></i> Clear Form
                    </button>
                    <button class="btn btn-success btn-lg flex-grow-1" id="submitBtn">
                        <i class="bi bi-check-circle"></i> Save Distribution
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Allocation Row Template -->
    <template id="allocationTemplate">
        <div class="allocation-row">
            <div class="row align-items-end">
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Brand</label>
                    <select class="form-select form-select-sm brand-select">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Department</label>
                    <select class="form-select form-select-sm department-select" required>
                        <option value="">Select...</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Subdepartment</label>
                    <select class="form-select form-select-sm subdepartment-select">
                        <option value="">N/A</option>
                    </select>
                </div>
                <div class="col-4 col-md-2 mb-2">
                    <label class="form-label small">Allocation %</label>
                    <input type="number" class="form-control form-control-sm allocation-input" min="0" max="100" step="0.01" value="100" required>
                </div>
                <div class="col-6 col-md-2 mb-2">
                    <label class="form-label small">Value (<span class="currency-label">RON</span>)</label>
                    <input type="number" class="form-control form-control-sm allocation-value-input" min="0" step="0.01" value="0">
                </div>
                <div class="col-2 col-md-2 mb-2 d-flex gap-1 align-items-end justify-content-end">
                    <button type="button" class="btn btn-outline-info btn-sm comment-allocation" title="Add comment">
                        <i class="bi bi-chat-text"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm lock-allocation" title="Lock this allocation">
                        <i class="bi bi-unlock"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-allocation">
                        <i class="bi bi-trash"></i>
                    </button>
                    <input type="hidden" class="allocation-comment" value="">
                </div>
            </div>
            <div class="row mt-1 align-items-center">
                <div class="col-md-6">
                    <small class="text-muted manager-display">Manager: --</small>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input reinvoice-check" type="checkbox" id="reinvoice">
                        <label class="form-check-label small" for="reinvoice">Reinvoice to:</label>
                        <span class="reinvoice-total-badge badge bg-secondary ms-2" style="display: none;">0%</span>
                    </div>
                </div>
            </div>
            <div class="reinvoice-section" style="display: none;">
                <div class="reinvoice-lines-container"></div>
                <div class="row mt-1">
                    <div class="col-12">
                        <button type="button" class="btn btn-outline-secondary btn-sm add-reinvoice-line-btn">
                            <i class="bi bi-plus"></i> Add Reinvoice Line
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Loading overlay helpers
        let loadingCount = 0;
        function showLoading(message = 'Loading...') {
            loadingCount++;
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.loading-text');
            text.textContent = message;
            overlay.classList.add('show');
        }
        function hideLoading() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        function setLoadingText(message) {
            document.querySelector('#loadingOverlay .loading-text').textContent = message;
        }

        // Retry fetch for cold start resilience
        async function fetchWithRetry(url, options = {}, retries = 2, delay = 1500) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const res = await fetch(url, options);
                    return res;
                } catch (e) {
                    if (i === retries) throw e;
                    console.log(`Fetch failed, retrying in ${delay}ms... (attempt ${i + 1}/${retries})`);
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 1.5; // Exponential backoff
                }
            }
        }

        let companies = [];
        let structure = [];
        let companiesWithVat = []; // Companies with VAT from Comp sheet
        let invoiceTemplates = []; // Invoice parsing templates
        let vatRates = []; // VAT rates from settings
        let uploadedFile = null; // Store uploaded file reference
        let attachmentFiles = []; // Store attachment files

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup event listeners FIRST (before async calls that might fail)
            setupEventListeners();
            addAllocationRow();

            showLoading('Loading data...');
            try {
                await loadStructure();
                await loadCompaniesWithVat();
                await loadInvoiceTemplates();
                await loadVatRates();
                await loadPendingBankTransactions();

                // Check for bulk transfer data from Bulk Processor
                await checkBulkTransferData();
            } catch (e) {
                console.error('Error loading page data:', e);
            } finally {
                hideLoading();
            }
        });

        // Handle bulk transfer data from Bulk Processor page
        async function checkBulkTransferData() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('fromBulk') !== '1') return;

            const transferDataStr = sessionStorage.getItem('bulkTransferData');
            if (!transferDataStr) return;

            try {
                const data = JSON.parse(transferDataStr);
                // Clear the data to prevent re-loading on refresh
                sessionStorage.removeItem('bulkTransferData');

                // Show notification
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-info alert-dismissible fade show mb-3';
                alertDiv.innerHTML = `
                    <i class="bi bi-info-circle"></i>
                    <strong>Bulk Transfer:</strong> Invoice data loaded from Bulk Processor.
                    ${data.campaigns?.length ? `<br><small>${data.campaigns.length} campaign(s) available for allocation.</small>` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);

                // Populate invoice header fields
                if (data.supplier) {
                    document.getElementById('supplier').value = data.supplier;
                }
                if (data.invoice_number) {
                    document.getElementById('invoiceNumber').value = data.invoice_number;
                }
                if (data.invoice_date) {
                    // Convert date to YYYY-MM-DD format if needed
                    let dateValue = data.invoice_date;
                    if (dateValue && !dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        // Try to parse various date formats
                        const parsed = new Date(dateValue);
                        if (!isNaN(parsed)) {
                            dateValue = parsed.toISOString().split('T')[0];
                        }
                    }
                    document.getElementById('invoiceDate').value = dateValue;
                }
                if (data.invoice_value) {
                    document.getElementById('invoiceValue').value = data.invoice_value;
                }
                if (data.currency) {
                    document.getElementById('currency').value = data.currency;
                    // Update currency label
                    const currencyLabel = document.querySelector('label[for="invoiceValue"]');
                    if (currencyLabel) {
                        currencyLabel.textContent = `Value (${data.currency})`;
                    }
                }

                // Set dedicated company if provided directly from bulk transfer
                const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                if (data.dedicated_company) {
                    dedicatedCompanySelect.value = data.dedicated_company;
                    // Trigger change to load departments for this company
                    dedicatedCompanySelect.dispatchEvent(new Event('change'));
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                // Otherwise try to match customer VAT to company
                else if (data.customer_vat) {
                    document.getElementById('matchedCompany').value = data.customer_vat;
                    // Try to find matching company
                    const matchedCompany = companiesWithVat.find(c =>
                        c.vat && c.vat.replace(/\s/g, '') === data.customer_vat.replace(/\s/g, '')
                    );
                    if (matchedCompany) {
                        dedicatedCompanySelect.value = matchedCompany.name;
                        // Trigger change to load departments for this company
                        dedicatedCompanySelect.dispatchEvent(new Event('change'));
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                // Handle campaign allocations if provided
                if (data.campaigns && data.campaigns.length > 0) {
                    await populateCampaignAllocations(data);
                }

                // Handle file data - load into uploader
                if (data.file_data && data.file_name) {
                    try {
                        // Convert base64 data URL to File object
                        const fileBlob = await (await fetch(data.file_data)).blob();
                        uploadedFile = new File([fileBlob], data.file_name, { type: 'application/pdf' });
                        updateDropZoneText(data.file_name);
                    } catch (fileError) {
                        console.warn('Could not load file from bulk transfer:', fileError);
                    }
                }

            } catch (e) {
                console.error('Error loading bulk transfer data:', e);
            }
        }

        async function populateCampaignAllocations(data) {
            const container = document.getElementById('allocationsContainer');
            const invoiceValue = data.invoice_value || 0;

            // Clear existing allocation rows
            container.innerHTML = '';

            // Filter campaigns with full allocations
            const campaignsWithAlloc = data.campaigns.filter(c => c.company && c.department);
            const campaignsWithoutAlloc = data.campaigns.filter(c => !c.company || !c.department);

            if (campaignsWithAlloc.length > 0) {
                // Create allocation row for each campaign with allocation
                for (const campaign of campaignsWithAlloc) {
                    await addAllocationRow();
                    const rows = container.querySelectorAll('.allocation-row');
                    const row = rows[rows.length - 1];

                    // Set company (only on first campaign)
                    const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                    if (!dedicatedCompanySelect.value && campaign.company) {
                        dedicatedCompanySelect.value = campaign.company;
                        // Trigger change to load departments/brands for this company
                        dedicatedCompanySelect.dispatchEvent(new Event('change'));
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }

                    // Wait for dropdowns to populate
                    await new Promise(resolve => setTimeout(resolve, 100));

                    // Set brand if provided
                    const brandSelect = row.querySelector('.brand-select');
                    if (brandSelect && campaign.brand) {
                        brandSelect.value = campaign.brand;
                    }

                    // Set department
                    const deptSelect = row.querySelector('.department-select');
                    if (deptSelect && campaign.department) {
                        deptSelect.value = campaign.department;
                        // Trigger change to load subdepartments and manager
                        deptSelect.dispatchEvent(new Event('change'));
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Set subdepartment if provided
                    const subdeptSelect = row.querySelector('.subdepartment-select');
                    if (subdeptSelect && campaign.subdepartment) {
                        subdeptSelect.value = campaign.subdepartment;
                    }

                    // Set allocation percentage (use transfer value if provided)
                    const allocInput = row.querySelector('.allocation-input');
                    if (allocInput) {
                        const allocPercent = campaign.allocation_percent || ((campaign.allocation_value || campaign.original_value || 0) / invoiceValue * 100);
                        allocInput.value = allocPercent.toFixed(2);
                    }

                    // Set allocation value
                    const allocValueInput = row.querySelector('.allocation-value-input');
                    if (allocValueInput) {
                        const allocValue = campaign.allocation_value || campaign.original_value || 0;
                        allocValueInput.value = allocValue.toFixed(2);
                    }

                    // Add comment with campaign name
                    const commentInput = row.querySelector('.allocation-comment');
                    if (commentInput) {
                        commentInput.value = campaign.name;
                    }

                    // Handle reinvoice if configured
                    if (campaign.reinvoice && campaign.reinvoice_company) {
                        const reinvoiceCheck = row.querySelector('.reinvoice-check');
                        if (reinvoiceCheck) {
                            reinvoiceCheck.checked = true;
                            reinvoiceCheck.dispatchEvent(new Event('change'));
                            await new Promise(resolve => setTimeout(resolve, 100));

                            // Set reinvoice company and department
                            const reinvoiceCompanySelect = row.querySelector('.reinvoice-company-select');
                            if (reinvoiceCompanySelect && campaign.reinvoice_company) {
                                reinvoiceCompanySelect.value = campaign.reinvoice_company;
                                reinvoiceCompanySelect.dispatchEvent(new Event('change'));
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }

                            const reinvoiceDeptSelect = row.querySelector('.reinvoice-dept-select');
                            if (reinvoiceDeptSelect && campaign.reinvoice_department) {
                                reinvoiceDeptSelect.value = campaign.reinvoice_department;
                            }
                        }
                    }
                }

                // If there are campaigns without allocation, add them as one row
                if (campaignsWithoutAlloc.length > 0) {
                    const unallocValue = campaignsWithoutAlloc.reduce((sum, c) => sum + (c.original_value || c.allocation_value || 0), 0);
                    if (unallocValue > 0) {
                        await addAllocationRow();
                        const rows = container.querySelectorAll('.allocation-row');
                        const row = rows[rows.length - 1];

                        const allocPercent = (unallocValue / invoiceValue) * 100;
                        const allocInput = row.querySelector('.allocation-input');
                        if (allocInput) {
                            allocInput.value = allocPercent.toFixed(2);
                        }

                        const allocValueInput = row.querySelector('.allocation-value-input');
                        if (allocValueInput) {
                            allocValueInput.value = unallocValue.toFixed(2);
                        }

                        // Add comment listing unallocated campaigns
                        const commentInput = row.querySelector('.allocation-comment');
                        if (commentInput) {
                            commentInput.value = campaignsWithoutAlloc.map(c => c.name).join(', ');
                        }
                    }
                }
            } else {
                // No pre-configured allocations, just add one row
                await addAllocationRow();
            }

            // Recalculate totals
            updateAllocationValues();
        }

        async function loadStructure() {
            const [companiesRes, structureRes] = await Promise.all([
                fetch('/api/companies'),
                fetch('/api/structure')
            ]);
            companies = await companiesRes.json();
            structure = await structureRes.json();

            // Populate dedicated company dropdown
            const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
            companies.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                dedicatedCompanySelect.appendChild(opt);
            });
        }

        async function loadCompaniesWithVat() {
            const res = await fetch('/api/companies-vat');
            companiesWithVat = await res.json();
        }

        async function loadInvoiceTemplates() {
            try {
                const res = await fetch('/api/templates');
                invoiceTemplates = await res.json();
                renderTemplateSelect();
            } catch (e) {
                console.error('Error loading templates:', e);
            }
        }

        async function loadVatRates() {
            try {
                const res = await fetch('/api/vat-rates?active_only=true');
                vatRates = await res.json();
                renderVatRateSelect();
            } catch (e) {
                console.error('Error loading VAT rates:', e);
            }
        }

        function renderVatRateSelect() {
            const select = document.getElementById('vatRateSelect');
            select.innerHTML = '<option value="">Select VAT rate...</option>';

            // Find and pre-select the default rate
            let defaultRateId = null;
            vatRates.forEach(rate => {
                const opt = document.createElement('option');
                opt.value = rate.id;
                opt.textContent = `${rate.name} (${rate.rate}%)`;
                opt.dataset.rate = rate.rate;
                select.appendChild(opt);
                if (rate.is_default) {
                    defaultRateId = rate.id;
                }
            });

            // Pre-select default rate if exists
            if (defaultRateId) {
                select.value = defaultRateId;
            }
        }

        // Bank Transaction Linking
        let pendingBankTransactions = [];

        async function loadPendingBankTransactions() {
            try {
                // Load transactions with status pending or matched (not yet linked to invoice)
                const res = await fetch('/statements/api/transactions?status=pending&limit=200');
                const data = await res.json();

                if (data.success) {
                    pendingBankTransactions = data.transactions.filter(t => !t.invoice_id);

                    // Also load matched transactions
                    const res2 = await fetch('/statements/api/transactions?status=matched&limit=200');
                    const data2 = await res2.json();
                    if (data2.success) {
                        const matchedWithoutInvoice = data2.transactions.filter(t => !t.invoice_id);
                        pendingBankTransactions = [...pendingBankTransactions, ...matchedWithoutInvoice];
                    }

                    renderBankTransactionSelect();
                }
            } catch (e) {
                console.error('Error loading bank transactions:', e);
                // Hide the section if bank statements module is not available
                const section = document.getElementById('bankTransactionSection');
                if (section) section.style.display = 'none';
            }
        }

        function renderBankTransactionSelect() {
            const select = document.getElementById('bankTransactionSelect');
            if (!select) return;

            select.innerHTML = '<option value="">-- No transaction link --</option>';

            if (pendingBankTransactions.length === 0) {
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.textContent = '(No pending transactions available)';
                select.appendChild(opt);
                return;
            }

            // Sort by date descending
            pendingBankTransactions.sort((a, b) => {
                return new Date(b.transaction_date) - new Date(a.transaction_date);
            });

            pendingBankTransactions.forEach(txn => {
                const opt = document.createElement('option');
                opt.value = txn.id;
                const date = formatDateShort(txn.transaction_date);
                const amount = formatCurrency(Math.abs(txn.amount), txn.currency);
                const vendor = txn.matched_supplier || txn.vendor_name || 'Unknown';
                opt.textContent = `${date} | ${amount} | ${vendor}`;
                opt.title = txn.description?.substring(0, 100) || '';
                select.appendChild(opt);
            });

            // Set up change listener
            select.addEventListener('change', onBankTransactionChange);
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('ro-RO', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(value, currency = 'RON') {
            if (value == null) return '-';
            return value.toLocaleString('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ' + currency;
        }

        function onBankTransactionChange() {
            const select = document.getElementById('bankTransactionSelect');
            const hidden = document.getElementById('bankTransactionId');
            const txnId = select.value;

            hidden.value = txnId || '';

            // If transaction selected, optionally pre-fill some fields
            if (txnId) {
                const txn = pendingBankTransactions.find(t => t.id == txnId);
                if (txn) {
                    // Auto-fill supplier if not already filled
                    const supplierInput = document.getElementById('supplier');
                    if (!supplierInput.value && txn.matched_supplier) {
                        supplierInput.value = txn.matched_supplier;
                    }

                    // Auto-fill amount if not already filled
                    const valueInput = document.getElementById('invoiceValue');
                    if (!valueInput.value && txn.amount) {
                        valueInput.value = Math.abs(txn.amount).toFixed(2);
                    }

                    // Auto-fill date if not already filled
                    const dateInput = document.getElementById('invoiceDate');
                    if (!dateInput.value && txn.transaction_date) {
                        dateInput.value = txn.transaction_date;
                    }

                    // Auto-fill currency
                    const currencySelect = document.getElementById('currency');
                    if (txn.currency) {
                        currencySelect.value = txn.currency;
                    }

                    // Set payment status to paid (bank transactions are already paid)
                    document.getElementById('paymentStatus').value = 'paid';
                }
            }
        }

        function onSubtractVatChange() {
            const subtractVat = document.getElementById('subtractVat').checked;
            const vatRateCol = document.getElementById('vatRateCol');
            const netValueCol = document.getElementById('netValueCol');

            if (subtractVat) {
                vatRateCol.style.display = '';
                netValueCol.style.display = '';
                calculateNetValue();
            } else {
                vatRateCol.style.display = 'none';
                netValueCol.style.display = 'none';
                document.getElementById('netValue').value = '';
                document.getElementById('netValueDisplay').value = '';
                document.getElementById('vatRateId').value = '';
            }
            updateAllocationValues();
        }

        function onVatRateChange() {
            calculateNetValue();
            updateAllocationValues();
        }

        function calculateNetValue() {
            const subtractVat = document.getElementById('subtractVat').checked;
            const vatRateSelect = document.getElementById('vatRateSelect');
            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;
            const currency = document.getElementById('currency').value || 'RON';

            if (!subtractVat || !vatRateSelect.value) {
                document.getElementById('netValue').value = '';
                document.getElementById('netValueDisplay').value = '';
                document.getElementById('vatRateId').value = '';
                return;
            }

            const selectedOption = vatRateSelect.options[vatRateSelect.selectedIndex];
            const vatRate = parseFloat(selectedOption.dataset.rate) || 0;

            // Calculate net value: gross / (1 + rate/100)
            const netValue = invoiceValue / (1 + vatRate / 100);

            document.getElementById('netValue').value = netValue.toFixed(2);
            document.getElementById('vatRateId').value = vatRateSelect.value;
            document.getElementById('netValueDisplay').value = `${formatCurrency(netValue)} ${currency}`;
        }

        // Helper to get the effective value for allocation calculations
        function getEffectiveInvoiceValue() {
            const subtractVat = document.getElementById('subtractVat').checked;
            const netValue = parseFloat(document.getElementById('netValue').value);

            if (subtractVat && netValue > 0) {
                return netValue;
            }
            return parseFloat(document.getElementById('invoiceValue').value) || 0;
        }

        function renderTemplateSelect() {
            const select = document.getElementById('templateSelect');
            // Keep the first auto-detect option
            select.innerHTML = '<option value="">Auto-detect (AI fallback)</option>';

            invoiceTemplates.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = `Template: ${t.name}`;
                select.appendChild(opt);
            });

            // Update button text when selection changes
            select.addEventListener('change', updateParseButton);
        }

        function updateParseButton() {
            const select = document.getElementById('templateSelect');
            const btnText = document.getElementById('parseBtnText');
            const btnIcon = document.getElementById('parseBtnIcon');

            if (select.value) {
                const template = invoiceTemplates.find(t => t.id == select.value);
                btnText.textContent = `Citeste cu ${template ? template.name : 'Template'}`;
                btnIcon.className = 'bi bi-file-earmark-text';
            } else {
                btnText.textContent = 'Citeste Factura';
                btnIcon.className = 'bi bi-magic';
            }
        }

        function normalizeVat(vat) {
            if (!vat) return '';
            // Remove spaces, dashes, dots, colons
            vat = vat.toUpperCase().replace(/[\s\-\./:]+/g, '');
            // Remove common prefixes
            const prefixes = ['CUI:', 'CUI', 'CIF:', 'CIF', 'VAT:', 'VAT', 'TAXID:', 'TAXID'];
            for (const prefix of prefixes) {
                if (vat.startsWith(prefix)) {
                    vat = vat.substring(prefix.length);
                    break;
                }
            }
            return vat;
        }

        function extractVatNumbers(vat) {
            if (!vat) return '';
            return vat.replace(/[^0-9]/g, '');
        }

        function matchCompanyByVat(invoiceVat) {
            if (!invoiceVat) return null;
            const normalizedInvoiceVat = normalizeVat(invoiceVat);
            const invoiceNumbersOnly = extractVatNumbers(invoiceVat);

            // First pass: exact normalized match
            for (const c of companiesWithVat) {
                if (normalizeVat(c.vat) === normalizedInvoiceVat) {
                    return c;
                }
            }

            // Second pass: numeric-only match (handles 'RO225615' matching '225615')
            if (invoiceNumbersOnly) {
                for (const c of companiesWithVat) {
                    const companyNumbers = extractVatNumbers(c.vat);
                    if (companyNumbers && companyNumbers === invoiceNumbersOnly) {
                        return c;
                    }
                }
            }

            return null;
        }

        function setupEventListeners() {
            // File upload
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            dropZone.addEventListener('click', () => document.getElementById('fileInput').click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('dragover');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    uploadedFile = e.dataTransfer.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length) {
                    uploadedFile = fileInput.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });

            // Parse button
            document.getElementById('parseBtn').addEventListener('click', parseInvoice);

            // Add allocation
            document.getElementById('addAllocationBtn').addEventListener('click', addAllocationRow);

            // Submit
            document.getElementById('submitBtn').addEventListener('click', submitDistribution);

            // Clear Form
            document.getElementById('clearFormBtn').addEventListener('click', clearForm);

            // Manual VAT Match button
            document.getElementById('matchVatBtn').addEventListener('click', manualVatMatch);

            // Manual Entry button
            document.getElementById('manualEntryBtn').addEventListener('click', enableManualEntry);

            // Dedicated Company change - reload allocation rows
            document.getElementById('dedicatedCompany').addEventListener('change', onDedicatedCompanyChange);

            // Invoice Value change - update allocation values
            document.getElementById('invoiceValue').addEventListener('input', updateAllocationValues);

            // Currency change - update labels
            document.getElementById('currency').addEventListener('change', updateTotalAllocation);

            // VAT subtraction handlers
            document.getElementById('subtractVat').addEventListener('change', onSubtractVatChange);
            document.getElementById('vatRateSelect').addEventListener('change', onVatRateChange);

            // Attachments handling
            const attachmentsZone = document.getElementById('attachmentsZone');
            const attachmentsInput = document.getElementById('attachmentsInput');

            attachmentsZone.addEventListener('click', (e) => {
                if (!e.target.classList.contains('remove-attachment')) {
                    attachmentsInput.click();
                }
            });

            attachmentsInput.addEventListener('change', async () => {
                if (attachmentsInput.files.length) {
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    let skippedFiles = [];
                    for (let file of attachmentsInput.files) {
                        if (file.size > maxSize) {
                            skippedFiles.push(file.name);
                        } else {
                            attachmentFiles.push(file);
                        }
                    }
                    if (skippedFiles.length > 0) {
                        await JarvisDialog.alert(`Files exceeding 5MB were skipped:\n${skippedFiles.join('\n')}`, { type: 'warning' });
                    }
                    renderAttachmentsList();
                    attachmentsInput.value = ''; // Clear input so same file can be re-added
                }
            });
        }

        function renderAttachmentsList() {
            const container = document.getElementById('attachmentsList');
            container.innerHTML = attachmentFiles.map((file, idx) => `
                <span class="attachment-item">
                    <i class="bi bi-file-earmark me-1"></i>
                    ${file.name}
                    <i class="bi bi-x-circle remove-attachment" data-idx="${idx}" onclick="removeAttachment(${idx})"></i>
                </span>
            `).join('');
        }

        function removeAttachment(idx) {
            attachmentFiles.splice(idx, 1);
            renderAttachmentsList();
        }

        async function onDedicatedCompanyChange() {
            const company = document.getElementById('dedicatedCompany').value;

            // Reload department and brand dropdowns in all allocation rows
            const rows = document.querySelectorAll('.allocation-row');
            for (const row of rows) {
                await updateAllocationRowDropdowns(row);
            }
        }

        async function updateAllocationRowDropdowns(row) {
            const company = document.getElementById('dedicatedCompany').value;
            const brandSelect = row.querySelector('.brand-select');
            const deptSelect = row.querySelector('.department-select');
            const subdeptSelect = row.querySelector('.subdepartment-select');
            const managerDisplay = row.querySelector('.manager-display');
            const brandCol = brandSelect.closest('[class*="col-"]');
            const subdeptCol = subdeptSelect.closest('[class*="col-"]');

            brandSelect.innerHTML = '<option value="">N/A</option>';
            deptSelect.innerHTML = '<option value="">Select...</option>';
            subdeptSelect.innerHTML = '<option value="">N/A</option>';
            managerDisplay.textContent = 'Manager: --';

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);

                // Hide/show brand column based on whether brands exist
                if (brands.length > 0) {
                    brandCol.style.display = '';
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        brandSelect.appendChild(opt);
                    });
                } else {
                    brandCol.style.display = 'none';
                }

                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });

                // Initially hide subdepartment until a department is selected
                subdeptCol.style.display = 'none';
            } else {
                // No company selected - show all columns
                brandCol.style.display = '';
                subdeptCol.style.display = '';
            }
        }

        async function manualVatMatch() {
            const vatInput = document.getElementById('customerVat').value.trim();
            if (!vatInput) {
                await JarvisDialog.alert('Please enter a VAT number first', { type: 'warning' });
                return;
            }

            const vatMatch = matchCompanyByVat(vatInput);
            if (vatMatch) {
                document.getElementById('matchedCompany').value = vatMatch.company + ' (matched by VAT)';

                // Auto-select company in dedicated company dropdown
                const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                let selectedCompany = null;

                // First try exact match
                for (let opt of dedicatedCompanySelect.options) {
                    if (opt.value === vatMatch.company) {
                        selectedCompany = vatMatch.company;
                        break;
                    }
                }

                // If no exact match, try partial match
                if (!selectedCompany) {
                    const matchedLower = vatMatch.company.toLowerCase();
                    for (let opt of dedicatedCompanySelect.options) {
                        if (!opt.value) continue;
                        const optLower = opt.value.toLowerCase();
                        if (optLower.includes(matchedLower) || matchedLower.includes(optLower)) {
                            selectedCompany = opt.value;
                            break;
                        }
                    }
                }

                if (selectedCompany) {
                    dedicatedCompanySelect.value = selectedCompany;
                    dedicatedCompanySelect.dispatchEvent(new Event('change'));
                }
            } else {
                document.getElementById('matchedCompany').value = '';
                await JarvisDialog.alert('No matching company found for VAT: ' + vatInput, { type: 'warning' });
            }
        }

        function enableManualEntry() {
            // Clear form but keep file if already uploaded
            document.getElementById('invoiceForm').reset();
            document.getElementById('matchedCompany').value = '';

            // Reset dedicated company
            document.getElementById('dedicatedCompany').value = '';
            document.getElementById('allocationsContainer').innerHTML = '';
            addAllocationRow();

            // Set today's date as default
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            // Show manual entry mode alert
            const alertEl = document.getElementById('entryModeAlert');
            const alertText = document.getElementById('entryModeText');
            alertEl.style.display = 'block';
            alertEl.className = 'alert alert-secondary small py-2 mb-3';
            alertText.textContent = 'Manual entry mode - fill in invoice details' + (uploadedFile ? ' (file attached for upload)' : '');

            // Focus on supplier field
            document.getElementById('supplier').focus();
        }

        async function clearForm() {
            // Confirm before clearing
            const confirmed = await JarvisDialog.confirm('Are you sure you want to clear the form? All entered data will be lost.', { danger: true });
            if (!confirmed) {
                return;
            }

            // Reset invoice form fields
            document.getElementById('invoiceForm').reset();
            document.getElementById('matchedCompany').value = '';

            // Reset dedicated company and allocations
            document.getElementById('dedicatedCompany').value = '';
            document.getElementById('allocationsContainer').innerHTML = '';

            // Reset file upload
            uploadedFile = null;
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                <p class="mb-0 mt-2">Drag & drop invoice here or click to upload</p>
                <small class="text-muted">Supports PDF, JPG, PNG</small>
                <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
            `;
            // Re-attach file input change listener (click handler uses getElementById so it works automatically)
            document.getElementById('fileInput').addEventListener('change', function() {
                if (this.files.length) {
                    uploadedFile = this.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });

            // Clear attachments
            attachmentFiles = [];
            document.getElementById('attachmentsList').innerHTML = '';

            // Reset VAT subtraction
            document.getElementById('subtractVat').checked = false;
            document.getElementById('vatRateCol').style.display = 'none';
            document.getElementById('netValueCol').style.display = 'none';
            document.getElementById('vatRateSelect').value = '';
            document.getElementById('netValue').value = '';
            document.getElementById('vatRateId').value = '';
            document.getElementById('netValueDisplay').value = '';

            // Reset bank transaction link
            const bankTxnSelect = document.getElementById('bankTransactionSelect');
            if (bankTxnSelect) {
                bankTxnSelect.value = '';
            }
            document.getElementById('bankTransactionId').value = '';

            // Hide currency conversion display
            document.getElementById('conversionDisplay').style.display = 'none';

            // Reset hidden fields
            document.getElementById('driveLink').value = '';
            document.getElementById('valueRon').value = '';
            document.getElementById('valueEur').value = '';
            document.getElementById('exchangeRate').value = '';

            // Hide entry mode alert
            document.getElementById('entryModeAlert').style.display = 'none';

            // Reset template selector
            document.getElementById('templateSelect').value = '';

            // Reset total allocation display
            document.getElementById('totalAllocation').textContent = '0%';
            document.getElementById('totalAllocation').className = 'total-allocation invalid';

            // Add initial allocation row
            addAllocationRow();

            // Focus on drop zone
            dropZone.focus();
        }

        function updateDropZoneText(filename) {
            const dropZone = document.getElementById('dropZone');
            dropZone.innerHTML = `
                <i class="bi bi-file-earmark-check fs-1 text-success"></i>
                <p class="mb-0 mt-2">${filename}</p>
                <small class="text-muted">Click to change</small>
                <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
            `;
            document.getElementById('fileInput').addEventListener('change', function() {
                if (this.files.length) {
                    uploadedFile = this.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
        }

        async function parseInvoice() {
            const btn = document.getElementById('parseBtn');
            const templateSelect = document.getElementById('templateSelect');
            const templateId = templateSelect.value;

            if (!uploadedFile) {
                await JarvisDialog.alert('Please upload an invoice first', { type: 'warning' });
                return;
            }

            btn.classList.add('parsing');
            btn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('file', uploadedFile);

                // Add template_id if a template is selected
                if (templateId) {
                    formData.append('template_id', templateId);
                }

                const res = await fetchWithRetry('/api/parse-invoice', { method: 'POST', body: formData });
                const result = await res.json();

                if (result.success) {
                    fillFormFromParsed(result.data, templateId ? true : false);
                } else {
                    await JarvisDialog.alert('Error parsing invoice: ' + result.error, { type: 'error' });
                }
            } catch (e) {
                await JarvisDialog.alert('Error: ' + e.message, { type: 'error' });
            } finally {
                btn.classList.remove('parsing');
                btn.disabled = false;
            }
        }

        function fillFormFromParsed(data, isTemplate = false) {
            // Show parsed mode alert
            const alertEl = document.getElementById('entryModeAlert');
            const alertText = document.getElementById('entryModeText');
            alertEl.style.display = 'block';
            if (isTemplate) {
                alertEl.className = 'alert alert-info small py-2 mb-3';
                alertText.textContent = `Template applied: ${data.template_used || 'Custom'} - enter invoice number, date, and value`;
            } else {
                alertEl.className = 'alert alert-success small py-2 mb-3';
                alertText.textContent = 'Invoice parsed with AI - review and edit fields if needed';
            }

            // Store drive link if returned from parsing (uploaded during parse)
            if (data.drive_link) {
                document.getElementById('driveLink').value = data.drive_link;
            }

            if (data.supplier) document.getElementById('supplier').value = data.supplier;
            if (data.customer_vat) document.getElementById('customerVat').value = data.customer_vat;
            if (data.invoice_number) document.getElementById('invoiceNumber').value = data.invoice_number;
            if (data.invoice_date) document.getElementById('invoiceDate').value = data.invoice_date;
            if (data.invoice_value) document.getElementById('invoiceValue').value = data.invoice_value;
            if (data.currency) {
                const currencySelect = document.getElementById('currency');
                for (let opt of currencySelect.options) {
                    if (opt.value === data.currency) {
                        opt.selected = true;
                        break;
                    }
                }
            }

            // Display currency conversion if available
            if (data.value_ron && data.value_eur) {
                document.getElementById('valueRon').value = data.value_ron;
                document.getElementById('valueEur').value = data.value_eur;
                document.getElementById('exchangeRate').value = data.exchange_rate || '';

                document.getElementById('displayValueRon').textContent = formatCurrency(data.value_ron);
                document.getElementById('displayValueEur').textContent = formatCurrency(data.value_eur);
                document.getElementById('displayExchangeRate').textContent = data.exchange_rate ? data.exchange_rate.toFixed(4) : '-';
                document.getElementById('conversionDisplay').style.display = 'block';
            } else {
                document.getElementById('conversionDisplay').style.display = 'none';
            }

            // PRIORITY 1: Try to match company by VAT number
            let matchedCompany = null;
            if (data.customer_vat) {
                const vatMatch = matchCompanyByVat(data.customer_vat);
                if (vatMatch) {
                    matchedCompany = vatMatch.company;
                    document.getElementById('matchedCompany').value = matchedCompany + ' (matched by VAT)';
                }
            }

            // Auto-select company in dedicated company dropdown
            if (matchedCompany) {
                const dedicatedCompanySelect = document.getElementById('dedicatedCompany');
                let selectedCompany = null;

                // First try exact match with matched company name
                for (let opt of dedicatedCompanySelect.options) {
                    if (opt.value === matchedCompany) {
                        selectedCompany = matchedCompany;
                        break;
                    }
                }

                // If no exact match, try partial match with matched company
                if (!selectedCompany) {
                    const matchedLower = matchedCompany.toLowerCase();
                    for (let opt of dedicatedCompanySelect.options) {
                        if (!opt.value) continue;
                        const optLower = opt.value.toLowerCase();
                        if (optLower.includes(matchedLower) || matchedLower.includes(optLower)) {
                            selectedCompany = opt.value;
                            break;
                        }
                        // Check word-based match
                        const matchedWords = matchedLower.split(/\s+/);
                        const optWords = optLower.split(/\s+/);
                        for (let mw of matchedWords) {
                            if (mw.length > 3 && optWords.some(w => w.includes(mw) || mw.includes(w))) {
                                selectedCompany = opt.value;
                                break;
                            }
                        }
                        if (selectedCompany) break;
                    }
                }

                // Apply selection if found
                if (selectedCompany) {
                    dedicatedCompanySelect.value = selectedCompany;
                    dedicatedCompanySelect.dispatchEvent(new Event('change'));
                }
            }

            // Update allocation values after invoice value is filled
            updateAllocationValues();
        }

        // Reinvoice line helper functions
        function addReinvoiceLine(allocationRow, redistribute = false) {
            const container = allocationRow.querySelector('.reinvoice-lines-container');
            const lineCount = container.children.length;
            let newPercentage = redistribute ? 100 / (lineCount + 1) : 100;

            // Get the allocation value to calculate reinvoice values
            const allocationValueInput = allocationRow.querySelector('.allocation-value-input');
            const allocationValue = parseFloat(allocationValueInput?.value) || 0;
            const currency = document.getElementById('currency')?.value || 'RON';

            // If redistributing, update only unlocked lines
            if (redistribute && lineCount > 0) {
                const allLines = container.querySelectorAll('.reinvoice-line');
                const lockedLines = container.querySelectorAll('.reinvoice-line.reinvoice-locked');
                const unlockedLines = container.querySelectorAll('.reinvoice-line:not(.reinvoice-locked)');

                // Calculate total locked percentage
                let lockedPercent = 0;
                lockedLines.forEach(line => {
                    lockedPercent += parseFloat(line.querySelector('.reinvoice-percent').value) || 0;
                });

                // Calculate remaining percentage for unlocked lines (including new line)
                const remainingPercent = Math.max(0, 100 - lockedPercent);
                const unlockedCount = unlockedLines.length + 1; // +1 for new line
                const perUnlockedLine = remainingPercent / unlockedCount;
                const perUnlockedValue = ((allocationValue * perUnlockedLine) / 100).toFixed(2);

                // Update only unlocked lines
                unlockedLines.forEach(line => {
                    line.querySelector('.reinvoice-percent').value = perUnlockedLine.toFixed(2);
                    line.querySelector('.reinvoice-value').value = perUnlockedValue;
                });

                // Use the calculated percentage for the new line
                newPercentage = perUnlockedLine;
            }

            const initialValue = ((allocationValue * newPercentage) / 100).toFixed(2);

            const lineHtml = `
                <div class="row mt-1 reinvoice-line align-items-center gx-1">
                    <div class="col reinvoice-company-col">
                        <select class="form-select form-select-sm reinvoice-company">
                            <option value="">Company...</option>
                            ${companies.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col reinvoice-brand-col d-none">
                        <select class="form-select form-select-sm reinvoice-brand">
                            <option value="">Brand...</option>
                        </select>
                    </div>
                    <div class="col reinvoice-dept-col">
                        <select class="form-select form-select-sm reinvoice-department">
                            <option value="">Dept...</option>
                        </select>
                    </div>
                    <div class="col reinvoice-subdept-col d-none">
                        <select class="form-select form-select-sm reinvoice-subdepartment">
                            <option value="">Subdept...</option>
                        </select>
                    </div>
                    <div class="col reinvoice-value-col">
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control reinvoice-value" value="${initialValue}" min="0" step="0.01">
                            <span class="input-group-text reinvoice-currency-label">${currency}</span>
                        </div>
                    </div>
                    <div class="col-auto reinvoice-percent-col">
                        <div class="input-group input-group-sm" style="width: 90px;">
                            <input type="number" class="form-control reinvoice-percent" value="${newPercentage.toFixed(2)}" min="0" max="100" step="0.01">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-auto d-flex align-items-center gap-1">
                        <button type="button" class="btn btn-outline-secondary btn-sm reinvoice-lock-btn" title="Lock this line">
                            <i class="bi bi-unlock"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm reinvoice-comment-btn" title="Add comment">
                            <i class="bi bi-chat"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-reinvoice-line-btn">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <input type="hidden" class="reinvoice-comment" value="">
                </div>
            `;

            container.insertAdjacentHTML('beforeend', lineHtml);
            const newLine = container.lastElementChild;

            // Set up event listeners for the new line
            setupReinvoiceLineEvents(newLine, allocationRow);
            updateReinvoiceTotalBadge(allocationRow);
        }

        function setupReinvoiceLineEvents(line, allocationRow) {
            const companySelect = line.querySelector('.reinvoice-company');
            const brandSelect = line.querySelector('.reinvoice-brand');
            const deptSelect = line.querySelector('.reinvoice-department');
            const subdeptSelect = line.querySelector('.reinvoice-subdepartment');
            const valueInput = line.querySelector('.reinvoice-value');
            const percentInput = line.querySelector('.reinvoice-percent');
            const removeBtn = line.querySelector('.remove-reinvoice-line-btn');

            // Get column wrappers for show/hide
            const brandCol = line.querySelector('.reinvoice-brand-col');
            const subdeptCol = line.querySelector('.reinvoice-subdept-col');

            // Company change - populate brands and departments
            companySelect.addEventListener('change', async () => {
                const company = companySelect.value;
                brandSelect.innerHTML = '<option value="">Brand...</option>';
                deptSelect.innerHTML = '<option value="">Dept...</option>';
                subdeptSelect.innerHTML = '<option value="">Subdept...</option>';

                // Hide subdept column when company changes (no dept selected yet)
                subdeptCol.classList.add('d-none');

                if (company) {
                    // Fetch brands and departments in parallel
                    const [brands, depts] = await Promise.all([
                        fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                        fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                    ]);

                    // Show/hide brand column based on available options
                    if (brands.length > 0) {
                        brandCol.classList.remove('d-none');
                        brands.forEach(b => {
                            const opt = document.createElement('option');
                            opt.value = b;
                            opt.textContent = b;
                            brandSelect.appendChild(opt);
                        });
                    } else {
                        brandCol.classList.add('d-none');
                    }

                    depts.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d;
                        opt.textContent = d;
                        deptSelect.appendChild(opt);
                    });
                } else {
                    // No company selected - hide brand column
                    brandCol.classList.add('d-none');
                }
            });

            // Department change - populate subdepartments
            deptSelect.addEventListener('change', async () => {
                const company = companySelect.value;
                const dept = deptSelect.value;
                subdeptSelect.innerHTML = '<option value="">Subdept...</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());

                    // Show/hide subdept column based on available options
                    if (subdepts.length > 0) {
                        subdeptCol.classList.remove('d-none');
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subdeptSelect.appendChild(opt);
                        });
                    } else {
                        subdeptCol.classList.add('d-none');
                    }
                } else {
                    // No department selected - hide subdept column
                    subdeptCol.classList.add('d-none');
                }
            });

            // Value change - update percentage (bidirectional sync)
            valueInput.addEventListener('input', () => {
                const allocationValueInput = allocationRow.querySelector('.allocation-value-input');
                const allocationValue = parseFloat(allocationValueInput?.value) || 0;
                const reinvoiceValue = parseFloat(valueInput.value) || 0;

                if (allocationValue > 0) {
                    const newPercent = (reinvoiceValue / allocationValue) * 100;
                    percentInput.value = newPercent.toFixed(2);
                }
                updateReinvoiceTotalBadge(allocationRow);
            });

            // Percentage change - update value (bidirectional sync)
            percentInput.addEventListener('input', () => {
                const allocationValueInput = allocationRow.querySelector('.allocation-value-input');
                const allocationValue = parseFloat(allocationValueInput?.value) || 0;
                const percent = parseFloat(percentInput.value) || 0;

                valueInput.value = ((allocationValue * percent) / 100).toFixed(2);
                updateReinvoiceTotalBadge(allocationRow);
            });

            // Remove button
            removeBtn.addEventListener('click', () => {
                line.remove();
                updateReinvoiceTotalBadge(allocationRow);
            });

            // Lock button
            const lockBtn = line.querySelector('.reinvoice-lock-btn');
            lockBtn.addEventListener('click', () => {
                const isLocked = line.classList.toggle('reinvoice-locked');
                const icon = lockBtn.querySelector('i');
                if (isLocked) {
                    icon.classList.remove('bi-unlock');
                    icon.classList.add('bi-lock-fill');
                    lockBtn.classList.remove('btn-outline-secondary');
                    lockBtn.classList.add('btn-warning');
                } else {
                    icon.classList.remove('bi-lock-fill');
                    icon.classList.add('bi-unlock');
                    lockBtn.classList.remove('btn-warning');
                    lockBtn.classList.add('btn-outline-secondary');
                }
            });

            // Comment button
            const commentBtn = line.querySelector('.reinvoice-comment-btn');
            const commentInput = line.querySelector('.reinvoice-comment');
            commentBtn.addEventListener('click', async () => {
                const currentComment = commentInput.value || '';
                const newComment = await JarvisDialog.prompt('Enter comment for this reinvoice line:', { defaultValue: currentComment });
                if (newComment !== null) {
                    commentInput.value = newComment;
                    // Update button appearance if comment exists
                    if (newComment.trim()) {
                        commentBtn.classList.remove('btn-outline-secondary');
                        commentBtn.classList.add('btn-info');
                        commentBtn.title = newComment;
                    } else {
                        commentBtn.classList.remove('btn-info');
                        commentBtn.classList.add('btn-outline-secondary');
                        commentBtn.title = 'Add comment';
                    }
                }
            });
        }

        function updateReinvoiceTotalBadge(allocationRow) {
            const container = allocationRow.querySelector('.reinvoice-lines-container');
            const badge = allocationRow.querySelector('.reinvoice-total-badge');

            if (!container || !badge) return;

            let total = 0;
            container.querySelectorAll('.reinvoice-percent').forEach(input => {
                total += parseFloat(input.value) || 0;
            });

            badge.textContent = total.toFixed(2) + '%';

            // Update badge color based on total
            badge.classList.remove('bg-secondary', 'bg-success', 'bg-danger');
            if (total === 0) {
                badge.classList.add('bg-secondary');
            } else if (total <= 100) {
                badge.classList.add('bg-success');
            } else {
                badge.classList.add('bg-danger');
            }
        }

        // Update reinvoice line values when allocation value changes (keeps percentage, updates value)
        function updateReinvoiceLineValues(allocationRow) {
            const container = allocationRow.querySelector('.reinvoice-lines-container');
            if (!container) return;

            const allocationValueInput = allocationRow.querySelector('.allocation-value-input');
            const allocationValue = parseFloat(allocationValueInput?.value) || 0;

            container.querySelectorAll('.reinvoice-line').forEach(line => {
                const percentInput = line.querySelector('.reinvoice-percent');
                const valueInput = line.querySelector('.reinvoice-value');
                const percent = parseFloat(percentInput.value) || 0;

                valueInput.value = ((allocationValue * percent) / 100).toFixed(2);
            });
        }

        function getReinvoiceDestinations(allocationRow) {
            const container = allocationRow.querySelector('.reinvoice-lines-container');
            const destinations = [];

            container.querySelectorAll('.reinvoice-line').forEach(line => {
                const company = line.querySelector('.reinvoice-company').value;
                const brand = line.querySelector('.reinvoice-brand').value;
                const department = line.querySelector('.reinvoice-department').value;
                const subdepartment = line.querySelector('.reinvoice-subdepartment').value;
                const percentage = parseFloat(line.querySelector('.reinvoice-percent').value) || 0;
                const value = parseFloat(line.querySelector('.reinvoice-value').value) || 0;
                const locked = line.classList.contains('reinvoice-locked');
                const comment = line.querySelector('.reinvoice-comment')?.value || '';

                if (company && percentage > 0) {
                    destinations.push({
                        company,
                        brand: brand || null,
                        department: department || null,
                        subdepartment: subdepartment || null,
                        percentage,
                        value,
                        locked,
                        comment: comment || null
                    });
                }
            });

            return destinations;
        }

        async function addAllocationRow() {
            const container = document.getElementById('allocationsContainer');
            const template = document.getElementById('allocationTemplate');
            const row = template.content.cloneNode(true);

            const brandSelect = row.querySelector('.brand-select');
            const deptSelect = row.querySelector('.department-select');
            const subdeptSelect = row.querySelector('.subdepartment-select');
            const allocationInput = row.querySelector('.allocation-input');
            const allocationValueInput = row.querySelector('.allocation-value-input');
            const currencyLabel = row.querySelector('.currency-label');
            const managerDisplay = row.querySelector('.manager-display');
            const removeBtn = row.querySelector('.remove-allocation');
            const reinvoiceCheck = row.querySelector('.reinvoice-check');
            const reinvoiceSection = row.querySelector('.reinvoice-section');
            const reinvoiceLinesContainer = row.querySelector('.reinvoice-lines-container');
            const addReinvoiceLineBtn = row.querySelector('.add-reinvoice-line-btn');
            const reinvoiceTotalBadge = row.querySelector('.reinvoice-total-badge');

            // Toggle reinvoice section visibility
            reinvoiceCheck.addEventListener('change', () => {
                // Get the actual allocation row element from the DOM (not the DocumentFragment)
                const allocRow = reinvoiceCheck.closest('.allocation-row');
                if (reinvoiceCheck.checked) {
                    reinvoiceSection.style.display = 'block';
                    reinvoiceTotalBadge.style.display = 'inline';
                    // Add first reinvoice line if none exist
                    if (reinvoiceLinesContainer.children.length === 0) {
                        addReinvoiceLine(allocRow);
                    }
                } else {
                    reinvoiceSection.style.display = 'none';
                    reinvoiceTotalBadge.style.display = 'none';
                    reinvoiceLinesContainer.innerHTML = '';
                    updateReinvoiceTotalBadge(allocRow);
                }
            });

            // Add reinvoice line button
            addReinvoiceLineBtn.addEventListener('click', () => {
                const allocRow = addReinvoiceLineBtn.closest('.allocation-row');
                addReinvoiceLine(allocRow, true); // true = redistribute percentages
            });

            // Populate brands and departments based on dedicated company
            const company = document.getElementById('dedicatedCompany').value;
            const brandCol = brandSelect.closest('[class*="col-"]');
            const subdeptCol = subdeptSelect.closest('[class*="col-"]');

            if (company) {
                const [brands, depts] = await Promise.all([
                    fetch(`/api/brands/${encodeURIComponent(company)}`).then(r => r.json()),
                    fetch(`/api/departments/${encodeURIComponent(company)}`).then(r => r.json())
                ]);

                // Hide/show brand column based on whether brands exist
                if (brands.length > 0) {
                    brandCol.style.display = '';
                    brands.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.textContent = b;
                        brandSelect.appendChild(opt);
                    });
                } else {
                    brandCol.style.display = 'none';
                }

                depts.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d;
                    opt.textContent = d;
                    deptSelect.appendChild(opt);
                });

                // Initially hide subdepartment until a department is selected
                subdeptCol.style.display = 'none';
            }

            deptSelect.addEventListener('change', async () => {
                const company = document.getElementById('dedicatedCompany').value;
                const dept = deptSelect.value;
                const subdeptCol = subdeptSelect.closest('[class*="col-"]');
                subdeptSelect.innerHTML = '<option value="">N/A</option>';

                if (company && dept) {
                    const subdepts = await fetch(`/api/subdepartments/${encodeURIComponent(company)}/${encodeURIComponent(dept)}`).then(r => r.json());
                    if (subdepts.length > 0) {
                        subdeptCol.style.display = '';
                        subdepts.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s;
                            opt.textContent = s;
                            subdeptSelect.appendChild(opt);
                        });
                    } else {
                        subdeptCol.style.display = 'none';
                    }
                } else {
                    subdeptCol.style.display = 'none';
                }
                updateManager();
            });

            subdeptSelect.addEventListener('change', updateManager);
            brandSelect.addEventListener('change', updateManager);

            async function updateManager() {
                const company = document.getElementById('dedicatedCompany').value;
                const brand = brandSelect.value;
                const dept = deptSelect.value;
                const subdept = subdeptSelect.value;

                if (company && dept) {
                    const params = new URLSearchParams({ company, department: dept });
                    if (brand) params.append('brand', brand);
                    if (subdept) params.append('subdepartment', subdept);
                    const res = await fetch(`/api/manager?${params}`);
                    const data = await res.json();
                    managerDisplay.textContent = `Manager: ${data.manager || '--'}`;
                } else {
                    managerDisplay.textContent = 'Manager: --';
                }
            }

            // Sync percentage and value inputs with smart redistribution
            allocationInput.addEventListener('input', () => {
                const rowElement = allocationInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'percent');
            });

            allocationValueInput.addEventListener('input', () => {
                const rowElement = allocationValueInput.closest('.allocation-row');
                onAllocationChange(rowElement, 'value');
            });

            removeBtn.addEventListener('click', () => {
                removeBtn.closest('.allocation-row').remove();
                redistributeAllocations(); // Redistribute after removing
            });

            // Lock button toggle
            const lockBtn = row.querySelector('.lock-allocation');
            lockBtn.addEventListener('click', () => {
                const icon = lockBtn.querySelector('i');
                const isLocked = icon.classList.contains('bi-lock-fill');
                if (isLocked) {
                    icon.classList.remove('bi-lock-fill');
                    icon.classList.add('bi-unlock');
                    lockBtn.classList.remove('btn-warning');
                    lockBtn.classList.add('btn-outline-secondary');
                    lockBtn.title = 'Lock this allocation';
                } else {
                    icon.classList.remove('bi-unlock');
                    icon.classList.add('bi-lock-fill');
                    lockBtn.classList.remove('btn-outline-secondary');
                    lockBtn.classList.add('btn-warning');
                    lockBtn.title = 'Unlock this allocation';
                }
            });

            // Comment button
            const commentBtn = row.querySelector('.comment-allocation');
            commentBtn.addEventListener('click', (e) => {
                const allocRow = e.target.closest('.allocation-row');
                openAllocationCommentModal(allocRow);
            });

            container.appendChild(row);
            redistributeAllocations(); // Smart redistribute when adding
        }

        function updateTotalAllocation() {
            const percentInputs = document.querySelectorAll('.allocation-input');
            const valueInputs = document.querySelectorAll('.allocation-value-input');
            const invoiceValue = parseFloat(document.getElementById('invoiceValue').value) || 0;
            const currency = document.getElementById('currency').value || 'RON';

            let totalPercent = 0;
            let totalValue = 0;
            percentInputs.forEach(input => {
                totalPercent += parseFloat(input.value) || 0;
            });
            valueInputs.forEach(input => {
                totalValue += parseFloat(input.value) || 0;
            });

            const display = document.getElementById('totalAllocation');
            display.textContent = `${totalPercent.toFixed(2)}% | ${formatCurrency(totalValue)} ${currency}`;
            display.classList.remove('valid', 'invalid');
            display.classList.add(totalPercent >= 100 && totalPercent <= 100.1 ? 'valid' : 'invalid');

            // Update currency labels in allocation rows
            document.querySelectorAll('.currency-label').forEach(label => {
                label.textContent = currency;
            });
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
        }

        function updateAllocationValues() {
            // Recalculate net value if VAT subtraction is enabled
            calculateNetValue();

            // Use effective value (net if VAT subtraction enabled, gross otherwise)
            const effectiveValue = getEffectiveInvoiceValue();
            const rows = document.querySelectorAll('.allocation-row');
            rows.forEach(row => {
                const percentInput = row.querySelector('.allocation-input');
                const valueInput = row.querySelector('.allocation-value-input');
                const percent = parseFloat(percentInput.value) || 0;
                valueInput.value = ((effectiveValue * percent) / 100).toFixed(2);
            });
            updateTotalAllocation();
        }

        // Check if a row is locked
        function isRowLocked(row) {
            const lockBtn = row.querySelector('.lock-allocation');
            const icon = lockBtn ? lockBtn.querySelector('i') : null;
            return icon && icon.classList.contains('bi-lock-fill');
        }

        // Smart allocation splitting - redistributes percentages when adding/removing allocations
        function redistributeAllocations() {
            const rows = Array.from(document.querySelectorAll('.allocation-row'));
            const count = rows.length;
            if (count === 0) return;

            // Use effective value (net if VAT subtraction enabled)
            const effectiveValue = getEffectiveInvoiceValue();

            // Separate locked and unlocked rows
            const lockedRows = rows.filter(r => isRowLocked(r));
            const unlockedRows = rows.filter(r => !isRowLocked(r));

            // Calculate total locked percentage
            let lockedPercent = 0;
            lockedRows.forEach(row => {
                lockedPercent += parseFloat(row.querySelector('.allocation-input').value) || 0;
            });

            // Distribute remaining percentage among unlocked rows
            const remainingPercent = Math.max(0, 100 - lockedPercent);
            const unlockedCount = unlockedRows.length;

            if (unlockedCount > 0) {
                let percentages = getSmartSplit(unlockedCount);
                // Scale percentages to fit remaining percent
                const scaleFactor = remainingPercent / 100;
                percentages = percentages.map(p => p * scaleFactor);

                unlockedRows.forEach((row, idx) => {
                    const percentInput = row.querySelector('.allocation-input');
                    const valueInput = row.querySelector('.allocation-value-input');
                    percentInput.value = percentages[idx].toFixed(2);
                    valueInput.value = ((effectiveValue * percentages[idx]) / 100).toFixed(2);
                    // Update reinvoice line values when allocation changes
                    updateReinvoiceLineValues(row);
                });
            }
            updateTotalAllocation();
        }

        // Get smart split percentages based on count
        // 1: 100%, 2: 50-50, 3: 40-30-30, 4: 40-20-20-20, etc.
        function getSmartSplit(count) {
            if (count === 1) return [100];
            if (count === 2) return [50, 50];

            // For 3+: first gets 40%, rest split equally
            const firstPercent = 40;
            const remaining = 100 - firstPercent;
            const otherPercent = remaining / (count - 1);

            const result = [firstPercent];
            for (let i = 1; i < count; i++) {
                result.push(otherPercent);
            }
            return result;
        }

        // When user changes an allocation, redistribute the difference to others
        function onAllocationChange(changedRow, changeType) {
            const rows = Array.from(document.querySelectorAll('.allocation-row'));
            const count = rows.length;

            // Use effective value (net if VAT subtraction enabled)
            const effectiveValue = getEffectiveInvoiceValue();
            const changedPercentInput = changedRow.querySelector('.allocation-input');
            const changedValueInput = changedRow.querySelector('.allocation-value-input');

            // Always sync percentage <-> value regardless of row count
            let changedPercent;
            if (changeType === 'percent') {
                changedPercent = parseFloat(changedPercentInput.value) || 0;
                changedValueInput.value = ((effectiveValue * changedPercent) / 100).toFixed(2);
            } else {
                const changedValue = parseFloat(changedValueInput.value) || 0;
                changedPercent = effectiveValue > 0 ? (changedValue / effectiveValue) * 100 : 0;
                changedPercentInput.value = changedPercent.toFixed(2);
            }

            // Update reinvoice line values for the changed row (keeps percentage, recalculates value)
            updateReinvoiceLineValues(changedRow);

            // For single row, just update totals (no redistribution needed)
            if (count <= 1) {
                updateTotalAllocation();
                return;
            }

            // Calculate total from changed row and all locked rows (excluding changed row if it's locked)
            let lockedPercent = changedPercent;
            const lockedRows = rows.filter(r => r !== changedRow && isRowLocked(r));
            lockedRows.forEach(row => {
                lockedPercent += parseFloat(row.querySelector('.allocation-input').value) || 0;
            });

            // Get unlocked rows that aren't the changed row
            const unlockedOtherRows = rows.filter(r => r !== changedRow && !isRowLocked(r));

            // Calculate remaining percentage to distribute among unlocked rows
            const remaining = Math.max(0, 100 - lockedPercent);

            if (unlockedOtherRows.length > 0) {
                const perOther = remaining / unlockedOtherRows.length;
                unlockedOtherRows.forEach(row => {
                    const pInput = row.querySelector('.allocation-input');
                    const vInput = row.querySelector('.allocation-value-input');
                    pInput.value = perOther.toFixed(2);
                    vInput.value = ((effectiveValue * perOther) / 100).toFixed(2);
                    // Update reinvoice line values for this row too
                    updateReinvoiceLineValues(row);
                });
            }

            updateTotalAllocation();
        }

        async function uploadToDrive(file, invoiceDate, company, invoiceNumber) {
            // Upload file to Google Drive
            const formData = new FormData();
            formData.append('file', file);
            formData.append('invoice_date', invoiceDate);
            formData.append('company', company);
            formData.append('invoice_number', invoiceNumber);

            const res = await fetchWithRetry('/api/drive/upload', { method: 'POST', body: formData });
            return await res.json();
        }

        async function uploadAttachment(file, driveLink) {
            // Upload attachment to the same Drive folder as the invoice
            const formData = new FormData();
            formData.append('file', file);
            formData.append('drive_link', driveLink);

            const res = await fetchWithRetry('/api/drive/upload-attachment', { method: 'POST', body: formData });
            return await res.json();
        }

        async function submitDistribution() {
            // Validate form
            const supplier = document.getElementById('supplier').value;
            const invoiceNumber = document.getElementById('invoiceNumber').value;
            const invoiceDate = document.getElementById('invoiceDate').value;
            const invoiceValue = document.getElementById('invoiceValue').value;

            if (!supplier || !invoiceNumber || !invoiceDate || !invoiceValue) {
                await JarvisDialog.alert('Please fill in all required fields', { type: 'warning' });
                return;
            }

            // Check for duplicate invoice number
            try {
                const dupRes = await fetch(`/api/db/check-invoice-number?invoice_number=${encodeURIComponent(invoiceNumber)}`);
                const dupResult = await dupRes.json();
                if (dupResult.exists) {
                    const existing = dupResult.invoice;
                    await JarvisDialog.alert(`Invoice number "${invoiceNumber}" already exists!\n\nExisting invoice:\n- Supplier: ${existing.supplier}\n- Date: ${existing.invoice_date}\n- Value: ${existing.invoice_value} ${existing.currency}`, { type: 'error' });
                    return;
                }
            } catch (e) {
                console.error('Error checking duplicate:', e);
            }

            // Get dedicated company
            const dedicatedCompany = document.getElementById('dedicatedCompany').value;

            if (!dedicatedCompany) {
                await JarvisDialog.alert('Please select a company in "Dedicated To"', { type: 'warning' });
                return;
            }

            // Collect allocations
            const rows = document.querySelectorAll('.allocation-row');
            const distributions = [];

            for (const row of rows) {
                const brandSelect = row.querySelector('.brand-select');
                const brand = brandSelect.value;
                const dept = row.querySelector('.department-select').value;
                const subdept = row.querySelector('.subdepartment-select').value;
                const allocation = parseFloat(row.querySelector('.allocation-input').value) / 100;
                const reinvoiceCheck = row.querySelector('.reinvoice-check').checked;
                const allocationComment = row.querySelector('.allocation-comment').value;

                // Check if brand is mandatory (brands exist for this company)
                const hasBrands = brandSelect.options.length > 1; // More than just "N/A"
                if (hasBrands && !brand) {
                    await JarvisDialog.alert('Please select a Brand for all allocations (brands are available for this company)', { type: 'warning' });
                    return;
                }

                if (!dept) {
                    await JarvisDialog.alert('Please select Department for all allocations', { type: 'warning' });
                    return;
                }

                // Check if subdepartment is mandatory (subdepartments exist for this department)
                const subdeptSelect = row.querySelector('.subdepartment-select');
                const hasSubdepts = subdeptSelect.options.length > 1; // More than just "N/A"
                if (hasSubdepts && !subdept) {
                    await JarvisDialog.alert('Please select Subdepartment for all allocations (subdepartments are available for this department)', { type: 'warning' });
                    return;
                }

                // Get reinvoice destinations using the helper function
                const reinvoiceDestinations = reinvoiceCheck ? getReinvoiceDestinations(row) : [];

                // Validate reinvoice total doesn't exceed 100%
                if (reinvoiceCheck && reinvoiceDestinations.length > 0) {
                    const reinvoiceTotal = reinvoiceDestinations.reduce((sum, d) => sum + d.percentage, 0);
                    if (reinvoiceTotal > 100.01) {
                        await JarvisDialog.alert('Reinvoice total percentage cannot exceed 100%', { type: 'warning' });
                        return;
                    }
                    // Validate each destination has a company
                    for (const dest of reinvoiceDestinations) {
                        if (!dest.company) {
                            await JarvisDialog.alert('Please select a company for all reinvoice destinations', { type: 'warning' });
                            return;
                        }
                    }
                }

                distributions.push({
                    company: dedicatedCompany,
                    brand: brand || null,
                    department: dept,
                    subdepartment: subdept || null,
                    allocation,
                    reinvoice_destinations: reinvoiceDestinations,
                    locked: isRowLocked(row),
                    comment: allocationComment || null
                });
            }

            // Validate total (must be 100%, allow up to 0.1% overdraft for rounding)
            const total = distributions.reduce((sum, d) => sum + d.allocation, 0);
            if (total < 1.0 || total > 1.001) {
                await JarvisDialog.alert('Allocations must sum to 100% (max 0.1% overdraft allowed)', { type: 'warning' });
                return;
            }

            // Submit
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
                let driveLink = document.getElementById('driveLink').value;

                // Get conversion values if available
                const valueRon = document.getElementById('valueRon').value;
                const valueEur = document.getElementById('valueEur').value;
                const exchangeRate = document.getElementById('exchangeRate').value;

                // Get notes
                const invoiceNotes = document.getElementById('invoiceNotes').value || '';

                // Get payment status
                const paymentStatus = document.getElementById('paymentStatus').value;

                // Get VAT subtraction settings
                const subtractVat = document.getElementById('subtractVat').checked;
                const vatRateSelect = document.getElementById('vatRateSelect');
                const vatRateSelectedOption = vatRateSelect.options[vatRateSelect.selectedIndex];
                const vatRate = subtractVat && vatRateSelectedOption && vatRateSelectedOption.dataset.rate
                    ? parseFloat(vatRateSelectedOption.dataset.rate) : null;
                const netValue = document.getElementById('netValue').value;

                // First save to database (without drive link if not yet uploaded)
                const res = await fetchWithRetry('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        supplier,
                        invoice_number: invoiceNumber,
                        invoice_date: invoiceDate,
                        invoice_value: invoiceValue,
                        currency: document.getElementById('currency').value,
                        drive_link: driveLink,
                        distributions,
                        value_ron: valueRon ? parseFloat(valueRon) : null,
                        value_eur: valueEur ? parseFloat(valueEur) : null,
                        exchange_rate: exchangeRate ? parseFloat(exchangeRate) : null,
                        comment: invoiceNotes,
                        payment_status: paymentStatus,
                        subtract_vat: subtractVat,
                        vat_rate: vatRate,
                        net_value: netValue ? parseFloat(netValue) : null
                    })
                });

                const result = await res.json();
                if (result.success) {
                    // Only upload to Drive AFTER successful database save
                    // This prevents creating Drive folders for duplicate invoices
                    let attachmentsUploaded = 0;
                    if (uploadedFile && !driveLink) {
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading to Drive...';
                        const uploadResult = await uploadToDrive(uploadedFile, invoiceDate, dedicatedCompany, invoiceNumber);
                        if (uploadResult.success) {
                            driveLink = uploadResult.drive_link;
                            document.getElementById('driveLink').value = driveLink;
                            // Update the invoice with the drive link
                            await fetch(`/api/invoices/${result.invoice_id}/drive-link`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ drive_link: driveLink })
                            });

                            // Upload attachments to the same folder as the invoice
                            if (attachmentFiles.length > 0 && driveLink) {
                                const totalAttachments = attachmentFiles.length;
                                for (let i = 0; i < attachmentFiles.length; i++) {
                                    const attachFile = attachmentFiles[i];
                                    btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Uploading attachment ${i + 1}/${totalAttachments}...`;
                                    const attachResult = await uploadAttachment(attachFile, driveLink);
                                    if (attachResult.success) {
                                        attachmentsUploaded++;
                                        // Show compression info if image was compressed
                                        if (attachResult.compression && attachResult.compression.saved_percent > 0) {
                                            console.log(`${attachFile.name}: compressed ${attachResult.compression.saved_percent}% (saved ${Math.round(attachResult.compression.saved_bytes / 1024)}KB)`);
                                        }
                                    }
                                }
                            }
                        } else if (!uploadResult.need_auth) {
                            console.warn('Drive upload failed:', uploadResult.error);
                        }
                    }

                    // Link to bank transaction if selected
                    const bankTransactionId = document.getElementById('bankTransactionId').value;
                    let transactionLinked = false;
                    if (bankTransactionId && result.invoice_id) {
                        try {
                            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Linking transaction...';
                            const linkRes = await fetch('/statements/api/transactions/link-invoice', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    transaction_id: parseInt(bankTransactionId),
                                    invoice_id: result.invoice_id
                                })
                            });
                            const linkResult = await linkRes.json();
                            transactionLinked = linkResult.success;
                            if (!transactionLinked) {
                                console.warn('Failed to link transaction:', linkResult.error);
                            }
                        } catch (linkError) {
                            console.error('Error linking transaction:', linkError);
                        }
                    }

                    let successMsg = 'Successfully saved ' + result.allocations + ' allocation(s)!';
                    if (driveLink) successMsg += '\nUploaded to Drive!';
                    if (transactionLinked) successMsg += '\nLinked to bank transaction!';
                    if (attachmentsUploaded > 0) successMsg += `\n${attachmentsUploaded} attachment(s) uploaded.`;
                    await JarvisDialog.alert(successMsg, { type: 'success' });
                    // Reset form
                    document.getElementById('invoiceForm').reset();
                    document.getElementById('matchedCompany').value = '';
                    document.getElementById('allocationsContainer').innerHTML = '';
                    // Reset dedicated company
                    document.getElementById('dedicatedCompany').value = '';
                    // Hide entry mode alert and conversion display
                    document.getElementById('entryModeAlert').style.display = 'none';
                    document.getElementById('conversionDisplay').style.display = 'none';
                    document.getElementById('valueRon').value = '';
                    document.getElementById('valueEur').value = '';
                    document.getElementById('exchangeRate').value = '';
                    document.getElementById('driveLink').value = '';
                    // Reset VAT subtraction fields
                    document.getElementById('subtractVat').checked = false;
                    document.getElementById('vatRateCol').style.display = 'none';
                    document.getElementById('netValueCol').style.display = 'none';
                    document.getElementById('netValue').value = '';
                    document.getElementById('netValueDisplay').value = '';
                    document.getElementById('vatRateId').value = '';
                    addAllocationRow();
                    // Reset file input area
                    uploadedFile = null;
                    const dropZone = document.getElementById('dropZone');
                    dropZone.innerHTML = `
                        <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                        <p class="mb-0 mt-2">Drag & drop invoice here or click to upload</p>
                        <small class="text-muted">Supports PDF, JPG, PNG</small>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf,.jpg,.jpeg,.png">
                    `;
                    setupFileInput();
                    // Reset attachments
                    attachmentFiles = [];
                    document.getElementById('attachmentsList').innerHTML = '';
                } else {
                    await JarvisDialog.alert('Error: ' + result.error, { type: 'error' });
                }
            } catch (e) {
                await JarvisDialog.alert('Error: ' + e.message, { type: 'error' });
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Save Distribution';
            }
        }

        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function() {
                if (this.files.length) {
                    uploadedFile = this.files[0];
                    updateDropZoneText(uploadedFile.name);
                }
            });
        }

        // Allocation Comment Modal
        let currentCommentRow = null;

        function openAllocationCommentModal(row) {
            currentCommentRow = row;
            const dept = row.querySelector('.department-select').value || '-';
            const brand = row.querySelector('.brand-select').value || '';
            const percent = row.querySelector('.allocation-input').value || 0;
            const value = row.querySelector('.allocation-value-input').value || 0;
            const comment = row.querySelector('.allocation-comment').value || '';
            const currency = document.getElementById('currency').value || 'RON';

            const brandPart = brand ? ` (${brand})` : '';
            document.getElementById('allocationCommentInfo').textContent = `${dept}${brandPart} - ${formatCurrency(parseFloat(value))} ${currency} (${percent}%)`;
            document.getElementById('allocationCommentText').value = comment;

            const modal = new bootstrap.Modal(document.getElementById('allocationCommentModal'));
            modal.show();
        }

        function saveAllocationComment() {
            if (!currentCommentRow) return;

            const comment = document.getElementById('allocationCommentText').value;
            currentCommentRow.querySelector('.allocation-comment').value = comment;

            // Update button appearance based on whether comment exists
            const commentBtn = currentCommentRow.querySelector('.comment-allocation');
            const icon = commentBtn.querySelector('i');
            if (comment.trim()) {
                icon.classList.remove('bi-chat-text');
                icon.classList.add('bi-chat-text-fill');
                commentBtn.classList.remove('btn-outline-info');
                commentBtn.classList.add('btn-info');
                commentBtn.title = 'Edit comment';
            } else {
                icon.classList.remove('bi-chat-text-fill');
                icon.classList.add('bi-chat-text');
                commentBtn.classList.remove('btn-info');
                commentBtn.classList.add('btn-outline-info');
                commentBtn.title = 'Add comment';
            }

            bootstrap.Modal.getInstance(document.getElementById('allocationCommentModal')).hide();
            currentCommentRow = null;
        }

        // Add event listener for save button
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('saveAllocationCommentBtn').addEventListener('click', saveAllocationComment);
        });

        // Change Password
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                await JarvisDialog.alert('New passwords do not match', { type: 'warning' });
                return;
            }

            if (newPassword.length < 6) {
                await JarvisDialog.alert('Password must be at least 6 characters', { type: 'warning' });
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                const result = await response.json();
                if (result.success) {
                    await JarvisDialog.alert('Password changed successfully', { type: 'success' });
                    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
                    document.getElementById('changePasswordForm').reset();
                } else {
                    await JarvisDialog.alert('Error: ' + result.error, { type: 'error' });
                }
            } catch (e) {
                await JarvisDialog.alert('Error: ' + e.message, { type: 'error' });
            }
        }
    </script>

    <!-- Allocation Comment Modal -->
    <div class="modal fade" id="allocationCommentModal" tabindex="-1" aria-labelledby="allocationCommentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allocationCommentModalLabel"><i class="bi bi-chat-text"></i> Allocation Comment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <small class="text-muted" id="allocationCommentInfo"></small>
                    </div>
                    <div class="mb-3">
                        <label for="allocationCommentText" class="form-label">Comment</label>
                        <textarea class="form-control" id="allocationCommentText" rows="3" placeholder="Add a comment for this allocation..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAllocationCommentBtn">Save Comment</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/jarvis-utils.js"></script>
    <script src="/static/js/online-users.js"></script>
    {% include 'partials/_edit_profile_modal.html' %}
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/jarvis-dialogs.js"></script>
</body>
</html>
