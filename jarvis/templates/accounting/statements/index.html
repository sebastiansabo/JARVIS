<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Bank Statements</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        .transaction-row.ignored { opacity: 0.5; }
        .transaction-row.resolved { background-color: #d1e7dd !important; }  /* Green for resolved rows */
        .transaction-row.resolved td { background-color: #d1e7dd !important; }  /* Override striped table */
        .transaction-row.merged { opacity: 0.5; text-decoration: line-through; }  /* Strikethrough for merged source rows */
        .transaction-row.merged-result { background-color: #cff4fc !important; }  /* Light blue for merged result */
        .transaction-row.merged-result td { background-color: #cff4fc !important; }
        .merged-source-row { font-size: 0.85rem; }  /* Slightly smaller for source rows */
        .merged-source-row td { background-color: #f0f9ff !important; border-top: none !important; }
        .badge-internal { background-color: var(--bs-secondary); }
        .badge-card_purchase { background-color: var(--bs-primary); }
        .badge-refund { background-color: var(--bs-warning); }
        .amount-negative { color: var(--bs-danger); }
        .amount-positive { color: var(--bs-success); }
        .summary-card { min-width: 150px; }
        .filter-section { background: var(--bs-tertiary-bg); padding: 1rem; border-radius: 0.5rem; }
        /* Invoice popover styles */
        .invoice-popover-content { min-width: 200px; font-size: 0.875rem; }
        .invoice-popover-content div { line-height: 1.5; }
        .popover { max-width: 320px; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="progress-text">Processing statements...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" style="z-index: 1100;"></div>

    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid px-4">
            <a class="navbar-brand mb-0 h1" href="/" id="navbarLogo">
                <span class="navbar-logo-icon"></span> J.A.R.V.I.S.
            </a>
            <span class="navbar-text text-white me-auto ms-3">
                <i class="bi bi-bank"></i> Bank Statements
                <span class="badge bg-light text-success ms-2" id="onlineUsersIndicator" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" title="Loading..." style="cursor: pointer; font-size: 0.7rem;">
                    <i class="bi bi-circle-fill text-success" style="font-size: 0.4rem;"></i> <span id="onlineUsersCount">-</span> online
                </span>
            </span>
            <div class="d-flex align-items-center">
                <!-- Theme Toggle -->
                <div class="theme-switch">
                    <i class="bi bi-sun-fill"></i>
                    <input type="checkbox" id="themeToggle" title="Toggle Dark/Light Theme">
                    <i class="bi bi-moon-fill"></i>
                </div>
                {% if current_user.can_add_invoices %}
                <a href="/add-invoice" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-plus-circle"></i> New Invoice
                </a>
                {% endif %}
                {% if current_user.can_access_accounting %}
                <a href="/accounting" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ current_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text text-muted small">{{ current_user.email }}</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/statements/mappings"><i class="bi bi-diagram-3"></i> Vendor Mappings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item active">Statements</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Summary Cards Toggle -->
        <div class="d-flex justify-content-between align-items-center mb-2" id="summaryToggleSection" style="display: none;">
            <button class="btn btn-sm btn-outline-secondary" id="toggleSummary" onclick="toggleSummaryCards()">
                <i class="bi bi-chevron-down" id="toggleSummaryIcon"></i> <span id="toggleSummaryText">Show Summary</span>
            </button>
            <div id="summaryCollapsed">
                <span class="badge bg-primary me-1"><i class="bi bi-list-ul"></i> <span id="totalCountCompact">0</span></span>
                <span class="badge bg-warning text-dark me-1"><i class="bi bi-hourglass-split"></i> <span id="pendingCountCompact">0</span></span>
                <span class="badge bg-success me-1"><i class="bi bi-check-circle"></i> <span id="resolvedCountCompact">0</span></span>
                <span class="badge bg-secondary"><i class="bi bi-eye-slash"></i> <span id="ignoredCountCompact">0</span></span>
            </div>
        </div>
        <!-- Summary Cards -->
        <div class="row mb-3 d-none" id="summaryCards">
            <div class="col-md-3">
                <div class="card summary-card bg-primary text-white">
                    <div class="card-body py-2">
                        <h6 class="card-title small mb-1"><i class="bi bi-list-ul"></i> Total Transactions</h6>
                        <h4 id="totalCount" class="mb-0">0</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-warning text-white">
                    <div class="card-body py-2">
                        <h6 class="card-title small mb-1"><i class="bi bi-hourglass-split"></i> Pending</h6>
                        <h4 class="mb-0"><span id="pendingCount">0</span> <small id="pendingPct"></small></h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-success text-white">
                    <div class="card-body py-2">
                        <h6 class="card-title small mb-1"><i class="bi bi-check-circle"></i> Resolved</h6>
                        <h4 class="mb-0"><span id="resolvedCount">0</span> <small id="resolvedPct"></small></h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card summary-card bg-secondary text-white">
                    <div class="card-body py-2">
                        <h6 class="card-title small mb-1"><i class="bi bi-eye-slash"></i> Ignored</h6>
                        <h4 class="mb-0"><span id="ignoredCount">0</span></h4>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="row mb-3" id="filterSection" style="display: none;">
            <div class="col-12">
                <div class="filter-section">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-2">
                            <label class="form-label small">Status</label>
                            <select class="form-select form-select-sm" id="filterStatus" onchange="loadTransactions()">
                                <option value="">All</option>
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                                <option value="ignored">Ignored</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Company</label>
                            <select class="form-select form-select-sm" id="filterCompany" onchange="loadTransactions()">
                                <option value="">All Companies</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Supplier</label>
                            <select class="form-select form-select-sm" id="filterSupplier" onchange="loadTransactions()">
                                <option value="">All Suppliers</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Date From</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateFrom" onchange="loadTransactions()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">Date To</label>
                            <input type="date" class="form-control form-control-sm" id="filterDateTo" onchange="loadTransactions()">
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                <i class="bi bi-x-lg"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="row mb-3" id="actionsSection" style="display: none;">
            <div class="col-12">
                <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAll()">
                        <i class="bi bi-check-all"></i> Select All
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectNone()">
                        <i class="bi bi-x-lg"></i> Select None
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectMatched()">
                        <i class="bi bi-check2-circle"></i> Select Resolved
                    </button>
                    <div class="vr"></div>
                    <button type="button" class="btn btn-sm btn-warning" onclick="bulkIgnore()" id="bulkIgnoreBtn" disabled>
                        <i class="bi bi-eye-slash"></i> Ignore Selected
                    </button>
                    <button type="button" class="btn btn-sm btn-info" onclick="showMergeModal()" id="mergeSelectedBtn" disabled title="Merge selected transactions into one">
                        <i class="bi bi-union"></i> Merge
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="linkInvoice()" id="linkInvoiceBtn" disabled>
                        <i class="bi bi-link-45deg"></i> Link Invoice
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="autoMatchInvoices()" title="Auto-match pending transactions to invoices">
                        <i class="bi bi-magic"></i> Auto-Match
                    </button>
                    <div class="vr"></div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="exportCSV()">
                        <i class="bi bi-download"></i> Export CSV
                    </button>
                    <a href="/statements/files" class="btn btn-sm btn-primary">
                        <i class="bi bi-files"></i> Manage Files
                    </a>
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" class="btn btn-sm" id="hideIgnoredBtn" onclick="toggleHideIgnored()" title="Toggle ignored transactions">
                            <i class="bi" id="hideIgnoredIcon"></i> <span id="hideIgnoredText">Hide Ignored</span>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openColumnConfig()" title="Configure columns">
                            <i class="bi bi-gear"></i> Columns
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="row" id="transactionsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="transactionsTable">
                                <thead class="table-light">
                                    <tr id="transactionsHeader">
                                        <!-- Columns rendered dynamically by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="transactionsBody">
                                    <tr>
                                        <td colspan="10" class="text-center text-muted py-4">
                                            Upload bank statements to see transactions
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Pagination Controls -->
                    <div class="card-footer d-flex justify-content-between align-items-center" id="paginationFooter">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted">Show</span>
                            <select class="form-select form-select-sm" id="pageSize" onchange="changePageSize()" style="width: auto;">
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="250">250</option>
                                <option value="500">500</option>
                            </select>
                            <span class="text-muted">per page</span>
                        </div>
                        <div class="text-muted" id="paginationInfo">
                            Showing 0-0 of 0 transactions
                        </div>
                        <nav aria-label="Transaction pagination">
                            <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                <li class="page-item disabled" id="prevPage">
                                    <a class="page-link" href="#" onclick="goToPage(currentPage - 1); return false;">Previous</a>
                                </li>
                                <li class="page-item disabled" id="nextPage">
                                    <a class="page-link" href="#" onclick="goToPage(currentPage + 1); return false;">Next</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Invoice Modal -->
    <div class="modal fade" id="linkInvoiceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-link-45deg"></i> Link Invoice to Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        <i class="bi bi-info-circle"></i> Select an existing invoice to link to this transaction.
                    </div>

                    <!-- Selected Transaction Info -->
                    <div class="card mb-3 bg-light">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1">Selected Transaction:</h6>
                            <div class="row small">
                                <div class="col-md-4">
                                    <strong>Date:</strong> <span id="linkTxnDate">-</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Amount:</strong> <span id="linkTxnAmount">-</span>
                                </div>
                                <div class="col-md-4">
                                    <strong>Vendor:</strong> <span id="linkTxnVendor">-</span>
                                </div>
                            </div>
                            <div class="mt-1 small text-muted" id="linkTxnDescription"></div>
                        </div>
                    </div>

                    <!-- Invoice Search -->
                    <div class="mb-3">
                        <label class="form-label">Search Invoice</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="invoiceSearchInput"
                                   placeholder="Search by invoice number, supplier, value, or ID...">
                            <button class="btn btn-outline-primary" type="button" onclick="searchInvoices()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <small class="text-muted">Enter invoice number, supplier name, or amount (e.g., 380.30)</small>
                    </div>

                    <!-- Search Results -->
                    <div id="invoiceSearchResults" style="max-height: 300px; overflow-y: auto;">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-search fs-3"></i>
                            <p class="mb-0">Search for an invoice above</p>
                        </div>
                    </div>

                    <input type="hidden" id="selectedInvoiceId">
                    <input type="hidden" id="selectedTransactionId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmLinkInvoice()" id="confirmLinkBtn" disabled>
                        <i class="bi bi-link-45deg"></i> Link Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Transactions Modal -->
    <div class="modal fade" id="mergeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-union"></i> Merge Transactions</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning py-2 mb-3">
                        <i class="bi bi-exclamation-triangle"></i> This will create a new merged transaction and mark the originals as "merged".
                    </div>

                    <p class="mb-2">Merging <strong><span id="mergeCount">0</span> transactions</strong>:</p>

                    <div class="list-group list-group-flush mb-3" id="mergePreviewList" style="max-height: 200px; overflow-y: auto;">
                        <!-- Preview items will be inserted here -->
                    </div>

                    <hr>

                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-2"><i class="bi bi-arrow-right-circle"></i> Result:</h6>
                            <div class="row small">
                                <div class="col-6">
                                    <strong>Total Amount:</strong><br>
                                    <span id="mergeTotal" class="fs-5">0.00</span> <span id="mergeCurrency">RON</span>
                                </div>
                                <div class="col-6">
                                    <strong>Date:</strong><br>
                                    <span id="mergeDate">-</span>
                                </div>
                            </div>
                            <div class="mt-2 small">
                                <strong>Supplier:</strong> <span id="mergeSupplier">-</span>
                            </div>
                        </div>
                    </div>

                    <div id="mergeError" class="alert alert-danger mt-3 py-2 d-none">
                        <i class="bi bi-x-circle"></i> <span id="mergeErrorText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="confirmMerge()" id="confirmMergeBtn">
                        <i class="bi bi-union"></i> Merge Transactions
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2">Drag to reorder, check/uncheck to show/hide columns.</p>
                    <div class="list-group" id="columnList">
                        <!-- Column items will be populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetColumnConfig()">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        // State
        let transactions = [];
        let selectedTransactionIds = new Set();
        let departmentStructure = {};

        // Pagination state
        let currentPage = 1;
        let pageSize = parseInt(localStorage.getItem('statementsPageSize') || '100');
        let totalTransactions = 0;

        // Summary cards visibility state
        let summaryCardsVisible = localStorage.getItem('statementsSummaryVisible') !== 'false';

        // Hide ignored transactions state
        let hideIgnored = localStorage.getItem('statementsHideIgnored') === 'true';

        // Expanded merged transactions state (track which merged results are expanded)
        let expandedMergedIds = new Set();
        // Cache for merged source transactions
        let mergedSourcesCache = {};

        // Column configuration
        const DEFAULT_COLUMNS = [
            { id: 'select', name: '', source: 'special.select', format: 'special', visible: true },
            { id: 'date', name: 'Date', source: 'transaction_date', format: 'date', visible: true },
            { id: 'company', name: 'Company', source: 'company_name', format: 'text', visible: true },
            { id: 'cui', name: 'CUI', source: 'company_cui', format: 'text', visible: true },
            { id: 'vendor', name: 'Vendor', source: 'vendor_name', format: 'text', visible: true },
            { id: 'supplier', name: 'Supplier', source: 'matched_supplier', format: 'badge', visible: true },
            { id: 'description', name: 'Description', source: 'description', format: 'description', visible: true },
            { id: 'amount', name: 'Amount', source: 'amount', format: 'amount', visible: true },
            { id: 'type', name: 'Type', source: 'transaction_type', format: 'type', visible: true },
            { id: 'status', name: 'Status', source: 'status', format: 'status', visible: true },
            { id: 'invoice', name: 'Invoice', source: 'special.invoice', format: 'special', visible: true },
            { id: 'actions', name: 'Actions', source: 'special.actions', format: 'special', visible: true }
        ];
        let columnConfig = [];

        function loadColumnConfig() {
            const saved = localStorage.getItem('statementsColumnConfig');
            if (saved) {
                try {
                    columnConfig = JSON.parse(saved);
                    // Ensure all default columns exist
                    DEFAULT_COLUMNS.forEach(defCol => {
                        if (!columnConfig.find(c => c.id === defCol.id)) {
                            columnConfig.push({ ...defCol });
                        }
                    });
                } catch (e) {
                    columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
                }
            } else {
                columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            }
        }

        function saveColumnConfig() {
            localStorage.setItem('statementsColumnConfig', JSON.stringify(columnConfig));
            renderTableHeader();
            renderTransactions();
        }

        function resetColumnConfig() {
            columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            saveColumnConfig();
            renderColumnList();
        }

        function renderColumnList() {
            const container = document.getElementById('columnList');
            if (!container) return;

            container.innerHTML = columnConfig.map((col, idx) => `
                <div class="list-group-item d-flex align-items-center" draggable="true" data-idx="${idx}">
                    <i class="bi bi-grip-vertical text-muted me-2" style="cursor: grab;"></i>
                    <div class="form-check me-auto">
                        <input class="form-check-input" type="checkbox" id="col-${col.id}"
                               ${col.visible ? 'checked' : ''} ${col.id === 'select' || col.id === 'actions' ? 'disabled' : ''}
                               onchange="toggleColumnVisibility(${idx}, this.checked)">
                        <label class="form-check-label" for="col-${col.id}">${col.name || '(Select)'}</label>
                    </div>
                </div>
            `).join('');

            // Setup drag and drop
            setupColumnDragDrop(container);
        }

        function toggleColumnVisibility(idx, visible) {
            columnConfig[idx].visible = visible;
            saveColumnConfig();
        }

        function setupColumnDragDrop(container) {
            const items = container.querySelectorAll('.list-group-item');
            items.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', item.dataset.idx);
                    item.classList.add('opacity-50');
                });
                item.addEventListener('dragend', () => item.classList.remove('opacity-50'));
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.classList.add('border-primary');
                });
                item.addEventListener('dragleave', () => item.classList.remove('border-primary'));
                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('border-primary');
                    const fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIdx = parseInt(item.dataset.idx);
                    if (fromIdx !== toIdx) {
                        const [moved] = columnConfig.splice(fromIdx, 1);
                        columnConfig.splice(toIdx, 0, moved);
                        saveColumnConfig();
                        renderColumnList();
                    }
                });
            });
        }

        function openColumnConfig() {
            renderColumnList();
            new bootstrap.Modal(document.getElementById('columnConfigModal')).show();
        }

        function renderTableHeader() {
            const headerRow = document.getElementById('transactionsHeader');
            if (!headerRow) return;

            const visibleCols = columnConfig.filter(c => c.visible);
            headerRow.innerHTML = visibleCols.map(col => {
                if (col.id === 'select') {
                    return `<th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>`;
                } else if (col.id === 'amount') {
                    return `<th class="text-end">${col.name}</th>`;
                } else {
                    return `<th>${col.name}</th>`;
                }
            }).join('');
        }

        function renderCellContent(col, txn) {
            const isSelected = selectedTransactionIds.has(txn.id);
            const amountClass = txn.amount < 0 ? 'amount-negative' : 'amount-positive';
            const typeClass = `badge-${txn.transaction_type}`;
            const isExpanded = expandedMergedIds.has(txn.id);

            switch (col.id) {
                case 'select':
                    return `<td>
                        <div class="d-flex align-items-center gap-1">
                            <input type="checkbox" class="txn-checkbox" value="${txn.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleSelection(${txn.id})">
                            ${txn.is_merged_result ?
                                `<button class="btn btn-sm btn-link p-0 text-info" onclick="toggleMergedExpand(${txn.id})" title="${isExpanded ? 'Collapse' : 'Expand'} merged transactions">
                                    <i class="bi bi-${isExpanded ? 'dash' : 'plus'}-circle-fill"></i>
                                </button>` : ''}
                        </div>
                    </td>`;
                case 'date':
                    return `<td>${txn.is_merged_result && txn.merged_dates_display ? txn.merged_dates_display : formatDate(txn.transaction_date)}</td>`;
                case 'company':
                    return `<td>${escapeHtml(txn.company_name || '-')}</td>`;
                case 'cui':
                    return `<td>${txn.company_cui || '-'}</td>`;
                case 'vendor':
                    return `<td>${txn.vendor_name || '-'}</td>`;
                case 'supplier':
                    return `<td>${txn.matched_supplier ?
                        `<span class="badge bg-info">${txn.matched_supplier}</span>` :
                        '<span class="text-muted">-</span>'}</td>`;
                case 'description':
                    return `<td class="small" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                        title="${escapeHtml(txn.description)}">
                        ${txn.is_merged_result ? `<span class="badge bg-info me-1"><i class="bi bi-layers"></i> ${txn.merged_count}</span>` : ''}
                        ${escapeHtml(txn.description?.substring(0, 80) || '')}...
                    </td>`;
                case 'amount':
                    return `<td class="text-end ${amountClass}">
                        ${formatNumber(txn.amount)} ${txn.currency}
                        ${txn.original_currency && txn.original_currency !== txn.currency ?
                            `<br><small class="text-muted">${formatNumber(txn.original_amount)} ${txn.original_currency}</small>` : ''}
                    </td>`;
                case 'type':
                    return `<td><span class="badge ${typeClass}">${txn.transaction_type}</span></td>`;
                case 'status':
                    return `<td>
                        <select class="form-select form-select-sm status-select"
                                data-id="${txn.id}"
                                data-original="${txn.status}"
                                onchange="handleStatusChange(this)"
                                style="width: 110px; padding: 2px 6px; font-size: 0.75rem;">
                            <option value="pending" ${txn.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="resolved" ${txn.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                            <option value="ignored" ${txn.status === 'ignored' ? 'selected' : ''}>Ignored</option>
                        </select>
                    </td>`;
                case 'invoice':
                    if (txn.invoice_id) {
                        return `<td>
                            <div class="d-flex flex-column">
                                <a href="/accounting?invoice=${txn.invoice_id}"
                                   class="text-success fw-bold text-decoration-none invoice-popover"
                                   data-txn-id="${txn.id}">
                                    <i class="bi bi-receipt-cutoff"></i> ${txn.invoice_number || '#' + txn.invoice_id}
                                </a>
                                ${txn.linked_invoice_date ? `<small class="text-muted">${formatDate(txn.linked_invoice_date)}</small>` : ''}
                            </div>
                        </td>`;
                    } else if (txn.suggested_invoice_id) {
                        return `<td>
                            <div class="d-flex align-items-center gap-1">
                                <a href="/accounting?invoice=${txn.suggested_invoice_id}" class="badge bg-warning text-dark text-decoration-none suggested-invoice-popover"
                                   data-txn-id="${txn.id}">
                                    <i class="bi bi-question-circle"></i> ${txn.suggested_invoice_number || '#' + txn.suggested_invoice_id}
                                </a>
                                <button class="btn btn-sm btn-outline-success p-0 px-1" onclick="acceptSuggestedMatch(${txn.id})" title="Accept match">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger p-0 px-1" onclick="rejectSuggestedMatch(${txn.id})" title="Reject">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </td>`;
                    } else {
                        return `<td><span class="text-muted">-</span></td>`;
                    }
                case 'actions':
                    let actionsHtml = `<td><div class="btn-group btn-group-sm">`;
                    if (txn.invoice_id) {
                        actionsHtml += `<button class="btn btn-linked" onclick="unlinkInvoice(${txn.id})" title="Unlink Invoice">
                            <i class="bi bi-link-45deg"></i>
                        </button>`;
                    } else if (txn.status !== 'ignored') {
                        actionsHtml += `<button class="btn btn-link-action" onclick="linkSingleTransaction(${txn.id})" title="Link Invoice">
                            <i class="bi bi-link-45deg"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="ignoreTransaction(${txn.id})" title="Ignore">
                            <i class="bi bi-eye-slash"></i>
                        </button>`;
                    } else {
                        actionsHtml += `<button class="btn btn-outline-secondary" onclick="unignoreTransaction(${txn.id})" title="Restore">
                            <i class="bi bi-eye"></i>
                        </button>`;
                    }
                    if (txn.is_merged_result) {
                        actionsHtml += `<button class="btn btn-outline-info" onclick="unmergeTransaction(${txn.id})" title="Unmerge back to ${txn.merged_count || 0} original transactions">
                            <i class="bi bi-layers-half"></i>
                        </button>`;
                    }
                    actionsHtml += `</div></td>`;
                    return actionsHtml;
                default:
                    // Generic text column
                    const value = txn[col.source] || '-';
                    return `<td>${escapeHtml(String(value))}</td>`;
            }
        }

        function renderMergedSourceCells(src) {
            const visibleCols = columnConfig.filter(c => c.visible);
            const srcAmountClass = src.amount < 0 ? 'amount-negative' : 'amount-positive';

            return visibleCols.map(col => {
                switch (col.id) {
                    case 'select':
                        return `<td class="ps-4 text-muted"><i class="bi bi-arrow-return-right"></i></td>`;
                    case 'date':
                        return `<td class="text-muted">${formatDate(src.transaction_date)}</td>`;
                    case 'company':
                        return `<td class="text-muted">${escapeHtml(src.company_name || '-')}</td>`;
                    case 'cui':
                        return `<td class="text-muted">${src.company_cui || '-'}</td>`;
                    case 'vendor':
                        return `<td class="text-muted">${escapeHtml(src.vendor_name || '-')}</td>`;
                    case 'supplier':
                        return `<td class="text-muted">${src.matched_supplier ?
                            `<span class="badge bg-info">${src.matched_supplier}</span>` : '-'}</td>`;
                    case 'description':
                        return `<td class="small text-muted" style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                            title="${escapeHtml(src.description)}">
                            ${escapeHtml(src.description?.substring(0, 60) || '')}...
                        </td>`;
                    case 'amount':
                        return `<td class="text-end ${srcAmountClass}">${formatNumber(src.amount)} ${src.currency}</td>`;
                    default:
                        return `<td></td>`;
                }
            }).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load column configuration
            loadColumnConfig();
            // Render table header based on column config
            renderTableHeader();
            // Set page size dropdown from localStorage
            document.getElementById('pageSize').value = pageSize;
            // Initialize summary cards toggle state
            initSummaryCardsToggle();
            // Initialize hide ignored toggle state
            initHideIgnoredToggle();
            loadFilterOptions();
            loadTransactions();
        });

        function initSummaryCardsToggle() {
            const cards = document.getElementById('summaryCards');
            const icon = document.getElementById('toggleSummaryIcon');
            const text = document.getElementById('toggleSummaryText');
            const collapsed = document.getElementById('summaryCollapsed');

            if (summaryCardsVisible) {
                cards.classList.remove('d-none');
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
                text.textContent = 'Hide Summary';
                collapsed.style.display = 'none';
            } else {
                cards.classList.add('d-none');
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
                text.textContent = 'Show Summary';
                collapsed.style.display = 'block';
            }
        }

        function toggleSummaryCards() {
            summaryCardsVisible = !summaryCardsVisible;
            localStorage.setItem('statementsSummaryVisible', summaryCardsVisible);
            initSummaryCardsToggle();
        }

        function initHideIgnoredToggle() {
            const btn = document.getElementById('hideIgnoredBtn');
            const icon = document.getElementById('hideIgnoredIcon');
            const text = document.getElementById('hideIgnoredText');
            if (hideIgnored) {
                btn.classList.add('btn-outline-warning');
                btn.classList.remove('btn-outline-secondary');
                icon.classList.add('bi-eye-slash-fill');
                icon.classList.remove('bi-eye');
                text.textContent = 'Hiding Ignored';
            } else {
                btn.classList.add('btn-outline-secondary');
                btn.classList.remove('btn-outline-warning');
                icon.classList.add('bi-eye');
                icon.classList.remove('bi-eye-slash-fill');
                text.textContent = 'Hide Ignored';
            }
        }

        function toggleHideIgnored() {
            hideIgnored = !hideIgnored;
            localStorage.setItem('statementsHideIgnored', hideIgnored);
            initHideIgnoredToggle();
            // Re-render transactions to apply the filter
            renderTransactions();
            // Update pagination to reflect filtered count
            updatePagination();
        }

        // Load filter dropdown options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/statements/api/filters');
                const data = await response.json();

                if (data.success) {
                    // Populate company dropdown
                    const companySelect = document.getElementById('filterCompany');
                    const currentCompany = companySelect.value;
                    companySelect.innerHTML = '<option value="">All Companies</option>';
                    data.companies.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.company_cui;
                        opt.textContent = c.company_name;
                        companySelect.appendChild(opt);
                    });
                    if (currentCompany) companySelect.value = currentCompany;

                    // Populate supplier dropdown
                    const supplierSelect = document.getElementById('filterSupplier');
                    const currentSupplier = supplierSelect.value;
                    supplierSelect.innerHTML = '<option value="">All Suppliers</option>';
                    data.suppliers.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.textContent = s;
                        supplierSelect.appendChild(opt);
                    });
                    if (currentSupplier) supplierSelect.value = currentSupplier;
                }
            } catch (error) {
                console.error('Error loading filter options:', error);
            }
        }

        // Load Transactions
        async function loadTransactions(resetPage = true) {
            if (resetPage) currentPage = 1;

            const params = new URLSearchParams();

            const status = document.getElementById('filterStatus').value;
            const company = document.getElementById('filterCompany').value;
            const supplier = document.getElementById('filterSupplier').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            if (status) params.append('status', status);
            if (company) params.append('company_cui', company);
            if (supplier) params.append('supplier', supplier);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);

            // Add pagination params
            params.append('limit', pageSize);
            params.append('offset', (currentPage - 1) * pageSize);

            try {
                const response = await fetch('/statements/api/transactions?' + params.toString());
                const data = await response.json();

                if (data.success) {
                    transactions = data.transactions;
                    renderTransactions();
                    loadSummary();
                    updateFilterOptions();
                    updatePagination();

                    // Always show sections (even when empty, so user can upload)
                    document.getElementById('summaryToggleSection').style.display = 'flex';
                    initSummaryCardsToggle();
                    document.getElementById('filterSection').style.display = 'block';
                    document.getElementById('actionsSection').style.display = 'block';
                    document.getElementById('transactionsSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Load transactions error:', error);
            }
        }

        // Pagination Functions
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSize').value);
            localStorage.setItem('statementsPageSize', pageSize);
            currentPage = 1;
            loadTransactions(false);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(totalTransactions / pageSize);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadTransactions(false);
        }

        function updatePagination() {
            const statusFilter = document.getElementById('filterStatus').value;

            // Calculate displayed count (accounting for hideIgnored filter)
            let displayedTotal = totalTransactions;
            let hiddenCount = 0;
            if (hideIgnored && statusFilter !== 'ignored') {
                const ignoredInPage = transactions.filter(t => t.status === 'ignored').length;
                const displayedInPage = transactions.filter(t => t.status !== 'ignored').length;
                // For display purposes, show the actual filtered count from current page
                displayedTotal = displayedInPage;
                hiddenCount = ignoredInPage;
            } else {
                displayedTotal = transactions.length;
            }

            const start = displayedTotal > 0 ? 1 : 0;
            const end = displayedTotal;
            const totalPages = Math.ceil(totalTransactions / pageSize);

            let paginationText = '';
            if (displayedTotal > 0) {
                paginationText = `Showing ${start}-${end} of ${displayedTotal} transactions`;
                if (hiddenCount > 0) {
                    paginationText += ` (${hiddenCount} ignored hidden)`;
                }
            } else {
                paginationText = hideIgnored ? 'All transactions hidden (ignored)' : 'No transactions';
            }
            document.getElementById('paginationInfo').textContent = paginationText;

            // Update prev/next buttons
            const prevPage = document.getElementById('prevPage');
            const nextPage = document.getElementById('nextPage');

            if (currentPage <= 1) {
                prevPage.classList.add('disabled');
            } else {
                prevPage.classList.remove('disabled');
            }

            if (currentPage >= totalPages) {
                nextPage.classList.add('disabled');
            } else {
                nextPage.classList.remove('disabled');
            }
        }

        async function loadSummary() {
            try {
                const response = await fetch('/statements/api/summary');
                const data = await response.json();

                if (data.success) {
                    const s = data.summary.by_status;
                    const total = Object.values(s).reduce((acc, v) => acc + v.count, 0);
                    totalTransactions = total;  // Update pagination total

                    const pending = s.pending?.count || 0;
                    const resolved = s.resolved?.count || 0;
                    const ignored = s.ignored?.count || 0;

                    // Base for percentage calculation excludes ignored transactions
                    const activeTotal = pending + resolved;

                    // Helper function to calculate and display percentage (excluding ignored)
                    const setPctDisplay = (elementId, count) => {
                        const pct = activeTotal > 0 ? Math.round((count / activeTotal) * 100) : 0;
                        document.getElementById(elementId).textContent = pct > 0 ? `(${pct}%)` : '';
                    };

                    // Update main cards
                    document.getElementById('totalCount').textContent = total;
                    document.getElementById('pendingCount').textContent = pending;
                    document.getElementById('resolvedCount').textContent = resolved;
                    document.getElementById('ignoredCount').textContent = ignored;

                    // Update compact badges
                    document.getElementById('totalCountCompact').textContent = total;
                    document.getElementById('pendingCountCompact').textContent = pending;
                    document.getElementById('resolvedCountCompact').textContent = resolved;
                    document.getElementById('ignoredCountCompact').textContent = ignored;

                    // Set percentages (only for pending/resolved, not ignored)
                    setPctDisplay('pendingPct', pending);
                    setPctDisplay('resolvedPct', resolved);

                    // Update filter dropdowns
                    updateCompanyFilter(data.summary.by_company);
                    updateSupplierFilter(data.summary.by_supplier);

                    // Update pagination info
                    updatePagination();
                }
            } catch (error) {
                console.error('Load summary error:', error);
            }
        }

        function updateCompanyFilter(companies) {
            const select = document.getElementById('filterCompany');
            const current = select.value;
            select.innerHTML = '<option value="">All Companies</option>';
            companies.forEach(c => {
                select.innerHTML += `<option value="${c.company_cui}">${c.company_name} (${c.count})</option>`;
            });
            select.value = current;
        }

        function updateSupplierFilter(suppliers) {
            const select = document.getElementById('filterSupplier');
            const current = select.value;
            select.innerHTML = '<option value="">All Suppliers</option>';
            suppliers.forEach(s => {
                select.innerHTML += `<option value="${s.matched_supplier}">${s.matched_supplier} (${s.count})</option>`;
            });
            select.value = current;
        }

        function updateFilterOptions() {
            // Additional filter updates if needed
        }

        function clearFilters() {
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterCompany').value = '';
            document.getElementById('filterSupplier').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            loadTransactions();
        }

        function exportCSV() {
            // Build URL with current filters
            const params = new URLSearchParams();

            const status = document.getElementById('filterStatus').value;
            const company = document.getElementById('filterCompany').value;
            const supplier = document.getElementById('filterSupplier').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            if (status) params.append('status', status);
            if (company) params.append('company_cui', company);
            if (supplier) params.append('supplier', supplier);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);

            // Trigger download
            window.location.href = '/statements/api/export/csv?' + params.toString();
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ro-RO') + ' ' + date.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });
        }

        function renderTransactions() {
            const tbody = document.getElementById('transactionsBody');
            const statusFilter = document.getElementById('filterStatus').value;
            const visibleCols = columnConfig.filter(c => c.visible);

            // Filter out ignored transactions if hideIgnored is true
            // (unless user explicitly filtered by "ignored" status)
            let displayTransactions = transactions;
            if (hideIgnored && statusFilter !== 'ignored') {
                displayTransactions = transactions.filter(txn => txn.status !== 'ignored');
            }

            // Always hide merged source transactions (they show in the expand view)
            displayTransactions = displayTransactions.filter(txn => txn.status !== 'merged');

            if (displayTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${visibleCols.length}" class="text-center text-muted py-4">
                            ${hideIgnored && transactions.length > 0
                                ? 'All transactions are ignored. Toggle "Hide Ignored" to see them.'
                                : 'No transactions found. Upload bank statements to get started.'}
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            displayTransactions.forEach(txn => {
                const isExpanded = expandedMergedIds.has(txn.id);

                // Render row using column config
                html += `<tr class="transaction-row ${txn.status}${txn.is_merged_result ? ' merged-result' : ''}" data-id="${txn.id}">`;
                visibleCols.forEach(col => {
                    html += renderCellContent(col, txn);
                });
                html += `</tr>`;

                // If this is a merged result and it's expanded, show the source transactions
                if (txn.is_merged_result && isExpanded && mergedSourcesCache[txn.id]) {
                    const sources = mergedSourcesCache[txn.id];
                    sources.forEach(src => {
                        html += `<tr class="merged-source-row" style="background-color: #f0f9ff !important;">`;
                        html += renderMergedSourceCells(src);
                        html += `</tr>`;
                    });
                }
            });

            tbody.innerHTML = html;

            updateSelectionButtons();
            // Initialize popovers for invoice links
            initPopovers();
        }

        // Toggle expand/collapse for merged transactions
        async function toggleMergedExpand(mergedId) {
            if (expandedMergedIds.has(mergedId)) {
                // Collapse
                expandedMergedIds.delete(mergedId);
                renderTransactions();
            } else {
                // Expand - fetch source transactions if not cached
                if (!mergedSourcesCache[mergedId]) {
                    try {
                        const response = await fetch(`/statements/api/transactions/${mergedId}/merged-sources`);
                        const data = await response.json();
                        if (data.success) {
                            mergedSourcesCache[mergedId] = data.sources;
                        } else {
                            showToast('Failed to load merged sources', 'error');
                            return;
                        }
                    } catch (error) {
                        console.error('Error loading merged sources:', error);
                        showToast('Failed to load merged sources', 'error');
                        return;
                    }
                }
                expandedMergedIds.add(mergedId);
                renderTransactions();
            }
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'resolved': 'success',
                'ignored': 'secondary',
                'merged': 'secondary'
            };
            return colors[status] || 'secondary';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('ro-RO');
        }

        function formatNumber(num) {
            if (num == null) return '-';
            return num.toLocaleString('ro-RO', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function buildInvoicePopoverContent(txn) {
            // Build HTML content for invoice details popover
            let content = '<div class="invoice-popover-content">';
            content += `<div class="mb-1"><strong>Invoice #:</strong> ${escapeHtml(txn.invoice_number || '#' + txn.invoice_id)}</div>`;
            if (txn.linked_invoice_supplier) {
                content += `<div class="mb-1"><strong>Supplier:</strong> ${escapeHtml(txn.linked_invoice_supplier)}</div>`;
            }
            if (txn.linked_invoice_company) {
                content += `<div class="mb-1"><strong>To:</strong> ${escapeHtml(txn.linked_invoice_company)}</div>`;
            }
            if (txn.linked_invoice_value) {
                content += `<div class="mb-1"><strong>Value:</strong> ${formatNumber(txn.linked_invoice_value)} ${txn.linked_invoice_currency || 'RON'}`;
                if (txn.linked_invoice_value_ron && txn.linked_invoice_currency !== 'RON') {
                    content += ` <small class="text-muted">(${formatNumber(txn.linked_invoice_value_ron)} RON)</small>`;
                }
                content += '</div>';
            }
            if (txn.linked_invoice_date) {
                content += `<div class="mb-1"><strong>Date:</strong> ${formatDate(txn.linked_invoice_date)}</div>`;
            }
            content += '</div>';
            return content;
        }

        function buildSuggestedInvoicePopoverContent(txn) {
            // Build HTML content for suggested invoice details popover
            let content = '<div class="invoice-popover-content">';
            content += `<div class="mb-1"><strong>Invoice #:</strong> ${escapeHtml(txn.suggested_invoice_number || '#' + txn.suggested_invoice_id)}</div>`;
            if (txn.suggested_invoice_supplier) {
                content += `<div class="mb-1"><strong>Supplier:</strong> ${escapeHtml(txn.suggested_invoice_supplier)}</div>`;
            }
            if (txn.suggested_invoice_company) {
                content += `<div class="mb-1"><strong>To:</strong> ${escapeHtml(txn.suggested_invoice_company)}</div>`;
            }
            if (txn.suggested_invoice_value) {
                content += `<div class="mb-1"><strong>Value:</strong> ${formatNumber(txn.suggested_invoice_value)} ${txn.suggested_invoice_currency || 'RON'}`;
                if (txn.suggested_invoice_value_ron && txn.suggested_invoice_currency !== 'RON') {
                    content += ` <small class="text-muted">(${formatNumber(txn.suggested_invoice_value_ron)} RON)</small>`;
                }
                content += '</div>';
            }
            if (txn.suggested_invoice_date) {
                content += `<div class="mb-1"><strong>Date:</strong> ${formatDate(txn.suggested_invoice_date)}</div>`;
            }
            if (txn.match_confidence) {
                const confidencePercent = Math.round(txn.match_confidence * 100);
                const confidenceColor = confidencePercent >= 80 ? 'success' : (confidencePercent >= 60 ? 'warning' : 'danger');
                content += `<div class="mb-1"><strong>Confidence:</strong> <span class="badge bg-${confidenceColor}">${confidencePercent}%</span></div>`;
            }
            if (txn.match_method) {
                content += `<div class="mb-1"><strong>Method:</strong> ${txn.match_method}</div>`;
            }
            content += '</div>';
            return content;
        }

        function initPopovers() {
            // Dispose existing popovers first (both linked and suggested)
            document.querySelectorAll('.invoice-popover, .suggested-invoice-popover').forEach(el => {
                const existingPopover = bootstrap.Popover.getInstance(el);
                if (existingPopover) {
                    existingPopover.dispose();
                }
            });

            // Initialize popovers for linked invoices
            document.querySelectorAll('.invoice-popover').forEach(el => {
                const txnId = parseInt(el.dataset.txnId);
                const txn = transactions.find(t => t.id === txnId);
                if (txn) {
                    const content = buildInvoicePopoverContent(txn);
                    new bootstrap.Popover(el, {
                        container: 'body',
                        placement: 'left',
                        trigger: 'hover focus',
                        html: true,
                        title: '<i class="bi bi-receipt-cutoff"></i> Invoice Details',
                        content: content
                    });
                }
            });

            // Initialize popovers for suggested invoices
            document.querySelectorAll('.suggested-invoice-popover').forEach(el => {
                const txnId = parseInt(el.dataset.txnId);
                const txn = transactions.find(t => t.id === txnId);
                if (txn) {
                    const content = buildSuggestedInvoicePopoverContent(txn);
                    new bootstrap.Popover(el, {
                        container: 'body',
                        placement: 'left',
                        trigger: 'hover focus',
                        html: true,
                        title: '<i class="bi bi-question-circle text-warning"></i> Suggested Match',
                        content: content
                    });
                }
            });
        }

        // Selection
        function toggleSelection(id) {
            if (selectedTransactionIds.has(id)) {
                selectedTransactionIds.delete(id);
            } else {
                selectedTransactionIds.add(id);
            }
            updateSelectionButtons();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            if (checkbox.checked) {
                transactions.forEach(t => selectedTransactionIds.add(t.id));
            } else {
                selectedTransactionIds.clear();
            }
            renderTransactions();
        }

        function selectAll() {
            transactions.forEach(t => selectedTransactionIds.add(t.id));
            renderTransactions();
        }

        function selectNone() {
            selectedTransactionIds.clear();
            renderTransactions();
        }

        function selectMatched() {
            selectedTransactionIds.clear();
            transactions.filter(t => t.status === 'resolved').forEach(t => selectedTransactionIds.add(t.id));
            renderTransactions();
        }

        function updateSelectionButtons() {
            const count = selectedTransactionIds.size;
            document.getElementById('bulkIgnoreBtn').disabled = count === 0;
            // Link Invoice requires exactly 1 transaction selected
            document.getElementById('linkInvoiceBtn').disabled = count !== 1;
            // Merge requires 2+ selected transactions
            updateMergeButtonState();
        }

        function updateMergeButtonState() {
            const mergeBtn = document.getElementById('mergeSelectedBtn');
            const selected = Array.from(selectedTransactionIds);

            if (selected.length < 2) {
                mergeBtn.disabled = true;
                mergeBtn.title = 'Select at least 2 transactions to merge';
                return;
            }

            // Get selected transactions data
            const txns = selected.map(id => transactions.find(t => t.id === id)).filter(t => t);

            // Check all are pending (not merged, resolved, ignored)
            const nonPending = txns.filter(t => t.status !== 'pending');
            if (nonPending.length > 0) {
                mergeBtn.disabled = true;
                mergeBtn.title = 'Only pending transactions can be merged';
                return;
            }

            // Check same currency
            const currencies = new Set(txns.map(t => t.currency || 'RON'));
            if (currencies.size > 1) {
                mergeBtn.disabled = true;
                mergeBtn.title = 'Cannot merge: different currencies';
                return;
            }

            // Check same supplier (matched_supplier or vendor_name)
            const suppliers = new Set(txns.map(t => t.matched_supplier || t.vendor_name || '-'));
            if (suppliers.size > 1) {
                mergeBtn.disabled = true;
                mergeBtn.title = 'Cannot merge: different suppliers';
                return;
            }

            // All checks passed
            mergeBtn.disabled = false;
            mergeBtn.title = `Merge ${selected.length} transactions`;
        }

        // Actions
        async function ignoreTransaction(id) {
            await updateTransactionStatus(id, 'ignored');
        }

        async function unignoreTransaction(id) {
            await updateTransactionStatus(id, 'pending');
        }

        async function unlinkInvoice(transactionId) {
            if (!confirm('Are you sure you want to unlink this invoice from the transaction?')) {
                return;
            }

            try {
                const response = await fetch(`/statements/api/transactions/${transactionId}/unlink`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Invoice unlinked successfully', 'success');
                    loadTransactions(false);
                } else {
                    showToast('Error: ' + (data.error || 'Failed to unlink invoice'), 'error');
                }
            } catch (error) {
                console.error('Unlink error:', error);
                showToast('Failed to unlink invoice: ' + error.message, 'error');
            }
        }

        async function updateTransactionStatus(id, status) {
            try {
                const response = await fetch(`/statements/api/transactions/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    loadTransactions();
                }
            } catch (error) {
                console.error('Update error:', error);
            }
        }

        // Inline Status Editing
        let statusChangeTimeout = null;

        function handleStatusChange(selectElement) {
            const id = parseInt(selectElement.dataset.id);
            const newStatus = selectElement.value;
            const originalStatus = selectElement.dataset.original;

            // Clear any pending save
            if (statusChangeTimeout) {
                clearTimeout(statusChangeTimeout);
            }

            // Add loading indicator
            selectElement.classList.add('opacity-50');
            selectElement.disabled = true;

            // Debounce: save after 300ms
            statusChangeTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/statements/api/transactions/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update the original value
                        selectElement.dataset.original = newStatus;
                        // Update the row class
                        const row = selectElement.closest('tr');
                        row.className = `transaction-row ${newStatus}`;
                        // Update local state
                        const txn = transactions.find(t => t.id === id);
                        if (txn) txn.status = newStatus;
                        showToast(`Status updated to ${newStatus}`, 'success', 2000);
                        // Refresh summary counts
                        loadSummary();
                    } else {
                        // Revert on failure
                        selectElement.value = originalStatus;
                        showToast('Failed to update status: ' + (data.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Status update error:', error);
                    // Revert on error
                    selectElement.value = originalStatus;
                    showToast('Failed to update status: ' + error.message, 'error');
                } finally {
                    selectElement.classList.remove('opacity-50');
                    selectElement.disabled = false;
                }
            }, 300);
        }

        async function bulkIgnore() {
            if (selectedTransactionIds.size === 0) return;

            if (!confirm(`Ignore ${selectedTransactionIds.size} transactions?`)) return;

            try {
                const response = await fetch('/statements/api/transactions/bulk-ignore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transaction_ids: Array.from(selectedTransactionIds) })
                });

                const data = await response.json();
                if (data.success) {
                    selectedTransactionIds.clear();
                    loadTransactions();
                }
            } catch (error) {
                console.error('Bulk ignore error:', error);
            }
        }

        // Merge Transaction Functions
        function showMergeModal() {
            if (selectedTransactionIds.size < 2) {
                showToast('Select at least 2 transactions to merge', 'warning');
                return;
            }

            const txns = Array.from(selectedTransactionIds)
                .map(id => transactions.find(t => t.id === id))
                .filter(t => t);

            // Validate same currency
            const currencies = new Set(txns.map(t => t.currency || 'RON'));
            if (currencies.size > 1) {
                showToast('Cannot merge transactions with different currencies', 'error');
                return;
            }

            // Validate same supplier
            const suppliers = new Set(txns.map(t => t.matched_supplier || t.vendor_name || '-'));
            if (suppliers.size > 1) {
                showToast('Cannot merge transactions with different suppliers', 'error');
                return;
            }

            // Calculate totals
            const total = txns.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
            const latestDate = txns.reduce((max, t) =>
                t.transaction_date > max ? t.transaction_date : max,
                txns[0].transaction_date
            );

            // Populate modal
            document.getElementById('mergeCount').textContent = txns.length;
            document.getElementById('mergeTotal').textContent = formatNumber(total);
            document.getElementById('mergeCurrency').textContent = txns[0].currency || 'RON';
            document.getElementById('mergeDate').textContent = formatDate(latestDate);
            document.getElementById('mergeSupplier').textContent = txns[0].matched_supplier || txns[0].vendor_name || '-';

            // Preview list
            const listHtml = txns.map(t => `
                <div class="list-group-item py-2 px-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted small">${formatDate(t.transaction_date)}</span>
                            <span class="ms-2">${t.description?.substring(0, 40) || '-'}${(t.description?.length || 0) > 40 ? '...' : ''}</span>
                        </div>
                        <strong class="${t.amount < 0 ? 'text-danger' : 'text-success'}">${formatNumber(t.amount)} ${t.currency || 'RON'}</strong>
                    </div>
                </div>
            `).join('');
            document.getElementById('mergePreviewList').innerHTML = listHtml;

            // Hide any previous error
            document.getElementById('mergeError').classList.add('d-none');

            new bootstrap.Modal(document.getElementById('mergeModal')).show();
        }

        async function confirmMerge() {
            const ids = Array.from(selectedTransactionIds);

            try {
                document.getElementById('confirmMergeBtn').disabled = true;
                document.getElementById('confirmMergeBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Merging...';

                const response = await fetch('/statements/api/transactions/merge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ transaction_ids: ids })
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('mergeModal')).hide();
                    showToast(`Merged ${ids.length} transactions successfully`, 'success');
                    selectedTransactionIds.clear();
                    loadTransactions();
                } else {
                    document.getElementById('mergeError').classList.remove('d-none');
                    document.getElementById('mergeErrorText').textContent = data.error || 'Merge failed';
                }
            } catch (error) {
                console.error('Merge error:', error);
                document.getElementById('mergeError').classList.remove('d-none');
                document.getElementById('mergeErrorText').textContent = error.message;
            } finally {
                document.getElementById('confirmMergeBtn').disabled = false;
                document.getElementById('confirmMergeBtn').innerHTML = '<i class="bi bi-union"></i> Merge Transactions';
            }
        }

        async function unmergeTransaction(mergedId) {
            if (!confirm('Unmerge this transaction? The original transactions will be restored.')) {
                return;
            }

            try {
                const response = await fetch(`/statements/api/transactions/${mergedId}/unmerge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    // Clear cache and expanded state for this merged transaction
                    delete mergedSourcesCache[mergedId];
                    expandedMergedIds.delete(mergedId);
                    showToast(`Unmerged transaction, restored ${data.restored_count} original transactions`, 'success');
                    loadTransactions();
                } else {
                    showToast('Error: ' + (data.error || 'Unmerge failed'), 'error');
                }
            } catch (error) {
                console.error('Unmerge error:', error);
                showToast('Failed to unmerge: ' + error.message, 'error');
            }
        }

        // Link Invoice Functions
        function openLinkModal(txn) {
            // Populate modal with transaction info
            document.getElementById('linkTxnDate').textContent = formatDate(txn.transaction_date);
            document.getElementById('linkTxnAmount').textContent = `${formatNumber(txn.amount)} ${txn.currency}`;
            document.getElementById('linkTxnVendor').textContent = txn.matched_supplier || txn.vendor_name || '-';
            document.getElementById('linkTxnDescription').textContent = txn.description?.substring(0, 100) || '';

            // Store transaction ID
            document.getElementById('selectedTransactionId').value = txn.id;
            document.getElementById('selectedInvoiceId').value = '';
            document.getElementById('invoiceSearchInput').value = '';
            document.getElementById('invoiceSearchResults').innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-search fs-3"></i>
                    <p class="mb-0">Search for an invoice above</p>
                </div>
            `;
            document.getElementById('confirmLinkBtn').disabled = true;

            new bootstrap.Modal(document.getElementById('linkInvoiceModal')).show();
        }

        function linkSingleTransaction(txnId) {
            // Direct link for a single transaction (from action button)
            const txn = transactions.find(t => t.id === txnId);
            if (!txn) {
                showToast('Transaction not found', 'error');
                return;
            }
            if (txn.status === 'resolved') {
                showToast('This transaction is already linked to an invoice', 'warning');
                return;
            }
            openLinkModal(txn);
        }

        function linkInvoice() {
            if (selectedTransactionIds.size !== 1) {
                showToast('Please select exactly one transaction to link', 'warning');
                return;
            }

            const txnId = Array.from(selectedTransactionIds)[0];
            const txn = transactions.find(t => t.id === txnId);

            if (!txn) {
                showToast('Transaction not found', 'error');
                return;
            }

            if (txn.status === 'resolved') {
                showToast('This transaction is already linked to an invoice', 'warning');
                return;
            }

            openLinkModal(txn);
        }

        async function searchInvoices() {
            const query = document.getElementById('invoiceSearchInput').value.trim();
            if (query.length < 2) {
                showToast('Please enter at least 2 characters to search', 'warning');
                return;
            }

            const resultsDiv = document.getElementById('invoiceSearchResults');
            resultsDiv.innerHTML = '<div class="text-center py-3"><span class="spinner-border spinner-border-sm"></span> Searching...</div>';

            try {
                const response = await fetch(`/api/invoices/search?q=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();

                if (!data.success || !data.invoices || data.invoices.length === 0) {
                    resultsDiv.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-search fs-3"></i>
                            <p class="mb-0">No invoices found matching "${escapeHtml(query)}"</p>
                        </div>
                    `;
                    return;
                }

                resultsDiv.innerHTML = data.invoices.map(inv => `
                    <div class="invoice-result-item p-2 border-bottom ${document.getElementById('selectedInvoiceId').value == inv.id ? 'bg-primary-subtle' : ''}"
                         style="cursor: pointer;"
                         onclick="selectInvoiceForLink(${inv.id}, '${escapeHtml(inv.invoice_number)}', '${escapeHtml(inv.supplier)}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${escapeHtml(inv.invoice_number)}</strong>
                                <span class="badge bg-secondary ms-2">#${inv.id}</span>
                            </div>
                            <span class="text-primary fw-bold">${formatNumber(inv.invoice_value)} ${inv.currency}</span>
                        </div>
                        <div class="small text-muted">
                            <span>${escapeHtml(inv.supplier)}</span> 
                            <span>${formatDate(inv.invoice_date)}</span>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="bi bi-exclamation-triangle fs-3"></i>
                        <p class="mb-0">Search failed: ${error.message}</p>
                    </div>
                `;
            }
        }

        function selectInvoiceForLink(invoiceId, invoiceNumber, supplier) {
            document.getElementById('selectedInvoiceId').value = invoiceId;
            document.getElementById('confirmLinkBtn').disabled = false;

            // Highlight selected invoice
            document.querySelectorAll('.invoice-result-item').forEach(item => {
                item.classList.remove('bg-primary-subtle');
            });
            event.currentTarget.classList.add('bg-primary-subtle');

            showToast(`Selected: ${invoiceNumber} (${supplier})`, 'info', 2000);
        }

        async function confirmLinkInvoice() {
            const transactionId = document.getElementById('selectedTransactionId').value;
            const invoiceId = document.getElementById('selectedInvoiceId').value;

            if (!transactionId || !invoiceId) {
                showToast('Please select an invoice to link', 'warning');
                return;
            }

            showLoading('Linking invoice...');

            try {
                const response = await fetch('/statements/api/transactions/link-invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_id: parseInt(transactionId),
                        invoice_id: parseInt(invoiceId)
                    })
                });

                const data = await response.json();

                bootstrap.Modal.getInstance(document.getElementById('linkInvoiceModal')).hide();

                if (data.success) {
                    showToast('Invoice linked successfully!', 'success');
                    selectedTransactionIds.clear();
                    loadTransactions();
                } else {
                    showToast('Error: ' + (data.error || 'Failed to link invoice'), 'error');
                }
            } catch (error) {
                console.error('Link invoice error:', error);
                showToast('Failed to link invoice: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Enter key to search in modal
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('invoiceSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchInvoices();
                    }
                });
            }
        });

        // Loading
        function showLoading(text) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.progress-text').textContent = text || 'Processing...';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Auto-Match Invoices
        async function autoMatchInvoices() {
            // Get selected transactions or fall back to all pending/matched if none selected
            let txnIds = [];
            let message = '';

            if (selectedTransactionIds.size > 0) {
                // Use selected transactions only
                txnIds = Array.from(selectedTransactionIds);
                message = `Auto-match ${txnIds.length} selected transaction(s) with existing invoices?\n\nMatching by exact amount first.`;
            } else {
                showToast('Please select transactions to auto-match', 'warning');
                return;
            }

            if (!confirm(message)) {
                return;
            }

            showLoading('Running auto-match...');

            try {
                const response = await fetch('/statements/api/transactions/auto-match', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        transaction_ids: txnIds,
                        use_ai: false,  // Disable AI, use exact amount matching
                        min_confidence: 0.5  // Lower threshold since we prioritize exact amount
                    })
                });

                const data = await response.json();

                if (data.success) {
                    let message = `Auto-Match Results:\n`;
                    message += ` Auto-linked: ${data.matched} transactions\n`;
                    message += `? Suggested: ${data.suggested} (need review)\n`;
                    message += ` Unmatched: ${data.unmatched}`;

                    showToast(message, data.matched > 0 ? 'success' : 'info', 8000);
                    loadTransactions(false);
                    loadSummary();
                } else {
                    showToast('Auto-match failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Auto-match error:', error);
                showToast('Auto-match failed: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Accept suggested invoice match
        async function acceptSuggestedMatch(transactionId) {
            showLoading('Accepting match...');
            try {
                const response = await fetch(`/statements/api/transactions/${transactionId}/accept-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });

                // Try to parse JSON response
                let data;
                try {
                    data = await response.json();
                } catch (parseError) {
                    // Not JSON - likely a redirect or error page
                    console.error('Failed to parse JSON:', response.status, response.url);
                    if (response.redirected || response.url.includes('login')) {
                        showToast('Session expired. Please refresh the page and login.', 'error');
                    } else {
                        showToast('Server error (status ' + response.status + ')', 'error');
                    }
                    return;
                }

                if (data.success) {
                    showToast('Match accepted!', 'success', 2000);
                    loadTransactions(false);
                    loadSummary();
                } else {
                    showToast('Failed to accept match: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Accept match error:', error);
                showToast('Failed to accept match: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Reject suggested invoice match
        async function rejectSuggestedMatch(transactionId) {
            try {
                const response = await fetch(`/statements/api/transactions/${transactionId}/reject-match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Suggestion rejected', 'info', 2000);
                    loadTransactions(false);
                } else {
                    showToast('Failed to reject: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Reject match error:', error);
                showToast('Failed to reject: ' + error.message, 'error');
            }
        }

        // Toast Notifications
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';

            const iconClass = {
                'success': 'bi-check-circle',
                'error': 'bi-x-circle',
                'warning': 'bi-exclamation-triangle',
                'info': 'bi-info-circle'
            }[type] || 'bi-info-circle';

            const textClass = type === 'warning' ? 'text-dark' : 'text-white';

            const toastHtml = `
                <div id="${toastId}" class="toast ${bgClass} ${textClass}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} ${textClass}">
                        <i class="bi ${iconClass} me-2"></i>
                        <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                        <button type="button" class="btn-close ${type === 'warning' ? '' : 'btn-close-white'}" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();

            // Remove from DOM after hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Online users tracking
        let onlineUsersInterval = null;
        let onlineUsersTooltip = null;

        async function initOnlineUsersTracking() {
            // Send initial heartbeat and wait for it to complete
            await sendHeartbeat();
            // Update online users count immediately after heartbeat
            await updateOnlineUsersCount();

            // Send heartbeat every 60 seconds
            setInterval(sendHeartbeat, 60000);
            // Update online users count every 30 seconds
            onlineUsersInterval = setInterval(updateOnlineUsersCount, 30000);
        }

        async function sendHeartbeat() {
            try {
                await fetch('/api/heartbeat', { method: 'POST' });
            } catch (e) {
                console.error('Heartbeat failed:', e);
            }
        }

        async function updateOnlineUsersCount() {
            try {
                const res = await fetch('/api/online-users');
                const data = await res.json();
                const countEl = document.getElementById('onlineUsersCount');
                const indicatorEl = document.getElementById('onlineUsersIndicator');
                if (countEl) {
                    countEl.textContent = data.count;
                    // Update Bootstrap tooltip with user names
                    if (indicatorEl && data.users) {
                        // Initialize tooltip if not already done
                        if (!onlineUsersTooltip) {
                            onlineUsersTooltip = new bootstrap.Tooltip(indicatorEl);
                        }
                        // Build tooltip content with user names on separate lines
                        let tooltipContent = '<strong>Online Users:</strong>';
                        if (data.users.length > 0) {
                            tooltipContent += '<br>' + data.users.map(u => u.name).join('<br>');
                        } else {
                            tooltipContent += '<br><em>No users online</em>';
                        }
                        indicatorEl.setAttribute('data-bs-original-title', tooltipContent);
                    }
                }
            } catch (e) {
                console.error('Failed to get online users:', e);
            }
        }

        // Initialize online users tracking on page load
        document.addEventListener('DOMContentLoaded', function() {
            initOnlineUsersTracking();
        });
    </script>
</body>
</html>
