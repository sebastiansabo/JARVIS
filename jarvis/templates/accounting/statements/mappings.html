<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Vendor Mappings</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        .pattern-code { font-family: monospace; font-size: 0.85em; }
        .mapping-inactive { opacity: 0.5; }
        .test-result { max-height: 200px; overflow-y: auto; }
        .test-match { background-color: var(--bs-success-bg-subtle); padding: 2px 4px; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="progress-text">Processing...</div>
    </div>

    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid px-4">
            <a class="navbar-brand mb-0 h1" href="/" id="navbarLogo">
                <span class="navbar-logo-icon"></span> J.A.R.V.I.S.
            </a>
            <span class="navbar-text text-white me-auto ms-3">
                <i class="bi bi-diagram-3"></i> Vendor Mappings
                <span class="badge bg-light text-success ms-2" id="onlineUsersIndicator" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" title="Loading..." style="cursor: pointer; font-size: 0.7rem;">
                    <i class="bi bi-circle-fill text-success" style="font-size: 0.4rem;"></i> <span id="onlineUsersCount">-</span> online
                </span>
            </span>
            <div class="d-flex align-items-center">
                <!-- Theme Toggle -->
                <div class="theme-switch">
                    <i class="bi bi-sun-fill"></i>
                    <input type="checkbox" id="themeToggle" title="Toggle Dark/Light Theme">
                    <i class="bi bi-moon-fill"></i>
                </div>
                <a href="/statements/" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-bank"></i> Bank Statements
                </a>
                {% if current_user.can_access_accounting %}
                <a href="/accounting" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-person-circle"></i> {{ current_user.name }}
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li><span class="dropdown-item-text text-muted small">{{ current_user.email }}</span></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/guide"><i class="bi bi-book"></i> User Guide</a></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editProfileModal"><i class="bi bi-person"></i> Edit Profile</a></li>
                        {% if current_user.can_access_settings %}
                        <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear"></i> Jarvis Settings</a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item"><a href="/statements/">Statements</a></li>
                    <li class="breadcrumb-item active">Mappings</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Add New Mapping Section -->
        <div class="row mb-4">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" onclick="toggleAddSection()">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Add New Mapping</h5>
                        <i class="bi bi-chevron-down" id="addToggleIcon"></i>
                    </div>
                    <div class="card-body" id="addBody">
                        <form id="addMappingForm" onsubmit="createMapping(event)">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Regex Pattern <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" class="form-control pattern-code" id="newPattern"
                                               placeholder="e.g., VENDOR\s*\*" required>
                                        <button type="button" class="btn btn-outline-secondary" onclick="testPattern('new')" title="Test Pattern">
                                            <i class="bi bi-play-circle"></i> Test
                                        </button>
                                    </div>
                                    <small class="text-muted">Case-insensitive regex pattern to match transaction descriptions</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="newSupplierName"
                                           placeholder="e.g., Meta" required>
                                    <small class="text-muted">Display name for matched transactions</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Supplier VAT</label>
                                    <input type="text" class="form-control" id="newSupplierVat"
                                           placeholder="e.g., IE9692928F">
                                    <small class="text-muted">Optional VAT number for invoice generation</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Invoice Template</label>
                                    <select class="form-select" id="newTemplateId">
                                        <option value="">No template</option>
                                    </select>
                                    <small class="text-muted">Optional template for invoice parsing</small>
                                </div>
                                <div class="col-12" id="newTestResult" style="display: none;">
                                    <div class="alert alert-info mb-0">
                                        <strong>Pattern Test Results:</strong>
                                        <div class="test-result mt-2" id="newTestResultContent"></div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-plus-lg"></i> Create Mapping
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex gap-2 align-items-center">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showInactive" onchange="loadMappings()">
                        <label class="form-check-label" for="showInactive">Show inactive mappings</label>
                    </div>
                    <div class="ms-auto">
                        <span class="text-muted" id="mappingCount">0 mappings</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mappings Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Pattern</th>
                                        <th>Supplier Name</th>
                                        <th>Supplier VAT</th>
                                        <th>Template</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mappingsBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted py-4">
                                            Loading mappings...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Mapping Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="form-label">Regex Pattern <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control pattern-code" id="editPattern" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="testPattern('edit')" title="Test Pattern">
                                <i class="bi bi-play-circle"></i> Test
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editSupplierName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier VAT</label>
                        <input type="text" class="form-control" id="editSupplierVat">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Invoice Template</label>
                        <select class="form-select" id="editTemplateId">
                            <option value="">No template</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">Active</label>
                        </div>
                    </div>
                    <div id="editTestResult" style="display: none;">
                        <div class="alert alert-info mb-0">
                            <strong>Pattern Test Results:</strong>
                            <div class="test-result mt-2" id="editTestResultContent"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMapping()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Pattern Modal -->
    <div class="modal fade" id="testModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test Pattern</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pattern</label>
                        <input type="text" class="form-control pattern-code" id="testPatternInput" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Test String</label>
                        <textarea class="form-control" id="testString" rows="3"
                                  placeholder="Enter a transaction description to test against..."></textarea>
                    </div>
                    <button type="button" class="btn btn-primary mb-3" onclick="runPatternTest()">
                        <i class="bi bi-play-circle"></i> Run Test
                    </button>
                    <div id="testResultBox" style="display: none;">
                        <div class="alert" id="testResultAlert">
                            <div id="testResultMessage"></div>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Unmatched Transactions</h6>
                    <div class="small text-muted mb-2">Click on a transaction to test the pattern against it</div>
                    <div id="unmatchedList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                        <div class="list-group-item text-muted">Loading...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the mapping for <strong id="deleteSupplierName"></strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                    <input type="hidden" id="deleteId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        // State
        let mappings = [];
        let templates = [];
        let unmatchedTransactions = [];
        let currentTestContext = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMappings();
            loadTemplates();
            loadUnmatchedTransactions();
        });

        function toggleAddSection() {
            const body = document.getElementById('addBody');
            const icon = document.getElementById('addToggleIcon');
            if (body.style.display === 'none') {
                body.style.display = 'block';
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
            } else {
                body.style.display = 'none';
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
            }
        }

        // Load Data
        async function loadMappings() {
            const showInactive = document.getElementById('showInactive').checked;
            const params = new URLSearchParams();
            params.append('active_only', !showInactive);

            try {
                const response = await fetch('/statements/api/mappings?' + params.toString());
                const data = await response.json();

                if (data.success) {
                    mappings = data.mappings;
                    renderMappings();
                }
            } catch (error) {
                console.error('Load mappings error:', error);
            }
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();

                if (data.success) {
                    templates = data.templates;
                    populateTemplateDropdowns();
                }
            } catch (error) {
                console.error('Load templates error:', error);
            }
        }

        async function loadUnmatchedTransactions() {
            try {
                const response = await fetch('/statements/api/transactions?status=pending&limit=20');
                const data = await response.json();

                if (data.success) {
                    unmatchedTransactions = data.transactions;
                }
            } catch (error) {
                console.error('Load unmatched error:', error);
            }
        }

        function populateTemplateDropdowns() {
            const selects = ['newTemplateId', 'editTemplateId'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">No template</option>';
                templates.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
            });
        }

        function renderMappings() {
            const tbody = document.getElementById('mappingsBody');
            document.getElementById('mappingCount').textContent = `${mappings.length} mapping${mappings.length !== 1 ? 's' : ''}`;

            if (mappings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            No vendor mappings found. Add one above.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = mappings.map(m => {
                const template = templates.find(t => t.id === m.template_id);
                const createdDate = m.created_at ? new Date(m.created_at).toLocaleDateString('ro-RO') : '-';

                return `
                    <tr class="${m.is_active ? '' : 'mapping-inactive'}">
                        <td class="pattern-code">${escapeHtml(m.pattern)}</td>
                        <td><strong>${escapeHtml(m.supplier_name)}</strong></td>
                        <td>${m.supplier_vat || '<span class="text-muted">-</span>'}</td>
                        <td>${template ? template.name : '<span class="text-muted">-</span>'}</td>
                        <td>
                            <span class="badge bg-${m.is_active ? 'success' : 'secondary'}">
                                ${m.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="testPatternFromTable(${m.id})" title="Test Pattern">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editMapping(${m.id})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteMapping(${m.id})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create Mapping
        async function createMapping(event) {
            event.preventDefault();

            const pattern = document.getElementById('newPattern').value.trim();
            const supplierName = document.getElementById('newSupplierName').value.trim();
            const supplierVat = document.getElementById('newSupplierVat').value.trim();
            const templateId = document.getElementById('newTemplateId').value;

            // Validate regex
            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern. Please check your syntax.');
                return;
            }

            showLoading('Creating mapping...');

            try {
                const response = await fetch('/statements/api/mappings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern,
                        supplier_name: supplierName,
                        supplier_vat: supplierVat || null,
                        template_id: templateId ? parseInt(templateId) : null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Clear form
                    document.getElementById('addMappingForm').reset();
                    document.getElementById('newTestResult').style.display = 'none';
                    loadMappings();
                    alert('Mapping created successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to create mapping'));
                }
            } catch (error) {
                console.error('Create mapping error:', error);
                alert('Failed to create mapping: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Edit Mapping
        function editMapping(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            document.getElementById('editId').value = mapping.id;
            document.getElementById('editPattern').value = mapping.pattern;
            document.getElementById('editSupplierName').value = mapping.supplier_name;
            document.getElementById('editSupplierVat').value = mapping.supplier_vat || '';
            document.getElementById('editTemplateId').value = mapping.template_id || '';
            document.getElementById('editIsActive').checked = mapping.is_active;
            document.getElementById('editTestResult').style.display = 'none';

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function saveMapping() {
            const id = document.getElementById('editId').value;
            const pattern = document.getElementById('editPattern').value.trim();
            const supplierName = document.getElementById('editSupplierName').value.trim();
            const supplierVat = document.getElementById('editSupplierVat').value.trim();
            const templateId = document.getElementById('editTemplateId').value;
            const isActive = document.getElementById('editIsActive').checked;

            if (!pattern || !supplierName) {
                alert('Pattern and Supplier Name are required');
                return;
            }

            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern. Please check your syntax.');
                return;
            }

            showLoading('Saving mapping...');

            try {
                const response = await fetch(`/statements/api/mappings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern,
                        supplier_name: supplierName,
                        supplier_vat: supplierVat || null,
                        template_id: templateId ? parseInt(templateId) : null,
                        is_active: isActive
                    })
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    loadMappings();
                } else {
                    alert('Error: ' + (data.error || 'Failed to update mapping'));
                }
            } catch (error) {
                console.error('Save mapping error:', error);
                alert('Failed to save mapping: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Delete Mapping
        function deleteMapping(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            document.getElementById('deleteId').value = id;
            document.getElementById('deleteSupplierName').textContent = mapping.supplier_name;

            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        async function confirmDelete() {
            const id = document.getElementById('deleteId').value;

            showLoading('Deleting mapping...');

            try {
                const response = await fetch(`/statements/api/mappings/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    loadMappings();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete mapping'));
                }
            } catch (error) {
                console.error('Delete mapping error:', error);
                alert('Failed to delete mapping: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Pattern Testing
        function validateRegex(pattern) {
            try {
                new RegExp(pattern, 'i');
                return true;
            } catch (e) {
                return false;
            }
        }

        function testPattern(context) {
            currentTestContext = context;
            let pattern = '';

            if (context === 'new') {
                pattern = document.getElementById('newPattern').value;
            } else if (context === 'edit') {
                pattern = document.getElementById('editPattern').value;
            }

            if (!pattern) {
                alert('Please enter a pattern first');
                return;
            }

            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern');
                return;
            }

            document.getElementById('testPatternInput').value = pattern;
            document.getElementById('testString').value = '';
            document.getElementById('testResultBox').style.display = 'none';

            // Populate unmatched transactions
            const list = document.getElementById('unmatchedList');
            if (unmatchedTransactions.length === 0) {
                list.innerHTML = '<div class="list-group-item text-muted">No unmatched transactions found</div>';
            } else {
                list.innerHTML = unmatchedTransactions.map(t => `
                    <button type="button" class="list-group-item list-group-item-action small"
                            onclick="useTransactionForTest('${escapeHtml(t.description?.replace(/\\/g, '\\\\').replace(/'/g, "\\'") || '')}')">
                        ${escapeHtml(t.description?.substring(0, 100) || 'No description')}...
                    </button>
                `).join('');
            }

            new bootstrap.Modal(document.getElementById('testModal')).show();
        }

        function testPatternFromTable(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            currentTestContext = 'table';
            document.getElementById('testPatternInput').value = mapping.pattern;
            document.getElementById('testString').value = '';
            document.getElementById('testResultBox').style.display = 'none';

            // Populate unmatched transactions
            const list = document.getElementById('unmatchedList');
            if (unmatchedTransactions.length === 0) {
                list.innerHTML = '<div class="list-group-item text-muted">No unmatched transactions found</div>';
            } else {
                list.innerHTML = unmatchedTransactions.map(t => `
                    <button type="button" class="list-group-item list-group-item-action small"
                            onclick="useTransactionForTest('${escapeHtml(t.description?.replace(/\\/g, '\\\\').replace(/'/g, "\\'") || '')}')">
                        ${escapeHtml(t.description?.substring(0, 100) || 'No description')}...
                    </button>
                `).join('');
            }

            new bootstrap.Modal(document.getElementById('testModal')).show();
        }

        function useTransactionForTest(description) {
            document.getElementById('testString').value = description;
            runPatternTest();
        }

        function runPatternTest() {
            const pattern = document.getElementById('testPatternInput').value;
            const testString = document.getElementById('testString').value;

            if (!testString) {
                alert('Please enter a test string');
                return;
            }

            const resultBox = document.getElementById('testResultBox');
            const resultAlert = document.getElementById('testResultAlert');
            const resultMessage = document.getElementById('testResultMessage');

            try {
                const regex = new RegExp(pattern, 'i');
                const match = testString.match(regex);

                resultBox.style.display = 'block';

                if (match) {
                    resultAlert.className = 'alert alert-success';
                    const highlighted = testString.replace(regex, `<span class="test-match">${match[0]}</span>`);
                    resultMessage.innerHTML = `
                        <i class="bi bi-check-circle"></i> <strong>Match found!</strong><br>
                        <div class="mt-2">Matched: <code>${escapeHtml(match[0])}</code></div>
                        <div class="mt-2">Preview: ${highlighted}</div>
                    `;
                } else {
                    resultAlert.className = 'alert alert-warning';
                    resultMessage.innerHTML = `
                        <i class="bi bi-x-circle"></i> <strong>No match</strong><br>
                        <div class="mt-2">The pattern did not match the test string.</div>
                    `;
                }
            } catch (e) {
                resultBox.style.display = 'block';
                resultAlert.className = 'alert alert-danger';
                resultMessage.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i> <strong>Regex Error</strong><br>
                    <div class="mt-2">${escapeHtml(e.message)}</div>
                `;
            }
        }

        // Quick inline test for new/edit forms
        function testPatternInline(context) {
            let pattern, resultDiv, resultContent;

            if (context === 'new') {
                pattern = document.getElementById('newPattern').value;
                resultDiv = document.getElementById('newTestResult');
                resultContent = document.getElementById('newTestResultContent');
            } else {
                pattern = document.getElementById('editPattern').value;
                resultDiv = document.getElementById('editTestResult');
                resultContent = document.getElementById('editTestResultContent');
            }

            if (!validateRegex(pattern)) {
                resultDiv.style.display = 'block';
                resultContent.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Invalid regex syntax</span>';
                return;
            }

            // Test against recent unmatched transactions
            const regex = new RegExp(pattern, 'i');
            const matches = unmatchedTransactions.filter(t => regex.test(t.description || ''));

            resultDiv.style.display = 'block';
            if (matches.length > 0) {
                resultContent.innerHTML = `
                    <span class="text-success"><i class="bi bi-check-circle"></i> Would match ${matches.length} unmatched transaction(s):</span>
                    <ul class="mb-0 mt-1">
                        ${matches.slice(0, 3).map(m => `<li class="small">${escapeHtml(m.description?.substring(0, 60) || '')}...</li>`).join('')}
                        ${matches.length > 3 ? `<li class="text-muted small">...and ${matches.length - 3} more</li>` : ''}
                    </ul>
                `;
            } else {
                resultContent.innerHTML = '<span class="text-warning"><i class="bi bi-info-circle"></i> No matches among recent unmatched transactions</span>';
            }
        }

        // Loading
        function showLoading(text) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.progress-text').textContent = text || 'Processing...';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Online users tracking
        let onlineUsersInterval = null;
        let onlineUsersTooltip = null;

        async function initOnlineUsersTracking() {
            await sendHeartbeat();
            await updateOnlineUsersCount();
            setInterval(sendHeartbeat, 60000);
            onlineUsersInterval = setInterval(updateOnlineUsersCount, 30000);
        }

        async function sendHeartbeat() {
            try {
                await fetch('/api/heartbeat', { method: 'POST' });
            } catch (e) {
                console.error('Heartbeat failed:', e);
            }
        }

        async function updateOnlineUsersCount() {
            try {
                const res = await fetch('/api/online-users');
                const data = await res.json();
                const countEl = document.getElementById('onlineUsersCount');
                const indicatorEl = document.getElementById('onlineUsersIndicator');
                if (countEl) {
                    countEl.textContent = data.count;
                    if (indicatorEl && data.users) {
                        if (!onlineUsersTooltip) {
                            onlineUsersTooltip = new bootstrap.Tooltip(indicatorEl);
                        }
                        let tooltipContent = '<strong>Online Users:</strong>';
                        if (data.users.length > 0) {
                            tooltipContent += '<br>' + data.users.map(u => u.name).join('<br>');
                        } else {
                            tooltipContent += '<br><em>No users online</em>';
                        }
                        indicatorEl.setAttribute('data-bs-original-title', tooltipContent);
                    }
                }
            } catch (e) {
                console.error('Failed to get online users:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', initOnlineUsersTracking);
    </script>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel"><i class="bi bi-person"></i> Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="profileName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="profileName" value="{{ current_user.name }}" required minlength="2">
                        </div>
                        <div class="mb-3">
                            <label for="profileEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="profileEmail" value="{{ current_user.email }}" disabled>
                            <small class="text-muted">Contact an administrator to change your email</small>
                        </div>
                        <div class="mb-3">
                            <label for="profilePhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="profilePhone" value="{{ current_user.phone or '' }}" placeholder="Optional">
                        </div>
                    </form>
                    <div class="d-flex justify-content-end mb-3">
                        <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Profile</button>
                    </div>
                    <hr>
                    <h6 class="mb-3"><i class="bi bi-key"></i> Change Password</h6>
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword">
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" minlength="6">
                        </div>
                    </form>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-warning" onclick="changePassword()">Change Password</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function updateProfile() {
            const name = document.getElementById('profileName').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            if (!name || name.length < 2) { alert('Name must be at least 2 characters'); return; }
            try {
                const response = await fetch('/api/auth/update-profile', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, phone }) });
                const result = await response.json();
                if (result.success) { alert('Profile updated successfully'); const btn = document.getElementById('userDropdown'); if (btn) btn.innerHTML = '<i class="bi bi-person-circle"></i> ' + result.name; }
                else { alert('Error: ' + result.error); }
            } catch (e) { alert('Error: ' + e.message); }
        }
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) { alert('Please fill in all password fields'); return; }
            if (newPassword !== confirmPassword) { alert('New passwords do not match'); return; }
            if (newPassword.length < 6) { alert('Password must be at least 6 characters'); return; }
            try {
                const response = await fetch('/api/auth/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ current_password: currentPassword, new_password: newPassword }) });
                const result = await response.json();
                if (result.success) { alert('Password changed successfully'); document.getElementById('changePasswordForm').reset(); }
                else { alert('Error: ' + result.error); }
            } catch (e) { alert('Error: ' + e.message); }
        }
    </script>
    <script src="/static/js/theme.js"></script>
</body>
</html>
