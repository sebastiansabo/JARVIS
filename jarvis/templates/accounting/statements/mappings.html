<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - Vendor Mappings</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        .pattern-code { font-family: monospace; font-size: 0.85em; }
        .mapping-inactive { opacity: 0.5; }
        .test-result { max-height: 200px; overflow-y: auto; }
        .test-match { background-color: var(--bs-success-bg-subtle); padding: 2px 4px; border-radius: 3px; }
        .summary-filter-bar { font-size: 0.85rem; }
        .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
        .summary-stat i { font-size: 1rem; }
        .summary-stat strong { color: var(--bs-body-color); }
        /* Sortable Table Headers */
        .sortable {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .sortable::after {
            content: '\F282';
            font-family: 'bootstrap-icons';
            margin-left: 4px;
            opacity: 0.3;
            font-size: 0.75em;
        }
        .sortable.asc::after {
            content: '\F235';
            opacity: 1;
        }
        .sortable.desc::after {
            content: '\F229';
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="progress-text">Processing...</div>
    </div>

    {% set current_module = 'statements' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/accounting">Accounting</a></li>
                    <li class="breadcrumb-item"><a href="/statements/">Statements</a></li>
                    <li class="breadcrumb-item active">Mappings</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
            {% set active_page = 'statements' %}
            {% set inline_nav = true %}
            {% include 'partials/_accounting_nav.html' %}
            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3" id="summaryStats" style="display: none;">
                <span class="summary-stat" title="Total Mappings">
                    <i class="bi bi-diagram-2 text-primary"></i>
                    <strong id="totalMappingsCompact">0</strong> mappings
                </span>
                <span class="summary-stat" title="Active Mappings">
                    <i class="bi bi-check-circle text-success"></i>
                    <strong id="activeMappingsCompact">0</strong> active
                </span>
            </div>
        </div>

        <!-- Tabs with Add Button -->
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs mb-0">
                <li class="nav-item">
                    <a class="nav-link" href="/statements/">
                        <i class="bi bi-list-ul"></i> Transactions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/statements/files">
                        <i class="bi bi-file-earmark-pdf"></i> Statements
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/statements/mappings">
                        <i class="bi bi-diagram-2"></i> Mappings
                    </a>
                </li>
            </ul>
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMappingModal">
                    <i class="bi bi-plus-lg"></i> Add Mapping
                </button>
            </div>
        </div>

        <!-- Mappings Table -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-diagram-2"></i> Vendor Mappings <span id="mappingCount" class="badge bg-secondary ms-2">0</span></span>
                    <div class="d-flex gap-2 align-items-center">
                        <!-- Search -->
                        <div class="input-group input-group-sm" style="width: 220px;">
                            <input type="text" class="form-control" id="searchInput" placeholder="Search supplier..." oninput="onSearchChange()">
                            <button class="btn btn-outline-secondary" type="button" id="searchBtn" onclick="handleSearchClick()" title="Search">
                                <i class="bi bi-search" id="searchIcon"></i>
                            </button>
                        </div>
                        <!-- Show Inactive -->
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="showInactiveBtn" onclick="toggleShowInactive()" title="Show inactive mappings">
                            <i class="bi bi-eye" id="showInactiveIcon"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light" id="mappingsHeader">
                            <tr>
                                <th class="sortable" onclick="sortMappingsBy('pattern')">Pattern</th>
                                <th class="sortable" onclick="sortMappingsBy('supplier_name')">Supplier Name</th>
                                <th class="sortable" onclick="sortMappingsBy('supplier_vat')">Supplier VAT</th>
                                <th class="sortable" onclick="sortMappingsBy('template_id')">Template</th>
                                <th class="sortable" onclick="sortMappingsBy('is_active')">Status</th>
                                <th class="sortable" onclick="sortMappingsBy('created_at')">Created</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mappingsBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    Loading mappings...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Mapping Modal -->
    <div class="modal fade" id="addMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMappingForm" onsubmit="createMapping(event)">
                        <div class="mb-3">
                            <label class="form-label">Regex Pattern <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control pattern-code" id="newPattern"
                                       placeholder="e.g., VENDOR\s*\*" required>
                                <button type="button" class="btn btn-outline-secondary" onclick="testPattern('new')" title="Test Pattern">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                            </div>
                            <small class="text-muted">Case-insensitive regex pattern to match transaction descriptions</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newSupplierName"
                                   placeholder="e.g., Meta" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Supplier VAT</label>
                            <input type="text" class="form-control" id="newSupplierVat"
                                   placeholder="e.g., IE9692928F">
                            <small class="text-muted">Optional VAT number for invoice generation</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Invoice Template</label>
                            <select class="form-select" id="newTemplateId">
                                <option value="">No template</option>
                            </select>
                        </div>
                        <div id="newTestResult" style="display: none;">
                            <div class="alert alert-info mb-0">
                                <strong>Pattern Test Results:</strong>
                                <div class="test-result mt-2" id="newTestResultContent"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" form="addMappingForm" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Create Mapping
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Mapping Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Mapping</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3">
                        <label class="form-label">Regex Pattern <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control pattern-code" id="editPattern" required>
                            <button type="button" class="btn btn-outline-secondary" onclick="testPattern('edit')" title="Test Pattern">
                                <i class="bi bi-play-circle"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editSupplierName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier VAT</label>
                        <input type="text" class="form-control" id="editSupplierVat">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Invoice Template</label>
                        <select class="form-select" id="editTemplateId">
                            <option value="">No template</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editIsActive">
                            <label class="form-check-label" for="editIsActive">Active</label>
                        </div>
                    </div>
                    <div id="editTestResult" style="display: none;">
                        <div class="alert alert-info mb-0">
                            <strong>Pattern Test Results:</strong>
                            <div class="test-result mt-2" id="editTestResultContent"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMapping()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Pattern Modal -->
    <div class="modal fade" id="testModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-play-circle"></i> Test Pattern</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pattern</label>
                        <input type="text" class="form-control pattern-code" id="testPatternInput" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Test String</label>
                        <textarea class="form-control" id="testString" rows="3"
                                  placeholder="Enter a transaction description to test against..."></textarea>
                    </div>
                    <button type="button" class="btn btn-primary mb-3" onclick="runPatternTest()">
                        <i class="bi bi-play-circle"></i> Run Test
                    </button>
                    <div id="testResultBox" style="display: none;">
                        <div class="alert" id="testResultAlert">
                            <div id="testResultMessage"></div>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Unmatched Transactions</h6>
                    <div class="small text-muted mb-2">Click on a transaction to test the pattern against it</div>
                    <div id="unmatchedList" class="list-group" style="max-height: 200px; overflow-y: auto;">
                        <div class="list-group-item text-muted">Loading...</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // State
        let mappings = [];
        let templates = [];
        let unmatchedTransactions = [];
        let currentTestContext = null;
        let searchTerm = '';
        let showInactive = false;

        // Sorting state
        let sortColumn = localStorage.getItem('statementsMappingsSortColumn') || 'supplier_name';
        let sortDirection = localStorage.getItem('statementsMappingsSortDir') || 'asc';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadMappings();
            loadTemplates();
            loadUnmatchedTransactions();
            updateMappingsTableHeaders();
        });

        // Sorting functions
        function sortMappingsBy(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            localStorage.setItem('statementsMappingsSortColumn', sortColumn);
            localStorage.setItem('statementsMappingsSortDir', sortDirection);
            updateMappingsTableHeaders();
            renderMappings();
        }

        function updateMappingsTableHeaders() {
            document.querySelectorAll('#mappingsHeader th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
                const col = th.getAttribute('onclick')?.match(/sortMappingsBy\('(\w+)'\)/)?.[1];
                if (col === sortColumn) {
                    th.classList.add(sortDirection);
                }
            });
        }

        // Search functionality
        let searchTimeout;
        function onSearchChange() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                updateSearchIcon();
                renderMappings();
            }, 300);
        }

        function updateSearchIcon() {
            const input = document.getElementById('searchInput');
            const icon = document.getElementById('searchIcon');
            const btn = document.getElementById('searchBtn');
            if (input.value.trim()) {
                icon.className = 'bi bi-x-lg';
                btn.title = 'Clear';
            } else {
                icon.className = 'bi bi-search';
                btn.title = 'Search';
            }
        }

        function handleSearchClick() {
            const input = document.getElementById('searchInput');
            if (input.value.trim()) {
                input.value = '';
                searchTerm = '';
                updateSearchIcon();
                renderMappings();
            } else {
                input.focus();
            }
        }

        function toggleShowInactive() {
            showInactive = !showInactive;
            const btn = document.getElementById('showInactiveBtn');
            const icon = document.getElementById('showInactiveIcon');
            if (showInactive) {
                btn.className = 'btn btn-sm btn-warning';
                icon.className = 'bi bi-eye-slash';
                btn.title = 'Hide inactive mappings';
            } else {
                btn.className = 'btn btn-sm btn-outline-secondary';
                icon.className = 'bi bi-eye';
                btn.title = 'Show inactive mappings';
            }
            loadMappings();
        }

        // Load Data
        async function loadMappings() {
            const params = new URLSearchParams();
            params.append('active_only', !showInactive);

            try {
                const response = await fetch('/statements/api/mappings?' + params.toString());
                const data = await response.json();

                if (data.success) {
                    mappings = data.mappings;
                    renderMappings();
                    updateSummary();
                }
            } catch (error) {
                console.error('Load mappings error:', error);
            }
        }

        async function loadTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();

                if (data.success) {
                    templates = data.templates;
                    populateTemplateDropdowns();
                }
            } catch (error) {
                console.error('Load templates error:', error);
            }
        }

        async function loadUnmatchedTransactions() {
            try {
                const response = await fetch('/statements/api/transactions?status=pending&limit=20');
                const data = await response.json();

                if (data.success) {
                    unmatchedTransactions = data.transactions;
                }
            } catch (error) {
                console.error('Load unmatched error:', error);
            }
        }

        function populateTemplateDropdowns() {
            const selects = ['newTemplateId', 'editTemplateId'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">No template</option>';
                templates.forEach(t => {
                    select.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                });
            });
        }

        function updateSummary() {
            const total = mappings.length;
            const active = mappings.filter(m => m.is_active).length;

            document.getElementById('totalMappingsCompact').textContent = total;
            document.getElementById('activeMappingsCompact').textContent = active;
            document.getElementById('summaryStats').style.display = 'flex';
        }

        function renderMappings() {
            const tbody = document.getElementById('mappingsBody');
            const countBadge = document.getElementById('mappingCount');

            // Filter by search
            let filtered = mappings;
            if (searchTerm) {
                filtered = mappings.filter(m =>
                    (m.supplier_name || '').toLowerCase().includes(searchTerm) ||
                    (m.pattern || '').toLowerCase().includes(searchTerm) ||
                    (m.supplier_vat || '').toLowerCase().includes(searchTerm)
                );
            }

            // Sort
            filtered = [...filtered].sort((a, b) => {
                let valA = a[sortColumn];
                let valB = b[sortColumn];
                if (valA == null) valA = '';
                if (valB == null) valB = '';
                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = (valB || '').toLowerCase();
                }
                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            countBadge.textContent = filtered.length;

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            ${searchTerm ? 'No mappings match your search.' : 'No vendor mappings found. Click "Add Mapping" to create one.'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(m => {
                const template = templates.find(t => t.id === m.template_id);
                const createdDate = m.created_at ? new Date(m.created_at).toLocaleDateString('ro-RO') : '-';

                return `
                    <tr class="${m.is_active ? '' : 'mapping-inactive'}">
                        <td class="pattern-code">${escapeHtml(m.pattern)}</td>
                        <td><strong>${escapeHtml(m.supplier_name)}</strong></td>
                        <td>${m.supplier_vat || '<span class="text-muted">-</span>'}</td>
                        <td>${template ? template.name : '<span class="text-muted">-</span>'}</td>
                        <td>
                            <span class="badge bg-${m.is_active ? 'success' : 'secondary'}">
                                ${m.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${createdDate}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" onclick="testPatternFromTable(${m.id})" title="Test Pattern">
                                    <i class="bi bi-play-circle"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="editMapping(${m.id})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteMapping(${m.id})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Create Mapping
        async function createMapping(event) {
            event.preventDefault();

            const pattern = document.getElementById('newPattern').value.trim();
            const supplierName = document.getElementById('newSupplierName').value.trim();
            const supplierVat = document.getElementById('newSupplierVat').value.trim();
            const templateId = document.getElementById('newTemplateId').value;

            // Validate regex
            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern. Please check your syntax.');
                return;
            }

            showLoading('Creating mapping...');

            try {
                const response = await fetch('/statements/api/mappings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern,
                        supplier_name: supplierName,
                        supplier_vat: supplierVat || null,
                        template_id: templateId ? parseInt(templateId) : null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('addMappingForm').reset();
                    document.getElementById('newTestResult').style.display = 'none';
                    bootstrap.Modal.getInstance(document.getElementById('addMappingModal')).hide();
                    loadMappings();
                    showToast('Mapping created successfully!', 'success');
                } else {
                    showToast('Error: ' + (data.error || 'Failed to create mapping'), 'error');
                }
            } catch (error) {
                console.error('Create mapping error:', error);
                showToast('Failed to create mapping: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Edit Mapping
        function editMapping(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            document.getElementById('editId').value = mapping.id;
            document.getElementById('editPattern').value = mapping.pattern;
            document.getElementById('editSupplierName').value = mapping.supplier_name;
            document.getElementById('editSupplierVat').value = mapping.supplier_vat || '';
            document.getElementById('editTemplateId').value = mapping.template_id || '';
            document.getElementById('editIsActive').checked = mapping.is_active;
            document.getElementById('editTestResult').style.display = 'none';

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        async function saveMapping() {
            const id = document.getElementById('editId').value;
            const pattern = document.getElementById('editPattern').value.trim();
            const supplierName = document.getElementById('editSupplierName').value.trim();
            const supplierVat = document.getElementById('editSupplierVat').value.trim();
            const templateId = document.getElementById('editTemplateId').value;
            const isActive = document.getElementById('editIsActive').checked;

            if (!pattern || !supplierName) {
                alert('Pattern and Supplier Name are required');
                return;
            }

            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern. Please check your syntax.');
                return;
            }

            showLoading('Saving mapping...');

            try {
                const response = await fetch(`/statements/api/mappings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern,
                        supplier_name: supplierName,
                        supplier_vat: supplierVat || null,
                        template_id: templateId ? parseInt(templateId) : null,
                        is_active: isActive
                    })
                });

                const data = await response.json();

                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                    loadMappings();
                    showToast('Mapping updated successfully!', 'success');
                } else {
                    showToast('Error: ' + (data.error || 'Failed to update mapping'), 'error');
                }
            } catch (error) {
                console.error('Save mapping error:', error);
                showToast('Failed to save mapping: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Delete Mapping
        async function deleteMapping(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            if (!confirm(`Delete the mapping for "${mapping.supplier_name}"?\n\nThis action cannot be undone.`)) {
                return;
            }

            showLoading('Deleting mapping...');

            try {
                const response = await fetch(`/statements/api/mappings/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    loadMappings();
                    showToast('Mapping deleted successfully', 'success');
                } else {
                    showToast('Error: ' + (data.error || 'Failed to delete mapping'), 'error');
                }
            } catch (error) {
                console.error('Delete mapping error:', error);
                showToast('Failed to delete mapping: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Pattern Testing
        function validateRegex(pattern) {
            try {
                new RegExp(pattern, 'i');
                return true;
            } catch (e) {
                return false;
            }
        }

        function testPattern(context) {
            currentTestContext = context;
            let pattern = '';

            if (context === 'new') {
                pattern = document.getElementById('newPattern').value;
            } else if (context === 'edit') {
                pattern = document.getElementById('editPattern').value;
            }

            if (!pattern) {
                alert('Please enter a pattern first');
                return;
            }

            if (!validateRegex(pattern)) {
                alert('Invalid regex pattern');
                return;
            }

            document.getElementById('testPatternInput').value = pattern;
            document.getElementById('testString').value = '';
            document.getElementById('testResultBox').style.display = 'none';

            populateUnmatchedList();

            new bootstrap.Modal(document.getElementById('testModal')).show();
        }

        function testPatternFromTable(id) {
            const mapping = mappings.find(m => m.id === id);
            if (!mapping) return;

            currentTestContext = 'table';
            document.getElementById('testPatternInput').value = mapping.pattern;
            document.getElementById('testString').value = '';
            document.getElementById('testResultBox').style.display = 'none';

            populateUnmatchedList();

            new bootstrap.Modal(document.getElementById('testModal')).show();
        }

        function populateUnmatchedList() {
            const list = document.getElementById('unmatchedList');
            if (unmatchedTransactions.length === 0) {
                list.innerHTML = '<div class="list-group-item text-muted">No unmatched transactions found</div>';
            } else {
                list.innerHTML = unmatchedTransactions.map(t => `
                    <button type="button" class="list-group-item list-group-item-action small"
                            onclick="useTransactionForTest('${escapeHtml(t.description?.replace(/\\/g, '\\\\').replace(/'/g, "\\'") || '')}')">
                        ${escapeHtml(t.description?.substring(0, 100) || 'No description')}...
                    </button>
                `).join('');
            }
        }

        function useTransactionForTest(description) {
            document.getElementById('testString').value = description;
            runPatternTest();
        }

        function runPatternTest() {
            const pattern = document.getElementById('testPatternInput').value;
            const testString = document.getElementById('testString').value;

            if (!testString) {
                alert('Please enter a test string');
                return;
            }

            const resultBox = document.getElementById('testResultBox');
            const resultAlert = document.getElementById('testResultAlert');
            const resultMessage = document.getElementById('testResultMessage');

            try {
                const regex = new RegExp(pattern, 'i');
                const match = testString.match(regex);

                resultBox.style.display = 'block';

                if (match) {
                    resultAlert.className = 'alert alert-success';
                    const highlighted = testString.replace(regex, `<span class="test-match">${match[0]}</span>`);
                    resultMessage.innerHTML = `
                        <i class="bi bi-check-circle"></i> <strong>Match found!</strong><br>
                        <div class="mt-2">Matched: <code>${escapeHtml(match[0])}</code></div>
                        <div class="mt-2">Preview: ${highlighted}</div>
                    `;
                } else {
                    resultAlert.className = 'alert alert-warning';
                    resultMessage.innerHTML = `
                        <i class="bi bi-x-circle"></i> <strong>No match</strong><br>
                        <div class="mt-2">The pattern did not match the test string.</div>
                    `;
                }
            } catch (e) {
                resultBox.style.display = 'block';
                resultAlert.className = 'alert alert-danger';
                resultMessage.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i> <strong>Regex Error</strong><br>
                    <div class="mt-2">${escapeHtml(e.message)}</div>
                `;
            }
        }

        // Loading
        function showLoading(text) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.progress-text').textContent = text || 'Processing...';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showToast(message, type = 'info', duration = 5000) {
            const container = document.querySelector('.toast-container');
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : type === 'warning' ? 'bg-warning text-dark' : 'bg-info';

            const toast = document.createElement('div');
            toast.className = `toast ${bgClass} text-white`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="toast-body d-flex justify-content-between align-items-start">
                    <span>${escapeHtml(message)}</span>
                    <button type="button" class="btn-close btn-close-white ms-2" data-bs-dismiss="toast"></button>
                </div>
            `;

            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: duration });
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

    </script>
    <script src="/static/js/jarvis-utils.js"></script>
    <script src="/static/js/online-users.js"></script>
    {% include 'partials/_edit_profile_modal.html' %}
    <script src="/static/js/theme.js"></script>
</body>
</html>
