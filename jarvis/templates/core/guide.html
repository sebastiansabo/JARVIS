<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - User Guide</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container">
            <a class="navbar-brand mb-0 h1" href="/" id="navbarLogo">
                <span class="navbar-logo-icon"></span> J.A.R.V.I.S.
            </a>
            <span class="navbar-text text-white me-auto ms-3">
                <i class="bi bi-book"></i> User Guide
            </span>
            <div class="d-flex align-items-center">
                <!-- Theme Toggle -->
                <div class="theme-switch">
                    <i class="bi bi-sun-fill"></i>
                    <input type="checkbox" id="themeToggle" title="Toggle Dark/Light Theme">
                    <i class="bi bi-moon-fill"></i>
                </div>
                <a href="/accounting" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-calculator"></i> Accounting
                </a>
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3">
                <div class="guide-nav">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <i class="bi bi-list"></i> Contents
                        </div>
                        <div class="card-body p-2">
                            <nav id="toc">
                                <a href="#overview" class="toc-link"><i class="bi bi-house"></i> Overview</a>
                                <a href="#add-invoice" class="toc-link"><i class="bi bi-plus-circle"></i> Adding Invoices</a>
                                <a href="#allocations" class="toc-link"><i class="bi bi-pie-chart"></i> Allocations</a>
                                <a href="#vat-subtraction" class="toc-link"><i class="bi bi-percent"></i> VAT Subtraction</a>
                                <a href="#reinvoicing" class="toc-link"><i class="bi bi-arrow-repeat"></i> Reinvoicing</a>
                                <a href="#dashboard" class="toc-link"><i class="bi bi-speedometer2"></i> Dashboard</a>
                                <a href="#filters" class="toc-link"><i class="bi bi-funnel"></i> Filters & Search</a>
                                <a href="#editing" class="toc-link"><i class="bi bi-pencil"></i> Editing Invoices</a>
                                <a href="#attachments" class="toc-link"><i class="bi bi-paperclip"></i> Attachments</a>
                                <a href="#settings" class="toc-link"><i class="bi bi-gear"></i> Settings</a>
                                <a href="#tips" class="toc-link"><i class="bi bi-lightbulb"></i> Tips & Shortcuts</a>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Overview -->
                <section id="overview" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-house"></i> Overview</h2>
                        </div>
                        <div class="guide-card-body">
                            <p class="lead">Bugetare is an invoice budget allocation system for managing marketing costs across companies, brands, and departments.</p>

                            <div class="row g-4 mt-3">
                                <div class="col-md-4 text-center">
                                    <i class="bi bi-receipt feature-icon"></i>
                                    <h5>Upload Invoices</h5>
                                    <p class="text-muted">Upload PDF invoices and let AI extract the data automatically</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <i class="bi bi-pie-chart feature-icon"></i>
                                    <h5>Allocate Costs</h5>
                                    <p class="text-muted">Split costs across departments with percentage-based allocations</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <i class="bi bi-graph-up feature-icon"></i>
                                    <h5>Track & Report</h5>
                                    <p class="text-muted">View summaries by company, department, or brand</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Adding Invoices -->
                <section id="add-invoice" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-plus-circle"></i> Adding Invoices</h2>
                        </div>
                        <div class="guide-card-body">
                            <h5><span class="step-number">1</span> Upload the Invoice</h5>
                            <p>Click <strong>New Invoice</strong> in the navigation bar. Upload a PDF or image file of the invoice.</p>

                            <h5 class="mt-4"><span class="step-number">2</span> AI Parsing</h5>
                            <p>The system uses AI to automatically extract:</p>
                            <ul>
                                <li><strong>Supplier Name</strong> and VAT number</li>
                                <li><strong>Invoice Number</strong> and Date</li>
                                <li><strong>Total Value</strong> and Currency</li>
                                <li><strong>Customer VAT</strong> (matched to your companies)</li>
                            </ul>

                            <h5 class="mt-4"><span class="step-number">3</span> Select Template (Optional)</h5>
                            <p>For recurring suppliers (Meta, Google Ads), select a template for faster, consistent parsing without AI.</p>

                            <h5 class="mt-4"><span class="step-number">4</span> Review & Correct</h5>
                            <p>Verify the extracted data and make corrections if needed. The company dropdown will auto-select if the customer VAT matches.</p>

                            <div class="tip-box">
                                <strong><i class="bi bi-lightbulb"></i> Tip:</strong> Templates work best with consistent invoice formats. Ask an admin to create templates for your regular suppliers.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Allocations -->
                <section id="allocations" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-pie-chart"></i> Allocations</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>Allocations split the invoice cost across departments. The total must equal <strong>100%</strong>.</p>

                            <h5 class="mt-4">Adding Allocations</h5>
                            <ol>
                                <li>Select the <strong>Company</strong> for the invoice</li>
                                <li>Choose <strong>Brand</strong>, <strong>Department</strong>, and optionally <strong>Subdepartment</strong></li>
                                <li>Set the <strong>Percentage</strong> or <strong>Value</strong> (they sync automatically)</li>
                                <li>Click <strong>+ Add Row</strong> to split across multiple departments</li>
                            </ol>

                            <h5 class="mt-4"><i class="bi bi-lock"></i> Lock Feature</h5>
                            <p>When you have 3+ allocations and add a new row, percentages redistribute automatically. To prevent this:</p>
                            <ol>
                                <li>Click the <strong>lock icon</strong> next to an allocation</li>
                                <li>Locked allocations keep their percentage when adding new rows</li>
                                <li>Only unlocked rows redistribute</li>
                            </ol>

                            <div class="warning-box">
                                <strong><i class="bi bi-exclamation-triangle"></i> Important:</strong> Allocation percentages must sum to exactly 100% (a small 0.1% tolerance is allowed for rounding).
                            </div>
                        </div>
                    </div>
                </section>

                <!-- VAT Subtraction -->
                <section id="vat-subtraction" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-percent"></i> VAT Subtraction</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>For invoices where allocations should be based on net value (excluding VAT):</p>

                            <ol>
                                <li>Check the <strong>"Subtract VAT"</strong> checkbox</li>
                                <li>Select the <strong>VAT Rate</strong> (19%, 9%, 5%, or 0%)</li>
                                <li>The <strong>Net Value</strong> is calculated automatically</li>
                                <li>Allocation values will be based on the net value</li>
                            </ol>

                            <div class="card bg-light mt-3">
                                <div class="card-body">
                                    <h6>Example:</h6>
                                    <ul class="mb-0">
                                        <li>Invoice Value: <strong>1,190 RON</strong></li>
                                        <li>VAT Rate: <strong>19%</strong></li>
                                        <li>Net Value: <strong>1,000 RON</strong> (1,190 / 1.19)</li>
                                        <li>50% allocation = <strong>500 RON</strong> (not 595 RON)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reinvoicing -->
                <section id="reinvoicing" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-arrow-repeat"></i> Reinvoicing</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>Reinvoicing marks an allocation for internal billing to another entity.</p>

                            <h5>Single Reinvoice</h5>
                            <ol>
                                <li>Check <strong>"Reinvoice to:"</strong> on an allocation</li>
                                <li>Select the target <strong>Company</strong>, <strong>Department</strong>, and optionally <strong>Subdepartment</strong></li>
                                <li>The department manager of both the original and reinvoice target will be notified</li>
                            </ol>

                            <h5 class="mt-4">Multi-Destination Reinvoice</h5>
                            <p>You can reinvoice to multiple destinations:</p>
                            <ol>
                                <li>Click <strong>"+ Add Reinvoice Line"</strong></li>
                                <li>Each line can have its own percentage/value</li>
                                <li>Use the <strong>lock icon</strong> to prevent redistribution</li>
                                <li>Add <strong>comments</strong> with the chat icon</li>
                            </ol>

                            <div class="tip-box">
                                <strong><i class="bi bi-lightbulb"></i> Tip:</strong> Reinvoice lines show a magenta arrow <span class="text-warning">(â†’)</span> in the Split Values column on the dashboard.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Dashboard -->
                <section id="dashboard" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-speedometer2"></i> Dashboard</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>The Accounting Dashboard provides multiple views of your invoice data.</p>

                            <h5>Tab Views</h5>
                            <ul>
                                <li><strong>Invoices</strong> - Complete list with all details</li>
                                <li><strong>By Company</strong> - Aggregated totals per company</li>
                                <li><strong>By Department</strong> - Totals per department</li>
                                <li><strong>By Brand</strong> - Totals per business line</li>
                            </ul>

                            <h5 class="mt-4">Summary Cards</h5>
                            <p>The top row shows quick statistics:</p>
                            <ul>
                                <li><strong>Total Invoices</strong> - Count of invoices in current filter</li>
                                <li><strong>Total Value</strong> - Sum of invoice values (toggle EUR/RON)</li>
                                <li><strong>Avg. Invoice Value</strong> - Average per invoice</li>
                            </ul>

                            <h5 class="mt-4">Column Configuration</h5>
                            <p>Click <strong>Configure Columns</strong> to:</p>
                            <ul>
                                <li>Show/hide columns with checkboxes</li>
                                <li>Drag to reorder columns</li>
                                <li>Settings are saved per browser</li>
                            </ul>

                            <h5 class="mt-4">Pagination</h5>
                            <p>Use the controls at the bottom to:</p>
                            <ul>
                                <li>Change rows per page (25, 50, 100, or All)</li>
                                <li>Navigate between pages</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Filters -->
                <section id="filters" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-funnel"></i> Filters & Search</h2>
                        </div>
                        <div class="guide-card-body">
                            <h5>Filter Options</h5>
                            <ul>
                                <li><strong>Company</strong> - Filter by allocated company</li>
                                <li><strong>Department</strong> - Filter by department</li>
                                <li><strong>Subdepartment</strong> - Filter by subdepartment</li>
                                <li><strong>Brand</strong> - Filter by business line</li>
                                <li><strong>Date Range</strong> - Filter by invoice date</li>
                            </ul>

                            <h5 class="mt-4">Quick Date Filters</h5>
                            <p>Use the dropdown for common periods:</p>
                            <ul>
                                <li>Today / This Week / This Month / This Year</li>
                                <li>Last Month / Last Year</li>
                            </ul>

                            <h5 class="mt-4">Search</h5>
                            <p>Type in the search box to find invoices by supplier name or invoice number.</p>
                        </div>
                    </div>
                </section>

                <!-- Editing -->
                <section id="editing" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-pencil"></i> Editing Invoices</h2>
                        </div>
                        <div class="guide-card-body">
                            <h5>View Invoice Details</h5>
                            <p>Click <strong>View</strong> on any invoice row to see full details including allocations.</p>

                            <h5 class="mt-4">Edit Invoice</h5>
                            <ol>
                                <li>Open the invoice detail modal</li>
                                <li>Click <strong>Edit</strong></li>
                                <li>Modify invoice fields or allocations</li>
                                <li>Click <strong>Save Changes</strong></li>
                            </ol>

                            <h5 class="mt-4">Change Status</h5>
                            <p>Update the invoice status directly from the table:</p>
                            <ul>
                                <li><strong>New</strong> (blue) - Just added</li>
                                <li><strong>Processed</strong> (green) - Completed</li>
                                <li><strong>Incomplete</strong> (red) - Needs attention</li>
                            </ul>

                            <h5 class="mt-4">Payment Status</h5>
                            <p>Track payment status separately:</p>
                            <ul>
                                <li><strong>Not Paid</strong> - Payment pending</li>
                                <li><strong>Paid</strong> - Payment completed</li>
                            </ul>

                            <h5 class="mt-4">Delete Invoice</h5>
                            <p>Invoices are soft-deleted first (moved to Bin). From the Bin you can:</p>
                            <ul>
                                <li><strong>Restore</strong> - Bring back the invoice</li>
                                <li><strong>Permanently Delete</strong> - Remove forever</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Attachments -->
                <section id="attachments" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-paperclip"></i> Attachments</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>Upload additional files with your invoice (supporting documents, receipts, etc.).</p>

                            <h5>Adding Attachments</h5>
                            <ol>
                                <li>On the Add Invoice page, expand <strong>"Add files to upload with invoice"</strong></li>
                                <li>Select files (max 5MB each)</li>
                                <li>Supported formats: PDF, images, documents</li>
                                <li>Attachments upload when you save the invoice</li>
                            </ol>

                            <h5 class="mt-4">Viewing Attachments</h5>
                            <p>In the dashboard, invoices with attachments show a <strong>folder icon</strong> next to the View button. Click it to open the Google Drive folder.</p>

                            <div class="tip-box">
                                <strong><i class="bi bi-lightbulb"></i> Tip:</strong> Images (PNG, JPEG) are automatically compressed before upload to save space.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings -->
                <section id="settings" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-gear"></i> Settings (Admin)</h2>
                        </div>
                        <div class="guide-card-body">
                            <p>Administrators can access Settings to configure the system.</p>

                            <h5>Tabs Overview</h5>
                            <ul>
                                <li><strong>Users</strong> - Manage user accounts and passwords</li>
                                <li><strong>Roles</strong> - Define permissions for user roles</li>
                                <li><strong>Company Configuration</strong> - Department structure</li>
                                <li><strong>VAT Registry</strong> - Company VAT numbers for matching</li>
                                <li><strong>Responsables</strong> - Department managers for notifications</li>
                                <li><strong>VAT Rates</strong> - Configure VAT rate options</li>
                                <li><strong>Notifications</strong> - SMTP email settings</li>
                                <li><strong>Activity Logs</strong> - Audit trail of user actions</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Tips -->
                <section id="tips" class="guide-section">
                    <div class="guide-card">
                        <div class="guide-card-header">
                            <h2 class="mb-0"><i class="bi bi-lightbulb"></i> Tips & Shortcuts</h2>
                        </div>
                        <div class="guide-card-body">
                            <h5>Keyboard Shortcuts</h5>
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td><span class="keyboard-key">Tab</span></td>
                                        <td>Move between form fields</td>
                                    </tr>
                                    <tr>
                                        <td><span class="keyboard-key">Enter</span></td>
                                        <td>Submit form / Confirm action</td>
                                    </tr>
                                    <tr>
                                        <td><span class="keyboard-key">Esc</span></td>
                                        <td>Close modal</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h5 class="mt-4">Best Practices</h5>
                            <ul>
                                <li><strong>Use templates</strong> for recurring suppliers to speed up entry</li>
                                <li><strong>Lock allocations</strong> before adding more rows to keep values stable</li>
                                <li><strong>Add comments</strong> to allocations for context</li>
                                <li><strong>Check totals</strong> - allocations must sum to 100%</li>
                                <li><strong>Save often</strong> - changes aren't saved until you click Save</li>
                            </ul>

                            <h5 class="mt-4">Troubleshooting</h5>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Problem</th>
                                        <th>Solution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Invoice parsing incorrect</td>
                                        <td>Try a different template or manually correct values</td>
                                    </tr>
                                    <tr>
                                        <td>Company not auto-selected</td>
                                        <td>Check VAT Registry in Settings</td>
                                    </tr>
                                    <tr>
                                        <td>Can't save - allocation error</td>
                                        <td>Ensure percentages sum to 100%</td>
                                    </tr>
                                    <tr>
                                        <td>Email notifications not sent</td>
                                        <td>Check SMTP settings and Responsables configuration</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Highlight active section in TOC on scroll
        const sections = document.querySelectorAll('.guide-section');
        const tocLinks = document.querySelectorAll('.toc-link');

        window.addEventListener('scroll', () => {
            let current = '';
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            tocLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
    <script src="/static/js/theme.js"></script>
</body>
</html>
