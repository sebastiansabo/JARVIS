<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - System Settings</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
    <style>
        /* Fix for inactive fade tabs taking up vertical space */
        .tab-pane.fade:not(.show) {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'settings' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item active">Settings</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Summary Stats Bar (matching accounting style) -->
        <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3 mb-3">
            <span class="summary-stat" title="Total Users">
                <i class="bi bi-people text-primary"></i>
                <strong id="totalUsers">0</strong> users
            </span>
            <span class="summary-stat" title="Active Users">
                <i class="bi bi-person-check text-success"></i>
                <strong id="activeUsers">0</strong> active
            </span>
            <span class="summary-stat" title="Roles Defined">
                <i class="bi bi-shield text-warning"></i>
                <strong id="totalRoles">0</strong> roles
            </span>
        </div>
        <style>
            .summary-filter-bar { font-size: 0.85rem; }
            .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
            .summary-stat i { font-size: 1rem; }
            .summary-stat strong { color: var(--bs-body-color); }
        </style>

        <!-- Tabs for Users, Roles, and Notifications -->
        <ul class="nav nav-tabs" id="settingsTabs">
            <li class="nav-item">
                <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                    <i class="bi bi-people-fill"></i> Users
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" type="button">
                    <i class="bi bi-shield-lock"></i> Roles
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button">
                    <i class="bi bi-envelope"></i> Notifications
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="dropdown-options-tab" data-bs-toggle="tab" data-bs-target="#dropdown-options" type="button">
                    <i class="bi bi-calculator"></i> Accounting
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="activity-logs-tab" data-bs-toggle="tab" data-bs-target="#activity-logs" type="button">
                    <i class="bi bi-clock-history"></i> Activity Logs
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="theme-tab" data-bs-toggle="tab" data-bs-target="#theme-settings" type="button">
                    <i class="bi bi-palette"></i> Theme
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="company-structure-tab" data-bs-toggle="tab" data-bs-target="#company-structure" type="button">
                    <i class="bi bi-diagram-3"></i> Company Structure
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="hr-tab" data-bs-toggle="tab" data-bs-target="#hr-settings" type="button">
                    <i class="bi bi-people"></i> HR
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Users Tab -->
            <div class="tab-pane fade show active" id="users">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>
                            <h5 class="mb-0 d-inline">Users</h5>
                            <button id="btnDeleteSelectedUsers" class="btn btn-outline-danger btn-sm ms-2 d-none">
                                <i class="bi bi-trash"></i> Delete Selected (<span id="selectedUsersCount">0</span>)
                            </button>
                        </span>
                        <button class="btn btn-primary btn-sm" onclick="showAddUserModal()">
                            <i class="bi bi-person-plus"></i> Add User
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="selectAllUsers" title="Select All"></th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr class="loading-placeholder"><td colspan="7" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading users...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="noUsersMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-people display-4"></i>
                            <p class="mt-2">No users found. Click "Add User" to create one.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roles Tab -->
            <div class="tab-pane fade" id="roles">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Access Permissions</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="showAddRoleModal()">
                                <i class="bi bi-shield-plus"></i> Add Role
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="saveAllPermissions()">
                                <i class="bi bi-check-lg"></i> Save Changes
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="row g-0" style="min-height: 500px;">
                            <!-- Module Sidebar -->
                            <div class="col-md-2 border-end" style="background: var(--bg-table-header);">
                                <div class="p-2">
                                    <input type="text" class="form-control form-control-sm mb-2" id="moduleSearch" placeholder="Search modules...">
                                </div>
                                <div class="list-group list-group-flush" id="moduleSidebar">
                                    <!-- Modules loaded dynamically -->
                                </div>
                            </div>
                            <!-- Permission Matrix -->
                            <div class="col-md-10">
                                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                                    <table class="table table-bordered table-sm mb-0" id="permissionMatrix">
                                        <thead class="sticky-top" style="background: var(--bg-table-header); z-index: 10;">
                                            <tr id="matrixHeaderRow">
                                                <th style="min-width: 200px; position: sticky; left: 0; background: var(--bg-table-header); z-index: 11;">
                                                    Permission
                                                </th>
                                                <!-- Role columns loaded dynamically -->
                                            </tr>
                                        </thead>
                                        <tbody id="matrixBody">
                                            <tr class="loading-placeholder"><td colspan="5" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading permissions...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="tab-pane fade" id="notifications">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-envelope-gear"></i> Email Notification Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="notificationSettingsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">SMTP Server Configuration</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Host</label>
                                                <input type="text" class="form-control" id="smtpHost" placeholder="smtp.gmail.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Port</label>
                                                <input type="number" class="form-control" id="smtpPort" placeholder="587">
                                            </div>
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="smtpTls" checked>
                                                <label class="form-check-label" for="smtpTls">Use TLS</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">Authentication</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Username</label>
                                                <input type="text" class="form-control" id="smtpUsername" placeholder="your-email@gmail.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">SMTP Password</label>
                                                <input type="password" class="form-control" id="smtpPassword" placeholder="App password or SMTP password">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">From Email</label>
                                                <input type="email" class="form-control" id="fromEmail" placeholder="noreply@yourcompany.com">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">From Name</label>
                                                <input type="text" class="form-control" id="fromName" placeholder="Invoice System">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <small class="text-muted">Notification Preferences</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" id="notifyOnAllocation" checked>
                                                <label class="form-check-label" for="notifyOnAllocation">
                                                    Send email when invoice is allocated to a department
                                                </label>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Global CC Address</label>
                                                <input type="email" class="form-control" id="globalCc" placeholder="cc@yourcompany.com">
                                                <small class="text-muted">All notification emails will be copied to this address</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                                    <i class="bi bi-check-lg"></i> Save Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="testEmailSettings()">
                                    <i class="bi bi-send"></i> Send Test Email
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Accounting Tab -->
            <div class="tab-pane fade" id="dropdown-options">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-calculator"></i> Accounting</h5>
                    </div>
                    <div class="card-body">
                        <!-- VAT Rates Section -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-percent"></i> VAT Rates</h6>
                            <p class="text-muted small mb-3">
                                Configure VAT rates for invoice processing. When adding invoices, you can optionally subtract VAT from the invoice value.
                            </p>
                            <div class="table-responsive mb-3">
                                <table class="table table-sm table-hover" id="vatRatesTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Rate (%)</th>
                                            <th>Default</th>
                                            <th>Active</th>
                                            <th style="width: 100px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vatRatesTableBody">
                                        <tr class="loading-placeholder"><td colspan="5" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading VAT rates...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noVatRatesMessage" class="text-center text-muted py-4" style="display: none;">
                                <i class="bi bi-percent display-4"></i>
                                <p class="mt-2">No VAT rates configured. Add a VAT rate below.</p>
                            </div>
                            <div class="row g-2 mt-2">
                                <div class="col-md-3">
                                    <input type="text" class="form-control form-control-sm" id="newVatRateName" placeholder="Name (e.g., Standard VAT)">
                                </div>
                                <div class="col-md-2">
                                    <div class="input-group input-group-sm">
                                        <input type="number" class="form-control" id="newVatRateValue" placeholder="Rate" step="0.01" min="0" max="100">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="newVatRateDefault">
                                        <label class="form-check-label small" for="newVatRateDefault">Default</label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="newVatRateActive" checked>
                                        <label class="form-check-label small" for="newVatRateActive">Active</label>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary btn-sm w-100" id="addVatRateBtn">
                                        <i class="bi bi-plus"></i> Add VAT Rate
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Invoice Status Options -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-tag"></i> Invoice Status Options</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="invoiceStatusTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Value</th>
                                            <th>Label</th>
                                            <th>Color</th>
                                            <th>Opacity</th>
                                            <th>Order</th>
                                            <th>Min Role</th>
                                            <th>Active</th>
                                            <th width="100">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="row g-2 mt-2 align-items-center">
                                <div class="col-auto">
                                    <input type="text" class="form-control form-control-sm" id="newInvoiceStatusValue" placeholder="Value (e.g., pending)" style="width: 120px;">
                                </div>
                                <div class="col-auto">
                                    <input type="text" class="form-control form-control-sm" id="newInvoiceStatusLabel" placeholder="Label (e.g., Pending)" style="width: 130px;">
                                </div>
                                <div class="col-auto">
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="newInvoiceStatusColor" value="#0d6efd" title="Choose color">
                                        <input type="text" class="form-control" id="newInvoiceStatusColorText" value="#0d6efd" placeholder="#hex" style="width: 75px;">
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="input-group input-group-sm">
                                        <input type="range" class="form-range" id="newInvoiceStatusOpacity" min="0" max="1" step="0.1" value="0.7" style="width: 60px;">
                                        <span class="input-group-text small" id="newInvoiceStatusOpacityValue">70%</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <input type="number" class="form-control form-control-sm" id="newInvoiceStatusOrder" placeholder="Order" value="0" style="width: 60px;">
                                </div>
                                <div class="col-auto">
                                    <select class="form-select form-select-sm" id="newInvoiceStatusMinRole" style="width: 100px;">
                                        <option value="Viewer">Viewer</option>
                                        <option value="User">User</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-sm" onclick="addDropdownOption('invoice_status')">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Status Options -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-credit-card"></i> Payment Status Options</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="paymentStatusTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Value</th>
                                            <th>Label</th>
                                            <th>Color</th>
                                            <th>Opacity</th>
                                            <th>Order</th>
                                            <th>Min Role</th>
                                            <th>Active</th>
                                            <th width="100">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="row g-2 mt-2 align-items-center">
                                <div class="col-auto">
                                    <input type="text" class="form-control form-control-sm" id="newPaymentStatusValue" placeholder="Value (e.g., partial)" style="width: 120px;">
                                </div>
                                <div class="col-auto">
                                    <input type="text" class="form-control form-control-sm" id="newPaymentStatusLabel" placeholder="Label (e.g., Partial)" style="width: 130px;">
                                </div>
                                <div class="col-auto">
                                    <div class="input-group input-group-sm">
                                        <input type="color" class="form-control form-control-color" id="newPaymentStatusColor" value="#0d6efd" title="Choose color">
                                        <input type="text" class="form-control" id="newPaymentStatusColorText" value="#0d6efd" placeholder="#hex" style="width: 75px;">
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="input-group input-group-sm">
                                        <input type="range" class="form-range" id="newPaymentStatusOpacity" min="0" max="1" step="0.1" value="0.7" style="width: 60px;">
                                        <span class="input-group-text small" id="newPaymentStatusOpacityValue">70%</span>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <input type="number" class="form-control form-control-sm" id="newPaymentStatusOrder" placeholder="Order" value="0" style="width: 60px;">
                                </div>
                                <div class="col-auto">
                                    <select class="form-select form-select-sm" id="newPaymentStatusMinRole" style="width: 100px;">
                                        <option value="Viewer">Viewer</option>
                                        <option value="User">User</option>
                                        <option value="Manager">Manager</option>
                                        <option value="Admin">Admin</option>
                                    </select>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-primary btn-sm" onclick="addDropdownOption('payment_status')">
                                        <i class="bi bi-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Vendor Mappings Section -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-diagram-3"></i> Vendor Mappings</h6>
                            <p class="text-muted small mb-3">
                                Configure regex patterns to automatically match bank statement transactions to known suppliers.
                            </p>
                            <div class="d-flex gap-2">
                                <a href="/statements/mappings" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-diagram-3"></i> Manage Vendor Mappings
                                </a>
                                <a href="/statements/" class="btn btn-outline-secondary btn-sm">
                                    <i class="bi bi-bank"></i> Bank Statements
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade" id="activity-logs">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Activity Logs</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i> View user activity logs including logins, logouts, and application actions.
                        </p>
                        <!-- Filters -->
                        <div class="row g-2 mb-3">
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="logFilterUser">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" id="logFilterEventType">
                                    <option value="">All Event Types</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="logFilterStartDate" placeholder="Start Date">
                            </div>
                            <div class="col-md-2">
                                <input type="date" class="form-control form-control-sm" id="logFilterEndDate" placeholder="End Date">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-primary w-100" onclick="loadActivityLogs()">
                                    <i class="bi bi-search"></i> Filter
                                </button>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="clearActivityLogFilters()">
                                    <i class="bi bi-x-circle"></i> Clear
                                </button>
                            </div>
                        </div>
                        <!-- Logs Table -->
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" id="activityLogsTable">
                                <thead>
                                    <tr>
                                        <th style="width: 150px;">Timestamp</th>
                                        <th style="width: 150px;">User</th>
                                        <th style="width: 120px;">Event Type</th>
                                        <th>Description</th>
                                        <th style="width: 120px;">IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="activityLogsTableBody"></tbody>
                            </table>
                        </div>
                        <div id="noActivityLogsMessage" class="text-center text-muted py-4" style="display: none;">
                            <i class="bi bi-clock-history display-4"></i>
                            <p class="mt-2">No activity logs found.</p>
                        </div>
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted small" id="activityLogsPaginationInfo">Showing 0 events</div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="activityLogsPagination"></ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Theme Settings Tab -->
            <div class="tab-pane fade" id="theme-settings">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-palette"></i> Theme Settings</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="resetThemeToDefault()">
                                <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="saveThemeSettings()">
                                <i class="bi bi-check-lg"></i> Save Theme
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-4">
                            <i class="bi bi-info-circle"></i> Customize the Jarvis platform colors. Changes apply to all users across the application.
                        </p>

                        <!-- Theme Name -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Theme Name</label>
                                <input type="text" class="form-control" id="themeName" placeholder="My Custom Theme">
                            </div>
                            <div class="col-md-8 d-flex align-items-end">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="themeIsActive" checked>
                                    <label class="form-check-label" for="themeIsActive">Active Theme</label>
                                </div>
                            </div>
                        </div>

                        <!-- Logo Settings -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-image"></i> Logo Settings</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label small">Logo Type</label>
                                        <select class="form-select form-select-sm" id="logoType" onchange="updateLogoPreview()">
                                            <option value="svg" selected>Custom SVG (Microchip)</option>
                                            <option value="icon">Bootstrap Icon</option>
                                            <option value="text">Text Only</option>
                                            <option value="image">Custom Image URL</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" id="logoSvgGroup">
                                        <label class="form-label small">SVG Path</label>
                                        <input type="text" class="form-control form-control-sm" id="logoSvgUrl" value="/static/img/jarvis-icon.svg" placeholder="/static/img/icon.svg" onchange="updateLogoPreview()">
                                        <small class="text-muted">Path to SVG file</small>
                                    </div>
                                    <div class="col-md-3" id="logoIconGroup" style="display: none;">
                                        <label class="form-label small">Logo Icon</label>
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text"><i class="bi" id="logoIconPreview"></i></span>
                                            <input type="text" class="form-control" id="logoIcon" value="bi-cpu" placeholder="bi-icon-name" onchange="updateLogoPreview()">
                                        </div>
                                        <small class="text-muted">e.g., bi-cpu, bi-grid-3x3-gap-fill</small>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Logo Text</label>
                                        <input type="text" class="form-control form-control-sm" id="logoText" value="J.A.R.V.I.S." placeholder="App Name" onchange="updateLogoPreview()">
                                    </div>
                                    <div class="col-md-3" id="logoImageGroup" style="display: none;">
                                        <label class="form-label small">Image URL</label>
                                        <input type="url" class="form-control form-control-sm" id="logoImageUrl" placeholder="https://..." onchange="updateLogoPreview()">
                                        <small class="text-muted">Max height: 32px</small>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small">Preview</label>
                                        <div class="p-2 bg-primary rounded d-inline-block">
                                            <span class="navbar-brand mb-0 h1 text-white" id="logoPreviewArea">
                                                <span class="navbar-logo-icon"></span> J.A.R.V.I.S.
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Light Theme Colors -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="bi bi-sun"></i> Light Theme Colors</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label small">Background Body</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-bgBody" value="#f5f5f5">
                                            <input type="text" class="form-control" id="light-bgBody-text" value="#f5f5f5">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Card Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-bgCard" value="#ffffff">
                                            <input type="text" class="form-control" id="light-bgCard-text" value="#ffffff">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Table Header</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-bgTableHeader" value="#f8f9fa">
                                            <input type="text" class="form-control" id="light-bgTableHeader-text" value="#f8f9fa">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Table Hover</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-bgTableHover" value="#e3f2fd">
                                            <input type="text" class="form-control" id="light-bgTableHover-text" value="#e3f2fd">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Input Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-bgInput" value="#ffffff">
                                            <input type="text" class="form-control" id="light-bgInput-text" value="#ffffff">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Primary Text</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-textPrimary" value="#212529">
                                            <input type="text" class="form-control" id="light-textPrimary-text" value="#212529">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Secondary Text</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-textSecondary" value="#6c757d">
                                            <input type="text" class="form-control" id="light-textSecondary-text" value="#6c757d">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Border Color</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-borderColor" value="#dee2e6">
                                            <input type="text" class="form-control" id="light-borderColor-text" value="#dee2e6">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Primary</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-accentPrimary" value="#0d6efd">
                                            <input type="text" class="form-control" id="light-accentPrimary-text" value="#0d6efd">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Success</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-accentSuccess" value="#198754">
                                            <input type="text" class="form-control" id="light-accentSuccess-text" value="#198754">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Warning</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-accentWarning" value="#ffc107">
                                            <input type="text" class="form-control" id="light-accentWarning-text" value="#ffc107">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Danger</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-accentDanger" value="#dc3545">
                                            <input type="text" class="form-control" id="light-accentDanger-text" value="#dc3545">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Navbar Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="light-navbarBg" value="#6c757d">
                                            <input type="text" class="form-control" id="light-navbarBg-text" value="#6c757d">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dark Theme Colors -->
                        <div class="card mb-4">
                            <div class="card-header" style="background: #1a1a2e;">
                                <h6 class="mb-0 text-white"><i class="bi bi-moon"></i> Dark Theme Colors</h6>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <label class="form-label small">Background Body</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-bgBody" value="#1a1a2e">
                                            <input type="text" class="form-control" id="dark-bgBody-text" value="#1a1a2e">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Card Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-bgCard" value="#16213e">
                                            <input type="text" class="form-control" id="dark-bgCard-text" value="#16213e">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Table Header</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-bgTableHeader" value="#0f3460">
                                            <input type="text" class="form-control" id="dark-bgTableHeader-text" value="#0f3460">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Table Hover</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-bgTableHover" value="#1f4068">
                                            <input type="text" class="form-control" id="dark-bgTableHover-text" value="#1f4068">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Input Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-bgInput" value="#0f3460">
                                            <input type="text" class="form-control" id="dark-bgInput-text" value="#0f3460">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Primary Text</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-textPrimary" value="#e4e4e4">
                                            <input type="text" class="form-control" id="dark-textPrimary-text" value="#e4e4e4">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Secondary Text</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-textSecondary" value="#a0a0a0">
                                            <input type="text" class="form-control" id="dark-textSecondary-text" value="#a0a0a0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Border Color</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-borderColor" value="#2d4a6e">
                                            <input type="text" class="form-control" id="dark-borderColor-text" value="#2d4a6e">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Primary</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-accentPrimary" value="#64b5f6">
                                            <input type="text" class="form-control" id="dark-accentPrimary-text" value="#64b5f6">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Success</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-accentSuccess" value="#81c784">
                                            <input type="text" class="form-control" id="dark-accentSuccess-text" value="#81c784">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Warning</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-accentWarning" value="#ffb74d">
                                            <input type="text" class="form-control" id="dark-accentWarning-text" value="#ffb74d">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Accent Danger</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-accentDanger" value="#ef5350">
                                            <input type="text" class="form-control" id="dark-accentDanger-text" value="#ef5350">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label small">Navbar Background</label>
                                        <div class="input-group input-group-sm">
                                            <input type="color" class="form-control form-control-color" id="dark-navbarBg" value="#0f3460">
                                            <input type="text" class="form-control" id="dark-navbarBg-text" value="#0f3460">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-eye"></i> Live Preview</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="border rounded p-3" id="previewLight" style="background: #f5f5f5;">
                                            <h6 style="color: #212529;">Light Theme Preview</h6>
                                            <div class="p-2 mb-2 rounded" style="background: #ffffff; border: 1px solid #dee2e6;">
                                                <span style="color: #212529;">Card content</span>
                                                <span class="ms-2" style="color: #6c757d;">Secondary text</span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <span class="badge" style="background: #0d6efd;">Primary</span>
                                                <span class="badge" style="background: #198754;">Success</span>
                                                <span class="badge" style="background: #ffc107; color: #000;">Warning</span>
                                                <span class="badge" style="background: #dc3545;">Danger</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border rounded p-3" id="previewDark" style="background: #1a1a2e;">
                                            <h6 style="color: #e4e4e4;">Dark Theme Preview</h6>
                                            <div class="p-2 mb-2 rounded" style="background: #16213e; border: 1px solid #2d4a6e;">
                                                <span style="color: #e4e4e4;">Card content</span>
                                                <span class="ms-2" style="color: #a0a0a0;">Secondary text</span>
                                            </div>
                                            <div class="d-flex gap-2">
                                                <span class="badge" style="background: #64b5f6; color: #000;">Primary</span>
                                                <span class="badge" style="background: #81c784; color: #000;">Success</span>
                                                <span class="badge" style="background: #ffb74d; color: #000;">Warning</span>
                                                <span class="badge" style="background: #ef5350;">Danger</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Module Menu Configuration -->
                        <div class="card mt-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="bi bi-grid-3x3-gap"></i> Module Menu Configuration</h6>
                                <button class="btn btn-sm btn-primary" onclick="showAddModuleModal()">
                                    <i class="bi bi-plus-lg"></i> Add Module
                                </button>
                            </div>
                            <div class="card-body">
                                <p class="text-muted small mb-3">
                                    <i class="bi bi-info-circle"></i> Configure the navigation modules and their sub-pages displayed in the global menu.
                                </p>
                                <div id="moduleMenuList">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm" role="status"></div>
                                        <span class="ms-2">Loading modules...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Menu Edit Modal -->
            <div class="modal fade" id="moduleMenuModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="moduleMenuModalTitle">Add Module</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="moduleMenuItemId">
                            <div class="mb-3">
                                <label class="form-label">Parent Module</label>
                                <select class="form-select" id="moduleParentId">
                                    <option value="">-- Top Level Module --</option>
                                </select>
                                <small class="text-muted">Leave empty for main module, select parent for sub-page</small>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Module Key *</label>
                                    <input type="text" class="form-control" id="moduleKey" placeholder="e.g., accounting" required>
                                    <small class="text-muted">Unique identifier</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Name *</label>
                                    <input type="text" class="form-control" id="moduleName" placeholder="e.g., Accounting" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" id="moduleDescription" placeholder="e.g., Invoices, Budgets, Statements">
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Icon</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi" id="moduleIconPreview"></i></span>
                                        <input type="text" class="form-control" id="moduleIcon" placeholder="bi-calculator" value="bi-grid">
                                    </div>
                                    <small class="text-muted">Bootstrap icon class</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Color</label>
                                    <div class="input-group">
                                        <input type="color" class="form-control form-control-color" id="moduleColorPicker" value="#6c757d">
                                        <input type="text" class="form-control" id="moduleColor" value="#6c757d">
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">URL</label>
                                    <input type="text" class="form-control" id="moduleUrl" placeholder="/accounting">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Sort Order</label>
                                    <input type="number" class="form-control" id="moduleSortOrder" value="0" min="0">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="moduleStatus">
                                    <option value="active">Active</option>
                                    <option value="coming_soon">Coming Soon</option>
                                    <option value="hidden">Hidden</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveModuleMenuItem()">
                                <i class="bi bi-check-lg"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Company Structure Tab (Main) -->
            <div class="tab-pane fade" id="company-structure">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Company Structure</h5>
                    </div>
                    <div class="card-body">
                        <!-- Stats Summary Bar (matching accounting style) -->
                        <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3 mb-3">
                            <span class="summary-stat" title="Companies">
                                <i class="bi bi-building text-primary"></i>
                                <strong id="hrStatsCompanies">-</strong> companies
                            </span>
                            <span class="summary-stat" title="Brands">
                                <i class="bi bi-tags text-success"></i>
                                <strong id="hrStatsBrands">-</strong> brands
                            </span>
                            <span class="summary-stat" title="Departments">
                                <i class="bi bi-diagram-3 text-info"></i>
                                <strong id="hrStatsDepartments">-</strong> departments
                            </span>
                        </div>

                        <!-- Structure Sub-tabs -->
                        <ul class="nav nav-pills mb-3" id="hrStructureTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="hr-companies-tab" data-bs-toggle="pill" data-bs-target="#hr-companies" type="button" role="tab">
                                    <i class="bi bi-building"></i> Companies
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hr-brands-tab" data-bs-toggle="pill" data-bs-target="#hr-brands" type="button" role="tab">
                                    <i class="bi bi-tags"></i> Brands
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hr-depts-tab" data-bs-toggle="pill" data-bs-target="#hr-depts" type="button" role="tab">
                                    <i class="bi bi-folder"></i> Departments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hr-subdepts-tab" data-bs-toggle="pill" data-bs-target="#hr-subdepts" type="button" role="tab">
                                    <i class="bi bi-folder2"></i> Subdepartments
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="hr-structure-tab" data-bs-toggle="pill" data-bs-target="#hr-structure" type="button" role="tab">
                                    <i class="bi bi-diagram-3"></i> Structure Mapping
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="hrStructureTabContent">
                            <!-- Companies Sub-tab -->
                            <div class="tab-pane fade show active" id="hr-companies" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Companies</span>
                                        <span id="companiesCount" class="badge bg-secondary">0</span>
                                        <span id="companiesSelectedCount" class="badge bg-primary d-none">0 selected</span>
                                        <button class="btn btn-danger btn-sm d-none" id="companiesDeleteSelectedBtn" onclick="bulkDeleteCompanies()">
                                            <i class="bi bi-trash"></i> Delete Selected
                                        </button>
                                        <div class="input-group input-group-sm" style="width: 200px;">
                                            <input type="text" class="form-control" id="companiesSearchInput" placeholder="Search..." oninput="filterCompanies()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearCompaniesSearch()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#hrCompanyModal" onclick="openAddHrCompanyModal()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="companiesSelectAll" onchange="toggleSelectAllCompanies()"></th>
                                                <th>Company Name</th>
                                                <th>VAT Number</th>
                                                <th style="width: 80px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hrCompaniesTable">
                                            <tr class="loading-placeholder"><td colspan="4" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Brands Master Sub-tab -->
                            <div class="tab-pane fade" id="hr-brands" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Brands</span>
                                        <span id="brandsCount" class="badge bg-secondary">0</span>
                                        <span id="brandsSelectedCount" class="badge bg-primary d-none">0 selected</span>
                                        <button class="btn btn-danger btn-sm d-none" id="brandsDeleteSelectedBtn" onclick="bulkDeleteBrands()">
                                            <i class="bi bi-trash"></i> Delete Selected
                                        </button>
                                        <div class="input-group input-group-sm" style="width: 200px;">
                                            <input type="text" class="form-control" id="brandsSearchInput" placeholder="Search..." oninput="filterBrands()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearBrandsSearch()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="openAddMasterBrandModal()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="brandsSelectAll" onchange="toggleSelectAllBrands()"></th>
                                                <th>Brand Name</th>
                                                <th style="width: 80px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="masterBrandsTable">
                                            <tr class="loading-placeholder"><td colspan="3" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Departments Master Sub-tab -->
                            <div class="tab-pane fade" id="hr-depts" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Departments</span>
                                        <span id="deptsCount" class="badge bg-secondary">0</span>
                                        <span id="deptsSelectedCount" class="badge bg-primary d-none">0 selected</span>
                                        <button class="btn btn-danger btn-sm d-none" id="deptsDeleteSelectedBtn" onclick="bulkDeleteDepts()">
                                            <i class="bi bi-trash"></i> Delete Selected
                                        </button>
                                        <div class="input-group input-group-sm" style="width: 200px;">
                                            <input type="text" class="form-control" id="deptsSearchInput" placeholder="Search..." oninput="filterDepts()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearDeptsSearch()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="openAddMasterDeptModal()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="deptsSelectAll" onchange="toggleSelectAllDepts()"></th>
                                                <th>Department Name</th>
                                                <th style="width: 80px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="masterDeptsTable">
                                            <tr class="loading-placeholder"><td colspan="3" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Subdepartments Master Sub-tab -->
                            <div class="tab-pane fade" id="hr-subdepts" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Subdepartments</span>
                                        <span id="subdeptsCount" class="badge bg-secondary">0</span>
                                        <span id="subdeptsSelectedCount" class="badge bg-primary d-none">0 selected</span>
                                        <button class="btn btn-danger btn-sm d-none" id="subdeptsDeleteSelectedBtn" onclick="bulkDeleteSubdepts()">
                                            <i class="bi bi-trash"></i> Delete Selected
                                        </button>
                                        <div class="input-group input-group-sm" style="width: 200px;">
                                            <input type="text" class="form-control" id="subdeptsSearchInput" placeholder="Search..." oninput="filterSubdepts()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearSubdeptsSearch()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="openAddMasterSubdeptModal()">
                                        <i class="bi bi-plus-lg"></i> Add
                                    </button>
                                </div>
                                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="subdeptsSelectAll" onchange="toggleSelectAllSubdepts()"></th>
                                                <th>Subdepartment Name</th>
                                                <th style="width: 80px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="masterSubdeptsTable">
                                            <tr class="loading-placeholder"><td colspan="3" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Company Structure Sub-tab (formerly Departments) -->
                            <div class="tab-pane fade" id="hr-structure" role="tabpanel">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="text-muted small">Structure</span>
                                        <span id="structureCount" class="badge bg-secondary">0</span>
                                        <span id="structureSelectedCount" class="badge bg-primary d-none">0 selected</span>
                                        <button class="btn btn-danger btn-sm d-none" id="structureDeleteSelectedBtn" onclick="bulkDeleteStructure()">
                                            <i class="bi bi-trash"></i> Delete Selected
                                        </button>
                                        <div class="input-group input-group-sm" style="width: 180px;">
                                            <input type="text" class="form-control" id="structureSearchInput" placeholder="Search..." oninput="filterStructure()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearStructureSearch()"><i class="bi bi-x-lg"></i></button>
                                        </div>
                                        <select id="hrStructureCompanyFilter" class="form-select form-select-sm" style="width: 160px;" onchange="filterStructure()">
                                            <option value="">All Companies</option>
                                        </select>
                                        <select id="structureDeptFilter" class="form-select form-select-sm" style="width: 160px;" onchange="filterStructure()">
                                            <option value="">All Departments</option>
                                        </select>
                                    </div>
                                    <div class="d-flex gap-2 align-items-center">
                                        <select class="form-select form-select-sm" id="structureSortOrder" style="width: 140px;" onchange="filterStructure()">
                                            <option value="company_asc">Company A-Z</option>
                                            <option value="company_desc">Company Z-A</option>
                                            <option value="dept_asc">Dept A-Z</option>
                                            <option value="dept_desc">Dept Z-A</option>
                                        </select>
                                        <button class="btn btn-primary btn-sm" onclick="openAddStructureModal()">
                                            <i class="bi bi-plus-lg"></i> Add
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive" style="max-height: 450px; overflow-y: auto;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="structureSelectAll" onchange="toggleSelectAllStructure()"></th>
                                                <th style="cursor: pointer;" onclick="sortStructure('company')">Company <i class="bi bi-chevron-expand text-muted" style="font-size: 0.7rem;"></i></th>
                                                <th>Brand</th>
                                                <th style="cursor: pointer;" onclick="sortStructure('department')">Department <i class="bi bi-chevron-expand text-muted" style="font-size: 0.7rem;"></i></th>
                                                <th>Subdepartment</th>
                                                <th>Manager</th>
                                                <th style="width: 80px;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hrStructureTable">
                                            <tr class="loading-placeholder"><td colspan="7" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <div class="alert alert-info mt-3 mb-0 py-2 small">
                            <i class="bi bi-info-circle"></i> <strong>Platform-wide:</strong> Company structure data is shared across all J.A.R.V.I.S. modules (Accounting, HR, etc.)
                        </div>
                    </div>
                </div>
            </div>

            <!-- HR Tab -->
            <div class="tab-pane fade" id="hr-settings">
                <div class="card border-top-0 rounded-top-0">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-people"></i> HR Settings</h5>
                    </div>
                    <div class="card-body">
                        <!-- Events Module Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-body-tertiary">
                                <h6 class="mb-0"><i class="bi bi-calendar-event"></i> Events Module</h6>
                            </div>
                            <div class="card-body">
                                <!-- Bonus Types -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <strong><i class="bi bi-tags"></i> Bonus Types</strong>
                                        <p class="text-muted small mb-0">
                                            Configure bonus types used for event bonuses. Each bonus type defines a daily rate multiplied by days.
                                        </p>
                                    </div>
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addBonusTypeModal">
                                        <i class="bi bi-plus-lg"></i> Add Bonus Type
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm" id="bonusTypesTable">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th class="text-end">Amount (RON)</th>
                                                <th class="text-center">Days/Amount</th>
                                                <th>Description</th>
                                                <th class="text-center">Status</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bonusTypesTableBody">
                                            <tr class="loading-placeholder"><td colspan="6" class="text-center text-muted py-3"><i class="bi bi-hourglass-split"></i> Loading bonus types...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div id="noBonusTypesMessage" class="text-center text-muted py-4" style="display: none;">
                                    <i class="bi bi-tags display-4"></i>
                                    <p class="mt-2">No bonus types configured. Click "Add Bonus Type" to create one.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Bonus Type Modal -->
    <div class="modal fade" id="addBonusTypeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-plus-lg"></i> Add Bonus Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addBonusTypeForm">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" id="addBonusTypeName" class="form-control" required placeholder="e.g., Standard, Premium">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount (RON) <span class="text-danger">*</span></label>
                                <input type="number" id="addBonusTypeAmount" class="form-control" required step="0.01" min="0" placeholder="e.g., 150.00">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Days per Amount <span class="text-danger">*</span></label>
                                <input type="number" id="addBonusTypeDaysPerAmount" class="form-control" required step="0.5" min="0.5" value="1" placeholder="e.g., 1">
                                <small class="text-muted">How many days this amount covers</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea id="addBonusTypeDescription" class="form-control" rows="2" placeholder="Optional description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBonusType()">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Bonus Type Modal -->
    <div class="modal fade" id="editBonusTypeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Bonus Type</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editBonusTypeForm">
                        <input type="hidden" id="editBonusTypeId">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" id="editBonusTypeName" class="form-control" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Amount (RON) <span class="text-danger">*</span></label>
                                <input type="number" id="editBonusTypeAmount" class="form-control" required step="0.01" min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Days per Amount <span class="text-danger">*</span></label>
                                <input type="number" id="editBonusTypeDaysPerAmount" class="form-control" required step="0.5" min="0.5">
                                <small class="text-muted">How many days this amount covers</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea id="editBonusTypeDescription" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" id="editBonusTypeIsActive" class="form-check-input">
                                <label class="form-check-label" for="editBonusTypeIsActive">Active</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateBonusType()">
                        <i class="bi bi-check-lg"></i> Update
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit VAT Registry Modal -->
    <div class="modal fade" id="editVatModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Company</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVatOriginalCompany">
                    <div class="mb-3">
                        <label class="form-label">Company Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatCompanyName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Brands</label>
                        <input type="text" class="form-control" id="editVatBrands" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">VAT Number <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatNumber" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVatEdit()">
                        <i class="bi bi-check"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Department Structure Modal -->
    <div class="modal fade" id="departmentStructureModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="departmentStructureModalTitle">Add Department Structure</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="departmentStructureForm">
                        <input type="hidden" id="departmentStructureId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Company <span class="text-danger">*</span></label>
                                    <select class="form-select" id="dsCompany" required>
                                        <option value="">Select company...</option>
                                    </select>
                                    <small class="text-muted">Companies from VAT Registry</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Brand</label>
                                    <input type="text" class="form-control" id="dsBrand" list="brandList">
                                    <datalist id="brandList"></datalist>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dsDepartment" required list="departmentList">
                                    <datalist id="departmentList"></datalist>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Subdepartment</label>
                                    <input type="text" class="form-control" id="dsSubdepartment">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Manager</label>
                                    <div class="pills-input-container" id="dsManagerContainer" onclick="focusPillsInput('dsManagerSearch')">
                                        <div class="pills-area">
                                            <span id="dsManagerPills"></span>
                                            <input type="text" class="search-input" id="dsManagerSearch"
                                                   placeholder="Type to search..."
                                                   autocomplete="off"
                                                   onfocus="showPillsDropdown('manager')"
                                                   oninput="filterPillsDropdown('manager')">
                                        </div>
                                        <div class="pills-dropdown" id="dsManagerDropdown"></div>
                                    </div>
                                    <small class="text-muted">Search and select users as managers.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Marketing</label>
                                    <div class="pills-input-container" id="dsMarketingContainer" onclick="focusPillsInput('dsMarketingSearch')">
                                        <div class="pills-area">
                                            <span id="dsMarketingPills"></span>
                                            <input type="text" class="search-input" id="dsMarketingSearch"
                                                   placeholder="Type to search..."
                                                   autocomplete="off"
                                                   onfocus="showPillsDropdown('marketing')"
                                                   oninput="filterPillsDropdown('marketing')">
                                        </div>
                                        <div class="pills-dropdown" id="dsMarketingDropdown"></div>
                                    </div>
                                    <small class="text-muted">Search and select users for marketing.</small>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">CC Email</label>
                                    <input type="email" class="form-control" id="dsCcEmail" placeholder="department-cc@example.com">
                                    <small class="text-muted">Optional. Will be CC'd on all allocation notifications for this department.</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDepartmentStructure()">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="userPhone">
                        </div>
                        <div class="mb-3" id="passwordField">
                            <label class="form-label">Password <span class="text-danger" id="passwordRequired">*</span></label>
                            <input type="password" class="form-control" id="userPassword">
                            <small class="text-muted" id="passwordHelp">Required for new users</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role <span class="text-danger">*</span></label>
                            <select class="form-select" id="userRole" required>
                                <option value="">Select a role...</option>
                            </select>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="userActive" checked>
                            <label class="form-check-label" for="userActive">Active</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="userNotifyOnAllocation" checked>
                            <label class="form-check-label" for="userNotifyOnAllocation">Notify on Allocation</label>
                            <small class="d-block text-muted">Receive email notifications when allocated to invoices</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">
                        <i class="bi bi-check-lg"></i> Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Role Modal -->
    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roleModalTitle">Add Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="roleForm">
                        <input type="hidden" id="roleId">
                        <div class="mb-3">
                            <label class="form-label">Role Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="roleName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="roleDescription" placeholder="Optional description">
                        </div>
                        <div class="alert alert-info small mb-0">
                            <i class="bi bi-info-circle"></i> After creating the role, configure its permissions in the Access Permissions matrix.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRole()">
                        <i class="bi bi-check-lg"></i> Save Role
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
                    <p class="text-muted small">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit VAT Rate Modal -->
    <div class="modal fade" id="editVatRateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit VAT Rate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editVatRateId">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editVatRateName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate (%) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editVatRateValue" step="0.01" min="0" max="100" required>
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="editVatRateDefault">
                        <label class="form-check-label" for="editVatRateDefault">Default VAT rate</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editVatRateActive">
                        <label class="form-check-label" for="editVatRateActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedVatRate()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- HR Company Modal -->
    <div class="modal fade" id="hrCompanyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-building"></i> <span id="hrCompanyModalTitle">Add Company</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="hrCompanyForm">
                        <input type="hidden" id="hrCompanyId">
                        <input type="hidden" id="hrCompanyDbId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Company Name *</label>
                                <input type="text" id="hrCompanyName" class="form-control" required placeholder="e.g., Autoworld S.R.L.">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">VAT Number</label>
                                <input type="text" id="hrCompanyVat" class="form-control" placeholder="e.g., RO 12345678">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-tags"></i> Brands</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCompanyBrandRow()">
                                    <i class="bi bi-plus"></i> Add Brand
                                </button>
                            </label>
                            <div id="hrCompanyBrandsList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; background: var(--bs-body-bg);">
                                <div class="text-muted small text-center py-2" id="noBrandsMessage">No brands added yet</div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveHrCompany()">Save Company</button>
                </div>
            </div>
        </div>
    </div>

    <!-- HR Department Modal -->
    <div class="modal fade" id="hrDepartmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-diagram-2"></i> <span id="hrDepartmentModalTitle">Add Department</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="hrDepartmentForm">
                        <input type="hidden" id="hrDepartmentId">
                        <div class="mb-3">
                            <label class="form-label">Company *</label>
                            <select id="hrDeptCompany" class="form-select" required>
                                <option value="">Select Company</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <select id="hrDeptBrand" class="form-select">
                                <option value="">Select Brand (optional)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department *</label>
                            <input type="text" id="hrDeptName" class="form-control" required placeholder="e.g., Sales, Marketing">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subdepartment</label>
                            <input type="text" id="hrDeptSubdepartment" class="form-control" placeholder="e.g., New Cars, Used Cars">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manager</label>
                            <input type="text" id="hrDeptManager" class="form-control" placeholder="Manager name">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveHrDepartment()">Save Department</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Master Brand Modal -->
    <div class="modal fade" id="masterBrandModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-tags"></i> <span id="masterBrandModalTitle">Add Brand</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="masterBrandForm">
                        <input type="hidden" id="masterBrandId">
                        <div class="mb-3">
                            <label class="form-label">Brand Name *</label>
                            <input type="text" id="masterBrandName" class="form-control" required placeholder="e.g., Audi, Volkswagen">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMasterBrand()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Master Department Modal -->
    <div class="modal fade" id="masterDeptModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-folder"></i> <span id="masterDeptModalTitle">Add Department</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="masterDeptForm">
                        <input type="hidden" id="masterDeptId">
                        <div class="mb-3">
                            <label class="form-label">Department Name *</label>
                            <input type="text" id="masterDeptName" class="form-control" required placeholder="e.g., Sales, Marketing">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMasterDept()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Master Subdepartment Modal -->
    <div class="modal fade" id="masterSubdeptModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-folder2"></i> <span id="masterSubdeptModalTitle">Add Subdepartment</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="masterSubdeptForm">
                        <input type="hidden" id="masterSubdeptId">
                        <div class="mb-3">
                            <label class="form-label">Subdepartment Name *</label>
                            <input type="text" id="masterSubdeptName" class="form-control" required placeholder="e.g., New Cars, Used Cars">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMasterSubdept()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Structure Modal (uses dropdowns for all fields) -->
    <div class="modal fade" id="structureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-diagram-3"></i> <span id="structureModalTitle">Add Structure Entry</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="structureForm">
                        <input type="hidden" id="structureId">
                        <div class="mb-3">
                            <label class="form-label">Company *</label>
                            <select id="structureCompany" class="form-select" required>
                                <option value="">Select Company</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Brand</label>
                            <select id="structureBrand" class="form-select">
                                <option value="">Select Brand (optional)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Department *</label>
                            <select id="structureDept" class="form-select" required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subdepartment</label>
                            <select id="structureSubdept" class="form-select">
                                <option value="">Select Subdepartment (optional)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Manager</label>
                            <div class="position-relative">
                                <input type="text" id="structureManagerSearch" class="form-control" placeholder="Search users..." autocomplete="off">
                                <input type="hidden" id="structureManagerId">
                                <div id="structureManagerDropdown" class="dropdown-menu w-100" style="max-height: 200px; overflow-y: auto; position: absolute; top: 100%; left: 0; z-index: 1050;"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStructure()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let users = [];
        let roles = [];
        let notificationSettings = {};
        let deleteType = null;
        let deleteId = null;
        let companiesWithVat = [];
        let vatRates = [];
        let bonusTypes = [];
        let currentTheme = null;
        let currentThemeId = null;

        // HR Company Structure data
        let hrCompaniesData = [];
        let filteredCompaniesData = [];
        let hrDepartmentsData = [];

        // Master Tables Data
        let masterBrandsData = [];
        let filteredBrandsData = [];
        let masterDeptsData = [];
        let filteredDeptsData = [];
        let masterSubdeptsData = [];
        let filteredSubdeptsData = [];
        let structureData = [];
        let filteredStructureData = [];

        // Selection state (stores IDs of selected items)
        let selectedCompanies = new Set();
        let selectedBrands = new Set();
        let selectedDepts = new Set();
        let selectedSubdepts = new Set();
        let selectedStructure = new Set();

        // Permission Matrix data
        let permissionMatrix = { modules: [], roles: [], role_permissions: {} };
        let selectedModule = null;
        let pendingPermissionChanges = {}; // {role_id: {perm_id: {scope/granted}}}

        // Theme color fields mapping
        const themeColorFields = [
            'bgBody', 'bgCard', 'bgTableHeader', 'bgTableHover', 'bgInput',
            'textPrimary', 'textSecondary', 'borderColor',
            'accentPrimary', 'accentSuccess', 'accentWarning', 'accentDanger', 'navbarBg'
        ];

        // Default theme values
        const defaultTheme = {
            light: {
                bgBody: '#f5f5f5',
                bgCard: '#ffffff',
                bgTableHeader: '#f8f9fa',
                bgTableHover: '#e3f2fd',
                bgInput: '#ffffff',
                textPrimary: '#212529',
                textSecondary: '#6c757d',
                borderColor: '#dee2e6',
                accentPrimary: '#0d6efd',
                accentSuccess: '#198754',
                accentWarning: '#ffc107',
                accentDanger: '#dc3545',
                navbarBg: '#6c757d'
            },
            dark: {
                bgBody: '#1a1a2e',
                bgCard: '#16213e',
                bgTableHeader: '#0f3460',
                bgTableHover: '#1f4068',
                bgInput: '#0f3460',
                textPrimary: '#e4e4e4',
                textSecondary: '#a0a0a0',
                borderColor: '#2d4a6e',
                accentPrimary: '#64b5f6',
                accentSuccess: '#81c784',
                accentWarning: '#ffb74d',
                accentDanger: '#ef5350',
                navbarBg: '#0f3460'
            },
            logo: {
                type: 'svg',
                svgUrl: '/static/img/jarvis-icon.svg',
                icon: 'bi-cpu',
                text: 'J.A.R.V.I.S.',
                imageUrl: ''
            }
        };

        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        const roleModal = new bootstrap.Modal(document.getElementById('roleModal'));
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        const editVatRateModal = new bootstrap.Modal(document.getElementById('editVatRateModal'));

        // Loading overlay helpers
        let loadingCount = 0;
        function showLoading(message = 'Loading...') {
            loadingCount++;
            const overlay = document.getElementById('loadingOverlay');
            const text = overlay.querySelector('.loading-text');
            text.textContent = message;
            overlay.classList.add('show');
        }
        function hideLoading() {
            loadingCount = Math.max(0, loadingCount - 1);
            if (loadingCount === 0) {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        function setLoadingMessage(message) {
            document.querySelector('#loadingOverlay .loading-text').textContent = message;
        }

        document.addEventListener('DOMContentLoaded', () => {
            showLoading('Loading settings...');
            Promise.all([
                loadRoles(),
                loadUsers(),
                loadNotificationSettings(),
                loadCompaniesWithVat(),
                loadDepartmentStructures(),
                loadVatRates(),
                loadDropdownOptions(),
                loadThemeSettings(),
                loadPermissionMatrix()
            ]).finally(() => {
                hideLoading();
            });

            // Event listener for Add Company VAT button
            document.getElementById('addCompanyVatBtn')?.addEventListener('click', addNewCompanyVat);
            // Event listener for Add VAT Rate button
            document.getElementById('addVatRateBtn')?.addEventListener('click', addNewVatRate);
            // Initialize theme color picker sync
            initThemeColorPickers();
            // Module search filter
            document.getElementById('moduleSearch')?.addEventListener('input', filterModules);

            // ========== TAB PERSISTENCE ==========
            // Save active tab to localStorage when changed
            document.querySelectorAll('#settingsTabs button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const tabId = e.target.id;
                    localStorage.setItem('settingsActiveTab', tabId);
                    // Also update URL hash for bookmarking
                    history.replaceState(null, null, '#' + tabId.replace('-tab', ''));
                });
            });

            // Restore active tab from URL hash or localStorage
            const hash = window.location.hash.slice(1);
            let tabToActivate = null;

            if (hash) {
                // Try to find tab from URL hash
                tabToActivate = document.getElementById(hash + '-tab');
            }

            if (!tabToActivate) {
                // Fall back to localStorage
                const savedTab = localStorage.getItem('settingsActiveTab');
                if (savedTab) {
                    tabToActivate = document.getElementById(savedTab);
                }
            }

            if (tabToActivate && tabToActivate.id !== 'users-tab') {
                // Use click to properly trigger Bootstrap tab switching
                tabToActivate.click();
            }
        });

        // ========== DATA LOADING ==========

        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                users = await res.json();
                renderUsers();
                updateSummary();
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        async function loadRoles() {
            try {
                const res = await fetch('/api/roles');
                roles = await res.json();
                renderRoles();
                populateRoleDropdown();
                updateSummary();
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        function updateSummary() {
            const total = users.length;
            const active = users.filter(u => u.is_active).length;

            const totalUsersEl = document.getElementById('totalUsers');
            const activeUsersEl = document.getElementById('activeUsers');
            const totalRolesEl = document.getElementById('totalRoles');

            if (totalUsersEl) totalUsersEl.textContent = total;
            if (activeUsersEl) activeUsersEl.textContent = active;
            if (totalRolesEl) totalRolesEl.textContent = roles.length;
        }

        // ========== USERS ==========

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            const noUsersMsg = document.getElementById('noUsersMessage');

            if (users.length === 0) {
                tbody.innerHTML = '';
                noUsersMsg.style.display = 'block';
                return;
            }

            noUsersMsg.style.display = 'none';
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><input type="checkbox" class="form-check-input user-checkbox" data-id="${user.id}"></td>
                    <td><strong>${escapeHtml(user.name)}</strong></td>
                    <td><a href="mailto:${escapeHtml(user.email)}">${escapeHtml(user.email)}</a></td>
                    <td>${user.phone ? escapeHtml(user.phone) : '<span class="text-muted">-</span>'}</td>
                    <td>
                        ${user.role_name
                            ? `<span class="badge bg-primary role-badge">${escapeHtml(user.role_name)}</span>`
                            : '<span class="badge bg-secondary role-badge">No Role</span>'}
                    </td>
                    <td>
                        ${user.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${user.id})" title="Edit" aria-label="Edit user">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('user', ${user.id}, '${escapeHtml(user.name)}')" title="Delete" aria-label="Delete user">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            // Re-attach checkbox event listeners after render
            attachUserCheckboxListeners();
        }

        // ============== Users Select All / Bulk Delete ==============
        function attachUserCheckboxListeners() {
            document.querySelectorAll('.user-checkbox').forEach(cb => {
                cb.addEventListener('change', updateUserSelectionUI);
            });
        }

        function updateUserSelectionUI() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            const count = checkedBoxes.length;

            const deleteBtn = document.getElementById('btnDeleteSelectedUsers');
            const countSpan = document.getElementById('selectedUsersCount');
            const selectAllCheckbox = document.getElementById('selectAllUsers');

            countSpan.textContent = count;

            if (count > 0) {
                deleteBtn.classList.remove('d-none');
            } else {
                deleteBtn.classList.add('d-none');
            }

            if (checkboxes.length > 0 && checkedBoxes.length === checkboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedBoxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        document.getElementById('selectAllUsers').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateUserSelectionUI();
        });

        document.getElementById('btnDeleteSelectedUsers').addEventListener('click', async function() {
            const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.dataset.id);

            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} selected user${ids.length > 1 ? 's' : ''}?`,
                { danger: true }
            );
            if (!confirmed) return;

            const resp = await fetch('/api/users/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids })
            });

            if (resp.ok) {
                await loadUsers();
                updateUserSelectionUI();
                JarvisToast.success(`Deleted ${ids.length} user${ids.length > 1 ? 's' : ''}`);
            } else {
                await JarvisDialog.alert('Error deleting users', { type: 'error' });
            }
        });

        function populateRoleDropdown() {
            const select = document.getElementById('userRole');
            select.innerHTML = '<option value="">Select a role...</option>' +
                roles.map(r => `<option value="${r.id}">${escapeHtml(r.name)}</option>`).join('');
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userId').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = '';
            document.getElementById('userActive').checked = true;
            document.getElementById('userNotifyOnAllocation').checked = true;
            // Show password as required for new users
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('passwordHelp').textContent = 'Required for new users';
            userModal.show();
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.name;
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role_id || '';
            document.getElementById('userActive').checked = user.is_active;
            document.getElementById('userNotifyOnAllocation').checked = user.notify_on_allocation !== false;
            // Password is optional when editing
            document.getElementById('passwordRequired').style.display = 'none';
            document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
            userModal.show();
        }

        async function saveUser() {
            const userId = document.getElementById('userId').value;
            const roleId = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value.trim();
            const userData = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim() || null,
                role_id: roleId ? parseInt(roleId) : null,
                is_active: document.getElementById('userActive').checked,
                notify_on_allocation: document.getElementById('userNotifyOnAllocation').checked
            };

            if (!userData.name || !userData.email) {
                await JarvisDialog.alert('Name and email are required', { type: 'warning' });
                return;
            }

            // Password required for new users
            if (!userId && !password) {
                await JarvisDialog.alert('Password is required for new users', { type: 'warning' });
                return;
            }

            // Include password if provided
            if (password) {
                userData.password = password;
            }

            try {
                const url = userId ? `/api/users/${userId}` : '/api/users';
                const method = userId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await res.json();

                if (result.success || result.id) {
                    userModal.hide();
                    loadUsers();
                } else {
                    await JarvisDialog.alert(result.error || 'Failed to save user', { type: 'error' });
                }
            } catch (error) {
                console.error('Error saving user:', error);
                await JarvisDialog.alert('Failed to save user', { type: 'error' });
            }
        }

        // ========== ROLES ==========

        // Module colors for permission badges
        const moduleColors = {
            system: 'secondary',
            invoices: 'primary',
            accounting: 'success',
            hr: 'info'
        };

        // Permission icon mapping
        const permissionIcons = {
            'system.settings': 'bi-gear',
            'system.activity_logs': 'bi-clock-history',
            'invoices.view': 'bi-eye',
            'invoices.add': 'bi-plus-circle',
            'invoices.edit': 'bi-pencil',
            'invoices.delete': 'bi-trash',
            'accounting.dashboard': 'bi-calculator',
            'accounting.export': 'bi-download',
            'accounting.templates': 'bi-file-earmark-text',
            'accounting.connectors': 'bi-plug',
            'hr.access': 'bi-people',
            'hr.manager': 'bi-person-badge'
        };

        function renderRoles() {
            // Old role table rendering is no longer used - replaced by permission matrix
            // This function now just exists for backward compatibility
            // Role dropdown population is handled by populateRoleDropdown()
            return;
        }

        // Cache for permissions modules
        let permissionsModules = null;

        async function loadPermissions() {
            if (permissionsModules) return permissionsModules;
            try {
                const res = await fetch('/api/permissions');
                const data = await res.json();
                permissionsModules = data.modules || [];
                return permissionsModules;
            } catch (error) {
                console.error('Error loading permissions:', error);
                return [];
            }
        }

        function renderPermissionsModal(selectedPermissions = []) {
            const container = document.getElementById('permissionsContainer');
            if (!permissionsModules || permissionsModules.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No permissions available</div>';
                return;
            }

            const selectedSet = new Set(selectedPermissions.map(p => typeof p === 'string' ? p : p.key));

            // Render accordion for each module
            container.innerHTML = permissionsModules.map((module, idx) => {
                const modulePerms = module.permissions || [];
                const checkedCount = modulePerms.filter(p => selectedSet.has(`${module.key}.${p.permission_key}`)).length;

                return `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                            <span><i class="bi ${modulePerms[0]?.icon || 'bi-folder'}"></i> ${module.label}</span>
                            <span class="badge bg-${moduleColors[module.key] || 'secondary'}">${checkedCount}/${modulePerms.length}</span>
                        </div>
                        <div class="card-body py-2">
                            ${modulePerms.map(perm => {
                                const permKey = `${module.key}.${perm.permission_key}`;
                                const isChecked = selectedSet.has(permKey);
                                const isChild = perm.parent_id != null;
                                return `
                                <div class="form-check ${isChild ? 'ms-3' : ''} mb-1">
                                    <input class="form-check-input perm-checkbox" type="checkbox"
                                        id="perm_${permKey.replace('.', '_')}"
                                        data-perm-key="${permKey}"
                                        ${isChecked ? 'checked' : ''}>
                                    <label class="form-check-label small" for="perm_${permKey.replace('.', '_')}">
                                        <i class="bi ${perm.icon || 'bi-check'}"></i> ${perm.label}
                                    </label>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function showAddRoleModal() {
            document.getElementById('roleModalTitle').textContent = 'Add Role';
            document.getElementById('roleId').value = '';
            document.getElementById('roleName').value = '';
            document.getElementById('roleDescription').value = '';
            roleModal.show();
        }

        function editRole(roleId) {
            const role = roles.find(r => r.id === roleId);
            if (!role) return;

            document.getElementById('roleModalTitle').textContent = 'Edit Role';
            document.getElementById('roleId').value = role.id;
            document.getElementById('roleName').value = role.name;
            document.getElementById('roleDescription').value = role.description || '';
            roleModal.show();
        }

        async function saveRole() {
            const roleId = document.getElementById('roleId').value;
            const name = document.getElementById('roleName').value.trim();
            const description = document.getElementById('roleDescription').value.trim() || null;

            if (!name) {
                await JarvisDialog.alert('Role name is required', { type: 'warning' });
                return;
            }

            try {
                const roleData = { name, description };
                const url = roleId ? `/api/roles/${roleId}` : '/api/roles';
                const method = roleId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roleData)
                });

                const result = await res.json();

                if (!result.success && !result.id) {
                    await JarvisDialog.alert(result.error || 'Failed to save role', { type: 'error' });
                    return;
                }

                roleModal.hide();
                loadRoles();
                // Reload permission matrix to include new role column
                loadPermissionMatrix();

            } catch (error) {
                console.error('Error saving role:', error);
                await JarvisDialog.alert('Failed to save role', { type: 'error' });
            }
        }

        // ========== DELETE ==========

        function showDeleteModal(type, id, name) {
            deleteType = type;
            deleteId = id;
            document.getElementById('deleteItemName').textContent = name;
            deleteModal.show();
        }

        async function confirmDelete() {
            if (!deleteType || !deleteId) return;

            try {
                let url;
                if (deleteType === 'user') url = `/api/users/${deleteId}`;
                else if (deleteType === 'role') url = `/api/roles/${deleteId}`;
                else if (deleteType === 'vat_rate') url = `/api/vat-rates/${deleteId}`;
                const res = await fetch(url, { method: 'DELETE' });
                const result = await res.json();

                if (result.success) {
                    deleteModal.hide();
                    if (deleteType === 'user') loadUsers();
                    else if (deleteType === 'role') { loadRoles(); loadPermissionMatrix(); }
                    else if (deleteType === 'vat_rate') loadVatRates();
                } else {
                    await JarvisDialog.alert(result.error || 'Failed to delete', { type: 'error' });
                }
            } catch (error) {
                console.error('Error deleting:', error);
                await JarvisDialog.alert('Failed to delete', { type: 'error' });
            } finally {
                deleteType = null;
                deleteId = null;
            }
        }

        // ========== NOTIFICATION SETTINGS ==========

        async function loadNotificationSettings() {
            try {
                const res = await fetch('/api/notification-settings');
                const settings = await res.json();
                // API returns a dictionary directly, no need to transform
                notificationSettings = settings;
                populateNotificationSettings();
            } catch (error) {
                console.error('Error loading notification settings:', error);
            }
        }

        function populateNotificationSettings() {
            document.getElementById('smtpHost').value = notificationSettings.smtp_host || '';
            document.getElementById('smtpPort').value = notificationSettings.smtp_port || '';
            document.getElementById('smtpTls').checked = notificationSettings.smtp_tls !== 'false';
            document.getElementById('smtpUsername').value = notificationSettings.smtp_username || '';
            document.getElementById('smtpPassword').value = notificationSettings.smtp_password || '';
            document.getElementById('fromEmail').value = notificationSettings.from_email || '';
            document.getElementById('fromName').value = notificationSettings.from_name || '';
            document.getElementById('notifyOnAllocation').checked = notificationSettings.notify_on_allocation !== 'false';
            document.getElementById('globalCc').value = notificationSettings.global_cc || '';
        }

        async function saveNotificationSettings() {
            const settingsData = {
                smtp_host: document.getElementById('smtpHost').value.trim(),
                smtp_port: document.getElementById('smtpPort').value.trim(),
                smtp_tls: document.getElementById('smtpTls').checked ? 'true' : 'false',
                smtp_username: document.getElementById('smtpUsername').value.trim(),
                smtp_password: document.getElementById('smtpPassword').value.trim(),
                from_email: document.getElementById('fromEmail').value.trim(),
                from_name: document.getElementById('fromName').value.trim(),
                notify_on_allocation: document.getElementById('notifyOnAllocation').checked ? 'true' : 'false',
                global_cc: document.getElementById('globalCc').value.trim()
            };

            try {
                const res = await fetch('/api/notification-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await res.json();

                if (result.success) {
                    await JarvisDialog.alert('Notification settings saved successfully!', { type: 'success' });
                    loadNotificationSettings();
                } else {
                    await JarvisDialog.alert(result.error || 'Failed to save settings', { type: 'error' });
                }
            } catch (error) {
                console.error('Error saving notification settings:', error);
                await JarvisDialog.alert('Failed to save settings', { type: 'error' });
            }
        }

        async function testEmailSettings() {
            const fromEmail = document.getElementById('fromEmail').value;
            if (!fromEmail) {
                showToast('Please enter a "From Email" address first', 'warning');
                return;
            }

            // Ask for test recipient email
            const testEmail = prompt('Enter email address to send test email to:', fromEmail);
            if (!testEmail) {
                return;
            }

            try {
                const btn = document.querySelector('button[onclick="testEmailSettings()"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';

                const response = await fetch('/api/notification-settings/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: testEmail })
                });

                const result = await response.json();

                btn.disabled = false;
                btn.innerHTML = originalText;

                if (result.success) {
                    showToast(`Test email sent to ${testEmail}`, 'success');
                } else {
                    showToast(`Failed to send test email: ${result.error}`, 'danger');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        }

        // ========== DEPARTMENT STRUCTURE ==========

        let departmentStructuresData = [];

        async function loadDepartmentStructures() {
            try {
                const dsRes = await fetch('/api/department-structures');
                departmentStructuresData = await dsRes.json();
                renderDepartmentStructuresTable();
            } catch (error) {
                console.error('Error loading department structures:', error);
            }
        }

        function renderDepartmentStructuresTable() {
            const tbody = document.getElementById('departmentStructuresTableBody');
            const noMsg = document.getElementById('noDepartmentStructuresMessage');

            if (!tbody) return;

            if (departmentStructuresData.length === 0) {
                tbody.innerHTML = '';
                if (noMsg) noMsg.style.display = 'block';
                return;
            }

            if (noMsg) noMsg.style.display = 'none';
            tbody.innerHTML = departmentStructuresData.map(ds => {
                // Get manager names from manager_ids
                const managerNames = (ds.manager_ids || [])
                    .map(id => users.find(r => r.id === id))
                    .filter(r => r)
                    .map(r => r.name)
                    .join(', ') || '-';

                // Get marketing names from marketing_ids
                const marketingNames = (ds.marketing_ids || [])
                    .map(id => users.find(r => r.id === id))
                    .filter(r => r)
                    .map(r => r.name)
                    .join(', ') || '-';

                return `
                    <tr>
                        <td>${escapeHtml(ds.company)}</td>
                        <td>${escapeHtml(ds.brand || '-')}</td>
                        <td>${escapeHtml(ds.department)}</td>
                        <td>${escapeHtml(ds.subdepartment || '-')}</td>
                        <td>${escapeHtml(managerNames)}</td>
                        <td>${escapeHtml(marketingNames)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDepartmentStructure(${ds.id})" title="Edit" aria-label="Edit department structure">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDepartmentStructure(${ds.id})" title="Delete" aria-label="Delete department structure">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Store selected IDs for manager and marketing
        let selectedManagerIds = [];
        let selectedMarketingIds = [];

        function showAddDepartmentStructureModal() {
            document.getElementById('departmentStructureModalTitle').textContent = 'Add Department Structure';
            document.getElementById('departmentStructureForm').reset();
            document.getElementById('departmentStructureId').value = '';
            document.getElementById('dsCcEmail').value = '';
            selectedManagerIds = [];
            selectedMarketingIds = [];
            renderPills('manager');
            renderPills('marketing');
            populateDSDataLists();
            new bootstrap.Modal(document.getElementById('departmentStructureModal')).show();
        }

        function editDepartmentStructure(id) {
            const ds = departmentStructuresData.find(d => d.id === id);
            if (!ds) return;

            document.getElementById('departmentStructureModalTitle').textContent = 'Edit Department Structure';
            document.getElementById('departmentStructureId').value = ds.id;
            document.getElementById('dsCompany').value = ds.company || '';
            document.getElementById('dsBrand').value = ds.brand || '';
            document.getElementById('dsDepartment').value = ds.department || '';
            document.getElementById('dsSubdepartment').value = ds.subdepartment || '';
            document.getElementById('dsCcEmail').value = ds.cc_email || '';
            selectedManagerIds = ds.manager_ids || [];
            selectedMarketingIds = ds.marketing_ids || [];
            renderPills('manager');
            renderPills('marketing');
            populateDSDataLists();
            new bootstrap.Modal(document.getElementById('departmentStructureModal')).show();
        }

        function focusPillsInput(inputId) {
            document.getElementById(inputId).focus();
        }

        function getSelectedIds(fieldName) {
            return fieldName === 'manager' ? selectedManagerIds : selectedMarketingIds;
        }

        function setSelectedIds(fieldName, ids) {
            if (fieldName === 'manager') {
                selectedManagerIds = ids;
            } else {
                selectedMarketingIds = ids;
            }
        }

        function renderPills(fieldName) {
            const pillsContainer = document.getElementById(`ds${capitalize(fieldName)}Pills`);
            const selectedIds = getSelectedIds(fieldName);
            const activeUsers = users.filter(r => r.is_active);

            pillsContainer.innerHTML = selectedIds.map(id => {
                const user = activeUsers.find(u => u.id === id);
                if (!user) return '';
                return `
                    <span class="pill" data-id="${id}">
                        ${escapeHtml(user.name)}
                        <span class="remove-pill" onclick="removePill('${fieldName}', ${id})">&times;</span>
                    </span>
                `;
            }).join('');
        }

        function removePill(fieldName, id) {
            const selectedIds = getSelectedIds(fieldName);
            const index = selectedIds.indexOf(id);
            if (index > -1) {
                selectedIds.splice(index, 1);
                setSelectedIds(fieldName, selectedIds);
                renderPills(fieldName);
            }
        }

        function showPillsDropdown(fieldName) {
            filterPillsDropdown(fieldName);
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            dropdown.classList.add('show');
        }

        function hidePillsDropdown(fieldName) {
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            dropdown.classList.remove('show');
        }

        function filterPillsDropdown(fieldName) {
            const searchInput = document.getElementById(`ds${capitalize(fieldName)}Search`);
            const dropdown = document.getElementById(`ds${capitalize(fieldName)}Dropdown`);
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedIds = getSelectedIds(fieldName);
            const activeUsers = users.filter(r => r.is_active);

            // Filter out already selected and match search term
            const filtered = activeUsers.filter(r =>
                !selectedIds.includes(r.id) &&
                r.name.toLowerCase().includes(searchTerm)
            );

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="pills-dropdown-empty">No users found</div>';
            } else {
                dropdown.innerHTML = filtered.map(u => `
                    <div class="pills-dropdown-item" onclick="selectUser('${fieldName}', ${u.id})">
                        ${escapeHtml(u.name)}
                    </div>
                `).join('');
            }

            dropdown.classList.add('show');
        }

        function selectUser(fieldName, id) {
            const selectedIds = getSelectedIds(fieldName);
            if (!selectedIds.includes(id)) {
                selectedIds.push(id);
                setSelectedIds(fieldName, selectedIds);
                renderPills(fieldName);
            }
            // Clear search and hide dropdown
            const searchInput = document.getElementById(`ds${capitalize(fieldName)}Search`);
            searchInput.value = '';
            hidePillsDropdown(fieldName);
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const managerContainer = document.getElementById('dsManagerContainer');
            const marketingContainer = document.getElementById('dsMarketingContainer');

            if (managerContainer && !managerContainer.contains(e.target)) {
                hidePillsDropdown('manager');
            }
            if (marketingContainer && !marketingContainer.contains(e.target)) {
                hidePillsDropdown('marketing');
            }
        });

        function populateDSDataLists() {
            // Populate company select from VAT Registry
            const companySelect = document.getElementById('dsCompany');
            const currentValue = companySelect.value;
            companySelect.innerHTML = '<option value="">Select company...</option>' +
                companiesWithVat.map(c => `<option value="${escapeHtml(c.company)}">${escapeHtml(c.company)}</option>`).join('');
            // Restore previous selection if exists
            if (currentValue) {
                companySelect.value = currentValue;
            }

            // Populate brand list from existing department structures
            const brands = [...new Set(departmentStructuresData.map(d => d.brand).filter(b => b))];
            const brandList = document.getElementById('brandList');
            brandList.innerHTML = brands.map(b => `<option value="${escapeHtml(b)}">`).join('');

            // Populate department list from existing department structures
            const departments = [...new Set(departmentStructuresData.map(d => d.department).filter(d => d))];
            const departmentList = document.getElementById('departmentList');
            departmentList.innerHTML = departments.map(d => `<option value="${escapeHtml(d)}">`).join('');
        }

        async function saveDepartmentStructure() {
            const id = document.getElementById('departmentStructureId').value;
            const company = document.getElementById('dsCompany').value.trim();
            const department = document.getElementById('dsDepartment').value.trim();

            if (!company || !department) {
                await JarvisDialog.alert('Company and Department are required', { type: 'warning' });
                return;
            }

            const managerIds = selectedManagerIds;
            const marketingIds = selectedMarketingIds;

            const data = {
                company: company,
                brand: document.getElementById('dsBrand').value.trim() || null,
                department: department,
                subdepartment: document.getElementById('dsSubdepartment').value.trim() || null,
                manager_ids: managerIds.length > 0 ? managerIds : null,
                marketing_ids: marketingIds.length > 0 ? marketingIds : null,
                cc_email: document.getElementById('dsCcEmail').value.trim() || null
            };

            try {
                const url = id ? `/api/department-structures/${id}` : '/api/department-structures';
                const method = id ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('departmentStructureModal')).hide();
                    loadDepartmentStructures();
                    showToast(id ? 'Department structure updated' : 'Department structure created', 'success');
                } else {
                    await JarvisDialog.alert(result.error || 'Failed to save department structure', { type: 'error' });
                }
            } catch (error) {
                console.error('Error saving department structure:', error);
                await JarvisDialog.alert('Failed to save department structure', { type: 'error' });
            }
        }

        async function deleteDepartmentStructure(id) {
            const confirmed = await JarvisDialog.confirm('Are you sure you want to delete this department structure?', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/api/department-structures/${id}`, { method: 'DELETE' });
                const result = await res.json();

                if (result.success) {
                    loadDepartmentStructures();
                    showToast('Department structure deleted', 'success');
                } else {
                    await JarvisDialog.alert(result.error || 'Failed to delete department structure', { type: 'error' });
                }
            } catch (error) {
                console.error('Error deleting department structure:', error);
                await JarvisDialog.alert('Failed to delete department structure', { type: 'error' });
            }
        }

        // ========== VAT REGISTRY ==========

        async function loadCompaniesWithVat() {
            try {
                const res = await fetch('/api/companies-vat');
                companiesWithVat = await res.json();
                renderCompaniesVatTable();
            } catch (error) {
                console.error('Error loading companies with VAT:', error);
            }
        }

        function renderCompaniesVatTable() {
            const tbody = document.getElementById('companiesVatTableBody');
            const noMsg = document.getElementById('noCompaniesVatMessage');
            const table = document.getElementById('companiesVatTable');

            if (!tbody) return;

            if (companiesWithVat.length === 0) {
                tbody.innerHTML = '';
                if (noMsg) noMsg.style.display = 'block';
                if (table) table.style.display = 'none';
                return;
            }

            if (noMsg) noMsg.style.display = 'none';
            if (table) table.style.display = 'table';
            tbody.innerHTML = companiesWithVat.map(c => `
                <tr>
                    <td><strong>${escapeHtml(c.company || '')}</strong></td>
                    <td>${escapeHtml(c.brands || '-')}</td>
                    <td><code>${escapeHtml(c.vat || '')}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCompanyVat('${escapeHtml(c.company)}')" title="Edit" aria-label="Edit company">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCompanyVat('${escapeHtml(c.company)}')" title="Delete" aria-label="Delete company">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewCompanyVat() {
            const name = document.getElementById('newCompanyName').value.trim();
            const brands = document.getElementById('newCompanyBrands').value.trim();
            const vat = document.getElementById('newCompanyVat').value.trim();

            if (!name || !vat) {
                await JarvisDialog.alert('Company name and VAT number are required', { type: 'warning' });
                return;
            }

            try {
                const res = await fetch('/api/companies-vat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: name, brands, vat })
                });

                const result = await res.json();
                if (result.success) {
                    document.getElementById('newCompanyName').value = '';
                    document.getElementById('newCompanyBrands').value = '';
                    document.getElementById('newCompanyVat').value = '';
                    await loadCompaniesWithVat();
                    showToast('Company added to VAT registry', 'success');
                } else {
                    await JarvisDialog.alert('Error adding company: ' + result.error, { type: 'error' });
                }
            } catch (error) {
                console.error('Error adding company:', error);
                await JarvisDialog.alert('Failed to add company', { type: 'error' });
            }
        }

        async function deleteCompanyVat(company) {
            const confirmed = await JarvisDialog.confirm(`Delete "${company}" from VAT registry?`, { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/api/companies-vat/${encodeURIComponent(company)}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    await loadCompaniesWithVat();
                    showToast('Company removed from VAT registry', 'success');
                } else {
                    await JarvisDialog.alert('Error deleting company: ' + result.error, { type: 'error' });
                }
            } catch (error) {
                console.error('Error deleting company:', error);
                await JarvisDialog.alert('Failed to delete company', { type: 'error' });
            }
        }

        function editCompanyVat(company) {
            const c = companiesWithVat.find(item => item.company === company);
            if (!c) return;

            document.getElementById('editVatOriginalCompany').value = c.company;
            document.getElementById('editVatCompanyName').value = c.company || '';
            document.getElementById('editVatBrands').value = c.brands || '';
            document.getElementById('editVatNumber').value = c.vat || '';

            new bootstrap.Modal(document.getElementById('editVatModal')).show();
        }

        async function saveVatEdit() {
            const originalCompany = document.getElementById('editVatOriginalCompany').value;
            const newCompany = document.getElementById('editVatCompanyName').value.trim();
            const brands = document.getElementById('editVatBrands').value.trim();
            const vat = document.getElementById('editVatNumber').value.trim();

            if (!newCompany || !vat) {
                await JarvisDialog.alert('Company name and VAT number are required', { type: 'warning' });
                return;
            }

            try {
                const res = await fetch(`/api/companies-vat/${encodeURIComponent(originalCompany)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company: newCompany, brands, vat })
                });

                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editVatModal')).hide();
                    await loadCompaniesWithVat();
                    showToast('Company updated successfully', 'success');
                } else {
                    await JarvisDialog.alert('Error updating company: ' + result.error, { type: 'error' });
                }
            } catch (error) {
                console.error('Error updating company:', error);
                await JarvisDialog.alert('Failed to update company', { type: 'error' });
            }
        }

        // ========== ACTIVITY LOGS ==========

        let activityLogs = [];
        let activityLogsPage = 1;
        let activityLogsPageSize = 50;
        let activityLogsTotalCount = 0;
        let eventTypes = [];

        async function loadActivityLogs() {
            const userId = document.getElementById('logFilterUser').value;
            const eventType = document.getElementById('logFilterEventType').value;
            const startDate = document.getElementById('logFilterStartDate').value;
            const endDate = document.getElementById('logFilterEndDate').value;

            const params = new URLSearchParams();
            params.append('limit', activityLogsPageSize);
            params.append('offset', (activityLogsPage - 1) * activityLogsPageSize);
            if (userId) params.append('user_id', userId);
            if (eventType) params.append('event_type', eventType);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            try {
                const res = await fetch(`/api/events?${params.toString()}`);
                if (!res.ok) {
                    if (res.status === 403) {
                        showToast('Permission denied. Admin access required.', 'danger');
                        return;
                    }
                    throw new Error('Failed to load activity logs');
                }
                const data = await res.json();
                // API returns array directly, not wrapped in {events: [...]}
                activityLogs = Array.isArray(data) ? data : (data.events || []);
                activityLogsTotalCount = activityLogs.length;
                renderActivityLogs();
            } catch (error) {
                console.error('Error loading activity logs:', error);
                showToast('Failed to load activity logs', 'danger');
            }
        }

        async function loadEventTypes() {
            try {
                const res = await fetch('/api/events/types');
                if (res.ok) {
                    eventTypes = await res.json();
                    populateEventTypeFilter();
                }
            } catch (error) {
                console.error('Error loading event types:', error);
            }
        }

        function populateEventTypeFilter() {
            const select = document.getElementById('logFilterEventType');
            select.innerHTML = '<option value="">All Event Types</option>' +
                eventTypes.map(type => `<option value="${escapeHtml(type)}">${formatEventType(escapeHtml(type))}</option>`).join('');
        }

        function populateUserFilterForLogs() {
            const select = document.getElementById('logFilterUser');
            select.innerHTML = '<option value="">All Users</option>' +
                users.map(u => `<option value="${u.id}">${escapeHtml(u.name)} (${escapeHtml(u.email)})</option>`).join('');
        }

        function formatEventType(type) {
            // Convert snake_case to Title Case
            return type.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('ro-RO', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getEventTypeBadgeClass(type) {
            const typeMap = {
                'login': 'bg-success',
                'logout': 'bg-secondary',
                'login_failed': 'bg-danger',
                'password_changed': 'bg-warning text-dark',
                'admin_password_reset': 'bg-warning text-dark',
                'bulk_password_set': 'bg-warning text-dark',
                'invoice_created': 'bg-primary',
                'invoice_updated': 'bg-info',
                'invoice_deleted': 'bg-danger',
                'invoice_restored': 'bg-success',
                'invoice_permanently_deleted': 'bg-dark',
                'allocations_updated': 'bg-info'
            };
            return typeMap[type] || 'bg-secondary';
        }

        function renderActivityLogs() {
            const tbody = document.getElementById('activityLogsTableBody');
            const noLogsMsg = document.getElementById('noActivityLogsMessage');
            const table = document.getElementById('activityLogsTable');

            if (activityLogs.length === 0) {
                tbody.innerHTML = '';
                noLogsMsg.style.display = 'block';
                table.style.display = 'none';
                document.getElementById('activityLogsPaginationInfo').textContent = 'Showing 0 events';
                document.getElementById('activityLogsPagination').innerHTML = '';
                return;
            }

            noLogsMsg.style.display = 'none';
            table.style.display = 'table';

            tbody.innerHTML = activityLogs.map(log => `
                <tr>
                    <td class="small">${formatTimestamp(log.created_at)}</td>
                    <td>
                        <strong>${escapeHtml(log.user_email || 'Unknown')}</strong>
                    </td>
                    <td>
                        <span class="badge ${getEventTypeBadgeClass(log.event_type)}">${formatEventType(log.event_type)}</span>
                    </td>
                    <td class="small">${escapeHtml(log.event_description || '-')}</td>
                    <td class="small text-muted">${escapeHtml(log.ip_address || '-')}</td>
                </tr>
            `).join('');

            // Update pagination info
            const start = (activityLogsPage - 1) * activityLogsPageSize + 1;
            const end = Math.min(activityLogsPage * activityLogsPageSize, activityLogsTotalCount);
            document.getElementById('activityLogsPaginationInfo').textContent =
                `Showing ${start}-${end} of ${activityLogsTotalCount} events`;

            // Render pagination
            renderActivityLogsPagination();
        }

        function renderActivityLogsPagination() {
            const totalPages = Math.ceil(activityLogsTotalCount / activityLogsPageSize);
            const pagination = document.getElementById('activityLogsPagination');

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `<li class="page-item ${activityLogsPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToActivityLogsPage(${activityLogsPage - 1}); return false;">&laquo;</a>
            </li>`;

            // Page numbers (show max 5 pages around current)
            const startPage = Math.max(1, activityLogsPage - 2);
            const endPage = Math.min(totalPages, activityLogsPage + 2);

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToActivityLogsPage(1); return false;">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === activityLogsPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="goToActivityLogsPage(${i}); return false;">${i}</a>
                </li>`;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><a class="page-link">...</a></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="goToActivityLogsPage(${totalPages}); return false;">${totalPages}</a></li>`;
            }

            // Next button
            html += `<li class="page-item ${activityLogsPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="goToActivityLogsPage(${activityLogsPage + 1}); return false;">&raquo;</a>
            </li>`;

            pagination.innerHTML = html;
        }

        function goToActivityLogsPage(page) {
            const totalPages = Math.ceil(activityLogsTotalCount / activityLogsPageSize);
            if (page < 1 || page > totalPages) return;
            activityLogsPage = page;
            loadActivityLogs();
        }

        function clearActivityLogFilters() {
            document.getElementById('logFilterUser').value = '';
            document.getElementById('logFilterEventType').value = '';
            document.getElementById('logFilterStartDate').value = '';
            document.getElementById('logFilterEndDate').value = '';
            activityLogsPage = 1;
            loadActivityLogs();
        }

        // Load activity logs when tab is shown
        document.getElementById('activity-logs-tab').addEventListener('shown.bs.tab', function() {
            populateUserFilterForLogs();
            loadEventTypes();
            loadActivityLogs();
        });

        // ========== VAT RATES ==========

        async function loadVatRates() {
            try {
                const res = await fetch('/api/vat-rates');
                vatRates = await res.json();
                renderVatRates();
            } catch (error) {
                console.error('Error loading VAT rates:', error);
            }
        }

        function renderVatRates() {
            const tbody = document.getElementById('vatRatesTableBody');
            const noVatRatesMsg = document.getElementById('noVatRatesMessage');

            if (vatRates.length === 0) {
                tbody.innerHTML = '';
                noVatRatesMsg.style.display = 'block';
                return;
            }

            noVatRatesMsg.style.display = 'none';
            tbody.innerHTML = vatRates.map(rate => `
                <tr>
                    <td>${escapeHtml(rate.name)}</td>
                    <td>${rate.rate}%</td>
                    <td>
                        ${rate.is_default
                            ? '<span class="badge bg-primary"><i class="bi bi-check-circle"></i> Default</span>'
                            : '<span class="text-muted">-</span>'}
                    </td>
                    <td>
                        ${rate.is_active
                            ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>'
                            : '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Inactive</span>'}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editVatRate(${rate.id})" title="Edit" aria-label="Edit VAT rate">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVatRateConfirm(${rate.id}, '${escapeHtml(rate.name)}')" title="Delete" aria-label="Delete VAT rate">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addNewVatRate() {
            const name = document.getElementById('newVatRateName').value.trim();
            const rate = document.getElementById('newVatRateValue').value;
            const isDefault = document.getElementById('newVatRateDefault').checked;
            const isActive = document.getElementById('newVatRateActive').checked;

            if (!name || !rate) {
                showToast('Please fill in Name and Rate', 'warning');
                return;
            }

            try {
                const res = await fetch('/api/vat-rates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        rate: parseFloat(rate),
                        is_default: isDefault,
                        is_active: isActive
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate added successfully', 'success');
                    // Clear form
                    document.getElementById('newVatRateName').value = '';
                    document.getElementById('newVatRateValue').value = '';
                    document.getElementById('newVatRateDefault').checked = false;
                    document.getElementById('newVatRateActive').checked = true;
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to add VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error adding VAT rate:', error);
                showToast('Failed to add VAT rate', 'danger');
            }
        }

        function editVatRate(rateId) {
            const rate = vatRates.find(r => r.id === rateId);
            if (!rate) return;

            document.getElementById('editVatRateId').value = rate.id;
            document.getElementById('editVatRateName').value = rate.name;
            document.getElementById('editVatRateValue').value = rate.rate;
            document.getElementById('editVatRateDefault').checked = rate.is_default;
            document.getElementById('editVatRateActive').checked = rate.is_active;

            editVatRateModal.show();
        }

        async function saveEditedVatRate() {
            const rateId = document.getElementById('editVatRateId').value;
            const name = document.getElementById('editVatRateName').value.trim();
            const rate = document.getElementById('editVatRateValue').value;
            const isDefault = document.getElementById('editVatRateDefault').checked;
            const isActive = document.getElementById('editVatRateActive').checked;

            if (!name || !rate) {
                showToast('Please fill in Name and Rate', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/vat-rates/${rateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        rate: parseFloat(rate),
                        is_default: isDefault,
                        is_active: isActive
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate updated successfully', 'success');
                    editVatRateModal.hide();
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to update VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error updating VAT rate:', error);
                showToast('Failed to update VAT rate', 'danger');
            }
        }

        function deleteVatRateConfirm(rateId, rateName) {
            deleteType = 'vat_rate';
            deleteId = rateId;
            document.getElementById('deleteItemName').textContent = `VAT Rate: ${rateName}`;
            deleteModal.show();
        }

        async function deleteVatRateById(rateId) {
            try {
                const res = await fetch(`/api/vat-rates/${rateId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.success) {
                    showToast('VAT rate deleted successfully', 'success');
                    loadVatRates();
                } else {
                    showToast(data.error || 'Failed to delete VAT rate', 'danger');
                }
            } catch (error) {
                console.error('Error deleting VAT rate:', error);
                showToast('Failed to delete VAT rate', 'danger');
            }
        }

        // ========== DROPDOWN OPTIONS ==========

        async function loadDropdownOptions() {
            try {
                const res = await fetch('/api/dropdown-options');
                const options = await res.json();

                // Group options by type
                const invoiceStatus = options.filter(o => o.dropdown_type === 'invoice_status');
                const paymentStatus = options.filter(o => o.dropdown_type === 'payment_status');

                // Render invoice status table
                const invoiceStatusTbody = document.querySelector('#invoiceStatusTable tbody');
                invoiceStatusTbody.innerHTML = invoiceStatus.map(opt => `
                    <tr>
                        <td><code>${escapeHtml(opt.value)}</code></td>
                        <td>
                            <input type="text" class="form-control form-control-sm" value="${escapeHtml(opt.label)}"
                                   onchange="updateDropdownOption(${opt.id}, 'label', this.value)">
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="color" class="form-control form-control-color" value="${opt.color || '#0d6efd'}"
                                       onchange="updateDropdownOption(${opt.id}, 'color', this.value); this.nextElementSibling.value = this.value;">
                                <input type="text" class="form-control" style="width: 80px" value="${opt.color || '#0d6efd'}"
                                       onchange="updateDropdownOption(${opt.id}, 'color', this.value); this.previousElementSibling.value = this.value;">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-1">
                                <input type="range" class="form-range" style="width: 60px" min="0" max="1" step="0.1" value="${opt.opacity ?? 0.7}"
                                       oninput="this.nextElementSibling.textContent = Math.round(this.value * 100) + '%'"
                                       onchange="updateDropdownOption(${opt.id}, 'opacity', parseFloat(this.value))">
                                <span class="small text-muted" style="width: 35px">${Math.round((opt.opacity ?? 0.7) * 100)}%</span>
                            </div>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm" style="width: 70px" value="${opt.sort_order}"
                                   onchange="updateDropdownOption(${opt.id}, 'sort_order', parseInt(this.value))">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" style="width: 100px"
                                    onchange="updateDropdownOption(${opt.id}, 'min_role', this.value)">
                                <option value="Viewer" ${opt.min_role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="User" ${opt.min_role === 'User' ? 'selected' : ''}>User</option>
                                <option value="Manager" ${opt.min_role === 'Manager' ? 'selected' : ''}>Manager</option>
                                <option value="Admin" ${opt.min_role === 'Admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${opt.is_active ? 'checked' : ''}
                                       onchange="updateDropdownOption(${opt.id}, 'is_active', this.checked)">
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteDropdownOption(${opt.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Render payment status table
                const paymentStatusTbody = document.querySelector('#paymentStatusTable tbody');
                paymentStatusTbody.innerHTML = paymentStatus.map(opt => `
                    <tr>
                        <td><code>${escapeHtml(opt.value)}</code></td>
                        <td>
                            <input type="text" class="form-control form-control-sm" value="${escapeHtml(opt.label)}"
                                   onchange="updateDropdownOption(${opt.id}, 'label', this.value)">
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <input type="color" class="form-control form-control-color" value="${opt.color || '#0d6efd'}"
                                       onchange="updateDropdownOption(${opt.id}, 'color', this.value); this.nextElementSibling.value = this.value;">
                                <input type="text" class="form-control" style="width: 80px" value="${opt.color || '#0d6efd'}"
                                       onchange="updateDropdownOption(${opt.id}, 'color', this.value); this.previousElementSibling.value = this.value;">
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center gap-1">
                                <input type="range" class="form-range" style="width: 60px" min="0" max="1" step="0.1" value="${opt.opacity ?? 0.7}"
                                       oninput="this.nextElementSibling.textContent = Math.round(this.value * 100) + '%'"
                                       onchange="updateDropdownOption(${opt.id}, 'opacity', parseFloat(this.value))">
                                <span class="small text-muted" style="width: 35px">${Math.round((opt.opacity ?? 0.7) * 100)}%</span>
                            </div>
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm" style="width: 70px" value="${opt.sort_order}"
                                   onchange="updateDropdownOption(${opt.id}, 'sort_order', parseInt(this.value))">
                        </td>
                        <td>
                            <select class="form-select form-select-sm" style="width: 100px"
                                    onchange="updateDropdownOption(${opt.id}, 'min_role', this.value)">
                                <option value="Viewer" ${opt.min_role === 'Viewer' ? 'selected' : ''}>Viewer</option>
                                <option value="User" ${opt.min_role === 'User' ? 'selected' : ''}>User</option>
                                <option value="Manager" ${opt.min_role === 'Manager' ? 'selected' : ''}>Manager</option>
                                <option value="Admin" ${opt.min_role === 'Admin' ? 'selected' : ''}>Admin</option>
                            </select>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${opt.is_active ? 'checked' : ''}
                                       onchange="updateDropdownOption(${opt.id}, 'is_active', this.checked)">
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteDropdownOption(${opt.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading dropdown options:', error);
                showToast('Failed to load dropdown options', 'danger');
            }
        }

        // Sync color picker with text input
        function syncColorInputs(prefix) {
            const colorPicker = document.getElementById(`new${prefix}Color`);
            const colorText = document.getElementById(`new${prefix}ColorText`);
            if (colorPicker && colorText) {
                colorPicker.addEventListener('input', () => colorText.value = colorPicker.value);
                colorText.addEventListener('input', () => colorPicker.value = colorText.value);
            }
        }

        // Sync opacity slider with value display
        function syncOpacityInputs(prefix) {
            const opacitySlider = document.getElementById(`new${prefix}Opacity`);
            const opacityValue = document.getElementById(`new${prefix}OpacityValue`);
            if (opacitySlider && opacityValue) {
                opacitySlider.addEventListener('input', () => {
                    opacityValue.textContent = Math.round(opacitySlider.value * 100) + '%';
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            syncColorInputs('InvoiceStatus');
            syncColorInputs('PaymentStatus');
            syncOpacityInputs('InvoiceStatus');
            syncOpacityInputs('PaymentStatus');
        });

        async function addDropdownOption(dropdownType) {
            const prefix = dropdownType === 'invoice_status' ? 'InvoiceStatus' : 'PaymentStatus';
            const valueInput = document.getElementById(`new${prefix}Value`);
            const labelInput = document.getElementById(`new${prefix}Label`);
            const colorInput = document.getElementById(`new${prefix}Color`);
            const opacityInput = document.getElementById(`new${prefix}Opacity`);
            const orderInput = document.getElementById(`new${prefix}Order`);
            const minRoleInput = document.getElementById(`new${prefix}MinRole`);

            const value = valueInput.value.trim();
            const label = labelInput.value.trim();
            const color = colorInput.value || '#0d6efd';
            const opacity = parseFloat(opacityInput.value) || 0.7;
            const sortOrder = parseInt(orderInput.value) || 0;
            const minRole = minRoleInput ? minRoleInput.value : 'Viewer';

            if (!value || !label) {
                showToast('Please fill in both Value and Label', 'warning');
                return;
            }

            try {
                const res = await fetch('/api/dropdown-options', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dropdown_type: dropdownType,
                        value: value,
                        label: label,
                        color: color,
                        opacity: opacity,
                        sort_order: sortOrder,
                        is_active: true,
                        min_role: minRole
                    })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('Option added successfully', 'success');
                    valueInput.value = '';
                    labelInput.value = '';
                    colorInput.value = '#0d6efd';
                    document.getElementById(`new${prefix}ColorText`).value = '#0d6efd';
                    opacityInput.value = '0.7';
                    document.getElementById(`new${prefix}OpacityValue`).textContent = '70%';
                    orderInput.value = '0';
                    loadDropdownOptions();
                } else {
                    showToast(data.error || 'Failed to add option', 'danger');
                }
            } catch (error) {
                console.error('Error adding dropdown option:', error);
                showToast('Failed to add option', 'danger');
            }
        }

        async function updateDropdownOption(optionId, field, value) {
            try {
                const res = await fetch(`/api/dropdown-options/${optionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value })
                });

                const data = await res.json();
                if (data.success) {
                    showToast('Option updated', 'success');
                    if (field === 'sort_order') {
                        loadDropdownOptions(); // Reload to reflect new order
                    }
                } else {
                    showToast(data.error || 'Failed to update option', 'danger');
                    loadDropdownOptions(); // Reload to revert
                }
            } catch (error) {
                console.error('Error updating dropdown option:', error);
                showToast('Failed to update option', 'danger');
                loadDropdownOptions();
            }
        }

        async function deleteDropdownOption(optionId) {
            const confirmed = await JarvisDialog.confirm('Are you sure you want to delete this option?', { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/api/dropdown-options/${optionId}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.success) {
                    showToast('Option deleted', 'success');
                    loadDropdownOptions();
                } else {
                    showToast(data.error || 'Failed to delete option', 'danger');
                }
            } catch (error) {
                console.error('Error deleting dropdown option:', error);
                showToast('Failed to delete option', 'danger');
            }
        }

        // ========== UTILS ==========

        function showToast(message, type = 'info') {
            // Simple toast notification using Bootstrap alert
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============== Theme Settings Functions ==============

        async function loadThemeSettings() {
            try {
                const res = await fetch('/api/themes/active');
                const data = await res.json();
                if (data.theme) {
                    currentTheme = data.theme;
                    currentThemeId = data.theme.id;
                    populateThemeForm(data.theme);
                } else {
                    // Use defaults
                    currentTheme = { theme_name: 'Jarvis Default', settings: defaultTheme, is_active: true };
                    populateThemeForm(currentTheme);
                }
            } catch (err) {
                console.error('Error loading theme settings:', err);
                populateThemeForm({ theme_name: 'Jarvis Default', settings: defaultTheme, is_active: true });
            }
        }

        function populateThemeForm(theme) {
            document.getElementById('themeName').value = theme.theme_name || '';
            document.getElementById('themeIsActive').checked = theme.is_active !== false;

            const settings = theme.settings || defaultTheme;

            // Populate light theme colors
            themeColorFields.forEach(field => {
                const value = settings.light?.[field] || defaultTheme.light[field];
                const colorPicker = document.getElementById(`light-${field}`);
                const textInput = document.getElementById(`light-${field}-text`);
                if (colorPicker) colorPicker.value = value;
                if (textInput) textInput.value = value;
            });

            // Populate dark theme colors
            themeColorFields.forEach(field => {
                const value = settings.dark?.[field] || defaultTheme.dark[field];
                const colorPicker = document.getElementById(`dark-${field}`);
                const textInput = document.getElementById(`dark-${field}-text`);
                if (colorPicker) colorPicker.value = value;
                if (textInput) textInput.value = value;
            });

            // Populate logo settings
            populateLogoForm(settings.logo);

            updateThemePreview();
        }

        function initThemeColorPickers() {
            // Sync color picker and text input for all theme fields
            ['light', 'dark'].forEach(mode => {
                themeColorFields.forEach(field => {
                    const colorPicker = document.getElementById(`${mode}-${field}`);
                    const textInput = document.getElementById(`${mode}-${field}-text`);

                    if (colorPicker && textInput) {
                        // Color picker changes text input
                        colorPicker.addEventListener('input', () => {
                            textInput.value = colorPicker.value;
                            updateThemePreview();
                        });

                        // Text input changes color picker
                        textInput.addEventListener('input', () => {
                            // Validate hex color
                            const hex = textInput.value;
                            if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
                                colorPicker.value = hex;
                                updateThemePreview();
                            }
                        });
                    }
                });
            });
        }

        function getThemeSettingsFromForm() {
            const settings = { light: {}, dark: {} };

            ['light', 'dark'].forEach(mode => {
                themeColorFields.forEach(field => {
                    const textInput = document.getElementById(`${mode}-${field}-text`);
                    if (textInput) {
                        settings[mode][field] = textInput.value;
                    }
                });
            });

            return settings;
        }

        // Logo preview function
        function updateLogoPreview() {
            const logoType = document.getElementById('logoType').value;
            const logoSvgUrl = document.getElementById('logoSvgUrl').value || '/static/img/jarvis-icon.svg';
            const logoIcon = document.getElementById('logoIcon').value || 'bi-cpu';
            const logoText = document.getElementById('logoText').value || 'J.A.R.V.I.S.';
            const logoImageUrl = document.getElementById('logoImageUrl').value;
            const previewArea = document.getElementById('logoPreviewArea');
            const logoSvgGroup = document.getElementById('logoSvgGroup');
            const logoIconGroup = document.getElementById('logoIconGroup');
            const logoImageGroup = document.getElementById('logoImageGroup');
            const logoIconPreview = document.getElementById('logoIconPreview');

            // Show/hide relevant fields
            if (logoType === 'svg') {
                logoSvgGroup.style.display = '';
                logoIconGroup.style.display = 'none';
                logoImageGroup.style.display = 'none';
            } else if (logoType === 'icon') {
                logoSvgGroup.style.display = 'none';
                logoIconGroup.style.display = '';
                logoImageGroup.style.display = 'none';
            } else if (logoType === 'text') {
                logoSvgGroup.style.display = 'none';
                logoIconGroup.style.display = 'none';
                logoImageGroup.style.display = 'none';
            } else if (logoType === 'image') {
                logoSvgGroup.style.display = 'none';
                logoIconGroup.style.display = 'none';
                logoImageGroup.style.display = '';
            }

            // Update icon preview
            logoIconPreview.className = 'bi ' + logoIcon;

            // Update main preview
            let html = '';
            if (logoType === 'svg') {
                html = `<span class="navbar-logo-icon" style="background-image: url('${logoSvgUrl}');"></span> ${logoText}`;
            } else if (logoType === 'icon') {
                html = `<i class="bi ${logoIcon}"></i> ${logoText}`;
            } else if (logoType === 'text') {
                html = logoText;
            } else if (logoType === 'image') {
                html = logoImageUrl ? `<img src="${logoImageUrl}" alt="Logo" style="max-height: 32px; vertical-align: middle;"> ${logoText}` : logoText;
            }
            previewArea.innerHTML = html;
        }

        // Get logo settings from form
        function getLogoSettingsFromForm() {
            return {
                type: document.getElementById('logoType').value,
                svgUrl: document.getElementById('logoSvgUrl').value || '/static/img/jarvis-icon.svg',
                icon: document.getElementById('logoIcon').value || 'bi-cpu',
                text: document.getElementById('logoText').value || 'J.A.R.V.I.S.',
                imageUrl: document.getElementById('logoImageUrl').value || ''
            };
        }

        // Populate logo form from settings
        function populateLogoForm(logo) {
            const defaults = defaultTheme.logo;
            const settings = logo || defaults;
            document.getElementById('logoType').value = settings.type || defaults.type;
            document.getElementById('logoSvgUrl').value = settings.svgUrl || defaults.svgUrl;
            document.getElementById('logoIcon').value = settings.icon || defaults.icon;
            document.getElementById('logoText').value = settings.text || defaults.text;
            document.getElementById('logoImageUrl').value = settings.imageUrl || defaults.imageUrl;
            updateLogoPreview();
        }

        function updateThemePreview() {
            const settings = getThemeSettingsFromForm();

            // Update light preview
            const previewLight = document.getElementById('previewLight');
            if (previewLight) {
                previewLight.style.background = settings.light.bgBody;
                previewLight.querySelector('h6').style.color = settings.light.textPrimary;
                const lightCard = previewLight.querySelector('div.p-2');
                if (lightCard) {
                    lightCard.style.background = settings.light.bgCard;
                    lightCard.style.borderColor = settings.light.borderColor;
                    lightCard.querySelector('span:first-child').style.color = settings.light.textPrimary;
                    lightCard.querySelector('span:last-child').style.color = settings.light.textSecondary;
                }
                const lightBadges = previewLight.querySelectorAll('.badge');
                if (lightBadges.length >= 4) {
                    lightBadges[0].style.background = settings.light.accentPrimary;
                    lightBadges[1].style.background = settings.light.accentSuccess;
                    lightBadges[2].style.background = settings.light.accentWarning;
                    lightBadges[3].style.background = settings.light.accentDanger;
                }
            }

            // Update dark preview
            const previewDark = document.getElementById('previewDark');
            if (previewDark) {
                previewDark.style.background = settings.dark.bgBody;
                previewDark.querySelector('h6').style.color = settings.dark.textPrimary;
                const darkCard = previewDark.querySelector('div.p-2');
                if (darkCard) {
                    darkCard.style.background = settings.dark.bgCard;
                    darkCard.style.borderColor = settings.dark.borderColor;
                    darkCard.querySelector('span:first-child').style.color = settings.dark.textPrimary;
                    darkCard.querySelector('span:last-child').style.color = settings.dark.textSecondary;
                }
                const darkBadges = previewDark.querySelectorAll('.badge');
                if (darkBadges.length >= 4) {
                    darkBadges[0].style.background = settings.dark.accentPrimary;
                    darkBadges[1].style.background = settings.dark.accentSuccess;
                    darkBadges[2].style.background = settings.dark.accentWarning;
                    darkBadges[3].style.background = settings.dark.accentDanger;
                }
            }
        }

        async function saveThemeSettings() {
            const themeName = document.getElementById('themeName').value.trim();
            const isActive = document.getElementById('themeIsActive').checked;
            const settings = getThemeSettingsFromForm();
            const logoSettings = getLogoSettingsFromForm();
            settings.logo = logoSettings;

            if (!themeName) {
                await JarvisDialog.alert('Please enter a theme name', { type: 'warning' });
                return;
            }

            showLoading('Saving theme...');
            try {
                const method = currentThemeId ? 'PUT' : 'POST';
                const url = currentThemeId ? `/api/themes/${currentThemeId}` : '/api/themes';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        theme_name: themeName,
                        settings: settings,
                        is_active: isActive
                    })
                });

                const data = await res.json();
                if (data.success) {
                    currentTheme = data.theme;
                    currentThemeId = data.theme.id;
                    await JarvisDialog.alert('Theme saved successfully! Refresh the page to see changes applied.', { type: 'success' });
                } else {
                    await JarvisDialog.alert('Error saving theme: ' + (data.error || 'Unknown error'), { type: 'error' });
                }
            } catch (err) {
                console.error('Error saving theme:', err);
                await JarvisDialog.alert('Error saving theme: ' + err.message, { type: 'error' });
            } finally {
                hideLoading();
            }
        }

        async function resetThemeToDefault() {
            const confirmed = await JarvisDialog.confirm('Reset theme to default Jarvis colors? This will not save automatically.');
            if (confirmed) {
                document.getElementById('themeName').value = 'Jarvis Default';
                populateThemeForm({ theme_name: 'Jarvis Default', settings: defaultTheme, is_active: true });
            }
        }

        // ============== Module Menu Functions ==============

        let moduleMenuItems = [];
        const moduleMenuModal = new bootstrap.Modal(document.getElementById('moduleMenuModal'));

        async function loadModuleMenu() {
            try {
                const res = await fetch('/api/module-menu/all');
                const data = await res.json();
                moduleMenuItems = data.items || [];
                renderModuleMenuList();
                populateParentDropdown();
            } catch (err) {
                console.error('Error loading module menu:', err);
                document.getElementById('moduleMenuList').innerHTML = '<div class="alert alert-danger">Failed to load modules</div>';
            }
        }

        function renderModuleMenuList() {
            const container = document.getElementById('moduleMenuList');
            if (!moduleMenuItems.length) {
                container.innerHTML = '<div class="alert alert-info">No modules configured yet. Click "Add Module" to create one.</div>';
                return;
            }

            // Group items by parent
            const parentItems = moduleMenuItems.filter(i => !i.parent_id);
            const childItems = moduleMenuItems.filter(i => i.parent_id);

            let html = '<div class="list-group">';
            parentItems.sort((a, b) => a.sort_order - b.sort_order).forEach(parent => {
                const children = childItems.filter(c => c.parent_id === parent.id).sort((a, b) => a.sort_order - b.sort_order);
                const statusBadge = getStatusBadge(parent.status);

                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="module-icon-preview me-2" style="color: ${parent.color};">
                                    <i class="bi ${parent.icon}"></i>
                                </span>
                                <div>
                                    <strong>${parent.name}</strong>
                                    <small class="text-muted ms-2">${parent.module_key}</small>
                                    ${statusBadge}
                                    <br><small class="text-muted">${parent.description || ''}</small>
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editModuleMenuItem(${parent.id})" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="showAddSubpageModal(${parent.id})" title="Add Sub-page">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteModuleMenuItem(${parent.id})" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        ${children.length ? `
                            <div class="ms-4 mt-2 border-start ps-3">
                                ${children.map(child => `
                                    <div class="d-flex justify-content-between align-items-center py-1">
                                        <div class="d-flex align-items-center">
                                            <i class="bi ${child.icon} me-2" style="color: ${child.color};"></i>
                                            <span>${child.name}</span>
                                            <small class="text-muted ms-2">${child.url || ''}</small>
                                            ${getStatusBadge(child.status)}
                                        </div>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="editModuleMenuItem(${child.id})" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteModuleMenuItem(${child.id})" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'active': return '<span class="badge bg-success ms-2">Active</span>';
                case 'coming_soon': return '<span class="badge bg-warning ms-2">Coming Soon</span>';
                case 'hidden': return '<span class="badge bg-secondary ms-2">Hidden</span>';
                default: return '';
            }
        }

        function populateParentDropdown() {
            const select = document.getElementById('moduleParentId');
            select.innerHTML = '<option value="">-- Top Level Module --</option>';
            moduleMenuItems.filter(i => !i.parent_id).forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name}</option>`;
            });
        }

        function showAddModuleModal() {
            document.getElementById('moduleMenuModalTitle').textContent = 'Add Module';
            document.getElementById('moduleMenuItemId').value = '';
            document.getElementById('moduleParentId').value = '';
            document.getElementById('moduleKey').value = '';
            document.getElementById('moduleName').value = '';
            document.getElementById('moduleDescription').value = '';
            document.getElementById('moduleIcon').value = 'bi-grid';
            document.getElementById('moduleIconPreview').className = 'bi bi-grid';
            document.getElementById('moduleColor').value = '#6c757d';
            document.getElementById('moduleColorPicker').value = '#6c757d';
            document.getElementById('moduleUrl').value = '';
            document.getElementById('moduleSortOrder').value = '0';
            document.getElementById('moduleStatus').value = 'active';
            moduleMenuModal.show();
        }

        function showAddSubpageModal(parentId) {
            showAddModuleModal();
            document.getElementById('moduleMenuModalTitle').textContent = 'Add Sub-page';
            document.getElementById('moduleParentId').value = parentId;
            // Copy parent's color
            const parent = moduleMenuItems.find(i => i.id === parentId);
            if (parent) {
                document.getElementById('moduleColor').value = parent.color;
                document.getElementById('moduleColorPicker').value = parent.color;
            }
        }

        function editModuleMenuItem(itemId) {
            const item = moduleMenuItems.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('moduleMenuModalTitle').textContent = 'Edit Module';
            document.getElementById('moduleMenuItemId').value = item.id;
            document.getElementById('moduleParentId').value = item.parent_id || '';
            document.getElementById('moduleKey').value = item.module_key;
            document.getElementById('moduleName').value = item.name;
            document.getElementById('moduleDescription').value = item.description || '';
            document.getElementById('moduleIcon').value = item.icon || 'bi-grid';
            document.getElementById('moduleIconPreview').className = 'bi ' + (item.icon || 'bi-grid');
            document.getElementById('moduleColor').value = item.color || '#6c757d';
            document.getElementById('moduleColorPicker').value = item.color || '#6c757d';
            document.getElementById('moduleUrl').value = item.url || '';
            document.getElementById('moduleSortOrder').value = item.sort_order || 0;
            document.getElementById('moduleStatus').value = item.status || 'active';
            moduleMenuModal.show();
        }

        async function saveModuleMenuItem() {
            const itemId = document.getElementById('moduleMenuItemId').value;
            const data = {
                parent_id: document.getElementById('moduleParentId').value || null,
                module_key: document.getElementById('moduleKey').value.trim(),
                name: document.getElementById('moduleName').value.trim(),
                description: document.getElementById('moduleDescription').value.trim(),
                icon: document.getElementById('moduleIcon').value.trim(),
                color: document.getElementById('moduleColor').value,
                url: document.getElementById('moduleUrl').value.trim(),
                sort_order: parseInt(document.getElementById('moduleSortOrder').value) || 0,
                status: document.getElementById('moduleStatus').value
            };

            if (!data.module_key || !data.name) {
                await JarvisDialog.alert('Module Key and Name are required', { type: 'warning' });
                return;
            }

            try {
                const url = itemId ? `/api/module-menu/${itemId}` : '/api/module-menu';
                const method = itemId ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    moduleMenuModal.hide();
                    loadModuleMenu();
                } else {
                    const err = await res.json();
                    await JarvisDialog.alert(err.error || 'Failed to save module', { type: 'error' });
                }
            } catch (err) {
                console.error('Error saving module:', err);
                await JarvisDialog.alert('Failed to save module', { type: 'error' });
            }
        }

        async function deleteModuleMenuItem(itemId) {
            const item = moduleMenuItems.find(i => i.id === itemId);
            const hasChildren = moduleMenuItems.some(i => i.parent_id === itemId);

            let msg = `Delete "${item?.name}"?`;
            if (hasChildren) {
                msg += '\n\nWarning: This will also delete all sub-pages!';
            }

            const confirmed = await JarvisDialog.confirm(msg, { danger: true });
            if (!confirmed) return;

            try {
                const res = await fetch(`/api/module-menu/${itemId}`, { method: 'DELETE' });
                if (res.ok) {
                    loadModuleMenu();
                } else {
                    await JarvisDialog.alert('Failed to delete module', { type: 'error' });
                }
            } catch (err) {
                console.error('Error deleting module:', err);
                await JarvisDialog.alert('Failed to delete module', { type: 'error' });
            }
        }

        // Sync icon preview
        document.getElementById('moduleIcon').addEventListener('input', (e) => {
            document.getElementById('moduleIconPreview').className = 'bi ' + e.target.value;
        });

        // Sync color inputs
        document.getElementById('moduleColorPicker').addEventListener('input', (e) => {
            document.getElementById('moduleColor').value = e.target.value;
        });
        document.getElementById('moduleColor').addEventListener('input', (e) => {
            document.getElementById('moduleColorPicker').value = e.target.value;
        });

        // Load module menu when Theme tab is shown
        document.querySelector('button[data-bs-target="#theme-settings"]')?.addEventListener('shown.bs.tab', loadModuleMenu);
        // Also load on page load if already on theme tab
        if (document.getElementById('theme-settings')?.classList.contains('show')) {
            loadModuleMenu();
        }

        // ============== Permission Matrix Functions ==============

        async function loadPermissionMatrix() {
            try {
                const res = await fetch('/api/permissions/matrix');
                const data = await res.json();
                permissionMatrix = data;
                pendingPermissionChanges = {};
                renderModuleSidebar();
                // Select first module by default
                if (permissionMatrix.modules.length > 0) {
                    selectModule(permissionMatrix.modules[0].key);
                }
            } catch (err) {
                console.error('Error loading permission matrix:', err);
            }
        }

        function renderModuleSidebar() {
            const sidebar = document.getElementById('moduleSidebar');
            if (!sidebar) return;

            sidebar.innerHTML = permissionMatrix.modules.map(mod => `
                <div class="module-item ${selectedModule === mod.key ? 'active' : ''}"
                     onclick="selectModule('${mod.key}')"
                     data-module="${mod.key}">
                    <i class="bi ${mod.icon || 'bi-folder'}"></i>
                    ${mod.label}
                </div>
            `).join('');
        }

        function selectModule(moduleKey) {
            selectedModule = moduleKey;
            renderModuleSidebar();
            renderPermissionMatrix();
        }

        function filterModules() {
            const search = document.getElementById('moduleSearch')?.value.toLowerCase() || '';
            document.querySelectorAll('.module-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function renderPermissionMatrix() {
            const headerRow = document.getElementById('matrixHeaderRow');
            const tbody = document.getElementById('matrixBody');
            if (!headerRow || !tbody) return;

            const module = permissionMatrix.modules.find(m => m.key === selectedModule);
            if (!module) return;

            // Build header with roles
            headerRow.innerHTML = `
                <th style="min-width: 200px; position: sticky; left: 0; background: var(--bg-table-header); z-index: 11;">
                    Permission
                </th>
                ${permissionMatrix.roles.map(role => `
                    <th class="role-header text-center">
                        <div class="d-flex flex-column align-items-center">
                            <span>${escapeHtml(role.name)}</span>
                            <small class="text-muted">${escapeHtml(role.description || '')}</small>
                            <div class="mt-1">
                                <button class="btn btn-link btn-sm p-0 me-1" onclick="editRole(${role.id})" title="Edit role name" aria-label="Edit role">
                                    <i class="bi bi-pencil text-primary" style="font-size: 0.75rem;"></i>
                                </button>
                                <button class="btn btn-link btn-sm p-0" onclick="showDeleteModal('role', ${role.id}, '${escapeHtml(role.name)}')" title="Delete role" aria-label="Delete role">
                                    <i class="bi bi-trash text-danger" style="font-size: 0.75rem;"></i>
                                </button>
                            </div>
                        </div>
                    </th>
                `).join('')}
            `;

            // Build body with entities and actions
            let html = '';
            module.entities.forEach(entity => {
                // Entity header row
                html += `
                    <tr class="entity-header">
                        <td colspan="${permissionMatrix.roles.length + 1}">
                            <i class="bi bi-chevron-down me-2"></i>${entity.label}
                        </td>
                    </tr>
                `;

                // Action rows
                entity.actions.forEach(action => {
                    html += `
                        <tr class="action-row" data-perm-id="${action.id}">
                            <td>
                                ${action.label}
                                ${action.description ? `<small class="text-muted d-block">${escapeHtml(action.description)}</small>` : ''}
                            </td>
                            ${permissionMatrix.roles.map(role => {
                                const rolePerms = permissionMatrix.role_permissions[role.id] || {};
                                const perm = rolePerms[action.id] || { scope: 'deny', granted: false };
                                return `<td class="text-center">${renderPermissionControl(role.id, action, perm)}</td>`;
                            }).join('')}
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = html;
        }

        function renderPermissionControl(roleId, action, currentPerm) {
            if (action.is_scope_based) {
                // Scope dropdown
                const scope = currentPerm.scope || 'deny';
                return `
                    <select class="scope-select scope-${scope}"
                            data-role-id="${roleId}"
                            data-perm-id="${action.id}"
                            onchange="updatePermission(this, true)">
                        <option value="deny" ${scope === 'deny' ? 'selected' : ''}>Deny</option>
                        <option value="own" ${scope === 'own' ? 'selected' : ''}>Own</option>
                        <option value="department" ${scope === 'department' ? 'selected' : ''}>Dept</option>
                        <option value="all" ${scope === 'all' ? 'selected' : ''}>All</option>
                    </select>
                `;
            } else {
                // Toggle switch
                const granted = currentPerm.granted || false;
                return `
                    <input type="checkbox" class="perm-toggle"
                           data-role-id="${roleId}"
                           data-perm-id="${action.id}"
                           ${granted ? 'checked' : ''}
                           onchange="updatePermission(this, false)">
                `;
            }
        }

        function updatePermission(element, isScopeBased) {
            const roleId = element.dataset.roleId;
            const permId = element.dataset.permId;

            if (!pendingPermissionChanges[roleId]) {
                pendingPermissionChanges[roleId] = {};
            }

            if (isScopeBased) {
                const scope = element.value;
                pendingPermissionChanges[roleId][permId] = { scope };
                // Update visual class
                element.className = `scope-select scope-${scope}`;
            } else {
                const granted = element.checked;
                pendingPermissionChanges[roleId][permId] = { granted };
            }

            // Update in-memory state for re-renders
            if (!permissionMatrix.role_permissions[roleId]) {
                permissionMatrix.role_permissions[roleId] = {};
            }
            if (isScopeBased) {
                permissionMatrix.role_permissions[roleId][permId] = {
                    scope: element.value,
                    granted: element.value !== 'deny'
                };
            } else {
                permissionMatrix.role_permissions[roleId][permId] = {
                    scope: element.checked ? 'all' : 'deny',
                    granted: element.checked
                };
            }
        }

        async function saveAllPermissions() {
            const roleIds = Object.keys(pendingPermissionChanges);
            if (roleIds.length === 0) {
                await JarvisDialog.alert('No changes to save.', { type: 'warning' });
                return;
            }

            showLoading('Saving permissions...');
            try {
                for (const roleId of roleIds) {
                    const perms = pendingPermissionChanges[roleId];
                    await fetch(`/api/roles/${roleId}/permissions/v2`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ permissions: perms })
                    });
                }

                pendingPermissionChanges = {};
                await JarvisDialog.alert('Permissions saved successfully!', { type: 'success' });
                // Reload to get fresh data
                await loadPermissionMatrix();
            } catch (err) {
                console.error('Error saving permissions:', err);
                await JarvisDialog.alert('Error saving permissions: ' + err.message, { type: 'error' });
            } finally {
                hideLoading();
            }
        }

        // Theme toggle is handled by theme.js with unified localStorage key 'jarvisTheme'

        // Online users tracking is handled by /static/js/online-users.js

        // ========== HR Events - Bonus Types Functions ==========

        async function loadBonusTypes() {
            try {
                const resp = await fetch('/hr/events/api/bonus-types');
                if (resp.ok) {
                    bonusTypes = await resp.json();
                    renderBonusTypesTable();
                }
            } catch (err) {
                console.error('Error loading bonus types:', err);
            }
        }

        function renderBonusTypesTable() {
            const tbody = document.getElementById('bonusTypesTableBody');
            const noMessage = document.getElementById('noBonusTypesMessage');

            if (!bonusTypes || bonusTypes.length === 0) {
                tbody.innerHTML = '';
                if (noMessage) noMessage.style.display = 'block';
                return;
            }

            if (noMessage) noMessage.style.display = 'none';

            tbody.innerHTML = bonusTypes.map(bt => `
                <tr class="${!bt.is_active ? 'text-muted' : ''}">
                    <td>${bt.name}</td>
                    <td class="text-end">${parseFloat(bt.amount).toFixed(2)}</td>
                    <td class="text-center">${parseFloat(bt.days_per_amount || 1).toFixed(1)}</td>
                    <td>${bt.description || '-'}</td>
                    <td class="text-center">
                        ${bt.is_active
                            ? '<span class="badge bg-success">Active</span>'
                            : '<span class="badge bg-secondary">Inactive</span>'}
                    </td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="editBonusType(${bt.id}, '${bt.name.replace(/'/g, "\\'")}', ${bt.amount}, ${bt.days_per_amount || 1}, '${(bt.description || '').replace(/'/g, "\\'")}', ${bt.is_active})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        ${bt.is_active ? `
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBonusType(${bt.id}, '${bt.name.replace(/'/g, "\\'")}')">
                            <i class="bi bi-trash"></i>
                        </button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function saveBonusType() {
            const name = document.getElementById('addBonusTypeName').value.trim();
            const amount = parseFloat(document.getElementById('addBonusTypeAmount').value);
            const daysPerAmount = parseFloat(document.getElementById('addBonusTypeDaysPerAmount').value) || 1;
            const description = document.getElementById('addBonusTypeDescription').value.trim();

            if (!name || isNaN(amount)) {
                await JarvisDialog.alert('Name and Amount are required', { type: 'warning' });
                return;
            }

            try {
                const resp = await fetch('/hr/events/api/bonus-types', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        amount: amount,
                        days_per_amount: daysPerAmount,
                        description: description || null
                    })
                });

                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addBonusTypeModal')).hide();
                    document.getElementById('addBonusTypeName').value = '';
                    document.getElementById('addBonusTypeAmount').value = '';
                    document.getElementById('addBonusTypeDaysPerAmount').value = '1';
                    document.getElementById('addBonusTypeDescription').value = '';
                    await loadBonusTypes();
                } else {
                    await JarvisDialog.alert('Error saving bonus type', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving bonus type', { type: 'error' });
            }
        }

        function editBonusType(id, name, amount, daysPerAmount, description, isActive) {
            document.getElementById('editBonusTypeId').value = id;
            document.getElementById('editBonusTypeName').value = name;
            document.getElementById('editBonusTypeAmount').value = amount;
            document.getElementById('editBonusTypeDaysPerAmount').value = daysPerAmount || 1;
            document.getElementById('editBonusTypeDescription').value = description;
            document.getElementById('editBonusTypeIsActive').checked = isActive;

            const modal = new bootstrap.Modal(document.getElementById('editBonusTypeModal'));
            modal.show();
        }

        async function updateBonusType() {
            const id = document.getElementById('editBonusTypeId').value;
            const name = document.getElementById('editBonusTypeName').value.trim();
            const amount = parseFloat(document.getElementById('editBonusTypeAmount').value);
            const daysPerAmount = parseFloat(document.getElementById('editBonusTypeDaysPerAmount').value) || 1;
            const description = document.getElementById('editBonusTypeDescription').value.trim();
            const isActive = document.getElementById('editBonusTypeIsActive').checked;

            if (!name || isNaN(amount)) {
                await JarvisDialog.alert('Name and Amount are required', { type: 'warning' });
                return;
            }

            try {
                const resp = await fetch(`/hr/events/api/bonus-types/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        amount: amount,
                        days_per_amount: daysPerAmount,
                        description: description || null,
                        is_active: isActive
                    })
                });

                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editBonusTypeModal')).hide();
                    await loadBonusTypes();
                } else {
                    await JarvisDialog.alert('Error updating bonus type', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error updating bonus type', { type: 'error' });
            }
        }

        async function deleteBonusType(id, name) {
            const confirmed = await JarvisDialog.confirm(`Are you sure you want to deactivate "${name}"?`, { danger: true });
            if (!confirmed) {
                return;
            }

            try {
                const resp = await fetch(`/hr/events/api/bonus-types/${id}`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    await loadBonusTypes();
                } else {
                    await JarvisDialog.alert('Error deleting bonus type', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting bonus type', { type: 'error' });
            }
        }

        // Load company structure when Company Structure tab is shown
        document.getElementById('company-structure-tab').addEventListener('shown.bs.tab', async function() {
            // Load companies first since filters depends on hrCompaniesData
            await loadHrCompanies();
            loadMasterBrands();
            loadMasterDepts();
            loadMasterSubdepts();
            loadHrDepartments();
        });

        // Load bonus types when HR tab is shown
        document.getElementById('hr-tab').addEventListener('shown.bs.tab', function() {
            loadBonusTypes();
        });

        // ============== Company Structure Functions (Core APIs) ==============
        async function loadHrCompanies() {
            try {
                const resp = await fetch('/api/companies-vat');
                if (!resp.ok) {
                    throw new Error(`HTTP ${resp.status}`);
                }
                hrCompaniesData = await resp.json();
                console.log('Companies loaded:', hrCompaniesData.length);
                filterCompanies(); // This will set filteredCompaniesData and call renderHrCompanies
                populateHrCompanyFilters();
                document.getElementById('hrStatsCompanies').textContent = hrCompaniesData.length;
            } catch (err) {
                console.error('Error loading companies:', err);
                document.getElementById('hrCompaniesTable').innerHTML = '<tr><td colspan="3" class="text-center text-danger py-3"><i class="bi bi-exclamation-triangle"></i> Error loading companies</td></tr>';
                document.getElementById('hrStatsCompanies').textContent = '-';
            }
        }

        function renderHrCompanies() {
            const tbody = document.getElementById('hrCompaniesTable');
            if (filteredCompaniesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3"><i class="bi bi-inbox"></i> No companies found</td></tr>';
                updateCompaniesSelection();
                return;
            }
            tbody.innerHTML = filteredCompaniesData.map(c => `
                <tr data-company="${c.company}" class="${selectedCompanies.has(c.id) ? 'table-primary' : ''}">
                    <td><input type="checkbox" class="form-check-input" ${selectedCompanies.has(c.id) ? 'checked' : ''} onchange="toggleCompanySelect(${c.id})"></td>
                    <td><strong>${c.company}</strong></td>
                    <td><code>${c.vat || '-'}</code></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editHrCompany('${c.company.replace(/'/g, "\\'")}')" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHrCompany('${c.company.replace(/'/g, "\\'")}')" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            updateCompaniesSelection();
        }

        function filterCompanies() {
            const searchTerm = (document.getElementById('companiesSearchInput')?.value || '').toLowerCase().trim();
            filteredCompaniesData = hrCompaniesData.filter(c => {
                if (!searchTerm) return true;
                const searchFields = [c.company || '', c.vat || ''].join(' ').toLowerCase();
                return searchFields.includes(searchTerm);
            });
            document.getElementById('companiesCount').textContent = filteredCompaniesData.length;
            renderHrCompanies();
        }

        function clearCompaniesSearch() {
            document.getElementById('companiesSearchInput').value = '';
            filterCompanies();
        }

        // ============== Selection Functions ==============
        function toggleSelectAllCompanies() {
            const selectAll = document.getElementById('companiesSelectAll');
            const visibleIds = filteredCompaniesData.map(c => c.id);
            if (selectAll.checked) {
                visibleIds.forEach(id => selectedCompanies.add(id));
            } else {
                visibleIds.forEach(id => selectedCompanies.delete(id));
            }
            updateCompaniesSelection();
            renderHrCompanies();
        }

        function toggleCompanySelect(id) {
            if (selectedCompanies.has(id)) {
                selectedCompanies.delete(id);
            } else {
                selectedCompanies.add(id);
            }
            updateCompaniesSelection();
        }

        function updateCompaniesSelection() {
            const countEl = document.getElementById('companiesSelectedCount');
            const deleteBtn = document.getElementById('companiesDeleteSelectedBtn');
            const selectAll = document.getElementById('companiesSelectAll');
            const visibleIds = filteredCompaniesData.map(c => c.id);
            const visibleSelected = visibleIds.filter(id => selectedCompanies.has(id));

            if (selectedCompanies.size > 0) {
                countEl.textContent = `${selectedCompanies.size} selected`;
                countEl.classList.remove('d-none');
                deleteBtn.classList.remove('d-none');
            } else {
                countEl.classList.add('d-none');
                deleteBtn.classList.add('d-none');
            }

            // Update select all checkbox state
            if (selectAll) {
                selectAll.checked = visibleIds.length > 0 && visibleSelected.length === visibleIds.length;
                selectAll.indeterminate = visibleSelected.length > 0 && visibleSelected.length < visibleIds.length;
            }
        }

        function toggleSelectAllBrands() {
            const selectAll = document.getElementById('brandsSelectAll');
            const visibleIds = filteredBrandsData.map(b => b.id);
            if (selectAll.checked) {
                visibleIds.forEach(id => selectedBrands.add(id));
            } else {
                visibleIds.forEach(id => selectedBrands.delete(id));
            }
            updateBrandsSelection();
            renderMasterBrands();
        }

        function toggleBrandSelect(id) {
            if (selectedBrands.has(id)) {
                selectedBrands.delete(id);
            } else {
                selectedBrands.add(id);
            }
            updateBrandsSelection();
        }

        function updateBrandsSelection() {
            const countEl = document.getElementById('brandsSelectedCount');
            const deleteBtn = document.getElementById('brandsDeleteSelectedBtn');
            const selectAll = document.getElementById('brandsSelectAll');
            const visibleIds = filteredBrandsData.map(b => b.id);
            const visibleSelected = visibleIds.filter(id => selectedBrands.has(id));

            if (selectedBrands.size > 0) {
                countEl.textContent = `${selectedBrands.size} selected`;
                countEl.classList.remove('d-none');
                deleteBtn.classList.remove('d-none');
            } else {
                countEl.classList.add('d-none');
                deleteBtn.classList.add('d-none');
            }

            if (selectAll) {
                selectAll.checked = visibleIds.length > 0 && visibleSelected.length === visibleIds.length;
                selectAll.indeterminate = visibleSelected.length > 0 && visibleSelected.length < visibleIds.length;
            }
        }

        function toggleSelectAllDepts() {
            const selectAll = document.getElementById('deptsSelectAll');
            const visibleIds = filteredDeptsData.map(d => d.id);
            if (selectAll.checked) {
                visibleIds.forEach(id => selectedDepts.add(id));
            } else {
                visibleIds.forEach(id => selectedDepts.delete(id));
            }
            updateDeptsSelection();
            renderMasterDepts();
        }

        function toggleDeptSelect(id) {
            if (selectedDepts.has(id)) {
                selectedDepts.delete(id);
            } else {
                selectedDepts.add(id);
            }
            updateDeptsSelection();
        }

        function updateDeptsSelection() {
            const countEl = document.getElementById('deptsSelectedCount');
            const deleteBtn = document.getElementById('deptsDeleteSelectedBtn');
            const selectAll = document.getElementById('deptsSelectAll');
            const visibleIds = filteredDeptsData.map(d => d.id);
            const visibleSelected = visibleIds.filter(id => selectedDepts.has(id));

            if (selectedDepts.size > 0) {
                countEl.textContent = `${selectedDepts.size} selected`;
                countEl.classList.remove('d-none');
                deleteBtn.classList.remove('d-none');
            } else {
                countEl.classList.add('d-none');
                deleteBtn.classList.add('d-none');
            }

            if (selectAll) {
                selectAll.checked = visibleIds.length > 0 && visibleSelected.length === visibleIds.length;
                selectAll.indeterminate = visibleSelected.length > 0 && visibleSelected.length < visibleIds.length;
            }
        }

        function toggleSelectAllSubdepts() {
            const selectAll = document.getElementById('subdeptsSelectAll');
            const visibleIds = filteredSubdeptsData.map(s => s.id);
            if (selectAll.checked) {
                visibleIds.forEach(id => selectedSubdepts.add(id));
            } else {
                visibleIds.forEach(id => selectedSubdepts.delete(id));
            }
            updateSubdeptsSelection();
            renderMasterSubdepts();
        }

        function toggleSubdeptSelect(id) {
            if (selectedSubdepts.has(id)) {
                selectedSubdepts.delete(id);
            } else {
                selectedSubdepts.add(id);
            }
            updateSubdeptsSelection();
        }

        function updateSubdeptsSelection() {
            const countEl = document.getElementById('subdeptsSelectedCount');
            const deleteBtn = document.getElementById('subdeptsDeleteSelectedBtn');
            const selectAll = document.getElementById('subdeptsSelectAll');
            const visibleIds = filteredSubdeptsData.map(s => s.id);
            const visibleSelected = visibleIds.filter(id => selectedSubdepts.has(id));

            if (selectedSubdepts.size > 0) {
                countEl.textContent = `${selectedSubdepts.size} selected`;
                countEl.classList.remove('d-none');
                deleteBtn.classList.remove('d-none');
            } else {
                countEl.classList.add('d-none');
                deleteBtn.classList.add('d-none');
            }

            if (selectAll) {
                selectAll.checked = visibleIds.length > 0 && visibleSelected.length === visibleIds.length;
                selectAll.indeterminate = visibleSelected.length > 0 && visibleSelected.length < visibleIds.length;
            }
        }

        function toggleSelectAllStructure() {
            const selectAll = document.getElementById('structureSelectAll');
            const visibleIds = filteredStructureData.map(s => s.id);
            if (selectAll.checked) {
                visibleIds.forEach(id => selectedStructure.add(id));
            } else {
                visibleIds.forEach(id => selectedStructure.delete(id));
            }
            updateStructureSelection();
            renderStructure();
        }

        function toggleStructureSelect(id) {
            if (selectedStructure.has(id)) {
                selectedStructure.delete(id);
            } else {
                selectedStructure.add(id);
            }
            updateStructureSelection();
        }

        function updateStructureSelection() {
            const countEl = document.getElementById('structureSelectedCount');
            const deleteBtn = document.getElementById('structureDeleteSelectedBtn');
            const selectAll = document.getElementById('structureSelectAll');
            const visibleIds = filteredStructureData.map(s => s.id);
            const visibleSelected = visibleIds.filter(id => selectedStructure.has(id));

            if (selectedStructure.size > 0) {
                countEl.textContent = `${selectedStructure.size} selected`;
                countEl.classList.remove('d-none');
                deleteBtn.classList.remove('d-none');
            } else {
                countEl.classList.add('d-none');
                deleteBtn.classList.add('d-none');
            }

            if (selectAll) {
                selectAll.checked = visibleIds.length > 0 && visibleSelected.length === visibleIds.length;
                selectAll.indeterminate = visibleSelected.length > 0 && visibleSelected.length < visibleIds.length;
            }
        }

        function populateHrCompanyFilters() {
            const selects = ['hrDepartmentCompanyFilter', 'hrDeptCompany'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;
                const currentValue = select.value;
                const isFilter = id.includes('Filter');
                select.innerHTML = isFilter
                    ? '<option value="">All Companies</option>'
                    : '<option value="">Select Company</option>';
                hrCompaniesData.forEach(c => {
                    select.innerHTML += `<option value="${c.company}">${c.company}</option>`;
                });
                select.value = currentValue;
            });
        }

        // Track brands for the current company being edited
        let currentCompanyBrands = []; // [{id: null/number, brand: string, isNew: bool, isDeleted: bool}]

        function openAddHrCompanyModal() {
            document.getElementById('hrCompanyModalTitle').textContent = 'Add Company';
            document.getElementById('hrCompanyForm').reset();
            document.getElementById('hrCompanyId').value = '';
            document.getElementById('hrCompanyDbId').value = '';
            currentCompanyBrands = [];
            renderCompanyBrands();
        }

        function editHrCompany(companyName) {
            const company = hrCompaniesData.find(c => c.company === companyName);
            if (!company) return;

            document.getElementById('hrCompanyModalTitle').textContent = 'Edit Company';
            document.getElementById('hrCompanyId').value = companyName; // Store original name for update
            document.getElementById('hrCompanyDbId').value = company.id || '';
            document.getElementById('hrCompanyName').value = company.company;
            document.getElementById('hrCompanyVat').value = company.vat || '';

            // Load brands from brands_list
            currentCompanyBrands = (company.brands_list || []).map(b => ({
                id: b.id,
                brand: b.brand,
                isNew: false,
                isDeleted: false
            }));
            renderCompanyBrands();

            const modal = new bootstrap.Modal(document.getElementById('hrCompanyModal'));
            modal.show();
        }

        function renderCompanyBrands() {
            const container = document.getElementById('hrCompanyBrandsList');
            const activeBrands = currentCompanyBrands.filter(b => !b.isDeleted);

            if (activeBrands.length === 0) {
                container.innerHTML = '<div class="text-muted small text-center py-2" id="noBrandsMessage">No brands added yet</div>';
                return;
            }

            container.innerHTML = activeBrands.map((b, idx) => {
                const realIdx = currentCompanyBrands.indexOf(b);
                return `
                    <div class="d-flex align-items-center gap-2 mb-1" data-idx="${realIdx}">
                        <input type="text" class="form-control form-control-sm" value="${b.brand}"
                               onchange="updateCompanyBrand(${realIdx}, this.value)" placeholder="Brand name">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCompanyBrand(${realIdx})" title="Remove">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        function addCompanyBrandRow() {
            currentCompanyBrands.push({ id: null, brand: '', isNew: true, isDeleted: false });
            renderCompanyBrands();
            // Focus the new input
            const container = document.getElementById('hrCompanyBrandsList');
            const lastInput = container.querySelector('input:last-of-type');
            if (lastInput) lastInput.focus();
        }

        function updateCompanyBrand(idx, value) {
            if (currentCompanyBrands[idx]) {
                currentCompanyBrands[idx].brand = value.trim();
            }
        }

        function removeCompanyBrand(idx) {
            if (currentCompanyBrands[idx]) {
                if (currentCompanyBrands[idx].isNew) {
                    // New brand, just remove from array
                    currentCompanyBrands.splice(idx, 1);
                } else {
                    // Existing brand, mark as deleted
                    currentCompanyBrands[idx].isDeleted = true;
                }
                renderCompanyBrands();
            }
        }

        async function saveHrCompany() {
            const originalCompany = document.getElementById('hrCompanyId').value;
            const companyDbId = document.getElementById('hrCompanyDbId').value;
            const data = {
                company: document.getElementById('hrCompanyName').value.trim(),
                vat: document.getElementById('hrCompanyVat').value.trim() || ''
            };

            if (!data.company) {
                await JarvisDialog.alert('Company name is required', { type: 'warning' });
                return;
            }

            try {
                let url, method;
                if (originalCompany) {
                    url = `/api/companies-vat/${encodeURIComponent(originalCompany)}`;
                    method = 'PUT';
                } else {
                    url = '/api/companies-vat';
                    method = 'POST';
                }

                // Save company first
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!resp.ok) {
                    const error = await resp.json();
                    await JarvisDialog.alert(error.error || 'Error saving company', { type: 'error' });
                    return;
                }

                // Get the company ID for brand operations
                let companyId = companyDbId;
                if (!companyId) {
                    // If creating a new company, fetch to get the ID
                    const companiesResp = await fetch('/api/companies-vat');
                    const companies = await companiesResp.json();
                    const newCompany = companies.find(c => c.company === data.company);
                    companyId = newCompany?.id;
                }

                // Now save brands if we have a company ID
                if (companyId) {
                    // Process brand changes
                    for (const brand of currentCompanyBrands) {
                        if (brand.isDeleted && brand.id) {
                            // Delete existing brand
                            await fetch(`/hr/events/api/structure/company-brands/${brand.id}`, { method: 'DELETE' });
                        } else if (brand.isNew && brand.brand) {
                            // Create new brand
                            await fetch('/hr/events/api/structure/company-brands', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ company_id: parseInt(companyId), brand: brand.brand })
                            });
                        } else if (!brand.isNew && !brand.isDeleted && brand.id && brand.brand) {
                            // Update existing brand (in case name changed)
                            await fetch(`/hr/events/api/structure/company-brands/${brand.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ brand: brand.brand })
                            });
                        }
                    }
                }

                bootstrap.Modal.getInstance(document.getElementById('hrCompanyModal')).hide();
                loadHrCompanies();
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving company', { type: 'error' });
            }
        }

        async function deleteHrCompany(companyName) {
            const confirmed = await JarvisDialog.confirm(`Delete company "${companyName}"? This will also delete all associated brands. This cannot be undone.`, { danger: true });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/api/companies-vat/${encodeURIComponent(companyName)}`, { method: 'DELETE' });
                if (resp.ok) {
                    loadHrCompanies();
                } else {
                    await JarvisDialog.alert('Error deleting company', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting company', { type: 'error' });
            }
        }

        async function bulkDeleteCompanies() {
            const ids = Array.from(selectedCompanies);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} ${ids.length === 1 ? 'company' : 'companies'}? This will also delete all associated brands. This cannot be undone.`,
                { danger: true, confirmText: 'Delete All' }
            );
            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            for (const id of ids) {
                const company = hrCompaniesData.find(c => c.id === id);
                if (!company) continue;

                try {
                    const resp = await fetch(`/api/companies-vat/${encodeURIComponent(company.company)}`, { method: 'DELETE' });
                    if (resp.ok) {
                        successCount++;
                        selectedCompanies.delete(id);
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error('Error deleting company:', err);
                    errorCount++;
                }
            }

            loadHrCompanies();

            if (errorCount > 0) {
                await JarvisDialog.alert(`Deleted ${successCount} companies. ${errorCount} failed.`, { type: 'warning' });
            } else {
                JarvisToast.success(`Deleted ${successCount} companies`);
            }
        }

        // ============== Departments (Core APIs) ==============
        async function loadHrDepartments() {
            try {
                const resp = await fetch('/api/department-structures');
                hrDepartmentsData = await resp.json();
                renderHrDepartments();
                const statsEl = document.getElementById('hrStatsDepartments');
                if (statsEl) statsEl.textContent = hrDepartmentsData.length;
            } catch (err) {
                console.error('Error loading departments:', err);
                const tbody = document.getElementById('hrDepartmentsTable');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3"><i class="bi bi-exclamation-triangle"></i> Error loading departments</td></tr>';
            }
        }

        function renderHrDepartments() {
            const filterEl = document.getElementById('hrDepartmentCompanyFilter');
            const filter = filterEl ? filterEl.value : '';
            const filtered = filter
                ? hrDepartmentsData.filter(d => d.company === filter)
                : hrDepartmentsData;

            const tbody = document.getElementById('hrDepartmentsTable');
            if (!tbody) return;

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3"><i class="bi bi-inbox"></i> No departments found</td></tr>';
                return;
            }
            tbody.innerHTML = filtered.map(d => `
                <tr data-id="${d.id}">
                    <td><strong>${d.department}</strong></td>
                    <td>${d.subdepartment || '-'}</td>
                    <td>${d.manager || '-'}</td>
                    <td>${d.brand || '-'}</td>
                    <td>${d.company}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editHrDepartment(${d.id})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteHrDepartment(${d.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        const hrDepartmentCompanyFilter = document.getElementById('hrDepartmentCompanyFilter');
        if (hrDepartmentCompanyFilter) {
            hrDepartmentCompanyFilter.addEventListener('change', renderHrDepartments);
        }

        function openAddHrDepartmentModal() {
            document.getElementById('hrDepartmentModalTitle').textContent = 'Add Department';
            document.getElementById('hrDepartmentForm').reset();
            document.getElementById('hrDepartmentId').value = '';
            document.getElementById('hrDeptBrand').innerHTML = '<option value="">Select Brand (optional)</option>';
        }

        async function editHrDepartment(id) {
            const dept = hrDepartmentsData.find(d => d.id === id);
            if (!dept) return;

            document.getElementById('hrDepartmentModalTitle').textContent = 'Edit Department';
            document.getElementById('hrDepartmentId').value = id;
            document.getElementById('hrDeptCompany').value = dept.company;
            document.getElementById('hrDeptName').value = dept.department;
            document.getElementById('hrDeptSubdepartment').value = dept.subdepartment || '';
            document.getElementById('hrDeptManager').value = dept.manager || '';

            // Load brands for the company from companies-vat data
            await loadBrandsForCompany(dept.company, dept.brand);

            const modal = new bootstrap.Modal(document.getElementById('hrDepartmentModal'));
            modal.show();
        }

        async function loadBrandsForCompany(company, selectedBrand = '') {
            const brandSelect = document.getElementById('hrDeptBrand');
            brandSelect.innerHTML = '<option value="">Select Brand (optional)</option>';

            if (company) {
                // Get brands from the companies-vat data
                const companyData = hrCompaniesData.find(c => c.company === company);
                if (companyData && companyData.brands) {
                    const brands = companyData.brands.split(/[,\s]+/).filter(b => b.trim());
                    brands.forEach(b => {
                        brandSelect.innerHTML += `<option value="${b.trim()}">${b.trim()}</option>`;
                    });
                }
                brandSelect.value = selectedBrand || '';
            }
        }

        // Load brands when company changes in department modal
        document.getElementById('hrDeptCompany').addEventListener('change', async (e) => {
            await loadBrandsForCompany(e.target.value);
        });

        async function saveHrDepartment() {
            const id = document.getElementById('hrDepartmentId').value;
            const data = {
                company: document.getElementById('hrDeptCompany').value,
                brand: document.getElementById('hrDeptBrand').value || null,
                department: document.getElementById('hrDeptName').value.trim(),
                subdepartment: document.getElementById('hrDeptSubdepartment').value.trim() || null,
                manager: document.getElementById('hrDeptManager').value.trim() || null
            };

            if (!data.company || !data.department) {
                await JarvisDialog.alert('Company and Department are required', { type: 'warning' });
                return;
            }

            try {
                const url = id ? `/api/department-structures/${id}` : '/api/department-structures';
                const method = id ? 'PUT' : 'POST';

                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('hrDepartmentModal')).hide();
                    loadHrDepartments();
                } else {
                    await JarvisDialog.alert('Error saving department', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving department', { type: 'error' });
            }
        }

        async function deleteHrDepartment(id) {
            const confirmed = await JarvisDialog.confirm('Delete this department? This cannot be undone.', { danger: true });
            if (!confirmed) return;

            try {
                const resp = await fetch(`/api/department-structures/${id}`, { method: 'DELETE' });
                if (resp.ok) {
                    loadHrDepartments();
                } else {
                    await JarvisDialog.alert('Error deleting department', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting department', { type: 'error' });
            }
        }

        // ============== Master Tables Functions ==============
        // Load master data when sub-tabs are shown
        document.getElementById('hr-brands-tab')?.addEventListener('shown.bs.tab', loadMasterBrands);
        document.getElementById('hr-depts-tab')?.addEventListener('shown.bs.tab', loadMasterDepts);
        document.getElementById('hr-subdepts-tab')?.addEventListener('shown.bs.tab', loadMasterSubdepts);
        document.getElementById('hr-structure-tab')?.addEventListener('shown.bs.tab', loadStructure);

        // ============== Master Brands ==============
        async function loadMasterBrands() {
            try {
                const resp = await fetch('/hr/events/api/master/brands', { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                masterBrandsData = await resp.json();
                filterBrands(); // This sets filteredBrandsData and calls renderMasterBrands
                document.getElementById('hrStatsBrands').textContent = masterBrandsData.length;
            } catch (err) {
                console.error('Error loading brands:', err);
                document.getElementById('masterBrandsTable').innerHTML = '<tr><td colspan="2" class="text-center text-danger py-3">Error loading brands</td></tr>';
            }
        }

        function filterBrands() {
            const searchTerm = (document.getElementById('brandsSearchInput')?.value || '').toLowerCase().trim();
            filteredBrandsData = masterBrandsData.filter(b => {
                if (!searchTerm) return true;
                return (b.name || '').toLowerCase().includes(searchTerm);
            });
            document.getElementById('brandsCount').textContent = filteredBrandsData.length;
            renderMasterBrands();
        }

        function clearBrandsSearch() {
            document.getElementById('brandsSearchInput').value = '';
            filterBrands();
        }

        function renderMasterBrands() {
            const tbody = document.getElementById('masterBrandsTable');
            if (filteredBrandsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No brands found</td></tr>';
                updateBrandsSelection();
                return;
            }
            tbody.innerHTML = filteredBrandsData.map(b => `
                <tr class="${selectedBrands.has(b.id) ? 'table-primary' : ''}">
                    <td><input type="checkbox" class="form-check-input" ${selectedBrands.has(b.id) ? 'checked' : ''} onchange="toggleBrandSelect(${b.id})"></td>
                    <td>${b.name}</td>
                    <td>
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editMasterBrand(${b.id}, '${b.name.replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteMasterBrand(${b.id}, '${b.name.replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            updateBrandsSelection();
        }

        function openAddMasterBrandModal() {
            document.getElementById('masterBrandId').value = '';
            document.getElementById('masterBrandName').value = '';
            document.getElementById('masterBrandModalTitle').textContent = 'Add Brand';
            new bootstrap.Modal(document.getElementById('masterBrandModal')).show();
        }

        function editMasterBrand(id, name) {
            document.getElementById('masterBrandId').value = id;
            document.getElementById('masterBrandName').value = name;
            document.getElementById('masterBrandModalTitle').textContent = 'Edit Brand';
            new bootstrap.Modal(document.getElementById('masterBrandModal')).show();
        }

        async function saveMasterBrand() {
            const id = document.getElementById('masterBrandId').value;
            const name = document.getElementById('masterBrandName').value.trim();
            if (!name) {
                await JarvisDialog.alert('Brand name is required', { type: 'warning' });
                return;
            }

            const url = id ? `/hr/events/api/master/brands/${id}` : '/hr/events/api/master/brands';
            const method = id ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('masterBrandModal')).hide();
                    loadMasterBrands();
                } else {
                    const data = await resp.json();
                    await JarvisDialog.alert(data.error || 'Error saving brand', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving brand', { type: 'error' });
            }
        }

        async function deleteMasterBrand(id, name) {
            const confirmed = await JarvisDialog.confirm(`Delete brand "${name}"?`, { danger: true });
            if (!confirmed) return;
            try {
                const resp = await fetch(`/hr/events/api/master/brands/${id}`, { method: 'DELETE' });
                if (resp.ok) loadMasterBrands();
                else await JarvisDialog.alert('Error deleting brand', { type: 'error' });
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting brand', { type: 'error' });
            }
        }

        async function bulkDeleteBrands() {
            const ids = Array.from(selectedBrands);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} ${ids.length === 1 ? 'brand' : 'brands'}? This cannot be undone.`,
                { danger: true, confirmText: 'Delete All' }
            );
            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            for (const id of ids) {
                try {
                    const resp = await fetch(`/hr/events/api/master/brands/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        successCount++;
                        selectedBrands.delete(id);
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error('Error deleting brand:', err);
                    errorCount++;
                }
            }

            loadMasterBrands();

            if (errorCount > 0) {
                await JarvisDialog.alert(`Deleted ${successCount} brands. ${errorCount} failed.`, { type: 'warning' });
            } else {
                JarvisToast.success(`Deleted ${successCount} brands`);
            }
        }

        // ============== Master Departments ==============
        async function loadMasterDepts() {
            try {
                const resp = await fetch('/hr/events/api/master/departments', { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                masterDeptsData = await resp.json();
                filterDepts(); // This sets filteredDeptsData and calls renderMasterDepts
                document.getElementById('hrStatsDepartments').textContent = masterDeptsData.length;
            } catch (err) {
                console.error('Error loading departments:', err);
                document.getElementById('masterDeptsTable').innerHTML = '<tr><td colspan="2" class="text-center text-danger py-3">Error loading departments</td></tr>';
            }
        }

        function filterDepts() {
            const searchTerm = (document.getElementById('deptsSearchInput')?.value || '').toLowerCase().trim();
            filteredDeptsData = masterDeptsData.filter(d => {
                if (!searchTerm) return true;
                return (d.name || '').toLowerCase().includes(searchTerm);
            });
            document.getElementById('deptsCount').textContent = filteredDeptsData.length;
            renderMasterDepts();
        }

        function clearDeptsSearch() {
            document.getElementById('deptsSearchInput').value = '';
            filterDepts();
        }

        function renderMasterDepts() {
            const tbody = document.getElementById('masterDeptsTable');
            if (filteredDeptsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No departments found</td></tr>';
                updateDeptsSelection();
                return;
            }
            tbody.innerHTML = filteredDeptsData.map(d => `
                <tr class="${selectedDepts.has(d.id) ? 'table-primary' : ''}">
                    <td><input type="checkbox" class="form-check-input" ${selectedDepts.has(d.id) ? 'checked' : ''} onchange="toggleDeptSelect(${d.id})"></td>
                    <td>${d.name}</td>
                    <td>
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editMasterDept(${d.id}, '${d.name.replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteMasterDept(${d.id}, '${d.name.replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            updateDeptsSelection();
        }

        function openAddMasterDeptModal() {
            document.getElementById('masterDeptId').value = '';
            document.getElementById('masterDeptName').value = '';
            document.getElementById('masterDeptModalTitle').textContent = 'Add Department';
            new bootstrap.Modal(document.getElementById('masterDeptModal')).show();
        }

        function editMasterDept(id, name) {
            document.getElementById('masterDeptId').value = id;
            document.getElementById('masterDeptName').value = name;
            document.getElementById('masterDeptModalTitle').textContent = 'Edit Department';
            new bootstrap.Modal(document.getElementById('masterDeptModal')).show();
        }

        async function saveMasterDept() {
            const id = document.getElementById('masterDeptId').value;
            const name = document.getElementById('masterDeptName').value.trim();
            if (!name) {
                await JarvisDialog.alert('Department name is required', { type: 'warning' });
                return;
            }

            const url = id ? `/hr/events/api/master/departments/${id}` : '/hr/events/api/master/departments';
            const method = id ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('masterDeptModal')).hide();
                    loadMasterDepts();
                } else {
                    const data = await resp.json();
                    await JarvisDialog.alert(data.error || 'Error saving department', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving department', { type: 'error' });
            }
        }

        async function deleteMasterDept(id, name) {
            const confirmed = await JarvisDialog.confirm(`Delete department "${name}"?`, { danger: true });
            if (!confirmed) return;
            try {
                const resp = await fetch(`/hr/events/api/master/departments/${id}`, { method: 'DELETE' });
                if (resp.ok) loadMasterDepts();
                else await JarvisDialog.alert('Error deleting department', { type: 'error' });
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting department', { type: 'error' });
            }
        }

        async function bulkDeleteDepts() {
            const ids = Array.from(selectedDepts);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} ${ids.length === 1 ? 'department' : 'departments'}? This cannot be undone.`,
                { danger: true, confirmText: 'Delete All' }
            );
            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            for (const id of ids) {
                try {
                    const resp = await fetch(`/hr/events/api/master/departments/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        successCount++;
                        selectedDepts.delete(id);
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error('Error deleting department:', err);
                    errorCount++;
                }
            }

            loadMasterDepts();

            if (errorCount > 0) {
                await JarvisDialog.alert(`Deleted ${successCount} departments. ${errorCount} failed.`, { type: 'warning' });
            } else {
                JarvisToast.success(`Deleted ${successCount} departments`);
            }
        }

        // ============== Master Subdepartments ==============
        async function loadMasterSubdepts() {
            try {
                const resp = await fetch('/hr/events/api/master/subdepartments', { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                masterSubdeptsData = await resp.json();
                filterSubdepts(); // This sets filteredSubdeptsData and calls renderMasterSubdepts
            } catch (err) {
                console.error('Error loading subdepartments:', err);
                document.getElementById('masterSubdeptsTable').innerHTML = '<tr><td colspan="2" class="text-center text-danger py-3">Error loading subdepartments</td></tr>';
            }
        }

        function filterSubdepts() {
            const searchTerm = (document.getElementById('subdeptsSearchInput')?.value || '').toLowerCase().trim();
            filteredSubdeptsData = masterSubdeptsData.filter(s => {
                if (!searchTerm) return true;
                return (s.name || '').toLowerCase().includes(searchTerm);
            });
            document.getElementById('subdeptsCount').textContent = filteredSubdeptsData.length;
            renderMasterSubdepts();
        }

        function clearSubdeptsSearch() {
            document.getElementById('subdeptsSearchInput').value = '';
            filterSubdepts();
        }

        function renderMasterSubdepts() {
            const tbody = document.getElementById('masterSubdeptsTable');
            if (filteredSubdeptsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No subdepartments found</td></tr>';
                updateSubdeptsSelection();
                return;
            }
            tbody.innerHTML = filteredSubdeptsData.map(s => `
                <tr class="${selectedSubdepts.has(s.id) ? 'table-primary' : ''}">
                    <td><input type="checkbox" class="form-check-input" ${selectedSubdepts.has(s.id) ? 'checked' : ''} onchange="toggleSubdeptSelect(${s.id})"></td>
                    <td>${s.name}</td>
                    <td>
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editMasterSubdept(${s.id}, '${s.name.replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteMasterSubdept(${s.id}, '${s.name.replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            updateSubdeptsSelection();
        }

        function openAddMasterSubdeptModal() {
            document.getElementById('masterSubdeptId').value = '';
            document.getElementById('masterSubdeptName').value = '';
            document.getElementById('masterSubdeptModalTitle').textContent = 'Add Subdepartment';
            new bootstrap.Modal(document.getElementById('masterSubdeptModal')).show();
        }

        function editMasterSubdept(id, name) {
            document.getElementById('masterSubdeptId').value = id;
            document.getElementById('masterSubdeptName').value = name;
            document.getElementById('masterSubdeptModalTitle').textContent = 'Edit Subdepartment';
            new bootstrap.Modal(document.getElementById('masterSubdeptModal')).show();
        }

        async function saveMasterSubdept() {
            const id = document.getElementById('masterSubdeptId').value;
            const name = document.getElementById('masterSubdeptName').value.trim();
            if (!name) {
                await JarvisDialog.alert('Subdepartment name is required', { type: 'warning' });
                return;
            }

            const url = id ? `/hr/events/api/master/subdepartments/${id}` : '/hr/events/api/master/subdepartments';
            const method = id ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });
                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('masterSubdeptModal')).hide();
                    loadMasterSubdepts();
                } else {
                    const data = await resp.json();
                    await JarvisDialog.alert(data.error || 'Error saving subdepartment', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving subdepartment', { type: 'error' });
            }
        }

        async function deleteMasterSubdept(id, name) {
            const confirmed = await JarvisDialog.confirm(`Delete subdepartment "${name}"?`, { danger: true });
            if (!confirmed) return;
            try {
                const resp = await fetch(`/hr/events/api/master/subdepartments/${id}`, { method: 'DELETE' });
                if (resp.ok) loadMasterSubdepts();
                else await JarvisDialog.alert('Error deleting subdepartment', { type: 'error' });
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting subdepartment', { type: 'error' });
            }
        }

        async function bulkDeleteSubdepts() {
            const ids = Array.from(selectedSubdepts);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} ${ids.length === 1 ? 'subdepartment' : 'subdepartments'}? This cannot be undone.`,
                { danger: true, confirmText: 'Delete All' }
            );
            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            for (const id of ids) {
                try {
                    const resp = await fetch(`/hr/events/api/master/subdepartments/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        successCount++;
                        selectedSubdepts.delete(id);
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error('Error deleting subdepartment:', err);
                    errorCount++;
                }
            }

            loadMasterSubdepts();

            if (errorCount > 0) {
                await JarvisDialog.alert(`Deleted ${successCount} subdepartments. ${errorCount} failed.`, { type: 'warning' });
            } else {
                JarvisToast.success(`Deleted ${successCount} subdepartments`);
            }
        }

        // ============== Company Structure (with dropdowns) ==============
        async function loadStructure() {
            try {
                // Load all master data for dropdowns
                const opts = { cache: 'no-store' };
                const [brandsResp, deptsResp, subdeptsResp, structResp] = await Promise.all([
                    fetch('/hr/events/api/master/brands', opts),
                    fetch('/hr/events/api/master/departments', opts),
                    fetch('/hr/events/api/master/subdepartments', opts),
                    fetch('/hr/events/api/structure/departments-full', opts)
                ]);

                if (!brandsResp.ok) throw new Error(`Brands: HTTP ${brandsResp.status}`);
                if (!deptsResp.ok) throw new Error(`Depts: HTTP ${deptsResp.status}`);
                if (!subdeptsResp.ok) throw new Error(`Subdepts: HTTP ${subdeptsResp.status}`);
                if (!structResp.ok) throw new Error(`Structure: HTTP ${structResp.status}`);

                masterBrandsData = await brandsResp.json();
                masterDeptsData = await deptsResp.json();
                masterSubdeptsData = await subdeptsResp.json();
                structureData = await structResp.json();

                // populateStructureFilters calls filterStructure which calls renderStructure
                populateStructureFilters();
            } catch (err) {
                console.error('Error loading structure:', err);
                document.getElementById('hrStructureTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Error loading structure</td></tr>';
            }
        }

        function renderStructure() {
            const tbody = document.getElementById('hrStructureTable');

            // Use filtered data (set by filterStructure())
            if (filteredStructureData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">No structure entries found</td></tr>';
                updateStructureSelection();
                return;
            }

            tbody.innerHTML = filteredStructureData.map(s => `
                <tr class="${selectedStructure.has(s.id) ? 'table-primary' : ''}">
                    <td><input type="checkbox" class="form-check-input" ${selectedStructure.has(s.id) ? 'checked' : ''} onchange="toggleStructureSelect(${s.id})"></td>
                    <td>${s.company || '-'}</td>
                    <td>${s.brand || '-'}</td>
                    <td>${s.department || '-'}</td>
                    <td>${s.subdepartment || '-'}</td>
                    <td>${s.manager || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-link text-primary p-0 me-2" onclick="editStructure(${s.id})"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteStructure(${s.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            updateStructureSelection();
        }

        function populateStructureFilters() {
            // Populate company filter
            const companies = [...new Set(structureData.map(s => s.company).filter(Boolean))].sort();
            const companySelect = document.getElementById('hrStructureCompanyFilter');
            if (companySelect) {
                const currentVal = companySelect.value;
                companySelect.innerHTML = '<option value="">All Companies</option>' +
                    companies.map(c => `<option value="${c}">${c}</option>`).join('');
                companySelect.value = currentVal;
            }

            // Populate department filter
            const departments = [...new Set(structureData.map(s => s.department).filter(Boolean))].sort();
            const deptSelect = document.getElementById('structureDeptFilter');
            if (deptSelect) {
                const currentVal = deptSelect.value;
                deptSelect.innerHTML = '<option value="">All Departments</option>' +
                    departments.map(d => `<option value="${d}">${d}</option>`).join('');
                deptSelect.value = currentVal;
            }

            // Apply initial filter
            filterStructure();
        }

        function filterStructure() {
            const companyFilter = document.getElementById('hrStructureCompanyFilter')?.value || '';
            const deptFilter = document.getElementById('structureDeptFilter')?.value || '';
            const searchTerm = document.getElementById('structureSearchInput')?.value?.toLowerCase() || '';

            filteredStructureData = structureData.filter(s => {
                if (companyFilter && s.company !== companyFilter) return false;
                if (deptFilter && s.department !== deptFilter) return false;
                if (searchTerm) {
                    const searchStr = `${s.company || ''} ${s.brand || ''} ${s.department || ''} ${s.subdepartment || ''} ${s.manager || ''}`.toLowerCase();
                    if (!searchStr.includes(searchTerm)) return false;
                }
                return true;
            });

            // Update count badge
            const countBadge = document.getElementById('structureCount');
            if (countBadge) countBadge.textContent = filteredStructureData.length;

            renderStructure();
        }

        function clearStructureSearch() {
            document.getElementById('structureSearchInput').value = '';
            filterStructure();
        }

        function openAddStructureModal() {
            document.getElementById('structureId').value = '';
            document.getElementById('structureManagerSearch').value = '';
            document.getElementById('structureManagerId').value = '';
            document.getElementById('structureModalTitle').textContent = 'Add Structure Entry';
            populateStructureDropdowns();
            new bootstrap.Modal(document.getElementById('structureModal')).show();
        }

        function populateStructureDropdowns(selected = {}) {
            // Companies - match by company_id or by name
            const companySelect = document.getElementById('structureCompany');
            companySelect.innerHTML = '<option value="">Select Company</option>' +
                hrCompaniesData.map(c => {
                    const isSelected = c.id == selected.company_id || (selected.company && c.company === selected.company);
                    return `<option value="${c.id}" ${isSelected ? 'selected' : ''}>${c.company}</option>`;
                }).join('');

            // Brands - match by brand_id or by name
            const brandSelect = document.getElementById('structureBrand');
            brandSelect.innerHTML = '<option value="">Select Brand (optional)</option>' +
                masterBrandsData.map(b => {
                    const isSelected = b.id == selected.brand_id || (selected.brand && b.name === selected.brand);
                    return `<option value="${b.id}" ${isSelected ? 'selected' : ''}>${b.name}</option>`;
                }).join('');

            // Departments - match by department_id or by name
            const deptSelect = document.getElementById('structureDept');
            deptSelect.innerHTML = '<option value="">Select Department</option>' +
                masterDeptsData.map(d => {
                    const isSelected = d.id == selected.department_id || (selected.department && d.name === selected.department);
                    return `<option value="${d.id}" ${isSelected ? 'selected' : ''}>${d.name}</option>`;
                }).join('');

            // Subdepartments - match by subdepartment_id or by name
            const subdeptSelect = document.getElementById('structureSubdept');
            subdeptSelect.innerHTML = '<option value="">Select Subdepartment (optional)</option>' +
                masterSubdeptsData.map(s => {
                    const isSelected = s.id == selected.subdepartment_id || (selected.subdepartment && s.name === selected.subdepartment);
                    return `<option value="${s.id}" ${isSelected ? 'selected' : ''}>${s.name}</option>`;
                }).join('');
        }

        // ============== Manager Employee Search ==============
        // Use event delegation - get elements fresh each time to avoid stale references
        document.addEventListener('input', function(e) {
            if (e.target.id !== 'structureManagerSearch') return;

            const dropdown = document.getElementById('structureManagerDropdown');
            if (!dropdown) return;

            const query = e.target.value.toLowerCase().trim();
            if (query.length < 1) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
                return;
            }

            const filtered = users.filter(user =>
                user.name && user.name.toLowerCase().includes(query)
            ).slice(0, 10);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="dropdown-item text-muted">No users found</div>';
            } else {
                dropdown.innerHTML = filtered.map(user => `
                    <a class="dropdown-item manager-item" href="#" data-emp-id="${user.id}" data-emp-name="${user.name}">
                        <i class="bi bi-person-badge"></i> ${user.name}
                        ${user.email ? `<small class="text-muted ms-1">(${user.email})</small>` : ''}
                    </a>
                `).join('');
            }
            dropdown.style.display = 'block';
            dropdown.classList.add('show');
        });

        // Handle dropdown item click
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('structureManagerDropdown');
            const searchInput = document.getElementById('structureManagerSearch');

            // Handle selection
            const item = e.target.closest('.manager-item');
            if (item && dropdown?.contains(item)) {
                e.preventDefault();
                const hiddenInput = document.getElementById('structureManagerId');
                if (searchInput) searchInput.value = item.dataset.empName;
                if (hiddenInput) hiddenInput.value = item.dataset.empId;
                if (dropdown) {
                    dropdown.style.display = 'none';
                    dropdown.classList.remove('show');
                }
                return;
            }

            // Hide dropdown when clicking outside
            if (dropdown && searchInput && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                dropdown.classList.remove('show');
            }
        });

        function editStructure(id) {
            const entry = structureData.find(s => s.id === id);
            if (!entry) return;

            document.getElementById('structureId').value = id;
            document.getElementById('structureManagerSearch').value = entry.manager || '';
            // Set manager_id from manager_ids array (take first element)
            const managerId = (entry.manager_ids && entry.manager_ids.length > 0) ? entry.manager_ids[0] : '';
            document.getElementById('structureManagerId').value = managerId;
            document.getElementById('structureModalTitle').textContent = 'Edit Structure Entry';
            populateStructureDropdowns(entry);
            new bootstrap.Modal(document.getElementById('structureModal')).show();
        }

        async function saveStructure() {
            const id = document.getElementById('structureId').value;
            const company_id = document.getElementById('structureCompany').value;
            const brand_id = document.getElementById('structureBrand').value || null;
            const department_id = document.getElementById('structureDept').value;
            const subdepartment_id = document.getElementById('structureSubdept').value || null;
            const manager = document.getElementById('structureManagerSearch').value.trim();
            const managerId = document.getElementById('structureManagerId').value;

            if (!company_id || !department_id) {
                await JarvisDialog.alert('Company and Department are required', { type: 'warning' });
                return;
            }

            // Build manager_ids array from selected user
            const manager_ids = managerId ? [parseInt(managerId)] : null;

            const url = id ? `/hr/events/api/structure/departments/${id}` : '/hr/events/api/structure/departments';
            const method = id ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method, headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ company_id, brand_id, department_id, subdepartment_id, manager, manager_ids })
                });
                if (resp.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('structureModal')).hide();
                    loadStructure();
                } else {
                    await JarvisDialog.alert('Error saving structure entry', { type: 'error' });
                }
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error saving structure entry', { type: 'error' });
            }
        }

        async function deleteStructure(id) {
            const confirmed = await JarvisDialog.confirm('Delete this structure entry?', { danger: true });
            if (!confirmed) return;
            try {
                const resp = await fetch(`/hr/events/api/structure/departments/${id}`, { method: 'DELETE' });
                if (resp.ok) loadStructure();
                else await JarvisDialog.alert('Error deleting structure entry', { type: 'error' });
            } catch (err) {
                console.error('Error:', err);
                await JarvisDialog.alert('Error deleting structure entry', { type: 'error' });
            }
        }

        async function bulkDeleteStructure() {
            const ids = Array.from(selectedStructure);
            if (ids.length === 0) return;

            const confirmed = await JarvisDialog.confirm(
                `Delete ${ids.length} structure ${ids.length === 1 ? 'entry' : 'entries'}? This cannot be undone.`,
                { danger: true, confirmText: 'Delete All' }
            );
            if (!confirmed) return;

            let successCount = 0;
            let errorCount = 0;

            for (const id of ids) {
                try {
                    const resp = await fetch(`/hr/events/api/structure/departments/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        successCount++;
                        selectedStructure.delete(id);
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    console.error('Error deleting structure:', err);
                    errorCount++;
                }
            }

            loadStructure();

            if (errorCount > 0) {
                await JarvisDialog.alert(`Deleted ${successCount} entries. ${errorCount} failed.`, { type: 'warning' });
            } else {
                JarvisToast.success(`Deleted ${successCount} structure entries`);
            }
        }
    </script>

    <script src="/static/js/online-users.js"></script>
    {% include 'partials/_edit_profile_modal.html' %}
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/jarvis-dialogs.js"></script>
</body>
</html>
