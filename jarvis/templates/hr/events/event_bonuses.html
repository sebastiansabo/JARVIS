<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. - HR Events</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='img/jarvis-icon.svg') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading...</div>
    </div>

    {% set current_module = 'hr' %}
    {% include 'partials/_navbar.html' %}

    <!-- Breadcrumb -->
    <div class="container-fluid px-4 py-2 bg-body-secondary border-bottom">
        <div class="d-flex justify-content-between align-items-center">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 small">
                    <li class="breadcrumb-item"><a href="/">Home</a></li>
                    <li class="breadcrumb-item"><a href="/hr">HR</a></li>
                    <li class="breadcrumb-item active">Events</li>
                </ol>
            </nav>
            <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="container-fluid px-4 mt-3">
        <!-- Nav + Summary Stats (same line) -->
        <div class="d-flex justify-content-between align-items-end flex-wrap gap-2 mb-2">
            {% set active_page = 'bonuses' %}
            {% set inline_nav = true %}
            {% include 'partials/_hr_nav.html' %}

            <div class="summary-filter-bar d-flex align-items-center flex-wrap gap-3">
                <span class="summary-stat" title="Total Bonuses">
                    <i class="bi bi-gift text-primary"></i>
                    <strong>{{ summary.total_bonuses or 0 }}</strong> bonuses
                </span>
                <span class="summary-stat" title="Employees">
                    <i class="bi bi-people text-info"></i>
                    <strong>{{ summary.total_employees or 0 }}</strong> employees
                </span>
                <span class="summary-stat" title="Events">
                    <i class="bi bi-calendar-event text-warning"></i>
                    <strong>{{ summary.total_events or 0 }}</strong> events
                </span>
                {% if is_hr_manager %}
                <span class="summary-stat text-success" title="Total Amount (Net)">
                    <i class="bi bi-cash-stack"></i>
                    <strong>{{ '{:,.0f}'.format(summary.total_bonus_amount or 0) }}</strong> RON
                </span>
                {% endif %}
                <span class="summary-stat" title="Total Hours">
                    <i class="bi bi-clock text-secondary"></i>
                    <strong>{{ summary.total_hours or 0 }}</strong> hours
                </span>
                <span class="summary-stat" title="Total Days">
                    <i class="bi bi-calendar-check text-secondary"></i>
                    <strong>{{ '{:.1f}'.format(summary.total_days or 0) }}</strong> days
                </span>
            </div>
        </div>

        <style>
            .summary-filter-bar { font-size: 0.85rem; }
            .summary-stat { display: flex; align-items: center; gap: 4px; color: var(--bs-secondary-color); }
            .summary-stat i { font-size: 1rem; }
            .summary-stat strong { color: var(--bs-body-color); }
        </style>

        <!-- Tabs with Action Buttons -->
        <div class="d-flex justify-content-between align-items-center">
            <ul class="nav nav-tabs mb-0" id="bonusesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="bonuses-tab" data-bs-toggle="tab" data-bs-target="#bonuses-pane" type="button" role="tab">
                        <i class="bi bi-list-ul"></i> Bonuses List
                    </button>
                </li>
                {% if is_hr_manager %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="by-employee-tab" data-bs-toggle="tab" data-bs-target="#by-employee-pane" type="button" role="tab">
                        <i class="bi bi-people"></i> By Employee
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="by-event-tab" data-bs-toggle="tab" data-bs-target="#by-event-pane" type="button" role="tab">
                        <i class="bi bi-calendar-event"></i> By Event
                    </button>
                </li>
                {% endif %}
            </ul>
            <div class="d-flex gap-2">
                <a href="{{ url_for('hr.events.add_event') }}" class="btn btn-hr btn-sm">
                    <i class="bi bi-calendar-plus"></i> Add Event
                </a>
                <a href="{{ url_for('hr.events.add_bonus') }}" class="btn btn-outline-info btn-sm">
                    <i class="bi bi-plus-lg"></i> Add Bonus
                </a>
                {% if is_hr_manager %}
                <button id="btnExport" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-download"></i> Export
                </button>
                {% endif %}
            </div>
        </div>

        <div class="tab-content">
            <!-- Bonuses List Tab -->
            <div class="tab-pane fade show active" id="bonuses-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-gift"></i> Bonuses <span id="bonusResultCount" class="badge bg-secondary ms-2">{{ bonuses|length }}</span></span>
                        <div class="d-flex gap-2 align-items-center">
                            <!-- Search -->
                            <div class="input-group input-group-sm" style="width: 220px;">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search employee, event..." oninput="updateSearchIcon(); filterBonuses();">
                                <button class="btn btn-outline-secondary" type="button" id="searchBtn" onclick="handleSearchClick()" title="Search">
                                    <i class="bi bi-search" id="searchIcon"></i>
                                </button>
                            </div>
                            <select id="filterYear" class="form-select form-select-sm" style="width: auto;">
                                <option value="">All Years</option>
                                {% for year in years %}
                                <option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <select id="filterMonth" class="form-select form-select-sm" style="width: auto;">
                                <option value="">All Months</option>
                                {% for num, name in months.items() %}
                                <option value="{{ num }}" {% if selected_month == num %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                            <button id="btnApplyFilter" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-funnel"></i> Filter
                            </button>
                            <button id="btnClearFilter" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-x"></i> Clear
                            </button>
                            <!-- Column Config -->
                            <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#columnConfigModal">
                                <i class="bi bi-gear"></i> Columns
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0" id="bonusesTableMain">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="year" data-order="desc">Year <i class="bi bi-arrow-down sort-icon"></i></th>
                                    <th class="sortable" data-sort="month">Month <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="employee">Employee <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="dept">Dept <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="company">Company <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="event">Event <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th>Participation</th>
                                    <th class="sortable" data-sort="days">Days <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="hours">Hours <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    {% if is_hr_manager %}
                                    <th class="sortable" data-sort="bonus">Bonus (Net) <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    {% endif %}
                                    <th>Details</th>
                                    <th class="sortable" data-sort="created">Created <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                    <tbody id="bonusesTable">
                        {% for bonus in bonuses %}
                        <tr class="bonus-row" data-id="{{ bonus.id }}"
                            data-year="{{ bonus.year }}"
                            data-month="{{ bonus.month }}"
                            data-employee="{{ bonus.employee_name|lower }}"
                            data-dept="{{ (bonus.department or '')|lower }}"
                            data-company="{{ (bonus.company or '')|lower }}"
                            data-event="{{ bonus.event_name|lower }}"
                            data-days="{{ bonus.bonus_days or 0 }}"
                            data-hours="{{ bonus.hours_free or 0 }}"
                            data-bonus="{{ bonus.bonus_net or 0 }}"
                            data-created="{{ bonus.created_at or '' }}">
                            <td><strong>{{ bonus.year }}</strong></td>
                            <td><span class="month-badge">{{ months.get(bonus.month, bonus.month) }}</span></td>
                            <td><strong>{{ bonus.employee_name }}</strong></td>
                            <td>{{ bonus.department or '-' }}</td>
                            <td>{{ bonus.company or '-' }}</td>
                            <td>{{ bonus.event_name }}</td>
                            <td>
                                {% if bonus.participation_start %}
                                {{ bonus.participation_start }} - {{ bonus.participation_end }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ bonus.bonus_days or 0 }}</td>
                            <td>{{ bonus.hours_free or 0 }}</td>
                            {% if is_hr_manager %}
                            <td><strong>{{ '{:,.0f}'.format(bonus.bonus_net or 0) }}</strong> RON</td>
                            {% endif %}
                            <td>{{ bonus.details or '-' }}</td>
                            <td class="text-muted small timestamp-cell">{{ bonus.created_at[:16].replace('T', ' ') if bonus.created_at else '-' }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary btn-edit" data-id="{{ bonus.id }}" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="{{ bonus.id }}" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ 13 if is_hr_manager else 12 }}" class="text-center text-muted py-4">
                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                No event bonuses found. Click "Add Bonus" to create one.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if is_hr_manager %}
            <!-- By Employee Tab -->
            <div class="tab-pane fade" id="by-employee-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <span><i class="bi bi-people"></i> By Employee</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="employeeSummaryTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="name">Employee <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="dept">Department <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="brand">Brand <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="company">Company <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="count" style="text-align: right;"># Events <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="days" style="text-align: right;">Total Days <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="hours" style="text-align: right;">Total Hours <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable" data-sort="bonus" data-order="desc" style="text-align: right;">Total Bonus <i class="bi bi-arrow-down sort-icon"></i></th>
                                </tr>
                            </thead>
                            <tbody id="employeeSummaryBody">
                                {% for emp in employee_summary %}
                                <tr data-name="{{ emp.name|lower }}"
                                    data-dept="{{ (emp.department or '')|lower }}"
                                    data-brand="{{ (emp.brand or '')|lower }}"
                                    data-company="{{ (emp.company or '')|lower }}"
                                    data-count="{{ emp.bonus_count }}"
                                    data-days="{{ emp.total_days or 0 }}"
                                    data-hours="{{ emp.total_hours or 0 }}"
                                    data-bonus="{{ emp.total_bonus or 0 }}">
                                    <td><strong>{{ emp.name }}</strong></td>
                                    <td>{{ emp.department or '-' }}</td>
                                    <td>{{ emp.brand or '-' }}</td>
                                    <td>{{ emp.company or '-' }}</td>
                                    <td style="text-align: right;">{{ emp.bonus_count }}</td>
                                    <td style="text-align: right;">{{ emp.total_days or 0 }}</td>
                                    <td style="text-align: right;">{{ emp.total_hours or 0 }}</td>
                                    <td style="text-align: right;"><strong>{{ '{:,.0f}'.format(emp.total_bonus or 0) }}</strong> RON</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        No employee data found.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="4">Total ({{ employee_summary|length }} employees)</th>
                                    <th style="text-align: right;">{{ employee_summary|sum(attribute='bonus_count') }}</th>
                                    <th style="text-align: right;">{{ employee_summary|sum(attribute='total_days') }}</th>
                                    <th style="text-align: right;">{{ employee_summary|sum(attribute='total_hours') }}</th>
                                    <th style="text-align: right;"><strong>{{ '{:,.0f}'.format(employee_summary|sum(attribute='total_bonus')) }}</strong> RON</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- By Event Tab -->
            <div class="tab-pane fade" id="by-event-pane" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <span><i class="bi bi-calendar-event"></i> By Event</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="eventSummaryTable">
                            <thead>
                                <tr>
                                    <th class="sortable-event" data-sort="year" data-order="desc">Year <i class="bi bi-arrow-down sort-icon"></i></th>
                                    <th class="sortable-event" data-sort="month">Month <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="name">Event <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th>Date Range</th>
                                    <th class="sortable-event" data-sort="company">Company <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="brand">Brand <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="employees" style="text-align: right;"># Employees <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="days" style="text-align: right;">Total Days <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="hours" style="text-align: right;">Total Hours <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                    <th class="sortable-event" data-sort="bonus" style="text-align: right;">Total Bonus <i class="bi bi-arrow-down-up sort-icon text-muted"></i></th>
                                </tr>
                            </thead>
                            <tbody id="eventSummaryBody">
                                {% for evt in event_summary %}
                                <tr data-name="{{ evt.name|lower }}"
                                    data-year="{{ evt.year }}"
                                    data-month="{{ evt.month }}"
                                    data-company="{{ (evt.company or '')|lower }}"
                                    data-brand="{{ (evt.brand or '')|lower }}"
                                    data-employees="{{ evt.employee_count }}"
                                    data-days="{{ evt.total_days or 0 }}"
                                    data-hours="{{ evt.total_hours or 0 }}"
                                    data-bonus="{{ evt.total_bonus or 0 }}">
                                    <td><strong>{{ evt.year }}</strong></td>
                                    <td><span class="month-badge">{{ months.get(evt.month, evt.month) }}</span></td>
                                    <td><strong>{{ evt.name }}</strong></td>
                                    <td>{{ evt.start_date }} - {{ evt.end_date }}</td>
                                    <td>{{ evt.company or '-' }}</td>
                                    <td>{{ evt.brand or '-' }}</td>
                                    <td style="text-align: right;">{{ evt.employee_count }}</td>
                                    <td style="text-align: right;">{{ evt.total_days or 0 }}</td>
                                    <td style="text-align: right;">{{ evt.total_hours or 0 }}</td>
                                    <td style="text-align: right;"><strong>{{ '{:,.0f}'.format(evt.total_bonus or 0) }}</strong> RON</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                        No event data found.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="6">Total ({{ event_summary|length }} rows)</th>
                                    <th style="text-align: right;">{{ event_summary|sum(attribute='employee_count') }}</th>
                                    <th style="text-align: right;">{{ event_summary|sum(attribute='total_days') }}</th>
                                    <th style="text-align: right;">{{ event_summary|sum(attribute='total_hours') }}</th>
                                    <th style="text-align: right;"><strong>{{ '{:,.0f}'.format(event_summary|sum(attribute='total_bonus')) }}</strong> RON</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Add Event with Employees Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-plus"></i> Add Event with Employees</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Event Details -->
                    <div class="row g-3 mb-4 pb-3 border-bottom">
                        <div class="col-12">
                            <h6 class="text-info mb-3"><i class="bi bi-calendar-event"></i> Event Details</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Event Name *</label>
                            <input type="text" id="newEventName" class="form-control" required placeholder="e.g., Toyota Family Day">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Start Date *</label>
                            <input type="date" id="newEventStart" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">End Date *</label>
                            <input type="date" id="newEventEnd" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year *</label>
                            <input type="number" id="newEventYear" class="form-control" value="2025" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Month *</label>
                            <select id="newEventMonth" class="form-select" required>
                                {% for num, name in months.items() %}
                                <option value="{{ num }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Default Values -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <h6 class="text-info mb-3"><i class="bi bi-people"></i> Employees</h6>
                        </div>
                        {% if is_hr_manager %}
                        <div class="col-md-2">
                            <label class="form-label">Default Bonus</label>
                            <input type="number" id="newEventDefaultBonus" class="form-control" value="150">
                        </div>
                        {% endif %}
                        <div class="col-md-2">
                            <label class="form-label">Default Hours</label>
                            <input type="number" id="newEventDefaultHours" class="form-control" value="6">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Default Days</label>
                            <input type="number" id="newEventDefaultDays" class="form-control" step="0.5" value="1">
                        </div>
                        <div class="col-md-6 d-flex align-items-end gap-2">
                            <button type="button" id="btnAddEventEmployee" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-plus"></i> Add Employee
                            </button>
                            <button type="button" id="btnApplyEventDefaults" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-clipboard"></i> Apply Defaults
                            </button>
                        </div>
                    </div>

                    <!-- Employees Table -->
                    <div class="table-responsive" style="max-height: 350px;">
                        <table class="table table-sm mb-0">
                            <thead class="sticky-top" style="background: var(--bg-table-header);">
                                <tr>
                                    <th style="width: 250px;">Employee</th>
                                    <th>Part. Start</th>
                                    <th>Part. End</th>
                                    <th style="width: 80px;">Days</th>
                                    <th style="width: 80px;">Hours</th>
                                    {% if is_hr_manager %}<th style="width: 100px;">Bonus</th>{% endif %}
                                    <th>Details</th>
                                    <th style="width: 40px;"></th>
                                </tr>
                            </thead>
                            <tbody id="newEventEmployeesTable">
                                <!-- Rows added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="newEventRowCount" class="me-auto text-muted">0 employees</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="btnSaveNewEvent" class="btn btn-hr">
                        <i class="bi bi-save"></i> Save Event & Bonuses
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Bonus Modal -->
    <div class="modal fade" id="bonusModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gift"></i> <span id="bonusModalTitle">Add Event Bonus</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bonusForm">
                        <input type="hidden" id="bonusId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Employee *</label>
                                <select id="bonusEmployee" class="form-select" required>
                                    <option value="">Select Employee</option>
                                    {% for emp in employees %}
                                    <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.company or 'N/A' }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Event *</label>
                                <select id="bonusEvent" class="form-select" required>
                                    <option value="">Select Event</option>
                                    {% for event in events %}
                                    <option value="{{ event.id }}">{{ event.name }} ({{ event.start_date }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Year *</label>
                                <input type="number" id="bonusYear" class="form-control" min="2020" max="2030" value="2025" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Month *</label>
                                <select id="bonusMonth" class="form-select" required>
                                    {% for num, name in months.items() %}
                                    <option value="{{ num }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Participation Start</label>
                                <input type="date" id="bonusPartStart" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Participation End</label>
                                <input type="date" id="bonusPartEnd" class="form-control">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Bonus Days</label>
                                <input type="number" id="bonusDays" class="form-control" step="0.5" min="0" max="10">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Hours Free</label>
                                <input type="number" id="bonusHours" class="form-control" min="0" max="100">
                            </div>
                            {% if is_hr_manager %}
                            <div class="col-md-3">
                                <label class="form-label">Bonus (Net)</label>
                                <input type="number" id="bonusNet" class="form-control" step="0.01" min="0">
                            </div>
                            {% else %}
                            <input type="hidden" id="bonusNet" value="">
                            {% endif %}
                            <div class="col-md-3">
                                <label class="form-label">Allocation Month</label>
                                <input type="text" id="bonusAllocation" class="form-control" placeholder="e.g., Feb 2026">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Details</label>
                                <input type="text" id="bonusDetails" class="form-control" placeholder="Optional notes">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="btnSaveBonus" class="btn btn-hr">Save Bonus</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Entry Modal -->
    <div class="modal fade" id="bulkModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-list-task"></i> Bulk Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Event *</label>
                            <select id="bulkEvent" class="form-select" required>
                                <option value="">Select Event</option>
                                {% for event in events %}
                                <option value="{{ event.id }}" data-start="{{ event.start_date }}" data-end="{{ event.end_date }}">
                                    {{ event.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year *</label>
                            <input type="number" id="bulkYear" class="form-control" value="2025" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Month *</label>
                            <select id="bulkMonth" class="form-select" required>
                                {% for num, name in months.items() %}
                                <option value="{{ num }}">{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% if is_hr_manager %}
                        <div class="col-md-2">
                            <label class="form-label">Default Bonus</label>
                            <input type="number" id="bulkDefaultBonus" class="form-control" value="150">
                        </div>
                        {% endif %}
                        <div class="col-md-2">
                            <label class="form-label">Default Hours</label>
                            <input type="number" id="bulkDefaultHours" class="form-control" value="6">
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" id="btnAddBulkRow" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-plus"></i> Add Row
                        </button>
                        <button type="button" id="btnApplyDefaults" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-clipboard"></i> Apply Defaults to All
                        </button>
                    </div>

                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm mb-0">
                            <thead class="sticky-top" style="background: var(--bg-table-header);">
                                <tr>
                                    <th>Employee</th>
                                    <th>Part. Start</th>
                                    <th>Part. End</th>
                                    <th>Days</th>
                                    <th>Hours</th>
                                    {% if is_hr_manager %}<th>Bonus</th>{% endif %}
                                    <th>Details</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="bulkTableBody">
                                <!-- Rows added dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="bulkRowCount" class="me-auto text-muted">0 rows</span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="btnSaveBulk" class="btn btn-hr">Save All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Configuration Modal -->
    <div class="modal fade" id="columnConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Configure Columns</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Toggle columns visibility. Drag to reorder.</p>
                    <div id="columnConfigList" class="border rounded">
                        <!-- Column items will be rendered here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-warning" onclick="resetColumns()">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset to Default
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Month names for display
        const MONTHS = {{ months|tojson }};

        // HR Manager permission flag for conditional bonus display
        const isHrManager = {{ 'true' if is_hr_manager else 'false' }};

        // Total bonuses count for badge
        const totalBonusesCount = {{ bonuses|length }};

        // Column configuration
        const COLUMN_CONFIG_VERSION = 1;
        const DEFAULT_COLUMNS = [
            { id: 'year', name: 'Year', visible: true },
            { id: 'month', name: 'Month', visible: true },
            { id: 'employee', name: 'Employee', visible: true },
            { id: 'dept', name: 'Dept', visible: true },
            { id: 'company', name: 'Company', visible: true },
            { id: 'event', name: 'Event', visible: true },
            { id: 'participation', name: 'Participation', visible: true },
            { id: 'days', name: 'Days', visible: true },
            { id: 'hours', name: 'Hours', visible: true },
            { id: 'bonus', name: 'Bonus (Net)', visible: isHrManager },
            { id: 'details', name: 'Details', visible: true },
            { id: 'created', name: 'Created', visible: false },
            { id: 'actions', name: 'Actions', visible: true, fixed: true }
        ];
        let columnConfig = [];

        function loadColumnConfig() {
            const savedVersion = localStorage.getItem('hrBonusesColumnConfigVersion');
            const saved = localStorage.getItem('hrBonusesColumnConfig');

            if (saved && savedVersion === COLUMN_CONFIG_VERSION.toString()) {
                try {
                    columnConfig = JSON.parse(saved);
                    // Ensure the bonus column respects permissions
                    const bonusCol = columnConfig.find(c => c.id === 'bonus');
                    if (bonusCol && !isHrManager) {
                        bonusCol.visible = false;
                    }
                } catch (e) {
                    columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
                }
            } else {
                columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
                localStorage.setItem('hrBonusesColumnConfigVersion', COLUMN_CONFIG_VERSION.toString());
            }
        }

        function saveColumnConfig() {
            localStorage.setItem('hrBonusesColumnConfig', JSON.stringify(columnConfig));
            localStorage.setItem('hrBonusesColumnConfigVersion', COLUMN_CONFIG_VERSION.toString());
        }

        function toggleColumn(idx, checked) {
            // Don't allow hiding bonus column if not HR manager
            if (columnConfig[idx].id === 'bonus' && !isHrManager) {
                columnConfig[idx].visible = false;
                return;
            }
            columnConfig[idx].visible = checked;
            saveColumnConfig();
        }

        function renderColumnConfigList() {
            const container = document.getElementById('columnConfigList');
            container.innerHTML = columnConfig.map((col, idx) => {
                const disabled = col.fixed || (col.id === 'bonus' && !isHrManager);
                return `
                <div class="d-flex align-items-center p-2 border-bottom column-item ${disabled ? 'bg-light' : ''}" draggable="${!col.fixed}" data-idx="${idx}">
                    <i class="bi bi-grip-vertical text-muted me-2" style="cursor: ${col.fixed ? 'default' : 'grab'};"></i>
                    <div class="form-check flex-grow-1 mb-0">
                        <input class="form-check-input" type="checkbox" id="col-${col.id}"
                               ${col.visible ? 'checked' : ''}
                               ${disabled ? 'disabled' : ''}
                               onchange="toggleColumn(${idx}, this.checked)">
                        <label class="form-check-label ${disabled ? 'text-muted' : ''}" for="col-${col.id}">
                            ${col.name} ${col.fixed ? '<small class="text-muted">(fixed)</small>' : ''}
                            ${col.id === 'bonus' && !isHrManager ? '<small class="text-muted">(HR only)</small>' : ''}
                        </label>
                    </div>
                </div>
            `}).join('');

            setupColumnDragDrop();
        }

        function setupColumnDragDrop() {
            const items = document.querySelectorAll('#columnConfigList .column-item[draggable="true"]');
            let draggedItem = null;

            items.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    e.dataTransfer.effectAllowed = 'move';
                    this.style.opacity = '0.5';
                });

                item.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                    const newOrder = [];
                    document.querySelectorAll('#columnConfigList .column-item').forEach(el => {
                        newOrder.push(columnConfig[parseInt(el.dataset.idx)]);
                    });
                    columnConfig = newOrder;
                    saveColumnConfig();
                    renderColumnConfigList();
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const rect = this.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    if (e.clientY < midY) {
                        this.parentNode.insertBefore(draggedItem, this);
                    } else {
                        this.parentNode.insertBefore(draggedItem, this.nextSibling);
                    }
                });
            });
        }

        function resetColumns() {
            columnConfig = JSON.parse(JSON.stringify(DEFAULT_COLUMNS));
            saveColumnConfig();
            renderColumnConfigList();
            applyColumnConfig();
        }

        function applyColumnConfig() {
            const table = document.getElementById('bonusesTableMain');
            if (!table) return;

            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            if (!thead || !tbody) return;

            // Get all header cells
            const headerCells = thead.querySelectorAll('th');
            const rows = tbody.querySelectorAll('tr');

            // Map column IDs to indices
            const columnIds = ['year', 'month', 'employee', 'dept', 'company', 'event', 'participation', 'days', 'hours', 'bonus', 'details', 'created', 'actions'];

            columnIds.forEach((colId, colIdx) => {
                const config = columnConfig.find(c => c.id === colId);
                const visible = config ? config.visible : true;

                // Hide/show header cell
                if (headerCells[colIdx]) {
                    headerCells[colIdx].style.display = visible ? '' : 'none';
                }

                // Hide/show body cells
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells[colIdx]) {
                        cells[colIdx].style.display = visible ? '' : 'none';
                    }
                });
            });
        }

        // Initialize column config on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadColumnConfig();

            // Setup modal handler
            document.getElementById('columnConfigModal').addEventListener('shown.bs.modal', renderColumnConfigList);
            document.getElementById('columnConfigModal').addEventListener('hidden.bs.modal', applyColumnConfig);

            // Apply column config on load
            applyColumnConfig();
        });

        // Search functions
        function updateSearchIcon() {
            const input = document.getElementById('searchInput');
            const icon = document.getElementById('searchIcon');
            const btn = document.getElementById('searchBtn');
            if (input.value.trim()) {
                icon.className = 'bi bi-x-lg';
                btn.title = 'Clear';
            } else {
                icon.className = 'bi bi-search';
                btn.title = 'Search';
            }
        }

        function handleSearchClick() {
            const input = document.getElementById('searchInput');
            if (input.value.trim()) {
                input.value = '';
                updateSearchIcon();
                filterBonuses();
            } else {
                input.focus();
            }
        }

        function filterBonuses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#bonusesTable .bonus-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const employee = row.dataset.employee || '';
                const event = row.dataset.event || '';
                const dept = row.dataset.dept || '';
                const company = row.dataset.company || '';

                const matchesSearch = !searchTerm ||
                    employee.includes(searchTerm) ||
                    event.includes(searchTerm) ||
                    dept.includes(searchTerm) ||
                    company.includes(searchTerm);

                if (matchesSearch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update result count badge
            const countBadge = document.getElementById('bonusResultCount');
            if (searchTerm) {
                countBadge.textContent = `${visibleCount} / ${totalBonusesCount}`;
            } else {
                countBadge.textContent = totalBonusesCount;
            }
        }

        // Filter handlers
        document.getElementById('btnApplyFilter').addEventListener('click', () => {
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            let url = '{{ url_for("hr.events.event_bonuses") }}';
            const params = new URLSearchParams();
            if (year) params.set('year', year);
            if (month) params.set('month', month);
            if (params.toString()) url += '?' + params.toString();
            window.location.href = url;
        });

        document.getElementById('btnClearFilter').addEventListener('click', () => {
            window.location.href = '{{ url_for("hr.events.event_bonuses") }}';
        });

        // Single Bonus Modal
        const bonusModal = new bootstrap.Modal(document.getElementById('bonusModal'));
        let editingBonusId = null;


        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', async () => {
                editingBonusId = btn.dataset.id;
                document.getElementById('bonusModalTitle').textContent = 'Edit Event Bonus';

                const resp = await fetch(`/hr/events/api/event-bonuses/${editingBonusId}`);
                const bonus = await resp.json();

                document.getElementById('bonusEmployee').value = bonus.employee_id;
                document.getElementById('bonusEvent').value = bonus.event_id;
                document.getElementById('bonusYear').value = bonus.year;
                document.getElementById('bonusMonth').value = bonus.month;
                document.getElementById('bonusPartStart').value = bonus.participation_start || '';
                document.getElementById('bonusPartEnd').value = bonus.participation_end || '';
                document.getElementById('bonusDays').value = bonus.bonus_days || '';
                document.getElementById('bonusHours').value = bonus.hours_free || '';
                document.getElementById('bonusNet').value = bonus.bonus_net || '';
                document.getElementById('bonusAllocation').value = bonus.allocation_month || '';
                document.getElementById('bonusDetails').value = bonus.details || '';

                bonusModal.show();
            });
        });

        document.getElementById('btnSaveBonus').addEventListener('click', async () => {
            const data = {
                employee_id: parseInt(document.getElementById('bonusEmployee').value),
                event_id: parseInt(document.getElementById('bonusEvent').value),
                year: parseInt(document.getElementById('bonusYear').value),
                month: parseInt(document.getElementById('bonusMonth').value),
                participation_start: document.getElementById('bonusPartStart').value || null,
                participation_end: document.getElementById('bonusPartEnd').value || null,
                bonus_days: parseFloat(document.getElementById('bonusDays').value) || null,
                hours_free: parseInt(document.getElementById('bonusHours').value) || null,
                bonus_net: parseFloat(document.getElementById('bonusNet').value) || null,
                allocation_month: document.getElementById('bonusAllocation').value || null,
                details: document.getElementById('bonusDetails').value || null
            };

            if (!data.employee_id || !data.event_id || !data.year || !data.month) {
                await JarvisDialog.alert('Please fill in all required fields', { type: 'warning' });
                return;
            }

            const url = editingBonusId
                ? `/hr/events/api/event-bonuses/${editingBonusId}`
                : '/hr/events/api/event-bonuses';
            const method = editingBonusId ? 'PUT' : 'POST';

            const resp = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (resp.ok) {
                bonusModal.hide();
                window.location.reload();
            } else {
                await JarvisDialog.alert('Error saving bonus', { type: 'error' });
            }
        });

        // Delete handler
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', async () => {
                const confirmed = await JarvisDialog.confirm('Delete this bonus record?', { danger: true });
                if (!confirmed) return;

                const id = btn.dataset.id;
                const resp = await fetch(`/hr/events/api/event-bonuses/${id}`, {
                    method: 'DELETE'
                });

                if (resp.ok) {
                    window.location.reload();
                } else {
                    await JarvisDialog.alert('Error deleting bonus', { type: 'error' });
                }
            });
        });

        // Bulk Entry
        const bulkEmployees = {{ employees|tojson }};
        let bulkRowId = 0;

        function addBulkRow(employeeId = '', partStart = '', partEnd = '', days = '', hours = '', bonus = '', details = '') {
            const tbody = document.getElementById('bulkTableBody');
            const row = document.createElement('tr');
            row.dataset.rowId = bulkRowId++;

            const defaultHours = document.getElementById('bulkDefaultHours').value;
            const defaultBonusEl = document.getElementById('bulkDefaultBonus');
            const defaultBonus = defaultBonusEl ? defaultBonusEl.value : '';

            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm bulk-employee" required>
                        <option value="">Select...</option>
                        ${bulkEmployees.map(e => `<option value="${e.id}" ${e.id == employeeId ? 'selected' : ''}>${e.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="date" class="form-control form-control-sm bulk-part-start" value="${partStart}"></td>
                <td><input type="date" class="form-control form-control-sm bulk-part-end" value="${partEnd}"></td>
                <td><input type="number" class="form-control form-control-sm bulk-days" step="0.5" value="${days || 1}"></td>
                <td><input type="number" class="form-control form-control-sm bulk-hours" value="${hours || defaultHours}"></td>
                ${isHrManager ? `<td><input type="number" class="form-control form-control-sm bulk-bonus" value="${bonus || defaultBonus}"></td>` : ''}
                <td><input type="text" class="form-control form-control-sm bulk-details" value="${details}"></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-row"><i class="bi bi-x"></i></button></td>
            `;

            row.querySelector('.btn-remove-row').addEventListener('click', () => {
                row.remove();
                updateBulkRowCount();
            });

            tbody.appendChild(row);
            updateBulkRowCount();
        }

        function updateBulkRowCount() {
            const count = document.querySelectorAll('#bulkTableBody tr').length;
            document.getElementById('bulkRowCount').textContent = `${count} rows`;
        }

        document.getElementById('btnAddBulkRow').addEventListener('click', () => addBulkRow());

        document.getElementById('btnApplyDefaults').addEventListener('click', () => {
            const hours = document.getElementById('bulkDefaultHours').value;
            document.querySelectorAll('.bulk-hours').forEach(el => el.value = hours);

            if (isHrManager) {
                const bonus = document.getElementById('bulkDefaultBonus').value;
                document.querySelectorAll('.bulk-bonus').forEach(el => el.value = bonus);
            }
        });

        document.getElementById('btnSaveBulk').addEventListener('click', async () => {
            const eventId = document.getElementById('bulkEvent').value;
            const year = document.getElementById('bulkYear').value;
            const month = document.getElementById('bulkMonth').value;

            if (!eventId || !year || !month) {
                await JarvisDialog.alert('Please select event, year, and month', { type: 'warning' });
                return;
            }

            const rows = document.querySelectorAll('#bulkTableBody tr');
            const bonuses = [];

            rows.forEach(row => {
                const employeeId = row.querySelector('.bulk-employee').value;
                if (!employeeId) return;

                const bonusInput = row.querySelector('.bulk-bonus');
                bonuses.push({
                    employee_id: parseInt(employeeId),
                    event_id: parseInt(eventId),
                    year: parseInt(year),
                    month: parseInt(month),
                    participation_start: row.querySelector('.bulk-part-start').value || null,
                    participation_end: row.querySelector('.bulk-part-end').value || null,
                    bonus_days: parseFloat(row.querySelector('.bulk-days').value) || null,
                    hours_free: parseInt(row.querySelector('.bulk-hours').value) || null,
                    bonus_net: bonusInput ? parseFloat(bonusInput.value) || null : null,
                    details: row.querySelector('.bulk-details').value || null
                });
            });

            if (bonuses.length === 0) {
                await JarvisDialog.alert('No valid rows to save', { type: 'warning' });
                return;
            }

            const resp = await fetch('/hr/events/api/event-bonuses/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bonuses })
            });

            if (resp.ok) {
                const result = await resp.json();
                await JarvisDialog.alert(`Saved ${result.count} bonuses`, { type: 'success' });
                window.location.reload();
            } else {
                await JarvisDialog.alert('Error saving bonuses', { type: 'error' });
            }
        });

        // Initialize bulk modal with a few rows
        document.getElementById('bulkModal').addEventListener('show.bs.modal', () => {
            if (document.querySelectorAll('#bulkTableBody tr').length === 0) {
                for (let i = 0; i < 5; i++) addBulkRow();
            }
        });

        // ============== Add Event with Employees Modal ==============
        const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
        let eventRowId = 0;

        function addEventEmployeeRow(employeeId = '', partStart = '', partEnd = '', days = '', hours = '', bonus = '', details = '') {
            const tbody = document.getElementById('newEventEmployeesTable');
            const row = document.createElement('tr');
            row.dataset.rowId = eventRowId++;

            const defaultDays = document.getElementById('newEventDefaultDays').value;
            const defaultHours = document.getElementById('newEventDefaultHours').value;
            const defaultBonusEl = document.getElementById('newEventDefaultBonus');
            const defaultBonus = defaultBonusEl ? defaultBonusEl.value : '';
            const eventStart = document.getElementById('newEventStart').value;
            const eventEnd = document.getElementById('newEventEnd').value;

            row.innerHTML = `
                <td>
                    <select class="form-select form-select-sm event-employee" required>
                        <option value="">Select...</option>
                        ${bulkEmployees.map(e => `<option value="${e.id}" ${e.id == employeeId ? 'selected' : ''}>${e.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="date" class="form-control form-control-sm event-part-start" value="${partStart || eventStart}"></td>
                <td><input type="date" class="form-control form-control-sm event-part-end" value="${partEnd || eventEnd}"></td>
                <td><input type="number" class="form-control form-control-sm event-days" step="0.5" value="${days || defaultDays}"></td>
                <td><input type="number" class="form-control form-control-sm event-hours" value="${hours || defaultHours}"></td>
                ${isHrManager ? `<td><input type="number" class="form-control form-control-sm event-bonus" value="${bonus || defaultBonus}"></td>` : ''}
                <td><input type="text" class="form-control form-control-sm event-details" value="${details}"></td>
                <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove-event-row"><i class="bi bi-x"></i></button></td>
            `;

            row.querySelector('.btn-remove-event-row').addEventListener('click', () => {
                row.remove();
                updateEventRowCount();
            });

            tbody.appendChild(row);
            updateEventRowCount();
        }

        function updateEventRowCount() {
            const count = document.querySelectorAll('#newEventEmployeesTable tr').length;
            document.getElementById('newEventRowCount').textContent = `${count} employees`;
        }

        document.getElementById('btnAddEventEmployee').addEventListener('click', () => addEventEmployeeRow());

        document.getElementById('btnApplyEventDefaults').addEventListener('click', () => {
            const days = document.getElementById('newEventDefaultDays').value;
            const hours = document.getElementById('newEventDefaultHours').value;
            const eventStart = document.getElementById('newEventStart').value;
            const eventEnd = document.getElementById('newEventEnd').value;

            document.querySelectorAll('.event-days').forEach(el => el.value = days);
            document.querySelectorAll('.event-hours').forEach(el => el.value = hours);
            document.querySelectorAll('.event-part-start').forEach(el => el.value = eventStart);
            document.querySelectorAll('.event-part-end').forEach(el => el.value = eventEnd);

            if (isHrManager) {
                const bonus = document.getElementById('newEventDefaultBonus').value;
                document.querySelectorAll('.event-bonus').forEach(el => el.value = bonus);
            }
        });

        // Auto-set month based on event start date
        document.getElementById('newEventStart').addEventListener('change', (e) => {
            if (e.target.value) {
                const date = new Date(e.target.value);
                document.getElementById('newEventMonth').value = date.getMonth() + 1;
                document.getElementById('newEventYear').value = date.getFullYear();
                // Also set end date if not set
                if (!document.getElementById('newEventEnd').value) {
                    document.getElementById('newEventEnd').value = e.target.value;
                }
            }
        });

        document.getElementById('btnSaveNewEvent').addEventListener('click', async () => {
            const eventName = document.getElementById('newEventName').value;
            const eventStart = document.getElementById('newEventStart').value;
            const eventEnd = document.getElementById('newEventEnd').value;
            const year = parseInt(document.getElementById('newEventYear').value);
            const month = parseInt(document.getElementById('newEventMonth').value);

            if (!eventName || !eventStart || !eventEnd) {
                await JarvisDialog.alert('Please fill in event name and dates', { type: 'warning' });
                return;
            }

            // Create event first
            const eventResp = await fetch('/hr/events/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: eventName,
                    start_date: eventStart,
                    end_date: eventEnd
                })
            });

            if (!eventResp.ok) {
                await JarvisDialog.alert('Error creating event', { type: 'error' });
                return;
            }

            const eventResult = await eventResp.json();
            const eventId = eventResult.id;

            // Collect employee bonuses
            const rows = document.querySelectorAll('#newEventEmployeesTable tr');
            const bonuses = [];

            rows.forEach(row => {
                const employeeId = row.querySelector('.event-employee').value;
                if (!employeeId) return;

                const bonusInput = row.querySelector('.event-bonus');
                bonuses.push({
                    employee_id: parseInt(employeeId),
                    event_id: eventId,
                    year: year,
                    month: month,
                    participation_start: row.querySelector('.event-part-start').value || null,
                    participation_end: row.querySelector('.event-part-end').value || null,
                    bonus_days: parseFloat(row.querySelector('.event-days').value) || null,
                    hours_free: parseInt(row.querySelector('.event-hours').value) || null,
                    bonus_net: bonusInput ? parseFloat(bonusInput.value) || null : null,
                    details: row.querySelector('.event-details').value || null
                });
            });

            if (bonuses.length > 0) {
                const bonusResp = await fetch('/hr/events/api/event-bonuses/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bonuses })
                });

                if (bonusResp.ok) {
                    const result = await bonusResp.json();
                    await JarvisDialog.alert(`Event created with ${result.count} employee bonuses`, { type: 'success' });
                } else {
                    await JarvisDialog.alert('Event created but error saving bonuses', { type: 'warning' });
                }
            } else {
                await JarvisDialog.alert('Event created (no employees added)', { type: 'success' });
            }

            addEventModal.hide();
            window.location.reload();
        });

        // Initialize Add Event modal
        document.getElementById('addEventModal').addEventListener('show.bs.modal', () => {
            // Reset form
            document.getElementById('newEventName').value = '';
            document.getElementById('newEventStart').value = '';
            document.getElementById('newEventEnd').value = '';
            document.getElementById('newEventYear').value = new Date().getFullYear();
            document.getElementById('newEventMonth').value = new Date().getMonth() + 1;
            document.getElementById('newEventEmployeesTable').innerHTML = '';
            eventRowId = 0;
            // Add initial rows
            for (let i = 0; i < 5; i++) addEventEmployeeRow();
        });

        // Export handler (only if manager)
        const btnExport = document.getElementById('btnExport');
        if (btnExport) {
            btnExport.addEventListener('click', async () => {
                const year = document.getElementById('filterYear').value;
                const month = document.getElementById('filterMonth').value;
                let url = '/hr/events/api/export';
                const params = new URLSearchParams();
                if (year) params.set('year', year);
                if (month) params.set('month', month);
                if (params.toString()) url += '?' + params.toString();
                window.location.href = url;
            });
        }

        // ============== Table Sorting ==============
        function sortTable(column, order) {
            const tbody = document.getElementById('bonusesTable');
            const rows = Array.from(tbody.querySelectorAll('tr.bonus-row'));

            rows.sort((a, b) => {
                let valA = a.dataset[column] || '';
                let valB = b.dataset[column] || '';

                // Numeric columns
                if (['year', 'month', 'days', 'hours', 'bonus'].includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return order === 'asc' ? valA - valB : valB - valA;
                }

                // Date columns (ISO format strings compare correctly)
                if (column === 'created') {
                    return order === 'asc'
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }

                // String columns
                return order === 'asc'
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Add click handlers to sortable headers (Bonuses List)
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                const currentOrder = th.dataset.order;
                const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

                // Reset all headers
                document.querySelectorAll('.sortable').forEach(h => {
                    h.removeAttribute('data-order');
                    h.querySelector('.sort-icon').className = 'bi bi-arrow-down-up sort-icon text-muted';
                });

                // Set current header
                th.dataset.order = newOrder;
                th.querySelector('.sort-icon').className = `bi bi-arrow-${newOrder === 'asc' ? 'up' : 'down'} sort-icon`;

                // Sort the table
                sortTable(column, newOrder);
            });
        });

        // ============== Employee Summary Table Sorting ==============
        function sortEmployeeTable(column, order) {
            const tbody = document.getElementById('employeeSummaryBody');
            const rows = Array.from(tbody.querySelectorAll('tr[data-name]'));

            rows.sort((a, b) => {
                let valA = a.dataset[column] || '';
                let valB = b.dataset[column] || '';

                // Numeric columns
                if (['count', 'days', 'hours', 'bonus'].includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return order === 'asc' ? valA - valB : valB - valA;
                }

                // String columns
                return order === 'asc'
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Add click handlers to employee summary sortable headers
        document.querySelectorAll('.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                const currentOrder = th.dataset.order;
                const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

                // Reset all headers
                document.querySelectorAll('.sortable').forEach(h => {
                    h.removeAttribute('data-order');
                    h.querySelector('.sort-icon').className = 'bi bi-arrow-down-up sort-icon text-muted';
                });

                // Set current header
                th.dataset.order = newOrder;
                th.querySelector('.sort-icon').className = `bi bi-arrow-${newOrder === 'asc' ? 'up' : 'down'} sort-icon`;

                // Sort the table
                sortEmployeeTable(column, newOrder);
            });
        });

        // ============== Event Summary Table Sorting ==============
        function sortEventTable(column, order) {
            const tbody = document.getElementById('eventSummaryBody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr[data-name]'));

            rows.sort((a, b) => {
                let valA = a.dataset[column] || '';
                let valB = b.dataset[column] || '';

                // Numeric columns
                if (['year', 'month', 'employees', 'days', 'hours', 'bonus'].includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return order === 'asc' ? valA - valB : valB - valA;
                }

                // String columns
                return order === 'asc'
                    ? valA.localeCompare(valB)
                    : valB.localeCompare(valA);
            });

            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        // Add click handlers to event summary sortable headers
        document.querySelectorAll('.sortable-event').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                const currentOrder = th.dataset.order;
                const newOrder = currentOrder === 'desc' ? 'asc' : 'desc';

                // Reset all event headers
                document.querySelectorAll('.sortable-event').forEach(h => {
                    h.removeAttribute('data-order');
                    h.querySelector('.sort-icon').className = 'bi bi-arrow-down-up sort-icon text-muted';
                });

                // Set current header
                th.dataset.order = newOrder;
                th.querySelector('.sort-icon').className = `bi bi-arrow-${newOrder === 'asc' ? 'up' : 'down'} sort-icon`;

                // Sort the table
                sortEventTable(column, newOrder);
            });
        });

        // ============== Theme Toggle ==============
        const themeToggle = document.getElementById('themeToggle');

        // Load saved theme preference
        const savedTheme = localStorage.getItem('jarvisTheme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeToggle.checked = true;
        }

        // Theme toggle handler
        themeToggle.addEventListener('change', () => {
            if (themeToggle.checked) {
                document.body.classList.add('dark-theme');
                localStorage.setItem('jarvisTheme', 'dark');
            } else {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('jarvisTheme', 'light');
            }
        });

        // ============== Column Resizing ==============
        function initColumnResize(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const headerRow = table.querySelector('thead tr');
            if (!headerRow) return;

            const headers = headerRow.querySelectorAll('th');

            headers.forEach((th, index) => {
                // Skip last column (actions)
                if (index === headers.length - 1) return;

                // Create resize handle
                const resizer = document.createElement('div');
                resizer.className = 'column-resizer';
                resizer.style.cssText = `
                    position: absolute;
                    right: 0;
                    top: 0;
                    height: 100%;
                    width: 5px;
                    cursor: col-resize;
                    user-select: none;
                    z-index: 10;
                `;

                th.style.position = 'relative';
                th.appendChild(resizer);

                let startX, startWidth;

                resizer.addEventListener('mousedown', (e) => {
                    startX = e.pageX;
                    startWidth = th.offsetWidth;

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);

                    // Prevent text selection
                    e.preventDefault();
                });

                function onMouseMove(e) {
                    const width = startWidth + (e.pageX - startX);
                    if (width > 50) { // Minimum width
                        th.style.width = width + 'px';
                        th.style.minWidth = width + 'px';
                    }
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);

                    // Save column widths to localStorage
                    saveColumnWidths(tableId);
                }
            });

            // Restore saved widths
            restoreColumnWidths(tableId);
        }

        function saveColumnWidths(tableId) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('thead th');
            const widths = Array.from(headers).map(th => th.style.width || 'auto');
            localStorage.setItem(`columnWidths_${tableId}`, JSON.stringify(widths));
        }

        function restoreColumnWidths(tableId) {
            const saved = localStorage.getItem(`columnWidths_${tableId}`);
            if (!saved) return;

            try {
                const widths = JSON.parse(saved);
                const table = document.getElementById(tableId);
                const headers = table.querySelectorAll('thead th');

                headers.forEach((th, index) => {
                    if (widths[index] && widths[index] !== 'auto') {
                        th.style.width = widths[index];
                        th.style.minWidth = widths[index];
                    }
                });
            } catch (e) {
                console.error('Error restoring column widths:', e);
            }
        }

        // Initialize column resizing for all tables
        initColumnResize('bonusesTableMain');
        initColumnResize('employeeSummaryTable');
        initColumnResize('eventSummaryTable');

        // Add CSS for resizer hover effect
        const style = document.createElement('style');
        style.textContent = `
            .column-resizer:hover {
                background: var(--month-badge-bg);
            }
            .column-resizer:active {
                background: #9c27b0;
            }
        `;
        document.head.appendChild(style);

    </script>
    <script src="/static/js/jarvis-utils.js"></script>
    <script src="/static/js/online-users.js"></script>
    <script src="/static/js/theme.js"></script>
    <script src="/static/js/jarvis-dialogs.js"></script>
</body>
</html>
