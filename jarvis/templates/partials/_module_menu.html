{#
    Module Menu Partial - Main navigation for JARVIS modules
    Usage: {% include 'partials/_module_menu.html' %}

    Optional variable: current_module (accounting, hr, sales, aftersales)
    Pass it before including: {% set current_module = 'hr' %}

    This menu dynamically loads from the database configuration.
#}

<div class="module-menu dropdown">
    <button class="module-menu-toggle dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="bi bi-grid-3x3-gap-fill"></i>
        <span class="d-none d-md-inline">Modules</span>
        {% if current_module %}
        <span class="current-module-dot {{ current_module }}" id="currentModuleDot"></span>
        {% endif %}
    </button>
    <ul class="dropdown-menu dropdown-menu-end" id="moduleMenuDropdown">
        <!-- Home Link -->
        <li>
            <a href="/apps" class="home-link">
                <i class="bi bi-house-door"></i>
                <span>J.A.R.V.I.S. Apps</span>
            </a>
        </li>

        <li><div class="menu-divider"></div></li>

        <!-- Module items will be loaded dynamically -->
        <li id="moduleMenuLoading" class="text-center py-2">
            <span class="spinner-border spinner-border-sm" role="status"></span>
            <span class="ms-2 small text-muted">Loading...</span>
        </li>
    </ul>
</div>

<script>
(function() {
    const currentModule = '{{ current_module | default("") }}';

    async function loadModuleMenu() {
        try {
            const res = await fetch('/api/module-menu');
            const data = await res.json();
            renderModuleMenu(data.items || []);
        } catch (err) {
            console.error('Failed to load module menu:', err);
            document.getElementById('moduleMenuLoading').innerHTML = '<span class="text-danger small">Failed to load</span>';
        }
    }

    function renderModuleMenu(items) {
        const dropdown = document.getElementById('moduleMenuDropdown');
        const loadingEl = document.getElementById('moduleMenuLoading');
        if (!dropdown || !loadingEl) return;

        // Separate active and coming_soon modules
        const activeModules = items.filter(i => i.status === 'active');
        const comingSoonModules = items.filter(i => i.status === 'coming_soon');

        let html = '';

        // Active Modules Section
        if (activeModules.length) {
            html += '<li class="menu-section-header">Active Modules</li>';
            activeModules.forEach(mod => {
                const isActive = currentModule === mod.module_key;
                const hasChildren = mod.children && mod.children.length > 0;

                html += `
                    <li class="module-item-container">
                        <a href="${mod.url || '#'}" class="module-menu-item ${isActive ? 'active' : ''}" ${hasChildren ? `data-module-key="${mod.module_key}"` : ''}>
                            <div class="module-icon ${mod.module_key}" style="background: ${hexToRgba(mod.color, 0.1)};">
                                <i class="bi ${mod.icon}" style="color: ${mod.color};"></i>
                            </div>
                            <div class="module-text">
                                <div class="module-name">${mod.name}</div>
                                <div class="module-desc">${mod.description || ''}</div>
                            </div>
                            ${hasChildren ? `<i class="bi bi-chevron-down submenu-toggle" data-target="${mod.module_key}"></i>` : ''}
                        </a>
                `;

                // Render children as submenu
                if (hasChildren) {
                    html += `<ul class="module-submenu" id="submenu-${mod.module_key}">`;
                    mod.children.forEach(child => {
                        const isChildActive = currentModule === child.module_key;
                        html += `
                            <li>
                                <a href="${child.url || '#'}" class="module-submenu-item ${isChildActive ? 'active' : ''}">
                                    <i class="bi ${child.icon}" style="color: ${mod.color};"></i>
                                    <span>${child.name}</span>
                                </a>
                            </li>
                        `;
                    });
                    html += '</ul>';
                }

                html += '</li>';
            });
        }

        // Coming Soon Section
        if (comingSoonModules.length) {
            html += '<li><div class="menu-divider"></div></li>';
            html += '<li class="menu-section-header">Coming Soon</li>';
            comingSoonModules.forEach(mod => {
                html += `
                    <li>
                        <a href="#" class="module-menu-item" onclick="return false;" style="opacity: 0.5; cursor: not-allowed;">
                            <div class="module-icon ${mod.module_key}" style="background: ${hexToRgba(mod.color, 0.1)};">
                                <i class="bi ${mod.icon}" style="color: ${mod.color};"></i>
                            </div>
                            <div class="module-text">
                                <div class="module-name">${mod.name}</div>
                                <div class="module-desc">${mod.description || ''}</div>
                            </div>
                            <span class="module-badge coming-soon">Soon</span>
                        </a>
                    </li>
                `;
            });
        }

        // Replace loading element with menu content
        loadingEl.outerHTML = html;

        // Add click handlers for submenu toggles
        document.querySelectorAll('.submenu-toggle').forEach(toggle => {
            toggle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const targetKey = toggle.dataset.target;
                const submenu = document.getElementById(`submenu-${targetKey}`);
                if (submenu) {
                    submenu.classList.toggle('show');
                    toggle.classList.toggle('bi-chevron-down');
                    toggle.classList.toggle('bi-chevron-up');
                }
            });
        });

        // Auto-expand submenu if current module is a child
        if (currentModule) {
            items.forEach(mod => {
                if (mod.children) {
                    const isChildActive = mod.children.some(c => c.module_key === currentModule);
                    if (isChildActive) {
                        const submenu = document.getElementById(`submenu-${mod.module_key}`);
                        const toggle = document.querySelector(`.submenu-toggle[data-target="${mod.module_key}"]`);
                        if (submenu) submenu.classList.add('show');
                        if (toggle) {
                            toggle.classList.remove('bi-chevron-down');
                            toggle.classList.add('bi-chevron-up');
                        }
                    }
                }
            });
        }

        // Update the current module dot color if we have a current module
        if (currentModule) {
            const currentMod = items.find(m => m.module_key === currentModule);
            if (currentMod) {
                const dot = document.getElementById('currentModuleDot');
                if (dot) {
                    dot.style.backgroundColor = currentMod.color;
                }
            }
        }
    }

    function hexToRgba(hex, alpha) {
        if (!hex) return `rgba(108, 117, 125, ${alpha})`;
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Load when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadModuleMenu);
    } else {
        loadModuleMenu();
    }
})();
</script>
